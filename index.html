<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="manifest" href="./manifest.webmanifest?v=7" />
  <link rel="icon" href="./assets/oakley/favicon/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@600;700;800&display=swap" rel="stylesheet">
  <title>Oakley Services Inventory</title>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- Optional: set your Supabase URL and anon key here -->
  <script>
    // Supabase project credentials (safe to expose anon public key in client)
    window.SB_URL  = "https://entmbaxeylglposptsuy.supabase.co";
    window.SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVudG1iYXhleWxnbHBvc3B0c3V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ2NjEsImV4cCI6MjA3MjQ5MDY2MX0.vDTzhL0Q-iDZShWu2hcaYOavPLltY31OThXj-ohBjAc";
  </script>

  <script>
  // Lightweight observability: log JS errors so users can screenshot
  window.addEventListener('error', e => console.log('JS Error:', e.message, e.error));
  window.addEventListener('unhandledrejection', e => console.log('Promise Rejection:', e.reason));
  </script>

  <style>
    :root{
      --bg:#24292d;--fg:#eaeff7;--muted:#a9b4c0;--accent:#5aa9ff;
      --card:#000000;--border:#1f2a36;--title-min:12px;--title-max:56px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);color:var(--fg)
    }
    header{
      padding:calc(10px + env(safe-area-inset-top)) 16px 8px;
      border-bottom:1px solid var(--border);
      position:sticky;top:0;background:var(--bg);z-index:20;text-align:center;
    }
    .header-inner{ max-width:1100px; margin:0 auto; padding:0 24px; }
.status{margin-top:8px;display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#0d1420;color:#9fb3c8;appearance:none;-webkit-appearance:none;cursor:pointer;text-align:left}
.status.online{color:#ffffff;background:#0f2d18;border-color:#1b5432}
.status.offline{color:#ffffff;background:#2a1212;border-color:#5a1c1c}
    h1{margin:0;text-align:left;font-family:'Barlow',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; font-weight:800; font-size:clamp(var(--title-min), 6vw, var(--title-max)); letter-spacing:1px}
    main{padding:12px;max-width:1100px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .toolbar .spacer{flex:1}
    .btn{
      cursor:pointer;border:1px solid var(--border);background:#101826;color:#fff;
      padding: clamp(10px, 2.2vw, 12px) clamp(12px, 3vw, 14px);
      border-radius:10px;font-weight:600;
      font-size: clamp(14px, 2.8vw, 16px);
      line-height:1.1; white-space:nowrap; min-height:44px
    }
    .btn.small{
      padding:8px 10px;
      font-size:13px;
      min-height:36px;
    }
    .btn.btn-icon{
      padding:10px;
      min-height:44px;
      min-width:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn.primary{background:var(--accent);color:#06121f;border-color:transparent}
    .btn:disabled{ opacity:.55; cursor:not-allowed }
    .muted{color:var(--muted);font-size:12px}
    .time{font-size:12px;color:var(--muted)}
    .scroll{overflow:auto;max-height:70vh;border-radius:10px;position:relative;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
    table{width:100%;border-collapse:collapse;font-size:15px}
    thead th{
      text-align:center;color:#e2e8f0;font-weight:700;border-bottom:2px solid var(--border);
      padding:14px 12px;position:sticky;top:0;background:#0d1117;z-index:7;
      text-transform:uppercase;font-size:12px;letter-spacing:0.5px;
      white-space:nowrap;
    }
    th.sortable{ cursor:pointer; user-select:none }
    th.sortable .sort-ind{ margin-left:6px; opacity:.85; display:inline }
    
    th.sorted-asc .sort-ind::before{ content:'\25B2'; opacity:1 }
    th.sorted-desc .sort-ind::before{ content:'\25BC'; opacity:1 }
tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
    td.actions{padding:8px;text-align:center}
	    .row-delete-btn{
	      background:none;border:none;cursor:pointer;padding:6px;
	      color:var(--muted);display:inline-flex;align-items:center;justify-content:center;
	      border-radius:6px;transition:background 0.15s,color 0.15s;
	    }
	    .row-delete-btn:hover{background:rgba(255,80,80,0.15);color:#ff6b6b}
		    @media (hover: hover) and (pointer: fine){
		      #invTable tbody tr[data-id]{
		        transition: background-color 160ms ease, filter 160ms ease, outline-color 160ms ease;
		        transition-delay: 0ms;
		        outline: 1px solid transparent;
		        outline-offset: -1px;
		      }
		      #invTable tbody tr[data-id]:hover{
		        transition-delay: 200ms; /* avoids flicker while scrolling */
		        background-color: rgba(90,169,255,0.12);
		        outline-color: rgba(90,169,255,0.62);
		        filter: drop-shadow(0 0 18px rgba(90,169,255,0.30));
		      }
		    }
			    /* Mobile table layout: stack fields vertically per record */
			    @media (max-width: 768px){
			      #invTable thead{ display:none; }
			      #invTable tbody tr[data-id]{
			        position:relative;
			        isolation:isolate;
			        display:block;
			        padding:10px; /* tighter cards to reduce scrolling */
			        border:1px solid var(--border);
			        border-radius:14px;
			        background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
			        box-shadow:0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
			        margin:0 0 8px 0;
			        transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
			        will-change: transform, box-shadow;
			      }
			      #invTable tbody tr[data-id]::before{
			        content:'';
			        position:absolute;
			        inset:-12px;
			        border-radius:20px;
			        background: radial-gradient(closest-side, rgba(90,169,255,0.40), rgba(90,169,255,0.0) 72%);
			        filter: blur(16px);
			        opacity:0;
			        transition: opacity 220ms ease, transform 220ms ease;
			        transform: translateY(0);
			        z-index:-1;
			        pointer-events:none;
			      }
			      #invTable tbody tr[data-id].scroll-focus{
			        box-shadow:
			          0 16px 36px rgba(0,0,0,0.62),
			          0 0 46px rgba(90,169,255,0.28),
			          0 0 82px rgba(90,169,255,0.12),
			          inset 0 1px 0 rgba(255,255,255,0.08);
			        transform: translateY(-3px);
			      }
			      #invTable tbody tr[data-id].scroll-focus::before{
			        opacity:1;
			        transform: translateY(-1px);
			      }
		      #invTable tbody tr[data-id] td{
		        display:block;
		        width:100%;
		        padding:0;
		        border-bottom:none;
		      }
		      #invTable tbody tr[data-id] td[data-col]{
		        padding:6px 0;
		      }
			      /* Indent left-aligned fields to avoid the absolute checkbox */
			      #invTable tbody tr[data-id] td[data-col="name"],
			      #invTable tbody tr[data-id] td[data-col="desc"]{ padding-left:44px; }
			      #invTable tbody tr[data-id] td[data-col]::before{
			        display:inline-block;
			        font-size:10px;
			        letter-spacing:.08em;
		        text-transform:uppercase;
		        color:var(--muted);
		        margin:0;
		      }
		      #invTable tbody tr[data-id] td[data-col="name"]::before{ content:'Item'; }
		      #invTable tbody tr[data-id] td[data-col="desc"]::before{ content:'Description'; }
		      #invTable tbody tr[data-id] td[data-col="qty"]::before{ content:'Qty'; }

		      /* Keep label/value on one line for compactness */
		      #invTable tbody tr[data-id] td[data-col="name"],
		      #invTable tbody tr[data-id] td[data-col="desc"]{
		        display:flex;
		        gap:10px;
		        align-items:flex-start;
		      }
		      #invTable tbody tr[data-id] td[data-col="name"]{ align-items:baseline; }
		      #invTable tbody tr[data-id] td[data-col="name"]::before,
		      #invTable tbody tr[data-id] td[data-col="desc"]::before{
		        min-width:86px;
		        flex:0 0 86px;
		        white-space:nowrap;
		        line-height:1.2;
		      }
		      #invTable tbody tr[data-id] td[data-col="name"] .cell-val,
		      #invTable tbody tr[data-id] td[data-col="desc"] .cell-val{
		        min-width:0;
		        flex:1;
		      }
		      #invTable tbody tr[data-id] td[data-col="desc"] .cell-val{
		        white-space:normal;
		        word-break:break-word;
		        hyphens:auto;
		        display:-webkit-box;
		        -webkit-box-orient:vertical;
		        -webkit-line-clamp:2;
		        overflow:hidden;
		      }

		      #invTable tbody tr[data-id] td[data-col="qty"]{ text-align:center; }
		      #invTable tbody tr[data-id] td[data-col="qty"]::before{ display:block; margin:0 0 4px 0; }

      #invTable tbody tr[data-id] td.sel{
        position:absolute;
        left:10px;
        top:50%;
        transform:translateY(-50%);
        width:42px;
        padding:0;
        display:flex;
        align-items:center;
        justify-content:center;
      }
	      #invTable tbody tr[data-id] td.actions{
	        position:absolute;
	        right:10px;
	        top:auto;
	        bottom:10px;
	        transform:none;
	        width:48px;
	        padding:0;
	        display:flex;
        align-items:center;
        justify-content:center;
        z-index:2;
      }
      #invTable tbody tr[data-id] td.sel input[type="checkbox"]{
        width:20px;
        height:20px;
      }
      #invTable tbody tr[data-id] td.actions .row-delete-btn{
        width:44px;
        height:44px;
        padding:10px;
        border-radius:10px;
        border:1px solid var(--border);
        background:#101826;
        color:#fff;
      }
	      #invTable tbody tr[data-id] td.actions .row-delete-btn:hover{
	        background:rgba(255,80,80,0.18);
	        border-color:rgba(255,80,80,0.35);
	        color:#ff6b6b;
	      }
		    }
		    @media (prefers-reduced-motion: reduce){
		      #invTable tbody tr[data-id]{ transition:none !important; }
		      #invTable tbody tr[data-id]::before{ transition:none !important; }
		      #invTable tbody tr[data-id].scroll-focus{ transform:none !important; }
		    }

    /* Desktop description: keep on one line (dynamic width handles it) */
    @media (min-width: 769px){ td[data-col="desc"], th[data-col="desc"]{ white-space:nowrap; } }
	    td.qty{text-align:center;font-variant-numeric:tabular-nums}
    th.sel, td.sel{ width:42px; text-align:center }
    input[type=text],input[type=number],input[type=email],input[type=password],input[type=tel],textarea,select{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
      background:#0d131b;color:#fff;font-size:16px
    }
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .hero-logo{height:clamp(36px,8vw,56px); margin:10px auto 0 auto;}
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .brandrow{display:flex;align-items:center;justify-content:space-between;gap:14px}
    .title-logo{height:clamp(44px,9vw,62px); width:auto; display:block;}
    .brandtext{display:flex;flex-direction:column;align-items:flex-start;flex:1;min-width:0;}
    .input-wrap{ position:relative; width:100%; max-width:480px; }
    .clear-input-btn{
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
      width:40px;
      height:40px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      cursor:pointer;
      touch-action:manipulation;
      -webkit-appearance:none;
      appearance:none;
    }
    .clear-input-btn:hover{ background:#0e1621; }
    .clear-input-btn:disabled{ opacity:.55; cursor:not-allowed; }
    .input-wrap > input{ padding-right:52px; }
    #filterBox{
      width:100%; max-width:480px;
      padding:12px 52px 12px 12px;border-radius:10px;border:1px solid var(--border);
      background:#0d131b;color:#eaeff7;font-size:16px
    }
    td.editing{padding:6px}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#0d1420;
      border:1px solid var(--border);color:var(--fg);padding:10px 14px;border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.4);z-index:100;display:none
    }
    .modal{
      display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;
      overflow:auto;
      padding:calc(12px + env(safe-area-inset-top)) 12px calc(12px + env(safe-area-inset-bottom));
    }
    .modal .box{
      max-width:580px;
      width:100%;
      margin:0 auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      max-height:calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .modal .box.edit-box{
      padding:0;
      overflow:hidden; /* body scrolls */
      display:flex;
      flex-direction:column;
    }
    .edit-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background:var(--card);
    }
    .edit-header h2{ margin:0; font-size:16px; }
    .edit-sub{ margin-top:6px; color:var(--muted); font-size:12px; }
    .edit-body{
      padding:12px 14px 14px;
      overflow:auto;
      flex:1;
      -webkit-overflow-scrolling:touch;
    }
    .edit-body textarea{
      min-height:30vh;
    }
    .qty-stepper.qty-stepper--modal,
    .qty-stepper.qty-stepper--table{
      display:inline-flex;
      align-items:center;
      flex-wrap:nowrap;
      justify-content:center;
      background:transparent;
      border:none;
      border-radius:0;
      overflow:visible;
      height:auto;
    }
    .qty-stepper.qty-stepper--modal{ gap:10px; }
    .qty-stepper.qty-stepper--table{ gap:6px; }
    .qty-stepper--table .qty-step{ min-width:38px; }
    .qty-stepper--table .qty-value{ min-width:30px; font-size:15px; }
    .qty-step{
      cursor:pointer;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      border-radius:10px;
      min-width:44px;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      line-height:1;
      user-select:none;
      -webkit-appearance:none;
      appearance:none;
      touch-action:manipulation;
    }
    .qty-step:disabled{ opacity:.55; cursor:not-allowed; }
    .qty-value{
      min-width:44px;
      text-align:center;
      font-variant-numeric:tabular-nums;
      font-weight:800;
      font-size:16px;
      line-height:1;
    }
    .qty-stepper.qty-stepper--modal input[type=number]{
      width:4rem;
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    .qty-stepper input[type=number]::-webkit-outer-spin-button,
    .qty-stepper input[type=number]::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }
    .edit-footer{
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#0b1017;
    }
    .section + .section{ margin-top:12px; }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .order-box{
      padding:0;
      overflow:hidden; /* body scrolls */
      display:flex;
      flex-direction:column;
    }
    .order-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background:var(--card);
    }
    .order-header h2{ margin:0; font-size:16px; }
    .order-body{
      padding:12px 14px 14px;
      overflow:auto;
      flex:1;
      -webkit-overflow-scrolling:touch;
    }
    .order-footer{
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .order-recipient{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .order-recipient input[type=email]{ flex:1; min-width:200px; }
    .order-suggest{
      display:none;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px;
      background:#000;
      max-height:190px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .order-suggest.has-suggest{ display:flex; }
    .suggest-chip{
      cursor:pointer;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      min-height:36px;
      max-width:100%;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .order-list{ display:flex; flex-direction:column; gap:10px; }
    .order-empty{
      padding:14px;
      border:1px dashed var(--border);
      border-radius:14px;
      background:transparent;
      color:var(--muted);
      font-size:13px;
      text-align:center;
    }
    .order-card{
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:14px;
      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
      box-shadow:0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .order-card-top{ display:flex; gap:12px; align-items:flex-start; }
    .order-meta{ flex:1; min-width:0; }
    .order-title{ font-weight:700; font-size:15px; letter-spacing:-0.01em; }
    .order-sub{ margin-top:3px; color:var(--muted); font-size:12px; line-height:1.4; }
    .order-side{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
    .order-kpi{ text-align:right; }
    .order-kpi-label{ color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:0.04em; }
    .order-kpi-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:18px; }
    .order-controls{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;
      gap:12px;
      align-items:flex-end;
    }
    .order-control{ flex-shrink:0; display:flex; flex-direction:column; }
    .order-control.qty{ width:64px; margin-left:auto; text-align:center; }
    .order-control.qty input{
      width:100%;
      text-align:center;
      font-weight:600;
      font-size:16px;
      font-variant-numeric:tabular-nums;
      height:42px;
      padding:0 8px;
      box-sizing:border-box;
    }
    .order-control-label{ color:var(--muted); font-size:11px; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.03em; }
    .order-control-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:17px; height:42px; display:flex; align-items:center; }
    .order-control-spacer{ height:17px; }
    .order-remove-btn{
      background:none; border:none; cursor:pointer; padding:8px;
      color:var(--muted); display:flex; align-items:center; justify-content:center;
      height:42px; width:42px; border-radius:8px; transition:background 0.15s, color 0.15s;
    }
    .order-remove-btn:hover{ background:rgba(255,80,80,0.15); color:#ff6b6b; }
    .order-remove-btn svg{ width:20px; height:20px; }
    .qty-stepper{
      display:flex; align-items:center; gap:0; background:#0d131b; border:1px solid var(--border);
      border-radius:10px; overflow:hidden; height:42px;
    }
    .qty-stepper-btn{
      width:42px; height:42px; border:none; background:transparent; color:#fff;
      font-size:20px; font-weight:500; cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition:background 0.15s;
    }
    .qty-stepper-btn:hover{ background:rgba(255,255,255,0.08); }
    .qty-stepper-btn:active{ background:rgba(255,255,255,0.12); }
    .qty-stepper-val{
      min-width:32px; text-align:center; font-weight:700; font-size:16px;
      font-variant-numeric:tabular-nums; color:#fff;
    }
    .order-preview{
      border:1px solid var(--border);
      border-radius:12px;
      background:#000;
      padding:10px;
    }
    .order-preview summary{
      cursor:pointer;
      list-style:none;
      font-weight:700;
      user-select:none;
    }
    .order-preview summary::-webkit-details-marker{ display:none; }
    .order-preview summary::after{ content:'▾'; float:right; color:var(--muted); }
    .order-preview[open] summary::after{ content:'▴'; }
    .order-preview-html{
      margin-top:10px;
      border-radius:8px;
      overflow:hidden;
      background:#fff;
      max-height:320px;
      overflow-y:auto;
    }
    .order-preview-html iframe{
      width:100%;
      border:none;
      min-height:280px;
    }
    .history-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .history-item{
      border:1px solid var(--border);
      border-radius:12px;
      background:#000;
      padding:10px;
    }
    .history-item summary{
      cursor:pointer;
      list-style:none;
      font-weight:800;
      user-select:none;
    }
    .history-item summary::-webkit-details-marker{ display:none; }
    .history-item summary::after{ content:'▾'; float:right; color:var(--muted); }
    .history-item[open] summary::after{ content:'▴'; }
    .history-meta{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .history-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .history-title{ flex:1; }
    .btn-icon-danger{
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      padding:4px;
      border-radius:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:color 0.15s, background 0.15s;
    }
    .btn-icon-danger:hover{
      color:#ef4444;
      background:rgba(239,68,68,0.1);
    }
    .history-kv{ margin-top:10px; font-size:13px; }
    .history-kv div{ margin-top:4px; }
    .history-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
    }
    .history-table th,
    .history-table td{ padding:8px; border-bottom:1px solid var(--border); }
    .history-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
    }
    .history-table td.qty{
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:800;
    }
    .drop{
      border:1px dashed var(--border);border-radius:10px;padding:12px;text-align:center;color:var(--muted)
    }
    .totals{ display:flex; justify-content:flex-end; margin:6px 0 4px; }
    @media (max-width:640px){
      .toolbar{gap:6px}
      .toolbar .btn{flex:1}
      .scroll{max-height:calc(100vh - 240px)}
    }
    /* no right-side logo anymore */
    @media (max-width:360px){ .toolbar{gap:4px} }
  
    @media (max-width: 480px){
      header{ padding: calc(8px + env(safe-area-inset-top)) 12px 6px; }
      .header-inner{ padding: 0 12px; }
      .brandrow{ gap:8px }
      .title-logo{ height:36px }
      .modal{ padding:calc(10px + env(safe-area-inset-top)) 10px calc(10px + env(safe-area-inset-bottom)); }
      .order-header{ padding:12px; }
      .order-body{ padding:10px 12px 12px; }
      .order-footer{ padding:10px 12px calc(10px + env(safe-area-inset-bottom)); }
      .order-footer{ display:grid; grid-template-columns:1fr 1fr; }
      .order-footer .order-send{ grid-column:1 / -1; }
      .order-recipient{ flex-direction:column; align-items:stretch; }
      .order-recipient input[type=email]{ min-width:0; }
    }

    /* Hamburger Menu Styles */
    .hamburger-menu{
      position:relative;
      z-index:25;
    }
    .hamburger-btn{
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      width:44px;
      height:44px;
      padding:8px;
      border:1px solid var(--border);
      background:#101826;
      border-radius:10px;
      cursor:pointer;
      gap:5px;
    }
    .hamburger-btn:hover{
      background:#1a2636;
    }
    .hamburger-btn span{
      display:block;
      width:22px;
      height:2px;
      background:var(--fg);
      border-radius:2px;
      transition:transform 0.2s, opacity 0.2s;
    }
    .hamburger-btn.open span:nth-child(1){
      transform:translateY(7px) rotate(45deg);
    }
    .hamburger-btn.open span:nth-child(2){
      opacity:0;
    }
    .hamburger-btn.open span:nth-child(3){
      transform:translateY(-7px) rotate(-45deg);
    }
    .menu-dropdown{
      display:none;
      position:absolute;
      top:calc(100% + 8px);
      right:0;
      min-width:200px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:8px;
      box-shadow:0 10px 40px rgba(0,0,0,.5);
      z-index:30;
    }
    .menu-dropdown.open{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .menu-dropdown .menu-item{
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
      padding:12px 14px;
      border:none;
      background:transparent;
      color:var(--fg);
      font-size:15px;
      font-weight:600;
      text-align:left;
      border-radius:10px;
      cursor:pointer;
      transition:background 0.15s;
    }
    .menu-dropdown .menu-item:hover{
      background:#1a2636;
    }
    .menu-dropdown .menu-item .menu-icon-svg{
      flex-shrink:0;
      opacity:0.8;
    }
    .menu-divider{
      height:1px;
      background:var(--border);
      margin:4px 0;
    }
    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .header-left{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:12px;
      flex:1;
      min-width:0;
    }
    .menu-backdrop{
      display:none;
      position:fixed;
      inset:0;
      z-index:22;
    }
    .menu-backdrop.open{
      display:block;
    }
    /* Profile dropdown */
    .profile-menu{
      position:relative;
    }
    .profile-btn{
      background:none;border:none;cursor:pointer;padding:8px;
      color:var(--muted);display:flex;align-items:center;gap:6px;
      border-radius:50%;transition:background 0.15s;position:relative;
    }
    .profile-btn:hover{background:rgba(255,255,255,0.08)}
    .profile-status{
      position:absolute;bottom:6px;right:6px;width:10px;height:10px;
      border-radius:50%;border:2px solid var(--bg);
      background:#6b7280;
    }
    .profile-status.online{background:#22c55e}
    .profile-status.offline{background:#ef4444}
    .profile-status.warning{background:#f59e0b}
    .profile-dropdown{
      position:absolute;top:100%;right:0;margin-top:8px;
      background:#1a1f26;border:1px solid var(--border);border-radius:12px;
      min-width:220px;padding:8px 0;z-index:30;
      box-shadow:0 10px 40px rgba(0,0,0,0.4);
      display:none;
    }
    .profile-dropdown.open{display:block}
    .profile-info{padding:12px 16px}
    .profile-email{font-weight:600;font-size:14px;color:var(--fg);margin-bottom:4px;word-break:break-all}
    .profile-connection{font-size:12px;color:var(--muted)}
    .profile-dropdown .menu-item{
      display:flex;align-items:center;gap:10px;width:100%;
      padding:12px 16px;border:none;background:transparent;
      color:var(--fg);font-size:14px;font-weight:500;
      text-align:left;cursor:pointer;transition:background 0.15s;
    }
    .profile-dropdown .menu-item:hover{background:rgba(255,255,255,0.06)}
    .profile-meta{padding:10px 16px;border-top:1px solid var(--border);margin-top:8px}
    .profile-meta .time{font-size:11px;color:var(--muted)}
    .menu-icon-svg{flex-shrink:0}
</style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-row">
        <div class="header-left">
          <div class="brandtext">
            <img class="title-logo" src="./assets/oakley/logo/oakley-logo-horizontal-h128.png" alt="Oakley Services" />
          </div>
        </div>
        <div class="profile-menu">
          <button class="profile-btn" id="profileBtn" aria-label="Account menu" aria-expanded="false">
            <span class="profile-status" id="profileStatus"></span>
            <svg class="profile-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          </button>
          <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-info" id="profileInfo">
              <div class="profile-email" id="profileEmail">Not signed in</div>
              <div class="profile-connection" id="profileConnection">Offline</div>
            </div>
            <div class="menu-divider"></div>
            <button class="menu-item" id="openProfileSettings">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
              <span>Profile Settings</span>
            </button>
            <button class="menu-item" id="profileSignIn">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
              <span id="profileSignInText">Sign Out</span>
            </button>
            <div class="profile-meta">
              <span class="time" id="lastUpdate" aria-live="polite"></span>
            </div>
          </div>
        </div>
        <div class="hamburger-menu">
          <button class="hamburger-btn" id="hamburgerBtn" aria-label="Open menu" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <nav class="menu-dropdown" id="menuDropdown" role="menu">
            <button class="menu-item" id="menuImport" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              Import File
            </button>
            <button class="menu-item" id="menuPaste" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
              Paste Data
            </button>
            <button class="menu-item" id="menuExport" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              Export File
            </button>
            <div class="menu-divider"></div>
            <button class="menu-item" id="menuAddOne" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Add Item
            </button>
            <button class="menu-item" id="menuOrder" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
              Create Order
            </button>
            <button class="menu-item" id="menuHistory" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              Order History
            </button>
          </nav>
        </div>
      </div>
      <div id="menuBackdrop" class="menu-backdrop"></div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="toolbar" role="toolbar" aria-label="Inventory actions" style="justify-content:center;">
        <input type="file" id="fileImport" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" style="display:none" />
        <div class="input-wrap">
          <input id="filterBox" type="text" placeholder="Filter items…" aria-label="Filter items" />
          <button class="clear-input-btn" id="btnClearFilter" type="button" aria-label="Clear filter" title="Clear filter" style="display:none">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M18 6L6 18"></path>
              <path d="M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="totals" aria-live="polite"><span id="totalQty" class="muted">Total Qty: 0</span></div>

	      <div class="scroll" id="tableWrap">
	        <table id="invTable" role="grid" aria-label="Inventory table">
	          <colgroup>
	            <col style="width:42px">
	            <col id="col-name">
	            <col id="col-desc">
	            <col style="width:150px">
	            <col style="width:48px">
	          </colgroup>
          <thead>
            <tr>
              <th class="sel"><input type="checkbox" id="chkAll" aria-label="Select all"></th>
              <th scope="col" class="sortable" data-col="name" aria-sort="ascending">Item <span class="sort-ind"></span></th>
              <th scope="col" class="sortable" data-col="desc">Description <span class="sort-ind"></span></th>
              <th scope="col" class="qty sortable" data-col="qty">Qty <span class="sort-ind"></span></th>
              <th scope="col" class="actions"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">
        <span id="editHint">Tap any cell to edit inline; <kbd>Enter</kbd> saves, <kbd>Esc</kbd> cancels.</span>
      </div>
    </section>
  </main>

  <!-- Paste/Import modal -->
  <div id="pasteModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Paste Data</h2>
      <div class="muted" style="margin-bottom:10px;">
        Provide columns <code>Item, Description, Qty</code>. Headers optional; Qty optional (defaults to 0).
        Tabs, commas, or multi-space columns are accepted. You may also drop or choose a file.
      </div>
      <div class="drop" id="dropZone">Drop a CSV/TSV/TXT/JSON/XLSX/XLS/DOCX/PDF file here, or choose below.</div>
      <input type="file" id="fileImportModal" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" style="display:block;margin:10px 0;" />
      <textarea id="pasteArea" rows="8" placeholder="Item, Description, Qty"></textarea>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <span id="pasteInfo" class="muted" style="margin-right:auto"></span>
        <button class="btn" id="btnPasteCancel">Cancel</button>
        <button class="btn primary" id="btnPasteApply">Import</button>
      </div>
    </div>
  </div>

  <!-- Add-one modal -->
  <div id="addOneModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Add Item</h2>
      <div style="display:grid; grid-template-columns:1fr; gap:8px;">
        <label class="muted">Item (unique)</label>
        <input id="addName" type="text" placeholder="Item" autocapitalize="off" autocomplete="off" spellcheck="false" />
        <label class="muted">Description (optional)</label>
        <input id="addDesc" type="text" placeholder="Description" />
        <label class="muted">Qty (integer > 0)</label>
        <input id="addQty" type="number" min="1" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" />
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnAddCancel">Cancel</button>
        <button class="btn primary" id="btnAddSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Mobile-friendly cell edit modal -->
  <div id="editItemModal" class="modal" aria-hidden="true">
    <div class="box edit-box">
      <div class="edit-header">
        <h2 id="editItemTitle">Edit Item</h2>
        <div class="edit-sub" id="editItemSub"></div>
      </div>
      <div class="edit-body">
        <div style="display:grid; grid-template-columns:1fr; gap:10px;">
          <div>
            <label class="muted" for="editItemName">Item</label>
            <input id="editItemName" type="text" placeholder="Item" autocapitalize="off" autocomplete="off" spellcheck="false" />
          </div>
          <div>
            <label class="muted" for="editItemDesc">Description</label>
            <textarea id="editItemDesc" rows="6" placeholder="Description" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>
          </div>
          <div>
            <label class="muted" for="editItemQty">Qty</label>
            <div class="qty-stepper qty-stepper--modal">
              <button class="qty-step" id="editItemQtyMinus" type="button" aria-label="Decrease qty">−</button>
              <input id="editItemQty" type="number" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" />
              <button class="qty-step" id="editItemQtyPlus" type="button" aria-label="Increase qty">+</button>
            </div>
            <div class="muted" style="margin-top:6px;">Tap +/- for small changes, or type a number.</div>
          </div>
        </div>
        <div id="editItemMsg" class="muted" style="margin-top:10px;"></div>
      </div>
      <div class="edit-footer">
        <button class="btn" id="btnEditItemCancel">Cancel</button>
        <button class="btn primary" id="btnEditItemSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Import preview -->
  <div id="previewModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Import Preview</h2>
      <div class="muted" id="previewInfo" style="margin-bottom:10px"></div>
      <div class="scroll" style="max-height:50vh">
        <table style="width:100%;border-collapse:collapse;font-size:14px">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Item</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Description</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">Old Qty</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">New Qty</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Action</th>
            </tr>
          </thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnPreviewCancel">Cancel</button>
        <button class="btn primary" id="btnPreviewApply">Apply Import</button>
      </div>
    </div>
  </div>

  <!-- Order modal -->
  <div id="orderModal" class="modal" aria-hidden="true">
    <div class="box order-box">
      <div class="order-header">
        <h2>Create Order</h2>
      </div>

      <div class="order-body">
	        <div class="section">
	          <div class="section-title"><span>Materials</span></div>
	          <div class="input-wrap" style="max-width:100%;">
	            <input id="orderSearch" type="text" placeholder="Search inventory to add items…" autocomplete="off" />
	            <button class="clear-input-btn" id="btnClearOrderSearch" type="button" aria-label="Clear search" title="Clear search" style="display:none">
	              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	                <path d="M18 6L6 18"></path>
	                <path d="M6 6l12 12"></path>
	              </svg>
	            </button>
	          </div>
	          <div id="orderResultsBody" class="order-list" style="margin-top:10px;"></div>
	        </div>

        <div class="section">
          <div class="section-title">
            <span>Order List</span>
            <span id="orderLinesInfo"></span>
          </div>
          <div id="orderLinesBody" class="order-list"></div>
        </div>

        <div class="section">
          <div class="section-title"><span>Select Order Recipient</span></div>
          <input id="orderEmail" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />
          <div id="orderEmailSuggest" class="order-suggest" aria-label="Email suggestions"></div>
        </div>

        <div class="section">
          <div class="section-title"><span>Message</span></div>
          <div style="display:grid; grid-template-columns:1fr; gap:10px;">
		            <div>
		              <div class="muted" style="margin-bottom:6px;">Subject</div>
		              <input id="orderSubject" type="text" placeholder="Order for Oakley Services, LLC (City/State)" />
		            </div>
            <div>
              <div class="muted" style="margin-bottom:6px;">Notes (optional)</div>
              <textarea id="orderNotes" rows="3" placeholder="Any notes…"></textarea>
            </div>
            <div class="order-preview">
              <div class="muted" style="margin-bottom:6px;">Email Preview</div>
              <div id="orderPreviewHtml" class="order-preview-html"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="order-footer">
        <button class="btn" id="btnOrderCancel">Close</button>
        <button class="btn" id="btnOrderCopy">Copy</button>
        <button class="btn primary order-send" id="btnOrderSubmit">Send</button>
      </div>
    </div>
  </div>

	  <!-- Order history -->
	  <div id="orderHistoryModal" class="modal" aria-hidden="true">
	    <div class="box">
	      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
	        <h2 style="margin:0;font-size:16px;">Order History</h2>
	        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
	          <button class="btn btn-icon" id="btnOrderHistoryDownload" type="button" title="Download CSV" aria-label="Download order history CSV">
	            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
	              <polyline points="7 10 12 15 17 10"></polyline>
	              <line x1="12" y1="15" x2="12" y2="3"></line>
	            </svg>
	          </button>
	          <button class="btn" id="btnOrderHistoryRefresh" type="button">Refresh</button>
	          <button class="btn" id="btnOrderHistoryClose" type="button">Close</button>
	        </div>
	      </div>
	      <div class="input-wrap" style="max-width:100%; margin-top:10px;">
	        <input id="orderHistoryFilter" type="text" placeholder="Filter history…" autocomplete="off" />
	        <button class="clear-input-btn" id="btnClearOrderHistoryFilter" type="button" aria-label="Clear history filter" title="Clear filter" style="display:none">
	          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	            <path d="M18 6L6 18"></path>
	            <path d="M6 6l12 12"></path>
	          </svg>
	        </button>
	      </div>
	      <div id="orderHistoryList" class="history-list" aria-live="polite"></div>
	    </div>
	  </div>

  <!-- Auth modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Sign In</h2>
      <div style="display:grid; grid-template-columns:1fr; gap:8px;">
        <label class="muted">Email</label>
        <input id="authEmail" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email" />
        <label class="muted" id="authPasswordLabel">Password</label>
        <input id="authPassword" type="password" placeholder="Password" autocomplete="current-password" />
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnAuthMagic">Send Magic Link</button>
        <button class="btn" id="btnAuthToggleMode">Create Account</button>
        <button class="btn primary" id="btnAuthSubmit">Sign In</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Account</h2>
      <div class="muted" id="profileEmailDisplay" style="margin-bottom:10px;"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <div>
          <label class="muted">First Name</label>
          <input id="profileFirstName" type="text" placeholder="First" autocomplete="given-name" />
        </div>
        <div>
          <label class="muted">Last Name</label>
          <input id="profileLastName" type="text" placeholder="Last" autocomplete="family-name" />
        </div>
      </div>
      <div style="display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px;">
        <label class="muted">Phone</label>
        <input id="profilePhone" type="tel" placeholder="(555) 555-5555" autocomplete="tel" inputmode="tel" />
        <label class="muted">Shipping Address</label>
        <textarea id="profileDeliveryAddress" rows="3" placeholder="123 Main St&#10;City, ST 12345"></textarea>
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnProfileClose">Close</button>
        <button class="btn" id="btnSignOut">Sign Out</button>
        <button class="btn primary" id="btnProfileSave">Save</button>
      </div>
      <div id="profileMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    // ========================
    // State & persistence
    // ========================
    const DB_KEY='inv.single.inline.mobile.v1';
	    const state={items:[], updatedAt:null, _filter:'', _sort:{col:'name', dir:'asc'}, _order:{lines:[], email:'', subject:'', notes:'', contactName:'', search:''}};
    const APP_VERSION = '2.0.0';

    const $ = (id) => document.getElementById(String(id).replace(/^#/, ''));
    const toKey=s=>(s||'').trim().toUpperCase();
    function toInt(v,f=0){const n=Number(v); if(!Number.isFinite(n))return f; const i=Math.floor(n); return i<0?f:i;}
    function setUpdated(){ state.updatedAt=new Date().toISOString(); }
    // Persist only UI prefs; never persist items
    function save(){ const prefs={updatedAt:state.updatedAt,_filter:state._filter,_sort:state._sort}; localStorage.setItem(DB_KEY, JSON.stringify(prefs)); render(); }
    function load(){ const raw=localStorage.getItem(DB_KEY); if(raw){ try{ const p=JSON.parse(raw); if(p){ if(typeof p._filter==='string') state._filter=p._filter; if(p._sort && typeof p._sort.col==='string'){ state._sort={ col:p._sort.col, dir:(p._sort.dir==='desc'?'desc':'asc') }; } if(p.updatedAt) state.updatedAt=p.updatedAt; } } catch(e){} } }



    function dedupe(){
      const seen=new Set();
      state.items=state.items.filter(it=>{
        const k=toKey(it.name); if(!k) return false;
        if(seen.has(k)) return false;
        seen.add(k);
        if(!it.id) it.id=crypto.randomUUID();
        it.qty = toInt(it.qty,0);
        return true;
      });
    }

    // Shallow clone of items for optimistic-UI rollback
    function snapshotItems(){ return state.items.map(it => ({...it})); }

    // ========================
    // Supabase (cloud sync) — optional
    // ========================
    const SB = { client:null, ready:false, connected:false, session:null, user:null, authorized:false, profile:null };
    function sbInit(){
      const url = window.SB_URL, key = window.SB_ANON;
      if(!url || !key || SB.client){ return; }
      try{
        if(!window.supabase || typeof window.supabase.createClient !== 'function'){
          console.warn('Supabase library not loaded; running in offline mode');
          SB.ready = false;
          return;
        }
        SB.client = window.supabase.createClient(url, key);
        SB.ready = true;
      }catch(err){
        console.warn('Supabase init failed:', err);
        SB.ready = false;
      }
    }
    function updateStatusBar(){
      // Update profile dropdown UI
      const statusEl = $('profileStatus');
      const emailEl = $('profileEmail');
      const connEl = $('profileConnection');
      const signInText = $('profileSignInText');
      const signInBtn = $('profileSignIn');

      // Icon SVGs
      const signInIcon = '<svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>';
      const signOutIcon = '<svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>';

      function setSignInUI(text, icon){
        if(signInText) signInText.textContent = text;
        if(signInBtn){
          const svg = signInBtn.querySelector('svg');
          if(svg) svg.outerHTML = icon;
        }
      }

      if(statusEl) statusEl.classList.remove('online','offline','warning');

      if(!SB.ready){
        if(emailEl) emailEl.textContent = 'Not configured';
        if(connEl) connEl.textContent = 'Supabase not set up';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Configure', signInIcon);
        return;
      }
      if(!SB.session){
        if(emailEl) emailEl.textContent = 'Not signed in';
        if(connEl) connEl.textContent = 'Sign in required';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Sign In', signInIcon);
        return;
      }

      // Show user email
      const userEmail = SB.session?.user?.email || 'Unknown user';
      if(emailEl) emailEl.textContent = userEmail;

      if(!SB.authorized){
        if(connEl) connEl.textContent = 'Not authorized';
        if(statusEl) statusEl.classList.add('warning');
        setSignInUI('Sign Out', signOutIcon);
        return;
      }
      if(SB.connected){
        if(connEl) connEl.textContent = 'Connected';
        if(statusEl) statusEl.classList.add('online');
      }else{
        if(connEl) connEl.textContent = 'Offline';
        if(statusEl) statusEl.classList.add('offline');
      }
      setSignInUI('Sign Out', signOutIcon);
    }
    function explainGate(){
      if(!SB.ready) return 'Supabase not configured';
      if(!SB.session) return 'Sign in required';
      if(!SB.authorized) return 'Not authorized';
      if(!SB.connected) return 'Offline – edits disabled';
      return '';
    }
    async function checkServerHealth(){
      if(!SB.ready || !SB.session || !SB.authorized){ SB.connected=false; updateStatusBar(); return false; }
      try{
        const { error } = await SB.client
          .from('items')
          .select('id', { head:true, count:'exact' })
          .limit(1);
        if(error) throw error;
        SB.connected = true;
      }catch(e){ SB.connected=false; }
      updateStatusBar();
      return SB.connected;
    }
    function isOnline(){ return SB.ready && !!SB.session && SB.authorized && SB.connected; }
    function requireOnline(){
      if(isOnline()) return true;
      const msg = explainGate();
      if(msg) toast(msg);
      if(!SB.session) show('authModal', true);
      return false;
    }

    // ---------- Auth + profile ----------
    let AUTH_MODE = 'signin'; // or 'signup'
    function renderAuthUi(){
      const submit = $('btnAuthSubmit');
      const toggle = $('btnAuthToggleMode');
      const pw = $('authPassword');
      const pwLabel = $('authPasswordLabel');
      if(submit) submit.textContent = (AUTH_MODE === 'signup') ? 'Create Account' : 'Sign In';
      if(toggle) toggle.textContent = (AUTH_MODE === 'signup') ? 'Have Account? Sign In' : 'Create Account';
      if(pw) pw.autocomplete = (AUTH_MODE === 'signup') ? 'new-password' : 'current-password';
      if(pwLabel) pwLabel.textContent = 'Password';
    }
    function setAuthMessage(msg){
      const el = $('authMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setProfileMessage(msg){
      const el = $('profileMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    // Auto-format phone number as (XXX) XXX-XXXX
    function formatPhoneNumber(value){
      const digits = String(value || '').replace(/\D/g, '').slice(0, 10);
      if(digits.length === 0) return '';
      if(digits.length <= 3) return `(${digits}`;
      if(digits.length <= 6) return `(${digits.slice(0,3)}) ${digits.slice(3)}`;
      return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
    }

    function renderProfileUi(){
      const email = SB.user && SB.user.email ? String(SB.user.email) : '';
      const elEmail = $('profileEmailDisplay'); if(elEmail) elEmail.textContent = email ? `Signed in: ${email}` : '';
      const elFirstName = $('profileFirstName'); if(elFirstName) elFirstName.value = (SB.profile && SB.profile.first_name) ? String(SB.profile.first_name) : '';
      const elLastName = $('profileLastName'); if(elLastName) elLastName.value = (SB.profile && SB.profile.last_name) ? String(SB.profile.last_name) : '';
      const elPhone = $('profilePhone'); if(elPhone) elPhone.value = formatPhoneNumber((SB.profile && SB.profile.phone) ? String(SB.profile.phone) : '');
      const elAddress = $('profileDeliveryAddress'); if(elAddress) elAddress.value = (SB.profile && SB.profile.delivery_address) ? String(SB.profile.delivery_address) : '';
      const note = SB.session && !SB.authorized
        ? 'This account is not authorized for this inventory yet. Ask an admin to add you in Supabase.'
        : '';
      setProfileMessage(note);
    }
    async function sbEnsureProfile(){
      if(!SB.ready || !SB.user) return null;
      try{
        // Fetch profile with all fields
        let { data, error } = await SB.client
          .from('profiles')
          .select('user_id,email,first_name,last_name,phone,delivery_address')
          .eq('user_id', SB.user.id)
          .maybeSingle();
        if(error) throw error;
        if(data){
          // Ensure all fields exist
          data.first_name = data.first_name || '';
          data.last_name = data.last_name || '';
          data.phone = data.phone || '';
          data.delivery_address = data.delivery_address || '';
          SB.profile = data;
          return data;
        }
        const row = { user_id: SB.user.id, email: String(SB.user.email||'').trim(), first_name: '', last_name: '', phone: '', delivery_address: '' };
        const { error: insErr } = await SB.client.from('profiles').insert([row]);
        if(insErr) throw insErr;
        SB.profile = row;
        return row;
      }catch(e){
        console.warn('Profile ensure failed:', e);
        SB.profile = { user_id: SB.user.id, email: String(SB.user.email||'').trim(), first_name: '', last_name: '', phone: '', delivery_address: '' };
        return SB.profile;
      }
    }
    async function sbSaveProfile(firstName, lastName, phone, deliveryAddress){
      if(!SB.ready || !SB.user) throw Error('Not signed in');
      const row = {
        user_id: SB.user.id,
        email: String(SB.user.email||'').trim(),
        first_name: String(firstName||'').trim(),
        last_name: String(lastName||'').trim(),
        phone: String(phone||'').trim(),
        delivery_address: String(deliveryAddress||'').trim()
      };
      let { error } = await SB.client.from('profiles').upsert([row], { onConflict: 'user_id' });
      if(error && error.message && error.message.includes('delivery_address')){
        const fallbackRow = { user_id: row.user_id, email: row.email, first_name: row.first_name, last_name: row.last_name, phone: row.phone };
        const res = await SB.client.from('profiles').upsert([fallbackRow], { onConflict: 'user_id' });
        error = res.error;
        if(!error){
          SB.profile = { ...fallbackRow, delivery_address: '' };
          return SB.profile;
        }
      }
      if(error) throw error;
      SB.profile = row;
      return row;
    }
    async function sbCheckAuthorization(){
      if(!SB.ready || !SB.user){ SB.authorized=false; updateStatusBar(); return false; }
      try{
        const { data, error } = await SB.client
          .from('authorized_users')
          .select('user_id')
          .eq('user_id', SB.user.id)
          .maybeSingle();
        if(error) throw error;
        SB.authorized = !!data;
      }catch(e){
        console.warn('Authorization check failed:', e);
        SB.authorized = false;
      }
      updateStatusBar();
      return SB.authorized;
    }
    async function sbHandleSession(session){
      SB.session = session || null;
      SB.user = session && session.user ? session.user : null;
      SB.connected = false;
      SB.authorized = false;
      SB.profile = null;
      updateStatusBar();

      if(!SB.session){
        state.items = [];
        if(_sbChannel && SB.client){ try{ SB.client.removeChannel(_sbChannel); }catch{} _sbChannel=null; }
        render();
        show('authModal', true);
        return;
      }

      show('authModal', false);
      setAuthMessage('');

      await sbEnsureProfile();
      await sbCheckAuthorization();
      renderProfileUi();

      if(!SB.authorized){
        state.items = [];
        render();
        updateStatusBar();
        return;
      }

      await checkServerHealth();
      if(isOnline()){
        await sbLoadSnapshot();
        sbStartRealtime();
      }
    }
    async function sbAuthBoot(){
      if(!SB.ready || !SB.client) return;

      renderAuthUi();

      // Profile dropdown handlers
      const profileBtn = $('profileBtn');
      const profileDropdown = $('profileDropdown');
      const profileSignIn = $('profileSignIn');

      function toggleProfileDropdown(open){
        if(profileDropdown){
          profileDropdown.classList.toggle('open', open);
          if(profileBtn) profileBtn.setAttribute('aria-expanded', open);
        }
      }

      if(profileBtn && !profileBtn._wired){
        profileBtn._wired = true;
        profileBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          toggleProfileDropdown(!profileDropdown.classList.contains('open'));
        });
      }

      if(profileSignIn && !profileSignIn._wired){
        profileSignIn._wired = true;
        profileSignIn.addEventListener('click', ()=>{
          toggleProfileDropdown(false);
          if(!SB.session) {
            show('authModal', true);
          } else {
            // Sign out
            sbSignOut();
          }
        });
      }

      // Close profile dropdown when clicking outside
      document.addEventListener('click', (e)=>{
        if(profileDropdown && profileDropdown.classList.contains('open')){
          if(!e.target.closest('.profile-menu')){
            toggleProfileDropdown(false);
          }
        }
      });

      try{
        const { data } = await SB.client.auth.getSession();
        await sbHandleSession(data && data.session ? data.session : null);
      }catch(e){
        console.warn('Auth boot failed:', e);
        await sbHandleSession(null);
      }

      SB.client.auth.onAuthStateChange((event, session)=>{
        void sbHandleSession(session);
      });
    }
    async function sbSignIn(email, password){
      if(!SB.ready) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      const p = String(password||'');
      if(!e) throw Error('Email required');
      if(!p) throw Error('Password required');
      const { error } = await SB.client.auth.signInWithPassword({ email: e, password: p });
      if(error) throw error;
    }
    async function sbSignUp(email, password){
      if(!SB.ready) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      const p = String(password||'');
      if(!e) throw Error('Email required');
      if(!p || p.length < 6) throw Error('Password must be at least 6 characters');
      const { data, error } = await SB.client.auth.signUp({ email: e, password: p });
      if(error) throw error;
      if(data && !data.session){
        setAuthMessage('Check your email to confirm your account, then sign in.');
      }
    }
    async function sbSendMagicLink(email){
      if(!SB.ready) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      if(!e) throw Error('Email required');
      const { error } = await SB.client.auth.signInWithOtp({ email: e, options: { emailRedirectTo: location.href } });
      if(error) throw error;
    }
    async function sbSignOut(){
      if(!SB.ready || !SB.client) return;
      await SB.client.auth.signOut();
    }

    // ---------- Auth/Profile modal events ----------
    const btnAuthToggleMode = $('btnAuthToggleMode');
    if(btnAuthToggleMode) btnAuthToggleMode.addEventListener('click', ()=>{
      AUTH_MODE = (AUTH_MODE === 'signup') ? 'signin' : 'signup';
      setAuthMessage('');
      renderAuthUi();
    });

    const btnAuthMagic = $('btnAuthMagic');
    if(btnAuthMagic) btnAuthMagic.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      setAuthMessage('');
      btnAuthMagic.disabled = true;
      try{
        await sbSendMagicLink(email);
        setAuthMessage('Magic link sent. Check your email.');
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Failed to send magic link');
      }finally{
        btnAuthMagic.disabled = false;
      }
    });

    const btnAuthSubmit = $('btnAuthSubmit');
    if(btnAuthSubmit) btnAuthSubmit.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      const password = $('authPassword')?.value || '';
      setAuthMessage('');
      btnAuthSubmit.disabled = true;
      try{
        if(AUTH_MODE === 'signup') await sbSignUp(email, password);
        else await sbSignIn(email, password);
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Authentication failed');
      }finally{
        btnAuthSubmit.disabled = false;
      }
    });

    const authPassword = $('authPassword');
    if(authPassword) authPassword.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); $('btnAuthSubmit')?.click(); }
    });

    const btnProfileClose = $('btnProfileClose');
    if(btnProfileClose) btnProfileClose.addEventListener('click', ()=> show('profileModal', false));

    const openProfileSettings = $('openProfileSettings');
    if(openProfileSettings) openProfileSettings.addEventListener('click', ()=>{
      show('profileDropdown', false);
      $('profileBtn')?.setAttribute('aria-expanded', 'false');
      renderProfileUi();
      show('profileModal', true);
    });

    const profilePhoneInput = $('profilePhone');
    if(profilePhoneInput){
      profilePhoneInput.addEventListener('input', (e)=>{
        const cursorPos = e.target.selectionStart;
        const oldLen = e.target.value.length;
        e.target.value = formatPhoneNumber(e.target.value);
        const newLen = e.target.value.length;
        // Adjust cursor position after formatting
        const newPos = Math.max(0, cursorPos + (newLen - oldLen));
        e.target.setSelectionRange(newPos, newPos);
      });
    }

    const btnProfileSave = $('btnProfileSave');
    if(btnProfileSave) btnProfileSave.addEventListener('click', async ()=>{
      const firstName = $('profileFirstName')?.value || '';
      const lastName = $('profileLastName')?.value || '';
      const phone = $('profilePhone')?.value || '';
      const deliveryAddress = $('profileDeliveryAddress')?.value || '';
      setProfileMessage('');
      btnProfileSave.disabled = true;
      try{
        await sbSaveProfile(firstName, lastName, phone, deliveryAddress);
        renderProfileUi();
        toast('Profile saved');
      }catch(e){
        setProfileMessage(e && e.message ? e.message : 'Save failed');
      }finally{
        btnProfileSave.disabled = false;
      }
    });

    const btnSignOut = $('btnSignOut');
    if(btnSignOut) btnSignOut.addEventListener('click', async ()=>{
      try{
        await sbSignOut();
        show('profileModal', false);
        toast('Signed out');
      }catch(e){
        toast(e && e.message ? e.message : 'Sign out failed');
      }
    });
    async function sbLoadSnapshot(){
      if(!SB.ready || !SB.session || !SB.authorized) return;
      const { data, error } = await SB.client
        .from('items')
        .select('id,name,description,qty,updated_at')
        .order('name', { ascending:true });
      if(error){ console.warn('Supabase load error', error); return; }
      state.items = (data||[]).map(r => ({
        id:r.id, name:r.name||'', desc:r.description||'', qty:toInt(r.qty,0), updatedAt:r.updated_at||null
      }));
      setUpdated(); render();
    }
    let _sbChannel=null;
    function sbStartRealtime(){
      if(!SB.ready || !SB.session || !SB.authorized) return;
      if(_sbChannel){ SB.client.removeChannel(_sbChannel); _sbChannel=null; }
      _sbChannel = SB.client.channel('items_all')
        .on('postgres_changes', {event:'*', schema:'public', table:'items'}, payload=>{
          const row = payload.new || payload.old;
          console.log('[realtime]', payload.eventType, row && row.id, row);
          if(payload.eventType==='INSERT'){
            const i = state.items.findIndex(x=> x.id===row.id);
            if(i===-1) state.items.push({id:row.id,name:row.name,desc:row.description||'',qty:toInt(row.qty,0),updatedAt:row.updated_at});
          }else if(payload.eventType==='UPDATE'){
            const it = state.items.find(x=> x.id===row.id);
            if(it){ it.name=row.name; it.desc=row.description||''; it.qty=toInt(row.qty,0); it.updatedAt=row.updated_at; }
          }else if(payload.eventType==='DELETE'){
            state.items = state.items.filter(x=> x.id!==row.id);
          }
          setUpdated(); render();
        })
        .subscribe();
    }
    async function sbAddItem(name, desc, qty){
      const id = crypto.randomUUID();
      const { error } = await SB.client.from('items').insert([{ id, name, description:desc||'', qty:toInt(qty,0) }]);
      if(error) throw error; return id;
    }
    async function sbUpdateFields(id, fields){
      const clean = {};
      if('name' in fields) clean.name = String(fields.name||'');
      if('desc' in fields) clean.description = String(fields.desc||'');
      if('qty'  in fields) clean.qty  = toInt(fields.qty,0);
      const { error } = await SB.client.from('items').update(clean).eq('id', id);
      if(error) throw error;
    }
    async function sbDeleteMany(ids){
      const requested = Array.isArray(ids) ? ids.filter(Boolean) : [];
      if(requested.length===0) return { deleted:0, requested:0 };
      // Note: Some RLS policies may prevent returning representations of deleted rows,
      // so we do not depend on the returned data length. If no error is thrown, treat
      // it as success for all requested IDs and immediately refresh from server.
      const { error } = await SB.client
        .from('items')
        .delete()
        .in('id', requested);
      if (error) throw error;
      return { deleted: requested.length, requested: requested.length };
    }
    async function sbUpsertMany(rows){
      // Load existing rows to build a case-insensitive index by name
      const { data: existing, error: selErr } = await SB.client
        .from('items')
        .select('id,name,description,qty');
      if (selErr) throw selErr;

      const idx = new Map((existing||[]).map(it => [toKey(it.name), it]));
      const toInsert = [];
      const toUpdate = [];

      for (const r of rows){
        const k = toKey(r.name); if (!k) continue;
        const ex = idx.get(k);
        const name = String(r.name||'').trim();
        const description = String(r.desc||'').trim();
        const qty = toInt(r.qty,0);

        if (!ex){
          toInsert.push({ name, description, qty });
        } else {
          toUpdate.push({ id: ex.id, name, description: (description || ex.description || ''), qty });
        }
      }

      if (toInsert.length){
        const { error: insErr } = await SB.client.from('items').insert(toInsert);
        if (insErr) throw insErr;
      }
      // Upsert updates by primary key id (safe and efficient)
      if (toUpdate.length){
        // Chunk to avoid payload limits
        const chunks = [];
        const size = 500;
        for (let i=0;i<toUpdate.length;i+=size) chunks.push(toUpdate.slice(i, i+size));
        for (const part of chunks){
          const { error: upErr } = await SB.client.from('items').upsert(part, { onConflict: 'id' });
          if (upErr) throw upErr;
        }
      }
    }

    // ========================
    // Rendering & inline edit
    // ========================
    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function escapeHtmlAttr(s){
      return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function render(){ renderTable(); renderKpis(); }

function adjustTitleSize(){
  try{
    const h1=document.querySelector('header h1');
    const wrap=document.querySelector('.brandtext');
    if(!h1||!wrap) return;
    h1.style.whiteSpace='nowrap'; h1.style.maxWidth='100%';
    h1.style.fontSize='';
    const rootStyles = getComputedStyle(document.documentElement);
    let min = parseFloat(rootStyles.getPropertyValue('--title-min')) || 12;
    let max = parseFloat(rootStyles.getPropertyValue('--title-max')) || 56;
    let size=parseFloat(getComputedStyle(h1).fontSize)||32;
    const room = Math.max(0, wrap.getBoundingClientRect().width - 8);
    const fits = ()=> h1.scrollWidth <= room;
    if(!fits()){
      while(size>min && !fits()){ size-=1; h1.style.fontSize=size+'px'; }
    }else{
      while(size<max){ h1.style.fontSize=(size+1)+'px'; if(!fits()){ h1.style.fontSize=size+'px'; break; } size+=1; }
    }
  }catch(e){}
}

function getSort(){ return state._sort || {col:'name',dir:'asc'}; }
function applySortIndicators(){
  const srt=getSort();
  document.querySelectorAll('#invTable thead th.sortable').forEach(th=>{
    const col=th.getAttribute('data-col');
    th.removeAttribute('aria-sort');
    th.classList.remove('sorted-asc','sorted-desc');
    if(col===srt.col){
      const desc = (srt.dir==='desc');
      th.setAttribute('aria-sort', desc ? 'descending' : 'ascending');
      th.classList.add(desc ? 'sorted-desc' : 'sorted-asc');
    }
  });
}

function sortItems(arr){
  const srt=getSort(); const dir = srt.dir==='desc' ? -1 : 1; const col=srt.col||'name';
  return arr.sort((a,b)=>{
    if(col==='qty') return (toInt(a.qty,0)-toInt(b.qty,0))*dir;
    const av=toKey(String((a && a[col])||'')); const bv=toKey(String((b && b[col])||''));
    return av.localeCompare(bv)*dir;
  });
}


	function adjustDescColumnWidth(){
	  try{
	    const table = document.getElementById('invTable');
	    const colDesc = document.getElementById('col-desc');
	    if(!table || !colDesc) return;
	    const isMobile = window.matchMedia('(max-width: 768px)').matches;
	    if(isMobile){
	      colDesc.style.width = '';
	      table.querySelectorAll('td[data-col="desc"], th[data-col="desc"]').forEach(el=>{
	        el.style.whiteSpace='normal'; el.style.wordBreak='break-word'; el.style.hyphens='auto';
	      });
	      return;
	    }
    const tb = table.querySelector('tbody');
    const cells = tb? Array.from(tb.querySelectorAll('td[data-col="desc"]')) : [];
    if(cells.length===0){ colDesc.style.width=''; return; }
    // Measure using hidden span with same font
    const sample = cells[0];
    const cs = window.getComputedStyle(sample);
    const meas = document.createElement('span');
    meas.style.position='absolute'; meas.style.visibility='hidden'; meas.style.whiteSpace='nowrap';
    meas.style.font = `${cs.fontWeight} ${cs.fontSize} ${cs.fontFamily}`;
    document.body.appendChild(meas);
    let max = 0;
    for(const td of cells){
      meas.textContent = td.textContent || '';
      const w = meas.getBoundingClientRect().width; if(w>max) max=w;
    }
    document.body.removeChild(meas);
	    const tableW = table.getBoundingClientRect().width;
	    const minW = 220; // ensure readable
	    const guard = 42 + 150 + 120; // sel + qty + min name
	    const maxClamp = Math.max(160, tableW - guard);
	    const width = Math.min(Math.max(minW, Math.ceil(max+24)), Math.floor(tableW*0.7), maxClamp);
    colDesc.style.width = width + 'px';
    table.querySelectorAll('td[data-col="desc"], th[data-col="desc"]').forEach(el=>{
      el.style.whiteSpace='nowrap'; el.style.wordBreak='normal'; el.style.hyphens='manual';
    });
	  }catch(e){ /* no-op */ }
	}

	// Mobile scroll "focus" glow: highlight the card nearest the center of the scroll viewport
	let _centerGlowObs = null;
	const _centerGlowSet = new Set();
	let _centerGlowEl = null;
	let _centerGlowRaf = 0;
	let _centerGlowBound = false;

	function isMobileStacked(){
	  try{ return window.matchMedia && window.matchMedia('(max-width: 768px)').matches; }catch(e){ return false; }
	}
	function clearCenteredGlow(){
	  if(_centerGlowEl){
	    _centerGlowEl.classList.remove('scroll-focus');
	    _centerGlowEl = null;
	  }
	}
	function scheduleCenteredGlowUpdate(){
	  if(_centerGlowRaf) return;
	  _centerGlowRaf = requestAnimationFrame(()=>{
	    _centerGlowRaf = 0;
	    const wrap = $('tableWrap');
	    if(!wrap || !isMobileStacked()){
	      clearCenteredGlow();
	      return;
	    }
	    if(_centerGlowSet.size === 0) return;

	    const wrapRect = wrap.getBoundingClientRect();
	    const centerY = wrapRect.top + (wrapRect.height / 2);
	    let best = null;
	    let bestDist = Infinity;
	    for(const row of _centerGlowSet){
	      if(!row || !row.isConnected) continue;
	      const r = row.getBoundingClientRect();
	      const rowCenter = r.top + (r.height / 2);
	      const dist = Math.abs(rowCenter - centerY);
	      if(dist < bestDist){ bestDist = dist; best = row; }
	    }

	    if(!best){ clearCenteredGlow(); return; }
	    if(_centerGlowEl !== best){
	      clearCenteredGlow();
	      best.classList.add('scroll-focus');
	      _centerGlowEl = best;
	    }
	  });
	}
	function refreshCenteredGlowTargets(){
	  try{
	    if(_centerGlowObs){ _centerGlowObs.disconnect(); _centerGlowObs = null; }
	  }catch(e){}
	  _centerGlowSet.clear();
	  clearCenteredGlow();

	  const wrap = $('tableWrap');
	  if(!wrap || !isMobileStacked()) return;

	  const rows = Array.from(document.querySelectorAll('#invTable tbody tr[data-id]'));
	  if(rows.length === 0) return;

	  if(!_centerGlowBound){
	    _centerGlowBound = true;
	    wrap.addEventListener('scroll', scheduleCenteredGlowUpdate, { passive: true });
	  }

	  _centerGlowObs = new IntersectionObserver((entries)=>{
	    for(const entry of entries){
	      if(entry.isIntersecting) _centerGlowSet.add(entry.target);
	      else _centerGlowSet.delete(entry.target);
	    }
	    scheduleCenteredGlowUpdate();
	  }, { root: wrap, rootMargin: '-48% 0px -48% 0px', threshold: 0 });

	  for(const row of rows) _centerGlowObs.observe(row);
	  // First paint: observer callback will arrive shortly and schedule the update
	}

	    function renderKpis(){
	      const el=$('lastUpdate');
	      if(!el) return;
	      el.textContent = state.updatedAt? `Last Update: ${new Date(state.updatedAt).toLocaleString(undefined,{hour12:true})}` : '';
      const fb=$('filterBox'); if(fb) fb.value = state._filter || '';
          }

    // -------- Partial-optimistic DOM helpers --------
function tbodyEl(){ return document.querySelector('#invTable tbody'); }
function rowElById(id){ return tbodyEl()?.querySelector(`tr[data-id="${id}"]`) || null; }
	function cellEl(tr, col){ return tr?.querySelector(`td[data-col="${col}"]`) || null; }
	function qtyCellHTML(it){
	  const q = toInt(it.qty,0);
	  const id = escapeHtmlAttr(it.id || '');
	  return (
	    '<div class="qty-stepper qty-stepper--table" aria-label="Qty controls">'+
	      '<button type="button" class="qty-step qty-step-btn" data-id="'+id+'" data-delta="-1" aria-label="Decrease qty">−</button>'+
	      '<span class="qty-value" aria-label="Qty">'+q+'</span>'+
	      '<button type="button" class="qty-step qty-step-btn" data-id="'+id+'" data-delta="1" aria-label="Increase qty">+</button>'+
	    '</div>'
	  );
	}
	function buildRowHTML(it){
	  return (
	    '<td class="sel"><input type="checkbox" class="rowChk" data-id="'+it.id+'"></td>'+
	    '<td data-col="name"><span class="cell-val">'+escapeHtml(it.name||'')+'</span></td>'+
	    '<td data-col="desc"><span class="cell-val">'+escapeHtml(it.desc||'')+'</span></td>'+
	    '<td data-col="qty" class="qty">'+qtyCellHTML(it)+'</td>'
	  );
	}
// Insert a row into the table in sorted position by name
function insertRowSorted(it){
  const tb = tbodyEl(); if(!tb) return;
  const empty = tb.querySelector('tr[data-empty="1"]'); if(empty) empty.remove();
  const trs = Array.from(tb.querySelectorAll('tr[data-id]'));
  const k = toKey(it.name);
  let anchor = null;
  for(const tr of trs){
    const nm = tr.querySelector('td[data-col="name"]')?.textContent || '';
    if(toKey(nm) > k){ anchor = tr; break; }
  }
  const tr = document.createElement('tr');
  tr.dataset.id = it.id;
  tr.innerHTML = buildRowHTML(it);
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing(); // attach listeners to the new row
}
// Reposition existing row if its name changed
function repositionRowByName(id){
  const tb = tbodyEl(); if(!tb) return;
  const tr = rowElById(id); if(!tr) return;
  const it = state.items.find(x=> x.id===id); if(!it) return;
  tr.innerHTML = buildRowHTML(it); // refresh cells
  const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
  const k = toKey(it.name);
  let anchor = null;
  for(const r of others){
    const nm = r.querySelector('td[data-col="name"]')?.textContent || '';
    if(toKey(nm) > k){ anchor = r; break; }
  }
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing();
}
// Update just one cell
function updateCellDisplay(id, col, value){
  const tr = rowElById(id); if(!tr) return;
  const td = cellEl(tr, col); if(!td) return;
  if(col==='qty'){
    const v = String(toInt(value,0));
    const el = td.querySelector('.qty-value');
    if(el) el.textContent = v;
    else td.textContent = v;
    return;
  }
  td.textContent = String(value||'');
}

function updateFilterClearBtn(){
  const fb = $('filterBox');
  const btn = $('btnClearFilter');
  if(!fb || !btn) return;
  const has = String(fb.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderSearchClearBtn(){
  const inp = $('orderSearch');
  const btn = $('btnClearOrderSearch');
  if(!inp || !btn) return;
  const has = String(inp.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderHistoryFilterClearBtn(){
  const inp = $('orderHistoryFilter');
  const btn = $('btnClearOrderHistoryFilter');
  if(!inp || !btn) return;
  const has = String(inp.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}
// Ensure an empty-state row exists when there are no data rows
function emptyStateHtml(){
  const gate = explainGate();
  if(!gate){
    return 'No items yet. Use <b>Import File</b> or <b>Paste Data</b> above, or <b>Add Item</b> to create one.';
  }
  if(gate === 'Sign in required'){
    return 'Sign in to view your inventory. Tap the status bar above.';
  }
  if(gate === 'Not authorized'){
    return 'Not authorized for this inventory. Tap the status bar above for account details.';
  }
  if(gate.startsWith('Offline')){
    return 'Offline. Connect to load your inventory.';
  }
  return escapeHtml(gate);
}
function ensureEmptyState(){
  const tb = tbodyEl(); if(!tb) return;
  const hasRows = tb.querySelector('tr[data-id]') !== null;
  const existingEmpty = tb.querySelector('tr[data-empty="1"]');
  if(!hasRows && !existingEmpty){
    const tr=document.createElement('tr'); tr.setAttribute('data-empty','1');
    tr.innerHTML = '<td colspan="4" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
    tb.appendChild(tr);
  } else if(hasRows && existingEmpty){
    existingEmpty.remove();
  }
}
	    function renderTable(){
	      applySortIndicators();
	      const tbody=$('#invTable').querySelector('tbody'); tbody.innerHTML='';
	      const term=(state._filter||'').trim().toLowerCase();

      let items=sortItems([...state.items]);
      if(term){
        items = items.filter(it=>{
          const name=(it.name||'').toLowerCase();
          const desc=(it.desc||'').toLowerCase();
          const qty = String(toInt(it.qty,0));
          return name.includes(term) || desc.includes(term) || qty.includes(term);
        });
      }
      // Update Total Qty for the currently displayed items
      const totalEl = $('totalQty');
      if (totalEl) {
        const total = items.reduce((sum, it) => sum + toInt(it.qty,0), 0);
        totalEl.textContent = `Total Qty: ${total}`;
      }
      if(items.length===0){
      const tr=document.createElement('tr');
      tr.innerHTML = '<td colspan="5" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
      tbody.appendChild(tr);
      return;
      }
		      for(const it of items){
		        const tr=document.createElement('tr'); tr.dataset.id=it.id;
		        tr.innerHTML =
		          '<td class="sel"><input type="checkbox" class="rowChk" data-id="'+it.id+'"></td>'+
		          '<td data-col="name"><span class="cell-val">'+escapeHtml(it.name||'')+'</span></td>'+
		          '<td data-col="desc"><span class="cell-val">'+escapeHtml(it.desc||'')+'</span></td>'+
		          '<td data-col="qty" class="qty">'+qtyCellHTML(it)+'</td>'+
		          '<td class="actions"><button class="row-delete-btn" data-id="'+it.id+'" aria-label="Delete item"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></td>';
		        tbody.appendChild(tr);
		      }
	      enableInlineEditing();
	      try{ requestAnimationFrame(()=>{ adjustDescColumnWidth(); adjustTitleSize(); refreshCenteredGlowTargets(); scheduleCenteredGlowUpdate(); }); }catch(e){}
	    }

    function enableInlineEditing(){
      const tbody=$('#invTable').querySelector('tbody');
      tbody.querySelectorAll('td').forEach(td=>{
        if(td.classList.contains('sel')) return; // skip checkbox column
        td.addEventListener('click', (e)=> startCellEdit(td, e));
        td.addEventListener('dblclick', (e)=> startCellEdit(td, e));
      });
    }

    // Mobile-friendly modal editor (helps iOS cursor/precision issues)
    let _editItemCtx = null;
    let _lastEditHintPref = null;
    const _qtyCommit = new Map(); // id -> { timer, desiredQty, inFlight }

    function isIOS(){
      try{
        const ua = navigator.userAgent || '';
        const platform = navigator.platform || '';
        return /iPad|iPhone|iPod/.test(ua) || (platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }catch(e){ return false; }
    }
    function prefersModalEditing(){
      try{
        if(isIOS()) return true;
        const hasTouch = ('ontouchstart' in window) || (navigator && navigator.maxTouchPoints > 0);
        if(!hasTouch) return false;
        return window.matchMedia && (
          window.matchMedia('(pointer: coarse)').matches ||
          window.matchMedia('(hover: none)').matches ||
          window.matchMedia('(max-width: 768px)').matches
        );
      }catch(e){ return false; }
    }
    function setEditHint(){
      const el = $('editHint');
      if(!el) return;
      const pref = prefersModalEditing();
      if(pref){
        el.innerHTML = 'Tap any cell to edit; use <b>Save</b> to apply. Use <b>+/-</b> in Qty for quick changes.';
      }else{
        el.innerHTML = 'Tap any cell to edit inline; <kbd>Enter</kbd> saves, <kbd>Esc</kbd> cancels.';
      }
      if(_lastEditHintPref !== null && pref !== _lastEditHintPref){
        try{ renderTable(); }catch(e){}
      }
      _lastEditHintPref = pref;
    }

    function setEditItemMessage(msg){
      const el = $('editItemMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function closeEditItemModal(){
      _editItemCtx = null;
      setEditItemMessage('');
      show('editItemModal', false);
    }
    function openEditItemModal(id){
      const it = state.items.find(x=> x.id===id); if(!it) return;
      _editItemCtx = { id };

      const sub = $('editItemSub');
      if(sub) sub.textContent = it.name ? `Editing: ${it.name}` : '';
      const name = $('editItemName'); if(name) name.value = String(it.name||'');
      const desc = $('editItemDesc'); if(desc) desc.value = String(it.desc||'');
      const qty  = $('editItemQty');  if(qty)  qty.value  = String(toInt(it.qty,0));

      setEditItemMessage('');
      show('editItemModal', true);
      setTimeout(()=>{
        const inp = $('editItemName');
        if(!inp) return;
        inp.focus();
        try{ inp.select(); }catch(e){}
      }, 0);
    }
    function bumpEditItemQty(delta){
      const inp = $('editItemQty'); if(!inp) return;
      const q = toInt(inp.value, 0);
      const nv = Math.max(0, q + toSignedInt(delta, 0));
      inp.value = String(nv);
    }

    async function commitItemUpdate(id, updates){
      const it = state.items.find(x=> x.id===id);
      if(!it) throw Error('Item not found');

      const fields = {};
      if(updates && 'name' in updates){
        const nv = String(updates.name||'').trim();
        if(!nv) throw Error('Name required');
        const prev = String(it.name||'');
        if(nv !== prev){
          if(toKey(nv)!==toKey(prev) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))) throw Error('Duplicate name');
          fields.name = nv;
        }
      }
      if(updates && 'desc' in updates){
        const nv = String(updates.desc||'').replace(/[\r\n]+/g,' ').trim();
        const prev = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
        if(nv !== prev) fields.desc = nv;
      }
      if(updates && 'qty' in updates){
        const q = toInt(updates.qty, -1); if(q < 0) throw Error('Qty must be integer ≥ 0');
        const prev = toInt(it.qty, 0);
        if(q !== prev) fields.qty = q;
      }

      if(Object.keys(fields).length === 0) return;
      await sbUpdateFields(id, fields);
      await sbLoadSnapshot();
    }
    async function commitItemField(id, col, rawValue){
      if(col==='name') return commitItemUpdate(id, { name: rawValue });
      if(col==='desc') return commitItemUpdate(id, { desc: rawValue });
      if(col==='qty')  return commitItemUpdate(id, { qty: rawValue });
      throw Error('Unknown field');
    }

    async function saveEditItemModal(){
      if(!_editItemCtx) return;
      if(!requireOnline()) return;

      const id = _editItemCtx.id;
      const name = $('editItemName') ? $('editItemName').value : '';
      const desc = $('editItemDesc') ? $('editItemDesc').value : '';
      const qty  = $('editItemQty')  ? $('editItemQty').value  : '';

      const btnSave = $('btnEditItemSave');
      const btnCancel = $('btnEditItemCancel');
      if(btnSave) btnSave.disabled = true;
      if(btnCancel) btnCancel.disabled = true;
      setEditItemMessage('');

      try{
        await commitItemUpdate(id, { name, desc, qty });
        closeEditItemModal();
      }catch(e){
        const msg = (e && e.message) ? e.message : 'Update failed';
        setEditItemMessage(msg);
        toast(msg);
      }finally{
        if(btnSave) btnSave.disabled = false;
        if(btnCancel) btnCancel.disabled = false;
      }
    }

    // Modal editor events
    const btnEditItemCancel = $('btnEditItemCancel');
    if(btnEditItemCancel) btnEditItemCancel.addEventListener('click', closeEditItemModal);
    const btnEditItemSave = $('btnEditItemSave');
    if(btnEditItemSave) btnEditItemSave.addEventListener('click', saveEditItemModal);
    const btnQtyMinus = $('editItemQtyMinus');
    if(btnQtyMinus) btnQtyMinus.addEventListener('click', ()=> bumpEditItemQty(-1));
    const btnQtyPlus = $('editItemQtyPlus');
    if(btnQtyPlus) btnQtyPlus.addEventListener('click', ()=> bumpEditItemQty(1));

    const editItemName = $('editItemName');
    if(editItemName) editItemName.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
      if(e.key==='Enter'){
        // On mobile, Enter often means "Done" — move to description instead of saving.
        e.preventDefault();
        $('editItemDesc')?.focus();
      }
    });
    const editItemQty = $('editItemQty');
    if(editItemQty) editItemQty.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
      if(e.key==='Enter'){ e.preventDefault(); saveEditItemModal(); }
    });
    const editItemDesc = $('editItemDesc');
    if(editItemDesc) editItemDesc.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
      if((e.key==='Enter' || e.key==='NumpadEnter') && (e.metaKey || e.ctrlKey)){
        e.preventDefault(); saveEditItemModal();
      }
    });

    // Table Qty +/- (mobile): optimistic UI + debounced commit
    function toSignedInt(v, f=0){
      const n = Number(v);
      if(!Number.isFinite(n)) return f;
      return Math.trunc(n);
    }
	    function adjustDisplayedTotalQty(delta){
	      const totalEl = $('totalQty'); if(!totalEl) return;
	      const m = /Total Qty:\s*(\d+)/.exec(totalEl.textContent || '');
	      if(!m) return;
	      const cur = toInt(m[1], 0);
	      totalEl.textContent = `Total Qty: ${Math.max(0, cur + toSignedInt(delta,0))}`;
	    }
    function updateQtyCellUIForRow(id, qty){
      const tr = rowElById(id);
      const val = tr ? tr.querySelector('td[data-col="qty"] .qty-value') : null;
      if(val) val.textContent = String(toInt(qty,0));
    }
    function repositionRowByQty(id){
      const srt = getSort();
      if(!srt || srt.col !== 'qty') return;
      const tb = tbodyEl(); if(!tb) return;
      const tr = rowElById(id); if(!tr) return;
      const it = state.items.find(x=> x.id===id); if(!it) return;
      const myQty = toInt(it.qty,0);
      const myName = toKey(it.name||'');
      const desc = (srt.dir === 'desc');
      const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
      let anchor = null;
      for(const r of others){
        const rid = r.dataset.id;
        const o = state.items.find(x=> x.id===rid);
        if(!o) continue;
        const oq = toInt(o.qty,0);
        const on = toKey(o.name||'');
        if(desc){
          if(oq < myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }else{
          if(oq > myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }
      }
      if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
    }
    function queueQtyCommit(id, desiredQty){
      if(!id) return;
      const q = toInt(desiredQty, 0);
      let entry = _qtyCommit.get(id);
      if(!entry){
        entry = { timer:null, desiredQty:q, inFlight:false };
        _qtyCommit.set(id, entry);
      }
      entry.desiredQty = q;
      if(entry.timer) clearTimeout(entry.timer);
      entry.timer = setTimeout(()=> flushQtyCommit(id), 400);
    }
    async function flushQtyCommit(id){
      const entry = _qtyCommit.get(id);
      if(!entry) return;
      entry.timer = null;
      if(entry.inFlight) return;
      entry.inFlight = true;
      const qtyToSend = entry.desiredQty;
      try{
        await sbUpdateFields(id, { qty: qtyToSend });
      }catch(e){
        toast((e && e.message) ? e.message : 'Qty update failed');
        try{ await sbLoadSnapshot(); }catch{}
      }finally{
        entry.inFlight = false;
        if(entry.desiredQty !== qtyToSend){
          queueQtyCommit(id, entry.desiredQty);
        }
      }
    }

    const invTable = $('invTable');
    if(invTable){
      invTable.addEventListener('click', (e)=>{
        const btn = e.target.closest('button.qty-step-btn');
        if(!btn) return;
        const id = String(btn.dataset.id || '').trim();
        const delta = toSignedInt(btn.dataset.delta, 0);
        if(!id || !delta) return;
        if(!requireOnline()) return;
        const it = state.items.find(x=> x.id===id); if(!it) return;
        const oldQty = toInt(it.qty,0);
        const newQty = Math.max(0, oldQty + delta);
        if(newQty === oldQty) return;
        it.qty = newQty;
        updateQtyCellUIForRow(id, newQty);
        adjustDisplayedTotalQty(newQty - oldQty);
        repositionRowByQty(id);
        queueQtyCommit(id, newQty);
      });
    }

	    function startCellEdit(td, ev){
	      // If the user tapped a control inside the cell, don't open an editor.
	      if(ev && ev.target && ev.target.closest('button, input, textarea, select, a')) return;
	      if(td.querySelector('input')) return;
	      const col=td.getAttribute('data-col'); if(!col) return;
	      const tr=td.closest('tr'); const id=tr?.dataset?.id; if(!id) return;
	      const it=state.items.find(x=> x.id===id); if(!it) return;

      if(prefersModalEditing()){
        if(!requireOnline()) return;
        openEditItemModal(id);
        return;
      }

      if(!requireOnline()) return;
      const fb = $('filterBox'); if (fb) fb.value = '';
	      state._filter = '';
	      try{ updateFilterClearBtn(); }catch(e){}

	      const oldVal = (col==='qty'? String(toInt(it.qty,0)) : String(col==='name'?it.name:(it.desc||'')));
	      const prevName = String(it.name||'');
	      const prevDesc = String(it.desc||'');
	      const prevQty = toInt(it.qty,0);
	      const inp=document.createElement('input');
	      inp.type = (col==='qty')? 'number' : 'text';
	      if(col==='qty'){ inp.min='0'; inp.step='1'; inp.inputMode='numeric'; inp.pattern='[0-9]*'; inp.setAttribute('enterkeyhint','done'); }
	      inp.value = oldVal; inp.autocapitalize='off'; inp.autocomplete='off'; inp.spellcheck=false;
	      td.classList.add('editing'); td.innerHTML=''; td.appendChild(inp);
	      setTimeout(()=>{ inp.focus(); inp.select(); }, 0);

	      let _done = false;
	      const restore = ()=>{
	        if(_done) return;
	        _done = true;
	        td.classList.remove('editing');
	        if(col==='qty') td.innerHTML = qtyCellHTML(it);
	        else td.innerHTML = '<span class="cell-val">' + escapeHtml((col==='name') ? String(it.name||'') : String(it.desc||'')) + '</span>';
	      };
	      const cancel=()=>{
	        it.name = prevName;
	        it.desc = prevDesc;
	        it.qty = prevQty;
	        restore();
	      };

	      const commit = async () => {
	        if(_done) return;
	        const raw = inp.value;
	        try{
	          if(col==='name'){
	            const nv = String(raw||'').trim();
	            if(!nv){ cancel(); toast('Name required'); return; }
	            if(nv === prevName){ cancel(); return; }
	            if(toKey(nv)!==toKey(prevName) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))){ cancel(); toast('Duplicate name'); return; }
	            it.name = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'name') renderTable();
	            await sbUpdateFields(id, { name: nv });
	            return;
	          }
	          if(col==='desc'){
	            const nv = String(raw||'').replace(/[\r\n]+/g,' ').trim();
	            const pv = String(prevDesc||'').replace(/[\r\n]+/g,' ').trim();
	            if(nv === pv){ cancel(); return; }
	            it.desc = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'desc') renderTable();
	            await sbUpdateFields(id, { desc: nv });
	            return;
	          }
	          if(col==='qty'){
	            const q = toInt(raw, -1);
	            if(q < 0){ cancel(); toast('Qty must be integer ≥ 0'); return; }
	            if(q === prevQty){ cancel(); return; }
	            it.qty = q;
	            restore();
	            adjustDisplayedTotalQty(q - prevQty);
	            repositionRowByQty(id);
	            queueQtyCommit(id, q);
	            return;
	          }
	          cancel();
	        }catch(e){
	          it.name = prevName;
	          it.desc = prevDesc;
	          it.qty = prevQty;
	          try{ renderTable(); }catch(_){}
	          toast((e && e.message) ? e.message : 'Update failed');
	          try{ await sbLoadSnapshot(); }catch{}
	        }
	      };

	      inp.addEventListener('keydown', e=>{
	        if(e.key==='Enter'){ e.preventDefault(); commit(); }
	        if(e.key==='Escape'){ e.preventDefault(); cancel(); }
	      });
	      inp.addEventListener('blur', commit);
	    }

    // ========================
    // Hamburger Menu Toggle
    // ========================
    const hamburgerBtn = $('hamburgerBtn');
    const menuDropdown = $('menuDropdown');
    const menuBackdrop = $('menuBackdrop');

    function toggleMenu(open) {
      const isOpen = open !== undefined ? open : !menuDropdown.classList.contains('open');
      hamburgerBtn.classList.toggle('open', isOpen);
      menuDropdown.classList.toggle('open', isOpen);
      menuBackdrop.classList.toggle('open', isOpen);
      hamburgerBtn.setAttribute('aria-expanded', isOpen);
    }

    hamburgerBtn.addEventListener('click', () => toggleMenu());
    menuBackdrop.addEventListener('click', () => toggleMenu(false));

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && menuDropdown.classList.contains('open')) {
        toggleMenu(false);
      }
    });

    // ========================
    // Import / Paste / Export
    // ========================
    $('menuImport').addEventListener('click', ()=> { toggleMenu(false); if(!requireOnline()) return; $('#fileImport').click(); });
    $('#fileImport').addEventListener('change', async ev=>{
      if(!requireOnline()){ ev.target.value=''; return; }
      const f=ev.target.files[0]; if(!f) return; await handleFile(f); ev.target.value='';
    });

    $('menuPaste').addEventListener('click', ()=>{ toggleMenu(false); if(!requireOnline()) return; $('#pasteArea').value=''; show('pasteModal', true); });
    $('btnPasteCancel').addEventListener('click', ()=> show('pasteModal', false));
    $('btnPasteApply').addEventListener('click', ()=>{
      if(!requireOnline()) return;
      const text=$('#pasteArea').value||''; if(!text.trim()){ toast('Nothing to import'); return; }
      const rows=parseDelimitedSmart(text); const items=rowsToItems(rows);
      if(!items.length){ toast('Could not detect headers or rows'); return; }
      show('pasteModal', false);
      showPreview(items);
    });

    const drop=$('#dropZone');
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#0e1621'; });
    drop.addEventListener('dragleave', ()=>{ drop.style.background=''; });
    drop.addEventListener('drop', async e=>{
      e.preventDefault(); drop.style.background=''; if(!requireOnline()) return; const f=e.dataTransfer.files[0]; if(f) await handleFile(f);
    });

    $('#fileImportModal').addEventListener('change', async ev=>{ if(!requireOnline()){ ev.target.value=''; return; } const f=ev.target.files[0]; if(f) await handleFile(f); ev.target.value=''; });

    async function handleFile(f){
      if(!requireOnline()) return;
      try{
        const items=await parseAnyFile(f);
        if(!items.length){ toast('No rows found in file'); return; }
        show('pasteModal', false);
        showPreview(items);
      }catch(err){ toast(err.message||'Import failed'); }
    }
    function buildPreview(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      const rows=[]; let add=0, upd=0, same=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        const it=index.get(k);
        if(!it){ rows.push({name:r.name, desc:r.desc||'', oldQty:'—', newQty:toInt(r.qty,0), action:'Add'}); add++; }
        else{
          const oldQ=toInt(it.qty,0), newQ=toInt(r.qty,0);
          const act = (oldQ===newQ && (r.desc||'').trim()===String(it.desc||'').trim())? 'No change' : 'Update';
          if(act==='Update') upd++; else same++;
          rows.push({name:it.name, desc:(r.desc||it.desc||''), oldQty:oldQ, newQty:newQ, action:act});
        }
      }
      return {rows, add, upd, same, total: imported.length};
    }
    function showPreview(imported){
      const pv=buildPreview(imported);
      const info=$('previewInfo'); if(info){ info.textContent = `${pv.total} row(s): ${pv.add} add, ${pv.upd} update, ${pv.same} unchanged`; }
      const tbody=$('previewBody'); if(tbody){
        tbody.innerHTML='';
        for(const r of pv.rows){
          const tr=document.createElement('tr');
          tr.innerHTML =
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.name)}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.desc||'')}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.oldQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.newQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${r.action}</td>`;
          tbody.appendChild(tr);
        }
      }
      state._pendingImport = imported;
      show('previewModal', true);
    }
    $('btnPreviewCancel').addEventListener('click', ()=>{ state._pendingImport=null; show('previewModal', false); });
    $('btnPreviewApply').addEventListener('click', async ()=>{
      if(!requireOnline()) return;
      const imp = state._pendingImport||[]; state._pendingImport=null; show('previewModal', false);
      if(!imp.length){ toast('Nothing to import'); return; }
      try{
        await sbUpsertMany(imp);
        await sbLoadSnapshot();
        toast('Import applied');
      }catch(e){ toast(e.message || 'Import failed'); }
    });

    $('menuExport').addEventListener('click', ()=>{
      toggleMenu(false);
      const rows=[["Item","Description","Qty"]];
      for(const it of state.items){ rows.push([it.name||'', it.desc||'', String(toInt(it.qty,0))]); }
      const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventory.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // ========================
    // Order engine (email-based)
    // ========================
    function getSignedInEmail(){
      return (SB && SB.user && SB.user.email) ? String(SB.user.email).trim() : '';
    }
    function userNameFromEmail(email){
      const e = String(email || '').trim();
      const local = e.includes('@') ? e.split('@')[0] : e;
      const cleaned = local
        .replace(/[._-]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      if(!cleaned) return '';
      return cleaned
        .split(' ')
        .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : '')
        .join(' ')
        .trim();
    }
    function formatStateToken(token){
      const t = String(token || '').trim().replace(/[.,]$/,'');
      if(!t) return '';
      if(t.length === 2) return t.toUpperCase();
      return t
        .split(/[\s_-]+/)
        .map(w => w ? (w[0].toUpperCase() + w.slice(1).toLowerCase()) : '')
        .join(' ')
        .trim();
    }
	    function cityStateFromDeliveryAddress(address){
	      const raw = String(address || '').trim();
	      if(!raw) return '';

	      const normalized = raw
	        .replace(/\r?\n/g, ', ')
	        .replace(/\s+/g, ' ')
	        .trim();

	      const noCountry = normalized
	        .replace(/\b(USA|UNITED STATES|UNITED STATES OF AMERICA)\b/gi, '')
	        .replace(/\s+/g, ' ')
	        .trim();

	      // Remove ZIP (and ZIP+4) to make parsing easier.
	      const zipStripped = noCountry
	        .replace(/\s+\d{5}(?:-\d{4})?\b/g, '')
	        .replace(/\s+/g, ' ')
	        .trim();

	      // Prefer the common US format: "Street, City, ST"
	      const parts = zipStripped.split(',').map(s => s.trim()).filter(Boolean);
	      if(parts.length >= 2){
	        const last = parts[parts.length - 1] || '';
	        const stateMatch = String(last).match(/\b([A-Za-z]{2})\b/);
	        const st = stateMatch ? String(stateMatch[1]).toUpperCase() : '';
	        if(st){
	          let city = String(parts[parts.length - 2] || '').trim();
	          // If the "city" looks like it's actually a street (starts with a number), try the segment before it.
	          if(/^\d/.test(city)){
	            if(parts.length >= 3){
	              city = String(parts[parts.length - 3] || '').trim();
	            }else{
	              // Handle: "Street, City ST"
	              city = String(last).replace(new RegExp(`\\b${st}\\b`, 'i'), '').trim();
	            }
	          }
	          if(city) return `${city}, ${st}`;
	        }
	      }

	      // Fallback: last "City ST" style (no commas).
	      const m = zipStripped.match(/^(.+?)\s+([A-Za-z]{2})$/);
	      if(m){
	        const city = String(m[1] || '').replace(/,$/, '').trim();
	        const st = String(m[2] || '').toUpperCase();
	        if(city && st) return `${city}, ${st}`;
	      }

	      return '';
	    }
    function formatEasternDateTime(value){
      const d = (value instanceof Date) ? value : new Date(value);
      try{
        return new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/New_York',
          year: 'numeric',
          month: 'short',
          day: '2-digit',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true,
          timeZoneName: 'short',
        }).format(d);
      }catch{
        return d.toLocaleString(undefined, { hour12:true });
      }
    }
	    const ORDER_COMPANY_NAME = 'Oakley Services, LLC';
	    function defaultOrderSubject(){
	      const base = `Order for ${ORDER_COMPANY_NAME}`;
	      const loc = cityStateFromDeliveryAddress(SB && SB.profile ? SB.profile.delivery_address : '');
	      return loc ? `${base} (${loc})` : base;
	    }
    function orderActiveLines(){
      const ord = orderState();
      return ord.lines
        .filter(l => toInt(l.qty, 0) > 0)
        .slice()
        .sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
    }
    function orderState(){
      if(!state._order){
        state._order = { lines:[], email:'', subject:defaultOrderSubject(), notes:'', contactName:'', search:'' };
      }
      return state._order;
    }
    function getInventoryById(id){
      return state.items.find(x => x && x.id === id) || null;
    }
    function getOrderQtyForItem(id){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      return line ? toInt(line.qty, 0) : 0;
    }
    function upsertOrderLineFromItem(it, qty = 1){
      const ord = orderState();
      if(!it || !it.id) return false;
      if(ord.lines.some(l => l.id === it.id)) return false;
      ord.lines.push({ id: it.id, name: String(it.name||'').trim(), desc: String(it.desc||'').trim(), qty: toInt(qty, 1) });
      ord.lines.sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      return true;
    }
    function removeOrderLine(id){
      const ord = orderState();
      ord.lines = ord.lines.filter(l => l.id !== id);
    }
    function setOrderQty(id, qty){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      if(!line) return;
      line.qty = toInt(qty, 0);
    }
    function normalizeEmailLineItems(lineItems){
      const arr = Array.isArray(lineItems) ? lineItems : [];
      return arr
        .map((x) => {
          const part = String(x?.part || x?.name || x?.item || '').trim();
          const desc = String(x?.desc || x?.description || '').trim();
          const qty = toInt(x?.qty, 0);
          return { part, desc, qty };
        })
        .filter((x) => x.part && x.qty > 0)
        .sort((a,b)=> toKey(a.part).localeCompare(toKey(b.part)));
    }
    function buildOrderBodyFromData({ subjectLine, notes, lineItems }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim() || defaultOrderSubject();
      const out = [];

      out.push(subject);
      out.push(`Date: ${when}`);
      out.push('');
      out.push('Items:');
      out.push('');

      const active = normalizeEmailLineItems(lineItems);
      if(!active.length){
        out.push('(none)');
      }else{
        const parts = active.map(l => String(l.part||'').trim());
        const descs = active.map(l => String(l.desc||'').trim());
        const partW = Math.min(25, Math.max(4, ...parts.map(p => p.length)));
        const descW = Math.min(35, Math.max(11, ...descs.map(d => d.length)));
        const qtyW = Math.min(6, Math.max(3, ...active.map(l => String(toInt(l.qty, 0)).length)));
        out.push(`${'Item'.padEnd(partW)} | ${'Description'.padEnd(descW)} | ${'Qty'.padStart(qtyW)}`);
        out.push(`${'-'.repeat(partW)}-+-${'-'.repeat(descW)}-+-${'-'.repeat(qtyW)}`);
        for(const l of active){
          const part = String(l.part||'').replace(/\t/g,' ').trim();
          const desc = String(l.desc||'').replace(/\t/g,' ').trim();
          const qty = String(toInt(l.qty, 0)).padStart(qtyW, ' ');
          out.push(`${part.padEnd(partW)} | ${desc.padEnd(descW)} | ${qty}`);
        }
      }

      const nt = String(notes||'').trim();
      if(nt){
        out.push('');
        out.push('Notes:');
        out.push(nt);
      }

      // Add delivery info from profile
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const deliveryAddr = String(profileData.delivery_address || '').trim();
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const deliveryLines = [];
      if(fullName) deliveryLines.push(fullName);
      if(deliveryAddr) deliveryLines.push(deliveryAddr);
      if(userPhone) deliveryLines.push(userPhone);
      if(userEmail) deliveryLines.push(userEmail);

      if(deliveryLines.length){
        out.push('');
        out.push('Shipping Address:');
        for(const line of deliveryLines) out.push(line);
      }

      out.push('');
      out.push(`Built by james.johns83@gmail.com for Oakley Services, LLC | v${APP_VERSION}`);
      return out.join('\n');
    }
    function buildOrderHtmlFromData({ subjectLine, notes, lineItems }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim() || defaultOrderSubject();

      const active = normalizeEmailLineItems(lineItems);
      const rows = active.map(l=>{
        const part = escapeHtml(String(l.part||'').trim());
        const desc = escapeHtml(String(l.desc||'').trim());
        const qty = toInt(l.qty, 0);
        return (
          `<tr>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;font-weight:600;">${part}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;">${desc}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;text-align:right;font-variant-numeric:tabular-nums;font-weight:700;">${qty}</td>`+
          `</tr>`
        );
      }).join('');

      const notesRaw = String(notes||'').trim();
      const notesHtml = notesRaw ? escapeHtml(notesRaw).replace(/\n/g, '<br>') : '';

      // Build user/delivery info block from profile
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const deliveryAddr = String(profileData.delivery_address || '').trim();
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const deliveryInfoLines = [];
      if(fullName) deliveryInfoLines.push(escapeHtml(fullName));
      if(deliveryAddr) deliveryInfoLines.push(escapeHtml(deliveryAddr).replace(/\n/g, '<br>'));
      if(userPhone) deliveryInfoLines.push(escapeHtml(userPhone));
      if(userEmail) deliveryInfoLines.push(`<a href="mailto:${escapeHtmlAttr(userEmail)}" style="color:#0969da;text-decoration:underline;">${escapeHtml(userEmail)}</a>`);

      const deliveryInfoBlock = deliveryInfoLines.length
        ? (
          `<div style="margin:16px 0 16px;padding:12px;background:#f6f8fa;border:1px solid #d0d7de;border-radius:6px;">`+
            `<div style="font-weight:700;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Shipping Address</div>`+
            `<div style="font-size:14px;line-height:1.5;">${deliveryInfoLines.join('<br>')}</div>`+
          `</div>`
        )
        : '';

      const notesBlock = notesHtml
        ? (
          `<div style="margin-top:16px;">`+
            `<div style="font-weight:700;margin-bottom:6px;">Notes</div>`+
            `<div>${notesHtml}</div>`+
          `</div>`
        )
        : '';

      const itemsBlock = active.length
        ? (
          `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;table-layout:fixed;">`+
            `<colgroup>`+
              `<col style="width:35%;">`+
              `<col style="width:50%;">`+
              `<col style="width:15%;">`+
            `</colgroup>`+
            `<thead>`+
              `<tr>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Item</th>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Description</th>`+
                `<th align="right" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Qty</th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>${rows}</tbody>`+
          `</table>`
        )
        : `<div style="padding:12px;border:1px dashed #d0d7de;color:#444;">(No items)</div>`;

      return (
        `<!doctype html>`+
        `<html><body style="margin:0;padding:0;background:#ffffff;">`+
        `<div style="max-width:620px;margin:0 auto;padding:18px 16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.35;">`+
          `<h2 style="margin:0 0 10px;font-size:18px;">${escapeHtml(subject)}</h2>`+
          `<div style="font-size:13px;color:#444;margin:0 0 16px;">`+
            `<div style="margin:2px 0;"><strong>Date:</strong> ${escapeHtml(when)}</div>`+
          `</div>`+
          `<div style="margin:0 0 10px;">Please supply the following materials:</div>`+
          `${itemsBlock}`+
          `${notesBlock}`+
          `${deliveryInfoBlock}`+
          `<div style="margin-top:18px;font-size:12px;color:#6a737d;">Built by james.johns83@gmail.com for Oakley Services, LLC | v${escapeHtml(APP_VERSION)}</div>`+
        `</div>`+
        `</body></html>`
      );
    }
    function looksLikeEmailAddress(email){
      const s = String(email || '').trim();
      if(!s) return false;
      if(s.length > 254) return false;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    }
    function buildOrderBody(){
      const ord = orderState();
      const subjectLine = String(ord.subject||'').trim() || defaultOrderSubject();
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return buildOrderBodyFromData({ subjectLine, notes, lineItems });
    }
    function buildOrderHtml(){
      const ord = orderState();
      const subjectLine = String(ord.subject||'').trim() || defaultOrderSubject();
      const notesRaw = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return buildOrderHtmlFromData({ subjectLine, notes: notesRaw, lineItems });
    }
    function buildMailtoUrl(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const subject = String(ord.subject||'').trim() || defaultOrderSubject();
      const body = buildOrderBody();
      if(!to) return '';
      return `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    function getOrderApiUrl(){
      // Allow explicit override via window.ORDER_API_URL
      const override = (typeof window.ORDER_API_URL === 'string') ? window.ORDER_API_URL.trim() : '';
      if(override) return override;
      // Use Supabase Edge Function if available
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/send-order`;
      // Fallback to local dev server
      return '/api/send-order';
    }
    async function sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems }){
      const toEmail = String(to||'').trim();
      const replyTo = getSignedInEmail();
      const subject = String(subjectLine||'').trim() || defaultOrderSubject();
      const text = buildOrderBodyFromData({ subjectLine: subject, notes, lineItems });
      const html = buildOrderHtmlFromData({ subjectLine: subject, notes, lineItems });
      const apiUrl = getOrderApiUrl();

      // Build headers - include Supabase auth if using Edge Function
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        // Add auth token if user is signed in
        if(SB.session && SB.session.access_token){
          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
        }
      }

      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify({ to: toEmail, subject, text, html, replyTo }),
      });
      let data = null;
      try { data = await res.json(); } catch {}
      if(!res.ok || !data || data.ok !== true){
        const msg = (data && data.error) ? String(data.error) : `Send failed (${res.status})`;
        throw Object.assign(new Error(msg), { status: res.status, data });
      }
      return data;
    }
    async function sendOrderViaApi(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const subjectLine = String(ord.subject||'').trim() || defaultOrderSubject();
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems });
    }
    async function copyText(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return;
      }
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position='fixed';
      ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
    async function copyOrderToClipboard(){
      try{
        await copyText(buildOrderBody());
        toast('Copied order text');
      }catch{
        toast('Copy failed');
      }
    }

    async function sbFetchOrderRecipientSuggestions(prefix){
      if(!SB.ready || !SB.session || !SB.authorized) return [];
      const q = String(prefix||'').trim();
      let req = SB.client
        .from('order_recipients')
        .select('email,name,last_used_at')
        .order('last_used_at', { ascending:false })
        .limit(20);
      if(q) req = req.ilike('email', q + '%');
      const { data, error } = await req;
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbRecordOrderRecipient(email, name){
      if(!SB.ready || !SB.session || !SB.authorized) return;
      const e = String(email||'').trim().toLowerCase();
      if(!e) return;
      const row = { email: e, last_used_at: new Date().toISOString(), created_by: SB.user ? SB.user.id : null };
      const nm = String(name||'').trim();
      if(nm) row.name = nm;
      const { error } = await SB.client
        .from('order_recipients')
        .upsert([row], { onConflict: 'email' });
      if(error) throw error;
    }
    function normalizeOrderLineItems(value){
      const arr = Array.isArray(value) ? value : [];
      return arr
        .map((x) => {
          const part = String(x?.part || x?.name || x?.item || '').trim();
          let desc = String(x?.desc || x?.description || '').trim();
          // Fallback: look up description from inventory if not stored
          if(!desc && part){
            const inv = state.items.find(it => it.name === part);
            if(inv) desc = String(inv.desc || '').trim();
          }
          const qty = toInt(x?.qty, 0);
          return { part, desc, qty };
        })
        .filter((x) => x.part);
    }
    async function sbInsertOrderHistoryFromData({ toEmail, subjectLine, contactName, notes, lineItems, providerResult }){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.user) return;
      const cleaned = normalizeEmailLineItems(lineItems).map(x => ({ part: x.part, desc: x.desc, qty: x.qty }));
      const row = {
        created_by: SB.user.id,
        to_email: String(toEmail||'').trim(),
        reply_to_email: String(getSignedInEmail()||'').trim(),
        subject: String(subjectLine||'').trim() || defaultOrderSubject(),
        contact_name: String(contactName||'').trim(),
        notes: String(notes||'').trim(),
        line_items: cleaned,
        provider_result: providerResult || null,
      };
      const { error } = await SB.client.from('orders').insert([row]);
      if(error) throw error;
    }
    async function sbInsertOrderHistory(providerResult){
      const ord = orderState();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return sbInsertOrderHistoryFromData({
        toEmail: String(ord.email||'').trim(),
        subjectLine: String(ord.subject||'').trim() || defaultOrderSubject(),
        contactName: String(ord.contactName||'').trim(),
        notes: String(ord.notes||'').trim(),
        lineItems,
        providerResult,
      });
    }
	    async function sbFetchOrders(limit = 50){
	      if(!SB.ready || !SB.session || !SB.authorized) return [];
	      const lim = Math.max(1, Math.min(200, toInt(limit, 50)));
	      const { data, error } = await SB.client
	        .from('orders')
	        .select('id,created_at,to_email,reply_to_email,subject,contact_name,notes,line_items')
	        .order('created_at', { ascending:false })
	        .limit(lim);
	      if(error) throw error;
	      return Array.isArray(data) ? data : [];
	    }
	    async function sbFetchAllOrders(pageSize = 200){
	      if(!SB.ready || !SB.session || !SB.authorized) return [];
	      const size = Math.max(1, Math.min(200, toInt(pageSize, 200)));
	      let offset = 0;
	      const out = [];
	      for(let page=0; page<200; page++){
	        const { data, error } = await SB.client
	          .from('orders')
	          .select('id,created_at,to_email,reply_to_email,subject,contact_name,notes,line_items')
	          .order('created_at', { ascending:false })
	          .range(offset, offset + size - 1);
	        if(error) throw error;
	        const rows = Array.isArray(data) ? data : [];
	        out.push(...rows);
	        if(rows.length < size) break;
	        offset += size;
	      }
	      return out;
	    }
	    function csvEscape(value){
	      const s = String(value ?? '');
	      return '"' + s.replace(/"/g, '""') + '"';
	    }
	    function orderLineItemsToCsvCell(value){
	      const items = normalizeOrderLineItems(value);
	      if(!items.length) return '';
	      return items
	        .map(it => {
	          const part = String(it.part||'').trim();
	          const qty = String(toInt(it.qty,0));
	          const desc = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
	          return `${part} | ${qty} | ${desc}`;
	        })
	        .join(' ; ');
	    }
	    function buildOrderHistoryCsv(rows){
	      const header = [
	        'Order ID',
	        'Created At (UTC)',
	        'Created (Eastern)',
	        'To',
	        'Reply-To',
	        'Subject',
	        'Contact Name',
	        'Notes',
	        'Item Count',
	        'Items',
	      ];
	      const out = [header.map(csvEscape).join(',')];
	      const list = Array.isArray(rows) ? rows : [];
	      for(const o of list){
	        const id = String(o?.id || '').trim();
	        const createdAt = String(o?.created_at || '').trim();
	        const createdEastern = formatEasternDateTime(createdAt || new Date());
	        const to = String(o?.to_email || '').trim();
	        const replyTo = String(o?.reply_to_email || '').trim();
	        const subject = String(o?.subject || '').trim() || defaultOrderSubject();
	        const contact = String(o?.contact_name || '').trim();
	        const notes = String(o?.notes || '').trim();
	        const items = normalizeOrderLineItems(o?.line_items);
	        const itemsCell = orderLineItemsToCsvCell(o?.line_items);
	        out.push([
	          id,
	          createdAt,
	          createdEastern,
	          to,
	          replyTo,
	          subject,
	          contact,
	          notes,
	          String(items.length),
	          itemsCell,
	        ].map(csvEscape).join(','));
	      }
	      // Add BOM so Excel opens UTF-8 correctly
	      return '\ufeff' + out.join('\n');
	    }
	    async function downloadOrderHistoryCsv(){
	      if(!SB.ready){ toast('Supabase not configured'); return; }
	      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }

	      const btn = $('btnOrderHistoryDownload');
	      const priorTitle = btn ? btn.getAttribute('title') : '';
	      if(btn){ btn.disabled = true; btn.setAttribute('title', 'Downloading…'); }
	      try{
	        toast('Downloading order history…');
	        const rows = await sbFetchAllOrders(200);
	        if(!rows.length){ toast('No orders to download'); return; }
	        const csv = buildOrderHistoryCsv(rows);
	        const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
	        const url = URL.createObjectURL(blob);
	        const a = document.createElement('a');
	        a.href = url;
	        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
	        a.download = `order-history-${stamp}.csv`;
	        document.body.appendChild(a);
	        a.click();
	        document.body.removeChild(a);
	        URL.revokeObjectURL(url);
	        toast(`Downloaded ${rows.length} order(s)`);
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Download failed');
	      }finally{
	        if(btn){ btn.disabled = false; btn.setAttribute('title', priorTitle || 'Download CSV'); }
	      }
	    }
	    async function sbDeleteOrder(orderId){
	      if(!SB.ready || !SB.session || !SB.authorized) throw new Error('Not authorized');
	      const { error } = await SB.client
	        .from('orders')
        .delete()
        .eq('id', orderId);
      if(error) throw error;
    }
	    function renderOrderHistoryList(list, opts = {}){
	      const wrap = $('orderHistoryList');
	      if(!wrap) return;
	      wrap.innerHTML = '';
	      const rows = Array.isArray(list) ? list : [];
	      if(!rows.length){
	        const empty = document.createElement('div');
	        empty.className = 'order-empty';
	        empty.textContent = (opts && typeof opts.emptyText === 'string' && opts.emptyText.trim())
	          ? opts.emptyText
	          : 'No orders yet.';
	        wrap.appendChild(empty);
	        return;
	      }
      for(const o of rows){
        const det = document.createElement('details');
        det.className = 'history-item';
        det.dataset.orderId = String(o.id || '');

	        const subject = escapeHtml(String(o.subject||defaultOrderSubject()));
        const created = escapeHtml(formatEasternDateTime(o.created_at || ''));
        const to = escapeHtml(String(o.to_email||''));
        const replyTo = String(o.reply_to_email||'').trim();
        const contact = String(o.contact_name||'').trim();
        const notes = String(o.notes||'').trim();
        const items = normalizeOrderLineItems(o.line_items);

        const itemsTable = items.length ? (
          `<table class="history-table">`+
            `<thead>`+
              `<tr>`+
                `<th>Part #</th>`+
                `<th>Description</th>`+
                `<th style="text-align:right">Qty</th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>`+
              items.map(it =>
                `<tr>`+
                  `<td>${escapeHtml(it.part)}</td>`+
                  `<td>${escapeHtml(it.desc)}</td>`+
                  `<td class="qty">${it.qty}</td>`+
                `</tr>`
              ).join('')+
            `</tbody>`+
          `</table>`
        ) : `<div class="order-empty" style="margin-top:10px;">(No line items)</div>`;

        const orderId = String(o.id || '');
        const forwardBlock =
          `<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">`+
            `<div class="muted" style="margin-bottom:8px;letter-spacing:.08em;text-transform:uppercase;font-weight:800;">Forward</div>`+
            `<div class="order-recipient">`+
              `<input data-forward-email-id="${orderId}" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />`+
              `<button class="btn small" type="button" data-forward-send-id="${orderId}" disabled>Forward</button>`+
            `</div>`+
            `<div class="order-suggest" data-forward-suggest-id="${orderId}" aria-label="Email suggestions"></div>`+
          `</div>`;

        det.innerHTML =
          `<summary>`+
            `<div class="history-header">`+
              `<div class="history-title">${subject}</div>`+
              `<button class="btn-icon-danger" data-delete-order-id="${orderId}" aria-label="Delete order" title="Delete order">`+
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`+
              `</button>`+
            `</div>`+
            `<div class="history-meta">${created}${to ? ` • To: ${to}` : ''}</div>`+
          `</summary>`+
          `<div class="history-kv">`+
            (replyTo ? `<div><span class="muted">Reply-To:</span> ${escapeHtml(replyTo)}</div>` : '')+
            (contact ? `<div><span class="muted">Contact:</span> ${escapeHtml(contact)}</div>` : '')+
            (notes ? `<div><span class="muted">Notes:</span> ${escapeHtml(notes)}</div>` : '')+
          `</div>`+
          itemsTable +
          forwardBlock;

	        wrap.appendChild(det);
	      }
	    }
	    function orderHistorySearchText(orderRow){
	      const o = orderRow || {};
	      const createdAt = String(o.created_at || '').trim();
	      const createdEastern = String(formatEasternDateTime(createdAt || '') || '').trim();
	      const subject = String(o.subject || '').trim();
	      const to = String(o.to_email || '').trim();
	      const replyTo = String(o.reply_to_email || '').trim();
	      const contact = String(o.contact_name || '').trim();
	      const notes = String(o.notes || '').trim();
	      const id = String(o.id || '').trim();
	      const items = normalizeOrderLineItems(o.line_items);
	      const itemText = items.map(it => `${it.part} ${it.desc} ${toInt(it.qty,0)}`).join(' ');
	      return `${id} ${createdAt} ${createdEastern} ${to} ${replyTo} ${subject} ${contact} ${notes} ${itemText}`.toLowerCase();
	    }
	    function renderOrderHistoryFiltered(){
	      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
	      const raw = String(state._orderHistoryFilter || '').trim().toLowerCase();
	      if(!raw){
	        renderOrderHistoryList(rows, { emptyText: 'No orders yet.' });
	        return;
	      }
	      const tokens = raw.split(/\s+/g).filter(Boolean);
	      const out = rows.filter(r => {
	        const hay = orderHistorySearchText(r);
	        return tokens.every(t => hay.includes(t));
	      });
	      renderOrderHistoryList(out, { emptyText: 'No matching orders.' });
	    }
	    let _orderSuggestTimer = null;
	    function renderOrderEmailSuggestions(list){
	      const wrap = $('orderEmailSuggest');
	      if(!wrap) return;
      wrap.innerHTML = '';
      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
      wrap.classList.add('has-suggest');
      rows.forEach(r=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggest-chip';
        btn.dataset.suggestEmail = String(r.email);
        btn.textContent = String(r.email);
        wrap.appendChild(btn);
      });
    }
    function requestOrderEmailSuggestions(prefix){
      if(_orderSuggestTimer) clearTimeout(_orderSuggestTimer);
      const q = String(prefix||'');
      _orderSuggestTimer = setTimeout(async ()=>{
        try{
          const data = await sbFetchOrderRecipientSuggestions(q);
          renderOrderEmailSuggestions(data);
        }catch{
          renderOrderEmailSuggestions([]);
        }
      }, 160);
    }

    const _forwardSuggestTimers = new Map();
    function renderForwardEmailSuggestions(orderId, list){
      const id = String(orderId || '').trim();
      if(!id) return;
      const wrap = document.querySelector(`[data-forward-suggest-id="${id}"]`);
      if(!wrap) return;
      wrap.innerHTML = '';
      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
      wrap.classList.add('has-suggest');
      rows.forEach(r=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggest-chip';
        btn.dataset.forwardSuggestEmail = String(r.email);
        btn.textContent = String(r.email);
        wrap.appendChild(btn);
      });
    }
    function requestForwardEmailSuggestions(orderId, prefix){
      const id = String(orderId || '').trim();
      if(!id) return;
      const prev = _forwardSuggestTimers.get(id);
      if(prev) clearTimeout(prev);
      const q = String(prefix||'');
      const t = setTimeout(async ()=>{
        try{
          const data = await sbFetchOrderRecipientSuggestions(q);
          renderForwardEmailSuggestions(id, data);
        }catch{
          renderForwardEmailSuggestions(id, []);
        }
      }, 160);
      _forwardSuggestTimers.set(id, t);
    }
    async function forwardOrderFromHistory(orderId){
      const id = String(orderId || '').trim();
      if(!id) return;

      const row = state._orderHistoryById && typeof state._orderHistoryById.get === 'function'
        ? (state._orderHistoryById.get(id) || null)
        : null;
      if(!row){ toast('Order not found'); return; }

      const input = document.querySelector(`[data-forward-email-id="${id}"]`);
      const to = String(input && input.value ? input.value : '').trim();
      if(!looksLikeEmailAddress(to)){ toast('Enter a valid email'); return; }

      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Sending…'; }

      try{
        const subjectLine = String(row.subject||'').trim() || defaultOrderSubject();
        const notes = String(row.notes||'').trim();
        const lineItems = Array.isArray(row.line_items) ? row.line_items : [];

        const sendRes = await sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems });
        try{ await sbRecordOrderRecipient(to, ''); }catch{}
        try{
          await sbInsertOrderHistoryFromData({
            toEmail: to,
            subjectLine,
            contactName: '',
            notes,
            lineItems,
            providerResult: sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes,
          });
        }catch{}

        toast('Forwarded');
        if(input) input.value = '';
        renderForwardEmailSuggestions(id, []);
      }catch(e){
        toast((e && e.message) ? e.message : 'Forward failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Forward'; }
      }
    }
    let _orderHistoryReturnToOrder = false;
	    async function refreshOrderHistory(){
	      const wrap = $('orderHistoryList');
	      if(wrap) wrap.innerHTML = `<div class="muted">Loading…</div>`;
	      const btn = $('btnOrderHistoryRefresh');
	      const prior = btn ? btn.textContent : '';
	      if(btn){ btn.disabled = true; btn.textContent = 'Loading…'; }
	      try{
	        const rows = await sbFetchOrders(60);
	        state._orderHistoryRows = Array.isArray(rows) ? rows : [];
	        state._orderHistoryById = new Map((rows||[]).map(r => [String(r && r.id ? r.id : ''), r]).filter(x=>x[0]));
	        renderOrderHistoryFiltered();
	      }catch(e){
	        state._orderHistoryById = new Map();
	        state._orderHistoryRows = [];
	        const msg = e && e.message ? e.message : 'Failed to load history';
	        if(wrap) wrap.innerHTML = `<div class="order-empty">${escapeHtml(msg)}</div>`;
	      }finally{
	        if(btn){ btn.disabled = false; btn.textContent = prior || 'Refresh'; }
	      }
	    }
	    async function openOrderHistoryModal(opts = {}){
	      const returnToOrder = !!opts.returnToOrder;
	      if(!SB.ready){ toast('Supabase not configured'); return; }
	      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
	      _orderHistoryReturnToOrder = returnToOrder;
	      if(returnToOrder) show('orderModal', false);
	      show('orderHistoryModal', true);
	      const f = $('orderHistoryFilter'); if(f) f.value = state._orderHistoryFilter || '';
	      try{ updateOrderHistoryFilterClearBtn(); }catch(e){}
	      await refreshOrderHistory();
	    }
    function closeOrderHistoryModal(){
      show('orderHistoryModal', false);
      if(_orderHistoryReturnToOrder){
        _orderHistoryReturnToOrder = false;
        show('orderModal', true);
        renderOrderPreview();
      }
    }
    function renderOrderResults(){
      const ord = orderState();
      const list = $('orderResultsBody');
      if(!list) return;
      const qRaw = String(ord.search||'').trim();
      const q = toKey(qRaw);

      const items = (state.items||[]).slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      list.innerHTML = '';
      if(!items.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No inventory loaded yet.';
        list.appendChild(empty);
        return;
      }
      if(!qRaw){
        return;
      }

      const hits = items.filter(it=>{
        if(!it) return false;
        const name = toKey(it.name);
        const desc = toKey(it.desc);
        return name.includes(q) || desc.includes(q) || String(toInt(it.qty,0)).includes(qRaw);
      }).slice(0, 20);

      if(!hits.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No matches.';
        list.appendChild(empty);
        return;
      }

      for(const it of hits){
        const card = document.createElement('div');
        card.className = 'order-card';
        const desc = String(it.desc||'').trim();
        const orderQty = getOrderQtyForItem(it.id);
        card.innerHTML =
          `<div class="order-card-top">`+
            `<div class="order-meta">`+
              `<div class="order-title">${escapeHtml(it.name||'')}</div>`+
              (desc ? `<div class="order-sub">${escapeHtml(desc)}</div>` : ``)+
            `</div>`+
            `<div class="order-side">`+
              `<div class="order-kpi">`+
                `<div class="order-kpi-label">On Hand</div>`+
                `<div class="order-kpi-value">${toInt(it.qty,0)}</div>`+
              `</div>`+
              `<div class="qty-stepper">`+
                `<button class="qty-stepper-btn" data-stepper-dec="${it.id}"${orderQty === 0 ? ' disabled style="opacity:0.3"' : ''}>−</button>`+
                `<span class="qty-stepper-val">${orderQty}</span>`+
                `<button class="qty-stepper-btn" data-stepper-inc="${it.id}">+</button>`+
              `</div>`+
            `</div>`+
          `</div>`;
        list.appendChild(card);
      }
    }
    function renderOrderLines(){
      const ord = orderState();
      const list = $('orderLinesBody');
      const info = $('orderLinesInfo');
      if(!list) return;
      list.innerHTML = '';

      const lines = ord.lines.slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      if(info){
        info.textContent = lines.length ? (lines.length === 1 ? '1 item' : `${lines.length} items`) : '';
      }

      if(!lines.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No items in the order yet. Add from inventory above, or pre-select items in the main table before opening Create Order.';
        list.appendChild(empty);
        renderOrderPreview();
        return;
      }

      for(const l of lines){
        const inv = getInventoryById(l.id);
        const onHand = inv ? toInt(inv.qty, 0) : null;
        const card = document.createElement('div');
        card.className = 'order-card';
        const desc = String(l.desc||'').trim();
        card.innerHTML =
          `<div class="order-title">${escapeHtml(l.name||'')}</div>`+
          (desc ? `<div class="order-sub">${escapeHtml(desc)}</div>` : ``)+
          `<div class="order-controls">`+
            `<div class="order-control">`+
              `<div class="order-control-label">On Hand</div>`+
              `<div class="order-control-value">${onHand===null ? '—' : onHand}</div>`+
            `</div>`+
            `<div class="order-control" style="margin-left:auto;">`+
              `<div class="order-control-label" style="text-align:center;">Qty</div>`+
              `<div class="qty-stepper">`+
                `<button class="qty-stepper-btn" data-line-dec="${l.id}">−</button>`+
                `<span class="qty-stepper-val">${toInt(l.qty,0)}</span>`+
                `<button class="qty-stepper-btn" data-line-inc="${l.id}">+</button>`+
              `</div>`+
            `</div>`+
            `<div class="order-control">`+
              `<div class="order-control-spacer"></div>`+
              `<button class="order-remove-btn" data-remove-order-id="${l.id}" title="Remove">`+
                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`+
              `</button>`+
            `</div>`+
          `</div>`;
        list.appendChild(card);
      }

      renderOrderPreview();
    }
    function renderOrderPreview(){
      const ord = orderState();
      const wrap = $('orderPreviewHtml');
      if(wrap){
        const html = buildOrderHtml();
        wrap.innerHTML = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" sandbox="allow-same-origin"></iframe>`;
      }
      const replyEl = $('orderReplyToNote');
      if(replyEl){
        const e = getSignedInEmail();
        replyEl.textContent = e ? `Reply-To: ${e}` : 'Reply-To: (sign in to set)';
      }
      const histBtn = $('btnOrderHistory');
      if(histBtn){
        histBtn.disabled = !(SB.ready && SB.session && SB.authorized);
      }
      const btn = $('btnOrderSubmit');
      if(btn){
        const okEmail = !!String(ord.email||'').trim();
        const okLines = ord.lines.some(l => toInt(l.qty, 0) > 0);
        btn.disabled = !(okEmail && okLines);
      }
    }
    function openOrderModal(){
      const ord = orderState();

      const selectedIds = Array.from(document.querySelectorAll('.rowChk:checked'))
        .map(cb => cb.dataset.id)
        .filter(Boolean);

      let added = 0;
      for(const id of selectedIds){
        const it = getInventoryById(id);
        if(it && upsertOrderLineFromItem(it, 1)) added++;
      }
      if(added) toast(`Added ${added} selected item(s)`);

	      if(
	        !ord.subject
	        || ord.subject === 'Materials Order'
	        || ord.subject === 'Material Order'
		        || /^Materials? Order\s*-\s*/i.test(String(ord.subject||'').trim())
	      ){
	        ord.subject = defaultOrderSubject();
	      }

      const s = $('orderSearch'); if(s) s.value = ord.search || '';
      const e = $('orderEmail'); if(e) e.value = ord.email || '';
      const sub = $('orderSubject'); if(sub) sub.value = ord.subject || '';
      const n = $('orderNotes'); if(n) n.value = ord.notes || '';

      renderOrderResults();
      renderOrderLines();
      renderOrderPreview();
      try{ updateOrderSearchClearBtn(); }catch(e){}

      show('orderModal', true);
    }

    const menuOrder = $('menuOrder');
    if(menuOrder) menuOrder.addEventListener('click', ()=>{ toggleMenu(false); openOrderModal(); });
    const menuHistory = $('menuHistory');
    if(menuHistory) menuHistory.addEventListener('click', ()=>{ toggleMenu(false); openOrderHistoryModal({ returnToOrder: false }); });
    const btnOrderHistory = $('btnOrderHistory');
    if(btnOrderHistory) btnOrderHistory.addEventListener('click', ()=> openOrderHistoryModal({ returnToOrder: true }));
	    const btnOrderHistoryClose = $('btnOrderHistoryClose');
	    if(btnOrderHistoryClose) btnOrderHistoryClose.addEventListener('click', closeOrderHistoryModal);
	    const btnOrderHistoryDownload = $('btnOrderHistoryDownload');
	    if(btnOrderHistoryDownload) btnOrderHistoryDownload.addEventListener('click', downloadOrderHistoryCsv);
	    const btnOrderHistoryRefresh = $('btnOrderHistoryRefresh');
	    if(btnOrderHistoryRefresh) btnOrderHistoryRefresh.addEventListener('click', refreshOrderHistory);

	    const orderHistoryFilter = $('orderHistoryFilter');
	    if(orderHistoryFilter){
	      updateOrderHistoryFilterClearBtn();
	      orderHistoryFilter.addEventListener('input', ()=>{
	        state._orderHistoryFilter = orderHistoryFilter.value || '';
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	      });
	      orderHistoryFilter.addEventListener('keydown', (e)=>{
	        if(e.key==='Escape' && orderHistoryFilter.value){
	          e.preventDefault();
	          orderHistoryFilter.value = '';
	          state._orderHistoryFilter = '';
	          renderOrderHistoryFiltered();
	          updateOrderHistoryFilterClearBtn();
	        }
	      });
	    }
	    const btnClearOrderHistoryFilter = $('btnClearOrderHistoryFilter');
	    if(btnClearOrderHistoryFilter && orderHistoryFilter){
	      btnClearOrderHistoryFilter.addEventListener('click', ()=>{
	        if(!orderHistoryFilter.value) return;
	        orderHistoryFilter.value = '';
	        state._orderHistoryFilter = '';
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	        try{ orderHistoryFilter.focus(); }catch(e){}
	      });
	    }
	    const btnOrderCancel = $('btnOrderCancel');
	    if(btnOrderCancel) btnOrderCancel.addEventListener('click', ()=> show('orderModal', false));
    const btnOrderCopy = $('btnOrderCopy');
    if(btnOrderCopy) btnOrderCopy.addEventListener('click', copyOrderToClipboard);
    const btnOrderSubmit = $('btnOrderSubmit');
    if(btnOrderSubmit) btnOrderSubmit.addEventListener('click', async ()=>{
      const url = buildMailtoUrl();
      if(!url){ toast('Add at least 1 item and an email'); return; }

      const btn = $('btnOrderSubmit');
      const priorText = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Sending…'; }

	      try{
	        const sendRes = await sendOrderViaApi();
	        let historySaved = false;
	        try{
	          const ord = orderState();
	          await sbRecordOrderRecipient(ord.email, ord.contactName);
	        }catch{}
	        try{
	          await sbInsertOrderHistory(sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes);
	          historySaved = true;
	        }catch{}
	        toast(historySaved ? 'Order sent' : 'Order sent (history not saved)');
	        show('orderModal', false);
	      }catch(e){
        const msg = e && e.message ? e.message : 'Send failed';
        const fallback = confirm(`${msg}\n\nOpen your email app instead?`);
        if(fallback){ window.location.href = url; }
        else { toast(msg); }
      }finally{
        if(btn){ btn.textContent = priorText || 'Send'; }
        renderOrderPreview();
      }
    });

    const orderSearch = $('orderSearch');
    if(orderSearch){
      updateOrderSearchClearBtn();
      orderSearch.addEventListener('input', ()=>{
        const ord = orderState();
        ord.search = orderSearch.value || '';
        renderOrderResults();
        updateOrderSearchClearBtn();
      });
      orderSearch.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && orderSearch.value){
          e.preventDefault();
          orderSearch.value = '';
          const ord = orderState();
          ord.search = '';
          renderOrderResults();
          updateOrderSearchClearBtn();
        }
      });
    }
    const btnClearOrderSearch = $('btnClearOrderSearch');
    if(btnClearOrderSearch && orderSearch){
      btnClearOrderSearch.addEventListener('click', ()=>{
        if(!orderSearch.value) return;
        orderSearch.value = '';
        const ord = orderState();
        ord.search = '';
        renderOrderResults();
        updateOrderSearchClearBtn();
        try{ orderSearch.focus(); }catch(e){}
      });
    }
    const orderEmail = $('orderEmail');
    if(orderEmail) orderEmail.addEventListener('input', ()=>{
      const ord = orderState();
      ord.email = orderEmail.value || '';
      renderOrderPreview();
      requestOrderEmailSuggestions(ord.email);
    });
    if(orderEmail) orderEmail.addEventListener('focus', ()=> requestOrderEmailSuggestions(orderEmail.value || ''));
    const orderSubject = $('orderSubject');
    if(orderSubject) orderSubject.addEventListener('input', ()=>{
      const ord = orderState();
      ord.subject = orderSubject.value || '';
    });
    const orderNotes = $('orderNotes');
    if(orderNotes) orderNotes.addEventListener('input', ()=>{
      const ord = orderState();
      ord.notes = orderNotes.value || '';
      renderOrderPreview();
    });

    const orderResultsBody = $('orderResultsBody');
    if(orderResultsBody) orderResultsBody.addEventListener('click', (e)=>{
      const incBtn = e.target.closest('button[data-stepper-inc]');
      const decBtn = e.target.closest('button[data-stepper-dec]');
      if(incBtn){
        const id = incBtn.getAttribute('data-stepper-inc');
        const it = getInventoryById(id);
        if(!it) return;
        const currentQty = getOrderQtyForItem(id);
        if(currentQty === 0){
          upsertOrderLineFromItem(it, 1);
        } else {
          setOrderQty(id, currentQty + 1);
        }
        renderOrderResults();
        renderOrderLines();
      } else if(decBtn){
        const id = decBtn.getAttribute('data-stepper-dec');
        const currentQty = getOrderQtyForItem(id);
        if(currentQty <= 1){
          removeOrderLine(id);
        } else {
          setOrderQty(id, currentQty - 1);
        }
        renderOrderResults();
        renderOrderLines();
      }
    });

    const orderEmailSuggest = $('orderEmailSuggest');
    if(orderEmailSuggest) orderEmailSuggest.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-suggest-email]');
      if(!btn) return;
      const email = String(btn.dataset.suggestEmail || '').trim();
      if(!email) return;
      const ord = orderState();
      ord.email = email;
      const inp = $('orderEmail'); if(inp) inp.value = email;
      renderOrderPreview();
      renderOrderEmailSuggestions([]);
    });

    const orderHistoryList = $('orderHistoryList');
    if(orderHistoryList) orderHistoryList.addEventListener('input', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      if(btn) btn.disabled = !looksLikeEmailAddress(inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('focusin', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('click', async (e)=>{
      // Delete order button
      const delBtn = e.target.closest('button[data-delete-order-id]');
	      if(delBtn){
	        e.preventDefault();
	        e.stopPropagation();
	        const id = String(delBtn.dataset.deleteOrderId || '').trim();
	        if(!id) return;
	        if(!confirm('Delete this order from history?')) return;
	        delBtn.disabled = true;
	        try{
	          await sbDeleteOrder(id);
	          try{
	            if(state._orderHistoryById && typeof state._orderHistoryById.delete === 'function'){
	              state._orderHistoryById.delete(id);
	            }
	            if(Array.isArray(state._orderHistoryRows)){
	              state._orderHistoryRows = state._orderHistoryRows.filter(r => String(r && r.id ? r.id : '') !== id);
	            }
	          }catch(e){}
	          renderOrderHistoryFiltered();
	          toast('Order deleted');
	        }catch(err){
	          toast(err && err.message ? err.message : 'Delete failed');
	          delBtn.disabled = false;
	        }
	        return;
	      }
      const sugBtn = e.target.closest('button[data-forward-suggest-email]');
      if(sugBtn){
        const email = String(sugBtn.dataset.forwardSuggestEmail || '').trim();
        const wrap = sugBtn.closest('[data-forward-suggest-id]');
        const id = wrap ? String(wrap.dataset.forwardSuggestId || '').trim() : '';
        if(id && email){
          const inp = document.querySelector(`input[data-forward-email-id="${id}"]`);
          if(inp) inp.value = email;
          const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
          if(btn) btn.disabled = false;
          renderForwardEmailSuggestions(id, []);
        }
        return;
      }
      const fwdBtn = e.target.closest('button[data-forward-send-id]');
      if(fwdBtn){
        const id = String(fwdBtn.dataset.forwardSendId || '').trim();
        if(!id) return;
        void forwardOrderFromHistory(id);
      }
    });
    const orderLinesBody = $('orderLinesBody');
    if(orderLinesBody) orderLinesBody.addEventListener('click', (e)=>{
      // Remove button
      const removeBtn = e.target.closest('button[data-remove-order-id]');
      if(removeBtn){
        removeOrderLine(removeBtn.getAttribute('data-remove-order-id'));
        renderOrderResults();
        renderOrderLines();
        return;
      }
      // Stepper increment
      const incBtn = e.target.closest('button[data-line-inc]');
      if(incBtn){
        const id = incBtn.getAttribute('data-line-inc');
        const currentQty = getOrderQtyForItem(id);
        setOrderQty(id, currentQty + 1);
        renderOrderResults();
        renderOrderLines();
        return;
      }
      // Stepper decrement
      const decBtn = e.target.closest('button[data-line-dec]');
      if(decBtn){
        const id = decBtn.getAttribute('data-line-dec');
        const currentQty = getOrderQtyForItem(id);
        if(currentQty <= 1){
          removeOrderLine(id);
        } else {
          setOrderQty(id, currentQty - 1);
        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
    });

    // Add-one modal
    $('menuAddOne').addEventListener('click', ()=>{ toggleMenu(false); if(!requireOnline()) return; show('addOneModal', true); $('addName').focus(); });
    $('btnAddCancel').addEventListener('click', ()=> show('addOneModal', false));
    $('btnAddSave').addEventListener('click', saveAddOne);
    $('addQty').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); saveAddOne(); }});
    async function saveAddOne(){
      if(!requireOnline()) return;
      const name = String(($('addName').value||'').trim());
      const desc = String(($('addDesc').value||'').trim());
      const qty  = toInt($('addQty').value,-1);
      if(!name){ toast('Item name required'); return; }
      if(qty<=0){ toast('Qty must be > 0'); return; }
      if(state.items.some(x=> toKey(x.name)===toKey(name))){ toast('Duplicate item'); return; }

      try{
        await sbAddItem(name, desc, qty);
        await sbLoadSnapshot();
        $('addName').value=''; $('addDesc').value=''; $('addQty').value='';
        show('addOneModal', false);
        toast('Item added');
      }catch(e){
        toast(e.message || 'Cloud add failed');
      }
    }

    // Row delete button handler (delegated)
    document.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.row-delete-btn');
      if(!btn) return;
      if(!requireOnline()) return;
      const id = btn.dataset.id;
      if(!id) return;
      const item = state.items.find(it => it.id === id);
      const itemName = item ? item.name : 'this item';
      if(!confirm(`Delete "${itemName}"?`)) return;
      try {
        const res = await sbDeleteMany([id]);
        await sbLoadSnapshot();
        toast('Item deleted', 'success');
      } catch (e) {
        toast(e.message || 'Delete failed', 'error');
      }
    });

    // Master checkbox + indeterminate state
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.id==='chkAll'){
        const on = e.target.checked;
        document.querySelectorAll('.rowChk').forEach(cb=> cb.checked=on);
      }
      if(e.target && e.target.classList && e.target.classList.contains('rowChk')){
        const all = document.querySelectorAll('.rowChk');
        const checked = document.querySelectorAll('.rowChk:checked');
        const m = $('chkAll');
        if(m){
          m.checked = (checked.length===all.length && all.length>0);
          m.indeterminate = (checked.length>0 && checked.length<all.length);
        }
      }
    });

    // ========================
    // Parsing helpers
    // ========================
    function parseDelimitedSmart(text){
      const firstLine=(text.split(/\r?\n/)[0]||'');
      let delim='\t';
      const tabScore=(firstLine.split('\t').length-1);
      const commaScore=(firstLine.split(',').length-1);
      const spaceScore=((firstLine.match(/\s{2,}/g)||[]).length);
      if(commaScore>tabScore && commaScore>=spaceScore) delim=','; else if(spaceScore>tabScore && spaceScore>commaScore) delim='  ';

      const rows=[]; let row=[]; let field=''; let inQ=false; let i=0; const N=text.length;
      const isDelim=(ch,pk)=> delim==='\t'? ch==='\t' : (delim===','? ch===',' : (ch===' ' && pk===' '));
      while(i<N){
        const ch=text[i], pk=text[i+1];
        if(ch==='"'){ if(inQ && pk==='"'){ field+='"'; i+=2; continue; } inQ=!inQ; i++; continue; }
        if(!inQ && (isDelim(ch,pk) || ch==='\n')){
          row.push(field); field='';
          if(delim==='  ' && ch===' ' && pk===' '){ while(text[i]===' ') i++; continue; }
          if(ch==='\n'){ rows.push(row); row=[]; }
          i++; continue;
        }
        if(ch==='\r'){ i++; continue; }
        field+=ch; i++;
      }
      if(field.length||row.length){ row.push(field); rows.push(row); }
      return rows.filter(r=> r.some(c=> String(c).trim().length));
    }
    function rowsToItems(rows){
      if(!rows||!rows.length) return [];
      const canon=s=> toKey(String(s).replace(/[^A-Za-z0-9]+/g,'').trim());
      const hdrsRaw=rows[0]||[]; const hdrs=hdrsRaw.map(canon);
      const idxFromHdr=names=>{ for(const n of names){ const i=hdrs.indexOf(n); if(i>=0) return i; } return -1; };
      let iItem=idxFromHdr(['ITEM','NAME']);
      let iDesc=idxFromHdr(['DESCRIPTION','DESC']);
      let iQty = idxFromHdr(['QTY','QUANTITY','COUNT','QUANTITYONHAND']);
      const hasHeader=(iItem>=0);
      if(!hasHeader){ iItem=0; iDesc=1; iQty=2; }
      const start=hasHeader?1:0; const out=[];
      for(let r=start;r<rows.length;r++){
        const row=rows[r]||[];
        const name=String((row[iItem]!==undefined? row[iItem] : '')).trim(); if(!name) continue;
        const desc=String((iDesc>=0 && row[iDesc]!==undefined? row[iDesc] : '')).trim();
        const qtyV=(iQty>=0 && row[iQty]!==undefined)? row[iQty] : 0; const qty=toInt(qtyV,0);
        out.push({name, desc, qty});
      }
      return out;
    }
    async function ensureXlsx(){
      if(window.XLSX) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load XLSX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensureDocx(){
      if(window.mammoth) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load DOCX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensurePdf(){
      if(window.pdfjsLib) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load PDF parser'));
        document.head.appendChild(s);
      });
      // Configure worker
      if(window.pdfjsLib){
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
      }
    }
    async function parsePdf(file){
      await ensurePdf();
      const buf = await file.arrayBuffer();
      const doc = await window.pdfjsLib.getDocument({ data: buf }).promise;
      const allLines = [];
      for(let p=1; p<=doc.numPages; p++){
        const page = await doc.getPage(p);
        const tc = await page.getTextContent();
        const rows = new Map(); // y -> [{x,str}]
        for(const item of tc.items){
          const t = (item.str||'').trim(); if(!t) continue;
          const tr = item.transform || [0,0,0,0,0,0];
          const x = tr[4] || 0; const y = Math.round(tr[5] || 0);
          if(!rows.has(y)) rows.set(y, []);
          rows.get(y).push({ x, str:t });
        }
        // Sort by Y descending (PDF origin bottom-left), then by X asc
        const yKeys = Array.from(rows.keys()).sort((a,b)=> b-a);
        for(const y of yKeys){
          const cols = rows.get(y).sort((a,b)=> a.x-b.x).map(o=> o.str);
          const line = cols.join(' ').replace(/\s{2,}/g,'  ').trim();
          if(line) allLines.push(line);
        }
      }
      // Try to parse with existing delimited parser
      if(allLines.length){
        const text = allLines.join('\n');
        const items = rowsToItems(parseDelimitedSmart(text));
        if(items.length) return items;
        // Fallback: pairwise lines as name/desc with qty 0
        const rows=[]; for(let i=0;i<allLines.length;i+=2){ rows.push([allLines[i]||'', allLines[i+1]||'', '0']); }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseDocx(file){
      await ensureDocx();
      const buf = await file.arrayBuffer();
      const result = await window.mammoth.convertToHtml({arrayBuffer: buf});
      const html = result && result.value ? result.value : '';
      if(!html) return [];
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      const tables = tmp.querySelectorAll('table');
      const items = [];
      if(tables.length){
        tables.forEach(tbl=>{
          const rows = Array.from(tbl.querySelectorAll('tr'))
            .map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
          const parsed = rowsToItems(rows);
          parsed.forEach(r=> items.push(r));
        });
        if(items.length) return items;
      }
      const lines = Array.from(tmp.querySelectorAll('p'))
        .map(p=> p.textContent.replace(/\u00a0/g,' ').trim())
        .filter(s=> s.length);
      if(lines.length){
        if(lines.some(l=>/[\t,]/.test(l))){
          const text = lines.join('\n');
          return rowsToItems(parseDelimitedSmart(text));
        }
        const rows = [];
        for(let i=0;i<lines.length;i++){
          const a = lines[i];
          const b = (i+1 < lines.length) ? lines[++i] : '';
          rows.push([a, b, '0']);
        }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseAnyFile(file){
      const ext=(file.name.split('.').pop()||'').toLowerCase();
      if(ext==='json'){
        const t=await file.text();
        try{
          const p=JSON.parse(t);
          if(Array.isArray(p.items)) return p.items.map(it=>({name:String(it.name||'').trim(), desc:String(it.desc||''), qty:toInt(it.qty,0)}));
          if(Array.isArray(p)) return p.map(it=>({name:String(it.Item||it.name||'').trim(), desc:String(it.Description||it.desc||''), qty:toInt(it.Qty||it.qty,0)}));
        }catch{}
        return [];
      }
      if(ext==='pdf'){ try { return await parsePdf(file); } catch { return []; } }
      if(ext==='docx' || ext==='doc'){ try { return await parseDocx(file); } catch{ return []; } }
      if(ext==='csv'||ext==='tsv'||ext==='txt'){ const t=await file.text(); return rowsToItems(parseDelimitedSmart(t)); }
      if(ext==='xlsx'||ext==='xls'){
        await ensureXlsx();
        const buf=await file.arrayBuffer();
        const wb=XLSX.read(buf,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const aoa=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
        return rowsToItems(aoa);
      }
      return [];
    }

    // ========================
    // Merge semantics (local mode)
    // ========================
    function mergeSet(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      let added=0, updated=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        let it=index.get(k);
        if(!it){
          it={id:crypto.randomUUID(), name:r.name.trim(), desc:(r.desc||'').trim(), qty:toInt(r.qty,0)};
          state.items.push(it); index.set(k,it); added++;
        }else{
          if(r.desc && r.desc.trim()) it.desc=r.desc.trim();
          it.qty=toInt(r.qty,0);
          updated++;
        }
      }
      dedupe(); setUpdated(); save();
      return {added, updated, total:imported.length};
    }

    // ========================
    // Utilities
    // ========================
    function show(id, on = true) {
  const el = document.getElementById(id);
  if (!el) return;
  if (!on) {
    // If we're hiding, and focus is inside the modal, blur it first
    if (el.contains(document.activeElement)) {
      document.activeElement.blur();
    }
    el.setAttribute('aria-hidden', 'true');
    el.style.display = 'none';
    return;
  }
  // Show and make it accessible
  el.style.display = 'block';
  el.setAttribute('aria-hidden', 'false');

  // Optional: auto-focus a sensible control
  if (id === 'addOneModal') {
    const inp = document.getElementById('addName');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'pasteModal') {
    const ta = document.getElementById('pasteArea');
    if (ta) setTimeout(() => ta.focus(), 0);
  } else if (id === 'orderModal') {
    const inp = document.getElementById('orderSearch');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'authModal') {
    const inp = document.getElementById('authEmail');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'profileModal') {
    const inp = document.getElementById('profilePhone');
    if (inp) setTimeout(() => inp.focus(), 0);
  }
}
    function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._tmr); t._tmr=setTimeout(()=> t.style.display='none', 2000); }

    // iOS keyboard-safe scroll height
    document.addEventListener('focusin', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','60vh');
      }
    });
    document.addEventListener('focusout', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','70vh');
      }
    });

    // Boot
      document.addEventListener('DOMContentLoaded', async ()=>{
      load(); render();
      try{ setEditHint(); }catch(e){}
      try{ adjustTitleSize(); if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=> requestAnimationFrame(adjustTitleSize)); } }catch(e){}
      const fb=$('filterBox'); if(fb){
        fb.value=state._filter||'';
        updateFilterClearBtn();
        fb.addEventListener('input', ()=>{ state._filter=fb.value; renderTable(); save(); updateFilterClearBtn(); });
        fb.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && fb.value){ e.preventDefault(); fb.value=''; state._filter=''; renderTable(); save(); updateFilterClearBtn(); }});
      }
      const clr=$('btnClearFilter'); if(clr && fb){
        clr.addEventListener('click', ()=>{
          if(!fb.value) return;
          fb.value='';
          state._filter='';
          renderTable();
          save();
          updateFilterClearBtn();
          try{ fb.focus(); }catch(e){}
        });
      }

      document.querySelectorAll('#invTable thead th.sortable').forEach(th=>{ th.addEventListener('click', ()=>{ const col=th.getAttribute('data-col'); if(!col) return; const srt=getSort(); if(srt.col===col){ state._sort={col, dir:(srt.dir==='asc'?'desc':'asc')}; } else { state._sort={col, dir:'asc'}; } renderTable(); save(); }); });

      // Supabase init and health check
      try{
        sbInit();
        updateStatusBar();
        await sbAuthBoot();
      }catch(e){
        console.warn('Startup error', e);
        SB.connected = false;
        updateStatusBar();
      }

      // Keep the status fresh
      window.addEventListener('online', checkServerHealth);
      window.addEventListener('offline', checkServerHealth);
      setInterval(checkServerHealth, 15000);

      // Responsive: adjust desc column width on viewport change
      window.addEventListener('resize', ()=> { try{ requestAnimationFrame(()=>{ adjustDescColumnWidth(); adjustTitleSize(); setEditHint(); refreshCenteredGlowTargets(); scheduleCenteredGlowUpdate(); }); }catch(e){} });

      // Close modals when clicking outside (on backdrop)
      document.addEventListener('click', (e)=>{
        const modal = e.target.closest('.modal');
        if(modal && e.target === modal){
          if(modal.id === 'editItemModal') return;
          show(modal.id, false);
        }
      });

      if('serviceWorker' in navigator){
        // Listen for SW activation and update flow
        let _swReloaded = false;
        navigator.serviceWorker.addEventListener('controllerchange', ()=>{
          if(_swReloaded) return; _swReloaded = true;
          try{ toast('App updated. Reloading…'); }catch{}
          setTimeout(()=> location.reload(), 400);
        });
        navigator.serviceWorker.addEventListener('message', (e)=>{
          if(!e || !e.data) return;
          if(e.data.type === 'SW_ACTIVATED'){
            // No-op: controllerchange handler above will handle reload UX
          }
        });
        navigator.serviceWorker.register('./sw.js?v=14', { scope: './' }).catch(console.warn);
      }
    });
  </script>
</body>
</html>
