<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="manifest" href="./manifest.webmanifest?v=11" />
  <link rel="icon" type="image/svg+xml" href="./assets/modulus/favicon/favicon-light.svg?v=2" media="(prefers-color-scheme: light)" />
  <link rel="icon" type="image/svg+xml" href="./assets/modulus/favicon/favicon-dark.svg?v=2" media="(prefers-color-scheme: dark)" />
  <link rel="icon" href="./assets/modulus/favicon/favicon.ico?v=2" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;1,100;1,200;1,300&family=Montserrat:ital,wght@0,100..900;1,100..900&family=Oswald:wght@200..700&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Roboto+Condensed:ital,wght@0,100..900;1,100..900&family=Roboto:ital,wght@0,100..900;1,100..900&family=Saira+Extra+Condensed:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <title>Inventory Manager by Modulus Software, LLC</title>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- Google Places Autocomplete -->
  <script data-google-places="true" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5LXJ43CBBfA5d-zAl03NBXwMVML2FMA8&libraries=places&callback=initGooglePlaces&v=weekly&loading=async" defer></script>

  <!-- Optional: set your Supabase URL and anon key here -->
  <script>
    // Supabase project credentials (safe to expose anon public key in client)
    const readLocalConfig = (key) => {
      try{
        return String(localStorage.getItem(key) || '').trim();
      }catch(e){
        return '';
      }
    };
    const overrideUrl = readLocalConfig('inv.sb_url');
    const overrideAnon = readLocalConfig('inv.sb_anon');
    const defaultUrl = 'https://entmbaxeylglposptsuy.supabase.co';
    const defaultAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVudG1iYXhleWxnbHBvc3B0c3V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ2NjEsImV4cCI6MjA3MjQ5MDY2MX0.vDTzhL0Q-iDZShWu2hcaYOavPLltY31OThXj-ohBjAc';
    window.SB_URL  = overrideUrl || window.SB_URL || defaultUrl;
    window.SB_ANON = overrideAnon || window.SB_ANON || defaultAnon;
    window.INBOUND_RECEIPT_DOMAIN = 'inbound.inventorymanager.modulus-software.com';
  </script>

  <script>
  // Lightweight observability: log JS errors so users can screenshot
  window.addEventListener('error', e => console.log('JS Error:', e.message, e.error));
  window.addEventListener('unhandledrejection', e => console.log('Promise Rejection:', e.reason));
  </script>

  <style>
    :root{
      --bg:#24292d;--fg:#eaeff7;--muted:#a9b4c0;--accent:#5aa9ff;
      --card:#000000;--border:#1f2a36;--title-min:12px;--title-max:56px;
      --app-header-offset: 140px;
      --inventory-sticky-offset: 120px;
      --success:#22c55e;
      --cyan:#06b6d4;--cyan-light:#22d3ee;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);color:var(--fg);overflow-x:hidden
    }
    body.modal-open{ overflow:hidden; }
    @media (pointer: fine){
      body{ min-width:390px; }
    }
    header{
      padding:calc(10px + env(safe-area-inset-top)) 16px 8px;
      border-bottom:1px solid var(--border);
      position:fixed;top:0;left:0;right:0;background:var(--bg);z-index:20;text-align:center;
    }
    body{ padding-top:var(--app-header-offset, 140px); overflow:hidden; height:100vh; }
    /* Onboarding view needs normal scroll behavior */
    body.onboarding-route{ overflow:auto; height:auto; padding-top:0; }
    .header-inner{ max-width:1100px; margin:0 auto; padding:0 24px; }
.status{margin-top:8px;display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#0d1420;color:#9fb3c8;appearance:none;-webkit-appearance:none;cursor:pointer;text-align:left}
.status.online{color:#ffffff;background:#0f2d18;border-color:#1b5432}
.status.offline{color:#ffffff;background:#2a1212;border-color:#5a1c1c}
    h1{margin:0;text-align:left;font-family:'Barlow',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; font-weight:800; font-size:clamp(var(--title-min), 6vw, var(--title-max)); letter-spacing:1px}
    main{padding:12px;max-width:1100px;margin:0 auto}
    #appMain{max-width:none;width:100%;margin:0;height:calc(100vh - var(--app-header-offset, 140px));display:flex;flex-direction:column;padding:0}
    #appMain > .card{width:100%;flex:1;display:flex;flex-direction:column;overflow:hidden;border-radius:0;border-left:none;border-right:none;border-bottom:none}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:0;align-items:center}
    .toolbar .spacer{flex:1}
    /* Toolbar stays in normal flow - no scrolling */
    #appMain .toolbar{
      flex-shrink:0;
      z-index:19;
      background:var(--card);
      padding:25px 12px 4px;
      position:relative;
    }
    :root{
      --glass-btn-blur: 14px;
      --glass-btn-radius: 14px;
      --glass-btn-shadow: 0 12px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.18);
      --glass-btn-shadow-hover: 0 16px 34px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.24);
      --btn-primary-bg: linear-gradient(135deg, rgba(90,169,255,0.35), rgba(90,169,255,0.12));
      --btn-primary-border: rgba(140,200,255,0.5);
      --btn-primary-color: #eaf2ff;
      --btn-secondary-bg: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      --btn-secondary-border: rgba(255,255,255,0.18);
      --btn-secondary-color: #eaf2ff;
      --btn-tertiary-bg: rgba(255,255,255,0.04);
      --btn-tertiary-border: rgba(255,255,255,0.12);
      --btn-tertiary-color: #dbe4f3;
      --btn-danger-bg: linear-gradient(135deg, rgba(248,113,113,0.3), rgba(248,113,113,0.12));
      --btn-danger-border: rgba(248,113,113,0.5);
      --btn-danger-color: #ffecec;
    }
    .btn-primary,
    .btn-secondary,
    .btn-tertiary{
      position:relative;
      cursor:pointer;
      border:1px solid transparent;
      padding: clamp(10px, 2.2vw, 12px) clamp(12px, 3vw, 16px);
      border-radius:var(--glass-btn-radius);
      font-weight:700;
      font-size: clamp(14px, 2.8vw, 16px);
      line-height:1.1;
      white-space:nowrap;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      backdrop-filter: blur(var(--glass-btn-blur));
      -webkit-backdrop-filter: blur(var(--glass-btn-blur));
      box-shadow: var(--glass-btn-shadow);
      transition: transform 160ms ease, box-shadow 200ms ease, border-color 200ms ease, background 200ms ease, color 200ms ease;
      overflow:hidden;
      text-decoration:none;
      font-family:inherit;
    }
    .btn-primary{ background:var(--btn-primary-bg); border-color:var(--btn-primary-border); color:var(--btn-primary-color); }
    .btn-secondary{ background:var(--btn-secondary-bg); border-color:var(--btn-secondary-border); color:var(--btn-secondary-color); }
    .btn-tertiary{ background:var(--btn-tertiary-bg); border-color:var(--btn-tertiary-border); color:var(--btn-tertiary-color); }
    .btn-danger{ background:var(--btn-danger-bg); border-color:var(--btn-danger-border); color:var(--btn-danger-color); }
    .btn-primary:hover,
    .btn-secondary:hover,
    .btn-tertiary:hover{
      transform: translateY(-1px);
      box-shadow: var(--glass-btn-shadow-hover);
      border-color: rgba(255,255,255,0.45);
    }
    .btn-primary:active,
    .btn-secondary:active,
    .btn-tertiary:active{
      transform: translateY(1px) scale(0.98);
    }
    .btn-primary:focus-visible,
    .btn-secondary:focus-visible,
    .btn-tertiary:focus-visible,
    .icon-btn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 2px rgba(125,211,252,0.6), var(--glass-btn-shadow);
    }
    .btn-with-icon svg{
      width:16px;
      height:16px;
    }
    .btn-sm{
      padding:8px 12px;
      min-height:36px;
      font-size:13px;
    }
    .btn-count{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      background:rgba(59,130,246,0.2);
      color:#bfdbfe;
      font-size:11px;
      font-weight:700;
      margin-left:6px;
    }
    .btn-primary[disabled],
    .btn-secondary[disabled],
    .btn-tertiary[disabled],
    .btn-primary[aria-disabled="true"],
    .btn-secondary[aria-disabled="true"],
    .btn-tertiary[aria-disabled="true"]{
      opacity:0.4;
      cursor:not-allowed;
      pointer-events:none;
      transform:none;
    }
    .btn-spinner{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
    }
    .btn-spinner svg{
      width:18px;
      height:18px;
      animation:btn-spin 1s linear infinite;
    }
    button[data-loading="true"]{
      pointer-events:none;
    }
    button[data-loading="true"] > *:not(.btn-spinner){
      opacity:0;
    }
    button[data-loading="true"] .btn-spinner{
      opacity:1;
    }
    @keyframes btn-spin{
      from{ transform:rotate(0deg); }
      to{ transform:rotate(360deg); }
    }
    .btn-ripple{
      position:absolute;
      border-radius:50%;
      transform:scale(0);
      background:rgba(255,255,255,0.3);
      animation:btn-ripple 500ms ease-out;
      pointer-events:none;
      width:20px;
      height:20px;
      left:0;
      top:0;
    }
    @keyframes btn-ripple{
      from{ transform:scale(0); opacity:0.5; }
      to{ transform:scale(4); opacity:0; }
    }
    /* Modern toggle switch */
    .toggle-switch{
      position:relative;
      width:48px;
      height:26px;
      flex-shrink:0;
    }
    .toggle-switch input{
      opacity:0;
      width:0;
      height:0;
      position:absolute;
    }
    .toggle-slider{
      position:absolute;
      cursor:pointer;
      inset:0;
      background:#374151;
      border-radius:26px;
      transition:background 0.25s ease, box-shadow 0.25s ease;
    }
    .toggle-slider::before{
      content:'';
      position:absolute;
      width:20px;
      height:20px;
      left:3px;
      bottom:3px;
      background:#fff;
      border-radius:50%;
      transition:transform 0.25s ease;
      box-shadow:0 1px 3px rgba(0,0,0,0.3);
    }
    .toggle-switch input:checked + .toggle-slider{
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.4);
    }
    .toggle-switch input:checked + .toggle-slider::before{
      transform:translateX(22px);
    }
    .toggle-switch input:focus + .toggle-slider{
      box-shadow:0 0 0 2px rgba(34,197,94,0.3);
    }
    .muted{color:var(--muted);font-size:12px}
    .time{font-size:12px;color:var(--muted)}
    .scroll{overflow:auto;max-height:70vh;border-radius:10px;position:relative;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
    /* Inventory scroll container - fills remaining space in flex layout */
    #tableWrap{ overflow-y:auto; overflow-x:hidden; position:relative; width:100%; max-width:100%; min-width:0; flex:1; margin-top:0; max-height:none; }
    #invCardGrid{ margin-top:0; flex:1; overflow-y:auto; }
    table{width:100%;border-collapse:collapse;font-size:15px}
    #invTable{ width:100%; table-layout:fixed; min-width:0; }
    #invTable th,
    #invTable td{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
	    thead th{
	      text-align:center;color:#e2e8f0;font-weight:700;border-bottom:2px solid var(--border);
	      padding:14px 12px;position:sticky;top:var(--inventory-sticky-offset, 0px);background:#0d1117;z-index:7;
	      text-transform:uppercase;font-size:12px;letter-spacing:0.5px;
	      white-space:nowrap;
	    }
	    #invTable thead th::after{
	      content:'';
	      position:absolute;
	      right:0;
	      top:8px;
	      bottom:8px;
	      width:2px;
	      background:rgba(148,163,184,0.55);
	    }
	    #invTable thead th:last-child::after{ display:none; }
	    /* Table header alignment + contrast */
    #invTable thead th[data-col="name"]{
      text-align:left;
    }
    #invTable thead th.actions{
      text-align:right;
      padding-right:14px;
    }
    #invTable thead th.align-left,
    #invTable tbody td.align-left{
      text-align:left;
    }
    #invTable thead th.num,
    #invTable tbody td.num{
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    #invTable tbody td[data-col="name"]{ padding:10px 12px; }
    th.sortable{ cursor:pointer; user-select:none }
    th.sortable .sort-ind{
      margin-left:6px;
      display:inline-block;
      padding:4px 6px;
      border-radius:4px;
      transition:background 0.15s, opacity 0.15s;
    }
    th.sortable .sort-ind:hover{ background:rgba(148,163,184,0.2) }
    th.sorted-asc .sort-ind::before{ content:'\25B2'; opacity:1 }
    th.sorted-desc .sort-ind::before{ content:'\25BC'; opacity:1 }
    tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
    td.actions{padding:8px 14px 8px 6px;text-align:right}
    .actions-wrap{display:inline-flex;gap:8px;align-items:center;justify-content:flex-end}
    .inv-item-main{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      width:100%;
    }
    .inv-row-check{
      width:22px;
      height:22px;
      flex:0 0 auto;
      touch-action:manipulation;
    }
    .inv-item-line{
      display:flex;
      align-items:baseline;
      gap:12px;
      min-width:0;
      flex:1 1 auto;
      overflow:hidden;
      white-space:nowrap;
    }
    .inv-item-name{
      font-weight:800;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #invTable tbody tr.card-expanded td{
      border-bottom-color: transparent;
    }
    .inv-detail-row td{
      padding:0 12px 14px;
      border-bottom:1px solid var(--border);
    }
    .inv-detail-panel{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.18);
      background:linear-gradient(145deg, rgba(15,20,30,0.85), rgba(12,16,24,0.9));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .inv-detail-section{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .inv-detail-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      font-weight:600;
    }
    .inv-detail-metrics{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    .inv-detail-metric{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .inv-detail-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .inv-detail-value{
      font-weight:600;
      color:var(--fg);
      min-width:0;
    }
    .inv-detail-incoming{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(99,102,241,0.35);
      background:rgba(99,102,241,0.12);
      color:#c4b5fd;
      font-size:11px;
      font-weight:600;
      line-height:1;
      max-width:100%;
    }
    .inv-detail-incoming .icon{
      width:14px;
      height:14px;
    }
    .inv-detail-incoming-text{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .inv-detail-desc{
      color:var(--muted);
      line-height:1.3;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .inv-detail-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    #invTable tbody td[data-col="desc"] .cell-val{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      white-space:normal;
      overflow:hidden;
      line-height:1.25;
    }
    .inv-item-signals{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      overflow:hidden;
    }
    .inv-item-signals:empty{ display:none; }
    .inv-signal{
      display:inline-flex;
      align-items:baseline;
      gap:6px;
      min-width:0;
      max-width:220px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .inv-signal-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      flex:0 0 auto;
    }
    .inv-signal-value{
      color:var(--fg);
      font-weight:600;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .inv-item-qty{
      margin-top:6px;
      display:none;
    }
    .inv-item-qty-label{
      display:block;
      margin-bottom:6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .inv-select-all{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .inv-select-all input{
      width:16px;
      height:16px;
    }
    @media (max-width: 520px){
      .inv-item-signals{ gap:6px; }
      .inv-signal{ max-width:140px; font-size:11px; }
    }
    @media (max-width: 720px){
      .inv-detail-metrics{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .icon{
      width:18px;
      height:18px;
      display:block;
    }
    .icon-sm{
      width:16px;
      height:16px;
    }
    .icon-btn{
      position:relative;
      width:36px;
      height:36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.06);
      color:#e2e8f0;
      cursor:pointer;
      transition: transform 160ms ease, box-shadow 200ms ease, border-color 200ms ease, background 200ms ease, color 200ms ease;
      backdrop-filter: blur(var(--glass-btn-blur));
      -webkit-backdrop-filter: blur(var(--glass-btn-blur));
      box-shadow: var(--glass-btn-shadow);
      overflow:hidden;
      padding:0;
      touch-action:manipulation;
      -webkit-appearance:none;
      appearance:none;
    }
    .icon-btn svg{ width:18px; height:18px; }
    .icon-btn--default{ color:#e2e8f0; }
    .icon-btn--success{
      color:#34d399;
      border-color:rgba(52,211,153,0.4);
      background:rgba(52,211,153,0.12);
    }
    .icon-btn--danger{
      color:#f87171;
      border-color:rgba(248,113,113,0.4);
      background:rgba(248,113,113,0.12);
    }
    .icon-btn:hover{
      transform: translateY(-1px);
      box-shadow: var(--glass-btn-shadow-hover);
      border-color: rgba(255,255,255,0.45);
    }
    .icon-btn:active{
      transform: translateY(1px) scale(0.98);
    }
    .icon-btn:disabled,
    .icon-btn[aria-disabled="true"]{
      opacity:0.4;
      cursor:not-allowed;
      pointer-events:none;
      transform:none;
    }
    .icon-btn--sm{
      width:30px;
      height:30px;
      border-radius:8px;
    }
    .icon-btn--sm svg{ width:15px; height:15px; }
    .row-order-btn .order-check{ opacity:0; transition:opacity 0.15s; }
    .row-order-btn.row-order-btn--active .order-check{ opacity:1; }
    .row-order-btn.row-order-btn--active{
      background:rgba(52,211,153,0.18);
      border-color:rgba(52,211,153,0.45);
      color:#34d399;
    }
					    /* Hidden by default (mobile-only UI elements) */
					    .card-leds{
				      display:none;
				    }
				    @media (hover: hover) and (pointer: fine){
				      #invTable tbody tr[data-id]{
				        transition: filter 160ms ease, background 160ms ease;
				        transition-delay: 0ms;
				        filter:none;
				      }
				      #invTable tbody tr[data-id]:hover{
				        transition-delay: 200ms; /* avoids flicker while scrolling */
				        filter:
				          drop-shadow(0 0 8px rgba(59,130,246,0.40))
				          drop-shadow(0 0 20px rgba(59,130,246,0.22));
				        background: linear-gradient(90deg, rgba(59,130,246,0.08) 0%, rgba(59,130,246,0.04) 50%, transparent 100%);
				      }
				      #invTable tbody tr.order-selected{
				        background:
				          radial-gradient(220px 120px at 40% 35%, rgba(34,197,94,0.20), rgba(34,197,94,0) 70%),
				          linear-gradient(145deg, rgba(34,197,94,0.12) 0%, #12161c 100%);
				      }
				      #invTable tbody tr.order-selected td{
				        background:transparent;
				        border-bottom-color: rgba(34,197,94,0.28);
				      }
				      .inv-item-name,
				      .inv-signal-value{
				        display:block;
				        white-space:nowrap;
				        overflow:hidden;
				        text-overflow:ellipsis;
				      }
				    }
				    /* Mobile table layout */
					    @media (pointer: coarse){
					      /* Ensure last row can scroll above mobile browser UI controls */
				      #tableWrap{
				        box-sizing:border-box;
				        width:100%;
				        max-width:100%;
				        padding-bottom:env(safe-area-inset-bottom);
				        scroll-padding-bottom:env(safe-area-inset-bottom);
				      }
				      #invTable{
                width:100%;
                min-width:0;
                table-layout:fixed;
              }
				      #invTable thead{ display:table-header-group; }
				      #invTable thead th{ top:0; } /* Sticky relative to tableWrap scroll container */
				      #invTable tbody{ display:table-row-group; width:100%; }
				      #invTable tbody tr[data-id]{
			        position:relative;
			        isolation:isolate;
			        min-height:68px;
			        cursor:pointer;
			        -webkit-tap-highlight-color: rgba(59,130,246,0.15);
			      }
			      #invTable tbody tr[data-id]:active{
			        background:rgba(59,130,246,0.12);
			      }
      #invTable tbody tr[data-id] td{
        padding:14px 12px;
        min-height:68px;
        height:auto;
        vertical-align:middle;
        border-bottom:1px solid rgba(255,255,255,0.08);
        position:static;
        overflow:visible;
        background:rgba(8,10,16,0.92);
      }
      #invTable tbody tr[data-id]:nth-child(even) td{
        background:rgba(18,22,32,0.95);
      }
      #invTable tbody tr.order-selected td{
        background:
          radial-gradient(220px 120px at 40% 35%, rgba(34,197,94,0.24), rgba(34,197,94,0) 70%),
          rgba(8,10,16,0.92);
        border-bottom-color: rgba(34,197,94,0.35);
      }
      #invTable tbody tr.order-selected td{
        box-shadow:
          inset 0 0 0 1px rgba(34,197,94,0.28),
          0 0 14px rgba(34,197,94,0.32);
      }
      #invTable tbody tr.order-selected td:first-child{
        border-top-left-radius:12px;
        border-bottom-left-radius:12px;
      }
      #invTable tbody tr.order-selected td:last-child{
        border-top-right-radius:12px;
        border-bottom-right-radius:12px;
      }
      #invTable tbody tr.order-selected::after{
        content:'';
        position:absolute;
        inset:2px;
        border-radius:12px;
        box-shadow:0 0 14px rgba(34,197,94,0.45);
        pointer-events:none;
        z-index:3;
      }
		      #invTable tbody tr[data-id] td .cell-val{
		        display:block;
		        overflow:hidden;
		        text-overflow:ellipsis;
		        white-space:nowrap;
		      }
		      #invTable tbody tr[data-id] td[data-col="desc"] .cell-val{
		        display:-webkit-box;
		        -webkit-line-clamp:2;
		        -webkit-box-orient:vertical;
		        white-space:normal;
		      }
		      #invTable tbody tr[data-id] td[data-col="name"]{
		        position:static; /* Allow tray to position relative to tr, not td */
		      }
		      #invTable tbody tr[data-id] td[data-col]::before{ display:none !important; }
		      /* Mobile: hide desktop action buttons */
		      #invTable thead th.actions,
		      #invTable tbody td.actions,
		      #invTable tbody td.actions .actions-wrap{ display:none !important; }

			      /* Mobile UX v2: order/override LEDs */
			      #invTable tbody tr[data-id] .card-leds{
			        position:absolute;
			        top:50%;
			        right:10px;
              transform:translateY(-50%);
			        display:flex;
			        gap:6px;
			        pointer-events:none;
			        z-index:4;
			      }
			      #invTable tbody tr[data-id] .card-led{
			        width:10px;
			        height:10px;
			        border-radius:50%;
			        background:rgba(255,255,255,0.26);
			        border:1px solid rgba(255,255,255,0.45);
			        box-shadow:0 6px 12px rgba(0,0,0,0.35), inset 0 1px 2px rgba(255,255,255,0.35);
			        backdrop-filter: blur(8px);
			        transition: background 200ms ease, box-shadow 200ms ease, filter 200ms ease;
			      }
			      #invTable tbody tr[data-id] .card-led.card-led--on{ filter:saturate(1.15); }
			      #invTable tbody tr[data-id] .card-led.card-led--lowstock.card-led--on{
			        background:rgba(245,158,11,0.7);
			        box-shadow: 0 0 10px rgba(245,158,11,0.45), inset 0 1px 2px rgba(255,255,255,0.25);
			      }
			      #invTable tbody tr[data-id] .card-led.card-led--lowstock.card-led--outofstock{
			        background:rgba(239,68,68,0.75);
			        box-shadow: 0 0 10px rgba(239,68,68,0.5), inset 0 1px 2px rgba(255,255,255,0.25);
			      }

				      /* Mobile UX v2: ensure steppers meet 48Ã—48 target */
				      .qty-step{ min-width:48px; min-height:48px; }
				      .qty-stepper--table .qty-step{ min-width:48px; }
				      #invTable tbody tr[data-id] .qty-stepper.qty-stepper--table{ gap:8px; }
				      #invTable tbody tr[data-id] .qty-stepper--table .qty-value{
				        min-width:3.25rem;
				        height:48px;
				        display:inline-flex;
				        align-items:center;
				        justify-content:center;
				        font-size:22px;
				        font-weight:900;
				      }
		    }
		    @media (prefers-reduced-motion: reduce){
		      #invTable tbody tr[data-id]{ transition:none !important; }
		      #invTable tbody tr[data-id]::before{ transition:none !important; }
		      #invTable tbody tr[data-id]::after{ transition:none !important; }
		    }

    /* Desktop description: keep on one line (dynamic width handles it) */
    @media (min-width: 769px){ td[data-col="desc"], th[data-col="desc"]{ white-space:nowrap; } }
	    td.qty{text-align:center;font-variant-numeric:tabular-nums}
    th.sel, td.sel{ width:42px; text-align:center }
    input[type=text],input[type=number],input[type=email],input[type=password],input[type=tel],textarea,select{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
      background:#0d131b;color:#fff;font-size:16px
    }
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .hero-logo{height:clamp(36px,8vw,56px); margin:10px auto 0 auto;}
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .brandrow{display:flex;align-items:center;justify-content:space-between;gap:14px}
    .title-logo{
      width:min(420px, 68vw);
      height:auto;
      display:block;
      margin:0 auto;
    }
	    .brandtext{display:flex;align-items:center;justify-content:flex-start;min-width:0;}
	    .site-footer{
	      max-width:1100px;
	      margin:16px auto 26px;
	      padding:0 16px 8px;
	      text-align:center;
	      color:var(--muted);
	      font-size:12px;
	    }
    .footer-logo{
      height:26px;
      width:auto;
      display:block;
      margin:0 auto 8px;
      opacity:.9;
    }
	    @media (max-width: 768px){
	      .footer-logo{ height:22px; }
	    }
      @media (max-width: 768px){
        #tableWrap{ width:100%; max-width:100%; min-width:0; }
      }
	    .inv-controls{ display:flex; align-items:center; justify-content:center; gap:10px; width:100%; flex-wrap:wrap; }
	    .inv-filter-group{ display:flex; align-items:center; gap:10px; flex:1 1 520px; flex-wrap:wrap; justify-content:flex-start; }
	    .input-wrap{ position:relative; width:100%; max-width:480px; }
	    .inv-filter-pills{
	      display:flex;
	      align-items:center;
	      gap:6px;
	      flex-wrap:wrap;
	    }
	    .inv-filter-pill{
	      min-height:32px;
	      padding:5px 12px;
	      border-radius:999px;
	      border:1px solid rgba(148,163,184,0.2);
	      background:rgba(12,16,22,0.5);
	      color:#cbd5f5;
	      font-size:13px;
	      font-weight:600;
	      letter-spacing:0.01em;
	      transition:background 160ms ease, border-color 160ms ease, color 160ms ease, transform 160ms ease, box-shadow 160ms ease;
	      backdrop-filter: blur(10px);
	      -webkit-backdrop-filter: blur(10px);
	    }
	    .inv-filter-pill:hover{ background:rgba(15,23,42,0.65); }
	    .inv-filter-pill:focus-visible{
	      outline:2px solid rgba(96,165,250,0.7);
	      outline-offset:2px;
	    }
	    .inv-filter-pill.is-active{
	      color:#f8fafc;
	      box-shadow:0 8px 18px rgba(0,0,0,0.28);
	    }
	    .inv-filter-pill.is-active[data-filter="all"]{
	      background:rgba(148,163,184,0.18);
	      border-color:rgba(148,163,184,0.55);
	      color:#e2e8f0;
	    }
	    .inv-filter-pill.is-active[data-filter="in_stock"]{
	      background:rgba(34,197,94,0.18);
	      border-color:rgba(34,197,94,0.6);
	      color:#bbf7d0;
	    }
	    .inv-filter-pill.is-active[data-filter="low_stock"]{
	      background:rgba(245,158,11,0.2);
	      border-color:rgba(245,158,11,0.65);
	      color:#fde68a;
	    }
	    .inv-filter-pill.is-active[data-filter="out_of_stock"]{
	      background:rgba(239,68,68,0.2);
	      border-color:rgba(239,68,68,0.65);
	      color:#fecaca;
	    }
	    .sort-wrap{ display:flex; align-items:center; flex:0 0 auto; min-width:180px; }
	    .columns-wrap{ position:relative; flex:0 0 auto; }
	    .column-builder{
	      position:absolute;
	      right:0;
	      top:calc(100% + 10px);
	      min-width:240px;
	      max-width:340px;
	      background:rgba(13,20,29,0.92);
	      border:1px solid var(--border);
	      border-radius:14px;
	      padding:12px;
	      box-shadow:0 18px 40px rgba(0,0,0,0.4);
	      backdrop-filter: blur(18px);
	      -webkit-backdrop-filter: blur(18px);
	      z-index:140;
	      display:none;
	    }
	    .column-builder.open{ display:block; }
	    .column-builder.dragging-panel{ opacity:0.96; }
	    .column-builder--centered{
	      position:fixed;
	      left:50%;
	      top:50%;
	      right:auto;
	      transform:translate(-50%, -50%);
	      max-width:min(360px, 92vw);
	      width:min(360px, 92vw);
	    }
	    .column-builder-header{
	      display:flex;
	      align-items:flex-start;
	      justify-content:space-between;
	      gap:12px;
	    }
	    .column-builder-title{ font-weight:800; font-size:13px; letter-spacing:0.02em; }
	    .column-builder-subtitle{ color:var(--muted); font-size:12px; margin-top:4px; }
	    .column-builder-drag{
	      flex:0 0 auto;
	      width:28px;
	      height:28px;
	      border-radius:8px;
	      border:1px solid var(--border);
	      background:#0d131b;
	      cursor:grab;
	      display:inline-flex;
	      align-items:center;
	      justify-content:center;
	      color:#7c8aa0;
	      padding:0;
	      touch-action:none;
	    }
	    .column-builder-drag:active{ cursor:grabbing; }
	    .column-builder-drag::before{
	      content:'';
	      width:14px;
	      height:10px;
	      background:
	        linear-gradient(#7c8aa0,#7c8aa0) 0 0 / 14px 2px,
	        linear-gradient(#7c8aa0,#7c8aa0) 0 4px / 14px 2px,
	        linear-gradient(#7c8aa0,#7c8aa0) 0 8px / 14px 2px;
	      background-repeat:no-repeat;
	    }
	    .column-builder-list{
	      display:flex;
	      flex-direction:column;
	      gap:6px;
	      margin-top:0;
	      max-height:260px;
	      overflow-y:auto;
	      padding-right:4px;
	    }
	    /* Column builder inline mode for layout tab */
	    .inv-column-sorter .column-builder-list{
	      margin-top:0;
	    }
	    .column-option{
	      display:flex;
	      align-items:center;
	      gap:12px;
	      font-size:13px;
	      color:#e2e8f0;
	      padding:12px;
	      min-height:52px;
	      border-radius:12px;
	      border:1px solid rgba(148,163,184,0.18);
	      background:rgba(12,16,22,0.6);
	      transition:background 0.16s ease, border-color 0.16s ease, transform 0.28s cubic-bezier(0.2, 0, 0, 1);
	      will-change:transform;
	    }
	    .column-option input{ width:18px; height:18px; }
	    .column-option .column-option-label{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
	    .column-option--limited{ opacity:0.45; }
	    .column-option.drag-over{
	      border-color:#1f3c57;
	      background:#0e1824;
	    }
	    .column-option.is-draggable{ cursor:grab; }
	    .column-option.is-draggable:active{ cursor:grabbing; }
	    .column-option.dragging{
	      position:fixed;
	      z-index:10000;
	      pointer-events:none;
	      box-shadow:0 8px 32px rgba(0,0,0,0.4), 0 0 0 1px rgba(99,179,237,0.4);
	      background:#0f1a28;
	      border-color:#3b82f6;
	      opacity:0.95;
	    }
	    .column-option.drag-placeholder{
	      opacity:0.4;
	      border-style:dashed;
	    }
	    .drag-handle{
	      width:20px;
	      height:20px;
	      display:inline-flex;
	      align-items:center;
	      justify-content:center;
	      font-size:14px;
	      color:#7c8aa0;
	      border-radius:6px;
	      border:1px solid var(--border);
	      background:#0d131b;
	      cursor:grab;
	      user-select:none;
	      touch-action:none;
	      margin-left:auto;
	    }
	    .drag-handle:active{ cursor:grabbing; }
	    .drag-handle.disabled{
	      opacity:0.4;
	      cursor:not-allowed;
	    }
	    .drag-handle::before{
	      content:'';
	      width:12px;
	      height:10px;
	      background:
	        linear-gradient(#7c8aa0,#7c8aa0) 0 0 / 12px 2px,
	        linear-gradient(#7c8aa0,#7c8aa0) 0 4px / 12px 2px,
	        linear-gradient(#7c8aa0,#7c8aa0) 0 8px / 12px 2px;
	      background-repeat:no-repeat;
	    }
	    .column-builder-actions{
	      display:flex;
	      gap:8px;
	      justify-content:flex-end;
	      margin-top:12px;
	    }
	    .column-builder-section{
	      margin-top:12px;
	      padding-top:10px;
	      border-top:1px solid rgba(148,163,184,0.16);
	    }
	    .column-builder-section-title{
	      font-size:11px;
	      text-transform:uppercase;
	      letter-spacing:0.08em;
	      color:var(--muted);
	      font-weight:700;
	    }
	    .column-builder-tap{
	      display:flex;
	      flex-direction:column;
	      gap:8px;
	      margin-top:8px;
	    }
	    .column-builder-tap label{
	      display:flex;
	      align-items:center;
	      gap:10px;
	      font-size:13px;
	      cursor:pointer;
	    }
	    .clear-input-btn{
	      position:absolute;
	      right:8px;
	      top:50%;
      transform:translateY(-50%);
      width:32px;
      height:32px;
      padding:0;
	    }
	    .clear-input-btn:disabled{ opacity:.55; }
	    .input-wrap > input{ padding-right:52px; }
	    #filterBox{
	      width:100%; max-width:480px;
	      padding:12px 52px 12px 12px;border-radius:10px;border:1px solid var(--border);
	      background:#0d131b;color:#eaeff7;font-size:16px
	    }
	    @media (max-width: 768px){
	      .inv-controls{ gap:8px; flex-wrap:wrap; justify-content:space-between; }
	      .inv-filter-group{ width:100%; }
	      .inv-controls .input-wrap{ flex:1 1 auto; max-width:none; }
	      .inv-filter-pills{ width:100%; }
	      .sort-wrap{ display:block; flex:0 0 auto; width:160px; min-width:0; }
	      .columns-wrap{ flex:0 0 auto; }
	      .column-builder{ width:min(360px, 92vw); }
	      .column-builder-drag{ display:none; }
	      #mobileSort{ padding:12px; border-radius:10px; }
	    }
    td.editing{padding:6px}
    /* Modern Toast System - React-toastify inspired */
    .toast{
      position:relative;
      display:none;
      align-items:center;
      gap:12px;
      min-width:280px;
      max-width:min(420px, 90vw);
      padding:14px 18px;
      border-radius:12px;
      font-size:14px;
      font-weight:500;
      line-height:1.4;
      box-shadow:0 10px 40px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.2);
      animation:toastSlideIn 0.3s cubic-bezier(0.21,1.02,0.73,1);
      overflow:hidden;
    }
    .toast.is-visible{ display:flex; }
    .toast-icon{
      flex-shrink:0;
      width:24px;
      height:24px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .toast-icon svg{
      width:22px;
      height:22px;
    }
    .toast-content{
      flex:1;
      min-width:0;
    }
    .toast-message{
      font-weight:600;
    }
    .toast-progress{
      position:absolute;
      bottom:0;
      left:0;
      height:4px;
      border-radius:0 0 12px 12px;
      animation:toastProgress 2s linear forwards;
    }
    @keyframes toastSlideIn{
      from{ opacity:0; transform:translateY(-16px) scale(0.95); }
      to{ opacity:1; transform:translateY(0) scale(1); }
    }
    @keyframes toastSlideOut{
      from{ opacity:1; transform:translateY(0) scale(1); }
      to{ opacity:0; transform:translateY(-12px) scale(0.95); }
    }
    @keyframes toastProgress{
      from{ width:100%; }
      to{ width:0%; }
    }
    /* Toast variants */
    .toast--success{
      background:linear-gradient(135deg, #065f46 0%, #047857 100%);
      color:#ecfdf5;
      border:1px solid rgba(16,185,129,0.3);
    }
    .toast--success .toast-icon{ color:#34d399; }
    .toast--success .toast-progress{ background:#34d399; }
    .toast--error{
      background:linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%);
      color:#fef2f2;
      border:1px solid rgba(248,113,113,0.3);
    }
    .toast--error .toast-icon{ color:#f87171; }
    .toast--error .toast-progress{ background:#f87171; }
    .toast--warning{
      background:linear-gradient(135deg, #78350f 0%, #92400e 100%);
      color:#fffbeb;
      border:1px solid rgba(251,191,36,0.3);
    }
    .toast--warning .toast-icon{ color:#fbbf24; }
    .toast--warning .toast-progress{ background:#fbbf24; }
    .toast--info{
      background:linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
      color:#eff6ff;
      border:1px solid rgba(96,165,250,0.3);
    }
    .toast--info .toast-icon{ color:#60a5fa; }
    .toast--info .toast-progress{ background:#60a5fa; }
    .toast--default{
      background:linear-gradient(135deg, #1f2937 0%, #374151 100%);
      color:#f9fafb;
      border:1px solid rgba(156,163,175,0.2);
    }
    .toast--default .toast-icon{ color:#9ca3af; }
    .toast--default .toast-progress{ background:#9ca3af; }
    /* Toast in header zone overrides */
    .header-toast-zone .toast{
      min-width:auto;
    }
    .header-notices{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      min-height:28px;
      padding:0 12px 8px;
    }
	    .modal-backdrop{
	      display:none;
	      position:fixed;
	      inset:0;
	      background:rgba(0,0,0,.65);
	      z-index:200;
	      padding:calc(12px + env(safe-area-inset-top)) 12px calc(12px + env(safe-area-inset-bottom));
	      -webkit-backdrop-filter: blur(8px);
	      backdrop-filter: blur(8px);
	      align-items:center;
	      justify-content:center;
	      overflow:hidden;
	    }
	    .modal-backdrop[aria-hidden="false"]{ display:flex; }
	    /* Depth level 2: Sub-modals opened from within a modal */
	    .modal-backdrop.depth-2,
	    #manageCompanyUsersModal,
	    #manageCompanyInventoryModal,
	    #renameCompanyModal,
	    #companyEnvironmentModal,
	    #seedInventoryModal{
	      z-index:210;
	      background:rgba(0,0,0,.75);
	      -webkit-backdrop-filter: blur(12px);
	      backdrop-filter: blur(12px);
	    }
	    /* Depth level 3: Confirmations and critical dialogs */
	    #reportEmailModal{ z-index:220; background:rgba(0,0,0,.8); -webkit-backdrop-filter:blur(14px); backdrop-filter:blur(14px); }
	    #msgModal{ z-index:240; background:rgba(0,0,0,.85); -webkit-backdrop-filter:blur(16px); backdrop-filter:blur(16px); }
	    #confirmModal{ z-index:250; background:rgba(0,0,0,.85); -webkit-backdrop-filter:blur(16px); backdrop-filter:blur(16px); }
	    #qtyPickerModal{ z-index:210; }
	    .modal{
	      width:100%;
	      max-width:480px;
	      background:var(--card);
	      border:1px solid var(--border);
	      border-radius:16px;
	      display:flex;
	      flex-direction:column;
	      max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
	      max-height:calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
	      overflow:hidden;
	    }
	    .modal--sm{ max-width:min(360px, 92vw); }
	    .modal--md{ max-width:min(480px, 94vw); }
	    .modal--lg{ max-width:min(1100px, 96vw); }
    .modal-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:rgba(12,16,22,0.85);
    }
    .modal-title-wrap{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width:0;
    }
    .modal-icon{
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#7dd3fc;
      flex:0 0 auto;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.18);
    }
    .modal-icon svg{ width:18px; height:18px; }
    .modal-title-text{ min-width:0; }
    .modal-title{
      margin:0;
      font-size:15px;
      font-weight:800;
      letter-spacing:0.01em;
    }
    .modal-subtitle{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }
    .modal-close{
      width:32px;
      height:32px;
      flex:0 0 auto;
    }
    .modal-body{
      padding:14px 16px 16px;
      overflow:auto;
      flex:1 1 auto;
      min-height:0;
      -webkit-overflow-scrolling:touch;
    }
    .modal-footer{
      padding:12px 16px calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid var(--border);
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(12,16,22,0.9);
    }
    .modal-footer .footer-left,
    .modal-footer .footer-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .modal-footer .footer-right{ margin-left:auto; }
    .form-section{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .form-section + .form-section{ margin-top:16px; }
    .section-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:11px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .section-label svg{ width:14px; height:14px; }
    .modal-body label{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }
    .modal-body input[type=text],
    .modal-body input[type=number],
    .modal-body input[type=email],
    .modal-body input[type=password],
    .modal-body input[type=tel],
    .modal-body textarea,
    .modal-body select{
      background:rgba(15,20,28,0.7);
      border:1px solid rgba(255,255,255,0.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
      min-height:44px;
    }
    .modal-body input:focus,
    .modal-body textarea:focus,
    .modal-body select:focus{
      outline:none;
      border-color:rgba(125,211,252,0.7);
      box-shadow:0 0 0 2px rgba(125,211,252,0.3);
    }
    .modal-body textarea{ min-height:120px; }
    .modal-body .edit-readonly{ opacity:0.8; }
    .modal-body .edit-readonly[disabled]{ cursor:not-allowed; }
    .modal-body .qty-stepper,
    .modal-body .qty-stepper *{ user-select:none; }
	    .edit-steppers{
	      display:grid;
	      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
	      gap:8px 12px;
	      align-items:center;
	      justify-items:center;
	    }
    .edit-grid-2{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:10px 12px;
      align-items:end;
    }
    .edit-grid-3{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:10px 12px;
      align-items:end;
    }
    .edit-field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .edit-readonly{
      opacity:0.8;
    }
	    .edit-steppers label.muted{
	      margin:0;
	      text-align:center;
	    }
	    .edit-label-meta{
	      display:block;
	      margin-top:2px;
	      font-weight:600;
	      opacity:0.85;
	      font-size:12px;
	    }
	    .edit-stepper-actions{
	      width:100%;
	      display:flex;
	      justify-content:center;
	    }
	    .edit-toggle-row{
	      display:flex;
	      align-items:center;
	      gap:12px;
	      margin-top:12px;
	      flex-wrap:wrap;
	    }
	    .edit-toggle-row label[for]{
	      cursor:pointer;
	      font-size:13px;
	      line-height:1.35;
	    }

    /* Edit Item Modal - Tabbed Interface */
    #editItemModal .modal{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      width:100%;
      max-width:480px;
      max-height:calc(100vh - 48px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      overflow:hidden;
      box-shadow:0 25px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    #editItemModal .edit-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background:var(--card);
      flex-shrink:0;
    }
    #editItemModal .edit-header-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
      flex:1;
    }
    #editItemModal .edit-header-icon{
      width:44px;
      height:44px;
      border-radius:12px;
      background:linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.08));
      border:1px solid rgba(34,197,94,0.25);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    #editItemModal .edit-header-icon svg{
      width:20px;
      height:20px;
      color:#22c55e;
    }
    #editItemModal .edit-header-info{
      min-width:0;
      flex:1;
    }
    #editItemModal .edit-header-title{
      margin:0;
      font-size:17px;
      font-weight:600;
      color:var(--fg);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #editItemModal .edit-header-sub{
      margin:3px 0 0;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #editItemModal .edit-tabs{
      display:flex;
      padding:12px 20px 0;
      background:var(--card);
      flex-shrink:0;
    }
    #editItemModal .edit-tabs-inner{
      display:flex;
      width:100%;
      background:rgba(0,0,0,0.3);
      border-radius:10px;
      padding:4px;
      gap:4px;
    }
    #editItemModal .edit-tab{
      flex:1;
      padding:10px 12px;
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      border-radius:8px;
      transition:all 0.2s ease;
    }
    #editItemModal .edit-tab:hover:not(.is-active){
      color:var(--fg);
      background:rgba(255,255,255,0.05);
    }
    #editItemModal .edit-tab.is-active{
      background:rgba(255,255,255,0.06);
      color:var(--fg);
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    #editItemModal .edit-tab-content{
      display:none;
      padding:20px;
    }
    #editItemModal .edit-tab-content.is-active{ display:block; }

    /* Details Tab */
    #editItemModal .edit-field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    #editItemModal .edit-field label{
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:var(--muted);
    }
    #editItemModal .edit-field input,
    #editItemModal .edit-field select,
    #editItemModal .edit-field textarea{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.2);
      color:var(--fg);
      font-size:15px;
      font-family:inherit;
      transition:border-color 0.15s, box-shadow 0.15s;
    }
    #editItemModal .edit-field input:focus,
    #editItemModal .edit-field select:focus,
    #editItemModal .edit-field textarea:focus{
      outline:none;
      border-color:rgba(90,169,255,0.55);
      box-shadow:0 0 0 3px rgba(90,169,255,0.18);
    }
    #editItemModal .edit-field textarea{
      min-height:80px;
      resize:vertical;
    }
    #editItemModal .edit-grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    #editItemModal .field-spacer{ height:14px; }

    /* Inventory Tab */
    #editItemModal .inventory-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    #editItemModal .inventory-card{
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:12px;
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    #editItemModal .inventory-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:3px;
      background:var(--card-accent, var(--border));
      opacity:0.7;
    }
    #editItemModal .inventory-card.on-hand{ --card-accent:#22c55e; }
    #editItemModal .inventory-card.incoming{ --card-accent:#f59e0b; }
    #editItemModal .inventory-card.allocated{ --card-accent:#3b82f6; }
    #editItemModal .inventory-card.remaining{ --card-accent:#94a3b8; }
    #editItemModal .inventory-label{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:var(--muted);
      margin-bottom:8px;
    }
    #editItemModal .inventory-value{
      font-size:32px;
      font-weight:800;
      color:var(--fg);
      font-variant-numeric:tabular-nums;
      line-height:1;
      margin-bottom:6px;
    }
    #editItemModal .inventory-value.calculated{ color:var(--muted); }
    #editItemModal .inventory-value.positive{ color:#22c55e; }
    #editItemModal .inventory-value.negative{ color:#ef4444; }
    #editItemModal .inventory-calc-hint{
      font-size:11px;
      color:var(--muted);
      line-height:1.3;
    }
    #editItemModal .inventory-info-banner{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px 14px;
      background:rgba(90,169,255,0.1);
      border:1px solid rgba(90,169,255,0.2);
      border-radius:10px;
      margin-top:16px;
    }
    #editItemModal .inventory-info-banner svg{
      width:18px;
      height:18px;
      color:var(--accent);
      flex-shrink:0;
      margin-top:1px;
    }
    #editItemModal .inventory-info-banner span{
      font-size:13px;
      color:#93c5fd;
      line-height:1.45;
    }

    /* Settings Tab */
    #editItemModal .settings-card{
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
    }
    #editItemModal .settings-card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    #editItemModal .settings-card-title{
      font-size:15px;
      font-weight:600;
      color:var(--fg);
    }
    #editItemModal .settings-card-desc{
      margin:0;
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
    }
    #editItemModal .settings-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:14px 0;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    #editItemModal .settings-row:last-of-type{ border-bottom:none; }
    #editItemModal .settings-label{
      font-size:14px;
      color:#94a3b8;
    }
    #editItemModal .settings-help{
      display:flex;
      align-items:flex-start;
      gap:10px;
      margin-top:20px;
      padding:12px 14px;
      background:rgba(90,169,255,0.1);
      border:1px solid rgba(90,169,255,0.2);
      border-radius:10px;
      font-size:13px;
      color:#94a3b8;
      line-height:1.5;
    }
    #editItemModal .settings-help svg{
      width:16px;
      height:16px;
      color:var(--accent);
      flex-shrink:0;
      margin-top:2px;
    }

    /* Inline Stepper */
    #editItemModal .stepper-inline{
      display:flex;
      align-items:center;
      gap:8px;
    }
    #editItemModal .stepper-inline-btn{
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(16,24,38,0.8);
      color:#fff;
      font-size:18px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
    }
    #editItemModal .stepper-inline-btn:hover{
      background:rgba(16,24,38,1);
      border-color:rgba(255,255,255,0.2);
    }
    #editItemModal .stepper-inline-btn:active{ transform:scale(0.95); }
    #editItemModal .stepper-inline-value{
      min-width:48px;
      text-align:center;
      font-size:18px;
      font-weight:700;
      font-variant-numeric:tabular-nums;
      color:var(--fg);
    }

    /* Toggle Switch */
    #editItemModal .toggle-label-wrap{
      display:flex;
      align-items:center;
      cursor:pointer;
    }
    #editItemModal .toggle-input{
      position:absolute;
      opacity:0;
      width:0;
      height:0;
    }
    #editItemModal .toggle-switch-new{
      width:48px;
      height:26px;
      border-radius:13px;
      background:rgba(255,255,255,0.1);
      position:relative;
      transition:background 0.2s ease;
      cursor:pointer;
    }
    #editItemModal .toggle-switch-new::after{
      content:'';
      position:absolute;
      top:3px;
      left:3px;
      width:20px;
      height:20px;
      border-radius:50%;
      background:#64748b;
      transition:all 0.2s ease;
    }
    #editItemModal .toggle-input:checked + .toggle-switch-new{
      background:rgba(34,197,94,0.3);
    }
    #editItemModal .toggle-input:checked + .toggle-switch-new::after{
      left:25px;
      background:#22c55e;
    }

    /* Edit Modal Footer */
    #editItemModal .edit-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px calc(16px + env(safe-area-inset-bottom));
      border-top:1px solid rgba(255,255,255,0.06);
      background:rgba(0,0,0,0.15);
      flex-shrink:0;
    }
    #editItemModal .edit-footer-right{
      display:flex;
      gap:10px;
    }
    #editItemModal .btn-delete{
      padding:10px 16px;
      border-radius:10px;
      border:1px solid rgba(239,68,68,0.3);
      background:rgba(239,68,68,0.1);
      color:#f87171;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    #editItemModal .btn-delete:hover{
      background:rgba(239,68,68,0.2);
      border-color:rgba(239,68,68,0.4);
    }
    #editItemModal #editItemMsg{
      padding:0 20px 12px;
      font-size:13px;
      color:var(--muted);
    }

    /* Edit modal body override for tabs */
    #editItemModal .modal-body{
      padding:0;
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    @media (max-width: 480px){
      #editItemModal .modal{
        border-radius:14px;
        max-height:calc(100vh - 16px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      }
      #editItemModal .edit-header{
        padding:14px 16px;
      }
      #editItemModal .edit-header-icon{
        width:40px;
        height:40px;
        border-radius:10px;
      }
      #editItemModal .edit-header-title{
        font-size:16px;
      }
      #editItemModal .edit-tabs{
        padding:10px 16px 0;
      }
      #editItemModal .edit-tab{
        padding:9px 10px;
        font-size:13px;
      }
      #editItemModal .edit-tab-content{
        padding:16px;
      }
      #editItemModal .inventory-grid{
        gap:10px;
      }
      #editItemModal .inventory-card{
        padding:14px;
      }
      #editItemModal .inventory-value{
        font-size:28px;
      }
      #editItemModal .edit-footer{
        padding:14px 16px calc(14px + env(safe-area-inset-bottom));
        flex-wrap:wrap;
        gap:10px;
      }
      #editItemModal .btn-delete{
        order:3;
        width:100%;
        text-align:center;
        margin-top:4px;
      }
      #editItemModal .edit-footer-right{
        order:1;
        width:100%;
        justify-content:flex-end;
      }
    }
    @media (max-width: 360px){
      #editItemModal .inventory-grid{
        grid-template-columns:1fr;
      }
    }

    .qty-stepper.qty-stepper--modal,
    .qty-stepper.qty-stepper--table{
      display:inline-flex;
      align-items:center;
      flex-wrap:nowrap;
      justify-content:center;
      background:transparent;
      border:none;
      border-radius:0;
      overflow:visible;
      height:auto;
    }
		    .qty-stepper.qty-stepper--modal{ gap:8px; }
		    .qty-stepper.qty-stepper--table{ gap:6px; }
	    .qty-stepper--table .qty-step{ min-width:38px; }
	    .qty-stepper--table .qty-value{ min-width:36px; font-size:15px; }
	    .qty-step{
	      cursor:pointer;
	      border:1px solid var(--border);
	      background:#101826;
	      color:#fff;
      border-radius:10px;
      min-width:44px;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      line-height:1;
      user-select:none;
      -webkit-appearance:none;
      appearance:none;
      touch-action:manipulation;
    }
    .qty-step:disabled{ opacity:.55; cursor:not-allowed; }
    .qty-value{
      min-width:44px;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-variant-numeric:tabular-nums;
      font-weight:800;
      font-size:16px;
      line-height:1;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
    }
	    .qty-stepper.qty-stepper--modal input[type=number]{
	      width:3.25rem;
	      text-align:center;
	      font-variant-numeric:tabular-nums;
	      font-size:22px;
	      font-weight:900;
	    }
    .qty-stepper input[type=number]::-webkit-outer-spin-button,
	    .qty-stepper input[type=number]::-webkit-inner-spin-button{
	      -webkit-appearance:none;
	      margin:0;
	    }
	    .qty-stepper input[type=number]{ -moz-appearance:textfield; }
	    .edit-footer{
	      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
	      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#0b1017;
    }
    .section + .section{ margin-top:12px; }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .order-box{
      padding:0;
      overflow:hidden; /* body scrolls */
      display:flex;
      flex-direction:column;
    }
    .order-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background:var(--card);
    }
    .order-header h2{ margin:0; font-size:16px; }
    .order-body{
      padding:12px 14px 14px;
      overflow:auto;
      flex:1;
      -webkit-overflow-scrolling:touch;
    }
    .order-footer{
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .order-recipient{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .order-recipient input[type=email]{ flex:1; min-width:200px; }
    .order-shipping-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .order-shipping-row select{ flex:1; min-width:220px; }
    .order-po-grid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; }
    .order-po-subject{ grid-column:1 / -1; }
    @media (max-width: 720px){
      .order-po-grid{ grid-template-columns:1fr; }
      .order-po-subject{ grid-column:auto; }
    }
    .order-suggest{
      display:none;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px;
      background:#000;
      max-height:190px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .order-suggest.has-suggest{ display:flex; }
    .suggest-chip{
      cursor:pointer;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      min-height:36px;
      max-width:100%;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .order-list{ display:flex; flex-direction:column; gap:10px; }
    .order-empty{
      padding:14px;
      border:1px dashed var(--border);
      border-radius:14px;
      background:transparent;
      color:var(--muted);
      font-size:13px;
      text-align:center;
    }
    .order-card{
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:14px;
      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
      box-shadow:0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
      transition: border-color 180ms ease, box-shadow 180ms ease;
    }
    .order-card.order-card--selected{
      background:
        radial-gradient(220px 120px at 40% 35%, rgba(34,197,94,0.20), rgba(34,197,94,0) 70%),
        linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%);
      box-shadow:0 0 0 1px rgba(34,197,94,0.12), 0 0 16px rgba(34,197,94,0.10), 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .order-card-header{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .order-batch-toggle{
      display:flex;
      align-items:center;
    }
    .order-line-select{
      width:16px;
      height:16px;
      accent-color:#22c55e;
      cursor:pointer;
    }
    @media (pointer: coarse){
      .order-batch-toggle{ display:none; }
    }
    .order-inline-kpi{
      margin-left:auto;
      display:flex;
      align-items:baseline;
      gap:6px;
      white-space:nowrap;
      font-size:12px;
      color:var(--muted);
      font-variant-numeric:tabular-nums;
    }
    .order-inline-kpi-val{
      color:var(--fg);
      font-weight:800;
      font-size:14px;
    }
    .order-card-top{ display:flex; gap:12px; align-items:flex-start; }
    .order-meta{ flex:1; min-width:0; }
    .order-title{ font-weight:700; font-size:15px; letter-spacing:-0.01em; }
    .order-sub{ margin-top:3px; color:var(--muted); font-size:12px; line-height:1.4; }
    .order-side{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
    .order-kpi{ text-align:right; }
    .order-kpi-label{ color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:0.04em; }
    .order-kpi-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:18px; }
    .order-controls{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;
      gap:12px;
      align-items:flex-end;
    }
	    .order-controls.order-controls--compact{
	      margin-top:10px;
	      padding-top:10px;
	      display:flex;
	      align-items:center;
	      gap:10px;
	    }
	    .order-controls.order-controls--compact .order-remove-btn{
	      margin-left:auto;
	    }
    .order-recommendation{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(13,19,27,0.7);
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:12px;
    }
    .order-rec-title{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:var(--muted);
    }
    .order-rec-line{
      display:flex;
      align-items:center;
      gap:6px;
      color:#d7e2f6;
    }
    .order-rec-muted{
      color:var(--muted);
    }
    .order-rec-value{
      font-weight:700;
      color:#e2e8f0;
    }
    .order-rec-total{
      font-weight:700;
      color:#7dd3fc;
    }
    .order-rec-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color:#cbd5f5;
      margin-top:4px;
    }
    .order-rec-toggle input{
      width:16px;
      height:16px;
      accent-color:#60a5fa;
      cursor:pointer;
    }
    .order-control{ flex-shrink:0; display:flex; flex-direction:column; }
    .order-control.qty{ width:64px; margin-left:auto; text-align:center; }
    .order-control.qty input{
      width:100%;
      text-align:center;
      font-weight:600;
      font-size:16px;
      font-variant-numeric:tabular-nums;
      height:42px;
      padding:0 8px;
      box-sizing:border-box;
    }
    .order-control-label{ color:var(--muted); font-size:11px; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.03em; }
    .order-control-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:17px; height:42px; display:flex; align-items:center; }
    .order-control-spacer{ height:17px; }
	    .qty-stepper{
	      display:flex; align-items:center; gap:0; background:#0d131b; border:1px solid var(--border);
	      border-radius:10px; overflow:hidden; height:48px;
	    }
	    .qty-stepper-btn{
	      width:48px; height:48px; border:none; background:transparent; color:#fff;
	      font-size:20px; font-weight:500; cursor:pointer; display:flex; align-items:center; justify-content:center;
	      transition:background 0.15s;
	    }
    .qty-stepper-btn:hover{ background:rgba(255,255,255,0.08); }
    .qty-stepper-btn:active{ background:rgba(255,255,255,0.12); }
	    .qty-stepper-val{
	      min-width:3.25rem;
	      height:48px;
	      display:inline-flex;
	      align-items:center;
	      justify-content:center;
	      text-align:center;
	      font-weight:900;
	      font-size:22px;
	      font-variant-numeric:tabular-nums;
	      color:#fff;
	      cursor:pointer;
	      user-select:none;
	      touch-action:manipulation;
	    }
	    .qty-stepper-input{
	      min-width:3.25rem;
	      width:auto;
	      height:48px;
	      border:none;
	      background:transparent;
	      text-align:center;
	      font-weight:900;
	      font-size:22px;
	      font-variant-numeric:tabular-nums;
	      color:#fff;
	      outline:none;
	      padding:0 4px;
	      -moz-appearance:textfield;
	    }
	    .qty-stepper-input::-webkit-outer-spin-button,
	    .qty-stepper-input::-webkit-inner-spin-button{
	      -webkit-appearance:none;
	      margin:0;
	    }
	    .qty-stepper-input:focus{
	      background:rgba(255,255,255,0.1);
	    }
    .order-preview{
      border:1px solid var(--border);
      border-radius:12px;
      background:#000;
      padding:10px;
    }
    .order-preview summary{
      cursor:pointer;
      list-style:none;
      font-weight:700;
      user-select:none;
    }
    .order-preview summary::-webkit-details-marker{ display:none; }
    .order-preview-html{
      margin-top:10px;
      border-radius:8px;
      overflow:hidden;
      background:#fff;
      max-height:320px;
      overflow-y:auto;
    }
    .order-preview-html iframe{
      width:100%;
      border:none;
      min-height:280px;
    }

    /* ============================================
       ORDER WIZARD - 3-Step Mobile-First Wizard
       ============================================ */
    .order-wizard{
      display:flex;
      flex-direction:column;
      height:100%;
      min-height:0;
    }
    #orderModal .modal-header{
      padding:16px 20px;
      border-bottom:1px solid var(--border-subtle);
      background:var(--card);
    }
    #orderModal .modal-icon{
      width:40px;
      height:40px;
      border-radius:10px;
      background:linear-gradient(135deg, rgba(34,197,94,0.2) 0%, rgba(34,197,94,0.1) 100%);
      border:1px solid rgba(34,197,94,0.2);
      color:var(--success);
    }
    #orderModal .modal-icon svg{
      width:20px;
      height:20px;
    }
    #orderModal .modal{
      max-width:540px;
    }
    #orderModal .modal-title{
      font-size:17px;
      font-weight:600;
    }

    /* Progress Stepper */
    .order-wizard-stepper-wrap{
      padding:14px 20px;
      border-bottom:1px solid var(--border-subtle);
      background:var(--card);
      flex-shrink:0;
    }
    .order-wizard-stepper{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:4px;
      padding:4px;
      background:rgba(0,0,0,0.3);
      border:1px solid var(--border-subtle);
      border-radius:10px;
    }
    .order-wizard-step{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px 12px;
      border-radius:8px;
      font-size:13px;
      font-weight:600;
      color:var(--muted);
      transition:all 0.2s ease;
      cursor:pointer;
      user-select:none;
    }
    .order-wizard-step:hover{
      background:rgba(255,255,255,0.05);
      color:var(--fg);
    }
    .order-wizard-step.active{
      background:var(--card-elevated);
      color:var(--fg);
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    .order-wizard-step.completed{
      color:var(--success);
    }
    .order-wizard-step-num{
      width:20px;
      height:20px;
      border-radius:50%;
      border:none;
      background:rgba(255,255,255,0.1);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:11px;
      font-weight:700;
      flex-shrink:0;
    }
    .order-wizard-step.active .order-wizard-step-num{
      background:var(--accent);
      color:#fff;
    }
    .order-wizard-step.completed .order-wizard-step-num{
      background:var(--success);
      color:#fff;
    }
    .order-wizard-step.completed .order-wizard-step-num::after{
      content:'âœ“';
    }
    .order-wizard-step.completed .order-wizard-step-num span{
      display:none;
    }
    .order-wizard-step-label{
      display:inline;
    }
    .order-wizard-connector{
      display:none;
    }
    .order-wizard-connector.completed{
      background:#22c55e;
    }

    /* Tab Panels */
    .order-wizard-panels{
      flex:1;
      min-height:0;
      overflow:hidden;
      position:relative;
    }
    .order-wizard-panel{
      position:absolute;
      inset:0;
      overflow-y:auto;
      height:100%;
      padding:16px 20px;
      opacity:0;
      visibility:hidden;
      transform:translateX(20px);
      transition:opacity 0.25s ease, transform 0.25s ease, visibility 0.25s;
      -webkit-overflow-scrolling:touch;
    }
    .order-wizard-panel.active{
      opacity:1;
      visibility:visible;
      transform:translateX(0);
    }
    .order-wizard-panel.exit-left{
      transform:translateX(-20px);
    }
    @media (max-width:480px){
      .order-wizard-panel{
        padding:14px 16px;
      }
    }

    /* Cart Tab */
    .order-cart-search{
      margin-bottom:12px;
    }
    .order-cart-search .input-wrap{
      max-width:100%;
    }
    .order-cart-search .input-wrap::before{
      content:'';
      position:absolute;
      left:14px;
      top:50%;
      transform:translateY(-50%);
      width:16px;
      height:16px;
      background-repeat:no-repeat;
      background-position:center;
      background-size:contain;
      opacity:0.7;
      pointer-events:none;
      background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='11' cy='11' r='8'/><line x1='21' y1='21' x2='16.65' y2='16.65'/></svg>");
    }
    .order-cart-search .input-wrap > input{
      padding-left:42px;
      background:rgba(0,0,0,0.2);
      border:1px solid var(--border);
      font-size:14px;
    }
    .order-cart-results{
      max-height:200px;
      overflow-y:auto;
      margin-bottom:16px;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
    }
    .order-cart-results:empty{
      display:none;
    }
    .order-cart-result{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      cursor:pointer;
      transition:background 0.15s;
    }
    .order-cart-result:last-child{
      border-bottom:none;
    }
    .order-cart-result:hover{
      background:rgba(59,130,246,0.08);
    }
    .order-cart-result-info{
      flex:1;
      min-width:0;
    }
    .order-cart-result-name{
      font-weight:600;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin-bottom:4px;
    }
    .order-cart-result-stats{
      display:flex;
      flex-wrap:wrap;
      gap:4px 10px;
      font-size:11px;
      color:var(--muted);
    }
    .order-cart-result-stat{
      display:flex;
      align-items:center;
      gap:3px;
      white-space:nowrap;
    }
    .order-cart-result-stat-label{
      opacity:0.7;
    }
    .order-cart-result-stat-value{
      font-weight:600;
      color:#94a3b8;
    }
    .order-cart-result-stat-value.low{
      color:#f59e0b;
    }
    .order-cart-result-stat-value.out{
      color:#ef4444;
    }
    .order-cart-result-stat-value.good{
      color:#22c55e;
    }
    .order-cart-result-stat-value.accent{
      color:#60a5fa;
    }
    .order-cart-result-desc{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .order-cart-section{
      margin-bottom:16px;
    }
    .order-cart-section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:var(--muted);
      margin-bottom:10px;
    }
    .order-cart-section-title-left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .order-cart-section-count{
      font-size:11px;
      font-weight:600;
      color:var(--muted);
      background:rgba(255,255,255,0.06);
      padding:3px 8px;
      border-radius:10px;
      text-transform:none;
    }
    #btnResetOrderList{
      width:32px;
      height:32px;
      border-radius:8px;
      box-shadow:none;
    }
    #btnResetOrderList svg{
      width:14px;
      height:14px;
    }
    .order-cart-items{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .order-cart-item{
      display:flex;
      flex-direction:column;
      align-items:stretch;
      gap:6px;
      padding:0;
      min-height:52px;
      background:rgba(0,0,0,0.2);
      border:1px solid var(--border-subtle);
      border-radius:12px;
      overflow:hidden;
    }
    .order-cart-item:hover{
      border-color:rgba(255,255,255,0.1);
    }
    .order-cart-item--warning{
      border-color:rgba(245,158,11,0.3);
      background:rgba(245,158,11,0.03);
    }
    .order-cart-item.has-warning{
      border-color:rgba(245,158,11,0.3);
      background:rgba(245,158,11,0.03);
    }
    .order-cart-item--expanded{
      border-color:rgba(59,130,246,0.3);
    }
    .order-cart-item-main{
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
      padding:12px;
    }
    .order-cart-item-info{
      flex:1;
      min-width:0;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
      cursor:pointer;
    }
    .order-cart-item-name{
      font-weight:600;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .order-cart-item-toggle{
      width:28px;
      height:28px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      transition:color 0.2s ease, background 0.2s ease;
      flex-shrink:0;
      cursor:pointer;
    }
    .order-cart-item-toggle:hover{
      background:rgba(255,255,255,0.08);
      color:var(--fg);
    }
    .order-cart-item-toggle svg{
      width:14px;
      height:14px;
      transition:transform 0.2s ease;
    }
    .order-cart-item--expanded .order-cart-item-toggle{
      color:var(--fg);
    }
    .order-cart-item--expanded .order-cart-item-toggle svg{
      transform:rotate(180deg);
    }
    .order-cart-item-meta{
      display:flex;
      align-items:center;
      gap:6px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--muted);
      padding-left:0;
    }
    .order-cart-item-jobs-meta{
      color:var(--muted);
    }
    .order-cart-item-jobs-meta--draft{
      color:#fbbf24;
    }
    .order-cart-item-jobs-meta--incoming{
      color:#93c5fd;
    }
    .order-cart-item-availability{
      font-weight:600;
    }
    .order-cart-item-availability.is-negative{
      color:#f87171;
    }
    .order-cart-item-availability.is-zero{
      color:#f87171;
    }
    .order-cart-item-availability.is-positive{
      color:var(--success);
    }
    .order-cart-item-jobs{
      display:none;
      border-top:1px solid rgba(255,255,255,0.06);
      margin-top:0;
      padding:12px;
    }
    .order-cart-item--expanded .order-cart-item-jobs{
      display:block;
    }
    .order-cart-item-jobs-section{
      margin-top:12px;
    }
    .order-cart-item-jobs-section:first-child{
      margin-top:0;
    }
    .order-cart-item-jobs-section-title{
      font-size:11px;
      font-weight:700;
      color:var(--fg);
      text-transform:uppercase;
      letter-spacing:0.04em;
    }
    .order-cart-item-jobs-helper{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
    }
    .order-cart-item-incoming{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:8px;
      font-size:11px;
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.04);
      margin:2px 0 6px;
    }
    .order-cart-item-jobs-cards{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .mini-card{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .mini-card--committed{
      border-color:rgba(34,197,94,0.28);
      background:linear-gradient(135deg, rgba(34,197,94,0.12), rgba(255,255,255,0.02));
    }
    .mini-card--draft{
      border-color:rgba(251,191,36,0.28);
      background:linear-gradient(135deg, rgba(251,191,36,0.1), rgba(255,255,255,0.02));
    }
    .mini-card--empty{
      border-color:rgba(255,255,255,0.06);
      background:rgba(255,255,255,0.02);
      justify-content:flex-start;
      color:var(--muted);
    }
    .mini-card--empty .mini-card-title{
      color:var(--muted);
    }
    .mini-card-main{
      min-width:0;
    }
    .mini-card-title{
      font-size:13px;
      font-weight:600;
      color:var(--fg);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mini-card-subtext{
      margin-top:2px;
      font-size:11px;
      color:var(--muted);
    }
    .mini-card-meta{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      flex-shrink:0;
    }
    .mini-card-qty{
      font-size:12px;
      font-weight:600;
      color:var(--fg);
    }
    .mini-card-badge{
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.04em;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      color:var(--muted);
    }
    .mini-card-badge--committed{
      color:#34d399;
      border-color:rgba(34,197,94,0.35);
      background:rgba(34,197,94,0.12);
    }
    .mini-card-badge--draft{
      color:#fbbf24;
      border-color:rgba(251,191,36,0.35);
      background:rgba(251,191,36,0.12);
    }
    .approve-ready-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .approve-ready-empty{
      padding:12px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.2);
      color:var(--muted);
      font-size:13px;
      text-align:center;
    }
    .approve-ready-card .mini-card-meta{
      align-items:flex-end;
    }
    .approve-ready-card .btn-secondary.btn-sm{
      min-height:30px;
      padding:6px 10px;
      font-size:12px;
    }
    .mini-card-status{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
      font-size:11px;
      font-weight:600;
      line-height:1.2;
      text-align:right;
      color:var(--muted);
    }
    .mini-card-status svg{ width:14px; height:14px; }
    .mini-card-status--success{ color:#34d399; }
    .mini-card-status--warning{ color:#fbbf24; }
    .order-cart-item-sub{
      display:none; /* Hidden for compact mode */
    }
    .order-cart-item-stepper{
      flex-shrink:0;
    }
    .order-cart-item-stepper .qty-stepper{
      display:flex;
      align-items:center;
      gap:2px;
      background:rgba(0,0,0,0.3);
      border-radius:8px;
      padding:2px;
      height:auto !important;
    }
    .order-cart-item-stepper .qty-stepper-btn{
      width:32px !important;
      height:32px !important;
      border:none;
      background:transparent;
      color:var(--muted);
      border-radius:6px;
    }
    .order-cart-item-stepper .qty-stepper-input{
      height:32px !important;
      font-size:15px !important;
      min-width:40px !important;
      background:rgba(255,255,255,0.05);
      border-radius:6px;
    }
    .order-cart-item-remove{
      flex-shrink:0;
      width:32px;
      height:32px;
      border:1px solid rgba(239,68,68,0.25);
      background:rgba(239,68,68,0.08);
      color:#ef4444;
      border-radius:8px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:background 0.15s;
    }
    .order-cart-item-remove:hover{
      background:rgba(239,68,68,0.18);
      color:#fca5a5;
    }
    .order-cart-summary{
      padding:14px;
      background:rgba(59,130,246,0.08);
      border:1px solid rgba(59,130,246,0.2);
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top:auto;
    }
    .order-cart-summary-label{
      font-size:14px;
      font-weight:600;
    }
    .order-cart-summary-value{
      font-size:18px;
      font-weight:800;
      color:#60a5fa;
    }
    .order-impact-card{
      margin-top:12px;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
      background:linear-gradient(145deg, rgba(15,23,42,0.75), rgba(2,6,23,0.85));
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .order-impact-card--success{
      border-color:rgba(34,197,94,0.35);
      box-shadow:inset 0 1px 0 rgba(34,197,94,0.2);
    }
    .order-impact-card--warning{
      border-color:rgba(251,191,36,0.35);
      box-shadow:inset 0 1px 0 rgba(251,191,36,0.2);
    }
    .order-impact-title{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:var(--muted);
      margin-bottom:8px;
    }
    .order-impact-main{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:14px;
      font-weight:600;
      color:var(--fg);
    }
    .order-impact-icon{
      width:32px;
      height:32px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.12);
    }
    .order-impact-card--success .order-impact-icon{
      background:rgba(34,197,94,0.12);
      border-color:rgba(34,197,94,0.35);
      color:#34d399;
    }
    .order-impact-card--warning .order-impact-icon{
      background:rgba(251,191,36,0.12);
      border-color:rgba(251,191,36,0.35);
      color:#fbbf24;
    }
    .order-impact-secondary{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }
    .order-impact-note{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }
    .order-impact-jobs{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.08);
    }
    .order-impact-toggle{
      display:flex;
      align-items:center;
      gap:6px;
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      padding:0;
    }
    .order-impact-toggle:hover{
      color:var(--fg);
    }
    .order-impact-toggle svg{
      width:12px;
      height:12px;
      transition:transform 0.2s ease;
    }
    .order-impact-toggle.is-expanded svg{
      transform:rotate(180deg);
    }
    .order-impact-joblist{
      display:none;
      margin-top:8px;
      flex-direction:column;
      gap:6px;
    }
    .order-impact-joblist.is-expanded{
      display:flex;
    }
    .order-impact-job{
      padding:6px 8px;
      border-radius:8px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.08);
      font-size:12px;
      color:var(--fg);
    }
    .order-impact-card--success .order-impact-job{
      border-color:rgba(34,197,94,0.25);
    }
    .order-impact-card--warning .order-impact-job{
      border-color:rgba(251,191,36,0.25);
    }
    .order-cart-empty{
      padding:32px 16px;
      text-align:center;
      color:var(--muted);
      font-size:14px;
    }
    .order-cart-empty svg{
      width:48px;
      height:48px;
      margin-bottom:12px;
      opacity:0.4;
    }

    /* Order Modal Form Styles */
    #orderModal .section-title{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:var(--muted);
      margin:12px 0 8px;
    }
    #orderModal .form-card{
      background:rgba(0,0,0,0.2);
      border:1px solid var(--border-subtle);
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
    }
    #orderModal .form-row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    #orderModal .form-row:last-child{
      margin-bottom:0;
    }
    #orderModal .form-field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    #orderModal .form-field.full-width{
      grid-column:1 / -1;
    }
    #orderModal .form-label{
      font-size:12px;
      color:var(--muted);
    }
    #orderModal .form-input{
      width:100%;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.2);
      color:var(--fg);
      font-size:14px;
      font-family:inherit;
      transition:border-color 0.15s, box-shadow 0.15s;
    }
    #orderModal .form-input:focus{
      outline:none;
      border-color:rgba(59,130,246,0.5);
      box-shadow:0 0 0 3px rgba(59,130,246,0.15);
    }
    #orderModal .form-input[readonly]{
      background:rgba(0,0,0,0.3);
      color:var(--muted);
      cursor:not-allowed;
    }
    #orderModal .form-input.textarea{
      min-height:70px;
      resize:vertical;
    }
    #orderModal .order-shipping-row{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    #orderModal .order-shipping-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    #orderModal .order-shipping-manage{
      padding:8px 12px;
      border-radius:8px;
      font-size:12px;
      font-weight:600;
    }
    #orderModal .order-shipping-select{
      position:absolute;
      left:-9999px;
      width:1px;
      height:1px;
      overflow:hidden;
    }
    #orderModal .order-shipping-options{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-bottom:16px;
    }
    #orderModal .order-shipping-option{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:12px;
      background:rgba(0,0,0,0.2);
      border:1px solid var(--border-subtle);
      border-radius:10px;
      cursor:pointer;
      transition:border-color 0.15s, background 0.15s;
      text-align:left;
      width:100%;
      appearance:none;
      -webkit-appearance:none;
      font:inherit;
      color:inherit;
    }
    #orderModal .order-shipping-option:hover{
      border-color:rgba(255,255,255,0.15);
    }
    #orderModal .order-shipping-option.is-selected{
      border-color:rgba(59,130,246,0.5);
      background:rgba(59,130,246,0.08);
    }
    #orderModal .order-shipping-radio{
      width:18px;
      height:18px;
      border-radius:50%;
      border:2px solid var(--border);
      background:rgba(0,0,0,0.3);
      flex-shrink:0;
      margin-top:2px;
      position:relative;
      transition:border-color 0.15s, background 0.15s;
    }
    #orderModal .order-shipping-option.is-selected .order-shipping-radio{
      border-color:var(--accent);
      background:var(--accent);
    }
    #orderModal .order-shipping-option.is-selected .order-shipping-radio::after{
      content:'';
      position:absolute;
      top:4px;
      left:4px;
      width:6px;
      height:6px;
      border-radius:50%;
      background:#fff;
    }
    #orderModal .order-shipping-info{
      flex:1;
      min-width:0;
    }
    #orderModal .order-shipping-name{
      display:block;
      font-size:14px;
      font-weight:600;
      color:var(--fg);
      margin-bottom:2px;
    }
    #orderModal .order-shipping-address{
      display:block;
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
      white-space:pre-line;
    }
    #orderModal .order-shipping-badge{
      font-size:10px;
      font-weight:600;
      text-transform:uppercase;
      padding:3px 8px;
      border-radius:4px;
      background:rgba(59,130,246,0.15);
      color:#60a5fa;
      flex-shrink:0;
      margin-top:2px;
    }
    #orderModal .order-shipping-empty{
      padding:12px;
      border-radius:10px;
      border:1px dashed var(--border-subtle);
      color:var(--muted);
      font-size:12px;
    }

    #orderModal .summary-card{
      background:rgba(0,0,0,0.2);
      border:1px solid var(--border-subtle);
      border-radius:12px;
      overflow:hidden;
      margin-bottom:16px;
    }
    #orderModal .summary-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid var(--border-subtle);
      gap:12px;
    }
    #orderModal .summary-row:last-child{
      border-bottom:none;
    }
    #orderModal .summary-label{
      font-size:13px;
      color:var(--muted);
      flex-shrink:0;
    }
    #orderModal .summary-value{
      font-size:13px;
      font-weight:500;
      color:var(--fg);
      text-align:right;
    }
    #orderModal .summary-value.highlight{
      color:var(--accent);
      font-weight:600;
    }
    #orderModal .summary-value .address{
      display:block;
      font-weight:400;
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
      white-space:pre-line;
    }
    #orderModal .job-link{
      color:#fbbf24;
      text-decoration:none;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:4px;
      transition:color 0.15s;
    }
    #orderModal .job-link:hover{
      color:#fbbf24;
      text-decoration:underline;
    }
    #orderModal .job-link svg{
      width:12px;
      height:12px;
      opacity:0.7;
    }

    #orderModal .toggle-option{
      background:rgba(245,158,11,0.08);
      border:1px solid rgba(245,158,11,0.2);
      border-radius:10px;
      padding:12px 14px;
      margin-bottom:16px;
    }
    #orderModal .toggle-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    #orderModal .toggle-content{
      flex:1;
    }
    #orderModal .toggle-label{
      font-size:13px;
      font-weight:600;
      color:var(--fg);
      margin-bottom:2px;
    }
    #orderModal .toggle-hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    #orderModal .toggle-wrap{
      display:flex;
      align-items:center;
      cursor:pointer;
      flex-shrink:0;
    }
    #orderModal .toggle-input{
      position:absolute;
      opacity:0;
      width:0;
      height:0;
    }
    #orderModal .toggle-switch{
      width:44px;
      height:24px;
      border-radius:12px;
      background:rgba(255,255,255,0.1);
      position:relative;
      transition:background 0.2s ease;
      cursor:pointer;
    }
    #orderModal .toggle-switch::after{
      content:'';
      position:absolute;
      top:2px;
      left:2px;
      width:20px;
      height:20px;
      border-radius:50%;
      background:#64748b;
      transition:all 0.2s ease;
    }
    #orderModal .toggle-input:checked + .toggle-switch{
      background:rgba(34,197,94,0.3);
    }
    #orderModal .toggle-input:checked + .toggle-switch::after{
      left:22px;
      background:#22c55e;
    }
    #orderModal .btn-ghost{
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
    }
    #orderModal .btn-ghost:hover{
      background:rgba(255,255,255,0.05);
      color:var(--fg);
    }

    /* Delivery Tab */
    .order-delivery-section{
      margin-bottom:20px;
    }
    .order-delivery-label{
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:var(--muted);
      margin-bottom:8px;
    }
    .order-delivery-suggestions{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .order-delivery-suggestion{
      padding:6px 12px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:16px;
      font-size:12px;
      color:#cbd5e1;
      cursor:pointer;
      transition:all 0.15s;
    }
    .order-delivery-suggestion:hover{
      background:rgba(59,130,246,0.15);
      border-color:rgba(59,130,246,0.3);
      color:#60a5fa;
    }
    .order-delivery-address-card{
      padding:14px;
      background:rgba(13,19,27,0.7);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
    }
    .order-delivery-address-name{
      font-weight:700;
      font-size:14px;
      margin-bottom:4px;
    }
    .order-delivery-address-text{
      font-size:13px;
      color:var(--muted);
      line-height:1.5;
      white-space:pre-line;
    }

    /* Review Tab */
    .order-review-section{
      margin-bottom:20px;
    }
    .order-review-label{
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:var(--muted);
      margin-bottom:8px;
    }
    .order-review-po-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:479px){
      .order-review-po-grid{
        grid-template-columns:1fr;
      }
    }
    .order-review-preview{
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      overflow:hidden;
    }
    .order-review-preview-header{
      padding:10px 14px;
      background:rgba(13,19,27,0.7);
      border-bottom:1px solid rgba(255,255,255,0.06);
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:var(--muted);
    }
    .order-review-preview-body{
      background:#fff;
      overflow:visible;
    }
    .order-review-preview-body iframe{
      width:100%;
      border:none;
      min-height:250px;
    }

    /* Info Box */
    .order-info-box{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px 14px;
      background:rgba(59,130,246,0.08);
      border:1px solid rgba(59,130,246,0.2);
      border-radius:10px;
      margin-bottom:16px;
    }
    .order-info-box-icon{
      flex-shrink:0;
      color:#60a5fa;
    }
    .order-info-box-text{
      font-size:13px;
      color:#94a3b8;
      line-height:1.5;
    }
    .order-info-box-text--stacked{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .order-info-box-meta{
      font-size:12px;
      color:var(--muted);
    }
    .order-info-box--muted{
      background:rgba(59,130,246,0.06);
      border-color:rgba(59,130,246,0.18);
    }
    .order-info-box-dismiss{
      margin-left:auto;
      width:28px;
      height:28px;
      border-radius:8px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:all 0.15s;
      flex-shrink:0;
    }
    .order-info-box-dismiss:hover{
      background:rgba(255,255,255,0.08);
      color:var(--fg);
    }

    .order-draft-selector{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      margin-bottom:14px;
      background:rgba(15,23,42,0.35);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:10px;
    }
    .order-draft-label{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:var(--muted);
      flex-shrink:0;
    }
    .order-draft-select{
      flex:1;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.2);
      color:var(--fg);
      font-size:13px;
      font-family:inherit;
    }
    .order-draft-meta{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      flex-shrink:0;
    }
    @media (max-width:540px){
      .order-draft-selector{
        flex-direction:column;
        align-items:flex-start;
      }
      .order-draft-select{
        width:100%;
      }
      .order-draft-meta{
        align-self:flex-end;
      }
    }

    /* Review Summary Card */
    .order-review-summary{
      background:rgba(26,31,38,0.7);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:14px;
      margin-bottom:16px;
    }
    .order-review-summary-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:6px 0;
    }
    .order-review-summary-row:not(:last-child){
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .order-review-summary-label{
      font-size:13px;
      color:var(--muted);
    }
    .order-review-summary-value{
      font-size:14px;
      font-weight:600;
      color:var(--fg);
    }
    .order-review-summary-sub{
      display:block;
      margin-top:2px;
      font-size:12px;
      font-weight:500;
      color:var(--muted);
      white-space:pre-line;
      text-align:right;
    }
    .order-review-summary-value.accent{
      color:#60a5fa;
    }
    .order-review-shortfall-toggle{
      margin:-6px 0 16px;
      padding:10px 12px;
      border:1px dashed rgba(148,163,184,0.25);
      border-radius:10px;
      font-size:12px;
      color:var(--muted);
      background:rgba(15,23,42,0.25);
    }
    .order-shortfall-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:600;
      color:#e2e8f0;
      cursor:pointer;
    }
    .order-shortfall-toggle input{
      accent-color:#60a5fa;
    }
    .order-shortfall-hint{
      margin-top:6px;
      font-size:11px;
      color:#94a3b8;
    }

    /* Wizard Footer */
    .order-wizard-footer{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 20px;
      background:rgba(13,19,27,0.8);
      border-top:1px solid rgba(255,255,255,0.06);
      flex-shrink:0;
    }
    .order-wizard-footer-left{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .order-wizard-footer-right{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .order-wizard-btn{
      padding:10px 20px;
      border-radius:10px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.15s;
      border:none;
    }
    .order-wizard-btn-prev{
      background:transparent;
      border:1px solid rgba(255,255,255,0.15);
      color:#cbd5e1;
    }
    .order-wizard-btn-prev:hover{
      background:rgba(255,255,255,0.05);
      border-color:rgba(255,255,255,0.25);
    }
    .order-wizard-btn-next{
      background:linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color:#fff;
    }
    .order-wizard-btn-next:hover{
      background:linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
    }
    .order-wizard-btn-next:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .order-wizard-btn-submit{
      background:linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
      color:#fff;
    }
    .order-wizard-btn-submit:hover{
      background:linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
    }
    .order-wizard-btn-submit:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    /* Mobile two-row footer */
    @media (max-width: 540px){
      .order-wizard-footer{
        flex-direction:column;
        gap:10px;
        padding:12px 16px 16px;
      }
      .order-wizard-footer-left,
      .order-wizard-footer-right{
        width:100%;
        justify-content:stretch;
      }
      .order-wizard-footer-left{
        order:1;
      }
      .order-wizard-footer-right{
        order:2;
      }
      .order-wizard-footer-left .order-wizard-btn-prev{
        flex:1;
      }
      .order-wizard-footer-left .btn-secondary{
        flex:0 0 auto;
        padding:10px 12px;
      }
      .order-wizard-footer-right{
        gap:10px;
      }
      .order-wizard-footer-right .btn-secondary{
        flex:1;
      }
      .order-wizard-footer-right .order-wizard-btn-next,
      .order-wizard-footer-right .order-wizard-btn-submit{
        flex:2;
      }
    }
    @media (max-width: 360px){
      .order-wizard-footer-left .btn-secondary span{
        display:none;
      }
      .order-wizard-footer-left .btn-secondary svg{
        margin-right:0;
      }
      .order-wizard-footer-left .btn-secondary{
        padding:10px;
        width:40px;
        flex:0 0 40px;
      }
    }
    .order-review-preview-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    /* Compact stepper on mobile */
    @media (max-width:400px){
      .order-wizard-stepper-wrap{
        padding:12px 16px;
      }
      .order-wizard-step{
        padding:8px 6px;
      }
      .order-wizard-step-num{
        width:18px;
        height:18px;
        font-size:10px;
      }
    }

    .history-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .history-item{
      border:1px solid var(--border);
      border-radius:12px;
      background:transparent;
      padding:10px;
    }
    .history-item summary{
      cursor:pointer;
      list-style:none;
      font-weight:800;
      user-select:none;
      position:relative;
      padding-right:32px;
    }
    .history-item summary::-webkit-details-marker{ display:none; }
    .history-caret{
      position:absolute;
      right:10px;
      top:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      pointer-events:none;
    }
    .history-caret svg{
      width:16px;
      height:16px;
      transition:transform 160ms ease;
    }
    .history-item[open] .history-caret svg{ transform:rotate(180deg); }
    .history-meta{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .history-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .history-title{ flex:1; }
    .history-actions{
      display:flex;
      align-items:center;
      gap:6px;
      flex-shrink:0;
    }
    /* Order history modal redesign */
    #orderHistoryModal .modal{
      max-width:720px;
      width:min(720px, 95vw);
      background:linear-gradient(145deg, rgba(18,22,30,0.98) 0%, rgba(12,16,22,0.99) 100%);
      border:1px solid var(--border);
      border-radius:20px;
      overflow:hidden;
      box-shadow:0 25px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    #orderHistoryModal .modal-header{
      padding:16px 20px;
      border-bottom:1px solid var(--border);
      background:rgba(12,16,22,0.9);
    }
    #orderHistoryModal .order-history-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }
    #orderHistoryModal .order-history-tabs{
      display:flex;
      padding:0 20px;
      background:rgba(0,0,0,0.2);
      border-bottom:1px solid var(--border);
      gap:4px;
    }
    #orderHistoryModal .order-history-tab{
      position:relative;
      padding:14px 16px;
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      transition:all 0.15s ease;
      border-bottom:2px solid transparent;
      margin-bottom:-1px;
    }
    #orderHistoryModal .order-history-tab:hover{
      color:var(--fg);
    }
    #orderHistoryModal .order-history-tab.is-active{
      color:var(--fg);
      border-bottom-color:#22c55e;
    }
    #orderHistoryModal .order-history-tab-badge{
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:9px;
      font-size:11px;
      font-weight:700;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:rgba(34,197,94,0.15);
      color:#22c55e;
    }
    #orderHistoryModal .order-history-tab-badge.is-amber{
      background:rgba(245,158,11,0.15);
      color:#f59e0b;
    }
    #orderHistoryModal .order-history-panels{
      display:flex;
      flex-direction:column;
      flex:1;
      overflow:hidden;
    }
    #orderHistoryModal .order-history-panel{
      display:none;
      flex-direction:column;
      flex:1;
      overflow:hidden;
    }
    #orderHistoryModal .order-history-panel.is-active{
      display:flex;
    }
    #orderHistoryModal .order-history-toolbar{
      display:flex;
      align-items:center;
      gap:10px;
      padding:14px 20px;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,0.15);
      flex-wrap:wrap;
    }
    #orderHistoryModal .order-history-toolbar-btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    #orderHistoryModal .order-history-search-wrap{
      flex:1;
      position:relative;
      min-width:200px;
    }
    #orderHistoryModal .order-history-search-input{
      width:100%;
      padding:10px 14px 10px 38px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.3);
      color:var(--fg);
      font-size:13px;
      font-weight:500;
      outline:none;
      transition:all 0.2s ease;
    }
    #orderHistoryModal .order-history-search-input::placeholder{
      color:var(--muted);
      font-weight:400;
    }
    #orderHistoryModal .order-history-search-input:focus{
      border-color:rgba(255,255,255,0.2);
      background:rgba(0,0,0,0.4);
    }
    #orderHistoryModal .order-history-search-icon{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:var(--muted);
      pointer-events:none;
    }
    #orderHistoryModal .order-history-search-icon svg{
      width:16px;
      height:16px;
    }
    #orderHistoryModal .order-history-clear-btn{
      position:absolute;
      right:8px;
      top:50%;
      transform:translateY(-50%);
    }
    #orderHistoryModal .order-history-toolbar-btn{
      padding:10px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      color:var(--fg);
      font-size:13px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
      transition:all 0.15s ease;
      white-space:nowrap;
    }
    #orderHistoryModal .order-history-toolbar-btn:hover{
      background:rgba(255,255,255,0.08);
      border-color:rgba(255,255,255,0.15);
    }
    #orderHistoryModal .order-history-body{
      flex:1;
      overflow-y:auto;
      padding:16px 20px;
    }
    #orderHistoryModal .po-card{
      background:rgba(0,0,0,0.25);
      border:1px solid var(--border);
      border-radius:14px;
      margin-bottom:10px;
      overflow:hidden;
      transition:all 0.15s ease;
    }
    #orderHistoryModal .po-card:hover{
      border-color:rgba(255,255,255,0.12);
    }
    #orderHistoryModal .po-card.is-expanded{
      border-color:rgba(34,197,94,0.3);
      background:rgba(0,0,0,0.3);
    }
    #orderHistoryModal .po-card-header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      cursor:pointer;
      transition:background 0.15s ease;
    }
    #orderHistoryModal .po-card-header:hover{
      background:rgba(255,255,255,0.02);
    }
    #orderHistoryModal .po-card-icon{
      width:42px;
      height:42px;
      border-radius:10px;
      background:rgba(34,197,94,0.15);
      border:1px solid rgba(34,197,94,0.2);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#22c55e;
      flex-shrink:0;
    }
    #orderHistoryModal .po-card-icon svg{
      width:20px;
      height:20px;
    }
    #orderHistoryModal .po-card-info{
      flex:1;
      min-width:0;
    }
    #orderHistoryModal .po-card-title{
      font-size:14px;
      font-weight:700;
      margin-bottom:3px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    #orderHistoryModal .po-card-id{
      color:var(--fg);
    }
    #orderHistoryModal .po-card-vendor{
      color:var(--muted);
      font-weight:500;
    }
    #orderHistoryModal .po-card-meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    #orderHistoryModal .po-card-meta-item{
      display:flex;
      align-items:center;
      gap:4px;
    }
    #orderHistoryModal .po-card-meta-item svg{
      width:12px;
      height:12px;
      opacity:0.6;
    }
    #orderHistoryModal .status-pill{
      padding:4px 10px;
      border-radius:8px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.04em;
      flex-shrink:0;
    }
    #orderHistoryModal .status-pill--submitted{
      background:rgba(59,130,246,0.15);
      color:#60a5fa;
    }
    #orderHistoryModal .status-pill--partial{
      background:rgba(245,158,11,0.15);
      color:#f59e0b;
    }
    #orderHistoryModal .status-pill--received{
      background:rgba(34,197,94,0.15);
      color:#22c55e;
    }
    #orderHistoryModal .status-pill--draft{
      background:rgba(148,163,184,0.12);
      color:#94a3b8;
    }
    #orderHistoryModal .status-pill--closed{
      background:rgba(239,68,68,0.15);
      color:#f87171;
    }
    #orderHistoryModal .po-card-expand{
      width:32px;
      height:32px;
      border-radius:8px;
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
    }
    #orderHistoryModal .po-card-expand svg{
      width:18px;
      height:18px;
      transition:transform 0.2s ease;
    }
    #orderHistoryModal .po-card.is-expanded .po-card-expand svg{
      transform:rotate(180deg);
    }
    #orderHistoryModal .po-card-body{
      display:none;
      padding:0 16px 16px;
      border-top:1px solid var(--border);
    }
    #orderHistoryModal .po-card.is-expanded .po-card-body{
      display:block;
    }
    #orderHistoryModal .po-quick-actions{
      display:flex;
      gap:8px;
      padding:12px 0;
      border-bottom:1px solid var(--border);
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    #orderHistoryModal .po-action-btn{
      flex:1 1 120px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      color:var(--fg);
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      transition:all 0.15s ease;
    }
    #orderHistoryModal .po-action-btn:hover{
      background:rgba(255,255,255,0.08);
      border-color:rgba(255,255,255,0.15);
    }
    #orderHistoryModal .po-action-btn svg{
      width:16px;
      height:16px;
    }
    #orderHistoryModal .po-action-btn--primary{
      background:rgba(34,197,94,0.15);
      border-color:rgba(34,197,94,0.3);
      color:#4ade80;
    }
    #orderHistoryModal .po-action-btn--primary:hover{
      background:rgba(34,197,94,0.25);
      border-color:rgba(34,197,94,0.4);
    }
    #orderHistoryModal .po-action-btn[disabled]{
      opacity:0.55;
      cursor:not-allowed;
    }
    #orderHistoryModal .po-details{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:12px;
      margin-bottom:14px;
    }
    #orderHistoryModal .po-detail{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 12px;
      background:rgba(0,0,0,0.2);
      border-radius:10px;
    }
    #orderHistoryModal .po-detail-icon{
      width:28px;
      height:28px;
      border-radius:8px;
      background:rgba(255,255,255,0.05);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      flex-shrink:0;
    }
    #orderHistoryModal .po-detail-icon svg{
      width:14px;
      height:14px;
    }
    #orderHistoryModal .po-detail-label{
      font-size:10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.05em;
      margin-bottom:2px;
    }
    #orderHistoryModal .po-detail-value{
      font-size:12px;
      font-weight:500;
      color:var(--fg);
      line-height:1.3;
    }
    #orderHistoryModal .po-detail--full{
      grid-column:1 / -1;
    }
    #orderHistoryModal .po-lines-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    #orderHistoryModal .po-lines-title{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
    }
    #orderHistoryModal .po-lines-count{
      font-size:11px;
      color:var(--muted);
      background:rgba(255,255,255,0.05);
      padding:2px 8px;
      border-radius:6px;
    }
    #orderHistoryModal .po-lines-table{
      background:rgba(0,0,0,0.2);
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
    }
    #orderHistoryModal .po-lines-empty{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      padding:12px;
      background:rgba(0,0,0,0.15);
      border-radius:8px;
    }
    #orderHistoryModal .po-line-row{
      display:grid;
      grid-template-columns:1fr 80px 70px 70px;
      gap:8px;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      align-items:center;
      font-size:13px;
    }
    #orderHistoryModal .po-line-row:last-child{
      border-bottom:none;
    }
    #orderHistoryModal .po-line-row--header{
      background:rgba(0,0,0,0.25);
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:var(--muted);
      padding:8px 12px;
    }
    #orderHistoryModal .po-line-name{
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #orderHistoryModal .po-line-sku{
      font-size:11px;
      color:var(--muted);
      margin-top:1px;
    }
    #orderHistoryModal .po-line-value{
      text-align:center;
      font-weight:600;
      font-variant-numeric:tabular-nums;
    }
    #orderHistoryModal .po-line-value--muted{ color:var(--muted); }
    #orderHistoryModal .po-line-value--green{ color:#22c55e; }
    #orderHistoryModal .po-line-value--amber{ color:#f59e0b; }
    #orderHistoryModal .po-receipts-section{
      margin-top:14px;
      padding-top:14px;
      border-top:1px solid var(--border);
    }
    #orderHistoryModal .po-receipts-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    #orderHistoryModal .po-receipts-title{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    #orderHistoryModal .po-receipts-title svg{
      width:14px;
      height:14px;
      color:#f59e0b;
    }
    #orderHistoryModal .no-receipts{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      padding:12px;
      background:rgba(0,0,0,0.15);
      border-radius:8px;
    }
    #orderHistoryModal .receipt-card{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      background:rgba(0,0,0,0.25);
      border:1px solid var(--border);
      border-radius:14px;
      margin-bottom:10px;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    #orderHistoryModal .receipt-card:hover{
      background:rgba(0,0,0,0.35);
      border-color:rgba(255,255,255,0.12);
    }
    #orderHistoryModal .receipt-card-icon{
      width:42px;
      height:42px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    #orderHistoryModal .receipt-card-icon svg{
      width:20px;
      height:20px;
    }
    #orderHistoryModal .receipt-card-icon--scanned{
      background:rgba(245,158,11,0.15);
      border:1px solid rgba(245,158,11,0.2);
      color:#f59e0b;
    }
    #orderHistoryModal .receipt-card-icon--manual{
      background:rgba(6,182,212,0.15);
      border:1px solid rgba(6,182,212,0.2);
      color:#06b6d4;
    }
    #orderHistoryModal .receipt-card-icon--po{
      background:rgba(34,197,94,0.15);
      border:1px solid rgba(34,197,94,0.2);
      color:#22c55e;
    }
    #orderHistoryModal .receipt-card-info{
      flex:1;
      min-width:0;
    }
    #orderHistoryModal .receipt-card-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:3px;
    }
    #orderHistoryModal .receipt-card-meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    #orderHistoryModal .receipt-card-tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:6px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
    }
    #orderHistoryModal .receipt-card-tag--po{
      background:rgba(34,197,94,0.15);
      color:#4ade80;
    }
    #orderHistoryModal .receipt-card-tag--manual{
      background:rgba(6,182,212,0.15);
      color:#06b6d4;
    }
    #orderHistoryModal .receipt-card-tag--standalone{
      background:rgba(148,163,184,0.12);
      color:#94a3b8;
    }
    #orderHistoryModal .receipt-card-arrow{
      color:var(--muted);
      flex-shrink:0;
    }
    #orderHistoryModal .receipt-card-arrow svg{
      width:18px;
      height:18px;
    }
    #orderHistoryModal .order-history-empty{
      text-align:center;
      padding:50px 20px;
      color:var(--muted);
    }
    #orderHistoryModal .order-history-empty-title{
      font-size:15px;
      font-weight:600;
      margin-bottom:6px;
      color:var(--fg);
    }
    #orderHistoryModal .order-history-empty-text{
      font-size:13px;
      color:var(--muted);
    }
    #orderHistoryModal .modal-footer{
      padding:14px 20px;
      border-top:1px solid var(--border);
      background:rgba(12,16,22,0.95);
      justify-content:flex-end;
    }
    @media (max-width: 600px){
      #orderHistoryModal .modal{
        max-width:100%;
        border-radius:16px 16px 0 0;
      }
      #orderHistoryModal .po-details{
        grid-template-columns:1fr;
      }
      #orderHistoryModal .po-line-row{
        grid-template-columns:1fr 60px 50px 50px;
        font-size:12px;
      }
      #orderHistoryModal .order-history-toolbar{
        flex-wrap:wrap;
      }
      #orderHistoryModal .order-history-toolbar-btn span{
        display:none;
      }
      #orderHistoryModal .po-quick-actions{
        flex-wrap:wrap;
      }
      #orderHistoryModal .po-action-btn{
        flex:1 1 calc(50% - 4px);
      }
    }
    /* Receive Order modal */
    #receiveOrderModal .box{
      max-width:1100px;
      width:min(1100px, 95vw);
    }
    .receive-order-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .receive-modal-body{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .receive-meta-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.55);
    }
    .receive-meta-left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
      flex:1;
    }
    .receive-meta-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .receive-tabs{
      display:flex;
      gap:6px;
      padding:6px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.6);
    }
    .receive-tab{
      flex:1;
      border-radius:10px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      font-size:12px;
      font-weight:700;
      padding:10px 12px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:all 0.15s ease;
      text-transform:uppercase;
      letter-spacing:.04em;
    }
    .receive-tab:hover{
      color:var(--fg);
    }
    .receive-tab.active{
      background:rgba(52,211,153,0.16);
      border-color:rgba(52,211,153,0.45);
      color:#86efac;
    }
    .receive-tab-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:18px;
      height:18px;
      padding:0 6px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      background:rgba(251,146,60,0.16);
      border:1px solid rgba(251,146,60,0.35);
      color:#fed7aa;
    }
    .receive-tab-panels{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .receive-tab-panel{
      display:none;
    }
    .receive-tab-panel.is-active{
      display:block;
    }
    .receive-tab-body{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .receive-detail-panel{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(15,23,42,0.45);
    }
    .receive-scanned-list{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .receive-scanned-header{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border-subtle);
      background:rgba(15,23,42,0.7);
    }
    .receive-scanned-title{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .receive-scanned-title-main{
      font-size:13px;
      font-weight:800;
      color:var(--fg);
    }
    .receive-scanned-title-sub{
      font-size:12px;
      color:var(--muted);
    }
    .receive-po-empty{
      border:1px dashed var(--border-subtle);
      border-radius:12px;
      padding:16px;
      background:rgba(15,23,42,0.4);
      text-align:center;
      color:var(--muted);
      font-size:13px;
    }
    .receive-po-empty-title{
      font-weight:700;
      color:var(--fg);
      margin-bottom:6px;
    }
    .receive-po-empty-text{
      font-size:12px;
      color:var(--muted);
    }
    .receive-po-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .receive-po-card{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--border-subtle);
      background:rgba(15,23,42,0.6);
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .receive-po-card:hover{
      border-color:rgba(52,211,153,0.35);
      background:rgba(17,24,39,0.75);
      transform:translateY(-1px);
    }
    .receive-po-icon{
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid rgba(52,211,153,0.3);
      background:rgba(52,211,153,0.12);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#86efac;
      flex-shrink:0;
    }
    .receive-po-info{
      min-width:0;
      flex:1;
    }
    .receive-po-title{
      font-size:14px;
      font-weight:700;
      color:var(--fg);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .receive-po-meta{
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }
    .receive-po-status{
      padding:4px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:.06em;
      text-transform:uppercase;
      background:rgba(251,191,36,0.18);
      border:1px solid rgba(251,191,36,0.35);
      color:#fde68a;
      white-space:nowrap;
    }
    .receive-po-arrow{
      color:var(--muted);
    }
    #receiveOrderModal .receive-footer{
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    #receiveOrderModal .receive-footer .footer-left{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    #receiveOrderModal .receive-footer .footer-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    #receiveOrderModal .receive-footer--icons{
      flex-direction:column;
      align-items:stretch;
      gap:16px;
      padding:16px 20px;
    }
    #receiveOrderModal .receive-footer--icons .footer-message{
      text-align:center;
      font-size:12px;
    }
    #receiveOrderModal .receive-footer--icons .footer-actions{
      display:flex;
      justify-content:center;
      gap:24px;
    }
    #receiveOrderModal .footer-icon-btn{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      background:transparent;
      border:none;
      padding:12px 16px;
      border-radius:12px;
      cursor:pointer;
      transition:all 0.15s ease;
      min-width:72px;
    }
    #receiveOrderModal .footer-icon-btn svg{
      width:24px;
      height:24px;
    }
    #receiveOrderModal .footer-icon-label{
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.04em;
    }
    #receiveOrderModal .footer-icon-btn--cancel{
      color:var(--muted);
    }
    #receiveOrderModal .footer-icon-btn--cancel:hover{
      background:rgba(255,255,255,0.05);
      color:var(--fg);
    }
    #receiveOrderModal .footer-icon-btn--save{
      color:var(--blue);
      background:var(--blue-muted);
    }
    #receiveOrderModal .footer-icon-btn--save:hover{
      background:var(--blue);
      color:#fff;
    }
    #receiveOrderModal .footer-icon-btn--confirm{
      color:var(--green);
      background:var(--green-muted);
    }
    #receiveOrderModal .footer-icon-btn--confirm:hover{
      background:var(--green);
      color:#fff;
    }
    #receiveOrderModal .footer-icon-btn:disabled{
      opacity:0.4;
      cursor:not-allowed;
    }
    #receiveOrderModal .footer-icon-btn:disabled:hover{
      background:transparent;
    }
    .receive-mode-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .receive-mode-badges{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .receive-status-pill,
    .receive-mode-pill{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      border:1px solid transparent;
    }
    .receive-status-pill[data-status="draft"]{
      background:rgba(148,163,184,0.15);
      color:#94a3b8;
      border-color:rgba(148,163,184,0.2);
    }
    .receive-status-pill[data-status="pending"]{
      background:rgba(251,191,36,0.15);
      color:#fbbf24;
      border-color:rgba(251,191,36,0.2);
    }
    .receive-status-pill[data-status="received"],
    .receive-status-pill[data-status="completed"]{
      background:rgba(52,211,153,0.15);
      color:#34d399;
      border-color:rgba(52,211,153,0.2);
    }
    .receive-status-pill[data-status="voided"]{
      background:rgba(248,113,113,0.15);
      color:#f87171;
      border-color:rgba(248,113,113,0.2);
    }
    .receive-status-pill[data-status="blocked_by_plan"]{
      background:rgba(249,115,22,0.15);
      color:#fb923c;
      border-color:rgba(249,115,22,0.2);
    }
    .receive-mode-pill{
      background:rgba(59,130,246,0.12);
      color:#93c5fd;
      border-color:rgba(59,130,246,0.2);
    }
    .receive-receipt-id{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }
    .receive-receipt-id span{
      color:#e2e8f0;
    }
    .receive-order-meta{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .receive-order-card{
      border:1px solid var(--border);
      background:#0d1420;
      border-radius:10px;
      padding:8px 10px;
    }
    .receive-order-card .label{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:800;
    }
    .receive-order-card .value{
      font-size:14px;
      font-weight:800;
      margin-top:4px;
    }
    .receive-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .receive-order-note{
      padding:10px 12px;
      border:1px solid var(--border-subtle);
      border-radius:10px;
      color:var(--muted);
      font-size:12px;
      background:rgba(15,23,42,0.7);
    }
    .receive-order-note label{
      display:block;
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .receive-order-note textarea{
      margin-top:6px;
      width:100%;
      min-height:60px;
      resize:vertical;
      background:rgba(15,23,42,0.6);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:8px;
      padding:8px 10px;
      font-size:13px;
    }
    .receive-forward-hint{
      margin-top:10px;
      padding:8px 10px;
      border:1px solid rgba(59,130,246,0.2);
      border-radius:10px;
      background:rgba(59,130,246,0.08);
      font-size:12px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .receive-forward-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:8px;
    }
    .receive-forward-hint strong{
      color:#93c5fd;
      font-weight:700;
    }
    .receive-forward-hint .forward-address{
      font-family:"SF Mono", Monaco, monospace;
      color:#e2e8f0;
      font-weight:600;
    }
    .receive-forward-dismiss{
      width:26px;
      height:26px;
      border-radius:8px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition:all 0.15s;
      flex-shrink:0;
    }
    .receive-forward-dismiss:hover{
      background:rgba(255,255,255,0.08);
      color:var(--fg);
    }
    .receive-draft-inbox{
      border:1px solid var(--border);
      border-radius:12px;
      background:#0b0f14;
      padding:12px;
    }
    .receive-draft-inbox-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .receive-draft-inbox-title{
      font-size:12px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .receive-draft-inbox-subtitle{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      max-width:520px;
    }
    .receive-draft-inbox-count{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
      background:rgba(251,146,60,0.16);
      border:1px solid rgba(251,146,60,0.35);
      color:#fed7aa;
      white-space:nowrap;
    }
    .receive-draft-inbox-list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .receive-draft-inbox-empty{
      padding:14px;
      border-radius:10px;
      background:rgba(15,23,42,0.45);
      border:1px dashed var(--border-subtle);
      color:var(--muted);
      font-size:13px;
    }
    .receive-inbox-card{
      border-radius:12px;
      border:1px solid var(--border-subtle);
      background:rgba(15,23,42,0.6);
      padding:12px;
      transition:border-color 0.15s, background 0.15s, transform 0.15s;
      cursor:pointer;
    }
    .receive-inbox-card:hover{
      border-color:rgba(255,255,255,0.18);
      background:rgba(17,24,39,0.75);
      transform:translateY(-1px);
    }
    .receive-inbox-vendor{
      font-size:14px;
      font-weight:700;
      color:var(--fg);
      max-width:260px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .receive-inbox-company{
      color:var(--muted);
      font-weight:500;
    }
    .receive-inbox-meta{
      flex-wrap:wrap;
      row-gap:4px;
    }
    .receive-inbox-status,
    .receive-inbox-source{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:.06em;
      text-transform:uppercase;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .receive-inbox-status[data-status="draft"]{
      color:#bfdbfe;
      background:rgba(59,130,246,0.18);
      border-color:rgba(59,130,246,0.35);
    }
    .receive-inbox-status[data-status="blocked_by_plan"]{
      color:#fdba74;
      background:rgba(249,115,22,0.18);
      border-color:rgba(249,115,22,0.35);
    }
    .receive-inbox-source{
      color:var(--muted);
      background:rgba(255,255,255,0.06);
      border-color:rgba(255,255,255,0.12);
    }
    .receipt-details-grid{
      margin-top:6px;
    }
    .receipt-details-meta{
      margin-top:10px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .receipt-source-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:.06em;
      text-transform:uppercase;
      background:rgba(56,189,248,0.14);
      border:1px solid rgba(56,189,248,0.3);
      color:#bae6fd;
    }
    .receipt-details-note{
      font-size:12px;
      color:var(--muted);
    }
    .receipt-parsed-lines{
      margin-top:12px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:rgba(15,23,42,0.55);
    }
    .receipt-parsed-title{
      font-size:11px;
      font-weight:700;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:8px;
    }
    .receipt-parsed-line{
      border:1px solid var(--border-subtle);
      border-radius:10px;
      padding:10px;
      background:rgba(11,15,20,0.7);
    }
    .receipt-parsed-line + .receipt-parsed-line{
      margin-top:10px;
    }
    .receipt-parsed-grid{
      display:grid;
      grid-template-columns:minmax(0,2fr) repeat(2, minmax(0,1fr)) minmax(0,1fr);
      gap:10px;
      align-items:end;
    }
    .receipt-parsed-field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .receipt-parsed-field label{
      font-size:11px;
      font-weight:700;
      letter-spacing:.06em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .receipt-parsed-total{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .receipt-parsed-total-value{
      min-height:42px;
      padding:9px 10px;
      border-radius:10px;
      background:rgba(255,255,255,0.04);
      border:1px solid var(--border-subtle);
      color:var(--fg);
      font-weight:600;
      display:flex;
      align-items:center;
    }
    .receipt-parsed-actions{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
    }
    .receive-plan-upgrade{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    @media (max-width: 720px){
      .receive-tabs{
        flex-direction:column;
      }
      .receive-tab{
        width:100%;
      }
      .receive-meta-bar{
        flex-direction:column;
        align-items:flex-start;
      }
      .receipt-parsed-grid{
        grid-template-columns:repeat(2, minmax(0,1fr));
      }
    }
    .receive-raw{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#0b0f14;
      padding:8px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .receive-detail-panel .receive-raw{
      margin-top:0;
    }
    .receive-attachments{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#0b0f14;
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .receive-detail-panel .receive-attachments{
      margin-top:0;
    }
    .receive-attachments-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .receive-attachments-title{
      font-size:11px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .receive-attachments-gate{
      font-size:11px;
      font-weight:700;
      color:#fbbf24;
    }
    .receive-attachments-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .receive-attachment-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--border-subtle);
      border-radius:10px;
      padding:8px 10px;
      background:rgba(15,23,42,0.55);
    }
    .receive-attachment-info{
      min-width:0;
      flex:1;
    }
    .receive-attachment-name{
      font-size:13px;
      font-weight:700;
      color:var(--fg);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .receive-attachment-meta{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }
    .receive-attachment-actions{
      display:flex;
      align-items:center;
      gap:6px;
      flex-shrink:0;
    }
    .receive-attachments-empty{
      font-size:12px;
      color:var(--muted);
    }
    .receive-raw summary{
      cursor:pointer;
      font-weight:700;
      color:#93c5fd;
      list-style:none;
    }
    .receive-raw summary::-webkit-details-marker{display:none;}
    .receive-raw pre{
      margin-top:8px;
      white-space:pre-wrap;
      font-family:"SF Mono", Monaco, monospace;
      color:#cbd5f5;
      font-size:11px;
    }
    /* ============================================
       PO Header Card - Order Summary
       ============================================ */
    .po-header-card{
      background:linear-gradient(145deg, rgba(34,197,94,0.08), rgba(34,197,94,0.02));
      border:1px solid rgba(34,197,94,0.2);
      border-radius:12px;
      padding:14px 16px;
      margin-bottom:10px;
    }
    .po-header-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .po-header-main{
      flex:1;
      min-width:0;
    }
    .po-number{
      font-size:18px;
      font-weight:800;
      color:#fff;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .po-number-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      background:rgba(34,197,94,0.15);
      border:1px solid rgba(34,197,94,0.3);
      border-radius:6px;
      font-size:10px;
      font-weight:700;
      color:#22c55e;
      text-transform:uppercase;
      letter-spacing:0.03em;
    }
    .po-number-badge svg{ width:10px; height:10px; }
    .po-vendor{
      font-size:14px;
      color:#94a3b8;
      margin-top:4px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .po-vendor svg{ width:14px; height:14px; stroke:#64748b; flex-shrink:0; }
    .po-vendor-name{
      color:#e2e8f0;
      font-weight:600;
    }
    .po-status-badge{
      padding:4px 10px;
      border-radius:8px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.03em;
      flex-shrink:0;
    }
    .po-status-badge--partial{
      background:rgba(245,158,11,0.15);
      border:1px solid rgba(245,158,11,0.3);
      color:#f59e0b;
    }
    .po-status-badge--open{
      background:rgba(59,130,246,0.15);
      border:1px solid rgba(59,130,246,0.3);
      color:#60a5fa;
    }
    .po-status-badge--received{
      background:rgba(34,197,94,0.15);
      border:1px solid rgba(34,197,94,0.3);
      color:#22c55e;
    }
    .po-details-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    .po-detail{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:#64748b;
    }
    .po-detail svg{
      width:14px;
      height:14px;
      stroke:#64748b;
      flex-shrink:0;
    }
    .po-detail-value{
      color:#94a3b8;
    }
    .po-detail-value a{
      color:#60a5fa;
      text-decoration:none;
    }
    .po-detail-value a:hover{
      text-decoration:underline;
    }
    /* Lead Time Card */
    .lead-time-card{
      margin-top:10px;
      background:linear-gradient(145deg, rgba(59,130,246,0.08), rgba(59,130,246,0.02));
      border:1px solid rgba(59,130,246,0.2);
      border-radius:10px;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .lead-time-info{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .lead-time-icon{
      width:36px;
      height:36px;
      border-radius:8px;
      background:rgba(59,130,246,0.15);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .lead-time-icon svg{
      width:18px;
      height:18px;
      stroke:#60a5fa;
    }
    .lead-time-label{
      font-size:11px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.04em;
      font-weight:700;
    }
    .lead-time-sublabel{
      font-size:11px;
      color:#64748b;
      margin-top:2px;
    }
    .lead-time-value{
      text-align:right;
    }
    .lead-time-days{
      font-size:24px;
      font-weight:800;
      color:#60a5fa;
      font-variant-numeric:tabular-nums;
      line-height:1;
    }
    .lead-time-days-label{
      font-size:11px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.03em;
    }
    .lead-time-pending{
      font-size:13px;
      color:#94a3b8;
      font-style:italic;
    }
    /* ============================================
       Receive Lines - Redesigned Cards
       ============================================ */
    .receive-lines{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .receive-line{
      background:linear-gradient(145deg, rgba(26,31,38,0.9), rgba(18,22,28,0.95));
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 4px 20px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.04);
      overflow:hidden;
    }
    .receive-line.disabled{
      opacity:0.55;
      pointer-events:none;
    }
    .receive-line-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.05);
      gap:12px;
    }
    .receive-line-info{
      flex:1;
      min-width:0;
    }
    .receive-line-title{
      font-weight:700;
      font-size:14px;
      color:#fff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .receive-line-sku{
      font-size:12px;
      color:#64748b;
      margin-top:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .receive-line-remaining{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      background:rgba(245,158,11,0.1);
      border:1px solid rgba(245,158,11,0.25);
      border-radius:8px;
      flex-shrink:0;
    }
    .receive-line-remaining-label{
      font-size:10px;
      color:#94a3b8;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.02em;
    }
    .receive-line-remaining-value{
      font-size:16px;
      font-weight:800;
      color:#f59e0b;
      font-variant-numeric:tabular-nums;
    }
    .receive-line-stats{
      display:flex;
      gap:0;
      background:rgba(0,0,0,0.15);
    }
    .receive-line-stat{
      flex:1;
      padding:8px 6px;
      text-align:center;
      border-right:1px solid rgba(255,255,255,0.05);
    }
    .receive-line-stat:last-child{
      border-right:none;
    }
    .receive-line-stat-value{
      font-size:13px;
      font-weight:700;
      color:#e2e8f0;
      font-variant-numeric:tabular-nums;
    }
    .receive-line-stat-label{
      font-size:9px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.3px;
      margin-top:1px;
    }
    .receive-line-inputs{
      padding:12px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .receive-line-stepper-row{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .receive-line-stepper-row label{
      font-size:11px;
      font-weight:700;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.04em;
      min-width:70px;
    }
    .receive-line-stepper-row .qty-stepper{
      flex:1;
      max-width:160px;
    }
    .receive-line-stepper-row .qty-stepper--received{
      border-color:rgba(34,197,94,0.3);
      background:rgba(34,197,94,0.05);
    }
    .receive-line-stepper-row .qty-stepper--received .qty-stepper-btn:hover{
      background:rgba(34,197,94,0.15);
    }
    .receive-line-stepper-row .qty-stepper--received .qty-stepper-input{
      color:#22c55e;
    }
    .receive-line-receive-all{
      padding:0 14px;
      height:44px;
      border-radius:10px;
      border:1px solid rgba(34,197,94,0.4);
      background:linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.08));
      color:#22c55e;
      font-size:12px;
      font-weight:700;
      cursor:pointer;
      white-space:nowrap;
      transition:all 0.15s ease;
      flex-shrink:0;
    }
    .receive-line-receive-all:hover{
      background:linear-gradient(135deg, rgba(34,197,94,0.3), rgba(34,197,94,0.12));
      border-color:rgba(34,197,94,0.5);
    }
    .receive-line-receive-all:active{
      transform:scale(0.97);
    }
    .receive-line-receive-all:disabled{
      opacity:0.4;
      cursor:not-allowed;
    }
    .receive-line-reason-row{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .receive-line-reason-row label{
      font-size:11px;
      font-weight:700;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.04em;
      min-width:70px;
    }
    .receive-line-reason-input{
      flex:1;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(0,0,0,0.2);
      color:#fff;
      font-size:13px;
      outline:none;
      transition:all 0.15s;
    }
    .receive-line-reason-input:focus{
      border-color:rgba(255,255,255,0.2);
      background:rgba(0,0,0,0.3);
    }
    .receive-line-reason-input::placeholder{
      color:#4a5568;
    }
    .receive-line-reason-input:disabled{
      opacity:0.4;
      cursor:not-allowed;
    }
    .receive-line-warning{
      display:none;
      padding:8px 14px;
      font-size:12px;
      color:#f59e0b;
      font-weight:600;
      background:rgba(245,158,11,0.08);
      border-top:1px solid rgba(245,158,11,0.15);
    }
    .receive-line.over .receive-line-warning{
      display:block;
    }
    .receive-line.over{
      border-color:rgba(245,158,11,0.4);
      box-shadow:0 0 0 1px rgba(245,158,11,0.2), 0 4px 20px rgba(0,0,0,0.3);
    }
    .receive-line-note{
      padding:8px 14px;
      margin:0;
      font-size:12px;
      color:#94a3b8;
      background:rgba(0,0,0,0.1);
      border-top:1px solid rgba(255,255,255,0.04);
    }
    .receive-order-warning{
      margin-top:8px;
      color:#f59e0b;
      font-size:12px;
      font-weight:700;
    }
    @media (max-width:480px){
      .po-header-top{
        flex-direction:column;
        align-items:flex-start;
      }
      .po-status-badge{
        align-self:flex-start;
      }
      .po-details-row{
        flex-direction:column;
        gap:8px;
      }
      .lead-time-card{
        flex-direction:column;
        align-items:flex-start;
        gap:10px;
      }
      .lead-time-value{
        text-align:left;
        display:flex;
        align-items:baseline;
        gap:6px;
      }
      .receive-line-header{
        flex-wrap:wrap;
      }
      .receive-line-remaining{
        order:-1;
        width:auto;
      }
      .receive-line-stat{
        padding:6px 4px;
      }
      .receive-line-stat-value{
        font-size:12px;
      }
      .receive-line-stat-label{
        font-size:8px;
      }
      .receive-line-stepper-row{
        flex-wrap:wrap;
      }
      .receive-line-stepper-row label{
        width:100%;
        margin-bottom:4px;
      }
      .receive-line-stepper-row .qty-stepper{
        max-width:none;
      }
      .receive-line-receive-all{
        flex:0;
      }
      .receive-line-reason-row{
        flex-wrap:wrap;
      }
      .receive-line-reason-row label{
        width:100%;
        margin-bottom:4px;
      }
    }
    .receive-receipts{
      margin-top:12px;
    }
    .receive-receipt{
      border:1px solid var(--border);
      background:#0b0f14;
      border-radius:12px;
      padding:10px;
      margin-top:10px;
    }
    .receive-receipt-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .receive-receipt-title{
      font-weight:800;
      font-size:13px;
    }
    .receive-receipt-meta{
      color:var(--muted);
      font-size:12px;
    }
    .receive-receipt-lines{
      margin-top:8px;
      display:grid;
      gap:6px;
    }
    .receive-receipt-line{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:var(--muted);
    }
    .receive-receipt-line span{
      white-space:nowrap;
    }
    .receive-void-row{
      margin-top:8px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .receive-void-row input{
      flex:1;
      min-width:200px;
      background:rgba(15,23,42,0.6);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:8px;
      padding:8px 10px;
      font-size:13px;
    }
    .receive-search-results{
      margin-top:10px;
      border:1px solid var(--border);
      background:#0b0f14;
      border-radius:12px;
      overflow:hidden;
    }
    .receive-search-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-top:1px solid var(--border);
    }
    .receive-search-item:first-child{
      border-top:none;
    }
    .receive-search-item-title{
      font-weight:700;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:320px;
    }
    .receive-search-item-meta{
      font-size:12px;
      color:var(--muted);
    }
    .receive-search-empty{
      padding:12px;
      font-size:12px;
      color:var(--muted);
    }
    #receiveOrderModal .form-section .input-wrap{
      max-width:100%;
    }
    #receiveOrderModal .form-section .input-wrap input{
      width:100%;
      background:rgba(0,0,0,0.3);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px 14px;
      font-size:14px;
      color:var(--fg);
      transition:border-color 0.15s ease;
    }
    #receiveOrderModal .form-section .input-wrap input:focus{
      outline:none;
      border-color:var(--primary);
    }
    #receiveOrderModal .form-section .input-wrap input::placeholder{
      color:var(--muted);
    }
    #receiveOrderModal .form-section label{
      display:block;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
      margin-bottom:6px;
    }
    #receiveOrderModal{
      --green:#22c55e;
      --green-muted:rgba(34,197,94,0.15);
      --blue:#3b82f6;
      --blue-muted:rgba(59,130,246,0.15);
      --amber:#f59e0b;
      --amber-muted:rgba(245,158,11,0.15);
    }
    #receiveOrderModal .modal{
      max-width:600px;
      background:linear-gradient(145deg, rgba(18,22,30,0.98) 0%, rgba(12,16,22,0.99) 100%);
      border-radius:20px;
      box-shadow:0 25px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    #receiveOrderModal .modal-header{
      padding:16px 20px;
      background:rgba(12,16,22,0.9);
    }
    #receiveOrderModal .modal-icon{
      width:40px;
      height:40px;
      border-radius:12px;
      border:1px solid rgba(34,197,94,0.3);
      background:linear-gradient(135deg, rgba(34,197,94,0.2), rgba(34,197,94,0.05));
      color:#22c55e;
      box-shadow:none;
    }
    #receiveOrderModal .modal-icon svg{ width:20px; height:20px; }
    #receiveOrderModal .modal-title{
      font-size:17px;
      font-weight:700;
      letter-spacing:-0.01em;
    }
    #receiveOrderModal .modal-subtitle{ display:none; }
    #receiveOrderModal .modal-close{
      width:36px;
      height:36px;
      border-radius:10px;
    }
    #receiveOrderModal .modal-body{ padding:0; }
    #receiveOrderModal .receive-modal-body{ gap:0; }
    #receiveOrderModal .receive-meta-bar{ display:none; }
    #receiveOrderModal .receive-tabs-container{
      padding:12px 20px;
      background:rgba(0,0,0,0.2);
      border-bottom:1px solid var(--border);
    }
    #receiveOrderModal .receive-tabs{
      display:flex;
      background:rgba(0,0,0,0.3);
      border-radius:12px;
      padding:4px;
      gap:4px;
      border:none;
    }
    #receiveOrderModal .receive-tab{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:13px;
      font-weight:600;
      text-transform:none;
      letter-spacing:0;
    }
    #receiveOrderModal .receive-tab:hover{
      color:var(--fg);
      background:rgba(255,255,255,0.03);
    }
    #receiveOrderModal .receive-tab.active{
      background:rgba(255,255,255,0.08);
      color:var(--fg);
      border:none;
    }
    #receiveOrderModal .receive-tab-badge{
      min-width:20px;
      height:20px;
      padding:0 6px;
      border-radius:10px;
      font-size:11px;
      font-weight:700;
      border:none;
    }
    #receiveOrderModal .receive-tab-badge--amber{
      background:var(--amber-muted);
      color:var(--amber);
    }
    #receiveOrderModal .receive-tab-badge--blue{
      background:var(--blue-muted);
      color:#60a5fa;
    }
    #receiveOrderModal .receive-tab-panels{ gap:0; }
    #receiveOrderModal .receive-tab-body{ padding:0; }
    #receiveOrderModal [data-receive-panel="quick"] .receive-tab-body,
    #receiveOrderModal [data-receive-panel="po"] .receive-tab-body{
      padding:16px 20px 20px;
    }
    #receiveOrderModal .receive-detail-panel{
      padding:0;
      gap:0;
      border:none;
      background:transparent;
    }
    #receiveOrderModal #receiveReceiptRaw,
    #receiveOrderModal #receiveReceiptAttachments,
    #receiveOrderModal #receiveLinesSection{
      margin:0 20px 16px;
    }
    #receiveOrderModal .receive-scanned-list{ gap:0; }
    #receiveOrderModal .receive-forward-hint{
      margin:16px 20px 0;
      padding:12px 14px;
      border:1px solid rgba(59,130,246,0.2);
      border-radius:10px;
      background:var(--blue-muted);
      color:#93c5fd;
    }
    #receiveOrderModal .receive-forward-hint strong{
      color:#93c5fd;
      font-weight:700;
    }
    #receiveOrderModal .receive-forward-hint .forward-address{
      font-family:"SF Mono", Monaco, monospace;
      font-size:11px;
      background:rgba(0,0,0,0.3);
      padding:2px 6px;
      border-radius:4px;
      color:#e2e8f0;
    }
    #receiveOrderModal .receive-forward-dismiss{
      width:28px;
      height:28px;
      border-radius:8px;
    }
    #receiveOrderModal .receive-draft-inbox{
      padding:16px 20px 16px;
      border:none;
      background:transparent;
    }
    #receiveOrderModal .receive-draft-batch-bar{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      margin:0 0 12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(0,0,0,0.2);
      flex-wrap:wrap;
    }
    #receiveOrderModal .receive-draft-batch-actions{
      display:flex;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      width:100%;
    }
    #receiveOrderModal .receive-draft-select-all{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      font-weight:600;
      color:var(--muted);
    }
    #receiveOrderModal .receive-draft-select-all input{
      width:14px;
      height:14px;
      accent-color:var(--accent);
    }
    #receiveOrderModal .receive-draft-batch-count{
      font-size:12px;
      color:var(--muted);
    }
    #receiveOrderModal .receive-draft-inbox-header{
      margin-bottom:10px;
    }
    #receiveOrderModal .receive-draft-inbox-title{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    #receiveOrderModal .receive-draft-inbox-subtitle{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
      max-width:520px;
    }
    #receiveOrderModal .receive-draft-inbox-count{
      background:var(--amber-muted);
      color:var(--amber);
      border:none;
    }
    #receiveOrderModal .scanned-queue{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    #receiveOrderModal .queue-item{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 16px;
      background:rgba(0,0,0,0.25);
      border:1px solid var(--border);
      border-radius:14px;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    #receiveOrderModal .queue-item:hover{
      background:rgba(0,0,0,0.35);
      border-color:rgba(255,255,255,0.12);
    }
    #receiveOrderModal .queue-item.active{
      background:rgba(245,158,11,0.08);
      border-color:rgba(245,158,11,0.3);
    }
    #receiveOrderModal .queue-item.is-selected{
      border-color:rgba(90,169,255,0.6);
      box-shadow:0 0 0 1px rgba(90,169,255,0.35);
      background:rgba(90,169,255,0.08);
    }
    #receiveOrderModal .queue-item.active.is-selected{
      border-color:rgba(245,158,11,0.5);
      box-shadow:0 0 0 1px rgba(245,158,11,0.35);
      background:rgba(245,158,11,0.1);
    }
    #receiveOrderModal .receive-draft-select{
      display:flex;
      align-items:center;
      margin-right:4px;
      flex-shrink:0;
    }
    #receiveOrderModal .receive-draft-select input{
      width:16px;
      height:16px;
      accent-color:var(--accent);
    }
    #receiveOrderModal .receive-draft-select.is-disabled{
      opacity:0.4;
      pointer-events:none;
    }
    #receiveOrderModal .queue-item-icon{
      width:40px;
      height:40px;
      border-radius:10px;
      background:var(--amber-muted);
      border:1px solid rgba(245,158,11,0.2);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--amber);
      flex-shrink:0;
    }
    #receiveOrderModal .queue-item-icon svg{ width:18px; height:18px; }
    #receiveOrderModal .queue-item-info{
      flex:1;
      min-width:0;
    }
    #receiveOrderModal .queue-item-title{
      font-size:14px;
      font-weight:600;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #receiveOrderModal .queue-item-meta{
      font-size:12px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    #receiveOrderModal .queue-item-tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:6px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.03em;
    }
    #receiveOrderModal .queue-item-tag--needs{
      background:var(--blue-muted);
      color:#60a5fa;
    }
    #receiveOrderModal .queue-item-tag--blocked{
      background:var(--amber-muted);
      color:var(--amber);
    }
    #receiveOrderModal .queue-item-tag--source{
      background:rgba(255,255,255,0.06);
      color:var(--muted);
    }
    #receiveOrderModal .queue-item-arrow{
      color:var(--muted);
      flex-shrink:0;
    }
    #receiveOrderModal .queue-item-arrow svg{ width:18px; height:18px; }
    #receiveOrderModal .queue-empty{
      text-align:center;
      padding:50px 20px;
    }
    #receiveOrderModal .queue-empty-title{
      font-size:15px;
      font-weight:600;
      margin-bottom:6px;
    }
    #receiveOrderModal .queue-empty-text{
      font-size:13px;
      color:var(--muted);
    }
    #receiveOrderModal .review-header{
      display:flex;
      align-items:center;
      gap:12px;
      padding:14px 20px;
      background:rgba(0,0,0,0.2);
      border-bottom:1px solid var(--border);
    }
    #receiveOrderModal .review-back{
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      color:var(--muted);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
      flex-shrink:0;
    }
    #receiveOrderModal .review-back:hover{
      background:rgba(255,255,255,0.08);
      color:var(--fg);
    }
    #receiveOrderModal .review-back svg{ width:18px; height:18px; }
    #receiveOrderModal .review-title-wrap{
      flex:1;
      min-width:0;
    }
    #receiveOrderModal .review-vendor{
      font-size:15px;
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #receiveOrderModal .review-meta{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    #receiveOrderModal .review-source-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:6px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      background:var(--amber-muted);
      color:var(--amber);
    }
    #receiveOrderModal .review-total{
      font-size:18px;
      font-weight:700;
      color:var(--green);
      flex-shrink:0;
    }
    #receiveOrderModal .review-body{
      padding:16px 20px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    #receiveOrderModal .receipt-summary{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:10px;
    }
    #receiveOrderModal .summary-field{
      padding:12px;
      background:rgba(0,0,0,0.25);
      border:1px solid var(--border);
      border-radius:12px;
    }
    #receiveOrderModal .summary-label{
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
      margin-bottom:4px;
    }
    #receiveOrderModal .summary-value{
      font-size:14px;
      font-weight:600;
      color:var(--fg);
    }
    #receiveOrderModal .summary-value--editable{
      display:flex;
      align-items:center;
      gap:6px;
    }
    #receiveOrderModal .summary-value--editable input{
      flex:1;
      background:transparent;
      border:none;
      color:var(--fg);
      font-size:14px;
      font-weight:600;
      padding:0;
      outline:none;
      min-width:0;
    }
    #receiveOrderModal .summary-value--editable input,
    #receiveOrderModal .parsed-item-name input,
    #receiveOrderModal .parsed-item-qty input,
    #receiveOrderModal .parsed-item-unit input{
      min-height:0;
      height:auto;
    }
    #receiveOrderModal .summary-value--editable svg{
      width:12px;
      height:12px;
      color:var(--muted);
      flex-shrink:0;
    }
    #receiveOrderModal .summary-value--date{
      position:relative;
      cursor:pointer;
    }
    #receiveOrderModal .summary-value--date input[type="date"]{
      cursor:pointer;
      color-scheme:dark;
    }
    #receiveOrderModal .summary-value--date input[type="date"]::-webkit-calendar-picker-indicator{
      cursor:pointer;
      filter:invert(1) brightness(0.7);
      opacity:0;
      position:absolute;
      left:0;
      right:0;
      top:0;
      bottom:0;
      width:100%;
      height:100%;
    }
    #receiveOrderModal .summary-value--date .date-icon{
      width:14px;
      height:14px;
      color:var(--primary);
      pointer-events:none;
    }
    #receiveOrderModal .summary-value--date:hover .date-icon{
      color:var(--fg);
    }
    #receiveOrderModal .po-link-card{
      padding:14px 16px;
      background:linear-gradient(135deg, rgba(34,197,94,0.08), rgba(34,197,94,0.02));
      border:1px solid rgba(34,197,94,0.25);
      border-radius:12px;
      display:flex;
      align-items:center;
      gap:12px;
      transition:all 0.15s ease;
    }
    #receiveOrderModal .po-link-card--none{
      background:rgba(0,0,0,0.2);
      border-color:var(--border);
    }
    #receiveOrderModal .po-link-icon{
      width:36px;
      height:36px;
      border-radius:10px;
      background:var(--green-muted);
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--green);
      flex-shrink:0;
    }
    #receiveOrderModal .po-link-card--none .po-link-icon{
      background:rgba(255,255,255,0.05);
      color:var(--muted);
    }
    #receiveOrderModal .po-link-info{ flex:1; min-width:0; }
    #receiveOrderModal .po-link-title{
      font-size:13px;
      font-weight:600;
      color:#4ade80;
      margin-bottom:2px;
    }
    #receiveOrderModal .po-link-card--none .po-link-title{
      color:var(--fg);
    }
    #receiveOrderModal .po-link-desc{
      font-size:11px;
      color:var(--muted);
    }
    #receiveOrderModal .po-link-action{
      padding:6px 12px;
      border-radius:8px;
      border:1px solid rgba(34,197,94,0.3);
      background:rgba(34,197,94,0.1);
      color:#4ade80;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.15s ease;
      white-space:nowrap;
    }
    #receiveOrderModal .po-link-action:hover{
      background:rgba(34,197,94,0.2);
    }
    #receiveOrderModal .po-link-action[disabled]{
      opacity:0.6;
      cursor:not-allowed;
    }
    #receiveOrderModal .parsed-items-section .section-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
    }
    #receiveOrderModal .parsed-items-section .section-label{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:var(--muted);
    }
    #receiveOrderModal .parsed-items-section .section-count{
      font-size:11px;
      color:var(--muted);
      background:rgba(255,255,255,0.05);
      padding:2px 8px;
      border-radius:6px;
    }
    #receiveOrderModal .parsed-items{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    #receiveOrderModal .parsed-item{
      background:rgba(0,0,0,0.25);
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      transition:all 0.15s ease;
    }
    #receiveOrderModal .parsed-item:hover{
      border-color:rgba(255,255,255,0.12);
    }
    #receiveOrderModal .parsed-item-main{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 14px;
    }
    #receiveOrderModal .parsed-item-status{
      width:32px;
      height:32px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      background:rgba(255,255,255,0.06);
      color:var(--muted);
    }
    #receiveOrderModal .parsed-item-status--matched{
      background:var(--green-muted);
      color:var(--green);
    }
    #receiveOrderModal .parsed-item-status--unmatched{
      background:var(--amber-muted);
      color:var(--amber);
    }
    #receiveOrderModal .parsed-item-status svg{ width:16px; height:16px; }
    #receiveOrderModal .parsed-item-info{
      flex:1;
      min-width:0;
    }
    #receiveOrderModal .parsed-item-name{
      font-size:13px;
      font-weight:600;
      margin-bottom:2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #receiveOrderModal .parsed-item-name input{
      width:100%;
      background:transparent;
      border:none;
      color:var(--fg);
      font-size:13px;
      font-weight:600;
      padding:0;
      outline:none;
    }
    #receiveOrderModal .parsed-item-match{
      font-size:11px;
      color:var(--muted);
    }
    #receiveOrderModal .parsed-item-values{
      display:flex;
      align-items:center;
      gap:12px;
      flex-shrink:0;
    }
    #receiveOrderModal .parsed-item-qty{
      text-align:center;
    }
    #receiveOrderModal .parsed-item-qty input{
      width:40px;
      background:transparent;
      border:none;
      color:var(--fg);
      font-size:16px;
      font-weight:700;
      text-align:center;
      padding:0;
      outline:none;
    }
    #receiveOrderModal .parsed-item-qty-label{
      font-size:9px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.03em;
    }
    #receiveOrderModal .parsed-item-price{
      text-align:right;
      min-width:70px;
    }
    #receiveOrderModal .parsed-item-unit input{
      width:70px;
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:12px;
      text-align:right;
      padding:0;
      outline:none;
    }
    #receiveOrderModal .parsed-item-total{
      font-size:14px;
      font-weight:700;
      color:var(--fg);
    }
    #receiveOrderModal .parsed-items-action{
      margin-top:8px;
      display:flex;
      justify-content:flex-end;
    }
    #receiveOrderModal .parsed-empty{
      padding:14px;
      border-radius:10px;
      border:1px dashed var(--border-subtle);
      background:rgba(0,0,0,0.2);
      font-size:12px;
      color:var(--muted);
    }
    #receiveOrderModal .parsed-item-actuals{
      display:flex;
      gap:12px;
      padding:10px 14px;
      background:rgba(0,0,0,0.15);
      border-top:1px solid var(--border-subtle);
    }
    #receiveOrderModal .parsed-item-actuals-field{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1;
    }
    #receiveOrderModal .parsed-item-actuals-field label{
      font-size:10px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:var(--muted);
    }
    #receiveOrderModal .parsed-item-actuals-field input,
    #receiveOrderModal .parsed-item-actuals-field textarea{
      background:rgba(255,255,255,0.06);
      border:1px solid var(--border);
      border-radius:6px;
      padding:8px 10px;
      font-size:13px;
      color:var(--fg);
    }
    #receiveOrderModal .parsed-item-actuals-field input:focus,
    #receiveOrderModal .parsed-item-actuals-field textarea:focus{
      outline:none;
      border-color:var(--primary);
    }
    #receiveOrderModal .parsed-item-actuals-field textarea{
      min-height:40px;
      resize:vertical;
    }
    /* Stepper controls for quantities */
    #receiveOrderModal .qty-stepper{
      display:inline-flex;
      align-items:center;
      gap:0;
      background:rgba(255,255,255,0.06);
      border:1px solid var(--border);
      border-radius:8px;
      overflow:hidden;
    }
    #receiveOrderModal .qty-stepper-btn{
      width:32px;
      height:32px;
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s;
    }
    #receiveOrderModal .qty-stepper-btn:hover{
      background:rgba(255,255,255,0.1);
      color:var(--fg);
    }
    #receiveOrderModal .qty-stepper-btn:active{
      background:rgba(255,255,255,0.15);
    }
    #receiveOrderModal .qty-stepper-btn svg{
      width:16px;
      height:16px;
    }
    #receiveOrderModal .qty-stepper-value{
      min-width:44px;
      padding:0 4px;
      text-align:center;
    }
    #receiveOrderModal .qty-stepper-value input{
      width:100%;
      background:transparent;
      border:none;
      color:var(--fg);
      font-size:15px;
      font-weight:700;
      text-align:center;
      padding:6px 0;
      outline:none;
    }
    #receiveOrderModal .qty-stepper--received{
      background:rgba(34,197,94,0.1);
      border-color:rgba(34,197,94,0.3);
    }
    #receiveOrderModal .qty-stepper--received .qty-stepper-value input{
      color:#22c55e;
    }
    #receiveOrderModal .qty-stepper--mismatch{
      background:rgba(251,191,36,0.1);
      border-color:rgba(251,191,36,0.3);
    }
    #receiveOrderModal .qty-stepper--mismatch .qty-stepper-value input{
      color:#fbbf24;
    }
    /* Parsed item SKU field */
    #receiveOrderModal .parsed-item-sku{
      margin-top:2px;
    }
    #receiveOrderModal .parsed-item-sku input{
      width:100%;
      background:transparent;
      border:none;
      color:var(--muted);
      font-size:11px;
      padding:0;
      outline:none;
    }
    #receiveOrderModal .parsed-item-sku input::placeholder{
      color:var(--muted);
      opacity:0.6;
    }
    /* Updated actuals layout */
    #receiveOrderModal .parsed-item-actuals{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      padding:12px 14px;
      background:rgba(0,0,0,0.15);
      border-top:1px solid var(--border-subtle);
    }
    #receiveOrderModal .parsed-item-actuals-row{
      display:flex;
      align-items:center;
      gap:16px;
      width:100%;
    }
    #receiveOrderModal .parsed-item-actuals-group{
      display:flex;
      align-items:center;
      gap:8px;
    }
    #receiveOrderModal .parsed-item-actuals-label{
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.03em;
      color:var(--muted);
      white-space:nowrap;
    }
    #receiveOrderModal .parsed-item-rejection{
      width:100%;
      margin-top:4px;
      display:none;
    }
    #receiveOrderModal .parsed-item-rejection.is-visible{
      display:block;
    }
    #receiveOrderModal .parsed-item-rejection textarea{
      width:100%;
      background:rgba(239,68,68,0.1);
      border:1px solid rgba(239,68,68,0.3);
      border-radius:6px;
      padding:8px 10px;
      font-size:12px;
      color:var(--fg);
      min-height:36px;
      resize:vertical;
    }
    #receiveOrderModal .parsed-item-rejection textarea::placeholder{
      color:rgba(239,68,68,0.7);
    }
    #receiveOrderModal .parsed-item-rejection textarea:focus{
      outline:none;
      border-color:rgba(239,68,68,0.5);
    }
    #receiveOrderModal .parsed-item-match-row{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      background:rgba(0,0,0,0.15);
      border-top:1px solid var(--border-subtle);
    }
    #receiveOrderModal .parsed-item-match-row .btn-match{
      background:var(--primary-muted);
      color:var(--primary);
      border:none;
      border-radius:6px;
      padding:6px 12px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    #receiveOrderModal .parsed-item-match-row .btn-match:hover{
      background:var(--primary);
      color:#fff;
    }
    #receiveOrderModal .parsed-item-match-row .btn-match svg{ width:14px; height:14px; }
    #receiveOrderModal .parsed-item-matched-info{
      flex:1;
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    #receiveOrderModal .parsed-item-matched-name{
      font-size:12px;
      font-weight:600;
      color:var(--green);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #receiveOrderModal .parsed-item-matched-sku{
      font-size:11px;
      color:var(--muted);
      flex-shrink:0;
    }
    #receiveOrderModal .parsed-item-match-row .btn-unmatch{
      background:transparent;
      border:1px solid var(--border);
      border-radius:6px;
      padding:4px 8px;
      font-size:11px;
      color:var(--muted);
      cursor:pointer;
    }
    #receiveOrderModal .parsed-item-match-row .btn-unmatch:hover{
      border-color:var(--red);
      color:var(--red);
    }
    #receiveOrderModal .parsed-item-search{
      position:relative;
      flex:1;
    }
    #receiveOrderModal .parsed-item-search input{
      width:100%;
      background:rgba(255,255,255,0.06);
      border:1px solid var(--border);
      border-radius:6px;
      padding:8px 10px;
      font-size:12px;
      color:var(--fg);
    }
    #receiveOrderModal .parsed-item-search input:focus{ outline:none; border-color:var(--primary); }
    #receiveOrderModal .parsed-item-search-results{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      background:var(--bg-elevated);
      border:1px solid var(--border);
      border-radius:8px;
      margin-top:4px;
      max-height:180px;
      overflow-y:auto;
      z-index:100;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
    }
    #receiveOrderModal .parsed-item-search-result{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      cursor:pointer;
      border-bottom:1px solid var(--border-subtle);
    }
    #receiveOrderModal .parsed-item-search-result:last-child{ border-bottom:none; }
    #receiveOrderModal .parsed-item-search-result:hover{ background:rgba(255,255,255,0.04); }
    #receiveOrderModal .parsed-item-search-result-name{
      font-size:13px;
      font-weight:500;
    }
    #receiveOrderModal .parsed-item-search-result-meta{
      font-size:11px;
      color:var(--muted);
    }
    #receiveOrderModal .notes-toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 14px;
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      background:rgba(0,0,0,0.15);
      color:var(--muted);
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    #receiveOrderModal .notes-toggle:hover{
      background:rgba(0,0,0,0.25);
      color:var(--fg);
    }
    #receiveOrderModal .notes-toggle svg{ width:14px; height:14px; }
    #receiveOrderModal .notes-toggle-arrow{
      margin-left:auto;
      transition:transform 0.2s ease;
    }
    #receiveOrderModal .notes-toggle[aria-expanded="true"] .notes-toggle-arrow{
      transform:rotate(180deg);
    }
    #receiveOrderModal .notes-content{
      margin-top:10px;
      display:none;
    }
    #receiveOrderModal .notes-content.is-open{ display:block; }
    #receiveOrderModal .notes-textarea{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.3);
      color:var(--fg);
      font-size:13px;
      font-family:inherit;
      resize:vertical;
      min-height:60px;
      outline:none;
      transition:all 0.2s ease;
    }
    #receiveOrderModal .notes-textarea::placeholder{ color:var(--muted); }
    #receiveOrderModal .notes-textarea:focus{
      border-color:rgba(125,211,252,0.4);
      background:rgba(0,0,0,0.4);
    }
    #receiveOrderModal .info-banner{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px 14px;
      background:var(--blue-muted);
      border:1px solid rgba(59,130,246,0.2);
      border-radius:10px;
      font-size:12px;
      color:#93c5fd;
    }
    #receiveOrderModal .info-banner svg{
      width:16px;
      height:16px;
      color:#60a5fa;
      flex-shrink:0;
      margin-top:1px;
    }
    #receiveOrderModal .receive-footer{
      padding:14px 20px;
      background:rgba(12,16,22,0.95);
    }
    #receiveOrderModal .btn-icon{
      padding:10px 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    #receiveOrderModal .btn-icon svg{ width:16px; height:16px; }
    @media (max-width: 520px){
      #receiveOrderModal .modal{
        max-width:100%;
        border-radius:16px 16px 0 0;
      }
      #receiveOrderModal .receipt-summary{
        grid-template-columns:1fr 1fr;
      }
      #receiveOrderModal .receipt-summary .summary-field:last-child{
        grid-column:1 / -1;
      }
      #receiveOrderModal .parsed-item-values{
        flex-direction:column;
        align-items:flex-end;
        gap:4px;
      }
      #receiveOrderModal .parsed-item-qty{
        display:flex;
        align-items:center;
        gap:4px;
      }
      #receiveOrderModal .parsed-item-qty-label{ display:none; }
      #receiveOrderModal .btn-icon span{ display:none; }
      #receiveOrderModal .parsed-item-actuals{
        flex-direction:column;
        gap:8px;
      }
      #receiveOrderModal .parsed-item-match-row{
        flex-wrap:wrap;
      }
      #receiveOrderModal .parsed-item-search{
        width:100%;
      }
    }
	    /* Qty picker wheel */
	    .qty-picker-wheel-wrap{
	      position:relative;
	      height:216px;
	      overflow:hidden;
	      -webkit-mask-image:linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
	      mask-image:linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
	    }
	    .qty-picker-highlight{
	      position:absolute;
	      top:50%;
	      left:16px;
	      right:16px;
	      height:36px;
	      transform:translateY(-50%);
	      background:rgba(120,120,128,0.24);
	      border-radius:8px;
	      pointer-events:none;
	    }
	    .qty-picker-wheel{
	      position:absolute;
	      top:0;
	      left:0;
	      right:0;
	      padding:90px 0;
	      display:flex;
	      flex-direction:column;
	      align-items:center;
	      transition:transform 150ms ease-out;
	    }
	    .qty-picker-item{
	      height:36px;
	      display:flex;
	      align-items:center;
	      justify-content:center;
	      font-size:22px;
	      font-weight:400;
	      color:rgba(255,255,255,0.85);
	      font-variant-numeric:tabular-nums;
	      transition:opacity 100ms ease, transform 100ms ease;
	    }
	    .qty-picker-item.selected{
	      font-weight:500;
	      color:#fff;
	    }
	    .report-metrics{
	      display:grid;
	      grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
	      gap:10px;
	      margin-top:12px;
	    }
	    .report-metric{
	      border:1px solid var(--border);
	      border-radius:12px;
	      padding:10px 12px;
	      background:#0d1420;
	    }
	    .report-metric .val{
	      margin-top:4px;
	      font-weight:900;
	      font-size:18px;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-metric--actionable{
	      position:relative;
	    }
	    .report-metric-action{
	      position:absolute;
	      top:8px;
	      right:8px;
	      background:rgba(255,255,255,0.08);
	      border:none;
	      border-radius:6px;
	      padding:6px;
	      cursor:pointer;
	      color:var(--muted);
	      display:flex;
	      align-items:center;
	      justify-content:center;
	      transition:color 0.15s, background 0.15s, transform 0.15s;
	    }
	    .report-metric-action:hover{
	      color:#22c55e;
	      background:rgba(34,197,94,0.15);
	      transform:scale(1.1);
	    }
	    .report-metric-action:active{
	      transform:scale(0.95);
	    }
	    .led-dot{
	      display:inline-block;
	      width:8px;
	      height:8px;
	      border-radius:50%;
	      margin-right:6px;
	      vertical-align:middle;
	      position:relative;
	      top:-1px;
	    }
	    .led-dot--red{
	      background:#ef4444;
	      box-shadow:0 0 6px rgba(239,68,68,0.5), 0 0 12px rgba(239,68,68,0.3);
	    }
	    .led-dot--amber{
	      background:#f59e0b;
	      box-shadow:0 0 6px rgba(245,158,11,0.5), 0 0 12px rgba(245,158,11,0.3);
	    }
	    .led-dot--green{
	      background:#22c55e;
	      box-shadow:0 0 6px rgba(34,197,94,0.5), 0 0 12px rgba(34,197,94,0.3);
	    }
	    .led-dot--cyan{
	      background:#06b6d4;
	      box-shadow:0 0 6px rgba(6,182,212,0.5), 0 0 12px rgba(6,182,212,0.3);
	    }
	    .led-dot--off{
	      background:rgba(148,163,184,0.55);
	      box-shadow:0 0 0 1px rgba(255,255,255,0.10);
	    }
	    .report-count{
	      color:var(--muted);
	      font-weight:900;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-progress{
	      margin-top:12px;
	      padding:10px 12px;
	      border:1px solid var(--border);
	      border-radius:14px;
	      background:#0d1420;
	    }
	    .report-progress-label{
	      display:flex;
	      align-items:center;
	      justify-content:space-between;
	      gap:10px;
	      color:var(--muted);
	      font-size:11px;
	      font-weight:900;
	      letter-spacing:0.08em;
	      text-transform:uppercase;
	    }
	    .report-progress-value{
	      flex:0 0 auto;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-progress-track{
	      margin-top:10px;
	      height:10px;
	      border-radius:999px;
	      background:rgba(255,255,255,0.10);
	      overflow:hidden;
	      border:1px solid rgba(255,255,255,0.10);
	    }
	    .report-progress-bar{
	      height:100%;
	      width:0%;
	      border-radius:999px;
	      background:linear-gradient(90deg, rgba(34,197,94,1), rgba(135,245,255,0.9));
	      box-shadow:0 0 16px rgba(34,197,94,0.35);
	      transition: width 120ms ease;
	    }
	    .report-pill-container{
	      position:static;
	      margin:12px 0 0;
	      padding:0;
	      background:none;
	    }
		    .report-section{
		      margin-top:14px;
		      border:1px solid var(--border);
		      border-radius:14px;
		      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
		      overflow:hidden;
		    }
		    .report-summary{
		      display:flex;
		      align-items:center;
		      justify-content:space-between;
		      gap:10px;
		      padding:10px 12px;
		      cursor:pointer;
		      user-select:none;
		      list-style:none;
		    }
		    .report-section summary::-webkit-details-marker{ display:none; }
		    .report-section summary::marker{ content:''; }
		    .report-summary-left h3{
		      margin:0;
		      font-size:13px;
		      letter-spacing:.08em;
		      text-transform:uppercase;
		    }
			    .report-summary-right{
			      display:flex;
			      align-items:center;
			      justify-content:flex-end;
			      gap:10px;
			      flex-shrink:0;
			    }
			    .report-summary-right .muted{ font-size:12px; }
			    .report-chevron{
			      display:inline-flex;
			      align-items:center;
			      justify-content:center;
			      color:var(--muted);
			      transform: rotate(0deg);
			      transition: transform 160ms ease;
		    }
		    .report-chevron svg{ width:16px; height:16px; }
		    .report-section[open] .report-chevron{ transform: rotate(180deg); }
		    .report-section[open] .report-summary{ border-bottom:1px solid rgba(255,255,255,0.08); }
		    .report-list{
		      display:flex;
		      flex-direction:column;
		      gap:8px;
		    }
		    .report-table{
		      width:100%;
		      border-collapse:collapse;
		      font-size:13px;
		    }
		    .report-table th{
		      text-align:left;
		      color:var(--muted);
		      font-weight:800;
		      border-bottom:1px solid rgba(255,255,255,0.10);
		      padding:10px 12px;
		      background:transparent;
		      position:static;
		      top:auto;
		      z-index:auto;
		      text-transform:uppercase;
		      font-size:11px;
		      letter-spacing:0.08em;
		      white-space:nowrap;
		    }
		    .report-table td{
		      padding:10px 12px;
		      border-bottom:1px solid rgba(255,255,255,0.08);
		      vertical-align:top;
		    }
		    .report-table td.item{
		      font-weight:900;
		      letter-spacing:0.02em;
		      white-space:nowrap;
		    }
		    .report-table td.desc{
		      color:var(--muted);
		      line-height:1.25;
		    }
		    .report-table th.qty,
		    .report-table td.qty,
		    .report-table th.thr,
		    .report-table td.thr{
		      text-align:right;
		      font-variant-numeric:tabular-nums;
		      font-weight:900;
		      white-space:nowrap;
		    }
		    .report-banner{
		      margin-top:12px;
		      padding:10px 12px;
		      border:1px solid rgba(135,245,255,0.22);
		      border-radius:12px;
		      background:rgba(135,245,255,0.06);
		      display:flex;
		      align-items:center;
		      justify-content:space-between;
		      gap:10px;
		    }
		    .report-banner-text{
		      min-width:0;
		      font-weight:700;
		      color:#c9f7ff;
		    }
		    .report-banner-actions{ display:flex; gap:8px; flex-shrink:0; }
		    .report-row{
		      display:flex;
		      align-items:flex-start;
		      justify-content:space-between;
		      gap:12px;
		      width:100%;
		      text-align:left;
		      cursor:pointer;
	      padding:10px 12px;
	      border:1px solid var(--border);
	      border-radius:12px;
	      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
	      color:inherit;
	      -webkit-appearance:none;
	      appearance:none;
	    }
	    .report-row:active{ transform:scale(0.99); }
	    .report-row:focus-visible{
	      outline:2px solid rgba(90,169,255,0.65);
	      outline-offset:2px;
	    }
		    .report-row[aria-pressed="true"]{
		      background:
		        radial-gradient(180px 90px at 50% 40%, rgba(34,197,94,0.20), rgba(34,197,94,0) 68%),
		        linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%);
		      box-shadow:0 0 0 1px rgba(34,197,94,0.12), 0 10px 24px rgba(0,0,0,0.35);
		    }
		    .report-separator{
		      display:flex;
		      align-items:center;
		      gap:10px;
		      margin:12px 0;
		      color:rgba(255,255,255,0.55);
		      font-size:11px;
		      text-transform:uppercase;
		      letter-spacing:0.08em;
		      user-select:none;
		    }
		    .report-separator::before,
		    .report-separator::after{
		      content:'';
		      flex:1;
		      height:1px;
		      background:rgba(255,255,255,0.10);
		    }
		    .report-separator span{ padding:0 2px; }
		    .report-row-main{ min-width:0; flex:1; }
	    .report-item{
	      display:flex;
	      align-items:center;
	      gap:8px;
	      min-width:0;
	      font-weight:800;
	      letter-spacing:.02em;
	    }
	    .report-item-name{
	      overflow:hidden;
	      text-overflow:ellipsis;
	      white-space:nowrap;
	      min-width:0;
	    }
	    .report-desc{
	      margin-top:4px;
	      color:var(--muted);
	      font-size:13px;
	      line-height:1.25;
	      overflow:hidden;
	      display:-webkit-box;
	      -webkit-box-orient:vertical;
	      -webkit-line-clamp:2;
	    }
	    .report-qty{
	      flex:0 0 auto;
	      min-width:56px;
	      text-align:right;
	      font-weight:900;
	      font-variant-numeric:tabular-nums;
	      display:flex;
	      flex-direction:column;
	      align-items:flex-end;
	      gap:4px;
	    }
	    .report-qty .muted{ font-size:10px; }
	    .history-kv{ margin-top:10px; font-size:13px; }
	    .history-kv div{ margin-top:4px; }
	    .history-table{
	      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
    }
    .history-table th,
    .history-table td{ padding:8px; border-bottom:1px solid var(--border); }
    .history-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
    }
    .history-table td.qty{
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:800;
    }
    .jobs-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
    }
    .jobs-table th,
    .jobs-table td{ padding:8px; border-bottom:1px solid var(--border); }
    .jobs-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:11px;
    }
    .job-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      letter-spacing:.04em;
      text-transform:uppercase;
      background:#0f172a;
      color:#93c5fd;
      border:1px solid rgba(148,163,184,0.3);
      white-space:nowrap;
    }
    .job-status--draft{ color:#93c5fd; background:#0b1220; border-color:#1f2a44; }
    .job-status--quoted{ color:#fbbf24; background:#1a1406; border-color:#3a2b0b; }
    .job-status--approved{ color:#34d399; background:#0b1a15; border-color:#1f3a2f; }
    .job-status--in_progress{ color:#60a5fa; background:#0b1623; border-color:#1d2f46; }
    .job-status--completed{ color:#a78bfa; background:#141022; border-color:#2b1e46; }
    .job-status--voided{ color:#f87171; background:#1a0d0d; border-color:#3a1515; }
    .job-meta{ color:var(--muted); font-size:12px; }
    .job-form-grid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px; }
    .job-field{ display:flex; flex-direction:column; gap:6px; }
    .job-bom-add{ display:grid; grid-template-columns:minmax(0,1fr) 140px auto; gap:10px; align-items:end; }
    .jobs-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow-x:hidden;
      width:100%;
    }
    .job-row{
      display:flex;
      flex-direction:column;
      gap:0;
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(13,18,24,0.65);
      width:100%;
      max-width:100%;
      min-width:0;
      box-sizing:border-box;
    }
    .job-card-header{
      display:grid;
      grid-template-columns:18px minmax(0,1fr) auto;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      cursor:pointer;
    }
    .job-chevron{
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border:none;
      background:none;
      padding:0;
      cursor:pointer;
      flex:0 0 auto;
    }
    .job-chevron svg{ transition:transform 0.15s ease; }
    .job-row[aria-expanded="true"] .job-chevron svg{ transform:rotate(90deg); }
    .job-header-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .job-name{
      font-weight:800;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .job-header-meta{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      min-width:0;
      color:var(--muted);
      font-size:12px;
    }
    .job-status-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      letter-spacing:0.04em;
      text-transform:uppercase;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .job-readiness-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      letter-spacing:0.02em;
      text-transform:uppercase;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .job-status-pill--approved{
      color:var(--status-approved, #238636);
      background:rgba(35,134,54,0.15);
      border-color:rgba(35,134,54,0.3);
    }
    .job-status-pill--pending{
      color:var(--status-pending, #9e6a03);
      background:rgba(158,106,3,0.15);
      border-color:rgba(158,106,3,0.3);
    }
    .job-status-pill--draft{
      color:var(--status-draft, #6e7681);
      background:rgba(110,118,129,0.15);
      border-color:rgba(110,118,129,0.3);
    }
    .job-readiness-pill--ready{
      color:var(--status-approved, #22c55e);
      background:rgba(34,197,94,0.12);
      border-color:rgba(34,197,94,0.3);
    }
    .job-readiness-pill--not-ready{
      color:var(--status-pending, #f59e0b);
      background:rgba(245,158,11,0.12);
      border-color:rgba(245,158,11,0.3);
    }
    .job-readiness-pill--unknown{
      color:var(--muted, #94a3b8);
      background:rgba(148,163,184,0.12);
      border-color:rgba(148,163,184,0.3);
    }
    .job-summary{
      display:inline-flex;
      align-items:center;
      gap:6px;
      min-width:0;
      white-space:nowrap;
    }
    .job-shortage{
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--alert-warning, #d29922);
      font-weight:600;
    }
    .job-actions{
      display:flex;
      align-items:center;
      gap:4px;
      flex-wrap:nowrap;
      justify-content:flex-end;
      flex:0 0 auto;
      justify-self:end;
    }
    .job-actions .icon-btn{ padding:2px; width:32px; height:32px; }
    .job-action--approve{ color:#34d399; }
    .job-action--complete{ color:#60a5fa; }
    .job-action--void{ color:#f87171; }
    .job-action--edit{ color:#93c5fd; }
    .job-action--view{ color:#e2e8f0; }
    @media (hover: hover) and (pointer: fine){
      #invTable tbody tr[data-id] .actions-wrap,
      .job-row .job-actions{
        opacity:0;
        pointer-events:none;
        transform:translateX(4px);
        transition:opacity 140ms ease, transform 140ms ease;
      }
      #invTable tbody tr[data-id]:hover .actions-wrap,
      #invTable tbody tr[data-id]:focus-within .actions-wrap,
      .job-row:hover .job-actions,
      .job-row:focus-within .job-actions{
        opacity:1;
        pointer-events:auto;
        transform:translateX(0);
      }
    }
    @media (max-width: 720px){
      .job-row{ gap:8px; }
      .job-status{ padding:3px 8px; font-size:10px; }
      .job-summary{ font-size:11px; }
      .job-actions .icon-btn{ width:30px; height:30px; }
    }
    .job-detail{
      margin:0;
      padding:8px 12px 12px 12px;
      border-top:1px solid rgba(148,163,184,0.2);
      overflow:hidden;
      width:100%;
      max-width:100%;
      box-sizing:border-box;
    }
    .job-items-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .job-items-table th,
    .job-items-table td{
      padding:8px 6px;
      border-bottom:1px solid rgba(148,163,184,0.2);
      vertical-align:top;
    }
    .job-items-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:11px;
    }
    .job-items-table td.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:700;
    }
    .job-item-name{
      font-weight:700;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .job-item-sku{
      font-size:11px;
      color:var(--muted);
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .job-item-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      font-weight:600;
      white-space:nowrap;
    }
    .job-item-status--fulfilled{ color:var(--alert-success, #3fb950); }
    .job-item-status--shortage{ color:var(--alert-warning, #d29922); }
    .job-item-status--out{ color:var(--alert-danger, #f85149); }
    .job-bom-incoming{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:30px;
      height:30px;
      color:#60a5fa;
      cursor:help;
    }
    .job-bom-incoming svg{ width:18px; height:18px; }
    .job-items-summary{
      display:flex;
      justify-content:flex-end;
      gap:16px;
      padding-top:10px;
      font-size:12px;
      font-weight:700;
      color:var(--muted);
    }
    .job-items-summary span{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .job-items-summary .job-total-short{
      color:var(--alert-warning, #d29922);
    }
    /* Job BOM Mini Cards */
    .job-bom-cards{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .job-bom-card{
      background:linear-gradient(145deg, rgba(26,31,38,0.7) 0%, rgba(18,22,28,0.8) 100%);
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      border-left:3px solid #22c55e;
      padding:12px;
      position:relative;
    }
    .job-bom-card.shortage{ border-left-color:#f59e0b; }
    .job-bom-card.out-of-stock{ border-left-color:#ef4444; }
    .job-bom-card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:10px;
    }
    .job-bom-card-name{
      font-weight:600;
      font-size:14px;
      color:#f1f5f9;
      line-height:1.3;
    }
    .job-bom-card-sku{
      font-size:11px;
      color:#64748b;
      margin-top:2px;
    }
    .job-bom-card-status{
      display:flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      font-weight:600;
      padding:4px 8px;
      border-radius:6px;
      flex-shrink:0;
    }
    .job-bom-card-status svg{ width:12px; height:12px; }
    .job-bom-card-status.in-stock{ background:rgba(34,197,94,0.15); color:#22c55e; }
    .job-bom-card-status.shortage{ background:rgba(249,115,22,0.15); color:#f97316; }
    .job-bom-card-status.out-of-stock{ background:rgba(239,68,68,0.15); color:#ef4444; }
    .job-bom-card-stats{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:8px;
    }
    .job-bom-stat{
      background:rgba(0,0,0,0.25);
      border-radius:8px;
      padding:8px;
      text-align:center;
    }
    .job-bom-stat-value{
      font-size:16px;
      font-weight:700;
      color:#e2e8f0;
      font-variant-numeric:tabular-nums;
    }
    .job-bom-stat-value.on-hand-out{ color:#ef4444; }
    .job-bom-stat-value.on-hand-low{ color:#f59e0b; }
    .job-bom-stat-label{
      font-size:10px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-top:2px;
    }
    .job-bom-card-footer{
      display:flex;
      justify-content:flex-end;
      margin-top:10px;
      padding-top:8px;
      border-top:1px solid rgba(255,255,255,0.04);
    }
    @media (max-width: 480px){
      .job-bom-card-stats{ grid-template-columns:repeat(2, 1fr); }
    }
    @media (max-width: 640px){
      .job-items-table thead{ display:none; }
      .job-items-table tr{
        display:block;
        padding:8px 0;
      }
      .job-items-table td{
        display:flex;
        justify-content:space-between;
        gap:12px;
        padding:4px 0;
        border-bottom:none;
      }
      .job-items-table td::before{
        content:attr(data-label);
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:0.05em;
        font-size:10px;
        font-weight:600;
      }
      .job-items-table td.item-cell{
        display:block;
      }
      .job-items-table td.item-cell::before{ display:none; }
    }

    /* Jobs Modal Layout */
    #jobsModal .modal{
      max-height:85vh;
    }
    #jobsModal .modal-header,
    #jobsModal .modal-toolbar,
    #jobsModal .modal-footer{
      flex-shrink:0;
    }
    #jobsModal .modal-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      background:rgba(12,16,22,0.85);
    }
    #jobsModal .modal-toolbar-label{
      font-size:12px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    #jobsModal .modal-toolbar-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    #jobsModal .modal-content{
      flex:1 1 auto;
      min-height:0;
      overflow-y:auto;
      padding:12px 16px 16px;
      -webkit-overflow-scrolling:touch;
    }
    #jobsModal #jobsMsg{ margin-top:8px; }
    #jobsModal .modal-content::-webkit-scrollbar{ width:8px; }
    #jobsModal .modal-content::-webkit-scrollbar-track{
      background:rgba(255,255,255,0.02);
      border-radius:4px;
    }
    #jobsModal .modal-content::-webkit-scrollbar-thumb{
      background:rgba(255,255,255,0.1);
      border-radius:4px;
    }
    #jobsModal .modal-content::-webkit-scrollbar-thumb:hover{
      background:rgba(255,255,255,0.15);
    }
    #jobsModal .udwe-table-wrap{
      max-width:100% !important;
    }
    #jobs_bom_table{
      width:100%;
      min-width:550px;
      table-layout:fixed;
    }
    #jobs_bom_table thead th{
      background:rgba(0,0,0,0.2);
    }
    #jobs_bom_table colgroup col:nth-child(1){ width:40% !important; }
    #jobs_bom_table colgroup col:nth-child(2){ width:12% !important; }
    #jobs_bom_table colgroup col:nth-child(3){ width:12% !important; }
    #jobs_bom_table colgroup col:nth-child(4){ width:20% !important; }
    #jobs_bom_table colgroup col:nth-child(5){ width:16% !important; }
    #jobs_bom_table th:nth-child(1),
    #jobs_bom_table td:nth-child(1){ min-width:180px; }
    #jobs_bom_table th:nth-child(2),
    #jobs_bom_table td:nth-child(2){ min-width:70px; }
    #jobs_bom_table th:nth-child(3),
    #jobs_bom_table td:nth-child(3){ min-width:80px; }
    #jobs_bom_table th:nth-child(4),
    #jobs_bom_table td:nth-child(4){ min-width:120px; }
    #jobs_bom_table th:nth-child(5),
    #jobs_bom_table td:nth-child(5){ min-width:100px; }
    #jobs_bom_table .item-cell{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    #jobs_bom_table .item-name{
      font-weight:500;
      color:#f1f5f9;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:250px;
      display:block;
    }
    #jobs_bom_table .item-sku{
      font-size:12px;
      color:#64748b;
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    #jobsModal .job-item-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 10px;
      border-radius:6px;
      font-size:12px;
      font-weight:500;
      white-space:nowrap;
    }
    #jobsModal .job-item-status--in-stock,
    #jobsModal .job-item-status--fulfilled{
      background:rgba(52,211,153,0.1);
      color:#34d399;
    }
    #jobsModal .job-item-status--low-stock,
    #jobsModal .job-item-status--shortage{
      background:rgba(251,191,36,0.1);
      color:#fbbf24;
    }
    #jobsModal .job-item-status--out{
      background:rgba(248,113,113,0.1);
      color:#f87171;
    }
    /* Jobs BOM Table - Mobile Responsive */
    @media (max-width: 640px){
      #jobs_bom_table{
        min-width:0;
        table-layout:auto;
      }
      #jobs_bom_table thead{
        display:none;
      }
      #jobs_bom_table tbody tr{
        display:block;
        padding:12px 0;
        border-bottom:1px solid var(--border);
      }
      #jobs_bom_table tbody tr:last-child{
        border-bottom:none;
      }
      #jobs_bom_table td{
        display:flex;
        justify-content:space-between;
        align-items:center;
        gap:12px;
        padding:6px 0;
        border-bottom:none;
        min-width:0 !important;
      }
      #jobs_bom_table td::before{
        content:attr(data-label);
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:0.05em;
        font-size:10px;
        font-weight:600;
        flex-shrink:0;
      }
      #jobs_bom_table td:first-child{
        display:block;
        padding-bottom:8px;
      }
      #jobs_bom_table td:first-child::before{
        display:none;
      }
      #jobs_bom_table .item-cell{
        flex-direction:row;
        gap:8px;
      }
      #jobs_bom_table .item-name{
        max-width:none;
      }
      #jobs_bom_table colgroup{
        display:none;
      }
    }

    /* Job Modal Redesign */
    .job-modal{
      width:100%;
      max-width:420px;
      background:rgba(26,31,38,0.95);
      backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px);
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      max-height:85vh;
    }
    .job-modal .modal-body{
      padding:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .job-modal .job-footer--icons{
      flex-direction:column;
      align-items:stretch;
      gap:16px;
      padding:16px 20px calc(16px + env(safe-area-inset-bottom));
    }
    .job-modal .job-footer--icons .footer-message{
      text-align:center;
      font-size:12px;
    }
    .job-modal .job-footer--icons .footer-actions{
      display:flex;
      justify-content:center;
      gap:24px;
    }
    .job-modal .footer-icon-btn{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      background:transparent;
      border:none;
      padding:12px 16px;
      border-radius:12px;
      cursor:pointer;
      transition:all 0.15s ease;
      min-width:72px;
    }
    .job-modal .footer-icon-btn svg{
      width:24px;
      height:24px;
    }
    .job-modal .footer-icon-label{
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.04em;
    }
    .job-modal .footer-icon-btn--cancel{
      color:var(--muted);
    }
    .job-modal .footer-icon-btn--cancel:hover{
      background:rgba(255,255,255,0.05);
      color:var(--fg);
    }
    .job-modal .footer-icon-btn--confirm{
      color:var(--green);
      background:var(--green-muted);
    }
    .job-modal .footer-icon-btn--confirm:hover{
      background:var(--green);
      color:#fff;
    }
    .job-modal .footer-icon-btn:disabled{
      opacity:0.4;
      cursor:not-allowed;
    }
    .job-modal .footer-icon-btn:disabled:hover{
      background:transparent;
    }
    .job-status-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background:rgba(0,0,0,0.2);
      gap:10px;
    }
    .job-status-name{
      font-size:14px;
      font-weight:600;
      color:#eaeff7;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      flex:1;
      min-width:0;
    }
    .job-status-badge{
      padding:4px 10px;
      border-radius:6px;
      font-size:11px;
      font-weight:700;
      letter-spacing:0.3px;
      text-transform:uppercase;
      border:1px solid transparent;
      flex-shrink:0;
    }
    .job-readiness-badge{
      padding:4px 10px;
      border-radius:6px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.2px;
      text-transform:uppercase;
      border:1px solid transparent;
      flex-shrink:0;
    }
    .job-readiness-badge--ready{
      background:rgba(34,197,94,0.18);
      color:#22c55e;
      border-color:rgba(34,197,94,0.35);
    }
    .job-readiness-badge--not-ready{
      background:rgba(245,158,11,0.18);
      color:#f59e0b;
      border-color:rgba(245,158,11,0.35);
    }
    .job-readiness-badge--unknown{
      background:rgba(148,163,184,0.16);
      color:#94a3b8;
      border-color:rgba(148,163,184,0.3);
    }
    .job-autosave-status{
      font-size:11px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:5px;
      margin-left:auto;
      opacity:0;
      transition:opacity 0.2s;
    }
    .job-autosave-status.visible{
      opacity:1;
    }
    .job-autosave-status.saving{
      color:#f59e0b;
    }
    .job-autosave-status.saved{
      color:#22c55e;
    }
    .job-autosave-status.error{
      color:#ef4444;
    }
    .job-autosave-status svg{
      width:12px;
      height:12px;
    }
    .job-readiness-detail{
      display:flex;
      flex-direction:column;
      gap:4px;
      font-size:12px;
      color:var(--muted);
    }
    .job-readiness-detail .job-readiness-value{
      font-weight:700;
      color:#e2e8f0;
    }
    .job-readiness-detail .job-readiness-reasons{
      font-size:11px;
      color:var(--muted);
    }
    .job-readiness-section{
      margin-bottom:16px;
    }
    .job-readiness-section-title{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .job-readiness-card{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.2);
    }
    .job-readiness-card--ready{
      border-color:rgba(34,197,94,0.35);
      background:rgba(34,197,94,0.08);
    }
    .job-readiness-card--not-ready{
      border-color:rgba(245,158,11,0.35);
      background:rgba(245,158,11,0.08);
    }
    .job-readiness-card--unknown{
      border-color:rgba(148,163,184,0.3);
      background:rgba(148,163,184,0.08);
    }
    .job-readiness-card-icon{
      width:34px;
      height:34px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      border:1px solid rgba(255,255,255,0.12);
      background:rgba(255,255,255,0.06);
      color:var(--muted);
    }
    .job-readiness-card--ready .job-readiness-card-icon{
      border-color:rgba(34,197,94,0.35);
      color:#22c55e;
      background:rgba(34,197,94,0.15);
    }
    .job-readiness-card--not-ready .job-readiness-card-icon{
      border-color:rgba(245,158,11,0.35);
      color:#f59e0b;
      background:rgba(245,158,11,0.15);
    }
    .job-readiness-card-content{
      flex:1;
      min-width:0;
    }
    .job-readiness-card-title{
      font-size:14px;
      font-weight:700;
      color:#e2e8f0;
      margin-bottom:4px;
    }
    .job-readiness-card-sub{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
    }
    .job-readiness-card-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .job-readiness-card-btn{
      padding:6px 10px;
      border-radius:8px;
      font-size:12px;
      font-weight:600;
      min-height:0;
    }
    /* Materials readiness banner - single source of readiness messaging */
    .job-materials-readiness-banner{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      margin-bottom:14px;
      border-radius:10px;
      border:1px solid rgba(148,163,184,0.2);
      background:rgba(0,0,0,0.15);
      font-size:13px;
      line-height:1.4;
    }
    .job-materials-readiness-banner svg{
      width:18px;
      height:18px;
      flex-shrink:0;
    }
    .job-materials-readiness-banner--empty{
      border-color:rgba(148,163,184,0.25);
      background:rgba(148,163,184,0.06);
      color:#94a3b8;
    }
    .job-materials-readiness-banner--shortage{
      border-color:rgba(245,158,11,0.35);
      background:rgba(245,158,11,0.08);
      color:#fbbf24;
    }
    .job-materials-readiness-banner--ready{
      border-color:rgba(34,197,94,0.35);
      background:rgba(34,197,94,0.08);
      color:#4ade80;
    }
    .job-materials-readiness-banner-content{
      flex:1;
      min-width:0;
    }
    .job-materials-readiness-banner-text{
      font-weight:600;
    }
    .job-materials-readiness-banner-sub{
      font-size:12px;
      opacity:0.8;
      margin-top:2px;
    }
    .job-blocking-section{
      margin-top:12px;
    }
    .job-blocking-title{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .job-blocking-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .job-blocking-card{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(245,158,11,0.3);
      background:rgba(245,158,11,0.08);
    }
    .job-blocking-info{
      flex:1;
      min-width:0;
    }
    .job-blocking-name{
      font-size:13px;
      font-weight:600;
      color:#f1f5f9;
      margin-bottom:4px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .job-blocking-meta{
      font-size:12px;
      color:var(--muted);
    }
    .job-blocking-shortfall{
      margin-top:4px;
      font-size:12px;
      font-weight:600;
      color:#fbbf24;
    }
    .job-blocking-note{
      margin-top:4px;
      font-size:11px;
      color:#94a3b8;
    }
    .job-blocking-badge{
      align-self:flex-start;
      padding:4px 8px;
      border-radius:6px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.3px;
      background:rgba(59,130,246,0.18);
      color:#60a5fa;
      border:1px solid rgba(59,130,246,0.3);
      flex-shrink:0;
    }
    .job-status-badge--draft{
      background:rgba(59,130,246,0.2);
      color:#3b82f6;
      border-color:rgba(59,130,246,0.3);
    }
    .job-status-badge--quoted{
      background:rgba(245,158,11,0.2);
      color:#f59e0b;
      border-color:rgba(245,158,11,0.3);
    }
    .job-status-badge--approved{
      background:rgba(168,85,247,0.2);
      color:#a855f7;
      border-color:rgba(168,85,247,0.3);
    }
    .job-status-badge--in_progress{
      background:rgba(245,158,11,0.2);
      color:#f59e0b;
      border-color:rgba(245,158,11,0.3);
    }
    .job-status-badge--completed{
      background:rgba(34,197,94,0.2);
      color:#22c55e;
      border-color:rgba(34,197,94,0.3);
    }
    .job-status-badge--voided{
      background:rgba(239,68,68,0.2);
      color:#ef4444;
      border-color:rgba(239,68,68,0.3);
    }
    .job-status-display{
      padding:10px 14px;
      border-radius:10px;
      font-size:12px;
      font-weight:700;
      text-align:center;
      text-transform:uppercase;
      border:1px solid rgba(255,255,255,0.1);
    }
    .job-progress-stepper{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px 20px;
      background:rgba(0,0,0,0.15);
      border-bottom:1px solid rgba(255,255,255,0.06);
      gap:8px;
    }
    .job-step-item{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      background:none;
      border:none;
      color:inherit;
      padding:0;
    }
    .job-step-circle{
      width:32px;
      height:32px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:14px;
      font-weight:700;
      transition:all 0.2s ease;
    }
    .job-step-circle.complete{
      background:rgba(34,197,94,0.2);
      border:2px solid #22c55e;
      color:#22c55e;
    }
    .job-step-circle.blocked{
      background:rgba(245,158,11,0.18);
      border:2px solid #f59e0b;
      color:#f59e0b;
    }
    .job-step-circle.current{
      background:rgba(59,130,246,0.2);
      border:2px solid #3b82f6;
      color:#3b82f6;
    }
    .job-step-circle.future{
      background:transparent;
      border:2px solid rgba(255,255,255,0.2);
      color:#64748b;
    }
    .job-step-circle svg{
      width:16px;
      height:16px;
    }
    .job-step-label{
      font-size:11px;
      font-weight:500;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }
    .job-step-label.current{ color:#3b82f6; }
    .job-step-label.complete{ color:#22c55e; }
    .job-step-label.blocked{ color:#f59e0b; }
    .job-step-connector{
      width:40px;
      height:2px;
      background:rgba(255,255,255,0.15);
      margin-bottom:22px;
      transition:all 0.2s ease;
    }
    .job-step-connector.complete{
      background:#22c55e;
    }
    .job-tabs{
      display:flex;
      border-bottom:1px solid rgba(255,255,255,0.06);
      flex-shrink:0;
    }
    .job-tab{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:12px 8px;
      border:none;
      background:transparent;
      color:#64748b;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      border-bottom:2px solid transparent;
      transition:all 0.15s ease;
    }
    .job-tab:hover{ color:#94a3b8; }
    .job-tab.active{
      color:#3b82f6;
      border-bottom-color:#3b82f6;
    }
    .job-tab-badge{
      padding:2px 6px;
      border-radius:10px;
      background:rgba(255,255,255,0.1);
      font-size:11px;
      font-weight:600;
      color:#94a3b8;
    }
    .job-tab-badge.warning{
      background:rgba(239,68,68,0.2);
      color:#f87171;
    }
    .job-tab-badge.success{
      background:rgba(34,197,94,0.2);
      color:#22c55e;
    }
    .job-tab-check{
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .job-tab-check svg{
      width:14px;
      height:14px;
      color:#22c55e;
    }
    .job-content{
      flex:1;
      overflow-y:auto;
      overflow-x:hidden;
      padding:12px;
      -webkit-overflow-scrolling:touch;
    }
    .job-tab-panel{ display:block; }
    .job-field-group{ margin-bottom:16px; }
    .job-field-row{ display:flex; gap:12px; margin-bottom:16px; }
    .job-field-half{ flex:1; }
    .job-field-label{
      display:block;
      font-size:10px;
      font-weight:600;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:6px;
    }
    .job-text-input,
    .job-text-area{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(13,19,27,0.8);
      color:#eaeff7;
      font-size:14px;
      font-weight:500;
    }
    .job-text-area{
      resize:vertical;
      min-height:100px;
      font-family:inherit;
    }
    .job-date-display{
      padding:10px 14px;
      border-radius:10px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      color:#94a3b8;
      font-size:13px;
    }
    .job-save-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
      padding:12px;
      border-radius:10px;
      font-size:14px;
      font-weight:600;
      margin-bottom:16px;
    }
    .job-quick-stats{
      display:flex;
      gap:8px;
      padding:12px;
      background:rgba(0,0,0,0.2);
      border-radius:10px;
    }
    .job-quick-stat-item{
      flex:1;
      text-align:center;
    }
    .job-quick-stat-value{
      display:block;
      font-size:20px;
      font-weight:700;
      color:#eaeff7;
      margin-bottom:2px;
    }
    .job-quick-stat-value.danger{ color:#ef4444; }
    .job-quick-stat-value.success{ color:#22c55e; }
    .job-quick-stat-label{
      font-size:10px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }
    .job-next-step-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
      padding:14px;
      margin-top:20px;
      border-radius:10px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .job-next-step-icon svg{
      width:18px;
      height:18px;
    }
    .job-step-hint,
    .job-step-hint-info{
      font-size:12px;
      text-align:center;
      margin-top:8px;
    }
    .job-step-hint{ color:#64748b; }
    .job-step-hint-info{ color:#3b82f6; }
    .job-add-item-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
      padding:12px;
      margin-bottom:12px;
      border-radius:10px;
      font-size:14px;
      font-weight:500;
    }
    .job-add-item-icon svg{ width:18px; height:18px; }
    .job-empty-state{
      text-align:center;
      padding:40px 20px;
    }
    .job-empty-title{
      font-size:15px;
      font-weight:600;
      color:#94a3b8;
      margin:0 0 6px 0;
    }
    .job-empty-text{
      font-size:13px;
      color:#64748b;
      margin:0;
    }
    .job-item-card{
      background:linear-gradient(145deg, rgba(26,31,38,0.8) 0%, rgba(18,22,28,0.9) 100%);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.06);
      border-left:3px solid #22c55e;
      padding:14px;
      margin-bottom:10px;
      cursor:pointer;
      position:relative;
      transition:all 0.15s ease;
    }
    .job-item-card.status-good{ border-left-color:#22c55e; }
    .job-item-card.status-pending{ border-left-color:#f59e0b; }
    .job-item-card.status-shortage{ border-left-color:#ef4444; }
    .job-item-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:12px;
    }
    .job-item-info{ flex:1; min-width:0; }
    .job-item-name{
      display:block;
      font-size:14px;
      font-weight:600;
      color:#eaeff7;
      margin-bottom:2px;
    }
    .job-item-sku{
      font-size:12px;
      color:#64748b;
    }
    .job-item-planned{ text-align:right; flex-shrink:0; }
    .job-planned-label{
      display:block;
      font-size:10px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:4px;
    }
    .job-planned-stepper{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .job-step-btn{
      width:28px;
      height:28px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(16,24,38,0.8);
      color:#fff;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .job-step-btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .job-planned-value{
      min-width:28px;
      text-align:center;
      font-size:16px;
      font-weight:700;
      color:#eaeff7;
    }
    .job-planned-input{ display:none; }
    .job-stock-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding:10px;
      background:rgba(0,0,0,0.2);
      border-radius:8px;
      margin-bottom:8px;
    }
    .job-item-card.completed{
      cursor:default;
    }
    .job-item-actuals{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      background:rgba(0,0,0,0.2);
      border-radius:8px;
      margin-bottom:8px;
    }
    .job-item-actuals-label{
      font-size:10px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }
    .job-item-actuals-value{
      font-size:16px;
      font-weight:700;
      color:#eaeff7;
      font-variant-numeric:tabular-nums;
    }
    .job-item-actuals-note{
      font-size:11px;
      color:#64748b;
      margin-top:6px;
    }
    .job-stock-item{
      flex:1;
      text-align:center;
    }
    .job-stock-value{
      display:block;
      font-size:16px;
      font-weight:700;
      color:#eaeff7;
      margin-bottom:2px;
      font-variant-numeric:tabular-nums;
    }
    .readonly-value{
      color:#64748b;
      font-style:italic;
    }
    .readonly-value.on-hand-good{ color:#22c55e; }
    .readonly-value.on-hand-low{ color:#fbbf24; }
    .readonly-value.on-hand-out{ color:#f87171; }
    .job-stock-label{
      font-size:9px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }
    .job-shortfall-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      background:rgba(239,68,68,0.08);
      border-radius:8px;
      border:1px solid rgba(239,68,68,0.15);
      margin-bottom:8px;
    }
    .job-shortfall-info{ flex:1; min-width:0; }
    .job-shortfall-warning{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:13px;
      color:#f87171;
    }
    .job-shortfall-warning svg{
      width:16px;
      height:16px;
      color:#ef4444;
      flex-shrink:0;
    }
    .job-shortfall-text{ font-size:13px; color:#f87171; }
    .job-shortfall-value{ font-weight:700; color:#ef4444; }
    .job-on-order-note{
      display:flex;
      align-items:center;
      gap:5px;
      margin-top:4px;
      font-size:11px;
      color:#3b82f6;
    }
    .job-on-order-note svg{ width:12px; height:12px; }
    .job-shortfall-link{
      display:flex;
      align-items:center;
      gap:5px;
      margin-top:4px;
      font-size:11px;
      color:#94a3b8;
    }
    .job-shortfall-link.has-order{ color:#22c55e; }
    .job-shortfall-link svg{ width:12px; height:12px; }
    .job-add-to-po-btn{
      display:flex;
      align-items:center;
      gap:6px;
      padding:8px 12px;
      border-radius:8px;
      border:1px solid rgba(34,197,94,0.4);
      background:rgba(34,197,94,0.15);
      color:#22c55e;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      flex-shrink:0;
      transition:all 0.15s ease;
    }
    .job-add-to-po-btn svg{ width:16px; height:16px; }
    .job-add-to-po-wrap{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      flex-shrink:0;
    }
    .job-add-to-po-note{
      font-size:10px;
      color:#94a3b8;
      line-height:1;
    }
    /* Cart feedback animation */
    .job-bom-order-btn.cart-added{
      background:rgba(34,197,94,0.25) !important;
      border-color:#22c55e !important;
      color:#22c55e !important;
      transform:scale(1.1);
    }
    .job-bom-order-btn.cart-added svg{
      color:#22c55e;
    }
    .job-bom-card-footer{
      overflow:visible;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
    }
    .job-bom-delete-btn{
      opacity:0.6;
      transition:opacity 0.15s ease;
    }
    .job-bom-delete-btn:hover{
      opacity:1;
    }
    .cart-feedback-toast{
      position:relative;
      display:flex;
      align-items:center;
      gap:12px;
      background:linear-gradient(135deg, #065f46 0%, #047857 100%);
      color:#ecfdf5;
      border:1px solid rgba(16,185,129,0.3);
      font-size:14px;
      font-weight:600;
      padding:14px 18px;
      border-radius:12px;
      box-shadow:0 10px 40px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.2);
      animation:toastSlideIn 0.3s cubic-bezier(0.21,1.02,0.73,1);
      overflow:hidden;
    }
    .cart-feedback-toast svg{
      width:22px;
      height:22px;
      color:#34d399;
      flex-shrink:0;
    }
    .cart-feedback-toast span{
      font-weight:600;
    }
    .cart-feedback-toast::after{
      content:'';
      position:absolute;
      bottom:0;
      left:0;
      height:4px;
      width:100%;
      background:#34d399;
      border-radius:0 0 12px 12px;
      animation:toastProgress 1.7s linear forwards;
    }
    /* Persistent "In Cart" badge for job BOM cards */
    .job-bom-in-cart{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      font-weight:600;
      color:#22c55e;
      background:rgba(34,197,94,0.15);
      padding:6px 12px;
      border-radius:8px;
      border:1px solid rgba(34,197,94,0.3);
    }
    .job-bom-in-cart svg{
      width:14px;
      height:14px;
    }
    .job-expand-hint{
      position:absolute;
      bottom:6px;
      left:50%;
      transform:translateX(-50%);
    }
    .job-expand-hint svg{
      width:16px;
      height:16px;
      color:#4b5563;
      transition:transform 0.2s ease;
    }
    .job-item-card.expanded .job-expand-hint svg{
      transform:rotate(180deg);
    }
    .job-item-expanded{
      display:flex;
      gap:8px;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    .job-item-action-btn{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(255,255,255,0.03);
      color:#94a3b8;
      font-size:12px;
      font-weight:500;
      cursor:pointer;
    }
    .job-item-action-btn svg{ width:14px; height:14px; }
    .job-item-action-btn.danger{
      border-color:rgba(239,68,68,0.2);
      background:rgba(239,68,68,0.05);
      color:#f87171;
    }
    .job-action-card{
      background:rgba(0,0,0,0.2);
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
    }
    .job-action-card-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .job-action-card-icon svg{ width:20px; height:20px; color:#a855f7; }
    .job-action-card-title{
      font-size:14px;
      font-weight:600;
      color:#eaeff7;
    }
    .job-action-card-desc{
      font-size:13px;
      color:#64748b;
      line-height:1.5;
      margin:0 0 12px 0;
    }
    .job-approve-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
      padding:12px;
      border-radius:10px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .job-shortfall-info-box{
      background:rgba(59,130,246,0.08);
      border:1px solid rgba(59,130,246,0.2);
      border-radius:10px;
      padding:14px;
      margin-bottom:14px;
    }
    .job-shortfall-info-header{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:8px;
    }
    .job-shortfall-info-icon svg{
      width:18px;
      height:18px;
      color:#3b82f6;
      flex-shrink:0;
    }
    .job-shortfall-info-title{
      font-size:13px;
      font-weight:600;
      color:#3b82f6;
    }
    .job-shortfall-info-text{
      font-size:12px;
      color:#94a3b8;
      line-height:1.5;
      margin:0 0 12px 0;
    }
    .job-shortfall-info-text strong{ color:#eaeff7; }
    .job-shortfall-benefits{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .job-shortfall-benefit-item{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:11px;
      color:#22c55e;
    }
    .job-shortfall-benefit-item svg{ width:14px; height:14px; }
    .job-shortfall-info-list{
      margin-top:10px;
      font-size:12px;
      color:#94a3b8;
    }
    .job-progress-card{
      background:rgba(0,0,0,0.2);
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
    }
    .job-progress-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .job-progress-title{
      font-size:14px;
      font-weight:600;
      color:#eaeff7;
    }
    .job-progress-percent{
      font-size:20px;
      font-weight:800;
      color:#3b82f6;
    }
    .job-progress-bar-bg{
      height:8px;
      background:rgba(255,255,255,0.1);
      border-radius:4px;
      overflow:hidden;
      margin-bottom:8px;
    }
    .job-progress-bar-fill{
      height:100%;
      background:#3b82f6;
      border-radius:4px;
      transition:width 0.3s ease;
    }
    .job-progress-stats{
      font-size:12px;
      color:#64748b;
      text-align:center;
    }
    .job-completion-card{
      background:linear-gradient(145deg, rgba(26,31,38,0.8) 0%, rgba(18,22,28,0.9) 100%);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.06);
      padding:14px;
      margin-bottom:10px;
    }
    .job-completion-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      margin-bottom:12px;
    }
    .job-completion-percent{
      font-size:18px;
      font-weight:700;
      color:#94a3b8;
    }
    .job-completion-percent.complete{ color:#22c55e; }
    .job-completion-row{
      display:flex;
      gap:16px;
      margin-bottom:10px;
    }
    .job-completion-planned,
    .job-completion-actual{
      flex:1;
    }
    .job-completion-label{
      display:block;
      font-size:10px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:6px;
    }
    .job-completion-value{
      font-size:20px;
      font-weight:700;
      color:#94a3b8;
    }
    .job-actual-stepper{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .job-actual-stepper .job-step-btn{
      width:32px;
      height:32px;
      border-radius:8px;
    }
    .job-actual-input{
      width:50px;
      padding:6px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(13,19,27,0.8);
      color:#eaeff7;
      font-size:16px;
      font-weight:700;
      text-align:center;
    }
    .job-mini-progress-bg{
      height:4px;
      background:rgba(255,255,255,0.1);
      border-radius:2px;
      overflow:hidden;
    }
    .job-mini-progress-fill{
      height:100%;
      border-radius:2px;
      background:#3b82f6;
      transition:width 0.3s ease;
    }
    .job-mini-progress-fill.complete{ background:#22c55e; }
    .job-complete-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
      padding:14px;
      margin-top:16px;
      border-radius:10px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }
    .job-completed-card,
    .job-voided-card{
      text-align:center;
      padding:40px 20px;
      border-radius:12px;
      margin-bottom:16px;
      border:1px solid rgba(255,255,255,0.1);
    }
    .job-completed-card{
      background:rgba(34,197,94,0.1);
      border-color:rgba(34,197,94,0.2);
    }
    .job-voided-card{
      background:rgba(239,68,68,0.1);
      border-color:rgba(239,68,68,0.2);
    }
    .job-completed-title,
    .job-voided-title{
      display:block;
      font-size:16px;
      font-weight:600;
      margin-bottom:6px;
    }
    .job-completed-title{ color:#22c55e; }
    .job-voided-title{ color:#ef4444; }
    .job-completed-text,
    .job-voided-text{
      font-size:13px;
      color:#64748b;
    }
    .job-completion-audit{
      background:rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:16px;
      margin-bottom:16px;
    }
    .job-audit-title{
      font-size:13px;
      font-weight:600;
      color:#e2e8f0;
      margin-bottom:10px;
    }
    .job-audit-section{
      margin-bottom:12px;
    }
    .job-audit-section:last-child{
      margin-bottom:0;
    }
    .job-audit-subtitle{
      font-size:10px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:#94a3b8;
      margin-bottom:6px;
    }
    .job-audit-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:8px;
    }
    .job-audit-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:6px 10px;
      background:rgba(0,0,0,0.25);
      border-radius:8px;
      font-size:12px;
      color:#e2e8f0;
    }
    .job-audit-item-name{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .job-audit-item-qty{
      font-variant-numeric:tabular-nums;
    }
    .job-audit-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:#94a3b8;
      padding:4px 2px;
    }
    .job-audit-empty{
      font-size:12px;
      color:#64748b;
      padding:8px 10px;
      background:rgba(0,0,0,0.2);
      border-radius:8px;
    }
    .job-audit-notes{
      font-size:12px;
      color:#cbd5f5;
      background:rgba(0,0,0,0.25);
      border-radius:8px;
      padding:8px 10px;
      line-height:1.4;
      white-space:pre-wrap;
    }
    .job-audit-hint{
      font-size:11px;
      color:#64748b;
      margin-top:8px;
    }
    .job-reopen-banner{
      background:rgba(245,158,11,0.08);
      border:1px solid rgba(245,158,11,0.2);
      color:#fbbf24;
      border-radius:10px;
      padding:10px 12px;
      font-size:12px;
      margin-bottom:12px;
    }
    .job-reopen-section{
      display:flex;
      justify-content:flex-end;
      margin-bottom:16px;
    }
    .job-reopen-btn{
      border-color:rgba(239,68,68,0.35);
      color:#f87171;
      background:rgba(239,68,68,0.08);
    }
    .job-reopen-btn:hover{
      background:rgba(239,68,68,0.16);
      border-color:rgba(239,68,68,0.45);
    }
    .job-danger-zone{
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid rgba(239,68,68,0.15);
    }
    .job-danger-zone-title{
      display:block;
      font-size:10px;
      font-weight:600;
      color:#ef4444;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:6px;
    }
    .job-danger-zone-desc{
      font-size:12px;
      color:#64748b;
      margin:0 0 10px 0;
    }
    .job-void-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      width:100%;
      padding:10px;
      border-radius:8px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
    }
    @media (max-width:640px){
      .job-field-row{ flex-direction:column; }
      .job-progress-stepper{ padding:12px; }
      .job-step-connector{ width:28px; }
    }

    /* =========================================================================
       UDWE: Universal Dynamic Width Engine Styles
       ========================================================================= */
    .udwe-table-wrap{
      width:100%;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    .udwe-table{
      width:100%;
      border-collapse:collapse;
      table-layout:fixed;
      font-size:13px;
    }
    .udwe-table th,
    .udwe-table td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .udwe-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:11px;
      white-space:nowrap;
    }
    .udwe-table th.num,
    .udwe-table td.num{
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    .udwe-table th.align-right,
    .udwe-table td.align-right{
      text-align:right;
    }
    .udwe-table td.truncatable{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .udwe-table .udwe-empty{
      text-align:center;
      color:var(--muted);
      padding:24px 12px;
      font-style:italic;
    }
    /* UDWE Mobile Card Layout */
    .udwe-cards{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .udwe-cards.udwe-empty{
      text-align:center;
      color:var(--muted);
      padding:24px 12px;
      font-style:italic;
    }
    .udwe-card{
      background:rgba(255,255,255,0.04);
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px 14px;
    }
    .udwe-card-primary{
      font-weight:700;
      font-size:14px;
      margin-bottom:8px;
      color:var(--fg);
    }
    .udwe-card-meta{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      padding:4px 0;
      font-size:13px;
    }
    .udwe-card-label{
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.04em;
      font-size:10px;
      font-weight:600;
    }
    .udwe-card-value{
      font-weight:600;
      color:var(--fg);
    }

    .job-bom-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    .job-bom-table th,
    .job-bom-table td{ padding:8px; border-bottom:1px solid var(--border); }
    .job-bom-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:11px;
    }
    .job-bom-table td.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:700;
    }
    .job-bom-shortfall{ color:#f97316; font-weight:800; }
    /* Job Item Picker */
    .job-item-picker-results{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .job-item-picker-row{
      display:flex;
      align-items:center;
      padding:10px 12px;
      background:rgba(255,255,255,0.04);
      border:1px solid var(--border);
      border-radius:8px;
      cursor:pointer;
      transition:background 0.15s, border-color 0.15s;
    }
    .job-item-picker-row:hover{
      background:rgba(96,165,250,0.12);
      border-color:rgba(96,165,250,0.4);
    }
    .job-item-picker-row.selected{
      background:rgba(96,165,250,0.18);
      border-color:rgba(96,165,250,0.6);
    }
    .job-item-picker-row .item-info{
      flex:1;
      min-width:0;
    }
    .job-item-picker-row .item-name{
      font-weight:600;
      color:var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .job-item-picker-row .item-sku{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .job-item-picker-row .item-desc{
      font-size:12px;
      color:#94a3b8;
      margin-top:4px;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .job-item-picker-row .item-qty{
      font-size:12px;
      color:var(--muted);
      margin-left:12px;
      white-space:nowrap;
      font-variant-numeric:tabular-nums;
    }
    .job-item-picker-row mark{
      background:rgba(250,204,21,0.35);
      color:inherit;
      padding:0 2px;
      border-radius:2px;
    }
    .job-item-picker-empty{
      padding:20px;
      text-align:center;
      color:var(--muted);
    }
    .job-warning{
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(251,146,60,0.45);
      background:rgba(251,146,60,0.12);
      color:#fbbf24;
      font-size:12px;
    }
    .job-actions-bar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    /* ============================================
       Add to Job Modal - Redesigned v2
       ============================================ */
    #addToJobModal .modal{
      background:linear-gradient(145deg, rgba(30, 35, 45, 0.95), rgba(20, 24, 32, 0.98));
      backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px);
      border:1px solid rgba(255, 255, 255, 0.08);
      border-radius:20px;
      max-width:480px;
      box-shadow:0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
      animation:atjModalIn 0.3s ease;
    }
    @keyframes atjModalIn{
      from{ opacity:0; transform:scale(0.95) translateY(10px); }
      to{ opacity:1; transform:scale(1) translateY(0); }
    }
    /* Item Card */
    .atj-item-card{
      margin:20px 24px 0;
      padding:16px;
      background:rgba(255,255,255,0.03);
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.06);
    }
    .atj-item-name{
      font-size:15px;
      font-weight:600;
      color:#f1f5f9;
      margin-bottom:4px;
    }
    .atj-item-desc{
      font-size:13px;
      color:#94a3b8;
      line-height:1.4;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .atj-item-sku{
      display:inline-flex;
      align-items:center;
      gap:6px;
      margin-top:10px;
      padding:5px 10px;
      background:rgba(255,255,255,0.05);
      border-radius:6px;
      font-size:12px;
      color:#64748b;
      font-family:"SF Mono",Monaco,monospace;
    }
    .atj-item-sku span{ color:#94a3b8; }
    /* Stats Row */
    .atj-stats-row{
      display:flex;
      gap:8px;
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    .atj-stat{
      flex:1;
      padding:10px 12px;
      background:rgba(255,255,255,0.03);
      border-radius:10px;
      text-align:center;
    }
    .atj-stat-value{
      font-size:18px;
      font-weight:700;
      color:#f1f5f9;
      letter-spacing:-0.02em;
      font-variant-numeric:tabular-nums;
    }
    .atj-stat-value.readonly-value{
      color:#64748b;
      font-style:italic;
    }
    .atj-stat-value.readonly-value.on-hand-good{ color:#22c55e; }
    .atj-stat-value.readonly-value.on-hand-low{ color:#fbbf24; }
    .atj-stat-value.readonly-value.on-hand-out{ color:#f87171; }
    .atj-stat-label{
      font-size:11px;
      font-weight:500;
      text-transform:uppercase;
      letter-spacing:0.04em;
      color:#64748b;
      margin-top:2px;
    }
    /* Tabs */
    .atj-tabs{ margin:20px 24px 0; }
    .atj-tabs-header{
      display:flex;
      gap:4px;
      padding:4px;
      background:rgba(255,255,255,0.04);
      border-radius:12px;
    }
    .atj-tab-btn{
      flex:1;
      padding:10px 16px;
      background:transparent;
      border:none;
      border-radius:9px;
      font-size:13px;
      font-weight:600;
      color:#64748b;
      cursor:pointer;
      transition:all 0.2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .atj-tab-btn:hover{ color:#94a3b8; }
    .atj-tab-btn.active{
      background:rgba(255,255,255,0.1);
      color:#f1f5f9;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    .atj-tab-btn svg{ width:16px; height:16px; }
    .atj-tab-content{ margin-top:16px; }
    .atj-tab-panel{
      display:none;
      animation:atjFadeIn 0.2s ease;
    }
    .atj-tab-panel.active{ display:block; }
    @keyframes atjFadeIn{
      from{ opacity:0; transform:translateY(4px); }
      to{ opacity:1; transform:translateY(0); }
    }
    /* Form fields */
    .atj-field{ margin-bottom:16px; }
    .atj-field:last-child{ margin-bottom:0; }
    .atj-label{
      display:block;
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#94a3b8;
      margin-bottom:8px;
    }
    .atj-label-optional{
      font-weight:400;
      text-transform:none;
      color:#64748b;
    }
    /* Dropdown */
    .atj-dropdown{ position:relative; }
    .atj-dropdown-trigger{
      width:100%;
      padding:14px 16px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:12px;
      color:#f1f5f9;
      font-size:14px;
      text-align:left;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:all 0.15s ease;
    }
    .atj-dropdown-trigger:hover{
      border-color:rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.06);
    }
    .atj-dropdown-trigger:focus{
      outline:none;
      border-color:#3b82f6;
      box-shadow:0 0 0 3px rgba(59,130,246,0.15);
    }
    .atj-dropdown-trigger .placeholder{ color:#64748b; }
    .atj-dropdown-trigger .chevron{ transition:transform 0.2s ease; }
    .atj-dropdown-trigger.open .chevron{ transform:rotate(180deg); }
    .atj-dropdown-menu{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      right:0;
      background:rgba(30,35,45,0.98);
      backdrop-filter:blur(20px);
      -webkit-backdrop-filter:blur(20px);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:14px;
      padding:6px;
      z-index:10;
      box-shadow:0 20px 40px -10px rgba(0,0,0,0.5);
      display:none;
      max-height:240px;
      overflow-y:auto;
    }
    .atj-dropdown-menu.open{
      display:block;
      animation:atjDropIn 0.15s ease;
    }
    @keyframes atjDropIn{
      from{ opacity:0; transform:translateY(-8px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .atj-dropdown-item{
      width:100%;
      padding:12px 14px;
      background:transparent;
      border:none;
      border-radius:10px;
      color:#e2e8f0;
      font-size:14px;
      text-align:left;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:background 0.15s ease;
    }
    .atj-dropdown-item:hover{ background:rgba(255,255,255,0.06); }
    .atj-dropdown-item.selected{ background:rgba(96,165,250,0.1); }
    .atj-dropdown-item .job-info{ display:flex; flex-direction:column; gap:2px; }
    .atj-dropdown-item .job-name{ font-weight:500; }
    .atj-dropdown-item .job-status{ font-size:12px; color:#64748b; }
    .atj-dropdown-item .job-status.draft{ color:#94a3b8; }
    .atj-dropdown-item .job-status.approved{ color:#34d399; }
    .atj-dropdown-item .job-status.in_progress{ color:#60a5fa; }
    .atj-dropdown-item .check-icon{ color:#60a5fa; display:none; }
    .atj-dropdown-item.selected .check-icon{ display:block; }
    .atj-dropdown-empty{
      padding:20px;
      text-align:center;
      color:#64748b;
      font-size:13px;
    }
    /* Text inputs */
    .atj-input{
      width:100%;
      padding:14px 16px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:12px;
      color:#f1f5f9;
      font-size:14px;
      outline:none;
      transition:all 0.15s ease;
    }
    .atj-input:hover{ border-color:rgba(255,255,255,0.2); }
    .atj-input:focus{
      border-color:#3b82f6;
      box-shadow:0 0 0 3px rgba(59,130,246,0.15);
    }
    .atj-input::placeholder{ color:#64748b; }
    .atj-textarea{
      width:100%;
      padding:14px 16px;
      background:rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:12px;
      color:#f1f5f9;
      font-size:14px;
      font-family:inherit;
      outline:none;
      transition:all 0.15s ease;
      resize:vertical;
      min-height:80px;
    }
    .atj-textarea:hover{ border-color:rgba(255,255,255,0.2); }
    .atj-textarea:focus{
      border-color:#3b82f6;
      box-shadow:0 0 0 3px rgba(59,130,246,0.15);
    }
    .atj-textarea::placeholder{ color:#64748b; }
    /* Quantity section */
    .atj-qty-section{
      padding:0 24px;
      margin-top:20px;
    }
    .atj-qty-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .atj-qty-label-group{ display:flex; flex-direction:column; gap:2px; }
    .atj-qty-main-label{ font-size:14px; font-weight:600; color:#f1f5f9; }
    .atj-qty-helper{ font-size:12px; color:#64748b; }
    .atj-qty-helper.warning{ color:#fbbf24; }
    .atj-qty-wrapper{
      display:flex;
      align-items:center;
      gap:2px;
      background:rgba(255,255,255,0.04);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.1);
      padding:4px;
    }
    .atj-qty-btn{
      width:40px;
      height:40px;
      border-radius:9px;
      border:none;
      background:rgba(255,255,255,0.06);
      color:#94a3b8;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
    }
    .atj-qty-btn:hover{ background:rgba(255,255,255,0.1); color:#e2e8f0; }
    .atj-qty-btn:active{ transform:scale(0.95); }
    .atj-qty-btn:disabled{ opacity:0.4; cursor:not-allowed; }
    .atj-qty-input{
      width:56px;
      height:40px;
      border:none;
      background:transparent;
      color:#f1f5f9;
      font-size:17px;
      font-weight:600;
      text-align:center;
      outline:none;
      -moz-appearance:textfield;
    }
    .atj-qty-input::-webkit-outer-spin-button,
    .atj-qty-input::-webkit-inner-spin-button{
      -webkit-appearance:none;
      margin:0;
    }
    /* Footer */
    .atj-footer{
      display:flex;
      gap:12px;
      padding:20px 24px 24px;
      margin-top:24px;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    .atj-cancel-btn{
      flex:1;
      padding:14px 20px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:12px;
      color:#94a3b8;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .atj-cancel-btn:hover{ background:rgba(255,255,255,0.08); color:#e2e8f0; }
    .atj-submit-btn{
      flex:1.5;
      padding:14px 20px;
      background:linear-gradient(135deg, #3b82f6, #2563eb);
      border:none;
      border-radius:12px;
      color:#ffffff;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      transition:all 0.15s ease;
      box-shadow:0 4px 12px rgba(59,130,246,0.3);
    }
    .atj-submit-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 6px 16px rgba(59,130,246,0.4);
    }
    .atj-submit-btn:active{ transform:translateY(0); }
    .atj-submit-btn:disabled{
      opacity:0.5;
      cursor:not-allowed;
      transform:none;
    }
    .atj-submit-btn svg{ width:16px; height:16px; }
    /* Message */
    .atj-message{
      display:none;
      padding:12px 16px;
      margin:0 24px 16px;
      font-size:13px;
      color:#64748b;
      background:rgba(255,255,255,0.03);
      border-radius:10px;
      text-align:center;
    }
    .atj-message.visible{ display:block; }
    .atj-message.error{ color:#f87171; background:rgba(248,113,113,0.1); }
    .atj-submit-btn .spinner{
      display:inline-block;
      width:16px;
      height:16px;
      border:2px solid rgba(255,255,255,0.3);
      border-top-color:#fff;
      border-radius:50%;
      animation:atjSpin 0.6s linear infinite;
      vertical-align:middle;
      margin-right:8px;
    }
    @keyframes atjSpin{
      to{ transform:rotate(360deg); }
    }
    /* Mobile responsive */
    @media (max-width:640px){
      .job-form-grid{ grid-template-columns:1fr; }
      .job-bom-add{ grid-template-columns:1fr; }
      .jobs-table th:nth-child(3),
      .jobs-table td:nth-child(3){ display:none; }
      #addToJobModal{
        align-items:center;
        justify-content:center;
        padding:calc(12px + env(safe-area-inset-top)) 12px calc(12px + env(safe-area-inset-bottom));
      }
      #addToJobModal .modal{
        width:100%;
        max-width:min(480px, 94vw);
        margin:0;
        border-radius:20px;
        max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
        max-height:calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      }
      .atj-item-card{ margin:16px 20px 0; padding:14px; }
      .atj-tabs{ margin:16px 20px 0; }
      .atj-qty-section{ padding:0 20px; }
      .atj-footer{ padding:16px 20px 20px; }
      .atj-stats-row{ gap:6px; }
      .atj-stat{ padding:8px 10px; }
      .atj-stat-value{ font-size:16px; }
    }
	    .drop{
	      border:1px dashed var(--border);border-radius:10px;padding:12px;text-align:center;color:var(--muted)
	    }
		    .totals{ display:flex; justify-content:center; align-items:center; gap:0; flex-wrap:wrap; margin:6px 0 4px; text-align:center; }
		    .totals > span{ white-space:nowrap; }
		    .totals > span + span::before{
		      content:'|';
		      display:inline-block;
		      margin:0 10px;
		      opacity:.65;
		    }
		    @media (max-width:520px){
		      .totals{ flex-wrap:nowrap; }
		      .totals > span{ font-size:11px; }
		      .totals > span + span::before{ margin:0 6px; }
		    }
		    @media (max-width:360px){
		      .totals > span{ font-size:10px; }
		      .totals > span + span::before{ margin:0 4px; }
		    }

    /* ============================================
       Inventory List Redesign - Glassmorphism
       ============================================ */

    /* ==================== CENTERED TABS ==================== */
    .inv-tabs-container{
      display:flex;
      justify-content:center;
      align-items:center;
      width:100%;
      margin-bottom:0;
    }
    .inv-header-tabs{
      display:inline-flex;
      gap:4px;
      background:rgba(0,0,0,0.3);
      border-radius:10px;
      padding:4px;
    }
    .inv-header-tab{
      display:flex;
      align-items:center;
      gap:6px;
      padding:8px 14px;
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:18px;
      font-weight:600;
      cursor:pointer;
      border-radius:8px;
      transition:all 0.2s ease;
    }
    .inv-header-tab:hover:not(.is-active){
      background:rgba(255,255,255,0.03);
      color:var(--fg);
    }
    .inv-header-tab.is-active{
      background:var(--card-elevated, #1a2332);
      color:var(--fg);
      box-shadow:0 2px 8px rgba(0,0,0,0.3);
    }
    .inv-header-tab svg{
      width:18px;
      height:18px;
    }

    /* ==================== TAB CONTENT ==================== */
    .inv-tab-content{
      max-height:0;
      overflow:hidden;
      padding:0 12px;
      background:rgba(0,0,0,0.2);
      border:1px solid transparent;
      border-radius:10px;
      margin-bottom:0;
      opacity:0;
      transition:all 0.25s ease;
    }
    .inv-tab-content.is-active{
      max-height:500px;
      padding:12px;
      border-color:rgba(255,255,255,0.06);
      margin-bottom:0;
      opacity:1;
      overflow-y:auto;
    }
    /* Layout tab opens as overlay so users can see impact on cards below */
    .inv-tab-content[data-inv-tab-content="layout"]{
      position:absolute;
      left:12px;
      right:12px;
      z-index:25;
      box-shadow:0 12px 40px rgba(0,0,0,0.5);
    }
    .inv-tab-content[data-inv-tab-content="layout"].is-active{
      max-height:calc(100vh - 280px);
    }

    /* Layout tab sections */
    .inv-layout-options{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
    }
    .inv-layout-group{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .inv-layout-group-label{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:var(--muted);
    }
    .inv-layout-toggle{
      display:flex;
      background:rgba(0,0,0,0.3);
      border-radius:6px;
      padding:3px;
    }
    .inv-layout-btn{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:5px;
      padding:6px 12px;
      border:none;
      background:transparent;
      color:var(--muted);
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      border-radius:6px;
      transition:all 0.15s;
    }
    .inv-layout-btn:hover:not(.is-active){
      background:rgba(255,255,255,0.05);
      color:var(--fg);
    }
    .inv-layout-btn.is-active{
      background:var(--card-elevated, #1a2332);
      color:var(--fg);
      box-shadow:0 2px 6px rgba(0,0,0,0.2);
    }
    .inv-layout-btn svg{
      width:16px;
      height:16px;
    }

    /* Column sorter section in layout tab */
    .inv-column-sorter{
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    .inv-column-sorter-header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      margin-bottom:10px;
    }
    .inv-column-sorter-hint{
      font-size:11px;
      color:var(--muted);
    }

    /* Row tap section */
    .inv-row-tap-section{
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    .inv-row-tap-options{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .inv-row-tap-option{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
      color:var(--fg);
      cursor:pointer;
      padding:8px 12px;
      border-radius:8px;
      transition:background 0.15s;
    }
    .inv-row-tap-option:hover{
      background:rgba(255,255,255,0.03);
    }

    /* Sort tab */
    .inv-sort-options{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .inv-sort-option{
      display:flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,0.03);
      color:var(--muted);
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      border-radius:6px;
      transition:all 0.15s;
    }
    .inv-sort-option:hover{
      border-color:rgba(255,255,255,0.2);
      color:var(--fg);
    }
    .inv-sort-option.is-active{
      border-color:var(--accent);
      background:rgba(59,130,246,0.15);
      color:#e0edff;
    }
    .inv-sort-option svg{
      width:14px;
      height:14px;
    }
    .inv-sort-direction{
      width:22px;
      height:22px;
      border-radius:4px;
      background:rgba(0,0,0,0.2);
      display:flex;
      align-items:center;
      justify-content:center;
      margin-left:auto;
    }
    .inv-sort-direction svg{
      width:12px;
      height:12px;
      transform-origin:center;
      transition:transform 0.15s ease;
    }
    .inv-sort-option.is-active .inv-sort-direction{
      background:rgba(59,130,246,0.3);
    }
    .inv-sort-option.is-desc .inv-sort-direction svg{
      transform:rotate(180deg);
    }

    /* Stats Row - flex layout, no wrap, equal width cards that shrink to fit */
    .inv-stats-row{
      display:flex;
      flex-wrap:nowrap;
      justify-content:center;
      gap:6px;
      width:100%;
      margin-top:25px;
      margin-bottom:4px;
    }
    @media (max-width:768px){
      .inv-stats-row{ margin-top:10px; }
    }
    .inv-stat-card{
      flex:1 1 0;
      min-width:0;
      max-width:110px;
      padding:6px 6px;
      background:rgba(0,0,0,0.2);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:8px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:1px;
      text-align:center;
      cursor:pointer;
      transition:all 0.15s;
      overflow:hidden;
    }
    .inv-stat-card:hover{
      border-color:rgba(255,255,255,0.1);
      background:rgba(0,0,0,0.25);
    }
    .inv-stat-card.is-active{
      border-color:rgba(59,130,246,0.4);
      background:rgba(59,130,246,0.08);
    }
    .inv-stat-value{
      font-size:22px;
      font-weight:700;
      font-variant-numeric:tabular-nums;
      line-height:1;
      color:var(--fg);
    }
    .inv-stat-value--green{ color:#22c55e; }
    .inv-stat-value--yellow{ color:#f59e0b; }
    .inv-stat-value--red{ color:#ef4444; }
    .inv-stat-value--muted{ color:#94a3b8; }
    .inv-stat-label{
      font-size:10px;
      font-weight:600;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }

    /* View Toggle */
    .inv-view-toggle{
      display:flex;
      gap:4px;
      background:rgba(26,31,38,0.8);
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      border-radius:10px;
      padding:4px;
      border:1px solid rgba(255,255,255,0.1);
    }
    .inv-view-btn{
      width:40px;
      height:40px;
      border-radius:8px;
      border:none;
      background:transparent;
      color:#64748b;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s ease;
    }
    .inv-view-btn:hover{ color:#94a3b8; }
    .inv-view-btn.is-active{
      background:rgba(34,197,94,0.15);
      color:#22c55e;
      box-shadow:0 0 12px rgba(34,197,94,0.2);
    }
    .inv-view-btn svg{ width:20px; height:20px; }

    /* Card Grid */
    .inv-card-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
      gap:10px;
    }
    .inv-card{
      background:linear-gradient(145deg, rgba(26,31,38,0.9) 0%, rgba(18,22,28,0.95) 100%);
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 4px 24px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05);
      padding:10px 12px;
      transition:all 0.2s ease;
      cursor:pointer;
    }
    .inv-card.order-selected{
      background:
        radial-gradient(220px 120px at 30% 25%, rgba(34,197,94,0.22), rgba(34,197,94,0) 70%),
        linear-gradient(145deg, rgba(18,28,22,0.92) 0%, rgba(16,22,20,0.97) 100%);
      border-color:rgba(34,197,94,0.45);
      box-shadow:
        0 0 0 1px rgba(34,197,94,0.35),
        0 12px 28px rgba(34,197,94,0.18),
        0 4px 24px rgba(0,0,0,0.4);
    }
    .inv-card.order-selected:hover{
      border-color:rgba(34,197,94,0.6);
      box-shadow:
        0 0 0 1px rgba(34,197,94,0.45),
        0 14px 30px rgba(34,197,94,0.22),
        0 6px 28px rgba(0,0,0,0.5);
    }
    .inv-card:hover{
      border-color:rgba(255,255,255,0.12);
      box-shadow:0 6px 28px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.08);
      transform:translateY(-1px);
    }
    .inv-card-header{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .inv-card-title{
      flex:1;
      margin:0;
      font-size:14px;
      font-weight:700;
      color:var(--fg);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .inv-card-actions{
      display:flex;
      gap:2px;
      opacity:0;
      transition:opacity 0.15s;
      pointer-events:none;
    }
    .inv-card:hover .inv-card-actions{ opacity:1; pointer-events:auto; }
    .inv-card-action-btn{
      width:28px;
      height:28px;
      border-radius:6px;
      border:none;
      background:rgba(255,255,255,0.05);
      color:#94a3b8;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s;
    }
    .inv-card-action-btn:hover{
      background:rgba(255,255,255,0.1);
      color:#fff;
    }
    .inv-card-action-btn:active{
      background:rgba(255,255,255,0.2);
      transform:scale(0.95);
    }
    .inv-card-action-btn svg{ width:14px; height:14px; }
    /* Larger touch targets on mobile */
    @media (hover:none), (max-width:768px){
      .inv-card-actions{ opacity:1; pointer-events:auto; gap:6px; }
      .inv-card-action-btn{ width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.08); }
      .inv-card-action-btn svg{ width:22px; height:22px; }
    }
    .inv-card-desc{
      margin:0 0 6px 0;
      font-size:12px;
      color:#94a3b8;
      line-height:1.3;
      display:-webkit-box;
      -webkit-line-clamp:1;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .inv-card-meta{
      display:flex;
      gap:12px;
      margin-bottom:8px;
      font-size:10px;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }
    .inv-card-footer{
      display:flex;
      align-items:center;
      gap:10px;
      padding-top:8px;
      border-top:1px solid rgba(255,255,255,0.06);
    }
    /* Dynamic card body - field-order aware */
    .inv-card-body{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:6px;
    }
    .inv-card-body:empty{ display:none; }
    .inv-card-field{
      display:flex;
      align-items:baseline;
      gap:6px;
      font-size:12px;
      line-height:1.3;
    }
    .inv-card-field-label{
      color:#64748b;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.3px;
      flex-shrink:0;
      min-width:50px;
    }
    .inv-card-field-value{
      color:#94a3b8;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .inv-card-field-value.is-desc{
      white-space:normal;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }
    /* Numeric field badges in footer */
    .inv-card-stats{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .inv-card-stat{
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:4px 10px;
      background:rgba(255,255,255,0.04);
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.06);
      min-width:50px;
    }
    .inv-card-stat-value{
      font-size:14px;
      font-weight:700;
      font-variant-numeric:tabular-nums;
      color:var(--fg);
    }
    .inv-card-stat-label{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:0.3px;
      color:#64748b;
    }
    .inv-card-stat--good{ background:rgba(34,197,94,0.1); border-color:rgba(34,197,94,0.2); }
    .inv-card-stat--good .inv-card-stat-value{ color:#22c55e; }
    .inv-card-stat--low{ background:rgba(245,158,11,0.1); border-color:rgba(245,158,11,0.2); }
    .inv-card-stat--low .inv-card-stat-value{ color:#f59e0b; }
    .inv-card-stat--out{ background:rgba(239,68,68,0.1); border-color:rgba(239,68,68,0.2); }
    .inv-card-stat--out .inv-card-stat-value{ color:#ef4444; }
    .inv-card-stat--reserved{ background:rgba(96,165,250,0.1); border-color:rgba(96,165,250,0.2); }
    .inv-card-stat--reserved .inv-card-stat-value{ color:#60a5fa; }
    .inv-card-stat--muted .inv-card-stat-value{ color:#94a3b8; }

    /* LED Status Indicator */
    .inv-led{
      display:inline-block;
      width:10px;
      height:10px;
      border-radius:50%;
      border:1px solid rgba(0,0,0,0.3);
      flex-shrink:0;
    }
    .inv-led--good{
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.5);
    }
    .inv-led--low{
      background:#f59e0b;
      box-shadow:0 0 8px rgba(245,158,11,0.5);
    }
    .inv-led--out{
      background:#ef4444;
      box-shadow:0 0 8px rgba(239,68,68,0.5);
    }

    /* Quantity Badge */
    .inv-qty-badge{
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:6px 12px;
      background:rgba(34,197,94,0.1);
      border-radius:8px;
      border:1px solid rgba(34,197,94,0.2);
    }
    .inv-qty-badge--low{
      background:rgba(245,158,11,0.1);
      border-color:rgba(245,158,11,0.2);
    }
    .inv-qty-badge--out{
      background:rgba(239,68,68,0.1);
      border-color:rgba(239,68,68,0.2);
    }
    .inv-qty-value{
      font-size:18px;
      font-weight:800;
      color:#22c55e;
      font-variant-numeric:tabular-nums;
      line-height:1;
    }
    .inv-qty-badge--low .inv-qty-value{ color:#f59e0b; }
    .inv-qty-badge--out .inv-qty-value{ color:#ef4444; }
    .inv-qty-label{
      font-size:9px;
      color:#94a3b8;
      text-transform:uppercase;
      margin-top:2px;
    }

    /* Reserved Badge */
    .inv-reserved-badge{
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:6px 10px;
    }
    .inv-reserved-value{
      font-size:16px;
      font-weight:700;
      color:#94a3b8;
      font-variant-numeric:tabular-nums;
      line-height:1;
    }
    .inv-reserved-label{
      font-size:9px;
      color:#64748b;
      text-transform:uppercase;
      margin-top:2px;
    }

    /* Status Badges */
    .inv-status-badge{
      margin-left:auto;
      padding:4px 8px;
      border-radius:5px;
      font-size:10px;
      font-weight:600;
    }
    .inv-status-badge--low{
      background:rgba(245,158,11,0.15);
      border:1px solid rgba(245,158,11,0.3);
      color:#f59e0b;
    }
    .inv-status-badge--out{
      background:rgba(239,68,68,0.15);
      border:1px solid rgba(239,68,68,0.3);
      color:#ef4444;
    }

    /* Table Container */
    .inv-table-container{
      background:rgba(26,31,38,0.7);
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 4px 24px rgba(0,0,0,0.4),inset 0 1px 0 rgba(255,255,255,0.05);
      overflow:hidden;
    }
    .inv-table-container table{
      width:100%;
      border-collapse:collapse;
    }
    .inv-table-container th{
      padding:14px 16px;
      text-align:left;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:#64748b;
      background:linear-gradient(180deg, rgba(26,31,38,0.95) 0%, rgba(18,22,28,0.9) 100%);
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .inv-table-container tr{
      cursor:pointer;
      transition:background 0.15s ease;
      border-left:3px solid transparent;
    }
    .inv-table-container tr:hover{
      background:rgba(59,130,246,0.05);
    }
    .inv-table-container tr.is-expanded{
      background:rgba(34,197,94,0.05);
      border-left-color:#22c55e;
    }
    .inv-table-container td{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,0.04);
      font-size:14px;
    }

    /* Floating Selection Bar */
    .inv-selection-bar{
      position:fixed;
      bottom:24px;
      left:50%;
      transform:translateX(-50%);
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 20px;
      background:rgba(34,197,94,0.15);
      backdrop-filter:blur(16px);
      -webkit-backdrop-filter:blur(16px);
      border-radius:14px;
      border:1px solid rgba(34,197,94,0.3);
      box-shadow:0 8px 32px rgba(0,0,0,0.4),0 0 24px rgba(34,197,94,0.15);
      z-index:100;
      animation:slideUp 0.2s ease-out;
    }
    @keyframes slideUp{
      from{ transform:translateX(-50%) translateY(20px); opacity:0; }
      to{ transform:translateX(-50%) translateY(0); opacity:1; }
    }
    .inv-selection-count{
      font-weight:600;
      color:#22c55e;
    }
    .inv-selection-action{
      padding:8px 16px;
      border-radius:8px;
      border:none;
      background:rgba(255,255,255,0.1);
      color:#fff;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      transition:background 0.15s;
    }
    .inv-selection-action:hover{
      background:rgba(255,255,255,0.15);
    }
    .inv-selection-clear{
      padding:8px 12px;
      border-radius:8px;
      border:none;
      background:transparent;
      color:#94a3b8;
      font-size:13px;
      cursor:pointer;
    }
    .inv-selection-clear:hover{
      color:#fff;
    }

    /* Enhanced filter pills styling */
    .inv-filter-pill.is-active{
      box-shadow:0 0 16px rgba(34,197,94,0.15);
    }

    /* Empty state */
    .inv-empty-state{
      text-align:center;
      padding:60px 20px;
      color:#64748b;
    }
    .inv-empty-state p{
      margin:0 0 12px;
    }
    .inv-reset-btn{
      padding:10px 20px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(26,31,38,0.8);
      color:var(--fg);
      font-size:14px;
      cursor:pointer;
      transition:all 0.15s;
    }
    .inv-reset-btn:hover{
      background:rgba(26,31,38,1);
      border-color:rgba(255,255,255,0.15);
    }

    /* Responsive adjustments for inventory redesign */
    @media (max-width:768px){
      .inv-tabs-container{ overflow-x:auto; -webkit-overflow-scrolling:touch; }
      .inv-header-tabs{ flex-shrink:0; }
      .inv-header-tab{ white-space:nowrap; font-size:16px; }
      .inv-layout-options{ flex-direction:column; }
      .inv-stats-row{ gap:4px; }
      .inv-stat-card{ padding:5px 4px; max-width:none; }
      .inv-stat-value{ font-size:18px; }
      .inv-stat-label{ font-size:9px; letter-spacing:0; }
    }
    @media (max-width:640px){
      .inv-stats-row{ gap:3px; }
      .inv-stat-card{ padding:4px 3px; }
      .inv-stat-value{ font-size:16px; }
      .inv-stat-label{ font-size:8px; }
      .inv-header-tab{ font-size:14px; padding:6px 10px; }
      .inv-card-grid{ grid-template-columns:1fr; }
      .inv-view-toggle{ display:flex; }
      .inv-view-btn{ width:36px; height:36px; }
      .inv-selection-bar{
        left:10px;
        right:10px;
        transform:none;
        bottom:calc(16px + env(safe-area-inset-bottom));
      }
      @keyframes slideUp{
        from{ transform:translateY(20px); opacity:0; }
        to{ transform:translateY(0); opacity:1; }
      }
      .order-pill-container{ top:var(--inventory-sticky-offset, 150px); }
    }
    @media (max-width:400px){
      .inv-stats-row{ gap:2px; }
      .inv-stat-card{ padding:3px 2px; }
      .inv-stat-value{ font-size:14px; }
      .inv-stat-label{ font-size:7px; }
      .inv-header-tab{ font-size:13px; padding:5px 8px; }
    }

	    @media (max-width:640px){
	      .toolbar{gap:6px}
	      .toolbar .btn-primary,
	      .toolbar .btn-secondary,
	      .toolbar .btn-tertiary{flex:1}
	    }
    /* no right-side logo anymore */
    @media (max-width:360px){ .toolbar{gap:4px} }
  
    @media (max-width: 480px){
      header{ padding: calc(8px + env(safe-area-inset-top)) 12px 6px; }
      .header-inner{ padding: 0 12px; }
      .brandrow{ gap:8px }
      .title-logo{ width:min(300px, 76vw); height:auto; }
      .header-company-name{ font-size:12px; max-width:140px; }
      .header-notices{ padding:0 8px 6px; min-height:24px; }
      .modal-backdrop{ padding:calc(10px + env(safe-area-inset-top)) 10px calc(10px + env(safe-area-inset-bottom)); }
      .order-header{ padding:12px; }
      .order-body{ padding:10px 12px 12px; }
      .order-footer{ padding:10px 12px calc(10px + env(safe-area-inset-bottom)); }
      .order-footer{ display:grid; grid-template-columns:1fr 1fr; }
      .order-footer .order-send{ grid-column:1 / -1; }
      .order-recipient{ flex-direction:column; align-items:stretch; }
      .order-recipient input[type=email]{ min-width:0; }
    }

    /* Hamburger Menu Styles */
    .hamburger-menu{
      position:relative;
      z-index:25;
    }
    .hamburger-btn{
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      width:40px;
      height:40px;
      padding:6px;
      gap:5px;
    }
    .hamburger-btn span{
      display:block;
      width:22px;
      height:2px;
      background:currentColor;
      border-radius:2px;
      transition:transform 0.2s, opacity 0.2s;
    }
    .hamburger-btn.open span:nth-child(1){
      transform:translateY(7px) rotate(45deg);
    }
    .hamburger-btn.open span:nth-child(2){
      opacity:0;
    }
    .hamburger-btn.open span:nth-child(3){
      transform:translateY(-7px) rotate(-45deg);
    }
    .menu-panel{
      width:min(360px, calc(100vw - 24px));
      background:rgba(15,20,28,0.92);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,0.55);
      -webkit-backdrop-filter: blur(18px);
      backdrop-filter: blur(18px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      max-height:calc(100vh - 120px);
    }
    .menu-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .menu-title{
      font-size:16px;
      font-weight:600;
      color:#ffffff;
    }
    .menu-close{
      width:32px;
      height:32px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.05);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#666;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .menu-close svg{ width:16px; height:16px; }
    .menu-close:hover{ background:rgba(255,255,255,0.1); color:#999; }
    .menu-quick-actions{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:8px;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .menu-quick-btn{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(99,179,237,0.2);
      background:linear-gradient(135deg, rgba(99,179,237,0.15), rgba(99,179,237,0.05));
      color:#7dd3fc;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .menu-quick-btn .menu-icon-svg{
      width:18px;
      height:18px;
      flex-shrink:0;
    }
    .menu-quick-btn:hover{
      background:rgba(99,179,237,0.25);
      border-color:rgba(99,179,237,0.3);
    }
    .menu-tabs{
      display:flex;
      gap:4px;
      padding:0 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .menu-tab{
      flex:1;
      padding:12px 8px;
      font-size:12px;
      font-weight:500;
      color:#666;
      background:transparent;
      border:0;
      border-bottom:2px solid transparent;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .menu-tab:hover{ color:#999; }
    .menu-tab.is-active{
      color:#7dd3fc;
      border-bottom-color:#7dd3fc;
    }
    .menu-tab-panels{
      padding:6px 0 10px;
      overflow:auto;
      flex:1;
    }
    .menu-tab-panel{
      display:none;
      padding:4px 6px;
      opacity:0;
      transform:translateY(4px);
      transition:opacity 0.15s ease, transform 0.15s ease;
    }
    .menu-tab-panel.is-active{
      display:block;
      opacity:1;
      transform:translateY(0);
    }
    .menu-tab-panel.is-leaving{
      opacity:0;
      transform:translateY(4px);
    }
    .menu-section-label{
      padding:10px 14px 6px;
      font-size:10px;
      font-weight:600;
      letter-spacing:1px;
      text-transform:uppercase;
      color:#555;
    }
    .menu-item{
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      background:transparent;
      border:0;
      font-size:14px;
      color:#bbb;
      text-align:left;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .menu-item:hover{
      background:rgba(255,255,255,0.06);
      color:#fff;
    }
    .menu-item:disabled,
    .menu-quick-btn:disabled{
      opacity:0.45;
      cursor:not-allowed;
      pointer-events:none;
    }
    .menu-item .menu-icon-svg{
      width:18px;
      height:18px;
      color:#666;
      flex-shrink:0;
    }
    .menu-item:hover .menu-icon-svg{ color:#888; }
    .menu-item--danger{
      color:#ef4444;
    }
    .menu-item--danger .menu-icon-svg{ color:#ef4444; }
    .menu-item--danger:hover{ background:rgba(239,68,68,0.1); }
    .menu-item-badges{
      margin-left:auto;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
      flex-wrap:wrap;
    }
    .menu-item-badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:600;
      letter-spacing:0.2px;
      border:1px solid transparent;
      cursor:pointer;
      transition:transform 0.15s ease, box-shadow 0.15s ease;
    }
    .menu-item-badge:hover{
      transform:translateY(-1px);
    }
    .menu-item-badge-label{
      opacity:0.75;
      font-weight:600;
    }
    .menu-item-badge-value{
      font-weight:700;
    }
    .menu-item-badge--accent{
      color:#7dd3fc;
      background:rgba(56,189,248,0.18);
      border-color:rgba(56,189,248,0.35);
    }
    .menu-item-badge--muted{
      color:#94a3b8;
      background:rgba(148,163,184,0.16);
      border-color:rgba(148,163,184,0.32);
    }
    .menu-item-badge--warning{
      color:#f59e0b;
      background:rgba(245,158,11,0.18);
      border-color:rgba(245,158,11,0.36);
    }
    .menu-item-badge--success{
      color:#22c55e;
      background:rgba(34,197,94,0.18);
      border-color:rgba(34,197,94,0.36);
    }
    .menu-item-badge--info{
      color:#93c5fd;
      background:rgba(147,197,253,0.18);
      border-color:rgba(147,197,253,0.35);
    }
    .menu-divider{
      height:1px;
      background:rgba(255,255,255,0.06);
      margin:6px 12px;
    }
    .header-row{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
      gap:12px;
    }
    .header-left{
      grid-column:2;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      gap:12px;
      min-width:0;
    }
    /* Toast overlay zone - sits on top of logo */
    .header-toast-zone{
      position:absolute;
      inset:0;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      pointer-events:none;
      opacity:0;
      transition:opacity 200ms ease;
    }
    .header-toast-zone.is-visible{
      opacity:1;
      pointer-events:auto;
    }
    .header-toast-zone::before{
      content:'';
      position:absolute;
      inset:-40px -80px;
      background:radial-gradient(ellipse at center, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 35%, rgba(0,0,0,0.4) 60%, rgba(0,0,0,0) 80%);
      filter:blur(12px);
    }
    .header-toast-zone .toast,
    .header-toast-zone .order-pill-container,
    .header-toast-zone .cart-feedback-toast{
      position:relative;
      z-index:1;
    }
    .header-company-name{
      font-family:'Poppins', sans-serif;
      font-size:15px;
      font-weight:500;
      letter-spacing:0.02em;
      color:#fff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:280px;
      opacity:0.95;
    }
    .header-right{
      grid-column:3;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      justify-self:end;
      gap:4px;
    }
    .header-icons{
      display:flex;
      align-items:center;
      gap:8px;
    }
    /* Main app order pill - in header notifications zone */
    .order-pill-container{
      position:relative;
      z-index:1;
      display:flex;
      justify-content:center;
      padding:0;
      margin:0;
      background:transparent;
    }
    .order-pill{
      width:auto;
      max-width:400px;
      display:flex;
      align-items:center;
      gap:14px;
      background:linear-gradient(135deg, #1e3a5f 0%, #1e40af 100%);
      border:1px solid rgba(96,165,250,0.35);
      color:#eff6ff;
      font-weight:600;
      padding:12px 14px 12px 18px;
      border-radius:12px;
      box-shadow:0 10px 40px rgba(0,0,0,0.4), 0 2px 8px rgba(0,0,0,0.2);
      animation:toastSlideIn 0.3s cubic-bezier(0.21,1.02,0.73,1);
    }
    .order-pill-icon{
      width:24px;
      height:24px;
      color:#60a5fa;
      flex-shrink:0;
    }
    .order-pill-icon svg{
      width:24px;
      height:24px;
    }
    .order-pill-text{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .order-pill-value{
      font-size:18px;
      font-weight:700;
      color:#fff;
    }
    .order-pill-label{
      font-size:14px;
      font-weight:500;
      color:#bfdbfe;
    }
    .order-pill-actions{
      display:flex;
      gap:8px;
      margin-left:4px;
    }
    .order-pill-btn{
      width:36px;
      height:36px;
      border-radius:10px;
      border:none;
      background:rgba(255,255,255,0.12);
      color:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:all 0.15s;
    }
    .order-pill-btn svg{
      width:20px;
      height:20px;
    }
    .order-pill-btn:hover{
      background:rgba(255,255,255,0.22);
      transform:translateY(-1px);
    }
    .order-pill-btn:active{
      transform:scale(0.95);
      background:rgba(255,255,255,0.28);
    }
    .order-pill-btn--clear{
      background:rgba(239,68,68,0.2);
      color:#fca5a5;
    }
    .order-pill-btn--clear:hover{
      background:rgba(239,68,68,0.35);
    }
    .receipts-pill-container{
      position:relative;
      top:auto;
      z-index:1;
      display:flex;
      justify-content:center;
      padding:0;
      margin:4px 0 2px;
    }
    .receipts-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      border:none;
      border-radius:14px;
      padding:10px 16px;
      background:rgba(251,146,60,0.18);
      border:1px solid rgba(251,146,60,0.45);
      color:#fff7ed;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 0 0 1px rgba(251,146,60,0.12), 0 10px 24px rgba(0,0,0,0.35);
      transition:transform 0.15s, box-shadow 0.15s, background 0.15s;
    }
    .receipts-pill:hover{
      background:rgba(251,146,60,0.28);
      transform:translateY(-1px);
    }
    .receipts-pill:active{
      transform:translateY(0);
    }
    .receipts-pill-icon{
      width:18px;
      height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .receipts-pill-label{
      font-size:14px;
      letter-spacing:0.01em;
    }
    .menu-backdrop,
    .profile-backdrop{
      display:none;
      position:fixed;
      inset:0;
      z-index:40;
      align-items:flex-start;
      justify-content:flex-end;
      padding:calc(56px + env(safe-area-inset-top)) 16px 16px;
      background:rgba(0,0,0,0.55);
      -webkit-backdrop-filter:blur(8px);
      backdrop-filter:blur(8px);
    }
    .menu-backdrop.open,
    .profile-backdrop.open{
      display:flex;
    }
    .profile-backdrop{
      z-index:39;
      align-items:flex-start;
      justify-content:flex-end;
      padding:0;
    }
    @media (max-width: 520px){
      .menu-backdrop{
        padding:calc(24px + env(safe-area-inset-top)) 10px 14px;
      }
      .menu-panel{
        width:100%;
        max-height:calc(100vh - 80px);
      }
    }
    /* Profile dropdown */
    .profile-menu{
      position:relative;
    }
    .profile-btn{
      border-radius:999px;
      position:relative;
    }
    .profile-status{
      position:absolute;bottom:6px;right:6px;width:10px;height:10px;
      border-radius:50%;border:2px solid var(--bg);
      background:#6b7280;
    }
    .profile-status.online{background:#22c55e}
    .profile-status.offline{background:#ef4444}
    .profile-status.warning{background:#f59e0b}
    .profile-dropdown{
      position:absolute;top:100%;right:0;margin-top:8px;
      background:rgba(15,18,24,0.92);
      border:1px solid var(--border);
      border-radius:14px;
      min-width:280px;
      width:min(360px, 92vw);
      padding:0;
      z-index:45;
      box-shadow:0 18px 40px rgba(0,0,0,0.45);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:none;
    }
    .profile-dropdown.open{display:block}
    .profile-panel-header{
      padding:14px 16px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .profile-email{font-weight:600;font-size:14px;color:var(--fg);word-break:break-all}
    .profile-company-name{font-size:12px;color:var(--muted)}
    .profile-badges{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .env-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      border:1px solid transparent;
      color:#0c1220;
      background:#9fb3c8;
      white-space:nowrap;
    }
    .env-badge.env-production{background:rgba(148,163,184,0.2);color:#cbd5f5;border-color:rgba(148,163,184,0.4)}
    .env-badge.env-test{background:rgba(167,139,250,0.2);color:#e9d5ff;border-color:rgba(167,139,250,0.45)}
    .profile-env-badge{
      padding:3px 8px;
      border-radius:6px;
      font-size:10px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }
    .profile-env-badge.hidden{display:none}
    .profile-env-note{
      font-size:11px;
      color:var(--muted);
      line-height:1.4;
    }
    .profile-role-badge{
      padding:4px 10px;
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      background:rgba(139,92,246,0.2);
      border:1px solid rgba(139,92,246,0.3);
      color:#a78bfa;
      letter-spacing:0.08em;
    }
    .profile-tabbar{
      display:flex;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .profile-tab{
      flex:1 1 0;
      padding:10px 12px;
      font-size:12px;
      font-weight:500;
      color:#666;
      background:transparent;
      border:0;
      border-bottom:2px solid transparent;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .profile-tab:hover{ color:#999; }
    .profile-tab.is-active{
      color:#7dd3fc;
      border-bottom-color:#7dd3fc;
    }
    .profile-panels{
      position:relative;
    }
    .profile-panel{
      display:none;
      padding:6px;
      opacity:0;
      transform:translateY(6px);
      transition:opacity 0.15s ease, transform 0.15s ease;
    }
    .profile-panel.is-active{
      display:block;
      opacity:1;
      transform:translateY(0);
    }
    .profile-panel.is-leaving{
      opacity:0;
      transform:translateY(6px);
    }
    .profile-item{
      width:100%;
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      border-radius:10px;
      background:transparent;
      border:0;
      cursor:pointer;
      color:#bbb;
      font-size:14px;
      text-align:left;
      transition:all 0.15s ease;
    }
    .profile-item:hover{
      background:rgba(255,255,255,0.06);
      color:#fff;
    }
    .profile-item-icon{
      width:18px;
      height:18px;
      color:#666;
      flex-shrink:0;
      transition:color 0.15s ease;
    }
    .profile-item:hover .profile-item-icon{ color:#888; }
    .profile-item--danger{
      color:#ef4444;
    }
    .profile-item--danger .profile-item-icon{ color:#ef4444; }
    .profile-item--danger:hover{
      background:rgba(239,68,68,0.1);
      color:#ef4444;
    }
    .profile-divider{
      height:1px;
      background:rgba(255,255,255,0.06);
      margin:8px 12px;
    }
    .profile-item-badge{
      margin-left:auto;
      padding:2px 7px;
      border-radius:10px;
      font-size:11px;
      font-weight:600;
      color:#7dd3fc;
      background:rgba(99,179,237,0.2);
    }
    .profile-empty{
      padding:8px 12px 10px;
      font-size:12px;
      color:var(--muted);
    }
    /* Testing Banner - appears when emulating a non-super_user role */
    .testing-banner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px;
      background:rgba(245,158,11,0.15);
      border-bottom:1px solid rgba(245,158,11,0.3);
      animation:testingBannerSlideDown 200ms ease;
    }
    @keyframes testingBannerSlideDown{
      from{ opacity:0; transform:translateY(-10px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .testing-banner-content{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      color:#f59e0b;
    }
    .testing-banner-content svg{
      width:16px;
      height:16px;
      flex-shrink:0;
    }
    .testing-banner-content strong{
      text-transform:capitalize;
    }
    .testing-banner-hint{
      font-size:11px;
      opacity:0.7;
      margin-left:8px;
    }
    .exit-testing-btn{
      padding:6px 12px;
      border-radius:6px;
      border:1px solid rgba(245,158,11,0.4);
      background:rgba(245,158,11,0.2);
      color:#f59e0b;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:background 0.15s ease;
    }
    .exit-testing-btn:hover{
      background:rgba(245,158,11,0.3);
    }

    /* Role Switcher Section - below header, above tabs */
    .role-switcher-section{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background:rgba(0,0,0,0.2);
    }
    .role-switcher-label{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:11px;
      font-weight:600;
      color:#64748b;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:10px;
    }
    .role-switcher-label svg{
      width:14px;
      height:14px;
    }
    .role-pills{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .role-pill{
      padding:8px 14px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.1);
      background:rgba(26,31,38,0.6);
      color:#94a3b8;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      text-transform:capitalize;
      transition:all 0.15s ease;
    }
    .role-pill:hover{
      background:rgba(255,255,255,0.05);
      border-color:rgba(255,255,255,0.15);
    }
    .role-pill.is-active{
      background:rgba(99,102,241,0.2);
      border-color:rgba(99,102,241,0.5);
      color:#a5b4fc;
      box-shadow:0 0 12px rgba(99,102,241,0.2);
    }
    @media (max-width: 400px){
      .role-pills{
        gap:4px;
      }
      .role-pill{
        padding:6px 10px;
        font-size:12px;
      }
      .testing-banner{
        padding:8px 12px;
        flex-wrap:wrap;
        gap:8px;
      }
      .testing-banner-hint{
        display:none;
      }
    }

    .manage-companies-modal .modal-header{
      padding:16px 24px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background:rgba(18,24,32,0.7);
      backdrop-filter: blur(10px);
    }
    .manage-companies-header-meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }
    .manage-companies-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      background:rgba(99,102,241,0.2);
      color:#c7d2fe;
      border:1px solid rgba(99,102,241,0.4);
    }
    .manage-companies-filters{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:flex-end;
    }
    .manage-companies-filters .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1 1 220px;
    }
    .manage-companies-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-top:10px;
    }
    .manage-companies-menu{
      position:relative;
    }
    .manage-companies-menu-dropdown{
      display:none;
      position:absolute;
      top:100%;
      right:0;
      margin-top:4px;
      min-width:200px;
      background:rgba(18,24,32,0.98);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:12px;
      padding:6px;
      box-shadow:0 8px 32px rgba(0,0,0,0.4);
      z-index:100;
    }
    .manage-companies-menu.is-open .manage-companies-menu-dropdown{
      display:block;
    }
    .manage-companies-menu-item{
      display:flex;
      align-items:center;
      gap:10px;
      width:100%;
      padding:10px 12px;
      border:none;
      border-radius:8px;
      background:transparent;
      color:var(--fg);
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      text-align:left;
      transition:background 120ms ease;
    }
    .manage-companies-menu-item:hover{
      background:rgba(255,255,255,0.08);
    }
    .manage-companies-menu-item svg{
      width:16px;
      height:16px;
      flex-shrink:0;
      opacity:0.7;
    }
    .seed-options-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .seed-field-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .seed-field-option{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(18,24,32,0.6);
    }
    .seed-field-option input{
      margin-top:2px;
      width:16px;
      height:16px;
    }
    .seed-field-option label{
      display:flex;
      flex-direction:column;
      gap:2px;
      cursor:pointer;
    }
    .seed-field-option.is-locked{
      opacity:0.6;
    }
    .seed-field-title{
      font-weight:600;
      font-size:13px;
    }
    .seed-field-note{
      font-size:12px;
      color:var(--muted);
    }
    .btn-outline-success{
      background:transparent;
      border:1px solid rgba(34,197,94,0.45);
      color:#6ee7b7;
      box-shadow:0 0 0 1px rgba(34,197,94,0.08) inset;
    }
    .btn-outline-success:hover{
      background:rgba(34,197,94,0.12);
      border-color:rgba(34,197,94,0.6);
      color:#34d399;
    }
    .manage-companies-modal{
      width:96vw;
      max-width:min(800px, 96vw);
    }
    .manage-companies-results{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      max-height:340px;
      overflow-y:auto;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      background:#121820;
      --inventory-sticky-offset:0px;
    }
    .manage-companies-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      table-layout:auto;
      min-width:980px;
    }
    .manage-companies-table th,.manage-companies-table td{
      text-align:left;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
      word-break:normal;
      white-space:nowrap;
    }
    .manage-companies-table td:first-child{
      white-space:normal;
    }
    .manage-companies-table th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:var(--muted);
    }
    .manage-companies-table thead th{
      position:sticky;
      top:0;
      z-index:3;
      background:#121820;
    }
    .manage-companies-table .col-members,
    .manage-companies-table .col-inventory{
      text-align:center;
    }
    .manage-companies-table .inv-positive{
      color:var(--action-primary);
    }
    .manage-companies-table tr.is-current{
      background:rgba(88,166,255,0.05);
    }
    .manage-companies-table tr.is-current td:first-child{
      border-left:3px solid var(--action-primary);
    }
    .manage-companies-name{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:nowrap;
      font-weight:600;
      min-width:0;
    }
    .manage-companies-name span{
      min-width:0;
      display:inline-block;
      max-width:240px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .manage-companies-current{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      border-radius:8px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      background:rgba(88,166,255,0.2);
      color:#93c5fd;
    }
    .company-id-copy{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
      background:transparent;
      border:none;
      padding:0;
      cursor:pointer;
    }
    .company-id-copy:hover{ color:#cbd5f5; }
    .modal-header-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .manage-companies-table .col-active{
      width:70px;
      text-align:center;
    }
    .manage-companies-table .col-envtype{
      width:110px;
    }
    .manage-companies-table .col-age,
    .manage-companies-table .col-jobs,
    .manage-companies-table .col-pos{
      width:80px;
      text-align:right;
    }
    .manage-companies-name .env-badge{
      font-size:9px;
    }
    .manage-companies-table .col-row-menu{
      width:48px;
      text-align:center;
    }
    .manage-companies-table .col-row-menu .company-overflow-btn{
      opacity:0;
      transition:opacity 150ms ease;
    }
    .manage-companies-table tr:hover .col-row-menu .company-overflow-btn,
    .manage-companies-table .col-row-menu .company-overflow.open .company-overflow-btn{
      opacity:1;
    }
    /* Toggle switch */
    .company-toggle{
      display:inline-flex;
      align-items:center;
      cursor:pointer;
    }
    .company-toggle input{
      position:absolute;
      opacity:0;
      width:0;
      height:0;
    }
    .company-toggle-track{
      position:relative;
      width:40px;
      height:22px;
      background:rgba(255,255,255,0.12);
      border-radius:999px;
      transition:background 200ms ease;
    }
    .company-toggle-thumb{
      position:absolute;
      top:2px;
      left:2px;
      width:18px;
      height:18px;
      background:#6b7280;
      border-radius:50%;
      transition:transform 200ms ease, background 200ms ease;
    }
    .company-toggle input:checked + .company-toggle-track{
      background:rgba(34,197,94,0.25);
    }
    .company-toggle input:checked + .company-toggle-track .company-toggle-thumb{
      transform:translateX(18px);
      background:#22c55e;
    }
    .company-toggle input:disabled + .company-toggle-track{
      opacity:0.7;
      cursor:default;
    }
    .company-toggle input:focus-visible + .company-toggle-track{
      outline:2px solid var(--action-primary);
      outline-offset:2px;
    }
    .company-overflow{
      position:relative;
    }
    .company-overflow-btn{
      width:32px;
      height:32px;
    }
    .company-overflow-menu{
      position:fixed;
      min-width:190px;
      background:#121820;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:8px;
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
      display:none;
      z-index:9999;
    }
    .company-overflow.open .company-overflow-menu{ display:block; }
    .company-overflow-section{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      padding:6px 8px 4px;
    }
    .company-overflow-item{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:10px;
      background:transparent;
      border:1px solid transparent;
      color:#d1d5db;
      font-size:13px;
      cursor:pointer;
      text-align:left;
    }
    .company-overflow-item:hover{
      background:rgba(255,255,255,0.06);
      color:#fff;
    }
    .company-overflow-item.danger{
      color:var(--action-danger);
    }
    .company-overflow-item.danger:hover{
      background:rgba(248,81,73,0.1);
      color:var(--action-danger);
    }
    .manage-companies-hint{margin-top:6px;font-size:12px;color:var(--muted)}
    .manage-companies-table tfoot .summary-row{
      background:rgba(88,166,255,0.08);
      border-top:2px solid rgba(88,166,255,0.2);
    }
    .manage-companies-table tfoot .summary-row td{
      padding:12px;
      font-size:12px;
      color:var(--fg);
    }
    .manage-companies-table tfoot .summary-row strong{
      color:#93c5fd;
    }
    /* Manage sub-modals (Users/Inventory) */
    .manage-sub-modal{
      width:96vw;
      max-width:800px;
    }
    .manage-sub-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:10px 0;
      border-bottom:1px solid var(--border);
      margin-bottom:10px;
    }
    .manage-sub-toolbar-left{
      display:flex;
      align-items:center;
      gap:16px;
      flex:1;
    }
    .manage-sub-search{
      flex:0 1 220px;
      min-width:140px;
    }
    .manage-sub-select-all{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
      white-space:nowrap;
    }
    .manage-sub-select-all input{
      width:16px;
      height:16px;
      cursor:pointer;
    }
    .manage-sub-select-all:hover{
      color:var(--fg);
    }
    .manage-sub-results{
      max-height:340px;
      overflow-y:auto;
      border:1px solid var(--border);
      border-radius:10px;
      background:#121820;
    }
    .manage-sub-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .manage-sub-table th,
    .manage-sub-table td{
      text-align:left;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    .manage-sub-table th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:var(--muted);
      background:rgba(18,24,32,0.5);
      position:sticky;
      top:0;
      z-index:1;
    }
    .manage-sub-table tbody tr:hover{
      background:rgba(255,255,255,0.03);
    }
    .manage-sub-table .col-check{
      width:40px;
      text-align:center;
    }
    .manage-sub-table .col-check input{
      width:16px;
      height:16px;
      cursor:pointer;
    }
    .manage-sub-table .col-role,
    .manage-sub-table .col-qty{
      width:90px;
      text-align:center;
    }
    .manage-sub-table .col-date{
      width:110px;
    }
    .manage-sub-table .col-sku{
      width:100px;
    }
    .manage-sub-table tr.is-selected{
      background:rgba(248,81,73,0.08);
    }
    .manage-sub-hint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
    }
    .btn-danger{
      background:rgba(248,81,73,0.15);
      color:var(--action-danger);
      border:1px solid rgba(248,81,73,0.3);
      padding:6px 14px;
      border-radius:8px;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      transition:background 150ms ease, border-color 150ms ease;
    }
    .btn-danger:hover:not(:disabled){
      background:rgba(248,81,73,0.25);
      border-color:rgba(248,81,73,0.5);
    }
    .btn-danger:disabled{
      opacity:0.5;
      cursor:not-allowed;
    }
    .btn-sm{
      padding:5px 12px;
      font-size:12px;
    }
    .manage-sub-empty{
      padding:40px 20px;
      text-align:center;
      color:var(--muted);
    }
    @media (max-width: 600px){
      .manage-sub-toolbar{
        flex-direction:column;
        align-items:stretch;
        gap:10px;
      }
      .manage-sub-toolbar-left{
        flex-direction:column;
        align-items:stretch;
      }
      .manage-sub-search{
        flex:1;
        width:100%;
      }
    }
    @media (max-width: 768px){
      .manage-companies-filters{flex-direction:column;align-items:stretch;}
      .manage-companies-table .col-members{display:none;}
      .manage-companies-table th.col-members{display:none;}
      .manage-companies-table .col-row-menu .company-overflow-btn{
        opacity:1;
      }
    }
    .advanced-switcher-controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .advanced-switcher-controls .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .advanced-switcher-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-top:8px;
    }
    .advanced-switcher-results{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      max-height:320px;
      overflow:auto;
      background:#121820;
    }
    .advanced-switcher-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .advanced-switcher-table th,.advanced-switcher-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    .advanced-switcher-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .advanced-switcher-id{font-size:11px;color:var(--muted);word-break:break-all}
    .advanced-switcher-row-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .advanced-switcher-row-actions .btn-tertiary{white-space:nowrap;}
    .advanced-switcher-hint{margin-top:6px;font-size:12px;color:var(--muted)}
    #advancedCompanyModal.company-switcher-basic .advanced-switcher-controls,
    #advancedCompanyModal.company-switcher-basic .advanced-switcher-actions{
      display:none;
    }
    .diag-section{margin-top:10px}
    .diag-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px}
    .diag-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .diag-table th,.diag-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    .diag-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .diag-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .diag-badge.pass{background:#12361f;color:#9ff5bf;border-color:#1b5d35}
    .diag-badge.fail{background:#3a1515;color:#ffb4b4;border-color:#7a1f1f}
    .diag-output{
      margin-top:8px;
      background:#0f141b;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      font-size:12px;
      color:#dbe5f0;
      max-height:240px;
      overflow:auto;
      white-space:pre-wrap;
    }
    @media (max-width: 720px){
      .advanced-switcher-controls{
        grid-template-columns:1fr;
      }
      .advanced-switcher-actions{
        justify-content:flex-start;
      }
    }
    .profile-dropdown .menu-item{
      display:flex;align-items:center;gap:10px;width:100%;
      padding:12px 16px;border:none;background:transparent;
      color:var(--fg);font-size:14px;font-weight:500;
      text-align:left;cursor:pointer;transition:background 0.15s;
    }
    .profile-dropdown .menu-item:hover{background:rgba(255,255,255,0.06)}
    .profile-dropdown .menu-item:disabled{opacity:0.45;cursor:not-allowed}
    .profile-dropdown .menu-item:disabled:hover{background:transparent}
    .profile-meta{padding:10px 16px;border-top:1px solid var(--border);margin-top:8px}
    .profile-meta .time{font-size:11px;color:var(--muted)}
    .profile-company{
      padding:10px 16px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .profile-company-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .profile-company select{
      padding:8px 10px;
      font-size:13px;
      border-radius:8px;
      background:#0f141b;
      color:var(--fg);
      border:1px solid var(--border);
    }
    .profile-company select:disabled{opacity:0.6;cursor:not-allowed}
    .profile-company-hint{font-size:11px;color:var(--muted)}
    .invite-section{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .invite-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .invite-grid{display:grid;grid-template-columns:1fr;gap:8px}
    .invite-actions{display:flex;justify-content:flex-end}
    .invite-link-row{display:none;gap:8px;align-items:center}
    .invite-link-row input{font-size:12px}
    .trash-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .trash-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .trash-item{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .trash-title{font-weight:700}
    .trash-meta{font-size:12px;color:var(--muted);margin-top:6px}
    .trash-empty{padding:14px;border:1px dashed var(--border);border-radius:12px;color:var(--muted);text-align:center}
    .auth-actions{display:flex;justify-content:flex-end;margin-top:6px}
    .auth-link{
      background:none;border:none;padding:0;
      color:var(--accent);font-size:13px;cursor:pointer;
    }
    .auth-link:hover{text-decoration:underline}
    .section-divider{height:1px;background:var(--border);margin:12px 0}
    .role-request-meta{font-size:12px;color:var(--muted)}
    .tier-admin-section{display:flex;flex-direction:column;gap:8px}
    .tier-admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    .tier-admin-card,
    .tier-admin-stat{border:1px solid var(--border);border-radius:10px;padding:10px;background:transparent;box-shadow:none}
    .tier-admin-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:4px}
    .tier-admin-value{font-size:13px;font-weight:600;color:var(--fg)}
    .tier-admin-actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .manage-company-section{display:flex;flex-direction:column;gap:8px}
    .manage-company-row{display:flex;flex-direction:column;gap:6px}
    .manage-company-label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em}
    .manage-company-value{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .manage-company-address{
      font-family:"SF Mono", Monaco, monospace;
      font-size:13px;
      color:var(--fg);
      background:rgba(15,23,42,0.4);
      border:1px solid var(--border);
      border-radius:10px;
      padding:6px 10px;
      word-break:break-all;
    }
    .audit-filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .audit-filters select,.audit-filters input{min-width:160px}
    .audit-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .audit-card{
      border:1px solid var(--border);
      border-radius:12px;
      background:transparent;
      padding:0;
    }
    .audit-card summary{
      cursor:pointer;
      list-style:none;
      padding:12px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .audit-card summary::-webkit-details-marker{display:none}
    .audit-caret{
      margin-left:auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
    }
    .audit-caret svg{
      width:16px;
      height:16px;
      transition:transform 160ms ease;
    }
    .audit-card[open] .audit-caret svg{ transform:rotate(90deg); }
    .audit-body{
      padding:0 12px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .audit-title{font-weight:700}
    .audit-meta{font-size:12px;color:var(--muted)}
    .audit-summary{display:flex;flex-direction:column;gap:4px;min-width:0;flex:1 1 auto}
    .audit-json{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:11px;white-space:pre-wrap;color:var(--muted)}
    .shipping-address-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .shipping-address-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .shipping-address-meta{font-size:12px;color:var(--muted)}
    .shipping-address-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .shipping-address-form{display:flex;flex-direction:column;gap:8px}
    .shipping-address-default{display:flex;align-items:center;gap:12px}
    /* Company Locations Modal */
    .locations-modal{
      width:100%;
      max-width:520px;
      max-height:calc(100vh - 48px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      box-shadow:0 25px 60px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .locations-body{
      padding:0 !important;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .locations-header{
      align-items:center;
      padding:16px 20px;
      border-bottom:1px solid var(--border-subtle);
      background:var(--card);
    }
    .locations-header-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .locations-header-icon{
      width:40px;
      height:40px;
      border-radius:10px;
      background:linear-gradient(135deg, rgba(59,130,246,0.2) 0%, rgba(59,130,246,0.1) 100%);
      border:1px solid rgba(59,130,246,0.2);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    .locations-header-icon svg{
      width:20px;
      height:20px;
      color:var(--accent);
    }
    .locations-header-title{
      font-size:17px;
      font-weight:600;
      color:var(--fg);
      margin:0;
    }
    .locations-company-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      background:rgba(59,130,246,0.08);
      border-bottom:1px solid rgba(59,130,246,0.15);
    }
    .locations-company-info{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:14px;
    }
    .locations-company-label{ color:var(--muted); }
    .locations-company-name{ color:var(--fg); font-weight:600; }
    .locations-env-badge{
      font-size:9px;
      padding:2px 6px;
    }
    .locations-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 20px;
      border-bottom:1px solid var(--border-subtle);
      background:var(--card);
    }
    .locations-count{
      font-size:13px;
      color:var(--muted);
    }
    .locations-count strong{
      color:var(--fg);
      font-weight:600;
    }
    .locations-add-btn{
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid rgba(34,197,94,0.3);
      background:rgba(34,197,94,0.15);
      color:#4ade80;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .locations-add-btn:hover{
      background:rgba(34,197,94,0.25);
      border-color:rgba(34,197,94,0.5);
      transform:scale(1.05);
    }
    .locations-scroll{
      flex:1;
      overflow-y:auto;
      padding:14px 20px;
      -webkit-overflow-scrolling:touch;
    }
    .locations-cards{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .locations-empty{padding:32px 16px;text-align:center;color:var(--muted)}
    .location-card{
      background:rgba(0, 0, 0, 0.2);
      border:1px solid var(--border-subtle);
      border-radius:12px;
      padding:14px;
      transition:border-color 0.15s, background 0.15s;
    }
    .location-card.is-default{
      border-color:rgba(6, 182, 212, 0.2);
      background:rgba(6, 182, 212, 0.03);
    }
    .location-card.is-archived{
      opacity:0.75;
    }
    .card-row{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .location-card:hover{
      border-color:rgba(255,255,255,0.12);
    }
    .location-card-edit{
      width:34px;
      height:34px;
      border-radius:8px;
      flex-shrink:0;
    }
    .card-info{
      flex:1;
      min-width:0;
    }
    .card-info-top{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:4px;
    }
    .location-name{
      font-size:14px;
      font-weight:600;
      color:var(--fg);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .type-badge{
      padding:2px 8px;
      border-radius:4px;
      font-size:10px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.3px;
      background:rgba(255,255,255,0.06);
      color:var(--muted);
      flex-shrink:0;
    }
    .status-dot{
      width:6px;
      height:6px;
      border-radius:50%;
      background:var(--cyan);
      flex-shrink:0;
    }
    .status-dot.archived{ background:var(--muted); }
    .default-indicators{
      display:flex;
      gap:4px;
      flex-shrink:0;
    }
    .default-pip{
      width:8px;
      height:8px;
      border-radius:2px;
    }
    .default-pip.ship-to{ background:#3b82f6; }
    .default-pip.receive-at{ background:var(--cyan); }
    .card-info-bottom{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }
    .address-text{
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .card-actions{
      display:flex;
      gap:6px;
      flex-shrink:0;
      margin-left:8px;
    }
    .locations-modal .icon-btn{
      width:34px;
      height:34px;
      border-radius:8px;
    }
    .locations-modal .icon-btn svg{ width:15px; height:15px; }
    .locations-modal .icon-btn[data-tooltip]::after{
      content:attr(data-tooltip);
      position:absolute;
      bottom:calc(100% + 6px);
      left:50%;
      transform:translateX(-50%);
      padding:5px 10px;
      background:#1e293b;
      border:1px solid var(--border);
      border-radius:6px;
      font-size:11px;
      font-weight:500;
      color:var(--fg);
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition:opacity 0.15s;
      z-index:10;
    }
    .locations-modal .icon-btn[data-tooltip]:hover::after{ opacity:1; }
    .locations-modal .icon-btn.ship-to{
      border-color:rgba(59, 130, 246, 0.3);
      background:rgba(59, 130, 246, 0.1);
      color:#60a5fa;
    }
    .locations-modal .icon-btn.ship-to.is-set{
      background:rgba(59, 130, 246, 0.25);
      border-color:rgba(59, 130, 246, 0.5);
      color:#93c5fd;
    }
    .locations-modal .icon-btn.receive-at{
      border-color:rgba(6, 182, 212, 0.3);
      background:rgba(6, 182, 212, 0.1);
      color:var(--cyan-light);
    }
    .locations-modal .icon-btn.receive-at.is-set{
      background:rgba(6, 182, 212, 0.25);
      border-color:rgba(6, 182, 212, 0.5);
      color:var(--cyan-light);
    }
    .locations-modal .icon-btn.restore{
      border-color:rgba(255, 255, 255, 0.2);
      background:rgba(255, 255, 255, 0.08);
      color:var(--fg);
    }
    .locations-legend{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:16px;
      padding:8px 20px;
      background:rgba(0, 0, 0, 0.2);
      border-top:1px solid var(--border-subtle);
      font-size:11px;
      color:var(--muted);
    }
    .locations-legend-item{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .locations-legend-pip{
      width:8px;
      height:8px;
      border-radius:2px;
    }
    .locations-legend-pip.ship-to{ background:#3b82f6; }
    .locations-legend-pip.receive-at{ background:var(--cyan); }
    @media (max-width:480px){
      .locations-modal{max-width:100%;border-radius:14px}
      .locations-header{padding:14px 16px}
      .locations-company-bar{padding:8px 16px}
      .locations-toolbar{padding:10px 16px}
      .locations-scroll{padding:12px 16px}
      .location-card{padding:12px}
      .card-row{flex-wrap:wrap;align-items:flex-start}
      .card-info{order:1;flex-basis:calc(100% - 46px)}
      .card-actions{order:2;width:100%;margin-left:0;justify-content:flex-end;margin-top:4px}
      .locations-legend{padding:8px 16px}
      .locations-modal .icon-btn[data-tooltip]::after{display:none;}
    }
    /* Location Editor Modal - Redesign */
    .location-editor-modal{
      width:100%;
      max-width:480px;
      max-height:calc(100vh - 48px);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .location-editor-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background:var(--card);
    }
    .location-editor-header-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
      flex:1;
    }
    .location-editor-icon{
      width:44px;
      height:44px;
      border-radius:12px;
      background:linear-gradient(135deg,rgba(59,130,246,0.2) 0%,rgba(59,130,246,0.1) 100%);
      border:1px solid rgba(59,130,246,0.2);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
    }
    .location-editor-icon svg{width:20px;height:20px;color:#3b82f6}
    .location-editor-info{min-width:0;flex:1}
    .location-editor-title{
      margin:0;
      font-size:17px;
      font-weight:600;
      color:var(--fg);
    }
    .location-editor-sub{
      margin:3px 0 0;
      font-size:13px;
      color:var(--muted);
    }
    .location-editor-body{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding:20px;
    }
    .location-editor-field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:14px;
    }
    .location-editor-field:last-child{margin-bottom:0}
    .location-editor-field label{
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:var(--muted);
    }
    .location-editor-field input,
    .location-editor-field select,
    .location-editor-field textarea{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.2);
      color:var(--fg);
      font-size:15px;
      font-family:inherit;
      transition:border-color 0.15s,box-shadow 0.15s;
    }
    .location-editor-field input:focus,
    .location-editor-field select:focus{
      outline:none;
      border-color:rgba(59,130,246,0.5);
      box-shadow:0 0 0 3px rgba(59,130,246,0.15);
    }
    .location-editor-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .location-editor-grid .location-editor-field{margin-bottom:0}
    .location-editor-grid .location-editor-field.full{grid-column:1 / -1}
    .location-editor-card{
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:12px;
      padding:16px;
      margin-top:20px;
    }
    .location-editor-card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
    }
    .location-editor-card-title{
      font-size:15px;
      font-weight:600;
      color:var(--fg);
    }
    .location-editor-card-desc{
      margin:0;
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
    }
    .location-toggle-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 0;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .location-toggle-row:last-of-type{border-bottom:none}
    .location-toggle-label{font-size:14px;color:#94a3b8;flex:1;min-width:0}
    .location-toggle-control{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      flex-shrink:0;
    }
    .location-toggle-switch{
      width:48px;
      height:26px;
      border-radius:13px;
      background:rgba(255,255,255,0.1);
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex-shrink:0;
      transition:background 0.2s ease;
      cursor:pointer;
    }
    .location-toggle-switch::after{
      content:'';
      position:absolute;
      top:3px;
      left:3px;
      width:20px;
      height:20px;
      border-radius:50%;
      background:#64748b;
      transition:all 0.2s ease;
    }
    .location-toggle-input{position:absolute;opacity:0;width:0;height:0}
    .location-toggle-input:checked + .location-toggle-switch{background:rgba(59,130,246,0.3)}
    .location-toggle-input:checked + .location-toggle-switch::after{left:25px;background:#3b82f6}
    .location-toggle-input:disabled + .location-toggle-switch{opacity:0.5;cursor:not-allowed}
    .location-editor-msg{
      padding:10px 14px;
      margin-top:16px;
      background:rgba(59,130,246,0.1);
      border:1px solid rgba(59,130,246,0.2);
      border-radius:10px;
      font-size:13px;
      color:#93c5fd;
      line-height:1.45;
    }
    .location-editor-msg:empty{display:none}
    .location-editor-msg.error{
      background:rgba(239,68,68,0.1);
      border-color:rgba(239,68,68,0.2);
      color:#fca5a5;
    }
    .location-editor-footer{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
      padding:16px 20px;
      border-top:1px solid rgba(255,255,255,0.06);
      background:rgba(0,0,0,0.15);
    }
    @media (max-width:480px){
      .location-editor-modal{max-width:100%}
      .location-editor-header{padding:14px 16px}
      .location-editor-icon{width:40px;height:40px;border-radius:10px}
      .location-editor-title{font-size:16px}
      .location-editor-body{padding:16px}
      .location-editor-grid{gap:10px}
      .location-editor-footer{padding:14px 16px}
    }
    @media (max-width:380px){
      .location-editor-grid{grid-template-columns:1fr}
      .location-editor-grid .location-editor-field.full{grid-column:1}
    }
    /* Company Selector for Super Users */
    .locations-company-selector{
      border-bottom:1px solid var(--border);
      padding:12px 16px;
    }
    .locations-selector-header{margin-bottom:10px}
    .locations-company-list{
      max-height:200px;
      overflow-y:auto;
      border:1px solid var(--border);
      border-radius:8px;
      background:#0d131b;
    }
    .locations-company-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 12px;
      cursor:pointer;
      border-bottom:1px solid var(--border);
    }
    .locations-company-item:last-child{border-bottom:none}
    .locations-company-item:hover{background:rgba(255,255,255,0.04)}
    .locations-company-name{font-weight:600}
    .locations-no-locations{
      font-size:11px;
      color:#f97316;
      background:rgba(249,115,22,0.15);
      padding:2px 8px;
      border-radius:4px;
    }
    .locations-has-locations{
      font-size:11px;
      color:var(--muted);
    }
    .locations-selected-company{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      background:rgba(59,130,246,0.08);
      border-bottom:1px solid rgba(59,130,246,0.15);
    }
    .locations-selected-company .btn-change-company{
      padding:6px 12px;
      border-radius:8px;
      border:1px solid rgba(59, 130, 246, 0.3);
      background:rgba(59, 130, 246, 0.1);
      color:#93c5fd;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      transition:background 0.15s, border-color 0.15s;
    }
    .locations-selected-company .btn-change-company:hover{
      background:rgba(59, 130, 246, 0.2);
      border-color:rgba(59, 130, 246, 0.5);
    }
    /* Z-index for nested modals (when opened from other modals) */
    #companyLocationsModal.modal-nested{z-index:10002}
    #companyLocationsModal.modal-nested .modal{z-index:10003}
    #companyLocationEditorModal.modal-nested{z-index:10004}
    #companyLocationEditorModal.modal-nested .modal{z-index:10005}

    /* Google Places Autocomplete Styling */
    .pac-container{background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.4);font-family:inherit;z-index:10010;margin-top:4px}
    .pac-item{padding:10px 14px;color:var(--fg);cursor:pointer;border-top:1px solid var(--border);font-size:13px}
    .pac-item:first-child{border-top:none}
    .pac-item:hover,.pac-item-selected{background:var(--border)}
    .pac-icon{display:none}
    .pac-item-query{color:var(--accent);font-weight:600}
    .pac-matched{font-weight:700}
    gmp-place-autocomplete{display:block}
    gmp-place-autocomplete input{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
      background:#0d131b;color:#fff;font-size:16px
    }
    gmp-place-autocomplete::part(prediction-list){
      background:var(--card);
      border:1px solid var(--border);
      border-radius:8px;
      box-shadow:0 4px 20px rgba(0,0,0,0.4);
      margin-top:4px
    }
    gmp-place-autocomplete::part(prediction-item){
      padding:10px 14px;
      color:var(--fg);
      cursor:pointer;
      border-top:1px solid var(--border);
      font-size:13px
    }
    gmp-place-autocomplete::part(prediction-item):first-child{border-top:none}
    gmp-place-autocomplete::part(prediction-item-selected){background:var(--border)}
    gmp-place-autocomplete::part(prediction-item-icon){display:none}
    gmp-place-autocomplete::part(prediction-item-main-text){color:var(--accent);font-weight:600}
    gmp-place-autocomplete::part(prediction-item-match){font-weight:700}

    .user-mgmt-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .user-mgmt-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .user-mgmt-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .user-mgmt-name{font-weight:700}
    .user-mgmt-meta{font-size:12px;color:var(--muted);margin-top:4px}
    .user-mgmt-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .user-mgmt-role{min-width:120px}
    .user-mgmt-action{display:flex;align-items:center;gap:6px}
    .user-mgmt-action-btn{display:inline-flex;align-items:center;gap:6px}
    .user-mgmt-icon{width:16px;height:16px;flex-shrink:0}
    .pending-invites-section{margin-top:14px}
    .pending-invites-header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .pending-invites-header h3{margin:0;font-size:14px}
    .pending-invites-table-wrap{margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px}
    .pending-invites-table{min-width:860px;margin:0}
    .pending-invites-table th,.pending-invites-table td{white-space:nowrap}
    .pending-invites-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .invite-status{display:inline-flex;align-items:center;gap:6px;font-weight:700;text-transform:uppercase;font-size:11px;letter-spacing:0.08em}
    .invite-status.pending{color:#34d399}
    .invite-status.expired{color:#fca5a5}
    .invite-row-expired{opacity:0.7}
    .provisioning-section{margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .provisioning-card{border:1px solid var(--border);border-radius:12px;padding:12px;background:transparent}
    .provisioning-card h3{margin:0;font-size:14px}
    .provisioning-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:8px}
    .provisioning-header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .provisioning-table-wrap{margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px}
    .provisioning-table{min-width:720px;margin:0}
    .provisioning-note{font-size:12px;color:var(--muted);margin-top:6px}
    .provisioning-warning{margin-top:8px;padding:8px 10px;border:1px solid #b45309;border-radius:10px;background:rgba(245,158,11,0.08);color:#fbbf24;font-size:12px}
    .provisioning-summary{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .provisioning-summary-item{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .provisioning-summary-label{font-weight:600}
    .provisioning-status{font-size:11px;text-transform:uppercase;letter-spacing:0.08em}
    .provisioning-status.ok{color:#34d399}
    .provisioning-status.warn{color:#fbbf24}
    .provisioning-status.fail{color:#fca5a5}
    .provisioning-users-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .provisioning-field-toggle{display:flex;align-items:center;gap:8px}
    .snapshots-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .snapshot-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .snapshot-title{font-weight:700}
    .snapshot-meta{font-size:12px;color:var(--muted);margin-top:6px}
    .snapshot-preview{margin-top:12px}
    .snapshot-preview-header{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .snapshot-preview-title{font-weight:700}
    .snapshot-preview-meta{font-size:12px;color:var(--muted);margin-top:6px}
    .snapshot-preview-table{margin-top:10px}
    .metrics-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .metrics-content{margin-top:12px}
    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:10px;
      margin-top:8px;
    }
    .metric-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
    }
    .metric-value{font-size:20px;font-weight:700}
    .metric-label{font-size:12px;color:var(--muted);margin-top:4px}
    .metrics-section{margin-top:14px}
    .metrics-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:8px;
    }
    .metrics-table th,.metrics-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
    }
    .metrics-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .metrics-note{font-size:12px;color:var(--muted);margin-top:6px}
    .role-manager-table-wrap{max-height:420px;overflow:auto;margin-top:10px}
    .role-manager-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .role-manager-table th,.role-manager-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
    }
    .role-manager-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .role-manager-category td{
      background:#0f141b;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:11px;
      color:var(--muted);
    }
    .menu-icon-svg{flex-shrink:0}

    /* ========== Modernized Onboarding Wizard Theme ========== */
    :root {
      --wiz-bg: #09090b;
      --wiz-bg-elevated: #18181b;
      --wiz-accent: #00e5ff;
      --wiz-secondary: #a855f7;
      --wiz-text: #fafafa;
      --wiz-muted: #71717a;
      --wiz-border: #27272a;
      --wiz-gradient: linear-gradient(135deg, #00e5ff 0%, #a855f7 100%);
    }

    body.onboarding-route {
      background: var(--wiz-bg);
      min-height: 100vh;
    }
    body.onboarding-route::before {
      content: '';
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 800px;
      height: 600px;
      background: radial-gradient(ellipse at center, rgba(0,229,255,0.08) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    body.onboarding-route #appMain{display:none}
    body.onboarding-route .site-footer{display:none}
    body.onboarding-route header{display:none}

    .onboarding-view{
      display:none;
      max-width:720px;
      margin:0 auto;
      padding:40px 20px;
      position:relative;
      z-index:1;
      font-family:'Outfit',ui-sans-serif,system-ui,-apple-system,sans-serif;
    }
    .onboarding-view.active{display:block;animation:wizFadeIn 0.4s ease}

    @keyframes wizFadeIn {
      from{opacity:0;transform:translateY(12px)}
      to{opacity:1;transform:translateY(0)}
    }

    .onboarding-card{
      background: var(--wiz-bg-elevated);
      border-radius:20px;
      padding:32px;
      position:relative;
      border:1px solid transparent;
      background-clip:padding-box;
    }
    .onboarding-card::before {
      content:'';
      position:absolute;
      inset:0;
      border-radius:20px;
      padding:1px;
      background:var(--wiz-gradient);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
    }

    .onboarding-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:24px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .onboarding-eyebrow{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--wiz-accent);
      font-weight:600;
    }
    .onboarding-title{
      margin:8px 0 4px;
      font-size:28px;
      font-weight:700;
      color:var(--wiz-text);
      letter-spacing:-0.02em;
    }
    .onboarding-plan{
      font-size:13px;
      color:var(--wiz-muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .onboarding-plan::before {
      content:'';
      display:inline-block;
      width:6px;
      height:6px;
      border-radius:50%;
      background:var(--wiz-secondary);
    }

    .onboarding-progress{min-width:220px;flex:1}
    .onboarding-progress-bar{
      height:8px;
      border-radius:999px;
      background:var(--wiz-border);
      overflow:hidden;
      box-shadow:inset 0 1px 2px rgba(0,0,0,0.3);
    }
    .onboarding-progress-fill{
      height:100%;
      width:0;
      background:var(--wiz-gradient);
      transition:width 0.4s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 0 12px rgba(0,229,255,0.5);
    }
    .onboarding-progress-steps{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .onboarding-progress-step{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.1em;
      font-weight:600;
      color:var(--wiz-muted);
      border:1px solid var(--wiz-border);
      border-radius:999px;
      padding:6px 12px;
      transition:all 0.2s ease;
    }
    .onboarding-progress-step.active{
      color:var(--wiz-accent);
      border-color:var(--wiz-accent);
      background:rgba(0,229,255,0.1);
      box-shadow:0 0 8px rgba(0,229,255,0.3);
    }
    .onboarding-progress-step.complete{
      color:#34d399;
      border-color:#34d399;
      background:rgba(52,211,153,0.1);
    }

    .onboarding-step{display:none;margin-top:24px}
    .onboarding-step.active{display:block;animation:wizFadeIn 0.3s ease}

    .onboarding-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;
      margin-top:16px;
    }

    /* Form styling for onboarding */
    #onboardingMain label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--wiz-muted);
      font-weight:600;
      margin-bottom:6px;
      display:block;
    }
    #onboardingMain input,
    #onboardingMain select,
    #onboardingMain textarea{
      width:100%;
      padding:12px 14px;
      background:var(--wiz-bg);
      border:1px solid var(--wiz-border);
      border-radius:10px;
      color:var(--wiz-text);
      font-size:15px;
      font-family:inherit;
      transition:border-color 0.2s, box-shadow 0.2s;
    }
    #onboardingMain input:focus,
    #onboardingMain select:focus,
    #onboardingMain textarea:focus{
      outline:none;
      border-color:var(--wiz-accent);
      box-shadow:0 0 0 3px rgba(0,229,255,0.15);
    }
    #onboardingMain input::placeholder{color:var(--wiz-muted)}

    .onboarding-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:24px;
    }
    .onboarding-inline-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:16px;
    }
    .onboarding-locations-summary{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .onboarding-location-card{
      border:1px solid var(--wiz-border);
      background:var(--wiz-bg);
      border-radius:12px;
      padding:12px;
    }
    .onboarding-location-name{font-weight:700;color:var(--wiz-text)}
    .onboarding-location-address{
      margin-top:6px;
      color:var(--wiz-muted);
      font-size:12px;
      line-height:1.4;
    }
    .onboarding-location-meta{
      margin-top:6px;
      color:var(--wiz-muted);
      font-size:12px;
    }

    .onboarding-message{
      font-size:13px;
      color:var(--wiz-muted);
      margin-top:8px;
    }
    .onboarding-callout{
      margin-top:18px;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--wiz-border);
      background:rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .onboarding-callout-title{
      font-weight:700;
      color:var(--wiz-text);
    }
    .onboarding-callout-text{
      font-size:13px;
      color:var(--wiz-muted);
    }
    .onboarding-callout-address{
      font-family:"SF Mono", Monaco, monospace;
      font-size:13px;
      color:var(--wiz-text);
      background:var(--wiz-bg);
      border:1px solid var(--wiz-border);
      border-radius:10px;
      padding:8px 10px;
      word-break:break-all;
    }
    .onboarding-callout-gate{
      font-size:12px;
      color:var(--wiz-muted);
    }

    .onboarding-gate{
      border:1px dashed var(--wiz-border);
      border-radius:16px;
      padding:20px;
      margin-top:20px;
      background:rgba(0,0,0,0.2);
    }
    .onboarding-gate-title{
      font-weight:700;
      margin-bottom:8px;
      color:var(--wiz-text);
    }
    .onboarding-note{
      font-size:13px;
      color:var(--wiz-muted);
      margin-top:8px;
    }

    /* Wizard brand logo */
    .onboarding-brand{
      text-align:center;
      margin-bottom:32px;
    }
    .onboarding-brand-logo{
      font-family:'Outfit',sans-serif;
      font-size:32px;
      font-weight:800;
      letter-spacing:-0.03em;
      background:var(--wiz-gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .onboarding-brand-tagline{
      font-size:13px;
      color:var(--wiz-muted);
      margin-top:4px;
    }
</style>
</head>
<body>
  <header>
    <div class="header-inner">
      <!-- Profile backdrop for consistent blur/darken effect -->
      <div id="profileBackdrop" class="profile-backdrop" aria-hidden="true"></div>
      <div class="header-row">
        <div class="header-left">
          <div class="brandtext">
            <img class="title-logo" src="./assets/modulus/logo/inventory-manager-header.svg" alt="Inventory Manager logo" />
          </div>
          <div class="header-toast-zone" id="headerToastZone">
            <div class="order-pill-container" id="orderPillContainer" style="display:none;">
              <div class="order-pill" id="orderPill" role="status" aria-live="polite">
                <span class="order-pill-icon">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
                </span>
                <span class="order-pill-text">
                  <span class="order-pill-value" id="orderPillValue">0</span>
                  <span class="order-pill-label">Items in Cart</span>
                </span>
                <div class="order-pill-actions">
                  <button class="order-pill-btn" id="orderPillOpen" type="button" title="Create Order" aria-label="Create Order">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                  </button>
                  <button class="order-pill-btn order-pill-btn--clear" id="orderPillClear" type="button" title="Clear Cart" aria-label="Clear Cart" data-order-reset>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                  </button>
                </div>
              </div>
            </div>
            <div class="toast" id="toast" role="status" aria-live="polite"></div>
          </div>
        </div>
        <div class="header-right">
          <div class="header-company-name" id="headerCompanyName"></div>
          <div class="header-icons">
          <div class="hamburger-menu">
            <button class="icon-btn icon-btn--default hamburger-btn" id="hamburgerBtn" aria-label="Open menu" aria-expanded="false">
              <span></span>
              <span></span>
              <span></span>
            </button>
          </div>
          <div class="profile-menu">
            <button class="icon-btn icon-btn--default profile-btn" id="profileBtn" aria-label="Account menu" aria-expanded="false">
              <span class="profile-status" id="profileStatus"></span>
              <svg class="profile-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
            <div class="profile-dropdown profile-tabs" id="profileDropdown" role="dialog" aria-label="Profile menu" aria-hidden="true">
            <!-- Testing Banner - visible when emulating non-super_user role -->
            <div class="testing-banner" id="testingBanner" style="display:none;">
              <div class="testing-banner-content">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <span>Testing as <strong id="testingRoleName">admin</strong></span>
                <span class="testing-banner-hint">UI only</span>
              </div>
              <button class="exit-testing-btn" id="btnExitTesting" type="button">Exit</button>
            </div>
            <div class="profile-panel-header">
              <div class="profile-email" id="profileEmail">Not signed in</div>
              <div class="profile-company-name" id="profileCompanyName">No company selected</div>
              <div class="profile-badges">
                <span class="env-badge profile-env-badge hidden" id="profileEnvBadge">Production</span>
                <span class="profile-role-badge" id="profileRoleBadge">USER</span>
              </div>
              <div class="profile-env-note" id="profileEnvNote" style="display:none;">
                This is a non-production environment. Data here may be reset or deleted.
              </div>
            </div>
            <!-- Role Switcher Section - only visible for super_users -->
            <div class="role-switcher-section" id="roleSwitcherSection" style="display:none;">
              <div class="role-switcher-label">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>
                <span>Emulate Role</span>
              </div>
              <div class="role-pills" id="rolePills">
                <button class="role-pill is-active" data-role="super_user" type="button">super user</button>
                <button class="role-pill" data-role="admin" type="button">admin</button>
                <button class="role-pill" data-role="member" type="button">member</button>
                <button class="role-pill" data-role="viewer" type="button">viewer</button>
              </div>
            </div>
            <div class="profile-tabbar" id="profileTabList" role="tablist" aria-label="Profile sections">
              <button class="profile-tab is-active" role="tab" id="profileTabAccount" data-tab="account" aria-selected="true" aria-controls="profilePanelAccount" tabindex="0">Account</button>
              <button class="profile-tab" role="tab" id="profileTabCompany" data-tab="company" aria-selected="false" aria-controls="profilePanelCompany" tabindex="-1">Company</button>
              <button class="profile-tab" role="tab" id="profileTabTeam" data-tab="team" aria-selected="false" aria-controls="profilePanelTeam" tabindex="-1">Team</button>
            </div>
            <div class="profile-panels" id="profileTabPanels">
              <div class="profile-panel is-active" role="tabpanel" id="profilePanelAccount" data-panel="account" aria-labelledby="profileTabAccount" tabindex="0">
                <button class="profile-item" id="openProfileSettings" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                  <span>Profile Settings</span>
                </button>
                <div class="profile-divider"></div>
                <button class="profile-item profile-item--danger" id="profileSignIn" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                  <span id="profileSignInText">Sign Out</span>
                </button>
              </div>
              <div class="profile-panel" role="tabpanel" id="profilePanelCompany" data-panel="company" aria-labelledby="profileTabCompany" tabindex="0">
                <button class="profile-item" id="openCompanySwitcher" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                  <span>Change User Company</span>
                </button>
                <button class="profile-item" id="openCompanyLocations" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 10c0 5-9 11-9 11S3 15 3 10a9 9 0 1 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                  <span>Locations</span>
                </button>
                <button class="profile-item" id="openManageCompany" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                  <span>Manage Company</span>
                </button>
                <button class="profile-item" id="openSubscriptionManager" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                  <span>Subscription</span>
                </button>
              </div>
              <div class="profile-panel" role="tabpanel" id="profilePanelTeam" data-panel="team" aria-labelledby="profileTabTeam" tabindex="0">
                <button class="profile-item" id="openInviteModal" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
                  <span>Invite User</span>
                </button>
                <button class="profile-item" id="openUserMgmt" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                  <span>Manage Users</span>
                </button>
                <button class="profile-item" id="openRoleManager" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                  <span>Roles &amp; Permissions</span>
                </button>
                <div class="profile-empty" id="profileTeamEmpty" style="display:none;">No team actions available.</div>
              </div>
            </div>
            </div>
          </div>
          </div>
        </div>
      </div>
      <div id="menuBackdrop" class="menu-backdrop" aria-hidden="true">
        <div class="menu-panel" id="menuPanel" role="dialog" aria-modal="true" aria-labelledby="menuTitle">
          <div class="menu-header">
            <div class="menu-title" id="menuTitle">Menu</div>
            <button class="menu-close" id="menuCloseBtn" type="button" aria-label="Close menu">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="menu-quick-actions">
            <button class="menu-quick-btn" id="menuAddOne" type="button">
              <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <span>Add Item</span>
            </button>
            <button class="menu-quick-btn" id="menuQuickOrder" type="button">
              <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
              </svg>
              <span>New Order</span>
            </button>
          </div>
          <div class="menu-tabs" id="menuTabList" role="tablist" aria-label="Menu sections">
            <button class="menu-tab is-active" role="tab" id="menuTabInventory" data-tab="inventory" aria-selected="true" aria-controls="menuPanelInventory" tabindex="0">Data</button>
            <button class="menu-tab" role="tab" id="menuTabOrders" data-tab="orders" aria-selected="false" aria-controls="menuPanelOrders" tabindex="-1">Orders</button>
            <button class="menu-tab" role="tab" id="menuTabReports" data-tab="reports" aria-selected="false" aria-controls="menuPanelReports" tabindex="-1">Reports</button>
          </div>
          <div class="menu-tab-panels" id="menuTabPanels">
            <div class="menu-tab-panel is-active" role="tabpanel" id="menuPanelInventory" data-panel="inventory" aria-labelledby="menuTabInventory" tabindex="0">
              <div class="menu-section-label">Data</div>
              <button class="menu-item" id="menuImport" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Import File</span>
              </button>
              <button class="menu-item" id="menuPaste" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                  <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
                <span>Paste Data</span>
              </button>
              <button class="menu-item" id="menuExport" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span>Export File</span>
              </button>
              <!--
              // Inventory Report retired.
              // Inventory List + quick filters cover low-stock use cases.
              // Future replacement: Report Builder.
              -->
              <div class="menu-divider"></div>
              <button class="menu-item menu-item--danger" id="menuTrash" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                <span>Trash</span>
              </button>
            </div>
            <div class="menu-tab-panel" role="tabpanel" id="menuPanelOrders" data-panel="orders" aria-labelledby="menuTabOrders" tabindex="0">
              <button class="menu-item" id="menuOrder" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="9" cy="21" r="1"></circle>
                  <circle cx="20" cy="21" r="1"></circle>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                </svg>
                <span>Orders</span>
                <span class="menu-item-badges" id="menuOrderBadges" style="display:none;">
                  <span class="menu-item-badge menu-item-badge--accent" id="menuOrderDraftBadge" data-menu-badge="orders-draft" title="View draft orders" style="display:none;">
                    <span class="menu-item-badge-label">Draft</span>
                    <span class="menu-item-badge-value">0</span>
                  </span>
                  <span class="menu-item-badge menu-item-badge--muted" id="menuOrderSubmittedBadge" data-menu-badge="orders-submitted" title="View submitted orders" style="display:none;">
                    <span class="menu-item-badge-label">Submitted</span>
                    <span class="menu-item-badge-value">0</span>
                  </span>
                </span>
              </button>
              <button class="menu-item" id="menuReceive" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                  <path d="M3.27 6.96 12 12.01l8.73-5.05"></path>
                  <path d="M12 22.08V12"></path>
                  <polyline points="9 11 12 14 16 10"></polyline>
                </svg>
                <span>Receive Inventory</span>
                <span class="menu-item-badges" id="menuReceiveBadges" style="display:none;">
                  <span class="menu-item-badge menu-item-badge--accent" id="menuReceiveReceiptsBadge" data-menu-badge="receive-receipts" title="Review receipts" style="display:none;">
                    <span class="menu-item-badge-label">Receipts</span>
                    <span class="menu-item-badge-value">0</span>
                  </span>
                  <span class="menu-item-badge menu-item-badge--info" id="menuReceivePendingBadge" data-menu-badge="receive-pending" title="Receive pending orders" style="display:none;">
                    <span class="menu-item-badge-label">Pending</span>
                    <span class="menu-item-badge-value">0</span>
                  </span>
                </span>
              </button>
              <button class="menu-item" id="menuJobs" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                  <path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>
                </svg>
                <span>Jobs</span>
                <span class="menu-item-badges" id="menuJobsBadges" style="display:none;">
                  <span class="menu-item-badge menu-item-badge--warning" id="menuJobsDraftBadge" data-menu-badge="jobs-draft" title="Review draft jobs" style="display:none;">
                    <span class="menu-item-badge-label">Draft</span>
                    <span class="menu-item-badge-value">0</span>
                  </span>
                  <span class="menu-item-badge menu-item-badge--success" id="menuJobsReadyBadge" data-menu-badge="jobs-ready" title="Approve ready jobs" style="display:none;">
                    <span class="menu-item-badge-label">Ready</span>
                    <span class="menu-item-badge-value">0</span>
                  </span>
                </span>
              </button>
              <button class="menu-item" id="menuHistory" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>Order History</span>
              </button>
            </div>
            <div class="menu-tab-panel" role="tabpanel" id="menuPanelReports" data-panel="reports" aria-labelledby="menuTabReports" tabindex="0">
              <button class="menu-item" id="menuMetrics" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <line x1="12" y1="20" x2="12" y2="10"></line>
                  <line x1="18" y1="20" x2="18" y2="4"></line>
                  <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                <span>Metrics</span>
              </button>
              <button class="menu-item" id="menuSnapshots" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"></path>
                  <circle cx="12" cy="13" r="4"></circle>
                </svg>
                <span>Snapshots</span>
              </button>
              <button class="menu-item" id="menuAudit" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M8 21h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H8"></path>
                  <path d="M6 17H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h2"></path>
                  <path d="M8 5v16"></path>
                  <path d="M10 9h8"></path>
                  <path d="M10 13h8"></path>
                  <path d="M10 17h8"></path>
                </svg>
                <span>Audit Log</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main id="onboardingMain" class="onboarding-view" aria-live="polite">
    <div class="onboarding-brand">
      <div class="onboarding-brand-logo">modulus</div>
      <div class="onboarding-brand-tagline">Inventory Manager</div>
    </div>
    <section class="card onboarding-card">
      <div class="onboarding-header">
        <div>
          <div class="onboarding-eyebrow" id="onboardingEyebrow">Company Onboarding</div>
          <div class="onboarding-title" id="onboardingTitle">Set up your workspace</div>
          <div class="onboarding-plan" id="onboardingPlanSummary" style="display:none;"></div>
          <div class="onboarding-note" id="onboardingNote">You can complete setup later.</div>
        </div>
        <div class="onboarding-progress" aria-label="Onboarding progress">
          <div class="onboarding-progress-bar">
            <div class="onboarding-progress-fill" id="onboardingProgressFill"></div>
          </div>
          <div class="onboarding-progress-steps" id="onboardingProgressSteps">
            <div class="onboarding-progress-step" data-onboarding-progress="1">Company Profile</div>
            <div class="onboarding-progress-step" data-onboarding-progress="2">Locations</div>
            <div class="onboarding-progress-step" data-onboarding-progress="3">Invite Users</div>
            <div class="onboarding-progress-step" data-onboarding-progress="4">Finish</div>
          </div>
        </div>
      </div>

      <div id="onboardingGate" class="onboarding-gate" style="display:none;">
        <div class="onboarding-gate-title" id="onboardingGateTitle"></div>
        <div class="muted" id="onboardingGateMessage"></div>
        <div class="onboarding-actions">
          <button class="btn-primary" id="onboardingGatePrimary" type="button">Continue</button>
          <button class="btn-secondary" id="onboardingGateSecondary" type="button" style="display:none;">Continue</button>
        </div>
      </div>

      <div id="onboardingWizard">
        <!-- Step 0: Create Account (for new signups) -->
        <div class="onboarding-step" id="onboardingStepAccount" data-onboarding-step="account">
          <h2 style="margin:0;font-size:16px;">Create Your Account</h2>
          <div class="muted" style="margin-top:6px;">Get started with your free account.</div>
          <form id="onboardingAccountForm">
            <div class="onboarding-grid">
              <div>
                <label class="muted" for="signupEmail">Email address</label>
                <input id="signupEmail" type="email" placeholder="you@company.com" autocomplete="email" inputmode="email" required />
              </div>
              <div>
                <label class="muted" for="signupPassword">Password</label>
                <input id="signupPassword" type="password" placeholder="At least 8 characters" autocomplete="new-password" required />
              </div>
              <div>
                <label class="muted" for="signupPasswordConfirm">Confirm password</label>
                <input id="signupPasswordConfirm" type="password" placeholder="Confirm password" autocomplete="new-password" required />
              </div>
            </div>
            <div class="onboarding-terms" style="margin-top:12px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:var(--wiz-muted);">
                <input type="checkbox" id="signupTerms" required style="width:auto;" />
                I agree to the <a href="/terms" target="_blank" style="color:var(--wiz-accent);">Terms of Service</a>
              </label>
            </div>
            <div class="onboarding-actions">
              <div id="signupAccountMsg" class="onboarding-message" style="margin-right:auto;"></div>
              <button class="btn-secondary" id="btnSignupHaveAccount" type="button">Already have an account?</button>
              <button class="btn-primary" id="btnSignupSubmit" type="submit">Create Account</button>
            </div>
          </form>
        </div>

        <!-- Step 1: Name Your Company (for new signups) -->
        <div class="onboarding-step" id="onboardingStepCompany" data-onboarding-step="company">
          <h2 style="margin:0;font-size:16px;">Name Your Company</h2>
          <div class="muted" style="margin-top:6px;">This will be your workspace in the Inventory Manager.</div>
          <form id="onboardingCompanyForm">
            <div class="onboarding-grid">
              <div style="grid-column: 1 / -1;">
                <label class="muted" for="signupCompanyName">Company name</label>
                <input id="signupCompanyName" type="text" placeholder="Acme Corporation" autocomplete="organization" required />
              </div>
            </div>
            <div class="onboarding-actions">
              <div id="signupCompanyMsg" class="onboarding-message" style="margin-right:auto;"></div>
              <button class="btn-primary" id="btnCompanySubmit" type="submit">Continue</button>
            </div>
          </form>
        </div>

        <div class="onboarding-step" id="onboardingStepProfile" data-onboarding-step="profile">
          <h2 style="margin:0;font-size:16px;">Company Profile</h2>
          <div class="muted" style="margin-top:6px;">Tell us the basics so we can personalize your setup.</div>
          <form id="onboardingProfileForm">
            <div class="onboarding-grid">
              <div>
                <label class="muted" for="onboardingCompanyName">Company name</label>
                <input id="onboardingCompanyName" type="text" placeholder="Acme Co." autocomplete="organization" />
              </div>
              <div>
                <label class="muted" for="onboardingContactEmail">Primary contact email</label>
                <input id="onboardingContactEmail" type="email" placeholder="ops@acme.co" autocomplete="email" inputmode="email" />
              </div>
              <div>
                <label class="muted" for="onboardingTimezone">Timezone</label>
                <select id="onboardingTimezone">
                  <option value="">Select timezone...</option>
                </select>
              </div>
            </div>
            <div class="onboarding-callout" id="onboardingReceiptCallout">
              <div class="onboarding-callout-title">Receipt forwarding</div>
              <div class="onboarding-callout-text">Each company has a unique address for forwarding receipts.</div>
              <div class="onboarding-callout-address" id="onboardingReceiptAddress">receipts+<company_slug>@inbound.inventorymanager.app</div>
              <div class="onboarding-callout-gate" id="onboardingReceiptGate" style="display:none;">Receipt ingestion is available on Pro plans. You can enable it later.</div>
            </div>
            <div class="onboarding-actions">
              <div id="onboardingProfileMsg" class="onboarding-message" style="margin-right:auto;"></div>
              <button class="btn-primary" id="btnOnboardingProfileSave" type="submit">Continue</button>
            </div>
          </form>
        </div>

        <div class="onboarding-step" id="onboardingStepLocations" data-onboarding-step="locations">
          <h2 style="margin:0;font-size:16px;">Locations</h2>
          <div class="muted" style="margin-top:6px;">Add at least one active location to receive inventory.</div>
          <div class="onboarding-inline-actions">
            <button class="btn-secondary" id="btnOnboardingManageLocations" type="button">Manage Locations</button>
            <button class="btn-primary" id="btnOnboardingLocationsContinue" type="button">Continue</button>
          </div>
          <div id="onboardingLocationsStatus" class="onboarding-message"></div>
          <div id="onboardingLocationsSummary" class="onboarding-locations-summary"></div>
          <div id="onboardingLocationsMsg" class="onboarding-message"></div>
        </div>

        <div class="onboarding-step" id="onboardingStepInvites" data-onboarding-step="invites">
          <h2 style="margin:0;font-size:16px;">Invite Users</h2>
          <div class="muted" style="margin-top:6px;">Invite teammates now, or skip and return later.</div>
          <div class="onboarding-inline-actions">
            <button class="btn-secondary" id="btnOnboardingInviteOpen" type="button">Send Invite</button>
            <button class="btn-secondary" id="btnOnboardingInvitesRefresh" type="button">Refresh Invites</button>
            <button class="btn-secondary" id="btnOnboardingInvitesSkip" type="button">Skip for now</button>
            <button class="btn-primary" id="btnOnboardingInvitesContinue" type="button">Continue</button>
          </div>
          <div id="onboardingInvitesMsg" class="onboarding-message"></div>
          <div id="onboardingPendingInvitesSlot"></div>
        </div>

        <div class="onboarding-step" id="onboardingStepFinish" data-onboarding-step="finish">
          <h2 style="margin:0;font-size:16px;">Finish</h2>
          <div class="muted" style="margin-top:6px;">Your company is ready. You can adjust settings anytime.</div>
          <div class="onboarding-inline-actions">
            <button class="btn-primary" id="btnOnboardingFinish" type="button">Go to Dashboard</button>
          </div>
          <div id="onboardingFinishMsg" class="onboarding-message"></div>
        </div>
      </div>
    </section>
  </main>

  <main id="appMain">
    <section class="card">
	      <div class="toolbar" role="toolbar" aria-label="Inventory actions">
	        <input type="file" id="fileImport" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" style="display:none" />

	        <!-- Stats Cards Row -->
	        <div class="inv-stats-row" id="invStatsRow" aria-live="polite">
	          <div class="inv-stat-card" data-stat-filter="all">
	            <span class="inv-stat-value" id="statTotalItems">0</span>
	            <span class="inv-stat-label">Total Items</span>
	          </div>
	          <div class="inv-stat-card" data-stat-filter="in_stock">
	            <span class="inv-stat-value inv-stat-value--green" id="statInStock">0</span>
	            <span class="inv-stat-label">In Stock</span>
	          </div>
	          <div class="inv-stat-card" data-stat-filter="low_stock">
	            <span class="inv-stat-value inv-stat-value--yellow" id="statLowStock">0</span>
	            <span class="inv-stat-label">Low Stock</span>
	          </div>
	          <div class="inv-stat-card" data-stat-filter="out_of_stock">
	            <span class="inv-stat-value inv-stat-value--red" id="statOutOfStock">0</span>
	            <span class="inv-stat-label">Out of Stock</span>
	          </div>
	          <div class="inv-stat-card">
	            <span class="inv-stat-value inv-stat-value--muted" id="statTotalQty">0</span>
	            <span class="inv-stat-label">Total Qty</span>
	          </div>
	        </div>

	        <!-- Centered Tabs -->
	        <div class="inv-tabs-container">
	          <div class="inv-header-tabs" role="tablist">
	            <button class="inv-header-tab" data-inv-tab="filter" type="button" role="tab" aria-selected="false">
	              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
	              </svg>
	              <span>Search &amp; Filter</span>
	            </button>
	            <button class="inv-header-tab" data-inv-tab="layout" type="button" role="tab" aria-selected="false">
	              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                <rect x="3" y="3" width="7" height="7"></rect>
	                <rect x="14" y="3" width="7" height="7"></rect>
	                <rect x="14" y="14" width="7" height="7"></rect>
	                <rect x="3" y="14" width="7" height="7"></rect>
	              </svg>
	              <span>Layout</span>
	            </button>
	            <button class="inv-header-tab" data-inv-tab="sort" type="button" role="tab" aria-selected="false">
	              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                <line x1="4" y1="6" x2="20" y2="6"></line>
	                <line x1="4" y1="12" x2="16" y2="12"></line>
	                <line x1="4" y1="18" x2="12" y2="18"></line>
	              </svg>
	              <span>Sort</span>
	            </button>
	          </div>
	        </div>

	        <!-- Filter Tab Content -->
	        <div class="inv-tab-content" data-inv-tab-content="filter" role="tabpanel">
	          <div class="input-wrap" style="margin-bottom:12px;">
	            <input id="filterBox" type="text" placeholder="Search itemsâ€¦" aria-label="Filter items" />
	            <button class="icon-btn icon-btn--default clear-input-btn" id="btnClearFilter" type="button" aria-label="Clear filter" title="Clear filter" style="display:none">
	              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	                <path d="M18 6L6 18"></path>
	                <path d="M6 6l12 12"></path>
	              </svg>
	            </button>
	          </div>
	          <div class="inv-filter-pills" id="invQuickFilters" role="group" aria-label="Quick filters">
	            <button class="inv-filter-pill is-active" type="button" data-filter="all" aria-pressed="true">All</button>
	            <button class="inv-filter-pill" type="button" data-filter="in_stock" aria-pressed="false">In Stock</button>
	            <button class="inv-filter-pill" type="button" data-filter="low_stock" aria-pressed="false">Low Stock</button>
	            <button class="inv-filter-pill" type="button" data-filter="out_of_stock" aria-pressed="false">Out of Stock</button>
	          </div>
	        </div>

	        <!-- Layout Tab Content -->
	        <div class="inv-tab-content" data-inv-tab-content="layout" role="tabpanel">
	          <div class="inv-layout-options">
	            <div class="inv-layout-group">
	              <div class="inv-layout-group-label">View</div>
	              <div class="inv-layout-toggle" id="invViewToggle" role="group" aria-label="View mode">
	                <button class="inv-layout-btn" id="btnViewCards" type="button" title="Card View" aria-pressed="false">
	                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                    <rect x="3" y="3" width="7" height="7" rx="1"></rect>
	                    <rect x="14" y="3" width="7" height="7" rx="1"></rect>
	                    <rect x="3" y="14" width="7" height="7" rx="1"></rect>
	                    <rect x="14" y="14" width="7" height="7" rx="1"></rect>
	                  </svg>
	                  Grid
	                </button>
	                <button class="inv-layout-btn is-active" id="btnViewTable" type="button" title="Table View" aria-pressed="true">
	                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	                    <path d="M3 6h18M3 12h18M3 18h18"></path>
	                  </svg>
	                  List
	                </button>
	              </div>
	            </div>
	          </div>

	          <!-- Column Sorter Section - PRESERVED for hysteresis drag -->
	          <div class="inv-column-sorter">
	            <div class="inv-column-sorter-header">
	              <div class="inv-layout-group-label">Column Sorter</div>
	              <div class="inv-column-sorter-hint">Drag to reorder â€¢ Uncheck to hide</div>
	            </div>
	            <div class="columns-wrap" style="position:static;">
	              <div class="column-builder" id="columnBuilder" role="region" aria-label="Column settings" style="position:static;display:block;background:transparent;border:none;padding:0;box-shadow:none;">
	                <div class="column-builder-list" id="columnBuilderList"></div>
	              </div>
	            </div>
	          </div>

	          <!-- Row Tap Section -->
	          <div class="inv-row-tap-section">
	            <div class="inv-layout-group-label">Row Tap</div>
	            <div class="column-builder-tap" id="columnBuilderTap">
	              <label for="rowTapExpandDetails" data-tap-option="expand_details" class="inv-row-tap-option">
	                <input type="radio" id="rowTapExpandDetails" name="rowTapPref" value="expand_details">
	                Expand details
	              </label>
	              <label for="rowTapOrder" data-tap-option="add_to_order" class="inv-row-tap-option">
	                <input type="radio" id="rowTapOrder" name="rowTapPref" value="add_to_order">
	                Add to order
	              </label>
	              <label for="rowTapJob" data-tap-option="add_to_job" class="inv-row-tap-option">
	                <input type="radio" id="rowTapJob" name="rowTapPref" value="add_to_job">
	                Add to job
	              </label>
	              <label for="rowTapEdit" data-tap-option="edit_item" class="inv-row-tap-option">
	                <input type="radio" id="rowTapEdit" name="rowTapPref" value="edit_item">
	                Edit item
	              </label>
	            </div>
	          </div>
	        </div>

	        <!-- Sort Tab Content -->
	        <div class="inv-tab-content" data-inv-tab-content="sort" role="tabpanel">
	          <div class="inv-sort-options" id="invSortOptions">
	            <button class="inv-sort-option is-active" data-sort="name:asc" type="button">
	              Item Name
	              <span class="inv-sort-direction">
	                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
	                  <polyline points="18 15 12 9 6 15"></polyline>
	                </svg>
	              </span>
	            </button>
	            <button class="inv-sort-option" data-sort="sku:asc" type="button">
	              SKU
	              <span class="inv-sort-direction">
	                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
	                  <polyline points="18 15 12 9 6 15"></polyline>
	                </svg>
	              </span>
	            </button>
	            <button class="inv-sort-option" data-sort="qty:desc" type="button">
	              On Hand
	              <span class="inv-sort-direction">
	                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
	                  <polyline points="18 15 12 9 6 15"></polyline>
	                </svg>
	              </span>
	            </button>
	            <button class="inv-sort-option" data-sort="updatedAt:desc" type="button">
	              Last Updated
	              <span class="inv-sort-direction">
	                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
	                  <polyline points="18 15 12 9 6 15"></polyline>
	                </svg>
	              </span>
	            </button>
	          </div>
	          <!-- Hidden select for existing sort functionality -->
	          <select id="mobileSort" aria-label="Sort items" style="display:none;">
	            <option value="name:asc">Item (Aâ€“Z)</option>
	            <option value="name:desc">Item (Zâ€“A)</option>
	            <option value="desc:asc">Description (Aâ€“Z)</option>
	            <option value="desc:desc">Description (Zâ€“A)</option>
	            <option value="qty:asc">Qty (Lowâ€“High)</option>
	            <option value="qty:desc">Qty (Highâ€“Low)</option>
	            <option value="updatedAt:desc">Last Modified (Newest)</option>
	            <option value="updatedAt:asc">Last Modified (Oldest)</option>
	          </select>
	        </div>
	      </div>

	      <!-- Legacy totals (hidden, kept for compatibility) -->
	      <div class="totals" aria-live="polite" style="display:none;">
	        <span id="totalItems" class="muted">Total Items: 0</span>
	        <span id="totalInStock" class="muted">In Stock: 0</span>
	        <span id="totalLowStock" class="muted">Low Stock: 0</span>
	        <span id="totalOutOfStock" class="muted">Out of Stock: 0</span>
	        <span id="totalQty" class="muted">Total Qty: 0</span>
	      </div>

	      <!-- Card View (hidden by default) -->
	      <div class="inv-card-grid" id="invCardGrid" style="display:none;" role="list" aria-label="Inventory items"></div>

	      <!-- Table View (default) -->
	      <div class="scroll" id="tableWrap">
	        <table id="invTable" role="grid" aria-label="Inventory table">
	          <colgroup id="invTableColgroup"></colgroup>
	          <thead id="invTableHead"></thead>
	          <tbody></tbody>
	        </table>
	      </div>

	      <!-- Empty State -->
	      <div class="inv-empty-state" id="invEmptyState" style="display:none;">
	        <p>No items match your filter.</p>
	        <button class="inv-reset-btn" id="btnResetFilters" type="button">Reset Filters</button>
	      </div>

      <div class="muted" style="margin-top:8px">
        <span id="editHint">Use the pencil icon to edit item details.</span>
      </div>
    </section>

    <!-- Floating Selection Bar -->
    <div class="inv-selection-bar" id="invSelectionBar" style="display:none;">
      <span class="inv-selection-count" id="invSelectionCount">0 selected</span>
      <button class="inv-selection-action" id="btnSelectionExport" type="button">Export</button>
      <button class="inv-selection-action" id="btnSelectionDelete" type="button">Delete</button>
      <button class="inv-selection-clear" id="btnSelectionClear" type="button">Clear</button>
    </div>
  </main>

  <footer class="site-footer">
    <img class="footer-logo" src="./assets/modulus/logo/modulus-logo-horizontal.svg" alt="Modulus Software, LLC" />
  </footer>

  <!-- Paste/Import modal -->
  <div id="pasteModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="pasteModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="9" y="2" width="6" height="4"></rect>
              <path d="M5 6h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 class="modal-title" id="pasteModalTitle">Paste Data</h2>
            <div class="modal-subtitle">Import items from clipboard or file.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="pasteModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Import</div>
          <div class="muted">
            Provide columns <code>Item, Description, Qty</code>. Headers optional; Qty optional (defaults to 0).
            Tabs, commas, or multi-space columns are accepted.
          </div>
          <div class="drop" id="dropZone">Drop a CSV/TSV/TXT/JSON/XLSX/XLS/DOCX/PDF file here, or choose below.</div>
          <label for="fileImportModal">Choose file</label>
          <input type="file" id="fileImportModal" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" />
          <label for="pasteArea">Paste data</label>
          <textarea id="pasteArea" rows="8" placeholder="Item, Description, Qty"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <span id="pasteInfo" class="muted"></span>
        </div>
        <div class="footer-right">
          <button class="btn-secondary" id="btnPasteCancel" type="button" data-modal-close="pasteModal">Cancel</button>
          <button class="btn-primary" id="btnPasteApply" type="button">Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add-one modal -->
  <div id="addOneModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="addOneModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 class="modal-title" id="addOneModalTitle">Add Item</h2>
            <div class="modal-subtitle">Create a single inventory item.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="addOneModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Details</div>
          <label for="addName">Item (unique)</label>
          <input id="addName" type="text" placeholder="Item" autocapitalize="off" autocomplete="off" spellcheck="false" />
          <label for="addDesc">Description (optional)</label>
          <input id="addDesc" type="text" placeholder="Description" />
          <label for="addQty">Quantity</label>
          <div class="qty-stepper" id="addQtyStepper">
            <button type="button" class="qty-stepper-btn" id="addQtyDec" aria-label="Decrease quantity">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <input type="text" inputmode="numeric" pattern="[0-9]*" class="qty-stepper-input" id="addQty" value="1" aria-label="Quantity">
            <button type="button" class="qty-stepper-btn" id="addQtyInc" aria-label="Increase quantity">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnAddCancel" type="button" data-modal-close="addOneModal">Cancel</button>
          <button class="btn-primary" id="btnAddSave" type="button">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Item modal (canonical) - Tabbed Interface -->
  <div id="editItemModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="editItemTitle">
      <!-- Dynamic Header -->
      <div class="edit-header">
        <div class="edit-header-left">
          <div class="edit-header-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
            </svg>
          </div>
          <div class="edit-header-info">
            <h2 id="editItemTitle" class="edit-header-title">Edit Item</h2>
            <p id="editItemSubtitle" class="edit-header-sub">No SKU Â· Unassigned</p>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="editItemModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Tab Bar -->
      <div class="edit-tabs" role="tablist" aria-label="Edit item sections">
        <div class="edit-tabs-inner">
          <button class="edit-tab is-active" role="tab" id="editTabDetails" data-tab="details" aria-selected="true" aria-controls="editPanelDetails" type="button">Details</button>
          <button class="edit-tab" role="tab" id="editTabInventory" data-tab="inventory" aria-selected="false" aria-controls="editPanelInventory" type="button">Inventory</button>
          <button class="edit-tab" role="tab" id="editTabSettings" data-tab="settings" aria-selected="false" aria-controls="editPanelSettings" type="button">Settings</button>
        </div>
      </div>

      <div class="modal-body">
        <!-- Details Tab -->
        <div class="edit-tab-content is-active" id="editPanelDetails" data-tab="details" role="tabpanel" aria-labelledby="editTabDetails">
          <div class="edit-field">
            <label for="editItemName">Item Name</label>
            <input id="editItemName" type="text" placeholder="Item name" autocapitalize="off" autocomplete="off" spellcheck="false" />
          </div>
          <div class="field-spacer"></div>
          <div class="edit-grid-2">
            <div class="edit-field">
              <label for="editItemSku">SKU</label>
              <input id="editItemSku" type="text" placeholder="Optional" autocapitalize="off" autocomplete="off" spellcheck="false" />
            </div>
            <div class="edit-field">
              <label for="editItemUom">Unit</label>
              <select id="editItemUom"></select>
            </div>
          </div>
          <div class="field-spacer"></div>
          <div class="edit-field">
            <label for="editItemDesc">Description</label>
            <textarea id="editItemDesc" rows="2" placeholder="Optional description" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>
          </div>
          <div class="field-spacer"></div>
          <div class="edit-grid-2">
            <div class="edit-field">
              <label for="editItemLocation">Location</label>
              <select id="editItemLocation"></select>
            </div>
            <div class="edit-field">
              <label for="editItemCategory">Category</label>
              <input id="editItemCategory" type="text" list="editItemCategoryList" placeholder="Optional" />
              <datalist id="editItemCategoryList"></datalist>
            </div>
          </div>
        </div>

        <!-- Inventory Tab -->
        <div class="edit-tab-content" id="editPanelInventory" data-tab="inventory" role="tabpanel" aria-labelledby="editTabInventory">
          <div class="inventory-grid">
            <div class="inventory-card on-hand">
              <div class="inventory-label">On Hand</div>
              <div class="inventory-value calculated" id="editInvOnHandValue">0</div>
              <div class="inventory-calc-hint">Inventory updates only via Receiving</div>
            </div>
            <div class="inventory-card incoming">
              <div class="inventory-label">Incoming (Not Yet Received)</div>
              <div class="inventory-value calculated" id="editInvIncomingValue">0</div>
              <div class="inventory-calc-hint">Open orders</div>
            </div>
            <div class="inventory-card allocated">
              <div class="inventory-label">Allocated</div>
              <div class="inventory-value calculated" id="editInvAllocatedValue">0</div>
              <div class="inventory-calc-hint">Allocated to jobs</div>
            </div>
            <div class="inventory-card remaining">
              <div class="inventory-label">Remaining</div>
              <div class="inventory-value calculated" id="editInvRemainingValue">0</div>
              <div class="inventory-calc-hint">On Hand - Allocated</div>
            </div>
          </div>
          <div class="inventory-info-banner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span>On Hand updates via Receiving. Allocations are created when items are added to jobs.</span>
          </div>
        </div>

        <!-- Settings Tab -->
        <div class="edit-tab-content" id="editPanelSettings" data-tab="settings" role="tabpanel" aria-labelledby="editTabSettings">
          <div class="settings-card">
            <div class="settings-card-header">
              <span class="settings-card-title">Batch Reorder</span>
              <label class="toggle-label-wrap">
                <input type="checkbox" id="editReorderEnabled" class="toggle-input" checked>
                <span class="toggle-switch-new"></span>
              </label>
            </div>
            <p class="settings-card-desc">Include this item in automatic batch reorder reports</p>
          </div>

          <div class="settings-row">
            <span class="settings-label">Reorder Point</span>
            <div class="stepper-inline">
              <button class="stepper-inline-btn" id="editReorderPointMinus" type="button" aria-label="Decrease">âˆ’</button>
              <span class="stepper-inline-value" id="editReorderPointValue">0</span>
              <button class="stepper-inline-btn" id="editReorderPointPlus" type="button" aria-label="Increase">+</button>
            </div>
          </div>
          <div class="settings-row">
            <span class="settings-label">Reorder Quantity</span>
            <div class="stepper-inline">
              <button class="stepper-inline-btn" id="editReorderQtyMinus" type="button" aria-label="Decrease">âˆ’</button>
              <span class="stepper-inline-value" id="editReorderQtyValue">0</span>
              <button class="stepper-inline-btn" id="editReorderQtyPlus" type="button" aria-label="Increase">+</button>
            </div>
          </div>

          <div class="settings-help">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span>When On Hand drops to or below the Reorder Point, this item will appear in your reorder report.</span>
          </div>
          <!-- Hidden inputs for form submission -->
          <input type="hidden" id="editLowStockQty" />
          <input type="hidden" id="editItemReorderQty" />
        </div>

        <div id="editItemMsg" class="muted"></div>
      </div>

      <!-- Footer -->
      <div class="edit-footer">
        <button class="btn-delete" id="btnEditItemDelete" type="button">Delete</button>
        <div class="edit-footer-right">
          <button class="btn-secondary" id="btnEditItemCancel" type="button" data-modal-close="editItemModal">Cancel</button>
          <button class="btn-primary" id="btnEditItemDone" type="button">Done</button>
        </div>
      </div>
    </div>
  </div>

	  <!-- Message modal -->
	  <div id="msgModal" class="modal-backdrop" aria-hidden="true">
	    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="msgTitle">
        <div class="modal-header">
          <div class="modal-title-wrap">
            <span class="modal-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
            </span>
            <div class="modal-title-text">
              <h2 id="msgTitle" class="modal-title">Message</h2>
            </div>
          </div>
          <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="msgModal" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-section">
            <div id="msgBody" class="muted" style="white-space:pre-wrap;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="footer-left">
            <button class="btn-secondary" id="btnMsgCopy" type="button" style="display:none">Copy</button>
          </div>
          <div class="footer-right">
            <button class="btn-secondary" id="btnMsgCancel" type="button" data-modal-close="msgModal">Cancel</button>
            <button class="btn-primary" id="btnMsgOk" type="button">OK</button>
          </div>
        </div>
	    </div>
	  </div>
	
  <!-- Confirm modal -->
  <div id="confirmModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 2 2 20h20L12 2z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="confirmTitle" class="modal-title">Confirm</h2>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="confirmModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div id="confirmBody" class="muted" style="white-space:pre-wrap;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnConfirmCancel" type="button">Cancel</button>
          <button class="btn-primary" id="btnConfirmOk" type="button">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import preview -->
  <div id="previewModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="previewModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="previewModalTitle" class="modal-title">Import Preview</h2>
            <div class="modal-subtitle">Review changes before applying.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="previewModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div id="previewInfo" class="muted"></div>
          <div class="scroll" style="max-height:50vh">
            <table style="width:100%;border-collapse:collapse;font-size:14px">
              <thead>
                <tr>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Item</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Description</th>
                  <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">Old Qty</th>
                  <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">New Qty</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Action</th>
                </tr>
              </thead>
              <tbody id="previewBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnPreviewCancel" type="button" data-modal-close="previewModal">Cancel</button>
          <button class="btn-primary" id="btnPreviewApply" type="button">Apply Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Qty entry modal -->
  <div id="qtyEntryModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="qtyEntryTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M4 7h16"></path>
              <path d="M4 12h16"></path>
              <path d="M4 17h16"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="qtyEntryTitle" class="modal-title">Set Qty</h2>
            <div id="qtyEntrySubtitle" class="modal-subtitle" style="display:none;"></div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="qtyEntryModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label for="qtyEntryInput">Quantity</label>
          <input id="qtyEntryInput" type="number" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" style="text-align:center;font-weight:900;font-size:22px;" />
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnQtyEntryCancel" type="button">Cancel</button>
          <button class="btn-primary" id="btnQtyEntryOk" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order modal (3-step wizard) -->
  <div id="orderModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="orderModalTitle" style="display:flex;flex-direction:column;">
      <div class="modal-header" style="flex-shrink:0;">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="orderModalTitle" class="modal-title">Create Order</h2>
            <div class="modal-subtitle">Build a cart and send the order.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="orderModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="order-wizard" style="flex:1;min-height:0;display:flex;flex-direction:column;">
        <!-- Progress Stepper -->
        <div class="order-wizard-stepper-wrap">
          <div class="order-wizard-stepper">
            <div class="order-wizard-step active" data-step="0" id="orderWizStep0">
              <span class="order-wizard-step-num"><span>1</span></span>
              <span class="order-wizard-step-label">Cart</span>
            </div>
            <div class="order-wizard-connector" id="orderWizConn1"></div>
            <div class="order-wizard-step" data-step="1" id="orderWizStep1">
              <span class="order-wizard-step-num"><span>2</span></span>
              <span class="order-wizard-step-label">Delivery</span>
            </div>
            <div class="order-wizard-connector" id="orderWizConn2"></div>
            <div class="order-wizard-step" data-step="2" id="orderWizStep2">
              <span class="order-wizard-step-num"><span>3</span></span>
              <span class="order-wizard-step-label">Review</span>
            </div>
          </div>
        </div>

        <!-- Tab Panels -->
        <div class="order-wizard-panels" style="flex:1;min-height:0;overflow:hidden;">
          <!-- Panel 1: Cart -->
          <div class="order-wizard-panel active" id="orderWizPanel0">
            <div id="orderBlockerBanner" class="order-info-box order-info-box--muted" style="display:none;">
              <span class="order-info-box-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
              </span>
              <div class="order-info-box-text order-info-box-text--stacked">
                <span id="orderBlockerBannerText">This draft order was created from job blockers. Quantities account for on-hand and incoming inventory.</span>
                <span id="orderBlockerBannerMeta" class="order-info-box-meta" style="display:none;"></span>
                <span id="orderBlockerBannerMeta2" class="order-info-box-meta" style="display:none;"></span>
              </div>
              <button class="order-info-box-dismiss" id="orderBlockerBannerDismiss" type="button" aria-label="Dismiss">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
            <div id="orderDraftSelector" class="order-draft-selector" style="display:none;">
              <label class="order-draft-label" for="orderDraftSelect">Draft orders</label>
              <select id="orderDraftSelect" class="order-draft-select"></select>
              <span id="orderDraftMeta" class="order-draft-meta"></span>
            </div>
            <div class="order-cart-search">
              <div class="input-wrap" style="max-width:100%;">
                <input id="orderSearch" type="text" placeholder="Search inventory to add itemsâ€¦" autocomplete="off" />
                <button class="icon-btn icon-btn--default clear-input-btn" id="btnClearOrderSearch" type="button" aria-label="Clear search" title="Clear search" style="display:none">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M18 6L6 18"></path>
                    <path d="M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
            </div>
            <div id="orderResultsBody" class="order-cart-results"></div>
            <div class="order-cart-section">
              <div class="order-cart-section-title">
                <div class="order-cart-section-title-left">
                  <span>Cart</span>
                  <span class="order-cart-section-count" id="orderCartCountBadge" style="display:none;">0 items</span>
                </div>
                <button type="button" id="btnResetOrderList" class="icon-btn icon-btn--default" aria-label="Clear cart" title="Clear cart">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                  </svg>
                </button>
              </div>
              <div id="orderLinesBody" class="order-cart-items"></div>
              <div id="orderLinesInfo" style="display:none;"></div>
            </div>
            <div class="order-cart-summary" id="orderCartSummary" style="display:none;">
              <span class="order-cart-summary-label">Items in cart</span>
              <span class="order-cart-summary-value" id="orderCartCount">0</span>
            </div>
            <div class="order-impact-card" id="orderImpactCard" style="display:none;"></div>
          </div>

          <!-- Panel 2: Delivery -->
          <div class="order-wizard-panel" id="orderWizPanel1">
            <div class="order-info-box">
              <span class="order-info-box-icon">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="12" cy="12" r="10"></circle>
                  <line x1="12" y1="16" x2="12" y2="12"></line>
                  <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
              </span>
              <span class="order-info-box-text">
                An email will be sent to the recipient with the order details and shipping information. They can reply directly to confirm or ask questions.
              </span>
            </div>
            <div class="section-title">Recipient</div>
            <div class="form-card">
              <div class="form-row">
                <div class="form-field full-width">
                  <label class="form-label" for="orderEmail">Email Address</label>
                  <input id="orderEmail" type="email" class="form-input" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />
                  <div id="orderEmailSuggest" class="order-delivery-suggestions" aria-label="Email suggestions"></div>
                </div>
              </div>
            </div>
            <div class="order-shipping-header">
              <div class="section-title">Ship To</div>
              <button class="btn-secondary order-shipping-manage" id="btnOrderShippingManage" type="button">Locations</button>
            </div>
            <select id="orderShippingAddress" class="form-input order-shipping-select" aria-hidden="true" tabindex="-1"></select>
            <div id="orderShippingOptions" class="order-shipping-options" role="listbox" aria-label="Shipping locations"></div>
          </div>

          <!-- Panel 3: Review -->
          <div class="order-wizard-panel" id="orderWizPanel2">
            <!-- Order Summary Card -->
            <div class="order-review-summary summary-card" id="orderReviewSummary">
              <div class="order-review-summary-row summary-row">
                <span class="order-review-summary-label summary-label">Items</span>
                <span class="order-review-summary-value summary-value highlight" id="orderReviewItemCount">0</span>
              </div>
              <div class="order-review-summary-row summary-row">
                <span class="order-review-summary-label summary-label">Recipient</span>
                <span class="order-review-summary-value summary-value" id="orderReviewRecipient">â€”</span>
              </div>
              <div class="order-review-summary-row summary-row">
                <span class="order-review-summary-label summary-label">Ship To</span>
                <span class="order-review-summary-value summary-value" id="orderReviewShipTo">â€”</span>
              </div>
              <div class="order-review-summary-row summary-row" id="orderReviewJobsRow" style="display:none;">
                <span class="order-review-summary-label summary-label" id="orderReviewJobsLabel">Related job</span>
                <span class="order-review-summary-value summary-value" id="orderReviewJobsValue">â€”</span>
              </div>
              <div class="order-review-summary-row summary-row" id="orderReviewShortfallRow" style="display:none;">
                <span class="order-review-summary-label summary-label">Shortfall</span>
                <span class="order-review-summary-value summary-value" id="orderReviewShortfallValue">â€”</span>
              </div>
            </div>
            <div class="order-review-shortfall-toggle toggle-option" id="orderReviewShortfallToggle" style="display:none;">
              <div class="toggle-row">
                <div class="toggle-content">
                  <div class="toggle-label">Attach shortfall to this order</div>
                  <div id="orderReviewShortfallHint" class="toggle-hint"></div>
                </div>
                <label class="toggle-wrap">
                  <input type="checkbox" id="orderShortfallAttachToggle" class="toggle-input" />
                  <span class="toggle-switch"></span>
                </label>
              </div>
            </div>
            <div class="order-review-section">
              <div class="section-title">Order Details</div>
              <div class="order-review-po-grid">
                <div>
                  <label class="form-label" for="orderCompanyPoNumber">Company PO (optional)</label>
                  <input id="orderCompanyPoNumber" class="form-input" type="text" placeholder="Company PO #" />
                </div>
                <div>
                  <label class="form-label" for="orderInternalPoNumber">Internal PO ID</label>
                  <input id="orderInternalPoNumber" class="form-input" type="text" readonly />
                </div>
              </div>
            </div>
            <div class="order-review-section">
              <label class="form-label" for="orderNotes">Notes (optional)</label>
              <textarea id="orderNotes" class="form-input textarea" rows="2" placeholder="Any notes for this orderâ€¦"></textarea>
            </div>
            <div class="order-review-section">
              <div class="order-review-preview">
                <div class="order-review-preview-header">
                  <span>Email Preview</span>
                </div>
                <div class="order-review-preview-body" id="orderPreviewHtml"></div>
              </div>
            </div>
            <input id="orderSubject" type="hidden" readonly />
          </div>
        </div>

        <!-- Wizard Footer -->
        <div class="order-wizard-footer">
          <div class="order-wizard-footer-left">
            <button class="order-wizard-btn order-wizard-btn-prev" id="btnOrderWizPrev" type="button" style="display:none;">Back</button>
            <button class="btn-ghost" id="btnOrderCopy" type="button" style="display:none;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;vertical-align:-2px;">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
              Copy
            </button>
            <button class="btn-ghost" id="btnOrderHistory" type="button" style="display:none;">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;vertical-align:-2px;">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              History
            </button>
          </div>
          <div class="order-wizard-footer-right">
            <button class="btn-secondary" id="btnOrderCancel" type="button" data-modal-close="orderModal">Cancel</button>
            <button class="order-wizard-btn order-wizard-btn-next" id="btnOrderWizNext" type="button">Next</button>
            <button class="order-wizard-btn order-wizard-btn-submit" id="btnOrderSubmit" type="button" style="display:none;">Submit Order</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shipping addresses modal -->
  <div id="shippingAddressModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="shippingAddressTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 17.5V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10.5"></path>
              <path d="M12 3v18"></path>
              <path d="M12 16l4-4"></path>
              <path d="M12 16l-4-4"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="shippingAddressTitle" class="modal-title">Shipping Addresses</h2>
            <div class="modal-subtitle">Manage saved shipping addresses for orders.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="shippingAddressModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Saved Addresses</div>
          <div style="display:flex;justify-content:flex-end;">
            <button class="btn-secondary" id="btnShippingAddressNew" type="button">Add New</button>
          </div>
          <div id="shippingAddressList" class="shipping-address-list" aria-live="polite"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Address Details</div>
          <div id="shippingAddressFormTitle" class="muted">Add Shipping Address</div>
          <div class="shipping-address-form">
            <label for="shippingAddressLabel">Label</label>
            <input id="shippingAddressLabel" type="text" placeholder="Main Warehouse" />
            <label for="shippingAddressValue">Address</label>
            <textarea id="shippingAddressValue" rows="3" placeholder="123 Main St&#10;City, ST 12345"></textarea>
            <div class="shipping-address-default">
              <label class="toggle-switch">
                <input id="shippingAddressDefault" type="checkbox" />
                <span class="toggle-slider"></span>
              </label>
              <label for="shippingAddressDefault" class="muted" style="font-size:13px;cursor:pointer;">Set as default</label>
            </div>
          </div>
          <div id="shippingAddressMsg" class="muted"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnShippingAddressClose" type="button" data-modal-close="shippingAddressModal">Cancel</button>
          <button class="btn-primary" id="btnShippingAddressSave" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Company locations modal -->
  <div id="companyLocationsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal locations-modal" role="dialog" aria-modal="true" aria-labelledby="companyLocationsTitle">
      <div class="modal-header locations-header">
        <div class="locations-header-left">
          <div class="locations-header-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
          </div>
          <h2 id="companyLocationsTitle" class="locations-header-title">Company Locations</h2>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="companyLocationsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body locations-body">
        <div id="locationsCompanySelector" class="locations-company-selector" hidden>
          <div class="locations-selector-header">
            <input type="text" id="locationsCompanySearch" placeholder="Search companies..." class="form-input">
          </div>
          <div id="locationsCompanyList" class="locations-company-list"></div>
        </div>
        <div id="locationsSelectedCompany" class="locations-selected-company locations-company-bar" hidden>
          <div class="locations-company-info">
            <span class="locations-company-label">Managing:</span>
            <span class="locations-company-name" id="locationsSelectedName"></span>
            <span class="env-badge locations-env-badge hidden" id="locationsSelectedEnvBadge">TEST</span>
          </div>
          <button type="button" id="btnLocationsClearCompany" class="btn-change-company">Change</button>
        </div>
        <div class="locations-toolbar">
          <span class="locations-count"><strong id="locationsCountValue">0</strong> <span id="locationsCountLabel">locations</span></span>
          <button class="icon-btn locations-add-btn" id="btnCompanyLocationNew" type="button" data-tooltip="Add Location" aria-label="Add Location">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </button>
        </div>
        <div class="locations-scroll">
          <div id="companyLocationsList" class="locations-cards" aria-live="polite"></div>
          <div id="companyLocationsMsg" class="muted" style="padding:16px 0;"></div>
        </div>
      </div>
      <div class="locations-legend">
        <div class="locations-legend-item">
          <span class="locations-legend-pip ship-to"></span>
          <span>Ship-To</span>
        </div>
        <div class="locations-legend-item">
          <span class="locations-legend-pip receive-at"></span>
          <span>Receive-At</span>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnCompanyLocationsClose" type="button" data-modal-close="companyLocationsModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="companyLocationsModal">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Company location editor modal -->
  <div id="companyLocationEditorModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal location-editor-modal" role="dialog" aria-modal="true" aria-labelledby="companyLocationEditorTitle">
      <!-- Header -->
      <div class="location-editor-header">
        <div class="location-editor-header-left">
          <div class="location-editor-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </div>
          <div class="location-editor-info">
            <h2 id="companyLocationEditorTitle" class="location-editor-title">Add Location</h2>
            <p class="location-editor-sub">Receiving and shipping address</p>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="companyLocationEditorModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <!-- Body -->
      <div class="location-editor-body">
        <div class="location-editor-grid">
          <div class="location-editor-field">
            <label for="companyLocationName">Location Name</label>
            <input id="companyLocationName" type="text" placeholder="Main Warehouse" autocapitalize="off" autocomplete="off" spellcheck="false" />
          </div>
          <div class="location-editor-field">
            <label for="companyLocationType">Type</label>
            <select id="companyLocationType">
              <option value="warehouse">Warehouse</option>
              <option value="yard">Yard</option>
              <option value="office">Office</option>
              <option value="job_site">Job Site</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="location-editor-field full">
            <label for="companyLocationAddress1">Address</label>
            <input id="companyLocationAddress1" type="text" placeholder="Start typing to search..." autocomplete="off" />
            <input id="companyLocationAddress1Value" type="hidden" />
            <input id="companyLocationPlaceId" type="hidden" />
            <input id="companyLocationAddressComponents" type="hidden" />
          </div>
        </div>
        <!-- Defaults Card -->
        <div class="location-editor-card">
          <div class="location-editor-card-header">
            <span class="location-editor-card-title">Default Settings</span>
          </div>
          <p class="location-editor-card-desc">Set this location as the default for orders</p>
          <div class="location-toggle-row">
            <span class="location-toggle-label">Default Ship-To</span>
            <label class="location-toggle-control">
              <input id="companyLocationDefaultShipTo" type="checkbox" class="location-toggle-input" />
              <span class="location-toggle-switch"></span>
            </label>
          </div>
          <div class="location-toggle-row">
            <span class="location-toggle-label">Default Receive-At</span>
            <label class="location-toggle-control">
              <input id="companyLocationDefaultReceiveAt" type="checkbox" class="location-toggle-input" />
              <span class="location-toggle-switch"></span>
            </label>
          </div>
        </div>
        <div id="companyLocationEditorMsg" class="location-editor-msg"></div>
      </div>
      <!-- Footer -->
      <div class="location-editor-footer">
        <button class="btn-secondary" id="btnCompanyLocationCancel" type="button" data-modal-close="companyLocationEditorModal">Cancel</button>
        <button class="btn-primary" id="btnCompanyLocationSave" type="button">Save Location</button>
      </div>
    </div>
  </div>

  <!-- Qty picker modal -->
  <div id="qtyPickerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="qtyPickerTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 12h18"></path>
              <path d="M3 6h18"></path>
              <path d="M3 18h18"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="qtyPickerTitle" class="modal-title">Order Qty</h2>
            <div class="modal-subtitle">Choose a quantity.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="qtyPickerModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="qty-picker-wheel-wrap">
            <div class="qty-picker-highlight"></div>
            <div class="qty-picker-wheel" id="qtyPickerWheel"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button type="button" class="btn-secondary" id="qtyPickerCancel">Cancel</button>
          <button type="button" class="btn-primary" id="qtyPickerDone">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Jobs list -->
  <div id="jobsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="jobsModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M16 6V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>
              <rect x="2" y="6" width="20" height="14" rx="2"></rect>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="jobsModalTitle" class="modal-title">Jobs</h2>
            <div class="modal-subtitle">Track commitments and inventory reservations.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="jobsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-toolbar">
        <span class="modal-toolbar-label">Job List</span>
        <div class="modal-toolbar-actions">
          <button class="btn-primary btn-with-icon" id="btnJobsCreate" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            <span>New Job</span>
          </button>
          <button class="btn-secondary btn-with-icon" id="btnJobsApproveReady" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="16 9 11 14 8 11"></polyline>
            </svg>
            <span>Approve-ready jobs</span>
            <span class="btn-count" id="btnJobsApproveReadyCount" style="display:none;">0</span>
          </button>
          <button class="btn-secondary" id="btnJobsRefresh" type="button">Refresh</button>
        </div>
      </div>
      <div class="modal-content">
        <div id="jobsList" aria-live="polite"></div>
        <div id="jobsMsg" class="muted"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnJobsClose" type="button" data-modal-close="jobsModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="jobsModal">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Approve-ready jobs -->
  <div id="approveReadyModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="approveReadyTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="16 9 11 14 8 11"></polyline>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="approveReadyTitle" class="modal-title">Jobs ready for approval</h2>
            <div class="modal-subtitle">Review each job before approving.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="approveReadyModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="approveReadyLoading" class="approve-ready-empty">Checking job readinessâ€¦</div>
        <div id="approveReadyEmpty" class="approve-ready-empty" style="display:none;">No jobs are ready for approval right now.</div>
        <div id="approveReadyList" class="approve-ready-list"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnApproveReadyClose" type="button" data-modal-close="approveReadyModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Job editor -->
  <div id="jobEditorModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md job-modal" role="dialog" aria-modal="true" aria-labelledby="jobEditorTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="4" width="18" height="18" rx="2"></rect>
              <path d="M9 2h6v4H9z"></path>
              <line x1="8" y1="11" x2="16" y2="11"></line>
              <line x1="8" y1="15" x2="16" y2="15"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="jobEditorTitle" class="modal-title">Job</h2>
            <div class="modal-subtitle" id="jobEditorSub">Bill of Materials</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="jobEditorModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="job-status-bar">
          <div class="job-status-name" id="jobStatusName">Untitled Job</div>
          <div id="jobStatusBadge" class="job-status-badge job-status-badge--draft">DRAFT</div>
          <div id="jobAutosaveStatus" class="job-autosave-status" aria-live="polite"></div>
        </div>
        <div class="job-progress-stepper" id="jobProgressStepper" aria-label="Job progress">
          <button class="job-step-item" type="button" data-job-step="details" aria-label="Details step">
            <span class="job-step-circle" data-job-step-circle="details">1</span>
            <span class="job-step-label" data-job-step-label="details">Details</span>
          </button>
          <span class="job-step-connector" data-job-step-connector="details" aria-hidden="true"></span>
          <button class="job-step-item" type="button" data-job-step="materials" aria-label="Materials step">
            <span class="job-step-circle" data-job-step-circle="materials">2</span>
            <span class="job-step-label" data-job-step-label="materials">Materials</span>
          </button>
          <span class="job-step-connector" data-job-step-connector="materials" aria-hidden="true"></span>
          <button class="job-step-item" type="button" data-job-step="execution" aria-label="Execution step">
            <span class="job-step-circle" data-job-step-circle="execution">3</span>
            <span class="job-step-label" data-job-step-label="execution">Execution</span>
          </button>
        </div>
        <div class="job-tabs" role="tablist" aria-label="Job tabs">
          <button class="job-tab" type="button" role="tab" id="jobTabBtnDetails" data-job-tab="details" aria-controls="jobTabDetails" aria-selected="true">
            <span>Details</span>
            <span id="jobTabDetailsCheck" class="job-tab-check" aria-hidden="true"></span>
          </button>
          <button class="job-tab" type="button" role="tab" id="jobTabBtnMaterials" data-job-tab="materials" aria-controls="jobTabMaterials" aria-selected="false">
            <span>Materials</span>
            <span id="jobTabMaterialsBadge" class="job-tab-badge">0</span>
          </button>
          <button class="job-tab" type="button" role="tab" id="jobTabBtnExecution" data-job-tab="execution" aria-controls="jobTabExecution" aria-selected="false">
            <span>Execution</span>
            <span id="jobTabExecutionBadge" class="job-tab-badge">0%</span>
          </button>
        </div>
        <div class="job-content">
          <section id="jobTabDetails" class="job-tab-panel" data-job-tab-panel="details" role="tabpanel" aria-labelledby="jobTabBtnDetails">
            <div class="job-field-group">
              <label class="job-field-label" for="jobNameInput">Job Name</label>
              <input id="jobNameInput" class="job-text-input" type="text" placeholder="Enter job name" />
            </div>
            <div class="job-field-row">
              <div class="job-field-half">
                <label class="job-field-label">Status</label>
                <div id="jobStatusPill" class="job-status-display job-status-badge--draft">Draft</div>
              </div>
              <div class="job-field-half">
                <label class="job-field-label">Created</label>
                <div id="jobCreatedMeta" class="job-date-display">--</div>
              </div>
            </div>
            <div class="job-field-group">
              <label class="job-field-label" for="jobNotesInput">Notes</label>
              <textarea id="jobNotesInput" class="job-text-area" placeholder="Add notes about this job"></textarea>
            </div>
            <div class="job-quick-stats">
              <div class="job-quick-stat-item" id="jobDetailsStatItemsWrap">
                <span id="jobDetailsStatItems" class="job-quick-stat-value">0</span>
                <span id="jobDetailsStatItemsLabel" class="job-quick-stat-label">BOM Items</span>
              </div>
              <div class="job-quick-stat-item" id="jobDetailsStatPlannedWrap">
                <span id="jobDetailsStatPlanned" class="job-quick-stat-value">0</span>
                <span id="jobDetailsStatPlannedLabel" class="job-quick-stat-label">Total Planned</span>
              </div>
              <div class="job-quick-stat-item" id="jobDetailsStatShortfallWrap">
                <span id="jobDetailsStatShortfall" class="job-quick-stat-value danger">0</span>
                <span id="jobDetailsStatShortfallLabel" class="job-quick-stat-label">Shortfall</span>
              </div>
            </div>
            <div id="jobCompletionTotalsNote" class="muted" style="margin-top:8px; display:none;"></div>
            <button class="btn-primary job-next-step-btn" id="btnJobNextMaterials" type="button">
              Continue to Materials
              <span class="job-next-step-icon" aria-hidden="true"></span>
            </button>
            <p class="job-step-hint" id="jobDetailsHint"></p>
          </section>
          <section id="jobTabMaterials" class="job-tab-panel" data-job-tab-panel="materials" role="tabpanel" aria-labelledby="jobTabBtnMaterials" style="display:none;">
            <div id="jobMaterialsReadinessBanner" class="job-materials-readiness-banner job-materials-readiness-banner--empty">
              <span id="jobMaterialsReadinessIcon" aria-hidden="true"></span>
              <div class="job-materials-readiness-banner-content">
                <div id="jobMaterialsReadinessText" class="job-materials-readiness-banner-text">Add materials to determine job readiness.</div>
                <div id="jobMaterialsReadinessSub" class="job-materials-readiness-banner-sub" style="display:none;"></div>
              </div>
            </div>
            <button class="btn-tertiary job-add-item-btn" id="btnJobAddItem" type="button">
              <span class="job-add-item-icon" aria-hidden="true"></span>
              Add Item
            </button>
            <div id="jobBomEmpty" class="job-empty-state" style="display:none;">
              <div class="job-empty-title">No BOM lines yet</div>
              <div class="job-empty-text">Add items from Inventory to build your bill of materials.</div>
            </div>
            <div id="jobBomTable"></div>
            <div id="jobBomMsg" class="muted" style="margin-top:8px;"></div>
            <button class="btn-primary job-next-step-btn" id="btnJobNextExecution" type="button" style="display:none;">
              Continue to Execution
              <span class="job-next-step-icon" aria-hidden="true"></span>
            </button>
            <p class="job-step-hint-info" id="jobMaterialsHint"></p>
          </section>
          <section id="jobTabExecution" class="job-tab-panel" data-job-tab-panel="execution" role="tabpanel" aria-labelledby="jobTabBtnExecution" style="display:none;">
            <div id="jobReopenBanner" class="job-reopen-banner" style="display:none;">
              This job was previously completed and reopened.
            </div>
            <div id="jobApprovalSection" class="job-action-card">
              <div class="job-action-card-header">
                <span class="job-action-card-icon" aria-hidden="true"></span>
                <span class="job-action-card-title">Approval</span>
              </div>
              <p class="job-action-card-desc">Approving a job reserves inventory for the planned items and locks in your material requirements.</p>
              <div id="jobShortfallInfoBox" class="job-shortfall-info-box" style="display:none;">
                <div class="job-shortfall-info-header">
                  <span class="job-shortfall-info-icon" aria-hidden="true"></span>
                  <span id="jobShortfallInfoTitle" class="job-shortfall-info-title">Items in shortfall</span>
                </div>
                <p class="job-shortfall-info-text">
                  <strong>Approval is blocked until shortfalls are resolved.</strong> Shortfalls track missing quantities without creating orders.
                </p>
                <div class="job-shortfall-benefits">
                  <div class="job-shortfall-benefit-item"><span class="job-shortfall-benefit-icon" aria-hidden="true"></span>Prevents duplicate ordering</div>
                  <div class="job-shortfall-benefit-item"><span class="job-shortfall-benefit-icon" aria-hidden="true"></span>Tracks missing quantities per item</div>
                  <div class="job-shortfall-benefit-item"><span class="job-shortfall-benefit-icon" aria-hidden="true"></span>Resolves automatically on successful allocation</div>
                </div>
                <div id="jobApprovalWarnings" class="job-shortfall-info-list" style="display:none;"></div>
              </div>
              <button class="btn-secondary job-approve-btn" id="btnJobApprove" type="button">Approve Job</button>
            </div>
            <div id="jobCompletionSection">
              <div class="job-progress-card" id="jobCompletionProgressCard">
                <div class="job-progress-header">
                  <span class="job-progress-title">Completion Progress</span>
                  <span id="jobCompletionPercent" class="job-progress-percent">0%</span>
                </div>
                <div class="job-progress-bar-bg">
                  <div id="jobCompletionProgressFill" class="job-progress-bar-fill" style="width:0%;"></div>
                </div>
                <div id="jobCompletionStats" class="job-progress-stats">0 / 0 items consumed</div>
              </div>
              <div id="jobActualsTable"></div>
              <div id="jobCompleteMsg" class="muted" style="margin-top:8px;"></div>
              <button class="btn-secondary job-complete-btn" id="btnJobComplete" type="button">Mark Job Complete</button>
            </div>
            <div id="jobCompletedState" class="job-completed-card" style="display:none;">
              <div class="job-completed-title">Job Completed</div>
              <div class="job-completed-text">All items have been consumed.</div>
            </div>
            <div id="jobCompletionSummary" class="job-completion-audit" style="display:none;">
              <div class="job-audit-title">Completion summary</div>
              <div id="jobCompletionSummaryContent"></div>
              <div class="job-field-group">
                <label class="job-field-label" for="jobCompletionNotesInput">Final execution notes</label>
                <textarea id="jobCompletionNotesInput" class="job-text-area" placeholder="Add final execution notes"></textarea>
              </div>
            </div>
            <div id="jobCompletionAudit" class="job-completion-audit" style="display:none;">
              <div class="job-audit-title">Completion audit</div>
              <div id="jobCompletionAuditContent"></div>
              <div id="jobCompletionAuditHint" class="job-audit-hint">This reflects what occurred at the time the job was completed.</div>
            </div>
            <div id="jobCompletionOrders" class="job-completion-audit" style="display:none;">
              <div class="job-audit-title">Supporting purchase orders</div>
              <div id="jobCompletionOrdersContent"></div>
            </div>
            <div id="jobReopenSection" class="job-reopen-section" style="display:none;">
              <button class="btn-secondary job-reopen-btn" id="btnJobReopen" type="button">Reopen job</button>
            </div>
            <div id="jobVoidedState" class="job-voided-card" style="display:none;">
              <div class="job-voided-title">Job Voided</div>
              <div class="job-voided-text">Reservations released and inventory returned.</div>
            </div>
            <div id="jobVoidSection" class="job-danger-zone">
              <span class="job-danger-zone-title">Void</span>
              <p class="job-danger-zone-desc">Voiding releases reservations and reverses consumption if needed.</p>
              <button class="btn-secondary btn-danger job-void-btn" id="btnJobVoid" type="button">Void Job</button>
            </div>
          </section>
        </div>
      </div>
      <div class="modal-footer job-footer job-footer--icons">
        <div class="footer-message">
          <div id="jobEditorMsg" class="muted"></div>
        </div>
        <div class="footer-actions">
          <button class="footer-icon-btn footer-icon-btn--cancel" id="btnJobEditorClose" type="button" data-modal-close="jobEditorModal" title="Cancel" aria-label="Cancel">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            <span class="footer-icon-label">Cancel</span>
          </button>
          <button class="footer-icon-btn footer-icon-btn--confirm" id="btnJobEditorDone" type="button" data-modal-close="jobEditorModal" title="Done" aria-label="Done">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
            <span class="footer-icon-label">Done</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add to Job modal (Redesigned v2) -->
  <div id="addToJobModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="addToJobTitle">
      <!-- Header -->
      <div class="modal-header" style="border-bottom:1px solid rgba(255,255,255,0.06);padding:24px 24px 20px;">
        <div class="modal-title-wrap">
          <span class="modal-icon" style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg, rgba(96,165,250,0.2), rgba(59,130,246,0.1));border:1px solid rgba(96,165,250,0.3);color:#60a5fa;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="addToJobTitle" class="modal-title">Add to Job</h2>
            <div class="modal-subtitle">Allocate inventory to a job</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="addToJobModal" aria-label="Close" style="width:36px;height:36px;border-radius:10px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Item Details Card -->
      <div class="atj-item-card">
        <div class="atj-item-name" id="atjItemName">Loading...</div>
        <div class="atj-item-desc" id="atjItemDesc"></div>
        <div class="atj-item-sku" id="atjItemSkuWrap" style="display:none;">SKU <span id="atjItemSku"></span></div>
        <!-- Stats Row -->
        <div class="atj-stats-row">
          <div class="atj-stat">
            <div class="atj-stat-value readonly-value" id="atjStatOnHand">0</div>
            <div class="atj-stat-label">On Hand</div>
          </div>
          <div class="atj-stat">
            <div class="atj-stat-value readonly-value" id="atjStatReserved">0</div>
            <div class="atj-stat-label">Reserved</div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="atj-tabs">
        <div class="atj-tabs-header">
          <button class="atj-tab-btn active" id="atjTabExisting" data-atj-tab="existing" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
            </svg>
            Existing Job
          </button>
          <button class="atj-tab-btn" id="atjTabNew" data-atj-tab="new" type="button">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            New Job
          </button>
        </div>
        <div class="atj-tab-content">
          <!-- Existing Job Panel -->
          <div class="atj-tab-panel active" id="atjPanelExisting" data-atj-panel="existing">
            <div class="atj-field">
              <label class="atj-label">Select Job</label>
              <div class="atj-dropdown" id="atjDropdown">
                <button class="atj-dropdown-trigger" id="atjDropdownTrigger" type="button">
                  <span id="atjSelectedText" class="placeholder">Choose a job...</span>
                  <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                </button>
                <div class="atj-dropdown-menu" id="atjDropdownMenu"></div>
              </div>
            </div>
          </div>
          <!-- New Job Panel -->
          <div class="atj-tab-panel" id="atjPanelNew" data-atj-panel="new">
            <div class="atj-field">
              <label class="atj-label" for="atjNewJobName">Job Name</label>
              <input type="text" class="atj-input" id="atjNewJobName" placeholder="e.g., Anderson Fence Build">
            </div>
            <div class="atj-field">
              <label class="atj-label" for="atjNewJobDesc">Description <span class="atj-label-optional">(optional)</span></label>
              <textarea class="atj-textarea" id="atjNewJobDesc" placeholder="Brief description of the job scope..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Quantity Section -->
      <div class="atj-qty-section">
        <div class="atj-qty-row">
          <div class="atj-qty-label-group">
            <div class="atj-qty-main-label">Quantity to Allocate</div>
            <div class="atj-qty-helper" id="atjQtyHelper">On Hand: 0</div>
          </div>
          <div class="atj-qty-wrapper">
            <button class="atj-qty-btn" id="atjQtyMinus" type="button" aria-label="Decrease quantity">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
            </button>
            <input type="number" class="atj-qty-input" id="atjQtyInput" value="1" min="1" max="9999">
            <button class="atj-qty-btn" id="atjQtyPlus" type="button" aria-label="Increase quantity">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Message -->
      <div class="atj-message" id="atjMessage"></div>

      <!-- Footer -->
      <div class="atj-footer">
        <button class="atj-cancel-btn" type="button" data-modal-close="addToJobModal">Cancel</button>
        <button class="atj-submit-btn" id="btnAddToJobConfirm" type="button">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Add to Job
        </button>
      </div>
    </div>
  </div>

  <!-- Job BOM Item Picker -->
  <div id="jobItemPickerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="jobItemPickerTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="jobItemPickerTitle" class="modal-title">Add Item to BOM</h2>
            <div class="modal-subtitle">Search inventory to add items.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="jobItemPickerModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <input id="jobItemPickerSearch" type="text" placeholder="Search itemsâ€¦" autocomplete="off" style="width:100%;margin-bottom:12px;" />
          <div id="jobItemPickerResults" class="job-item-picker-results" style="max-height:300px;overflow-y:auto;"></div>
        </div>
        <div class="form-section" id="jobItemPickerQtySection" style="display:none;">
          <div class="section-label">Selected Item</div>
          <div id="jobItemPickerSelected" class="muted" style="margin-bottom:8px;"></div>
          <label for="jobItemPickerQty">Quantity</label>
          <div class="qty-stepper qty-stepper--modal">
            <button class="qty-step" id="jobItemPickerQtyMinus" type="button" aria-label="Decrease qty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <input id="jobItemPickerQty" type="number" min="1" step="1" pattern="[0-9]*" inputmode="numeric" value="1" />
            <button class="qty-step" id="jobItemPickerQtyPlus" type="button" aria-label="Increase qty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnJobItemPickerCancel" type="button" data-modal-close="jobItemPickerModal">Cancel</button>
          <button class="btn-primary" id="btnJobItemPickerAdd" type="button" disabled>Add to BOM</button>
        </div>
      </div>
    </div>
  </div>

		  <!-- Order history -->
		  <div id="orderHistoryModal" class="modal-backdrop" aria-hidden="true">
		    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="orderHistoryTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                  <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                  <path d="M9 14l2 2 4-4"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="orderHistoryTitle" class="modal-title">Purchase Orders</h2>
              </div>
            </div>
            <div class="order-history-actions">
              <button class="icon-btn icon-btn--default" id="btnOrderHistoryDownload" type="button" title="Download CSV" aria-label="Download order history CSV">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
              </button>
              <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="orderHistoryModal" aria-label="Close">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
          <div class="order-history-tabs" id="orderHistoryTabs" role="tablist" aria-label="Order history tabs">
            <button class="order-history-tab is-active" type="button" data-order-history-tab="orders" role="tab" aria-selected="true">
              Orders
              <span id="orderHistoryOrdersBadge" class="order-history-tab-badge">0</span>
            </button>
            <button class="order-history-tab" type="button" data-order-history-tab="receipts" role="tab" aria-selected="false">
              Receipts
              <span id="orderHistoryReceiptsBadge" class="order-history-tab-badge is-amber">0</span>
            </button>
          </div>
          <div class="order-history-panels">
            <div class="order-history-panel is-active" data-order-history-panel="orders" role="tabpanel">
              <div class="order-history-toolbar">
                <div class="order-history-search-wrap">
                  <span class="order-history-search-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"></circle>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                  </span>
                  <input id="orderHistoryFilter" class="order-history-search-input" type="search" placeholder="Filter ordersâ€¦" autocomplete="off" />
                  <button class="icon-btn icon-btn--default clear-input-btn order-history-clear-btn" id="btnClearOrderHistoryFilter" type="button" aria-label="Clear history filter" title="Clear filter" style="display:none">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M18 6L6 18"></path>
                      <path d="M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
                <button class="order-history-toolbar-btn" id="btnOrderHistoryRefresh" type="button">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                    <path d="M21 3v5h-5"></path>
                  </svg>
                  <span>Refresh</span>
                </button>
              </div>
              <div class="order-history-body">
                <div id="orderHistoryList" class="history-list" aria-live="polite"></div>
              </div>
            </div>
            <div class="order-history-panel" data-order-history-panel="receipts" role="tabpanel">
              <div class="order-history-toolbar">
                <div class="order-history-search-wrap">
                  <span class="order-history-search-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <circle cx="11" cy="11" r="8"></circle>
                      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                  </span>
                  <input id="orderHistoryReceiptFilter" class="order-history-search-input" type="search" placeholder="Filter receiptsâ€¦" autocomplete="off" />
                </div>
              </div>
              <div class="order-history-body">
                <div id="orderHistoryReceiptsList" aria-live="polite"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="footer-right">
              <button class="btn-secondary" id="btnOrderHistoryClose" type="button" data-modal-close="orderHistoryModal">Done</button>
            </div>
          </div>
		    </div>
		  </div>

      <!-- Receive order -->
      <div id="receiveOrderModal" class="modal-backdrop" aria-hidden="true">
        <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="receiveOrderTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 16V8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v8"></path>
                  <path d="M3 10h18"></path>
                  <path d="M12 14v4"></path>
                  <path d="M9 17l3 3 3-3"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="receiveOrderTitle" class="modal-title">Receive Inventory</h2>
                <div class="modal-subtitle">Inventory is updated only when the receipt is received.</div>
              </div>
            </div>
            <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="receiveOrderModal" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body receive-modal-body">
            <div class="receive-meta-bar">
              <div class="receive-meta-left">
                <div class="receive-meta-row">
                  <span id="receiveReceiptStatus" class="receive-status-pill" data-status="draft">Draft</span>
                  <span id="receiveReceiptMode" class="receive-mode-pill">Quick Add</span>
                </div>
                <div id="receiveReceiptId" class="receive-receipt-id"></div>
              </div>
            </div>
            <div class="receive-tabs-container">
              <div class="receive-tabs" id="receiveTabs" role="tablist" aria-label="Receive tabs">
                <button class="receive-tab active" type="button" data-receive-tab="quick" role="tab" aria-selected="true">Quick Add</button>
                <button class="receive-tab" type="button" data-receive-tab="scanned" role="tab" aria-selected="false">
                  Scanned
                  <span id="receiveTabScannedCount" class="receive-tab-badge receive-tab-badge--amber" style="display:none;">0</span>
                </button>
                <button class="receive-tab" type="button" data-receive-tab="po" role="tab" aria-selected="false">PO Receipt</button>
              </div>
            </div>
            <div class="receive-tab-panels">
              <div class="receive-tab-panel is-active" data-receive-panel="quick" role="tabpanel">
                <div class="receive-tab-body">
                  <div class="form-section" id="receiveManualSection">
                    <div class="section-label">Manual Receive</div>
                    <label for="receiveManualSearch">Search inventory</label>
                    <div class="input-wrap" style="max-width:100%;">
                      <input id="receiveManualSearch" type="search" placeholder="Search items by name or SKUâ€¦" autocomplete="off" />
                      <button class="icon-btn icon-btn--default clear-input-btn" id="btnReceiveManualClear" type="button" aria-label="Clear manual search" title="Clear search" style="display:none">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                          <path d="M18 6L6 18"></path>
                          <path d="M6 6l12 12"></path>
                        </svg>
                      </button>
                    </div>
                    <div id="receiveManualResults" class="receive-search-results"></div>
                  </div>
                </div>
              </div>
              <div class="receive-tab-panel" data-receive-panel="scanned" role="tabpanel">
                <div class="receive-tab-body">
                  <div id="receiveScannedList" class="receive-scanned-list">
                    <div id="receiveForwardingHint" class="receive-forward-hint"></div>
                    <div id="receiveDraftInbox" class="receive-draft-inbox" style="display:none;"></div>
                  </div>
                </div>
              </div>
              <div class="receive-tab-panel" data-receive-panel="po" role="tabpanel">
                <div class="receive-tab-body">
                  <div id="receivePoEmpty" class="receive-po-empty" style="display:none;">
                    <div class="receive-po-empty-title">Select a purchase order</div>
                    <div class="receive-po-empty-text">Choose an open purchase order to receive against.</div>
                  </div>
                  <div id="receivePoList" class="receive-po-list"></div>
                  <div class="form-section" id="receiveOrderSummarySection">
                    <div class="section-label">Order Summary</div>
                    <div id="receiveOrderMeta" class="receive-order-meta"></div>
                    <div id="receiveOrderSummary" class="receive-summary"></div>
                  </div>
                  <div class="form-section" id="receiveOrderReceiptsSection">
                    <div class="section-label">Receipts</div>
                    <div id="receiveOrderReceipts" class="receive-receipts"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="receive-detail-panel" id="receiveDetailPanel">
              <div class="review-header" id="receiveScannedHeader" style="display:none;">
                <button class="review-back" type="button" id="btnReceiveScannedBack" aria-label="Back to receipts">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <polyline points="15 18 9 12 15 6"></polyline>
                  </svg>
                </button>
                <div class="review-title-wrap">
                  <div class="review-vendor" id="receiveScannedTitleMain">Receipt review</div>
                  <div class="review-meta">
                    <span id="receiveScannedTitleSub">Review before inventory is updated.</span>
                    <span id="receiveReceiptSourceBadge" class="review-source-badge" style="display:none;">Email</span>
                  </div>
                </div>
                <div class="review-total" id="receiveScannedTotal"></div>
              </div>
              <div class="review-body" id="receiptReviewSection" style="display:none;">
                <div class="receipt-summary">
                  <div class="summary-field">
                    <div class="summary-label">Vendor</div>
                    <div class="summary-value summary-value--editable">
                      <input id="receiveReceiptVendor" type="text" placeholder="Vendor name" />
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
                      </svg>
                    </div>
                  </div>
                  <div class="summary-field">
                    <div class="summary-label">Date</div>
                    <div class="summary-value summary-value--editable summary-value--date">
                      <input id="receiveReceiptDate" type="date" />
                      <svg class="date-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                      </svg>
                    </div>
                  </div>
                  <div class="summary-field">
                    <div class="summary-label">Total</div>
                    <div class="summary-value summary-value--editable">
                      <input id="receiveReceiptTotal" type="number" inputmode="decimal" step="0.01" min="0" placeholder="0.00" />
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
                      </svg>
                    </div>
                  </div>
                </div>
                <div class="po-link-section">
                  <div class="po-link-card po-link-card--none" id="receivePoLinkCard">
                    <div class="po-link-icon">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                      </svg>
                    </div>
                    <div class="po-link-info">
                      <div class="po-link-title" id="receivePoLinkTitle">No PO linked</div>
                      <div class="po-link-desc" id="receivePoLinkDesc">Link to a purchase order to auto-reconcile</div>
                    </div>
                    <button class="po-link-action" id="receivePoLinkAction" type="button" data-receipt-link-po>Link PO</button>
                  </div>
                </div>
                <div class="parsed-items-section" id="receiveParsedSection">
                  <div class="section-header">
                    <span class="section-label">Parsed Items</span>
                    <span class="section-count" id="receiveParsedCount">0 items</span>
                  </div>
                  <div class="parsed-items" id="receiptParsedLines"></div>
                </div>
                <div class="notes-section">
                  <button class="notes-toggle" type="button" id="receiveReceiptNotesToggle" aria-expanded="false">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M12 20h9"></path>
                      <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"></path>
                    </svg>
                    Add notes
                    <svg class="notes-toggle-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                  </button>
                  <div class="notes-content" id="receiveReceiptNotesContent">
                    <textarea class="notes-textarea" id="receiveReceiptNotes" rows="2" placeholder="Optional notes for this receipt..."></textarea>
                  </div>
                </div>
                <div class="info-banner">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                  </svg>
                  <span>Review before confirming. Inventory is only updated when you complete the receipt.</span>
                </div>
              </div>
              <details id="receiveReceiptRaw" class="receive-raw" style="display:none;">
                <summary>Receipt text (email)</summary>
                <pre id="receiveReceiptRawText"></pre>
              </details>
              <div id="receiveReceiptAttachments" class="receive-attachments" style="display:none;">
                <div class="receive-attachments-header">
                  <div class="receive-attachments-title">Receipt attachments</div>
                  <div id="receiveReceiptAttachmentsGate" class="receive-attachments-gate" style="display:none;">Receipt scans/storage on Pro plans.</div>
                </div>
                <div id="receiveReceiptAttachmentsList" class="receive-attachments-list"></div>
              </div>
              <div class="form-section" id="receiveLinesSection">
                <div class="section-label">Lines</div>
                <div id="receiveOrderLines" class="receive-lines" aria-live="polite"></div>
                <div id="receiveOrderWarning" class="receive-order-warning" role="status"></div>
              </div>
            </div>
          </div>
          <div class="modal-footer receive-footer receive-footer--icons">
            <div class="footer-message">
              <div id="receiveOrderMsg" class="muted"></div>
              <div class="receive-plan-upgrade" id="receivePlanUpgrade" style="display:none;">
                <span class="muted">Upgrade to enable receipt-based receiving.</span>
                <button class="btn-tertiary btn-sm" type="button" data-receipt-upgrade>Upgrade to Pro</button>
              </div>
            </div>
            <div class="footer-actions">
              <button class="footer-icon-btn footer-icon-btn--cancel" id="btnReceiveOrderCancel" type="button" data-modal-close="receiveOrderModal" title="Cancel">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                <span class="footer-icon-label">Cancel</span>
              </button>
              <button class="footer-icon-btn footer-icon-btn--save" id="btnReceiveOrderSave" type="button" title="Save Draft">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                  <polyline points="17 21 17 13 7 13 7 21"></polyline>
                  <polyline points="7 3 7 8 15 8"></polyline>
                </svg>
                <span class="footer-icon-label">Save</span>
              </button>
              <button class="footer-icon-btn footer-icon-btn--confirm" id="btnReceiveOrderComplete" type="button" title="Confirm &amp; Receive">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                <span class="footer-icon-label">Receive</span>
              </button>
            </div>
          </div>
        </div>
      </div>

		  <!-- Trash -->
		  <div id="trashModal" class="modal-backdrop" aria-hidden="true">
		    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="trashModalTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                  <path d="M10 11v6"></path>
                  <path d="M14 11v6"></path>
                  <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="trashModalTitle" class="modal-title">Trash</h2>
                <div class="modal-subtitle">Restore or permanently remove deleted items.</div>
              </div>
            </div>
            <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="trashModal" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-section">
              <div class="section-label">Deleted Items</div>
              <div class="trash-controls">
                <input id="trashFilter" type="text" placeholder="Filter deleted itemsâ€¦" autocomplete="off" />
                <button class="btn-secondary" id="btnTrashReload" type="button">Refresh</button>
              </div>
              <div id="trashList" class="trash-list" aria-live="polite"></div>
              <div id="trashMsg" class="muted" style="margin-top:8px;"></div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="footer-right">
              <button class="btn-secondary" id="btnTrashClose" type="button" data-modal-close="trashModal">Cancel</button>
              <button class="btn-primary" type="button" data-modal-close="trashModal">Done</button>
            </div>
          </div>
		    </div>
		  </div>

		  <!-- Inventory report -->
		  <div id="reportModal" class="modal-backdrop" aria-hidden="true">
		    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="reportModalTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M3 3v18h18"></path>
                  <path d="M18 17V9"></path>
                  <path d="M13 17V5"></path>
                  <path d="M8 17v-3"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="reportModalTitle" class="modal-title">Inventory Report</h2>
                <div class="modal-subtitle">Review low stock and inventory status.</div>
              </div>
            </div>
            <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="reportModal" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-section">
              <div class="section-label">Report</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                <button class="icon-btn icon-btn--default" id="btnReportShare" type="button" title="Share report" aria-label="Share report">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"></path>
                    <polyline points="16 6 12 2 8 6"></polyline>
                    <line x1="12" y1="2" x2="12" y2="15"></line>
                  </svg>
                </button>
                <button class="icon-btn icon-btn--default" id="btnReportDownload" type="button" title="Download CSV" aria-label="Download report CSV">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                </button>
              </div>

			      <div class="report-progress" id="reportProgress" style="display:none;" aria-live="polite">
			        <div class="report-progress-label">
			          <span id="reportProgressLabel">Analyzing Low Stock Items...</span>
			          <span class="report-progress-value" id="reportProgressValue">0%</span>
			        </div>
			        <div class="report-progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
			          <div class="report-progress-bar" id="reportProgressBar" style="width:0%"></div>
			        </div>
			      </div>

			      <div id="reportContent" style="display:none;">
				      <div class="report-metrics" aria-label="Report summary">
				        <div class="report-metric"><div class="muted">Total Items</div><div class="val" id="reportMetricTotalItems">0</div></div>
				        <div class="report-metric"><div class="muted">Total Qty</div><div class="val" id="reportMetricTotalQty">0</div></div>
				      </div>

				      <div class="order-pill-container report-pill-container" id="reportOrderPillContainer" style="display:none;">
				        <div class="order-pill" id="reportOrderBadge" role="status" aria-live="polite">
				          <span class="order-pill-value" id="reportOrderCount">0</span>
				          <span class="order-pill-label">Items in Cart</span>
				          <div class="order-pill-actions">
				            <button class="order-pill-btn" id="reportOrderPillOpen" type="button" title="Create Order" aria-label="Create Order">
				              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"></circle><circle cx="19" cy="21" r="1"></circle><path d="M2.05 2.05h2l2.66 12.6a2 2 0 0 0 2 1.6h9.7a2 2 0 0 0 2-1.6l1.65-8.6H6"></path></svg>
				            </button>
				            <button class="order-pill-btn order-pill-btn--clear" id="reportOrderPillClear" type="button" title="Clear Cart" aria-label="Clear Cart" data-order-reset>
				              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="m15 9-6 6"></path><path d="m9 9 6 6"></path></svg>
				            </button>
				          </div>
				        </div>
				      </div>
		
					      <details class="report-section" id="reportLowStockSection">
					        <summary class="report-summary">
					          <div class="report-summary-left">
					            <h3><span class="led-dot led-dot--amber"></span>Low Stock Items <span class="report-count" id="reportLowStockCount">(0)</span></h3>
					          </div>
					          <div class="report-summary-right">
					            <button type="button" class="icon-btn icon-btn--success" id="btnReportBatchOrder" title="Add all low stock items to cart" aria-label="Add all low stock items to shopping cart">
					              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					                <circle cx="9" cy="21" r="1"></circle>
					                <circle cx="20" cy="21" r="1"></circle>
					                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
					                <path d="M16 3v6"></path>
					                <path d="M13 6h6"></path>
					              </svg>
					            </button>
					            <span class="report-chevron" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                      </span>
					          </div>
					        </summary>
					        <div class="report-list" id="reportLowStockList"></div>
				      </details>

				      <details class="report-section" id="reportExemptSection">
				        <summary class="report-summary">
				          <div class="report-summary-left">
				            <h3><span class="led-dot led-dot--cyan"></span>Exempt from Batch Re-order <span class="report-count" id="reportExemptCount">(0)</span></h3>
				          </div>
				          <div class="report-summary-right">
				            <span class="report-chevron" aria-hidden="true">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                      </svg>
                    </span>
				          </div>
				        </summary>
				        <div class="report-list" id="reportExemptList"></div>
				      </details>

				      <details class="report-section" id="reportInventorySection">
				        <summary class="report-summary">
				          <div class="report-summary-left">
				            <h3>Current Inventory <span class="report-count" id="reportInStockCount">(0)</span></h3>
				          </div>
				          <div class="report-summary-right">
				            <span class="report-chevron" aria-hidden="true">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                      </svg>
                    </span>
				          </div>
				        </summary>
				        <div class="report-list" id="reportList" aria-live="polite"></div>
				      </details>
			      </div>
			    </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnReportClose" type="button" data-modal-close="reportModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="reportModal">Done</button>
        </div>
      </div>
    </div>
  </div>

		  <!-- Email inventory report -->
		  <div id="reportEmailModal" class="modal-backdrop" aria-hidden="true">
		    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="reportEmailTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                  <path d="m22 7-8.97 5.7a1 1 0 0 1-1.06 0L2 7"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="reportEmailTitle" class="modal-title">Email Inventory Report</h2>
                <div class="modal-subtitle">Send the report to a recipient.</div>
              </div>
            </div>
            <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="reportEmailModal" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-section">
              <div class="section-label">Message</div>
              <label for="reportEmailTo">To</label>
              <input id="reportEmailTo" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />
              <label for="reportEmailSubject">Subject</label>
              <input id="reportEmailSubject" type="text" placeholder="Inventory Report" />
            </div>
            <div class="form-section">
              <div class="section-label">Preview</div>
              <div class="order-preview">
                <div id="reportEmailPreview" class="order-preview-html"></div>
              </div>
              <div id="reportEmailMsg" class="muted"></div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="footer-left">
              <button class="btn-secondary" id="btnReportEmailCopy" type="button">Copy</button>
            </div>
            <div class="footer-right">
              <button class="btn-secondary" id="btnReportEmailClose" type="button" data-modal-close="reportEmailModal">Cancel</button>
              <button class="btn-primary" id="btnReportEmailSend" type="button">Send</button>
            </div>
          </div>
		    </div>
		  </div>

  <!-- Auth modal -->
  <div id="authModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="authModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="11" width="18" height="11" rx="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="authModalTitle" class="modal-title">Sign In</h2>
            <div class="modal-subtitle">Invite-only access. Contact your admin for an account.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="authModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label for="authEmail">Email</label>
          <input id="authEmail" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email" />
          <label for="authPassword" id="authPasswordLabel">Password</label>
          <input id="authPassword" type="password" placeholder="Password" autocomplete="current-password" />
          <div class="auth-actions">
            <button class="auth-link" id="btnAuthForgot" type="button">Forgot password?</button>
          </div>
          <div id="authMsg" class="muted"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" type="button" data-modal-close="authModal">Cancel</button>
          <button class="btn-primary" id="btnAuthSubmit" type="button">Sign In</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite accept modal -->
  <div id="inviteAcceptModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="inviteAcceptTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 17v-6"></path>
              <path d="M9 14h6"></path>
              <circle cx="12" cy="12" r="10"></circle>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="inviteAcceptTitle" class="modal-title">Set Your Password</h2>
            <div class="modal-subtitle">Create a password to activate your invited account.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="inviteAcceptModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label for="inviteAcceptPassword">New Password</label>
          <input id="inviteAcceptPassword" type="password" placeholder="New password" autocomplete="new-password" />
          <label for="inviteAcceptPasswordConfirm">Confirm Password</label>
          <input id="inviteAcceptPasswordConfirm" type="password" placeholder="Confirm password" autocomplete="new-password" />
          <div class="auth-actions">
            <button class="auth-link" id="btnInviteAcceptSignIn" type="button">Already have an account? Sign in</button>
          </div>
          <div id="inviteAcceptMsg" class="muted"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnInviteAcceptClose" type="button" data-modal-close="inviteAcceptModal">Cancel</button>
          <button class="btn-primary" id="btnInviteAcceptSubmit" type="button">Create Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Password reset modal -->
  <div id="resetModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="resetModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 12a9 9 0 1 0 9-9"></path>
              <path d="M3 4v4h4"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="resetModalTitle" class="modal-title">Reset Password</h2>
            <div class="modal-subtitle">Create a new password for your account.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="resetModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label for="resetPassword">New Password</label>
          <input id="resetPassword" type="password" placeholder="New password" autocomplete="new-password" />
          <label for="resetPasswordConfirm">Confirm Password</label>
          <input id="resetPasswordConfirm" type="password" placeholder="Confirm password" autocomplete="new-password" />
          <div id="resetMsg" class="muted"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnResetClose" type="button" data-modal-close="resetModal">Cancel</button>
          <button class="btn-primary" id="btnResetSubmit" type="button">Update Password</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite modal -->
  <div id="inviteModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="inviteModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="8.5" cy="7" r="4"></circle>
              <line x1="20" y1="8" x2="20" y2="14"></line>
              <line x1="17" y1="11" x2="23" y2="11"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="inviteModalTitle" class="modal-title">Invite User</h2>
            <div class="modal-subtitle">Send an invite to a new team member.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="inviteModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section" id="inviteSection">
          <div class="section-label">Invite Details</div>
          <div class="invite-grid">
            <div id="inviteCompanyRow">
              <label for="inviteCompany">Company</label>
              <select id="inviteCompany" aria-label="Invite company"></select>
            </div>
            <div>
              <label for="inviteEmail">Email</label>
              <input id="inviteEmail" type="email" placeholder="newuser@example.com" autocomplete="email" inputmode="email" />
            </div>
            <div>
              <label for="inviteRole">Role</label>
              <select id="inviteRole">
                <option value="member">Member</option>
                <option value="admin">Admin</option>
                <option value="viewer">Viewer</option>
              </select>
            </div>
          </div>
          <div class="invite-link-row" id="inviteLinkRow">
            <input id="inviteLink" type="text" readonly />
            <button class="btn-secondary" id="btnInviteCopy" type="button">Copy</button>
          </div>
          <div id="inviteMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnInviteClose" type="button" data-modal-close="inviteModal">Cancel</button>
          <button class="btn-primary" id="btnInviteSend" type="button">Send Invite</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User management modal -->
  <div id="userMgmtModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="userMgmtTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="8.5" cy="7" r="4"></circle>
              <line x1="20" y1="8" x2="20" y2="14"></line>
              <line x1="17" y1="11" x2="23" y2="11"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="userMgmtTitle" class="modal-title">Manage Users</h2>
            <div class="modal-subtitle">Invite and manage access across companies.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="userMgmtModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Users</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn-secondary" id="btnUserMgmtAdd" type="button">
              <svg class="user-mgmt-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
              Add User
            </button>
            <button class="btn-secondary" id="btnUserMgmtRefresh" type="button">Refresh</button>
          </div>
          <div class="user-mgmt-controls" id="userMgmtControls">
            <div>
              <label for="userMgmtCompany">Company</label>
              <select id="userMgmtCompany" aria-label="Manage users company"></select>
            </div>
          </div>
          <div id="userMgmtList" class="user-mgmt-list" aria-live="polite"></div>
          <div id="pendingInvitesMount">
            <div id="pendingInvitesSection" class="pending-invites-section">
              <div class="section-divider"></div>
              <div class="pending-invites-header">
                <h3>Pending Invites</h3>
                <button class="btn-tertiary btn-sm" id="btnPendingInvitesRefresh" type="button">Refresh Invites</button>
              </div>
              <div id="pendingInvitesList" class="pending-invites-list" aria-live="polite"></div>
              <div id="pendingInvitesMsg" class="muted" style="margin-top:8px;"></div>
            </div>
          </div>
          <div id="userMgmtMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnUserMgmtClose" type="button" data-modal-close="userMgmtModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="userMgmtModal">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Role manager modal -->
  <div id="roleManagerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="roleManagerTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 2l7 4v6c0 5-3.5 9.7-7 10-3.5-.3-7-5-7-10V6l7-4z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="roleManagerTitle" class="modal-title">Role Manager</h2>
            <div class="modal-subtitle">Configure role permissions. Super user permissions are fixed.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="roleManagerModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Permissions</div>
          <div class="role-manager-table-wrap">
            <table class="role-manager-table">
              <thead>
                <tr>
                  <th>Permission</th>
                  <th>Admin</th>
                  <th>Member</th>
                  <th>Viewer</th>
                </tr>
              </thead>
              <tbody id="roleManagerBody"></tbody>
            </table>
          </div>
          <div id="roleManagerMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnRoleManagerClose" type="button" data-modal-close="roleManagerModal">Cancel</button>
          <button class="btn-primary" id="btnRoleManagerSave" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Audit log modal -->
  <div id="auditModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="auditTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="auditTitle" class="modal-title">Audit Log</h2>
            <div class="modal-subtitle">Review recent system activity and data changes.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="auditModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Filters</div>
          <div class="audit-filters">
            <input id="auditSearchFilter" type="text" placeholder="Filter audit logâ€¦" autocomplete="off" />
            <select id="auditTableFilter">
              <option value="">All tables</option>
              <option value="inventory_items">Inventory Items</option>
              <option value="orders">Orders</option>
              <option value="company_members">Company Members</option>
              <option value="invitations">Invitations</option>
            </select>
            <select id="auditActionFilter">
              <option value="">All actions</option>
              <option value="INSERT">INSERT</option>
              <option value="UPDATE">UPDATE</option>
              <option value="DELETE">DELETE</option>
              <option value="RESTORE">RESTORE</option>
              <option value="BULK_DELETE">BULK_DELETE</option>
            </select>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Entries</div>
          <div id="auditList" class="audit-list" aria-live="polite"></div>
          <div id="auditMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <button class="btn-tertiary" id="btnAuditDownload" type="button" title="Download audit log CSV">Download CSV</button>
        </div>
        <div class="footer-right">
          <button class="btn-secondary" id="btnAuditRefresh" type="button">Refresh</button>
          <button class="btn-secondary" id="btnAuditClose" type="button" data-modal-close="auditModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Snapshots modal -->
  <div id="snapshotsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="snapshotsTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
              <path d="M3 5v14c0 1.7 4 3 9 3s9-1.3 9-3V5"></path>
              <path d="M3 12c0 1.7 4 3 9 3s9-1.3 9-3"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="snapshotsTitle" class="modal-title">Inventory Snapshots</h2>
            <div class="modal-subtitle">Browse point-in-time inventory captures.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="snapshotsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Snapshots</div>
          <div id="snapshotsList" class="snapshots-list" aria-live="polite"></div>
          <div id="snapshotPreview" class="snapshot-preview" style="display:none;">
            <div class="snapshot-preview-header">
              <button class="btn-tertiary btn-sm" id="btnSnapshotBack" type="button">Back</button>
              <div class="snapshot-preview-title" id="snapshotPreviewTitle"></div>
            </div>
            <div class="snapshot-preview-meta" id="snapshotPreviewMeta"></div>
            <div class="snapshot-preview-table scroll">
              <table class="metrics-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>SKU</th>
                    <th>Qty</th>
                    <th>Category ID</th>
                    <th>Location ID</th>
                  </tr>
                </thead>
                <tbody id="snapshotPreviewBody"></tbody>
              </table>
            </div>
          </div>
          <div id="snapshotsMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnSnapshotsClose" type="button" data-modal-close="snapshotsModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Metrics modal -->
  <div id="metricsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="metricsTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="metricsTitle" class="modal-title">Metrics Dashboard</h2>
            <div class="modal-subtitle">Track inventory activity and operational trends.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="metricsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Filters</div>
          <div class="metrics-toolbar">
            <select id="metricsRange" aria-label="Metrics date range">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
            </select>
            <select id="metricsView" aria-label="Metrics view" style="display:none;">
              <option value="company">Company View</option>
              <option value="platform">Platform View</option>
            </select>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Dashboard</div>
          <div id="metricsContent" class="metrics-content" aria-live="polite"></div>
          <div id="metricsMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnMetricsClose" type="button" data-modal-close="metricsModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="profileTitle" class="modal-title">Account</h2>
            <div class="modal-subtitle">Update your profile and notification preferences.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="profileModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Profile</div>
          <div class="muted" id="profileEmailDisplay"></div>
          <div class="edit-grid-2">
            <div>
              <label for="profileFirstName">First Name</label>
              <input id="profileFirstName" type="text" placeholder="First" autocomplete="given-name" />
            </div>
            <div>
              <label for="profileLastName">Last Name</label>
              <input id="profileLastName" type="text" placeholder="Last" autocomplete="family-name" />
            </div>
          </div>
          <div>
            <label for="profilePhone">Phone</label>
            <input id="profilePhone" type="tel" placeholder="(555) 555-5555" autocomplete="tel" inputmode="tel" />
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Preferences</div>
          <div style="display:flex;align-items:center;gap:12px;margin-top:6px;">
            <label class="toggle-switch">
              <input id="profileSilenceLowStockAlerts" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
            <label for="profileSilenceLowStockAlerts" class="muted" style="font-size:13px;cursor:pointer;">Hide low stock LED indicators</label>
          </div>
        </div>
        <div id="profileMsg" class="muted" style="margin-top:10px;"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <button class="btn-secondary" id="btnSignOut" type="button">Sign Out</button>
        </div>
        <div class="footer-right">
          <button class="btn-secondary" id="btnProfileClose" type="button" data-modal-close="profileModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Subscription Manager modal -->
  <div id="subscriptionManagerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="subscriptionManagerTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="2" y="5" width="20" height="14" rx="2"></rect>
              <line x1="2" y1="10" x2="22" y2="10"></line>
              <line x1="7" y1="15" x2="7.01" y2="15"></line>
              <line x1="11" y1="15" x2="13" y2="15"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="subscriptionManagerTitle" class="modal-title">Subscription Manager</h2>
            <div class="modal-subtitle">Review and update company tier settings.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="subscriptionManagerModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section" id="tierOverrideSection">
          <div class="section-label">Subscription</div>
          <div class="role-request-meta" id="tierOverrideCompany"></div>
          <div class="tier-admin-grid">
            <div class="tier-admin-stat">
              <div class="tier-admin-label">Base Tier</div>
              <div class="tier-admin-value" id="tierBaseValue">â€”</div>
            </div>
            <div class="tier-admin-stat">
              <div class="tier-admin-label">Active Override</div>
              <div class="tier-admin-value" id="tierOverrideValue">â€”</div>
            </div>
            <div class="tier-admin-stat">
              <div class="tier-admin-label">Effective Tier</div>
              <div class="tier-admin-value" id="tierEffectiveValue">â€”</div>
            </div>
            <div class="tier-admin-stat">
              <div class="tier-admin-label">Override Expires</div>
              <div class="tier-admin-value" id="tierOverrideExpiresValue">â€”</div>
            </div>
          </div>
        </div>
        <div class="section-divider" id="tierOverrideDivider"></div>
        <div class="form-section">
          <div class="section-label">Base Tier</div>
          <label for="tierBaseSelect">Change Base Subscription</label>
          <select id="tierBaseSelect" aria-label="Select base subscription tier"></select>
          <div class="tier-admin-actions">
            <button class="btn-secondary" id="btnTierBaseSave" type="button">Save Base Tier</button>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Temporary Access</div>
          <label for="tierOverrideTierSelect">Grant Temporary Access</label>
          <select id="tierOverrideTierSelect" aria-label="Select override tier"></select>
          <label for="tierOverrideEndsAt">Access Ends At (optional)</label>
          <input id="tierOverrideEndsAt" type="datetime-local" />
          <div class="tier-admin-actions">
            <button class="btn-secondary" id="btnTierOverrideGrant" type="button">Grant Temporary Access</button>
            <button class="btn-secondary" id="btnTierOverrideRevoke" type="button">Revoke Override</button>
          </div>
          <div id="tierOverrideMsg" class="muted" style="margin-top:4px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnSubscriptionManagerClose" type="button" data-modal-close="subscriptionManagerModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Company modal (admin-only) -->
  <div id="manageCompanyModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="manageCompanyTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="manageCompanyTitle" class="modal-title">Manage Company</h2>
            <div class="modal-subtitle">Company-level settings and tools.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="manageCompanyModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section manage-company-section">
          <div class="section-label">Receipt Ingestion</div>
          <div class="manage-company-row">
            <div class="manage-company-label">Forward receipts to</div>
            <div class="manage-company-value">
              <span id="manageCompanyReceiptAddress" class="manage-company-address">receipts+<company_slug>@inbound.inventorymanager.app</span>
              <button class="btn-tertiary btn-sm" type="button" data-copy-receipt-address>Copy</button>
            </div>
            <div class="muted">Forward store receipts here to prepare them for inventory receiving.</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" type="button" data-modal-close="manageCompanyModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage companies (super user only) -->
  <div id="advancedCompanyModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md manage-companies-modal" role="dialog" aria-modal="true" aria-labelledby="advancedCompanyTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 21h18"></path>
              <path d="M5 21V7l7-4 7 4v14"></path>
              <path d="M9 21V9h6v12"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="advancedCompanyTitle" class="modal-title">Manage Companies</h2>
            <div class="manage-companies-header-meta">
              <span class="manage-companies-badge">Super User</span>
            </div>
          </div>
        </div>
        <div class="modal-header-actions">
          <div class="manage-companies-menu" id="manageCompaniesMenu">
            <button class="icon-btn icon-btn--default" id="manageCompaniesMenuBtn" type="button" aria-haspopup="menu" aria-expanded="false" aria-label="Company actions menu">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="4" y1="6" x2="20" y2="6"></line>
                <line x1="4" y1="12" x2="20" y2="12"></line>
                <line x1="4" y1="18" x2="20" y2="18"></line>
              </svg>
            </button>
            <div class="manage-companies-menu-dropdown" id="manageCompaniesMenuDropdown" role="menu" aria-label="Company actions">
              <button class="manage-companies-menu-item" type="button" role="menuitem" id="btnCreateNewCompany">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <line x1="12" y1="5" x2="12" y2="19"></line>
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Create New Company</span>
              </button>
              <button class="manage-companies-menu-item" type="button" role="menuitem" id="btnExportCompanies">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Export Companies</span>
              </button>
              <button class="manage-companies-menu-item" type="button" role="menuitem" id="btnRefreshCompanies">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 2v6h-6"></path>
                  <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                  <path d="M3 22v-6h6"></path>
                  <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                </svg>
                <span>Refresh List</span>
              </button>
            </div>
          </div>
          <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="advancedCompanyModal" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      <div class="modal-body">
        <div class="form-section filters-section">
          <div class="section-label">Filters</div>
          <div class="manage-companies-filters advanced-switcher-controls">
            <div class="field">
              <label for="advancedCompanySearch">Search</label>
              <input id="advancedCompanySearch" type="text" placeholder="Company name or exact company ID" />
            </div>
            <div class="field">
              <label for="advancedCompanyTypeFilter">Environment</label>
              <select id="advancedCompanyTypeFilter">
                <option value="">All</option>
                <option value="production">Production</option>
                <option value="test">Test</option>
              </select>
            </div>
          </div>
        </div>
        <div class="form-section results-section">
          <div class="section-label">Results</div>
          <div id="advancedCompanyResults" class="manage-companies-results advanced-switcher-results"></div>
          <div id="advancedCompanyMsg" class="manage-companies-hint advanced-switcher-hint"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="advancedCompanyClose" type="button" data-modal-close="advancedCompanyModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Inventory seeding (super user only) -->
  <div id="seedInventoryModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="seedInventoryTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <path d="M3.27 6.96 12 12.01l8.73-5.05"></path>
              <path d="M12 22.08V12"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="seedInventoryTitle" class="modal-title">Seed Inventory</h2>
            <div class="modal-subtitle">Copy items from another company into this workspace.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="seedInventoryModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Target</div>
          <label>Company</label>
          <div id="seedInventoryTargetName" class="add-job-item"></div>
          <div id="seedInventoryTargetId" class="advanced-switcher-id"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Source</div>
          <label for="seedInventorySource">Source company</label>
          <select id="seedInventorySource"></select>
          <label for="seedInventoryDedupe">Dedupe key</label>
          <select id="seedInventoryDedupe">
            <option value="sku" selected>SKU</option>
            <option value="name">Name</option>
          </select>
          <div class="muted">Selected fields replace existing values. Empty source fields are skipped.</div>
          <div id="seedInventoryMsg" class="muted" style="margin-top:6px;"></div>
        </div>
        <div class="form-section">
          <div class="seed-options-header">
            <div class="section-label">Seed Options</div>
            <button class="btn-tertiary btn-sm" id="seedInventorySelectAll" type="button">Select all</button>
          </div>
          <div id="seedInventoryFields" class="seed-field-list"></div>
          <div id="seedInventoryInfo" class="muted" style="margin-top:6px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnSeedInventoryCancel" type="button" data-modal-close="seedInventoryModal">Cancel</button>
          <button class="btn-primary" id="btnSeedInventoryConfirm" type="button">Seed Inventory</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Company environment (super user only) -->
  <div id="companyEnvironmentModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="companyEnvironmentTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 2l3 6 6 .9-4.5 4.3 1.1 6.3L12 16.8 6.4 19.5l1.1-6.3L3 8.9 9 8z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="companyEnvironmentTitle" class="modal-title">Set Environment</h2>
            <div class="modal-subtitle">Test enables destructive actions. Production blocks them.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="companyEnvironmentModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Target</div>
          <label>Company</label>
          <div id="companyEnvironmentTargetName" class="add-job-item"></div>
          <div id="companyEnvironmentTargetId" class="advanced-switcher-id"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Environment</div>
          <label for="companyEnvironmentSelect">Set environment</label>
          <select id="companyEnvironmentSelect">
            <option value="production">Production</option>
            <option value="test">Test</option>
          </select>
          <div id="companyEnvironmentNote" class="muted" style="margin-top:6px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnCompanyEnvironmentCancel" type="button" data-modal-close="companyEnvironmentModal">Cancel</button>
          <button class="btn-primary" id="btnCompanyEnvironmentConfirm" type="button">Save Environment</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Rename Company Modal (super user only) -->
  <div id="renameCompanyModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="renameCompanyTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
              <path d="m15 5 4 4"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="renameCompanyTitle" class="modal-title">Rename Company</h2>
            <div class="modal-subtitle" id="renameCompanySubtitle">Update the company name.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="renameCompanyModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="field">
          <label for="renameCompanyName">Company Name</label>
          <input id="renameCompanyName" type="text" placeholder="Enter new company name" maxlength="100" />
        </div>
        <div id="renameCompanyMsg" class="form-message"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnRenameCompanyCancel" type="button" data-modal-close="renameCompanyModal">Cancel</button>
          <button class="btn-primary" id="btnRenameCompanyConfirm" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Company Users (super user only) -->
  <div id="manageCompanyUsersModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md manage-sub-modal" role="dialog" aria-modal="true" aria-labelledby="manageCompanyUsersTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="manageCompanyUsersTitle" class="modal-title">Manage Users</h2>
            <div class="modal-subtitle" id="manageCompanyUsersSubtitle"></div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="manageCompanyUsersModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="manage-sub-toolbar">
          <label class="manage-sub-select-all">
            <input type="checkbox" id="manageUsersSelectAll" />
            <span>Select All</span>
          </label>
          <button class="btn-danger btn-sm" id="btnDeleteSelectedUsers" type="button" disabled>Delete Selected</button>
        </div>
        <div id="manageCompanyUsersResults" class="manage-sub-results"></div>
        <div id="manageCompanyUsersMsg" class="manage-sub-hint"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" type="button" data-modal-close="manageCompanyUsersModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Company Inventory (super user only) -->
  <div id="manageCompanyInventoryModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md manage-sub-modal" role="dialog" aria-modal="true" aria-labelledby="manageCompanyInventoryTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="m7.5 4.27 9 5.15"></path>
              <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"></path>
              <path d="m3.3 7 8.7 5 8.7-5"></path>
              <path d="M12 22V12"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="manageCompanyInventoryTitle" class="modal-title">Manage Inventory</h2>
            <div class="modal-subtitle" id="manageCompanyInventorySubtitle"></div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="manageCompanyInventoryModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="manage-sub-toolbar">
          <div class="manage-sub-toolbar-left">
            <input type="text" id="manageInventorySearch" class="manage-sub-search" placeholder="Search items..." />
            <label class="manage-sub-select-all">
              <input type="checkbox" id="manageInventorySelectAll" />
              <span>Select All</span>
            </label>
          </div>
          <button class="btn-danger btn-sm" id="btnDeleteSelectedInventory" type="button" disabled>Delete Selected</button>
        </div>
        <div id="manageCompanyInventoryResults" class="manage-sub-results"></div>
        <div id="manageCompanyInventoryMsg" class="manage-sub-hint"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" type="button" data-modal-close="manageCompanyInventoryModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Company provisioning dashboard (super user only) -->
  <div id="provisioningModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="provisioningTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="provisioningTitle" class="modal-title">Company Provisioning</h2>
            <div class="modal-subtitle">Super-user only. Each step is explicit and recorded server-side.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="provisioningModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Company Creation</div>
          <div class="provisioning-grid">
            <div>
              <label for="provisioningCompanyName">Company Name</label>
              <input id="provisioningCompanyName" type="text" placeholder="New Company" />
            </div>
            <div>
              <label for="provisioningCompanySlug">Slug</label>
              <input id="provisioningCompanySlug" type="text" placeholder="new-company" />
              <div class="provisioning-note">Auto-generated from name; edit if needed.</div>
            </div>
            <div>
              <label for="provisioningOnboardingState">Onboarding State</label>
              <input id="provisioningOnboardingState" type="text" value="UNINITIALIZED" readonly />
              <div class="provisioning-note">Set automatically for new companies.</div>
            </div>
            <div>
              <label for="provisioningEnvironmentType">Environment Type</label>
              <select id="provisioningEnvironmentType">
                <option value="production" selected>Production</option>
                <option value="test">Test</option>
              </select>
              <div class="provisioning-note" id="provisioningEnvironmentNote" style="display:none;">
                Non-production companies are not intended for real work.
              </div>
            </div>
            <div>
              <div class="provisioning-field-toggle" style="margin-top:18px;">
                <label class="toggle-switch">
                  <input id="provisioningIncludeActor" type="checkbox" checked />
                  <span class="toggle-slider"></span>
                </label>
                <label for="provisioningIncludeActor" class="muted" style="font-size:13px;cursor:pointer;">Add me as admin</label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-label">Initial User Assignment (optional)</div>
          <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap;">
            <div class="provisioning-note" style="margin-top:0;">Attach existing users and assign roles.</div>
            <button class="btn-tertiary btn-sm" id="btnProvisioningAddUser" type="button">Add User</button>
          </div>
          <div id="provisioningUsersList" aria-live="polite"></div>
          <div class="provisioning-warning">Cross-company memberships are allowed for test or super_user accounts.</div>
        </div>

        <div class="form-section">
          <div class="section-label">Subscription Tier (optional)</div>
          <div class="provisioning-grid">
            <div>
              <label for="provisioningTierOverride">Subscription Tier Override</label>
              <select id="provisioningTierOverride">
                <option value="" selected>No override (starter)</option>
                <option value="starter">starter</option>
                <option value="professional">professional</option>
                <option value="business">business</option>
                <option value="enterprise">enterprise</option>
              </select>
              <div class="provisioning-note">Overrides effective tier; base remains starter.</div>
            </div>
            <div>
              <label for="provisioningTierEndsAt">Override Ends At (optional)</label>
              <input id="provisioningTierEndsAt" type="datetime-local" />
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-label">Inventory Seeding (optional)</div>
          <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap;">
            <div class="provisioning-note" style="margin-top:0;">Seed inventory from an existing company (explicit and auditable).</div>
            <button class="btn-tertiary btn-sm" id="btnProvisioningRefreshCompanies" type="button">Refresh Companies</button>
          </div>
          <div class="provisioning-field-toggle" style="margin-top:8px;">
            <label class="toggle-switch">
              <input id="provisioningSeedToggle" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
            <label for="provisioningSeedToggle" class="muted" style="font-size:13px;cursor:pointer;">Seed inventory from existing company</label>
          </div>
          <div id="provisioningSeedFields" style="display:none;">
            <div class="provisioning-grid">
              <div>
                <label for="provisioningSeedSource">Source Company</label>
                <select id="provisioningSeedSource"></select>
              </div>
              <div>
                <label for="provisioningSeedDedupe">Dedupe Key</label>
                <select id="provisioningSeedDedupe">
                  <option value="sku" selected>sku</option>
                  <option value="name">name</option>
                </select>
              </div>
              <div>
                <label for="provisioningSeedMode">Mode</label>
                <input id="provisioningSeedMode" type="text" value="items_only" readonly />
              </div>
            </div>
            <div class="provisioning-warning">Warning: Seeding copies item definitions across companies. This action is explicit and auditable.</div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-label">Finalize</div>
          <div style="display:flex;justify-content:flex-end;">
            <button class="btn-tertiary btn-sm" id="btnProvisioningReset" type="button">Reset Form</button>
          </div>
          <div id="provisioningSummary" class="provisioning-summary" aria-live="polite"></div>
        </div>
        <div id="provisioningMsg" class="muted" style="margin-top:8px;"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnProvisioningClose" type="button" data-modal-close="provisioningModal">Close</button>
          <button class="btn-primary" id="btnProvisioningRun" type="button">Provision Company</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Diagnostics modal (super user only) -->
  <div id="diagnosticsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="diagnosticsTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="diagnosticsTitle" class="modal-title">Diagnostics</h2>
            <div class="modal-subtitle">Simulation and inspection only. No data writes.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="diagnosticsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Role & Tier Simulation</div>
          <div class="muted">Session-scoped only. Does not affect backend authorization.</div>
          <label for="diagRoleSelect">Simulated Role</label>
          <select id="diagRoleSelect">
            <option value="">Use current role</option>
            <option value="super_user">super_user</option>
            <option value="admin">admin</option>
            <option value="member">member</option>
            <option value="viewer">viewer</option>
          </select>
          <label for="diagTierSelect" style="margin-top:8px;">Simulated Subscription Tier</label>
          <select id="diagTierSelect">
            <option value="">Use current tier</option>
            <option value="starter">Starter</option>
            <option value="professional">Professional</option>
            <option value="business">Business</option>
            <option value="enterprise">Enterprise</option>
          </select>
          <div class="diag-actions">
            <button class="btn-secondary" id="diagApply" type="button">Apply Simulation</button>
            <button class="btn-secondary" id="diagReset" type="button">Reset Simulation</button>
          </div>
          <div id="diagSimMsg" class="muted"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Enforcement Inspection</div>
          <div id="diagChecks"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Metric Preview (Read-Only)</div>
          <label for="diagMetricId">Metric ID</label>
          <input id="diagMetricId" type="text" placeholder="INVENTORY_TURNOVER" />
          <label for="diagMetricContext" style="margin-top:8px;">Time Context (JSON)</label>
          <textarea id="diagMetricContext" rows="3" placeholder='{"period_start":"2025-01-01","period_end":"2025-01-31"}'></textarea>
          <label for="diagMetricInputs" style="margin-top:8px;">Inputs (JSON)</label>
          <textarea id="diagMetricInputs" rows="4" placeholder='{"COGS":100000,"AverageInventory":50000}'></textarea>
          <div class="diag-actions">
            <div class="muted" id="diagMetricTierHint"></div>
            <button class="btn-secondary" id="diagMetricRun" type="button">Run Preview</button>
          </div>
          <pre id="diagMetricOutput" class="diag-output"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="diagClose" type="button" data-modal-close="diagnosticsModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="./src/utils.js"></script>

		  <script>
		    // UUID helper (works on older mobile browsers and non-HTTPS dev hosts)
		    let _nativeRandomUUID = null;
		    try{
		      if(typeof crypto !== 'undefined' && crypto && typeof crypto.randomUUID === 'function'){
		        const candidate = crypto.randomUUID.bind(crypto);
		        candidate(); // ensure it works (some browsers expose but throw on insecure contexts)
		        _nativeRandomUUID = candidate;
		      }
		    }catch(e){
		      _nativeRandomUUID = null;
		    }
		    function randomUUID(){
		      if(_nativeRandomUUID){
		        try{ return _nativeRandomUUID(); }catch(e){}
		      }
		      const cryptoObj = (typeof crypto !== 'undefined') ? crypto : null;
		      const bytes = new Uint8Array(16);
		      if(cryptoObj && typeof cryptoObj.getRandomValues === 'function'){
		        try{
		          cryptoObj.getRandomValues(bytes);
		        }catch(e){
		          for(let i=0;i<bytes.length;i++) bytes[i] = Math.floor(Math.random()*256);
		        }
		      }else{
		        for(let i=0;i<bytes.length;i++) bytes[i] = Math.floor(Math.random()*256);
		      }
		      // RFC4122 v4
		      bytes[6] = (bytes[6] & 0x0f) | 0x40;
		      bytes[8] = (bytes[8] & 0x3f) | 0x80;
		      const hex = Array.from(bytes, b => b.toString(16).padStart(2,'0'));
		      return `${hex[0]}${hex[1]}${hex[2]}${hex[3]}-${hex[4]}${hex[5]}-${hex[6]}${hex[7]}-${hex[8]}${hex[9]}-${hex[10]}${hex[11]}${hex[12]}${hex[13]}${hex[14]}${hex[15]}`;
		    }
		    if(!_nativeRandomUUID){
		      try{
		        const cryptoObj = (typeof crypto !== 'undefined') ? crypto : null;
		        if(cryptoObj) cryptoObj.randomUUID = randomUUID;
		      }catch(e){}
		      try{
		        if(typeof Crypto !== 'undefined' && Crypto.prototype){
		          Object.defineProperty(Crypto.prototype, 'randomUUID', { value: randomUUID, configurable: true, writable: true });
		        }
		      }catch(e){}
		    }

	    // ========================
	    // State & persistence
	    // ========================
    const DB_KEY='inv.single.inline.mobile.v1';
    const state={
      items:[],
      updatedAt:null,
      _filter:'',
      _sort:{col:'name', dir:'asc'},
      _rowTapPref:'',
      _order:{
        lines:[],
        email:'',
        companyPoNumber:'',
        internalPoNumber:'',
        subject:'',
        notes:'',
        contactName:'',
        search:'',
        shippingAddressId:'',
        shippingAddressSnapshot:null,
        shortfall:null,
        shortfallAttached:false,
        source:'',
        relatedJobId:'',
        supplierId:'',
        supplierName:'',
        blockerBannerDismissed:false,
        blockerMultiSupplier:false,
        blockerHasUnknownSupplier:false,
        draftId:''
      },
      _orderDraftQueue:[],
      _vendorsById:new Map(),
      _orderHistoryRows:[],
      _orderHistoryById:new Map(),
      _orderHistoryFilter:'',
      _orderHistoryStatusFilter:[],
      _orderHistoryTab:'orders',
      _orderHistoryExpanded:new Set(),
      _orderHistoryReceipts:[],
      _orderHistoryReceiptsCount:0,
      _orderHistoryReceiptsFilter:'',
      _orderHistoryReceiptsLoaded:false,
      _orderHistoryLinesByPo:new Map(),
      _receiveOrder:null,
      _draftEmailReceipts:[],
      _draftEmailReceiptsCount:0,
      _draftEmailReceiptsLoaded:false,
      _receiveDraftSelected:new Set(),
      _draftEmailReceiptsNotified:false,
      _shippingAddresses:[],
	      _shippingAddressById:new Map(),
	      _shippingAddressEditing:null,
      _orderShippingOptions:[],
      _orderShippingById:new Map(),
      _orderCommittedByItemId:new Map(),
      _orderJobCountByItemId:new Map(),
      _orderDraftJobCountByItemId:new Map(),
      _orderCommitmentKey:'',
      _orderCommitmentLoading:false,
      _orderCommitmentError:'',
      _orderLineExpanded:new Set(),
      _orderJobAllocationsByItemId:new Map(),
      _orderDraftJobAllocationsByItemId:new Map(),
      _companyLocations:[],
      _companyLocationById:new Map(),
      _companyLocationEditing:null,
      _companyLocationsContext:null,
	      _trashItems:[],
	      _trashFilter:'',
      _auditRows:[],
      _auditTableFilter:'',
      _auditActionFilter:'',
      _auditSearch:'',
      _userMgmtRows:[],
      _pendingInvites:[],
      _pendingInviteBusy:{},
      _snapshots:[],
      _snapshotPreview:null,
      _metrics:null,
      _roleConfigs:{},
      _roleChanges:{},
      _impersonationRole:'super_user',
      _impersonationPermissions:null,
      _tierDetails:null,
      _tierDetailsCompanyId:null,
      _advancedCompanies:[],
      _provisioningUsers:[],
      _provisioningCompanies:[],
      _provisioningExistingUsers:[],
      _provisioningExistingUsersLoading:false,
      _provisioningExistingUsersError:'',
      _provisioningBusy:false,
      _provisioningResult:null,
      _advancedSearch:'',
      _advancedType:'',
      _defaultCompanyId:null,
      _diagRole:'',
      _diagTier:'',
      _diagPermissions:null,
      _onboardingState:null,
      _onboardingStep:null,
      _onboardingLoading:false,
      _onboardingPlan:null,
      _onboardingSource:null,
      _onboardingError:'',
      _signupError:'',
      _onboardingAllowSuper:false,
      _onboardingGatePrimary:null,
      _onboardingGateSecondary:null,
      _jobs:[],
      _jobsById:new Map(),
      _jobBomByJobId:new Map(),
      _jobActualsByJobId:new Map(),
      _jobEditor:null,
      _jobEditorBusy:false,
      _jobEditorTab:'details',
      _jobEditorExpandedItemId:'',
      _jobEditorActualsDraft:new Map(),
      _jobEditorIncomingMap:new Map(),
      _jobApprovalShortages:[],
      _jobReopenedById:new Set(),
      _approveReadyJobs:[],
      _approveReadyLoading:false,
      _approveReadyError:'',
      _jobsLoading:false,
      _jobsExpanded:new Set(),
      _jobReservedMap:new Map(),
      _jobAllocationsByJobId:new Map(),
      _jobShortfallsByJobId:new Map(),
      _jobReadinessByJobId:new Map(),
      _shortfallOrdersById:new Map(),
      _shortfallOrdersLoaded:false,
      _addToJob:null,
      _addToJobBusy:false,
      _seedInventory:null,
      _seedInventoryBusy:false,
      _companyEnvironment:null,
      _companyEnvironmentBusy:false,
      _renameCompany:null,
      _renameCompanyBusy:false,
      _advancedSearchDebounce:null,
      _companySwitcherMode:'basic',
      _profileTab:'',
      _advancedInventoryCounts:{},
      _advancedTotalOnHand:{},
      _companyOverflowOpenId:null,
      _manageUsersCompany:null,
      _manageUsersData:[],
      _manageUsersSelected:new Set(),
      _manageUsersBusy:false,
      _manageInventoryCompany:null,
      _manageInventoryData:[],
      _manageInventorySelected:new Set(),
      _manageInventoryBusy:false,
      _manageInventorySearch:''
    };
    const APP_VERSION = '2.0.0';
    const PROFILE_TAB_STORAGE_KEY = 'profile.activeTab';
    const MENU_TAB_STORAGE_KEY = 'menu.activeTab';

    const $ = (id) => document.getElementById(String(id).replace(/^#/, ''));
    const IMUtils = window.IMUtils || {};
    const toKey = IMUtils.toKey || ((s) => (s || '').trim().toUpperCase());
    const toInt = IMUtils.toInt || ((v, f = 0) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return f;
      const i = Math.floor(n);
      return i < 0 ? f : i;
    });
    const toQty = (v, f = 0) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return f;
      return n < 0 ? f : n;
    };
    function formatQty(value){
      const n = Number(value);
      if(!Number.isFinite(n)) return '0';
      if(Math.abs(n - Math.round(n)) < 1e-9) return String(Math.round(n));
      const fixed = n.toFixed(2);
      return fixed.replace(/\.00$/, '').replace(/(\.\d)0$/, '$1');
    }
    const ICONS = {
      chevronRight:
        '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="m9 18 6-6-6-6"></path>'+
        '</svg>',
      chevronDown:
        '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="m6 9 6 6 6-6"></path>'+
        '</svg>',
      eye:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M2 12s3-6 10-6 10 6 10 6-3 6-10 6-10-6-10-6Z"></path>'+
          '<circle cx="12" cy="12" r="3"></circle>'+
        '</svg>',
      pencil:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>'+
          '<path d="m15 5 4 4"></path>'+
        '</svg>',
      checkCircle:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<circle cx="12" cy="12" r="10"></circle>'+
          '<path d="m9 12 2 2 4-4"></path>'+
        '</svg>',
      check:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M20 6 9 17l-5-5"></path>'+
        '</svg>',
      xCircle:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<circle cx="12" cy="12" r="10"></circle>'+
          '<path d="m15 9-6 6"></path>'+
          '<path d="m9 9 6 6"></path>'+
        '</svg>',
      briefcasePlus:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<rect x="2" y="7" width="20" height="14" rx="2"></rect>'+
          '<path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>'+
          '<line x1="12" y1="12" x2="12" y2="16"></line>'+
          '<line x1="10" y1="14" x2="14" y2="14"></line>'+
        '</svg>',
      alertTriangle:
        '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>'+
          '<line x1="12" y1="9" x2="12" y2="13"></line>'+
          '<line x1="12" y1="17" x2="12.01" y2="17"></line>'+
        '</svg>',
      info:
        '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<circle cx="12" cy="12" r="10"></circle>'+
          '<line x1="12" y1="16" x2="12" y2="12"></line>'+
          '<line x1="12" y1="8" x2="12.01" y2="8"></line>'+
        '</svg>',
      columns:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<rect x="3" y="3" width="7" height="18"></rect>'+
          '<rect x="14" y="3" width="7" height="18"></rect>'+
        '</svg>',
      plus:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<line x1="12" y1="5" x2="12" y2="19"></line>'+
          '<line x1="5" y1="12" x2="19" y2="12"></line>'+
        '</svg>',
      shoppingCart:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<circle cx="8" cy="21" r="1"></circle>'+
          '<circle cx="19" cy="21" r="1"></circle>'+
          '<path d="M2.05 2.05h2l2.66 12.6a2 2 0 0 0 2 1.6h9.7a2 2 0 0 0 2-1.6l1.65-8.6H6"></path>'+
          '<path class="order-check" d="m9 11 2 2 4-4"></path>'+
        '</svg>',
      shoppingBag:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6z"></path>'+
          '<path d="M3 6h18"></path>'+
          '<path d="M16 10a4 4 0 0 1-8 0"></path>'+
          '<path class="order-check" d="m9 14 2 2 4-4"></path>'+
        '</svg>',
      moreHorizontal:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<circle cx="12" cy="12" r="1"></circle>'+
          '<circle cx="19" cy="12" r="1"></circle>'+
          '<circle cx="5" cy="12" r="1"></circle>'+
        '</svg>',
      package:
        '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>'+
          '<path d="M3.27 6.96 12 12.01l8.73-5.05"></path>'+
          '<path d="M12 22.08V12"></path>'+
        '</svg>',
      trash2:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<polyline points="3 6 5 6 21 6"></polyline>'+
          '<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>'+
          '<path d="M10 11v6"></path>'+
          '<path d="M14 11v6"></path>'+
          '<path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>'+
        '</svg>',
      loader2:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M21 12a9 9 0 1 1-9-9"></path>'+
        '</svg>',
      logIn:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>'+
          '<polyline points="10 17 15 12 10 7"></polyline>'+
          '<line x1="15" y1="12" x2="3" y2="12"></line>'+
        '</svg>',
    };
    const INVENTORY_ROW_DISPLAY_KEY = 'tableRowDisplay:inventory_list';
    const INVENTORY_ROW_TAP_KEY = 'tableRowTap:inventory_list';
    const INVENTORY_ROW_TAP_DEFAULT = 'expand_details';
    const INVENTORY_ROW_TAP_OPTIONS = new Set(['expand_details', 'add_to_order', 'add_to_job', 'edit_item']);
    const INVENTORY_QUICK_FILTER_KEY = 'inv.quickFilter.inventory_list';
    const INVENTORY_QUICK_FILTERS = new Set(['all', 'in_stock', 'low_stock', 'out_of_stock']);
    window.invQuickFilter = 'all';
    const INVENTORY_LEGACY_COLUMNS_KEY = 'tableColumns:inventory_list';
    const INVENTORY_ANCHOR_KEY = 'item';
    const INVENTORY_ACTIONS_DEF = {
      id:'actions',
      key:'actions',
      label:'Actions',
      type:'actions',
      locked:true,
      lock:true,
      minWidth:192,
      minCellWidth:192,
      dataCol:'actions',
      sortable:false,
      align:'right',
      thClass:'actions'
    };
    const INVENTORY_COLUMN_DEFS = [
      { id:'item', key:'item', label:'Item', type:'item', locked:true, lock:true, minWidth:180, minCellWidth:180, maxWidth:360, defaultVisible:true, dataCol:'name', sortable:true, align:'left', optional:false },
      { id:'sku', key:'sku', label:'SKU', type:'text', locked:false, lock:false, minWidth:140, minCellWidth:140, maxWidth:180, defaultVisible:true, dataCol:'sku', sortable:true, align:'left', optional:true },
      { id:'on_hand', key:'on_hand', label:'On Hand', type:'number', locked:false, lock:false, minWidth:110, minCellWidth:110, defaultVisible:true, dataCol:'qty', sortable:true, align:'center', optional:true },
      { id:'incoming', key:'incoming', label:'Incoming', type:'number', locked:false, lock:false, minWidth:120, minCellWidth:120, defaultVisible:false, dataCol:'incoming', sortable:true, align:'center', optional:true },
      { id:'reserved', key:'reserved', label:'Allocated', type:'number', locked:false, lock:false, minWidth:110, minCellWidth:110, defaultVisible:false, dataCol:'reserved', sortable:true, align:'center', optional:true },
      { id:'available', key:'available', label:'Available', type:'number', locked:false, lock:false, minWidth:110, minCellWidth:110, defaultVisible:true, dataCol:'available', sortable:true, align:'center', optional:true },
      { id:'reorder_point', key:'reorder_point', label:'Reorder Point', type:'number', locked:false, lock:false, minWidth:120, minCellWidth:120, defaultVisible:true, dataCol:'reorderPoint', sortable:true, align:'center', optional:true },
      { id:'reorder_qty', key:'reorder_qty', label:'Reorder Qty', type:'number', locked:false, lock:false, minWidth:120, minCellWidth:120, defaultVisible:false, dataCol:'reorderQty', sortable:true, align:'center', optional:true },
      { id:'description', key:'description', label:'Description', type:'text', locked:false, lock:false, minWidth:220, minCellWidth:220, maxWidth:280, defaultVisible:false, dataCol:'desc', sortable:true, align:'left', optional:true },
      { id:'location', key:'location', label:'Location', type:'text', locked:false, lock:false, minWidth:140, minCellWidth:140, maxWidth:180, defaultVisible:false, dataCol:'location', sortable:true, align:'left', optional:true },
      { id:'category', key:'category', label:'Category', type:'text', locked:false, lock:false, minWidth:140, minCellWidth:140, maxWidth:180, defaultVisible:false, dataCol:'category', sortable:true, align:'left', optional:true }
    ];
    const INVENTORY_ROW_ACTION_ORDER = ['edit_item', 'add_to_job', 'order_item', 'delete_item'];
    
    const INVENTORY_TRAY_SIDE = {
      add_to_job: 'right',
      order_item: 'right',
      edit_item: 'left',
      delete_item: 'left'
    };
    const INVENTORY_TRAY_ORDER = {
      left: ['edit_item', 'delete_item'],
      right: ['add_to_job', 'order_item']
    };
    const INVENTORY_ACTION_META = {
      edit_item: {
        btnClass: 'icon-btn icon-btn--default row-edit-btn',
        icon: () => ICONS.pencil,
        label: () => 'Edit item',
        trayAction: 'edit'
      },
      add_to_job: {
        btnClass: 'icon-btn icon-btn--default row-job-btn',
        icon: () => ICONS.briefcasePlus,
        label: () => 'Add to job',
        trayAction: 'job'
      },
      order_item: {
        btnClass: 'icon-btn icon-btn--success row-order-btn',
        icon: () => ICONS.shoppingBag,
        label: (ctx) => (ctx && ctx.inOrder ? 'Remove from order' : 'Add to order'),
        trayAction: 'order'
      },
      delete_item: {
        btnClass: 'icon-btn icon-btn--danger row-delete-btn',
        icon: () => ICONS.trash2,
        label: () => 'Delete item',
        trayAction: 'delete'
      }
    };
    const INVENTORY_COLUMN_MAP = new Map(INVENTORY_COLUMN_DEFS.map(def => [def.key, def]));
    const INVENTORY_DEFAULT_ORDER = INVENTORY_COLUMN_DEFS.map(def => def.key);
    const INVENTORY_DEFAULT_VISIBLE = INVENTORY_COLUMN_DEFS.filter(def => def.defaultVisible).map(def => def.key);
    let _inventoryColumnSig = '';
    let _inventoryColumnConfig = null;
    let _inventoryActiveColumns = null;
    let _inventoryLayoutSig = '';
    let _inventoryLayout = null;
    let _inventoryItemColWidth = 180;
    const INVENTORY_ITEM_MIN_WIDTH = 180;
    const INVENTORY_ITEM_MAX_WIDTH = 360;
    const INVENTORY_ITEM_FONT = '800 15px Barlow, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    const INVENTORY_HEADER_FONT = '700 12px Barlow, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    const INVENTORY_HEADER_LETTER_SPACING = 0.5;
    const INVENTORY_HEADER_PADDING = 24;
    const INVENTORY_HEADER_SORT_EXTRA = 20;
    let _inventoryMeasureCanvas = null;

    function measureTextPx(text, font){
      try{
        if(!_inventoryMeasureCanvas) _inventoryMeasureCanvas = document.createElement('canvas');
        const ctx = _inventoryMeasureCanvas.getContext('2d');
        if(!ctx) return 0;
        ctx.font = font;
        return ctx.measureText(String(text || '')).width || 0;
      }catch(e){
        return 0;
      }
    }
    function getInventoryColumnMinWidth(def){
      if(!def) return 0;
      const min = Number(def.minCellWidth ?? def.minWidth);
      return Number.isFinite(min) ? min : 0;
    }
    function getInventoryColumnHeaderWidth(def){
      if(!def) return 0;
      if(Number.isFinite(def.headerWidth)) return def.headerWidth;
      const label = String(def.label || def.key || '').trim();
      if(!label){
        def.headerWidth = 0;
        return 0;
      }
      const text = label.toUpperCase();
      let width = measureTextPx(text, INVENTORY_HEADER_FONT);
      if(INVENTORY_HEADER_LETTER_SPACING){
        width += Math.max(0, text.length - 1) * INVENTORY_HEADER_LETTER_SPACING;
      }
      width += INVENTORY_HEADER_PADDING;
      if(def.sortable) width += INVENTORY_HEADER_SORT_EXTRA;
      def.headerWidth = Math.ceil(width);
      return def.headerWidth;
    }
    function getInventoryColumnRequiredWidth(def){
      if(!def) return 0;
      const minWidth = getInventoryColumnMinWidth(def);
      const headerWidth = getInventoryColumnHeaderWidth(def);
      return Math.max(minWidth, headerWidth);
    }
    function computeItemColWidth(items){
      const list = Array.isArray(items) ? items : [];
      let max = 0;
      for(const it of list){
        const name = String(it && it.name ? it.name : '').trim();
        if(!name) continue;
        const w = measureTextPx(name, INVENTORY_ITEM_FONT);
        if(w > max) max = w;
      }
      const padding = 86; // checkbox + spacing + cell padding
      const desired = Math.ceil(max + padding);
      const clamped = Math.max(INVENTORY_ITEM_MIN_WIDTH, Math.min(INVENTORY_ITEM_MAX_WIDTH, desired || INVENTORY_ITEM_MIN_WIDTH));
      return clamped;
    }
    function refreshComputedItemColWidth(items){
      _inventoryItemColWidth = computeItemColWidth(items);
      _inventoryLayoutSig = '';
      return _inventoryItemColWidth;
    }
    function getComputedItemColWidth(){
      return _inventoryItemColWidth || INVENTORY_ITEM_MIN_WIDTH;
    }
    function getInventoryViewportWidth(){
      const wrap = $('tableWrap');
      if(wrap){
        const w = wrap.getBoundingClientRect().width;
        if(Number.isFinite(w) && w > 0) return Math.floor(w);
      }
      const table = $('invTable');
      if(table){
        const w = table.getBoundingClientRect().width;
        if(Number.isFinite(w) && w > 0) return Math.floor(w);
      }
      return Math.max(0, Math.floor(window.innerWidth || 0));
    }
    function computeInventoryVisibleColumns({ enabledOrder, viewportWidthPx, isMobile, computedItemColWidth }){
      const order = Array.isArray(enabledOrder) ? enabledOrder : [];
      const viewport = Math.max(0, Number(viewportWidthPx) || 0);
      const actionsWidth = (!isMobile && INVENTORY_ACTIONS_DEF && INVENTORY_ACTIONS_DEF.minWidth)
        ? Number(INVENTORY_ACTIONS_DEF.minWidth) || 0
        : 0;
      let itemWidth = Math.max(
        INVENTORY_ITEM_MIN_WIDTH,
        Math.min(INVENTORY_ITEM_MAX_WIDTH, Number(computedItemColWidth) || INVENTORY_ITEM_MIN_WIDTH)
      );
      const requiredWidthForKey = (key) => {
        const def = INVENTORY_COLUMN_MAP.get(key);
        return def ? getInventoryColumnRequiredWidth(def) : 0;
      };
      const buildVisible = (remaining) => {
        const out = [];
        let rem = remaining;
        for(const key of order){
          const req = requiredWidthForKey(key);
          if(req <= 0) continue;
          if(rem >= req){
            out.push(key);
            rem -= req;
          }else{
            break;
          }
        }
        return out;
      };
      let remaining = viewport - itemWidth - actionsWidth;
      let visible = buildVisible(remaining);

      if(visible.length === 0 && order.length){
        const firstReq = requiredWidthForKey(order[0]);
        if(firstReq > 0){
          const maxItemForTwo = viewport - actionsWidth - firstReq;
          if(Number.isFinite(maxItemForTwo)){
            const adjustedItem = Math.max(INVENTORY_ITEM_MIN_WIDTH, Math.min(itemWidth, maxItemForTwo));
            if(adjustedItem !== itemWidth){
              itemWidth = adjustedItem;
              remaining = viewport - itemWidth - actionsWidth;
              visible = buildVisible(remaining);
            }
          }
        }
      }

      if(visible.length === 0 && order.length){
        const remainingAfterItem = viewport - itemWidth - actionsWidth;
        for(const key of order){
          const req = requiredWidthForKey(key);
          if(req > 0 && remainingAfterItem >= req){
            visible = [key];
            break;
          }
        }
        if(visible.length === 0){
          visible = [order[0]];
        }
      }

      return { visibleKeys: visible, itemWidth };
    }

    function defaultInventoryOrder(){
      return INVENTORY_DEFAULT_ORDER.slice();
    }
    function defaultInventoryVisibleKeys(){
      return INVENTORY_DEFAULT_VISIBLE.slice();
    }
    function normalizeInventoryOrder(order){
      if(!Array.isArray(order) || !order.includes(INVENTORY_ANCHOR_KEY)) return defaultInventoryOrder();
      const valid = new Set(INVENTORY_DEFAULT_ORDER);
      const seen = new Set();
      const cleaned = [];
      for(const key of order){
        if(!valid.has(key) || seen.has(key)) continue;
        if(key === INVENTORY_ANCHOR_KEY) continue;
        seen.add(key);
        cleaned.push(key);
      }
      const ordered = [INVENTORY_ANCHOR_KEY, ...cleaned];
      for(const key of INVENTORY_DEFAULT_ORDER){
        if(!ordered.includes(key)) ordered.push(key);
      }
      return ordered;
    }
    function normalizeInventoryVisible(visible, order){
      const valid = new Set(INVENTORY_DEFAULT_ORDER);
      if(!Array.isArray(visible)) return defaultInventoryVisibleKeys();
      const visibleSet = new Set();
      visible.forEach(key=>{
        if(valid.has(key)) visibleSet.add(key);
      });
      visibleSet.add(INVENTORY_ANCHOR_KEY);
      const ordered = Array.isArray(order) ? order : defaultInventoryOrder();
      return ordered.filter(key => visibleSet.has(key));
    }
    function getInventoryLayoutFromConfig(config, opts = {}){
      const order = normalizeInventoryOrder(config && Array.isArray(config.order) ? config.order : defaultInventoryOrder());
      const visible = normalizeInventoryVisible(config && Array.isArray(config.visible) ? config.visible : defaultInventoryVisibleKeys(), order);
      const visibleSet = new Set(visible);
      const enabledOrder = order.filter(key => key !== INVENTORY_ANCHOR_KEY && visibleSet.has(key));
      const viewportWidthPx = getInventoryViewportWidth();
      const isMobile = isMobileUx();
      const itemWidth = getComputedItemColWidth();
      const sig = `${order.join('|')}::${visible.join('|')}::${viewportWidthPx}::${isMobile ? '1' : '0'}::${itemWidth}`;
      if(!opts.force && sig === _inventoryLayoutSig && _inventoryLayout){
        return _inventoryLayout;
      }
      const computed = computeInventoryVisibleColumns({
        enabledOrder,
        viewportWidthPx,
        isMobile,
        computedItemColWidth: itemWidth
      });
      const visibleKeys = computed.visibleKeys || [];
      const columnDefs = visibleKeys.map(key => INVENTORY_COLUMN_MAP.get(key)).filter(Boolean);
      const showActions = !isMobile;
      _inventoryLayoutSig = sig;
      _inventoryLayout = {
        order,
        visible,
        columnKeys: visibleKeys,
        columnDefs,
        showActions,
        itemWidth: computed.itemWidth || itemWidth,
        viewportWidthPx,
        isMobile
      };
      return _inventoryLayout;
    }
    function getInventoryLayout(){
      const config = getInventoryColumnConfig();
      return getInventoryLayoutFromConfig(config);
    }

    // =========================================================================
    // UDWE: Universal Dynamic Width Engine
    // Standardized responsive table/modal sizing for all modal tables
    // =========================================================================
    const UDWE = (function(){
      const BASELINE_WIDTH = 480;
      const MIN_WIDTH = 320;
      const MAX_WIDTH = 800;
      const MOBILE_BREAKPOINT = 600;
      const HEADER_FONT = '600 11px system-ui, -apple-system, sans-serif';
      const BODY_FONT = '400 14px system-ui, -apple-system, sans-serif';
      const HEADER_PADDING = 24;
      const CELL_PADDING = 24;
      const TRUNCATE_CHAR = 40;
      let _measureCanvas = null;

      function measureText(text, font){
        try{
          if(!_measureCanvas) _measureCanvas = document.createElement('canvas');
          const ctx = _measureCanvas.getContext('2d');
          if(!ctx) return 0;
          ctx.font = font || BODY_FONT;
          return ctx.measureText(String(text || '')).width || 0;
        }catch(e){
          return 0;
        }
      }

      function calcHeaderWidth(colDef){
        if(!colDef) return 0;
        const label = String(colDef.label || colDef.key || '').trim();
        const textWidth = measureText(label.toUpperCase(), HEADER_FONT);
        const width = Math.ceil(textWidth + HEADER_PADDING);
        return Math.max(width, colDef.minWidth || 0);
      }

      function calcContentWidth(colDef, data){
        if(!colDef || !Array.isArray(data) || !data.length) return colDef?.minWidth || 0;
        const key = colDef.key;
        let maxWidth = 0;
        for(const row of data){
          let val = row[key];
          if(val === null || val === undefined) continue;
          let text = String(val);
          if(colDef.truncatable && colDef.truncateAt && text.length > colDef.truncateAt){
            text = text.slice(0, colDef.truncateAt);
          }
          const w = measureText(text, BODY_FONT);
          if(w > maxWidth) maxWidth = w;
        }
        let width = Math.ceil(maxWidth + CELL_PADDING);
        if(colDef.minWidth) width = Math.max(width, colDef.minWidth);
        if(colDef.maxWidth) width = Math.min(width, colDef.maxWidth);
        return width;
      }

      function calcTableWidth(config, data){
        if(!config || !Array.isArray(config.columns)) return { total: BASELINE_WIDTH, columns: [] };
        const columns = config.columns.map(col => {
          const headerW = calcHeaderWidth(col);
          const contentW = calcContentWidth(col, data);
          const width = Math.max(headerW, contentW);
          return { ...col, computedWidth: width };
        });
        let total = columns.reduce((sum, c) => sum + c.computedWidth, 0);
        const min = config.minWidth || MIN_WIDTH;
        const max = config.maxWidth || MAX_WIDTH;
        total = Math.max(min, Math.min(max, total));
        return { total, columns };
      }

      function getLayoutMode(config){
        const breakpoint = config?.mobileBreakpoint || MOBILE_BREAKPOINT;
        const width = window.innerWidth || 0;
        return width < breakpoint ? 'mobile' : 'desktop';
      }

      function renderColgroup(columns){
        if(!Array.isArray(columns) || !columns.length) return '';
        return '<colgroup>' + columns.map(c =>
          `<col style="width:${c.computedWidth || c.minWidth || 100}px">`
        ).join('') + '</colgroup>';
      }

      function renderThead(columns){
        if(!Array.isArray(columns) || !columns.length) return '';
        const cells = columns.map(c => {
          const align = c.align || 'left';
          const cls = align === 'center' ? ' class="num"' : (align === 'right' ? ' class="align-right"' : '');
          return `<th scope="col"${cls}>${escapeHtml(c.label || c.key)}</th>`;
        }).join('');
        return `<thead><tr>${cells}</tr></thead>`;
      }

      function renderTbody(columns, data, config){
        if(!Array.isArray(data) || !data.length){
          const colCount = columns?.length || 1;
          return `<tbody><tr><td colspan="${colCount}" class="udwe-empty">No data found</td></tr></tbody>`;
        }
        const rows = data.map(row => {
          const cells = columns.map(col => {
            const key = col.key;
            let val = row[key];
            if(val === null || val === undefined) val = '';
            // Support custom cell renderer
            let cellContent;
            if(typeof col.render === 'function'){
              cellContent = col.render(val, row, col);
            }else{
              let text = String(val);
              const isTruncated = col.truncatable && col.truncateAt && text.length > col.truncateAt;
              if(isTruncated) text = text.slice(0, col.truncateAt) + '...';
              cellContent = escapeHtml(text);
            }
            const align = col.align || 'left';
            const cls = [];
            if(align === 'center') cls.push('num');
            if(align === 'right') cls.push('align-right');
            if(col.truncatable) cls.push('truncatable');
            if(col.cellClass) cls.push(col.cellClass);
            const classAttr = cls.length ? ` class="${cls.join(' ')}"` : '';
            const label = col.mobileLabel || col.label || col.key;
            return `<td${classAttr} data-label="${escapeHtmlAttr(label)}">${cellContent}</td>`;
          }).join('');
          return `<tr>${cells}</tr>`;
        }).join('');
        return `<tbody>${rows}</tbody>`;
      }

      function renderDesktopTable(config, data){
        const { total, columns } = calcTableWidth(config, data);
        const colgroup = renderColgroup(columns);
        const thead = renderThead(columns);
        const tbody = renderTbody(columns, data, config);
        const tableId = config.id ? ` id="${escapeHtmlAttr(config.id)}"` : '';
        return `<div class="udwe-table-wrap" style="max-width:${total}px"><table class="udwe-table"${tableId}>${colgroup}${thead}${tbody}</table></div>`;
      }

      function renderCards(config, data){
        if(!Array.isArray(data) || !data.length){
          return '<div class="udwe-cards udwe-empty">No data found</div>';
        }
        const primaryKey = config.mobilePrimaryKey || (config.columns[0]?.key);
        const secondaryKeys = config.mobileSecondaryKeys || config.columns.slice(1).map(c => c.key);
        const columnMap = new Map(config.columns.map(c => [c.key, c]));
        const cards = data.map(row => {
          const primaryVal = row[primaryKey] ?? '';
          const primaryCol = columnMap.get(primaryKey);
          // Support custom renderer for primary
          let primaryContent;
          if(primaryCol && typeof primaryCol.render === 'function'){
            primaryContent = primaryCol.render(primaryVal, row, primaryCol);
          }else{
            primaryContent = escapeHtml(String(primaryVal));
          }
          const metas = secondaryKeys.map(key => {
            const col = columnMap.get(key);
            if(!col) return '';
            const val = row[key] ?? '';
            const label = col.mobileLabel || col.label || key;
            // Support custom renderer for meta values
            let valueContent;
            if(typeof col.render === 'function'){
              valueContent = col.render(val, row, col);
            }else{
              valueContent = escapeHtml(String(val));
            }
            return `<div class="udwe-card-meta"><span class="udwe-card-label">${escapeHtml(label)}</span><span class="udwe-card-value">${valueContent}</span></div>`;
          }).join('');
          return `<div class="udwe-card"><div class="udwe-card-primary">${primaryContent}</div>${metas}</div>`;
        }).join('');
        return `<div class="udwe-cards">${cards}</div>`;
      }

      function renderTable(config, data, opts){
        const options = opts || {};
        const mode = options.forceMode || getLayoutMode(config);
        if(mode === 'mobile' && config.mobileLayout !== 'scroll'){
          return renderCards(config, data);
        }
        return renderDesktopTable(config, data);
      }

      return {
        BASELINE_WIDTH,
        MIN_WIDTH,
        MAX_WIDTH,
        MOBILE_BREAKPOINT,
        measureText,
        calcHeaderWidth,
        calcContentWidth,
        calcTableWidth,
        getLayoutMode,
        renderColgroup,
        renderThead,
        renderTable,
        renderCards
      };
    })();
    window.UDWE = UDWE;

    function loadInventoryColumnConfig(){
      const raw = localStorage.getItem(INVENTORY_ROW_DISPLAY_KEY);
      const fallback = localStorage.getItem(INVENTORY_LEGACY_COLUMNS_KEY);
      if(!raw && !fallback){
        return { order: defaultInventoryOrder(), visible: defaultInventoryVisibleKeys() };
      }
      try{
        const parsed = JSON.parse(raw || fallback || '{}');
        const hasOrder = parsed && Array.isArray(parsed.order);
        const hasVisible = parsed && Array.isArray(parsed.visible);
        const order = hasOrder ? normalizeInventoryOrder(parsed.order) : defaultInventoryOrder();
        const visible = hasVisible ? normalizeInventoryVisible(parsed.visible, order) : defaultInventoryVisibleKeys();
        return { order, visible };
      }catch(e){
        return { order: defaultInventoryOrder(), visible: defaultInventoryVisibleKeys() };
      }
    }
    function saveInventoryColumnConfig(config){
      const existing = loadInventoryColumnConfig();
      const order = normalizeInventoryOrder(config && config.order ? config.order : (existing.order || defaultInventoryOrder()));
      const visible = normalizeInventoryVisible(config && config.visible ? config.visible : (existing.visible || defaultInventoryVisibleKeys()), order);
      localStorage.setItem(INVENTORY_ROW_DISPLAY_KEY, JSON.stringify({ order, visible }));
      _inventoryColumnSig = '';
      _inventoryColumnConfig = null;
      _inventoryLayoutSig = '';
    }
    function getAllowedInventoryRowTapOptions(){
      const allowed = new Set(['expand_details']);
      if(isInventoryActionVisible('order_item') && canOrdersCreate()) allowed.add('add_to_order');
      if(isInventoryActionVisible('add_to_job')) allowed.add('add_to_job');
      if(isInventoryActionVisible('edit_item') && canItemsEdit()) allowed.add('edit_item');
      return allowed;
    }
    function normalizeInventoryRowTapValue(value){
      const raw = String(value || '').trim();
      if(raw === 'expand_qty') return 'expand_details';
      return raw;
    }
    function getInventoryRowTapPref(){
      const allowed = getAllowedInventoryRowTapOptions();
      if(state._rowTapPref && allowed.has(state._rowTapPref)) return state._rowTapPref;
      const raw = normalizeInventoryRowTapValue(localStorage.getItem(INVENTORY_ROW_TAP_KEY));
      state._rowTapPref = (allowed.has(raw) && INVENTORY_ROW_TAP_OPTIONS.has(raw)) ? raw : INVENTORY_ROW_TAP_DEFAULT;
      return state._rowTapPref;
    }
    function setInventoryRowTapPref(value){
      const allowed = getAllowedInventoryRowTapOptions();
      const normalized = normalizeInventoryRowTapValue(value);
      const next = (INVENTORY_ROW_TAP_OPTIONS.has(normalized) && allowed.has(normalized)) ? normalized : INVENTORY_ROW_TAP_DEFAULT;
      state._rowTapPref = next;
      localStorage.setItem(INVENTORY_ROW_TAP_KEY, next);
    }
    function handleInventoryRowTap(id){
      const itemId = String(id || '').trim();
      if(!itemId) return;
      const pref = getInventoryRowTapPref();
      if(pref === 'edit_item'){
        if(isInventoryActionVisible('edit_item') && canItemsEdit()){
          openEditItemModal(itemId);
          return;
        }
      }
      if(pref === 'add_to_job'){
        if(isInventoryActionVisible('add_to_job')){
          openAddToJobModal(itemId);
          return;
        }
      }
      if(pref === 'add_to_order'){
        if(isInventoryActionVisible('order_item') && canOrdersCreate()){
          toggleOrderLineForItemId(itemId);
          return;
        }
      }
      toggleExpandedCard(itemId);
    }
    function loadInventoryQuickFilter(){
      let raw = '';
      try{ raw = String(localStorage.getItem(INVENTORY_QUICK_FILTER_KEY) || '').trim(); }catch(e){ raw = ''; }
      window.invQuickFilter = INVENTORY_QUICK_FILTERS.has(raw) ? raw : 'all';
    }
    function getInventoryQuickFilter(){
      const raw = String(window.invQuickFilter || '').trim();
      return INVENTORY_QUICK_FILTERS.has(raw) ? raw : 'all';
    }
    function updateQuickFilterPills(){
      const wrap = $('invQuickFilters');
      if(!wrap) return;
      const active = getInventoryQuickFilter();
      wrap.querySelectorAll('[data-filter]').forEach(btn=>{
        const key = btn.getAttribute('data-filter');
        const on = key === active;
        btn.classList.toggle('is-active', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }
    function setInventoryQuickFilter(value, opts = {}){
      const next = INVENTORY_QUICK_FILTERS.has(value) ? value : 'all';
      window.invQuickFilter = next;
      if(opts.persist !== false){
        try{ localStorage.setItem(INVENTORY_QUICK_FILTER_KEY, next); }catch(e){}
      }
      updateQuickFilterPills();
      if(opts.render !== false){
        renderTable();
        // Also update card view if active
        try{ if(_invViewMode === 'cards') renderInventoryCards(); }catch(e){}
      }
    }
    function applyInventoryQuickFilter(items){
      const list = Array.isArray(items) ? items : [];
      const mode = getInventoryQuickFilter();
      if(mode === 'all') return list;
      return list.filter(it=>{
        const qty = toInt(it.qty, 0);
        if(mode === 'in_stock') return qty > 0;
        if(mode === 'out_of_stock') return qty === 0;
        if(mode === 'low_stock') return qty > 0 && isLowStockItem(it);
        return true;
      });
    }
    function getInventoryVisibilityRole(){
      const role = String(getEffectiveRole() || '').trim().toLowerCase();
      if(role === 'member') return 'user';
      if(role === 'user') return 'user';
      // Fallback to 'user' if role is empty/unknown (ensures tray actions visible)
      return role || 'user';
    }
    function getInventoryActionVisibilityMap(){
      const vis = UI_VISIBILITY && UI_VISIBILITY.inventory_action && UI_VISIBILITY.inventory_action.row;
      return (vis && typeof vis === 'object') ? vis : {};
    }
    function isInventoryActionVisible(actionKey){
      const role = getInventoryVisibilityRole();
      const map = getInventoryActionVisibilityMap();
      const allowed = map ? map[actionKey] : null;
      return Array.isArray(allowed) && role && allowed.includes(role);
    }
    function getVisibleInventoryRowActions(){
      return INVENTORY_ROW_ACTION_ORDER.filter(key => isInventoryActionVisible(key));
    }
    function getVisibleInventoryTrayActions(side){
      const s = side === 'right' ? 'right' : 'left';
      const order = INVENTORY_TRAY_ORDER[s] || [];
      return order.filter(key => INVENTORY_TRAY_SIDE[key] === s && isInventoryActionVisible(key));
    }
    function inventoryActionMetaForKey(actionKey){
      return INVENTORY_ACTION_META[actionKey] || null;
    }
    if (!IMUtils.toKey) IMUtils.toKey = toKey;
    if (!IMUtils.toInt) IMUtils.toInt = toInt;
    window.IMUtils = IMUtils;
    function setUpdated(){ state.updatedAt=new Date().toISOString(); }
    // Persist only UI prefs; never persist items
    function save(){ const prefs={updatedAt:state.updatedAt,_filter:state._filter,_sort:state._sort}; localStorage.setItem(DB_KEY, JSON.stringify(prefs)); render(); }
    function load(){
      const raw=localStorage.getItem(DB_KEY);
      if(raw){
        try{
          const p=JSON.parse(raw);
          if(p){
            if(typeof p._filter==='string') state._filter=p._filter;
            if(p._sort){
              // Handle array format (convert to single)
              if(Array.isArray(p._sort) && p._sort[0] && typeof p._sort[0].col === 'string'){
                state._sort = { col: p._sort[0].col, dir: p._sort[0].dir === 'desc' ? 'desc' : 'asc' };
              } else if(typeof p._sort.col === 'string'){
                state._sort = { col: p._sort.col, dir: p._sort.dir === 'desc' ? 'desc' : 'asc' };
              }
            }
            if(p.updatedAt) state.updatedAt=p.updatedAt;
          }
        } catch(e){}
      }
    }



    function dedupe(){
      const seen=new Set();
      state.items=state.items.filter(it=>{
        const k=toKey(it.name); if(!k) return false;
        if(seen.has(k)) return false;
        seen.add(k);
        if(!it.id) it.id=randomUUID();
        it.qty = toInt(it.qty,0);
        return true;
      });
    }

    // Shallow clone of items for optimistic-UI rollback
    function snapshotItems(){ return state.items.map(it => ({...it})); }

	    // ========================
	    // Supabase (cloud sync) â€” optional
	    // ========================
    const SB = { client:null, ready:false, connected:false, session:null, user:null, authorized:false, profile:null, companyId:null, company:null, companyTier:null, companies:[], permissions:null, itemsHasLowStockQty:null, itemsHasReorderEnabled:null, ordersHasReceipt:null, warnedLowStockSchema:false, warnedReorderSchema:false, warnedOrdersReceiptSchema:false, warnedTierMissing:false };
    const COMPANY_STORAGE_PREFIX = 'inv.company.v1';
    let _inviteCompanyId = '';
    let _userMgmtCompanyId = '';
    let _onboardingCompanyId = '';
    let _signupMode = false;      // True when in self-service signup flow
    let _signupPlan = '';         // Plan from URL parameter (starter, professional, business)

    // ========================
    // Self-Service Signup Flow
    // ========================
    function isSignupMode() {
      return _signupMode && isOnboardingRoute();
    }

    function setSignupMessage(msg, isError = false) {
      const el = $('signupAccountMsg');
      if (!el) return;
      el.textContent = String(msg || '');
      el.style.color = isError ? '#f87171' : 'var(--wiz-muted)';
    }

    function setCompanyMessage(msg, isError = false) {
      const el = $('signupCompanyMsg');
      if (!el) return;
      el.textContent = String(msg || '');
      el.style.color = isError ? '#f87171' : 'var(--wiz-muted)';
    }

    async function handleSignupSubmit(e) {
      if (e) e.preventDefault();
      const email = String($('signupEmail')?.value || '').trim();
      const password = String($('signupPassword')?.value || '');
      const confirm = String($('signupPasswordConfirm')?.value || '');
      const terms = $('signupTerms')?.checked;

      setSignupMessage('');

      // Validation
      if (!email) {
        setSignupMessage('Email address is required.', true);
        return;
      }
      if (!email.includes('@') || !email.includes('.')) {
        setSignupMessage('Please enter a valid email address.', true);
        return;
      }
      if (!password) {
        setSignupMessage('Password is required.', true);
        return;
      }
      if (password.length < 8) {
        setSignupMessage('Password must be at least 8 characters.', true);
        return;
      }
      if (password !== confirm) {
        setSignupMessage('Passwords do not match.', true);
        return;
      }
      if (!terms) {
        setSignupMessage('Please accept the Terms of Service.', true);
        return;
      }

      const btn = $('btnSignupSubmit');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Creating account...';
      }

      try {
        const { data, error } = await SB.client.auth.signUp({
          email,
          password,
          options: {
            data: { signup_plan: _signupPlan || 'starter' }
          }
        });

        if (error) throw error;

        if (data?.user) {
          // Refresh session
          const { data: sessionData } = await SB.client.auth.getSession();
          if (sessionData?.session) {
            SB.session = sessionData.session;
            SB.user = sessionData.session.user;
          }
          // Move to company creation step
          renderOnboardingStep('company');
          renderSignupProgress(2); // Step 2 of 6
        } else {
          setSignupMessage('Check your email to confirm your account.', false);
        }
      } catch (err) {
        console.error('Signup error:', err);
        const msg = err?.message || 'Signup failed. Please try again.';
        setSignupMessage(msg, true);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Create Account';
        }
      }
    }

    async function handleCompanyCreate(e) {
      if (e) e.preventDefault();
      const name = String($('signupCompanyName')?.value || '').trim();

      setCompanyMessage('');

      if (!name) {
        setCompanyMessage('Company name is required.', true);
        return;
      }
      if (name.length < 2) {
        setCompanyMessage('Company name must be at least 2 characters.', true);
        return;
      }

      const btn = $('btnCompanySubmit');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Creating company...';
      }

      try {
        // Generate slug from name
        const slug = name.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');

        const { data, error } = await SB.client.rpc('create_company_for_signup', {
          p_name: name,
          p_slug: slug,
          p_plan: _signupPlan || 'starter'
        });

        if (error) throw error;

        if (data?.success) {
          // Update SB state
          SB.companyId = data.company_id;
          SB.company = {
            id: data.company_id,
            name: data.company_name,
            slug: data.company_slug
          };
          SB.companyTier = data.tier;
          _onboardingCompanyId = data.company_id;

          // Refresh companies list
          await sbLoadCompanies();

          // Exit signup mode and continue normal onboarding
          _signupMode = false;

          // Fetch onboarding state and continue
          state._onboardingState = await fetchOnboardingState();
          const stepIndex = getOnboardingStepFromState(state._onboardingState);
          const stepId = stepIndex === 1 ? 'profile' : stepIndex === 2 ? 'locations' : stepIndex === 3 ? 'invites' : 'finish';
          state._onboardingStep = stepId;

          // Render normal 4-step progress
          renderOnboardingProgress(stepIndex);
          renderOnboardingStep(stepId);

          // Pre-fill profile with signup email
          if (stepId === 'profile') {
            const profile = await loadOnboardingCompanyProfile();
            applyOnboardingProfileToForm(profile);
            // Also set contact email to signup email if empty
            const contactEmail = $('onboardingContactEmail');
            if (contactEmail && !contactEmail.value && SB.user?.email) {
              contactEmail.value = SB.user.email;
            }
          }
        } else {
          throw new Error(data?.error || 'Company creation failed');
        }
      } catch (err) {
        console.error('Company creation error:', err);
        const msg = err?.message || 'Failed to create company. Please try again.';
        if(/company_members_user_id_fkey|auth\\.users/i.test(msg) || /foreign key constraint/i.test(msg)){
          state._signupError = 'Your local database was reset. Please create your account again.';
          await sbSignOut();
          return;
        }
        setCompanyMessage(msg, true);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Continue';
        }
      }
    }

    function renderSignupProgress(step) {
      // For signup flow, we show 6 steps
      const steps = [
        { num: 1, label: 'Account' },
        { num: 2, label: 'Company' },
        { num: 3, label: 'Profile' },
        { num: 4, label: 'Locations' },
        { num: 5, label: 'Team' },
        { num: 6, label: 'Finish' }
      ];

      const container = $('onboardingProgressSteps');
      if (!container) return;

      container.innerHTML = steps.map(s => {
        const isComplete = step > s.num;
        const isActive = step === s.num;
        const cls = isComplete ? 'complete' : isActive ? 'active' : '';
        return `<div class="onboarding-progress-step ${cls}" data-onboarding-progress="${s.num}">${s.label}</div>`;
      }).join('');

      const fill = $('onboardingProgressFill');
      if (fill) {
        const percent = Math.round(((step - 1) / (steps.length - 1)) * 100);
        fill.style.width = `${percent}%`;
      }

      // Update header text for signup flow
      const eyebrow = $('onboardingEyebrow');
      const title = $('onboardingTitle');
      const note = $('onboardingNote');

      if (step === 1) {
        if (eyebrow) eyebrow.textContent = 'Get Started';
        if (title) title.textContent = 'Create your account';
        if (note) note.textContent = _signupPlan ? `Selected plan: ${_signupPlan.charAt(0).toUpperCase() + _signupPlan.slice(1)}` : '';
      } else if (step === 2) {
        if (eyebrow) eyebrow.textContent = 'Almost there';
        if (title) title.textContent = 'Name your company';
        if (note) note.textContent = 'This will be your workspace name.';
      } else {
        // Reset to default for profile+ steps
        if (eyebrow) eyebrow.textContent = 'Company Onboarding';
        if (title) title.textContent = 'Set up your workspace';
        if (note) note.textContent = 'You can complete setup later.';
      }
    }

    function showSignInFromSignup() {
      // User clicked "Already have an account?" - show sign in modal
      show('authModal', true);
    }

    // ========================
    // Google Places Autocomplete (PlaceAutocompleteElement)
    // ========================
    let _googlePlacesReady = false;
    let _placesLibraryPromise = null;
    const _autocompleteInstances = new Map();

    function hasPlaceAutocomplete(){
      return !!(window.google && google.maps && google.maps.places && google.maps.places.PlaceAutocompleteElement);
    }

    function safePlaceField(place, key){
      if(!place) return undefined;
      try{
        // Check if it's a getter that might throw
        const descriptor = Object.getOwnPropertyDescriptor(place, key) ||
          Object.getOwnPropertyDescriptor(Object.getPrototypeOf(place) || {}, key);
        if(descriptor && typeof descriptor.get === 'function'){
          try{
            return descriptor.get.call(place);
          }catch(e){
            return undefined;
          }
        }
        return place[key];
      }catch(e){
        return undefined;
      }
    }

    async function loadPlacesLibrary(){
      if(_placesLibraryPromise) return _placesLibraryPromise;
      if(window.google && google.maps && typeof google.maps.importLibrary === 'function'){
        _placesLibraryPromise = google.maps.importLibrary('places').catch(()=>null);
      }else{
        _placesLibraryPromise = Promise.resolve(null);
      }
      return _placesLibraryPromise;
    }

    async function initGooglePlaces() {
      await loadPlacesLibrary();
      _googlePlacesReady = hasPlaceAutocomplete();
      initAllAddressAutocomplete();
    }
    window.initGooglePlaces = initGooglePlaces;

    function ensureGooglePlacesLoaded(retries = 10){
      if(_googlePlacesReady && hasPlaceAutocomplete()){
        return Promise.resolve(true);
      }
      if(hasPlaceAutocomplete()){
        _googlePlacesReady = true;
        initAllAddressAutocomplete();
        return Promise.resolve(true);
      }
      return new Promise((resolve)=>{
        let remaining = Math.max(0, retries);
        const timer = setInterval(()=>{
          if(hasPlaceAutocomplete()){
            clearInterval(timer);
            _googlePlacesReady = true;
            initAllAddressAutocomplete();
            resolve(true);
            return;
          }
          if(window.google && google.maps && typeof google.maps.importLibrary === 'function'){
            void loadPlacesLibrary();
          }
          remaining -= 1;
          if(remaining <= 0){
            clearInterval(timer);
            resolve(false);
          }
        }, 200);
      });
    }

    function initAllAddressAutocomplete() {
      if(!_googlePlacesReady) return;
      initAddressAutocomplete('companyLocationAddress1', {
        address1: 'companyLocationAddress1',
        formatted: 'companyLocationAddress1Value',
        placeId: 'companyLocationPlaceId',
        components: 'companyLocationAddressComponents'
      });
    }

    function isPlaceAutocompleteHost(el){
      return !!(el && String(el.tagName || '').toLowerCase() === 'gmp-place-autocomplete');
    }

    function getAutocompleteInputElement(inputId){
      const el = $(inputId);
      if(!el) return null;
      if(isPlaceAutocompleteHost(el)){
        // Try multiple methods to find the internal input
        if(el.inputElement) return el.inputElement;
        // Try shadow DOM
        if(el.shadowRoot){
          const shadowInput = el.shadowRoot.querySelector('input');
          if(shadowInput) return shadowInput;
        }
        // Try direct child input
        const childInput = el.querySelector('input');
        if(childInput) return childInput;
        return null;
      }
      return el;
    }

    function getAutocompleteStoredValue(inputId){
      const key = String(inputId || '');
      const hiddenId = key.endsWith('Value') ? key : key + 'Value';
      const baseId = key.endsWith('Value') ? key.slice(0, -5) : key;
      const hidden = $(hiddenId);
      if(hidden && typeof hidden.value === 'string' && hidden.value) return String(hidden.value);
      const instance = _autocompleteInstances.get(baseId) || _autocompleteInstances.get(key);
      if(instance && typeof instance.lastValue === 'string' && instance.lastValue) return instance.lastValue;
      return '';
    }

    function setAutocompleteStoredValue(inputId, value){
      const next = String(value || '');
      const key = String(inputId || '');
      const hiddenId = key.endsWith('Value') ? key : key + 'Value';
      const baseId = key.endsWith('Value') ? key.slice(0, -5) : key;
      const instance = _autocompleteInstances.get(baseId) || _autocompleteInstances.get(key);
      if(instance) instance.lastValue = next;
      const hidden = $(hiddenId);
      if(hidden && typeof hidden.value !== 'undefined') hidden.value = next;
    }

    function getInputValueById(id){
      const el = $(id);
      if(el && isPlaceAutocompleteEl(el)){
        const hidden = document.getElementById(id + 'Value');
        const hv = hidden ? String(hidden.value || '').trim() : '';
        if(hv) return hv;
        const txt = getPlaceAutocompleteText(el);
        if(txt) setAutocompleteStoredValue(id + 'Value', txt);
        return txt || '';
      }
      if(!el) return '';
      if(isPlaceAutocompleteHost(el)){
        // First check our cached value
        if(el._imLastValue) return String(el._imLastValue);
        // Try inputElement property
        if(el.inputElement && typeof el.inputElement.value === 'string') return el.inputElement.value;
        // Try shadow DOM
        if(el.shadowRoot){
          const shadowInput = el.shadowRoot.querySelector('input');
          if(shadowInput && shadowInput.value) return String(shadowInput.value);
        }
        // Try direct child
        const childInput = el.querySelector('input');
        if(childInput && childInput.value) return String(childInput.value);
        try{
          if(typeof el.value === 'string' && el.value) return el.value;
        }catch(e){}
        const stored = getAutocompleteStoredValue(id);
        if(stored) return stored;
        return '';
      }
      const input = getAutocompleteInputElement(id);
      return input ? String(input.value || '') : '';
    }

    function setInputValueById(inputId, value){
      const el = $(inputId);
      const next = String(value || '');
      if(!el) return;
      if(isPlaceAutocompleteHost(el)){
        // Always cache the value
        el._imLastValue = next;
        setAutocompleteStoredValue(inputId, next);
        // Try inputElement property
        if(el.inputElement) el.inputElement.value = next;
        // Try shadow DOM
        if(el.shadowRoot){
          const shadowInput = el.shadowRoot.querySelector('input');
          if(shadowInput) shadowInput.value = next;
        }
        // Try direct child
        const childInput = el.querySelector('input');
        if(childInput) childInput.value = next;
        try{
          if(typeof el.value !== 'undefined') el.value = next;
        }catch(e){}
        return;
      }
      const input = getAutocompleteInputElement(inputId);
      if(input) input.value = next;
    }

    // ---- PlaceAutocompleteElement value sync helpers ----
    function isPlaceAutocompleteEl(el){
      if(!el) return false;
      const tag = String(el.tagName||'').toLowerCase();
      return tag === 'gmp-place-autocomplete' || tag.includes('place-autocomplete');
    }

    function getPlaceAutocompleteText(placeEl){
      if(!placeEl) return '';
      // Try inputElement property (Google's official way)
      try{
        if(placeEl.inputElement && placeEl.inputElement.value){
          const val = String(placeEl.inputElement.value).trim();
          if(val) return val;
        }
      }catch{}
      try{
        const v = placeEl.value;
        if(typeof v === 'string' && v.trim()) return v.trim();
        if(v && typeof v === 'object'){
          const t = v.text;
          if(typeof t === 'string' && t.trim()) return t.trim();
          if(t && typeof t === 'object'){
            const tVal = t.text || t.value;
            if(typeof tVal === 'string' && tVal.trim()) return tVal.trim();
          }
          const desc = v.description || v.formattedAddress || v.formatted_address || v.name;
          if(typeof desc === 'string' && desc.trim()) return desc.trim();
          try{
            const str = String(v);
            if(str && str !== '[object Object]') return str.trim();
          }catch{}
        }
      }catch{}
      try{
        const lightInput = placeEl.querySelector?.('input');
        if(lightInput?.value?.trim()) return lightInput.value.trim();
      }catch{}
      try{
        const shInput = placeEl.shadowRoot?.querySelector?.('input');
        if(shInput?.value?.trim()) return shInput.value.trim();
      }catch{}
      // Try to get from internals or attachInternals
      try{
        if(placeEl.internals && placeEl.internals.value){
          return String(placeEl.internals.value).trim();
        }
      }catch{}
      // Try _value internal property
      try{
        if(placeEl._value) return String(placeEl._value).trim();
      }catch{}
      try{
        const a = placeEl.getAttribute?.('value') || placeEl.getAttribute?.('aria-label') || '';
        return String(a).trim();
      }catch{}
      return '';
    }

    function syncPlaceAutocompleteToHidden(placeEl, hiddenId){
      const txt = getPlaceAutocompleteText(placeEl);
      if(!txt) return '';
      // Get existing stored value
      const existing = getAutocompleteStoredValue(hiddenId);
      // Only overwrite if:
      // 1. No existing value, OR
      // 2. New value is longer (more complete address), OR
      // 3. Existing value is very short (like just a country code)
      const shouldOverwrite = !existing || txt.length > existing.length || existing.length <= 5;
      if(shouldOverwrite){
        setAutocompleteStoredValue(hiddenId, txt);
      }
      return shouldOverwrite ? txt : existing;
    }

    async function resolvePlaceFromAutocompleteEvent(ev){
      const d = ev?.detail || ev;
      const directPlace = d?.place;
      if(directPlace){
        try{
          if(typeof directPlace.fetchFields === 'function'){
            // Use correct field names for new Places API
            await directPlace.fetchFields({ fields: ['formattedAddress', 'displayName', 'location'] });
          }
        }catch(e){
          console.warn('[Places] fetchFields failed for directPlace:', e);
        }
        return directPlace;
      }
      const pred = d?.placePrediction;
      // Try to extract text from prediction for fallback
      if(pred){
        // Store prediction text as fallback before converting to place
        const predText = pred.text?.text || pred.text?.value || pred.description || '';
        const mainText = pred.structuredFormat?.mainText?.text || '';
        const secondaryText = pred.structuredFormat?.secondaryText?.text || '';
        const fullPredText = pred.description || (mainText && secondaryText ? `${mainText}, ${secondaryText}` : mainText) || predText;

        if(typeof pred.toPlace === 'function'){
          const p = pred.toPlace();
          // Attach the prediction text as fallback
          p._predictionText = fullPredText;
          try{
            if(typeof p.fetchFields === 'function'){
              // Use correct field names for new Places API
              await p.fetchFields({ fields: ['formattedAddress', 'displayName', 'location'] });
            }
          }catch(e){
            console.warn('[Places] fetchFields failed for prediction:', e);
            // If fetchFields fails, use the prediction text as formattedAddress
            if(fullPredText && !p.formattedAddress){
              p.formattedAddress = fullPredText;
            }
          }
          return p;
        }
        // If no toPlace, return a mock place with the prediction text
        return { formattedAddress: fullPredText, _predictionText: fullPredText };
      }
      return null;
    }

    function initAddressAutocomplete(inputId, mapping, force = false) {
      const host = $(inputId);
      if(!host || !hasPlaceAutocomplete()) return;
      if(_autocompleteInstances.has(inputId)){
        if(!force) return;
        destroyAddressAutocomplete(inputId);
      }

      let placeElement = host;
      let placeholder = '';
      let className = '';
      let inlineStyle = '';
      let currentValue = '';

      if(isPlaceAutocompleteHost(host)){
        placeElement = host;
        placeholder = host.dataset.placeholder || '';
        className = host.dataset.inputClass || '';
        currentValue = getInputValueById(inputId);
      }else{
        currentValue = String(host.value || '');
        placeholder = String(host.getAttribute('placeholder') || '');
        className = String(host.getAttribute('class') || '');
        inlineStyle = String(host.getAttribute('style') || '');

        placeElement = new google.maps.places.PlaceAutocompleteElement();
        placeElement.id = inputId;
        if(className) placeElement.setAttribute('class', className);
        if(inlineStyle) placeElement.setAttribute('style', inlineStyle);
        if(placeholder) placeElement.dataset.placeholder = placeholder;
        if(className) placeElement.dataset.inputClass = className;

        if(host.parentNode) host.parentNode.replaceChild(placeElement, host);
      }

      const hiddenId = inputId + 'Value';

      ['input','change','blur','keyup'].forEach(evt=>{
        placeElement.addEventListener(evt, () =>
          syncPlaceAutocompleteToHidden(placeElement, hiddenId),
          { passive:true }
        );
      });

      try{
        const tryBindInternal = () => {
          const internal =
            placeElement.querySelector?.('input') ||
            placeElement.shadowRoot?.querySelector?.('input');
          if(internal && !internal.__invBound){
            internal.__invBound = true;
            ['input','change','blur','keyup'].forEach(evt=>{
              internal.addEventListener(evt, () =>
                syncPlaceAutocompleteToHidden(placeElement, hiddenId),
                { passive:true }
              );
            });
          }
        };
        tryBindInternal();
        setTimeout(tryBindInternal, 0);
        setTimeout(tryBindInternal, 250);
        const mo = new MutationObserver(tryBindInternal);
        mo.observe(placeElement, { subtree:true, childList:true });
      }catch{}

      syncPlaceAutocompleteToHidden(placeElement, hiddenId);

      // These properties may not be available in newer API versions - wrap in try/catch
      try{
        if('types' in placeElement && !placeElement.types) placeElement.types = ['address'];
      }catch(e){}
      try{
        if('fields' in placeElement && !placeElement.fields) placeElement.fields = ['addressComponents','formattedAddress','id'];
      }catch(e){}

      if(currentValue) setAutocompleteStoredValue(inputId, currentValue);

      const wireInput = () => {
        const inputEl = getAutocompleteInputElement(inputId);
        if(!inputEl || inputEl._imPlacesWired) return;
        inputEl._imPlacesWired = true;
        if(className) inputEl.className = className;
        inputEl.type = 'text';
        if(placeholder) inputEl.placeholder = placeholder;
        inputEl.autocomplete = 'off';
        inputEl.spellcheck = false;
        if(currentValue) inputEl.value = currentValue;
        placeElement._imLastValue = inputEl.value || currentValue || '';
        setAutocompleteStoredValue(inputId, placeElement._imLastValue);
        inputEl.addEventListener('input', ()=>{
          placeElement._imLastValue = inputEl.value || '';
          setAutocompleteStoredValue(inputId, placeElement._imLastValue);
        });
      };
      wireInput();
      setTimeout(wireInput, 0);

      const onPlacePicked = async (ev) => {
        const hiddenId = inputId + 'Value';
        const visibleTxt = syncPlaceAutocompleteToHidden(placeElement, hiddenId);
        const pred = ev?.detail?.placePrediction;
        // Extract prediction text from various possible structures
        const predText = pred
          ? (
              (pred.text && (pred.text.text || pred.text.value)) ||
              pred.description ||
              (pred.structuredFormat && pred.structuredFormat.mainText && pred.structuredFormat.mainText.text) ||
              ''
            )
          : '';
        // Also try to get full description from prediction (more complete address)
        const predFullText = pred
          ? (
              pred.description ||
              (pred.structuredFormat && (
                (pred.structuredFormat.mainText?.text || '') +
                (pred.structuredFormat.secondaryText?.text ? ', ' + pred.structuredFormat.secondaryText.text : '')
              )) ||
              predText ||
              ''
            )
          : '';
        // Ensure we have something stored even if API calls fail
        const fallbackText = visibleTxt || predFullText || predText;
        if(fallbackText) setAutocompleteStoredValue(hiddenId, fallbackText);
        const place = await resolvePlaceFromAutocompleteEvent(ev);
        if(place){
          // Try formattedAddress, then prediction text fallback, then our extracted fallback
          const fmt = String(
            place.formattedAddress || place.formatted_address || place._predictionText || fallbackText || ''
          ).trim();
          // Use formatted address from API if available, otherwise keep fallback
          if(fmt) setAutocompleteStoredValue(hiddenId, fmt);
          try{ populateAddressFields(place, mapping, fmt); }catch(e){}
        }else if(fallbackText){
          try{ populateAddressFields([], mapping, fallbackText); }catch(e){}
        }
      };

      placeElement.addEventListener('gmp-placeselect', onPlacePicked);
      placeElement.addEventListener('gmp-select', onPlacePicked);

      // Also listen to the newer event names
      placeElement.addEventListener('gmpx-placechange', onPlacePicked);
      placeElement.addEventListener('place_changed', onPlacePicked);

      _autocompleteInstances.set(inputId, { element: placeElement, handler: onPlacePicked, lastValue: currentValue || '' });
    }

    function populateAddressFields(components, mapping, formattedAddress) {
      let placeId = '';
      if(components && !Array.isArray(components) && typeof components === 'object'){
        const place = components;
        components = place.addressComponents || place.address_components || [];
        formattedAddress = formattedAddress
          || place.formattedAddress
          || place.formatted_address
          || '';
        placeId = String(place.id || place.placeId || place.place_id || '').trim();
      }
      const formatted = String(formattedAddress || '').trim();
      if(mapping.formatted && formatted){
        setInputValueById(mapping.formatted, formatted);
      }
      if(mapping.placeId){
        setInputValueById(mapping.placeId, placeId);
      }
      if(mapping.components){
        const payload = Array.isArray(components) ? components : [];
        if(payload.length){
          try{
            setInputValueById(mapping.components, JSON.stringify(payload));
          }catch(e){
            setInputValueById(mapping.components, '');
          }
        }else{
          setInputValueById(mapping.components, '');
        }
      }
      const hasComponents = Array.isArray(components) && components.length > 0;
      if(!hasComponents){
        if(mapping.address1 && formatted){
          setInputValueById(mapping.address1, formatted);
        }
        return;
      }

      let streetNumber = '';
      let route = '';

      components.forEach(component => {
        const types = Array.isArray(component.types) ? component.types : [];
        const longName = component.longText || component.long_name || component.name || '';

        if(types.includes('street_number')){
          streetNumber = longName;
        } else if(types.includes('route')){
          route = longName;
        }
      });

      if(mapping.address1){
        if(formatted){
          setInputValueById(mapping.address1, formatted);
        } else {
          const streetAddress = [streetNumber, route].filter(Boolean).join(' ');
          if(streetAddress){
            setInputValueById(mapping.address1, streetAddress);
          }
        }
      }
    }

    function destroyAddressAutocomplete(inputId) {
      const instance = _autocompleteInstances.get(inputId);
      if(instance && instance.element && instance.handler){
        instance.element.removeEventListener('gmp-select', instance.handler);
        instance.element.removeEventListener('gmp-placeselect', instance.handler);
        if(instance.inputHandler){
          instance.element.removeEventListener('input', instance.inputHandler);
        }
      }
      _autocompleteInstances.delete(inputId);
    }

    function getSystemTimezone() {
      try {
        return Intl.DateTimeFormat().resolvedOptions().timeZone;
      } catch (e) {
        return 'America/Chicago';
      }
    }

    const PERMISSIONS = {
      ITEMS_VIEW: 'items:view',
      ITEMS_CREATE: 'items:create',
      ITEMS_EDIT: 'items:edit',
      ITEMS_DELETE: 'items:delete',
      ITEMS_RESTORE: 'items:restore',
      ITEMS_EXPORT: 'items:export',
      ITEMS_IMPORT: 'items:import',
      ORDERS_VIEW: 'orders:view',
      ORDERS_CREATE: 'orders:create',
      ORDERS_EDIT: 'orders:edit',
      ORDERS_DELETE: 'orders:delete',
      ORDERS_RESTORE: 'orders:restore',
      ORDERS_MANAGE_SHIPPING: 'orders:manage_shipping',
      RECEIVING_VIEW: 'receiving:view',
      RECEIVING_CREATE: 'receiving:create',
      RECEIVING_EDIT: 'receiving:edit',
      RECEIVING_APPROVE: 'receiving:approve',
      RECEIVING_VOID: 'receiving:void',
      MEMBERS_VIEW: 'members:view',
      MEMBERS_INVITE: 'members:invite',
      MEMBERS_REMOVE: 'members:remove',
      MEMBERS_CHANGE_ROLE: 'members:change_role',
      COMPANY_VIEW_SETTINGS: 'company:view_settings',
      COMPANY_EDIT_SETTINGS: 'company:edit_settings',
      AUDIT_LOG_VIEW: 'audit_log:view',
      METRICS_VIEW: 'metrics:view',
      SNAPSHOTS_VIEW: 'snapshots:view',
      PLATFORM_VIEW_ALL: 'platform:view_all_companies',
      PLATFORM_MANAGE_ROLES: 'platform:manage_roles',
      PLATFORM_VIEW_METRICS: 'platform:view_metrics',
    };
    const LEGACY_PERMISSION_MAP = {
      [PERMISSIONS.ITEMS_VIEW]: { any:['can_read'] },
      [PERMISSIONS.ITEMS_CREATE]: { any:['can_create'] },
      [PERMISSIONS.ITEMS_EDIT]: { any:['can_update'] },
      [PERMISSIONS.ITEMS_DELETE]: { any:['can_delete'] },
      [PERMISSIONS.ITEMS_RESTORE]: { any:['can_delete'] },
      [PERMISSIONS.ITEMS_EXPORT]: { any:['can_read'] },
      [PERMISSIONS.ITEMS_IMPORT]: { all:['can_create','can_update'] },
      [PERMISSIONS.ORDERS_VIEW]: { any:['can_read'] },
      [PERMISSIONS.ORDERS_CREATE]: { any:['can_create'] },
      [PERMISSIONS.ORDERS_EDIT]: { any:['can_update'] },
      [PERMISSIONS.ORDERS_DELETE]: { any:['can_delete'] },
      [PERMISSIONS.ORDERS_RESTORE]: { any:['can_delete'] },
      [PERMISSIONS.MEMBERS_VIEW]: { any:['can_manage_users','can_invite'] },
      [PERMISSIONS.MEMBERS_INVITE]: { any:['can_invite'] },
      [PERMISSIONS.MEMBERS_REMOVE]: { any:['can_manage_users'] },
      [PERMISSIONS.MEMBERS_CHANGE_ROLE]: { any:['can_manage_users'] },
      [PERMISSIONS.AUDIT_LOG_VIEW]: { any:['can_invite'] },
      [PERMISSIONS.METRICS_VIEW]: { any:['can_invite'] },
      [PERMISSIONS.SNAPSHOTS_VIEW]: { any:['can_delete'] },
      [PERMISSIONS.RECEIVING_VIEW]: { any:['can_read'] },
      [PERMISSIONS.RECEIVING_CREATE]: { any:['can_create'] },
      [PERMISSIONS.RECEIVING_EDIT]: { any:['can_update'] },
      [PERMISSIONS.RECEIVING_APPROVE]: { any:['can_update'] },
      [PERMISSIONS.RECEIVING_VOID]: { any:['can_delete'] },
      [PERMISSIONS.PLATFORM_VIEW_ALL]: { any:['is_super_user'] },
      [PERMISSIONS.PLATFORM_MANAGE_ROLES]: { any:['is_super_user'] },
      [PERMISSIONS.PLATFORM_VIEW_METRICS]: { any:['is_super_user'] },
    };
    const IMPERSONATION_ROLES = IMUtils.buildImpersonationRoleOptions
      ? IMUtils.buildImpersonationRoleOptions(['super_user','admin','member','viewer'])
      : ['super_user','admin','member','viewer'];
    const IMPERSONATION_LOG_LIMIT = 25;
    const UI_VISIBILITY = (window.UI_VISIBILITY && typeof window.UI_VISIBILITY === 'object')
      ? window.UI_VISIBILITY
      : {
          inventory_action: {
            row: {
              edit_item: ['viewer','user','admin','super_user'],
              add_to_job: ['viewer','user','admin','super_user'],
              order_item: ['viewer','user','admin','super_user'],
              delete_item: ['admin','super_user']
            }
          }
        };
    // Always sync inventory_action.row visibility with defaults (both window and const)
    if(!window.UI_VISIBILITY) window.UI_VISIBILITY = {};
    if(!window.UI_VISIBILITY.inventory_action) window.UI_VISIBILITY.inventory_action = {};
    if(!window.UI_VISIBILITY.inventory_action.row){
      window.UI_VISIBILITY.inventory_action.row = {
        edit_item: ['viewer','user','admin','super_user'],
        add_to_job: ['viewer','user','admin','super_user'],
        order_item: ['viewer','user','admin','super_user'],
        delete_item: ['admin','super_user']
      };
    }
    // Also ensure the const UI_VISIBILITY has this property (in case it was bound to empty window.UI_VISIBILITY)
    if(!UI_VISIBILITY.inventory_action) UI_VISIBILITY.inventory_action = {};
    if(!UI_VISIBILITY.inventory_action.row){
      UI_VISIBILITY.inventory_action.row = {
        edit_item: ['viewer','user','admin','super_user'],
        add_to_job: ['viewer','user','admin','super_user'],
        order_item: ['viewer','user','admin','super_user'],
        delete_item: ['admin','super_user']
      };
    }
    const TIER_ORDER = ['starter','professional','business','enterprise'];
    const TIER_LABELS = {
      starter: 'Starter',
      professional: 'Professional',
      business: 'Business',
      enterprise: 'Enterprise'
    };
    const TIER_FALLBACK = 'starter';
    function getCompanyStorageKey(){
      const uid = (SB && SB.user && SB.user.id) ? String(SB.user.id) : 'anon';
      return `${COMPANY_STORAGE_PREFIX}.${uid}`;
    }
    function readSavedCompanyId(){
      try{
        const raw = localStorage.getItem(getCompanyStorageKey());
        const id = String(raw || '').trim();
        return id || null;
      }catch(e){ return null; }
    }
    function saveCompanyId(companyId){
      try{
        const id = String(companyId || '').trim();
        if(!id) return;
        localStorage.setItem(getCompanyStorageKey(), id);
        state._defaultCompanyId = id;
      }catch(e){}
    }
    async function sbLoadCompanies(){
      SB.companies = [];
      SB.companyId = null;
      SB.company = null;
      if(!SB.ready || !SB.user) return null;
      // First load with production only
      const { data, error } = await SB.client.rpc('get_my_companies', { p_include_non_production: false });
      if(error) throw error;
      let rows = Array.isArray(data) ? data : [];
      // If user is super user (any row has is_super_user=true), reload with all company types
      const isSuperUserFromRows = rows.some(r => r.is_super_user === true);
      if(isSuperUserFromRows && rows.length > 0){
        const { data: allData, error: allError } = await SB.client.rpc('get_my_companies', { p_include_non_production: true });
        if(!allError && Array.isArray(allData)){
          rows = allData;
        }
      }
      SB.companies = rows;
      let selected = readSavedCompanyId();
      if(selected && !rows.some(r => String(r.company_id) === String(selected))) selected = null;
      if(!selected && rows.length) selected = rows[0].company_id;
      SB.companyId = selected ? String(selected) : null;
      state._defaultCompanyId = SB.companyId ? String(SB.companyId) : null;
      SB.company = SB.companyId ? rows.find(r => String(r.company_id) === String(SB.companyId)) || null : null;
      SB.companyTier = SB.company ? getCompanyTier() : null;
      if(SB.companyId) saveCompanyId(SB.companyId);
      return SB.companyId;
    }
    async function sbLoadPermissions(){
      SB.permissions = null;
      if(!SB.ready || !SB.user || !SB.companyId) return null;
      try{
        const { data, error } = await SB.client.rpc('get_user_permissions', { p_company_id: SB.companyId });
        if(error) throw error;
        let merged = (data && typeof data === 'object') ? data : null;
        try{
          const { data: meta } = await SB.client.rpc('get_my_permissions', { p_company_id: SB.companyId });
          if(meta && typeof meta === 'object'){
            merged = merged ? { ...meta, ...merged } : meta;
          }
        }catch(metaErr){}
        SB.permissions = merged;
        return SB.permissions;
      }catch(e){
        const { data, error } = await SB.client.rpc('get_my_permissions', { p_company_id: SB.companyId });
        if(error) throw error;
        SB.permissions = (data && typeof data === 'object') ? data : null;
        return SB.permissions;
      }
    }
    function sbInit(){
      const url = window.SB_URL, key = window.SB_ANON;
      if(!url || !key || SB.client){ return; }
      try{
        if(!window.supabase || typeof window.supabase.createClient !== 'function'){
          console.warn('Supabase library not loaded; running in offline mode');
          SB.ready = false;
          return;
        }
        SB.client = window.supabase.createClient(url, key);
        SB.ready = true;
      }catch(err){
        console.warn('Supabase init failed:', err);
        SB.ready = false;
      }
    }
    function formatRoleBadgeLabel(role){
      const value = String(role || '').trim().toLowerCase();
      if(value === 'super_user') return 'SUPER USER';
      if(value === 'admin') return 'ADMIN';
      if(value === 'member' || value === 'user') return 'USER';
      if(value === 'viewer') return 'VIEWER';
      return 'GUEST';
    }
    function renderProfileHeaderInfo(){
      const emailEl = $('profileEmail');
      const companyEl = $('profileCompanyName');
      const headerCompanyEl = $('headerCompanyName');
      const roleEl = $('profileRoleBadge');
      const email = SB.session?.user?.email || (SB.ready ? 'Not signed in' : 'Not configured');
      if(emailEl) emailEl.textContent = email;
      const companyName = SB.company ? String(SB.company.company_name || SB.company.company_slug || SB.company.company_id || '').trim() : '';
      if(companyEl) companyEl.textContent = companyName || 'No company selected';
      if(headerCompanyEl) headerCompanyEl.textContent = companyName || '';
      const roleLabel = SB.session ? formatRoleBadgeLabel(getEffectiveRole()) : 'GUEST';
      if(roleEl) roleEl.textContent = roleLabel;
    }
    function setProfileMenuItemVisibility(id, allowed){
      const el = $(id);
      if(!el) return;
      if(allowed){
        el.style.display = '';
        el.setAttribute('aria-hidden', 'false');
        el.disabled = false;
        el.removeAttribute('aria-disabled');
        return;
      }
      el.style.display = 'none';
      el.setAttribute('aria-hidden', 'true');
    }
    function updateProfileTeamEmpty(){
      const empty = $('profileTeamEmpty');
      if(!empty) return;
      const ids = ['openInviteModal','openUserMgmt','openRoleManager'];
      const anyVisible = ids.some((id) => {
        const el = $(id);
        return el && el.style.display !== 'none';
      });
      empty.style.display = anyVisible ? 'none' : '';
    }
    function setProfileTab(tabKey, opts = {}){
      const tabs = Array.from(document.querySelectorAll('#profileTabList .profile-tab'));
      const panels = Array.from(document.querySelectorAll('#profileTabPanels .profile-panel'));
      if(!tabs.length) return;
      const desired = String(tabKey || '').trim();
      const resolved = tabs.some(tab => tab.dataset.tab === desired) ? desired : 'account';
      const current = tabs.find(tab => tab.classList.contains('is-active'));
      if(current && current.dataset.tab === resolved && !opts.force) return;
      tabs.forEach(tab => {
        const active = tab.dataset.tab === resolved;
        tab.classList.toggle('is-active', active);
        tab.setAttribute('aria-selected', active ? 'true' : 'false');
        tab.tabIndex = active ? 0 : -1;
      });
      panels.forEach(panel => {
        const active = panel.dataset.panel === resolved;
        if(active){
          panel.classList.add('is-active');
          panel.classList.remove('is-leaving');
          return;
        }
        if(panel.classList.contains('is-active')){
          panel.classList.add('is-leaving');
          setTimeout(() => {
            panel.classList.remove('is-active');
            panel.classList.remove('is-leaving');
          }, 160);
        }else{
          panel.classList.remove('is-active');
          panel.classList.remove('is-leaving');
        }
      });
      state._profileTab = resolved;
      try{ sessionStorage.setItem(PROFILE_TAB_STORAGE_KEY, resolved); }catch(e){}
    }
    function restoreProfileTab(){
      let target = state._profileTab;
      if(!target){
        try{ target = sessionStorage.getItem(PROFILE_TAB_STORAGE_KEY) || ''; }catch(e){}
      }
      setProfileTab(target || 'account', { force:true });
    }
    function initProfileTabs(){
      const tabList = $('profileTabList');
      if(!tabList || tabList._wired) return;
      tabList._wired = true;
      tabList.addEventListener('click', (e)=>{
        const btn = e.target.closest('.profile-tab');
        if(!btn) return;
        setProfileTab(btn.dataset.tab);
      });
      tabList.addEventListener('keydown', (e)=>{
        if(e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;
        const tabs = Array.from(tabList.querySelectorAll('.profile-tab'));
        if(!tabs.length) return;
        const idx = tabs.findIndex(tab => tab.classList.contains('is-active'));
        if(idx < 0) return;
        const dir = e.key === 'ArrowRight' ? 1 : -1;
        const nextIdx = (idx + dir + tabs.length) % tabs.length;
        const nextTab = tabs[nextIdx];
        if(nextTab){
          e.preventDefault();
          setProfileTab(nextTab.dataset.tab);
          nextTab.focus();
        }
      });
      const dropdown = $('profileDropdown');
      if(dropdown && !dropdown._keywired){
        dropdown._keywired = true;
        dropdown.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape'){
            closeProfileMenu();
            $('profileBtn')?.focus();
          }
        });
      }
    }
    function syncProfileTabsForRole(){
      const tabList = $('profileTabList');
      const panels = $('profileTabPanels');
      if(!tabList || !panels) return;
      const isSuper = !!(SB.session && isSuperUser());
      let devTab = $('profileTabDeveloper');
      let devPanel = $('profilePanelDeveloper');
      if(isSuper){
        if(!devTab){
          devTab = document.createElement('button');
          devTab.className = 'profile-tab';
          devTab.type = 'button';
          devTab.id = 'profileTabDeveloper';
          devTab.dataset.tab = 'developer';
          devTab.setAttribute('role', 'tab');
          devTab.setAttribute('aria-selected', 'false');
          devTab.setAttribute('aria-controls', 'profilePanelDeveloper');
          devTab.tabIndex = -1;
          devTab.textContent = 'Developer';
          tabList.appendChild(devTab);
        }
        if(!devPanel){
          devPanel = document.createElement('div');
          devPanel.className = 'profile-panel';
          devPanel.id = 'profilePanelDeveloper';
          devPanel.dataset.panel = 'developer';
          devPanel.setAttribute('role', 'tabpanel');
          devPanel.setAttribute('aria-labelledby', 'profileTabDeveloper');
          devPanel.tabIndex = 0;
          devPanel.innerHTML = `
            <button class="profile-item" id="openAdvancedCompanySwitcher" type="button">
              <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
              <span>Manage Companies</span>
            </button>
            <button class="profile-item" id="openDiagnostics" type="button">
              <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 3v18h18"></path>
                <path d="M18 17v-6"></path>
                <path d="M13 17v-9"></path>
                <path d="M8 17v-3"></path>
              </svg>
              <span>Diagnostics</span>
            </button>
          `;
          panels.appendChild(devPanel);
        }
        wireDeveloperProfileActions();
      }else{
        if(devTab) devTab.remove();
        if(devPanel) devPanel.remove();
        if(state._profileTab === 'developer'){
          state._profileTab = 'account';
          try{ sessionStorage.setItem(PROFILE_TAB_STORAGE_KEY, 'account'); }catch(e){}
        }
      }
      initProfileTabs();
    }
    function closeProfileMenu(){
      const profileDropdown = $('profileDropdown');
      const profileBackdrop = $('profileBackdrop');
      if(profileDropdown){
        profileDropdown.classList.remove('open');
        profileDropdown.style.display = '';
        profileDropdown.setAttribute('aria-hidden', 'true');
      }
      if(profileBackdrop){
        profileBackdrop.classList.remove('open');
        profileBackdrop.setAttribute('aria-hidden', 'true');
      }
      $('profileBtn')?.setAttribute('aria-expanded', 'false');
    }
    function setCompanySwitcherMode(mode){
      const modal = $('advancedCompanyModal');
      if(!modal) return;
      const nextMode = mode === 'advanced' ? 'advanced' : 'basic';
      state._companySwitcherMode = nextMode;
      modal.classList.toggle('company-switcher-basic', nextMode === 'basic');
      const title = $('advancedCompanyTitle');
      const subtitle = modal.querySelector('.modal-subtitle');
      if(title) title.textContent = nextMode === 'basic' ? 'Change User Company' : 'Manage Companies';
      if(subtitle){
        subtitle.textContent = nextMode === 'basic'
          ? 'Choose the workspace you want to access.'
          : 'Switching here is temporary and does not change the user\'s default company.';
      }
      const badge = modal.querySelector('.manage-companies-badge');
      const meta = modal.querySelector('.manage-companies-header-meta');
      if(badge) badge.style.display = nextMode === 'basic' ? 'none' : '';
      if(meta) meta.style.display = nextMode === 'basic' ? 'none' : '';
    }
    function renderBasicCompanyResults(){
      const container = $('advancedCompanyResults');
      if(!container) return;
      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      if(!rows.length){
        container.innerHTML = '<div class="trash-empty">No companies available.</div>';
        return;
      }
      const header = '<thead><tr><th>Company</th><th>Role</th><th>Action</th></tr></thead>';
      const body = rows.map(row => {
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || 'Company';
        const id = String(row.company_id || '').trim();
        const role = row.is_super_user ? 'super_user' : String(row.my_role || '').trim();
        const roleLabel = role ? formatRoleBadgeLabel(role) : 'USER';
        const envType = normalizeEnvironmentType(row.environment_type);
        const envBadge = isNonProductionEnvironment(envType)
          ? `<span class="env-badge env-${escapeHtmlAttr(envType)}">${escapeHtml(formatEnvironmentBadgeText(envType))}</span>`
          : '';
        const isCurrent = String(SB.companyId || '') === id;
        const actionLabel = isCurrent ? 'Current' : 'Switch';
        const disabled = isCurrent ? 'disabled aria-disabled="true"' : '';
        return (
          `<tr>` +
            `<td>` +
              `<div class="manage-companies-name">` +
                `<span>${escapeHtml(name)}</span>` +
                `${envBadge}` +
              `</div>` +
              `<div class="advanced-switcher-id">${escapeHtml(id)}</div>` +
            `</td>` +
            `<td>${escapeHtml(roleLabel)}</td>` +
            `<td><div class="advanced-switcher-row-actions">` +
              `<button class="btn-tertiary btn-sm" type="button" data-basic-switch="${escapeHtmlAttr(id)}" ${disabled}>${escapeHtml(actionLabel)}</button>` +
            `</div></td>` +
          `</tr>`
        );
      }).join('');
      container.innerHTML = `<table class="advanced-switcher-table">${header}<tbody>${body}</tbody></table>`;
      if(!container._basicWired){
        container._basicWired = true;
        container.addEventListener('click', async (e)=>{
          const btn = e.target.closest('[data-basic-switch]');
          if(!btn) return;
          const targetId = String(btn.getAttribute('data-basic-switch') || '').trim();
          if(!targetId || targetId === String(SB.companyId || '')) return;
          const ok = await sbSwitchCompany(targetId);
          if(ok){
            const row = (Array.isArray(SB.companies) ? SB.companies : [])
              .find(r => String(r.company_id || '') === targetId);
            const name = row ? String(row.company_name || row.company_slug || row.company_id || 'company') : 'company';
            toast(`Switched to ${name}`);
            renderBasicCompanyResults();
          }
        });
      }
    }
    async function openCompanySwitcherModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      setCompanySwitcherMode('basic');
      setAdvancedCompanyMessage('');
      renderBasicCompanyResults();
      show('advancedCompanyModal', true);
    }
    function updateStatusBar(){
      // Update profile dropdown UI
      const statusEl = $('profileStatus');
      const emailEl = $('profileEmail');
      const signInText = $('profileSignInText');
      const signInBtn = $('profileSignIn');

      // Icon SVGs
      const signInIcon = '<svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>';
      const signOutIcon = '<svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>';

      function setSignInUI(text, icon, danger){
        if(signInText) signInText.textContent = text;
        if(signInBtn){
          signInBtn.classList.toggle('profile-item--danger', !!danger);
          const svg = signInBtn.querySelector('svg');
          if(svg) svg.outerHTML = icon;
        }
      }

      if(statusEl) statusEl.classList.remove('online','offline','warning');
      renderCompanyEnvBadge();

      if(!SB.ready){
        if(emailEl) emailEl.textContent = 'Not configured';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Configure', signInIcon, false);
        renderProfileHeaderInfo();
        return;
      }
      if(!SB.session){
        if(emailEl) emailEl.textContent = 'Not signed in';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Sign In', signInIcon, false);
        renderProfileHeaderInfo();
        return;
      }

      // Show user email
      const userEmail = SB.session?.user?.email || 'Unknown user';
      if(emailEl) emailEl.textContent = userEmail;

      const testingLabel = isImpersonating() ? ` Â· Testing: ${getEffectiveRole()}` : '';
      if(!SB.authorized){
        const reason = (!SB.companyId) ? 'No company access' : ((!SB.permissions || !hasPermission(PERMISSIONS.ITEMS_VIEW)) ? 'Permission denied' : 'Not authorized');
        if(statusEl) statusEl.classList.add('warning');
        setSignInUI('Sign Out', signOutIcon, true);
        renderProfileHeaderInfo();
        return;
      }
      const companyName = (SB.company && SB.company.company_name) ? ` Â· ${SB.company.company_name}` : '';
      if(SB.connected){
        if(statusEl) statusEl.classList.add('online');
      }else{
        if(statusEl) statusEl.classList.add('offline');
      }
      setSignInUI('Sign Out', signOutIcon, true);
      renderProfileHeaderInfo();
    }
    function explainGate(){
      if(!SB.ready) return 'Supabase not configured';
      if(!SB.session) return 'Sign in required';
      if(!SB.companyId) return 'No company access';
      if(!SB.permissions || !hasPermission(PERMISSIONS.ITEMS_VIEW)) return 'Permission denied';
      if(!SB.authorized) return 'Not authorized';
      if(!SB.connected) return 'Offline â€“ edits disabled';
      return '';
    }
    async function checkServerHealth(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId){ SB.connected=false; updateStatusBar(); return false; }
      try{
        const { error } = await SB.client
          .from('inventory_items')
          .select('id', { head:true, count:'exact' })
          .eq('company_id', SB.companyId)
          .is('deleted_at', null)
          .limit(1);
        if(error) throw error;
        SB.connected = true;
      }catch(e){ SB.connected=false; }
      updateStatusBar();
      return SB.connected;
    }
    function isOnline(){ return SB.ready && !!SB.session && SB.authorized && SB.connected; }
    function requireOnline(){
      if(isOnline()) return true;
      const msg = explainGate();
      if(msg) toast(msg);
      if(!SB.session) show('authModal', true);
      return false;
    }
    function normalizeTier(value){
      const tier = String(value || '').trim().toLowerCase();
      return TIER_ORDER.includes(tier) ? tier : '';
    }
    function getCompanyTier(){
      const fromCompany = SB.company ? (SB.company.effective_tier || SB.company.company_tier || SB.company.tier || '') : '';
      const tier = normalizeTier(fromCompany);
      if(tier) return tier;
      if(SB.companyId && !SB.warnedTierMissing){
        SB.warnedTierMissing = true;
        console.warn('Company tier missing; defaulting to', TIER_FALLBACK);
      }
      return TIER_FALLBACK;
    }
    function hasTier(minTier){
      if(isEffectiveSuperUser()) return true;
      const current = normalizeTier(getCompanyTier()) || TIER_FALLBACK;
      const target = normalizeTier(minTier);
      if(!target) return true;
      return TIER_ORDER.indexOf(current) >= TIER_ORDER.indexOf(target);
    }
    function normalizeRoleName(value){
      if(IMUtils.normalizeImpersonationRole){
        return IMUtils.normalizeImpersonationRole(value, IMPERSONATION_ROLES);
      }
      const role = String(value || '').trim().toLowerCase();
      return IMPERSONATION_ROLES.includes(role) ? role : '';
    }
    function ensureImpersonationRole(value){
      if(IMUtils.ensureImpersonationRole){
        return IMUtils.ensureImpersonationRole(value, IMPERSONATION_ROLES);
      }
      return normalizeRoleName(value) || 'super_user';
    }
    function getImpersonationRoleOptions(){
      if(IMUtils.buildImpersonationRoleOptions){
        return IMUtils.buildImpersonationRoleOptions(IMPERSONATION_ROLES);
      }
      return IMPERSONATION_ROLES.slice();
    }
    function getAuthorityRole(){
      const raw = String((SB.company && SB.company.my_role) || (SB.permissions && SB.permissions.role) || '').trim();
      const normalized = normalizeRoleName(raw);
      if(normalized) return normalized;
      return isSuperUser() ? 'super_user' : '';
    }
    function isImpersonating(){
      const role = normalizeRoleName(state._impersonationRole);
      return !!(isSuperUser() && role && role !== 'super_user');
    }
    function getEffectiveRole(){
      if(isImpersonating()){
        return normalizeRoleName(state._impersonationRole) || 'super_user';
      }
      return getAuthorityRole();
    }
    function isEffectiveSuperUser(){
      return isSuperUser() && !isImpersonating();
    }
    function getEffectivePermissions(){
      if(isImpersonating() && state._impersonationPermissions && typeof state._impersonationPermissions === 'object'){
        return state._impersonationPermissions;
      }
      return SB.permissions;
    }
    function getImpersonationLogKey(){
      const userId = SB.user && SB.user.id ? String(SB.user.id) : 'anonymous';
      return `inv.impersonation.log.${userId}`;
    }
    function logImpersonationEvent(fromRole, toRole, reason){
      if(!SB.user) return;
      const entry = {
        ts: new Date().toISOString(),
        user_id: SB.user.id,
        company_id: SB.companyId || null,
        company_name: (SB.company && SB.company.company_name) ? SB.company.company_name : null,
        from: fromRole,
        to: toRole,
        reason: reason || 'manual',
      };
      try{
        const key = getImpersonationLogKey();
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        const list = Array.isArray(existing) ? existing : [];
        list.unshift(entry);
        if(list.length > IMPERSONATION_LOG_LIMIT) list.length = IMPERSONATION_LOG_LIMIT;
        localStorage.setItem(key, JSON.stringify(list));
      }catch(e){}
      console.info('[impersonation]', entry);
    }
    function resetImpersonationState(reason){
      const prev = normalizeRoleName(state._impersonationRole) || 'super_user';
      state._impersonationRole = 'super_user';
      state._impersonationPermissions = null;
      if(prev && prev !== 'super_user'){
        logImpersonationEvent(prev, 'super_user', reason || 'reset');
      }
    }
    async function loadImpersonationPermissions(role){
      if(!role || role === 'super_user') return null;
      const cached = state._roleConfigs && state._roleConfigs[role];
      if(cached && typeof cached === 'object') return cached;
      if(!SB.ready || !SB.session || !SB.client) return null;
      try{
        const { data, error } = await SB.client
          .from('role_configurations')
          .select('permissions')
          .eq('role_name', role)
          .maybeSingle();
        if(error) throw error;
        if(data && typeof data.permissions === 'object') return data.permissions;
        return {};
      }catch(e){
        console.warn('Impersonation permissions load failed:', e);
        return null;
      }
    }
    function refreshImpersonationUi(){
      updateStatusBar();
      renderRoleTestingSwitcher();
      renderInviteUi();
      renderProfileMenuVisibility();
      renderAdvancedCompanySwitcherButton();
      renderProvisioningDashboardButton();
      renderDiagnosticsButton();
      renderSubscriptionManagerButton();
      renderCompanyLocationsButton();
      renderRoleManagerButton();
      renderUserMgmtButton();
      renderUserMgmtControls();
      renderUserMgmtList();
      renderPendingInvitesSection();
      renderPendingInvitesList();
      renderTierAdminSection();
      applyPermissionUI();
      render();
    }
    async function setImpersonationRole(nextRole, reason){
      if(!isSuperUser()){
        resetImpersonationState('not_super_user');
        refreshImpersonationUi();
        return false;
      }
      const desired = ensureImpersonationRole(nextRole);
      const prev = normalizeRoleName(state._impersonationRole) || 'super_user';
      if(desired === 'super_user'){
        if(prev !== 'super_user'){
          resetImpersonationState(reason || 'manual');
          refreshImpersonationUi();
        }
        return true;
      }
      state._impersonationRole = desired;
      const permissions = await loadImpersonationPermissions(desired);
      state._impersonationPermissions = (permissions && typeof permissions === 'object') ? permissions : {};
      if(prev !== desired){
        logImpersonationEvent(prev, desired, reason || 'manual');
      }
      refreshImpersonationUi();
      return true;
    }
    function hasPermission(key){
      const permissions = getEffectivePermissions();
      if(!permissions || !key) return false;
      if(Object.prototype.hasOwnProperty.call(permissions, key)){
        return permissions[key] === true;
      }
      const legacy = LEGACY_PERMISSION_MAP[key];
      if(legacy && Array.isArray(legacy.any)){
        return legacy.any.some(k => permissions[k] === true);
      }
      if(legacy && Array.isArray(legacy.all)){
        return legacy.all.every(k => permissions[k] === true);
      }
      return false;
    }
    function requirePermission(key, message){
      if(hasPermission(key)) return true;
      toast(message || 'Permission denied');
      return false;
    }
    function isSuperUser(){
      if(SB.company && SB.company.is_super_user) return true;
      if(SB.permissions && SB.permissions.is_super_user === true) return true;
      const role = String((SB.company && SB.company.my_role) || (SB.permissions && SB.permissions.role) || '').trim();
      return role === 'super_user';
    }
    function canItemsView(){ return hasPermission(PERMISSIONS.ITEMS_VIEW); }
    function canItemsCreate(){ return hasPermission(PERMISSIONS.ITEMS_CREATE); }
    function canItemsEdit(){ return hasPermission(PERMISSIONS.ITEMS_EDIT); }
    function canItemsDelete(){ return hasPermission(PERMISSIONS.ITEMS_DELETE); }
    function canItemsRestore(){ return hasPermission(PERMISSIONS.ITEMS_RESTORE); }
    function canItemsExport(){ return hasTier('professional') && hasPermission(PERMISSIONS.ITEMS_EXPORT); }
    function canItemsImport(){ return hasTier('professional') && hasPermission(PERMISSIONS.ITEMS_IMPORT); }
    function canOrdersView(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_VIEW); }
    function canOrdersCreate(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_CREATE); }
    function canOrdersEdit(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_EDIT); }
    function canOrdersDelete(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_DELETE); }
    function canOrdersManageShipping(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_MANAGE_SHIPPING); }
    function canAccessCompanyLocations(){
      if(isEffectiveSuperUser()) return true;
      const role = getEffectiveRole();
      return role === 'admin';
    }
    function canManageCompanyLocations(){
      return canAccessCompanyLocations();
    }
    function canReceivingView(){ return hasTier('professional') && hasPermission(PERMISSIONS.RECEIVING_VIEW); }
    function canReceivingCreate(){ return hasTier('professional') && hasPermission(PERMISSIONS.RECEIVING_CREATE); }
    function canReceivingEdit(){ return hasTier('professional') && hasPermission(PERMISSIONS.RECEIVING_EDIT); }
    function canReceivingApprove(){ return hasTier('professional') && hasPermission(PERMISSIONS.RECEIVING_APPROVE); }
    function canReceivingVoid(){ return hasTier('enterprise') && hasPermission(PERMISSIONS.RECEIVING_VOID); }
    function canReceiveOrders(){
      return canReceivingCreate() || canReceivingEdit() || canReceivingApprove();
    }
    function canAccessReceivingInbox(){
      return !!(SB.session && SB.authorized);
    }
    function canManageReceiptAttachments(){
      if(isEffectiveSuperUser()) return true;
      return hasPermission(PERMISSIONS.COMPANY_EDIT_SETTINGS);
    }
    function canMembersView(){ return hasPermission(PERMISSIONS.MEMBERS_VIEW); }
    function canMembersInvite(){ return hasPermission(PERMISSIONS.MEMBERS_INVITE); }
    function canMembersRemove(){ return hasPermission(PERMISSIONS.MEMBERS_REMOVE); }
    function canMembersChangeRole(){ return hasPermission(PERMISSIONS.MEMBERS_CHANGE_ROLE); }
    function canAuditView(){ return hasPermission(PERMISSIONS.AUDIT_LOG_VIEW); }
    function canMetricsView(){ return hasPermission(PERMISSIONS.METRICS_VIEW); }
    function canSnapshotsView(){ return hasPermission(PERMISSIONS.SNAPSHOTS_VIEW); }
    function canPlatformMetricsView(){ return hasPermission(PERMISSIONS.PLATFORM_VIEW_METRICS); }
    function canManageRoles(){ return hasPermission(PERMISSIONS.PLATFORM_MANAGE_ROLES) || isEffectiveSuperUser(); }
    function canAccessTrash(){ return canItemsDelete() || canItemsRestore(); }
    function canAccessMembers(){ return canMembersView() && hasTier('business'); }
    function canAccessInvites(){ return canMembersInvite() && hasTier('business'); }
    function canAccessAuditLog(){
      return canAuditView() && hasTier('enterprise');
    }
    function canAccessSnapshots(){
      return canSnapshotsView() && hasTier('business');
    }
    function canAccessMetrics(){
      const allowCompany = canMetricsView() && hasTier('professional');
      const allowPlatform = canPlatformMetricsView() && isEffectiveSuperUser() && hasTier('professional');
      return allowCompany || allowPlatform;
    }
    function canAccessRoleManager(){
      return isEffectiveSuperUser() && canManageRoles() && hasTier('business');
    }
    function canCreate(){ return canItemsCreate(); }
    function canUpdate(){ return canItemsEdit(); }
    function canDelete(){ return canItemsDelete(); }
    function canInvite(){ return canMembersInvite(); }
    function canManageUsers(){ return canMembersChangeRole() || canMembersRemove(); }
    function applyPermissionUI(){
      const canRead = canItemsView();
      const allowSelect = canItemsCreate() || canItemsEdit() || canItemsDelete();
      const canBulk = canItemsImport();
      const setDisabled = (id, disabled) => {
        const el = $(id);
        if(!el) return;
        el.disabled = !!disabled;
        el.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      };
      setDisabled('menuImport', !canBulk);
      setDisabled('menuPaste', !canBulk);
      setDisabled('menuAddOne', !canItemsCreate());
      setDisabled('menuOrder', !canOrdersCreate());
      setDisabled('menuQuickOrder', !canOrdersCreate());
      setDisabled('menuHistory', !canOrdersView());
      setDisabled('menuReceive', !canAccessReceivingInbox());
      setDisabled('menuTrash', !canAccessTrash());
      setDisabled('menuAudit', !canAccessAuditLog());
      setDisabled('menuSnapshots', !canAccessSnapshots());
      setDisabled('menuMetrics', !canAccessMetrics());
      setDisabled('menuExport', !canItemsExport());
      setDisabled('menuReport', !canItemsView());
      setDisabled('btnOrderSubmit', !canOrdersCreate());
      setDisabled('btnOrderShippingManage', !canOrdersManageShipping());
      setDisabled('btnEditItemDelete', !canItemsDelete());
      setDisabled('btnReportBatchOrder', !canOrdersCreate());
      const chkAll = $('chkAll');
      if(chkAll) chkAll.disabled = !allowSelect;
      setEditHint();
      renderReceiptsInboxIndicator();
    }

    // ---------- Auth + profile ----------
    function renderAuthUi(){
      const submit = $('btnAuthSubmit');
      const pw = $('authPassword');
      const pwLabel = $('authPasswordLabel');
      if(submit) submit.textContent = 'Sign In';
      if(pw) pw.autocomplete = 'current-password';
      if(pwLabel) pwLabel.textContent = 'Password';
    }
    function setAuthMessage(msg){
      const el = $('authMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setResetMessage(msg){
      const el = $('resetMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setAuditMessage(msg){
      const el = $('auditMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function auditSearchText(row){
      const action = String(row.action || '').trim();
      const tableName = String(row.table_name || '').trim();
      const recordId = String(row.record_id || '').trim();
      const user = String(row.user_email || '').trim();
      const role = String(row.user_role || '').trim();
      const oldVals = row.old_values ? JSON.stringify(row.old_values) : '';
      const newVals = row.new_values ? JSON.stringify(row.new_values) : '';
      const changed = Array.isArray(row.changed_fields) ? row.changed_fields.join(' ') : '';
      return `${action} ${tableName} ${recordId} ${user} ${role} ${changed} ${oldVals} ${newVals}`.toLowerCase();
    }
    function filteredAuditRows(){
      const rows = Array.isArray(state._auditRows) ? state._auditRows : [];
      const raw = String(state._auditSearch || '').trim().toLowerCase();
      if(!raw) return rows;
      const tokens = raw.split(/\s+/g).filter(Boolean);
      return rows.filter(r => {
        const hay = auditSearchText(r);
        return tokens.every(t => hay.includes(t));
      });
    }
    function setUserMgmtMessage(msg){
      const el = $('userMgmtMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function renderAuditList(){
      const list = $('auditList');
      if(!list) return;
      const rows = filteredAuditRows();
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No audit entries.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const action = String(row.action || '').trim();
        const tableName = String(row.table_name || '').trim();
        const when = row.created_at ? formatEasternDateTime(row.created_at) : '';
        const user = String(row.user_email || '').trim();
        const role = String(row.user_role || '').trim();
        const summary = [action, tableName].filter(Boolean).join(' Â· ');
        const meta = [when, user, role].filter(Boolean).join(' Â· ');
        const oldVals = row.old_values ? JSON.stringify(row.old_values, null, 2) : '';
        const newVals = row.new_values ? JSON.stringify(row.new_values, null, 2) : '';
        const changed = Array.isArray(row.changed_fields) && row.changed_fields.length
          ? `Changed: ${row.changed_fields.join(', ')}`
          : '';
        return (
          `<details class="audit-card">`+
            `<summary>`+
              `<div class="audit-summary">`+
                `<div class="audit-title">${escapeHtml(summary || 'Entry')}</div>`+
                `<div class="audit-meta">${escapeHtml(meta)}</div>`+
              `</div>`+
              `<span class="audit-caret" aria-hidden="true">`+
                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">`+
                  `<polyline points="9 18 15 12 9 6"></polyline>`+
                `</svg>`+
              `</span>`+
            `</summary>`+
            `<div class="audit-body">`+
              `${changed ? `<div class="audit-meta">${escapeHtml(changed)}</div>` : ''}`+
              `${oldVals ? `<div class="audit-json">Old: ${escapeHtml(oldVals)}</div>` : ''}`+
              `${newVals ? `<div class="audit-json">New: ${escapeHtml(newVals)}</div>` : ''}`+
            `</div>`+
          `</details>`
        );
      }).join('');
    }
    function buildAuditCsv(rows){
      const header = [
        'Audit ID',
        'Created At (UTC)',
        'Created (Eastern)',
        'Action',
        'Table',
        'Record ID',
        'User Email',
        'User Role',
        'Changed Fields',
        'Old Values',
        'New Values',
      ];
      const out = [header.map(csvEscape).join(',')];
      const list = Array.isArray(rows) ? rows : [];
      for(const row of list){
        const createdAt = String(row?.created_at || '').trim();
        const createdEastern = createdAt ? formatEasternDateTime(createdAt) : '';
        out.push([
          String(row?.id || '').trim(),
          createdAt,
          createdEastern,
          String(row?.action || '').trim(),
          String(row?.table_name || '').trim(),
          String(row?.record_id || '').trim(),
          String(row?.user_email || '').trim(),
          String(row?.user_role || '').trim(),
          Array.isArray(row?.changed_fields) ? row.changed_fields.join(' ') : '',
          row?.old_values ? JSON.stringify(row.old_values) : '',
          row?.new_values ? JSON.stringify(row.new_values) : '',
        ].map(csvEscape).join(','));
      }
      return '\ufeff' + out.join('\n');
    }
    async function downloadAuditCsv(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!hasTier('enterprise')){ toast('Audit log requires Enterprise tier', 'info'); return; }
      if(!canAuditView()){ toast('Permission denied', 'error'); return; }
      const btn = $('btnAuditDownload');
      const priorTitle = btn ? btn.getAttribute('title') : '';
      if(btn){ btn.disabled = true; btn.setAttribute('title', 'Downloadingâ€¦'); }
      try{
        const rows = filteredAuditRows();
        if(!rows.length){ toast('No audit entries to download'); return; }
        const csv = buildAuditCsv(rows);
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.download = `audit-log-${stamp}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toast(`Downloaded ${rows.length} audit entries`);
      }catch(e){
        toast((e && e.message) ? e.message : 'Download failed');
      }finally{
        if(btn){ btn.disabled = false; btn.setAttribute('title', priorTitle || 'Download CSV'); }
      }
    }
    async function refreshAuditLog(){
      const list = $('auditList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setAuditMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        if(!hasTier('enterprise')) throw new Error('Audit log requires Enterprise tier');
        if(!canAuditView()) throw new Error('Permission denied');
        const tableFilter = String(state._auditTableFilter || '').trim() || null;
        const actionFilter = String(state._auditActionFilter || '').trim() || null;
        const { data, error } = await SB.client.rpc('get_audit_log', {
          p_company_id: SB.companyId,
          p_limit: 50,
          p_offset: 0,
          p_table_name: tableFilter,
          p_action: actionFilter,
        });
        if(error) throw error;
        state._auditRows = Array.isArray(data) ? data : [];
        renderAuditList();
      }catch(e){
        state._auditRows = [];
        const msg = e && e.message ? e.message : 'Failed to load audit log';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openAuditModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!hasTier('enterprise')){ toast('Audit log requires Enterprise tier', 'info'); return; }
      if(!canAuditView()){ toast('Permission denied', 'error'); return; }
      show('auditModal', true);
      const tableFilter = $('auditTableFilter'); if(tableFilter) tableFilter.value = state._auditTableFilter || '';
      const actionFilter = $('auditActionFilter'); if(actionFilter) actionFilter.value = state._auditActionFilter || '';
      const searchFilter = $('auditSearchFilter'); if(searchFilter) searchFilter.value = state._auditSearch || '';
      await refreshAuditLog();
    }
    function closeAuditModal(){
      show('auditModal', false);
    }

    // Feature: inventory.snapshots.ui
    const SNAPSHOT_PREVIEW_LIMIT = 200;
    function setSnapshotsMessage(msg){
      const el = $('snapshotsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function showSnapshotList(){
      const list = $('snapshotsList');
      const preview = $('snapshotPreview');
      if(list) list.style.display = '';
      if(preview) preview.style.display = 'none';
      const body = $('snapshotPreviewBody'); if(body) body.innerHTML = '';
      setSnapshotsMessage('');
    }
    function renderSnapshotsList(){
      const list = $('snapshotsList');
      if(!list) return;
      const rows = Array.isArray(state._snapshots) ? state._snapshots : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No snapshots available.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const id = String(row && row.id ? row.id : '').trim();
        const name = String(row && row.name ? row.name : 'Snapshot').trim();
        const desc = String(row && row.description ? row.description : '').trim();
        const createdAt = row && row.created_at ? formatEasternDateTime(row.created_at) : '';
        const createdBy = String(row && row.created_by_email ? row.created_by_email : '').trim();
        const itemsCount = toInt(row && row.items_count ? row.items_count : 0, 0);
        const totalQty = toInt(row && row.total_quantity ? row.total_quantity : 0, 0);
        const type = String(row && row.snapshot_type ? row.snapshot_type : '').trim();
        const restoredAt = row && row.was_restored && row.restored_at ? formatEasternDateTime(row.restored_at) : '';
        const metaParts = [];
        if(createdAt) metaParts.push(`Created: ${createdAt}`);
        if(createdBy) metaParts.push(`By: ${createdBy}`);
        metaParts.push(`Items: ${itemsCount}`);
        metaParts.push(`Qty: ${totalQty}`);
        if(type) metaParts.push(`Type: ${type}`);
        if(restoredAt) metaParts.push(`Restored: ${restoredAt}`);
        const meta = metaParts.join(' | ');
        return (
          `<div class="snapshot-card">`+
            `<div>`+
              `<div class="snapshot-title">${escapeHtml(name)}</div>`+
              `${desc ? `<div class="muted">${escapeHtml(desc)}</div>` : ''}`+
              `<div class="snapshot-meta">${escapeHtml(meta)}</div>`+
            `</div>`+
            `<div>`+
              `<button class="btn-tertiary btn-sm" data-snapshot-preview-id="${escapeHtmlAttr(id)}">Preview</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    async function loadSnapshots(){
      const list = $('snapshotsList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setSnapshotsMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        if(!canAccessSnapshots()) throw new Error('Permission denied');
        const { data, error } = await SB.client.rpc('get_snapshots', { p_company_id: SB.companyId });
        if(error) throw error;
        state._snapshots = Array.isArray(data) ? data : [];
        renderSnapshotsList();
      }catch(e){
        state._snapshots = [];
        const msg = e && e.message ? e.message : 'Failed to load snapshots';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openSnapshotsModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!SB.companyId){ toast('No company selected', 'warning'); return; }
      if(!hasTier('business')){ toast('Snapshots require Business or Enterprise tier', 'info'); return; }
      if(!canSnapshotsView()){ toast('Permission denied', 'error'); return; }
      show('snapshotsModal', true);
      showSnapshotList();
      await loadSnapshots();
    }
    function closeSnapshotsModal(){
      show('snapshotsModal', false);
      showSnapshotList();
    }
    async function openSnapshotPreview(snapshotId){
      const list = $('snapshotsList');
      const preview = $('snapshotPreview');
      const body = $('snapshotPreviewBody');
      if(!snapshotId || !preview || !body) return;
      if(list) list.style.display = 'none';
      preview.style.display = '';
      body.innerHTML = `<tr><td colspan="5" class="muted">Loadingâ€¦</td></tr>`;
      setSnapshotsMessage('');
      try{
        const { data, error } = await SB.client
          .from('inventory_snapshots')
          .select('id,name,description,snapshot_type,items_count,total_quantity,created_at,restored_at,items_data')
          .eq('id', snapshotId)
          .eq('company_id', SB.companyId)
          .maybeSingle();
        if(error) throw error;
        const items = Array.isArray(data && data.items_data) ? data.items_data : [];
        const limited = items.slice(0, SNAPSHOT_PREVIEW_LIMIT);
        const metaParts = [];
        const name = String(data && data.name ? data.name : 'Snapshot').trim();
        const desc = String(data && data.description ? data.description : '').trim();
        const createdAt = data && data.created_at ? formatEasternDateTime(data.created_at) : '';
        const restoredAt = data && data.restored_at ? formatEasternDateTime(data.restored_at) : '';
        const count = toInt(data && data.items_count ? data.items_count : items.length, 0);
        const totalQty = toInt(data && data.total_quantity ? data.total_quantity : 0, 0);
        if(createdAt) metaParts.push(`Created: ${createdAt}`);
        metaParts.push(`Items: ${count}`);
        metaParts.push(`Qty: ${totalQty}`);
        if(data && data.snapshot_type) metaParts.push(`Type: ${String(data.snapshot_type)}`);
        if(restoredAt) metaParts.push(`Restored: ${restoredAt}`);
        if(items.length > SNAPSHOT_PREVIEW_LIMIT){
          metaParts.push(`Showing: ${SNAPSHOT_PREVIEW_LIMIT} of ${items.length}`);
        }
        const titleEl = $('snapshotPreviewTitle');
        if(titleEl) titleEl.textContent = name || 'Snapshot';
        const metaEl = $('snapshotPreviewMeta');
        if(metaEl) metaEl.textContent = metaParts.join(' | ');
        if(desc){
          setSnapshotsMessage(desc);
        }
        if(!limited.length){
          body.innerHTML = `<tr><td colspan="5" class="muted">No items in snapshot.</td></tr>`;
          return;
        }
        body.innerHTML = limited.map(item => {
          const label = String(item && item.name ? item.name : '').trim();
          const sku = String(item && item.sku ? item.sku : '').trim();
          const qty = toInt(item && item.quantity !== undefined ? item.quantity : item && item.qty, 0);
          const categoryId = String(item && item.category_id ? item.category_id : '').trim();
          const locationId = String(item && item.location_id ? item.location_id : '').trim();
          return (
            `<tr>`+
              `<td>${escapeHtml(label)}</td>`+
              `<td>${escapeHtml(sku)}</td>`+
              `<td>${escapeHtml(String(qty))}</td>`+
              `<td>${escapeHtml(categoryId)}</td>`+
              `<td>${escapeHtml(locationId)}</td>`+
            `</tr>`
          );
        }).join('');
      }catch(e){
        const msg = e && e.message ? e.message : 'Snapshot preview failed';
        body.innerHTML = `<tr><td colspan="5" class="muted">${escapeHtml(msg)}</td></tr>`;
      }
    }

    // Feature: inventory.metrics.dashboard
    function setMetricsMessage(msg){
      const el = $('metricsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function renderMetricsControls(){
      const viewSelect = $('metricsView');
      if(!viewSelect) return;
      const allowPlatform = canPlatformMetricsView() && isEffectiveSuperUser() && hasTier('professional');
      viewSelect.style.display = allowPlatform ? '' : 'none';
      if(!allowPlatform) viewSelect.value = 'company';
    }
    function openMetricsModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!SB.companyId){ toast('No company selected', 'warning'); return; }
      if(!canAccessMetrics()){
        if(!hasTier('professional')){
          toast('Metrics require Professional tier or higher', 'info');
          return;
        }
        toast('Permission denied', 'error');
        return;
      }
      show('metricsModal', true);
      renderMetricsControls();
      loadMetrics();
    }
    function closeMetricsModal(){
      show('metricsModal', false);
      setMetricsMessage('');
    }
    function formatMetricValue(value){
      const num = Number(value);
      if(!Number.isFinite(num)) return '0';
      return Math.round(num).toLocaleString();
    }
    function buildDailySummary(rows){
      const map = new Map();
      (rows || []).forEach(row => {
        const date = String(row && (row.date || row.metric_date) ? row.date || row.metric_date : '').slice(0, 10);
        if(!date) return;
        const entry = map.get(date) || { date, updates:0, deletes:0, restores:0, rollbacks:0, records:0 };
        const action = String(row && row.action_type ? row.action_type : '').toLowerCase();
        const count = toInt(row && row.action_count ? row.action_count : 0, 0);
        if(action === 'update') entry.updates += count;
        else if(action === 'delete' || action === 'bulk_delete') entry.deletes += count;
        else if(action === 'restore') entry.restores += count;
        else if(action === 'rollback') entry.rollbacks += count;
        entry.records += toInt(row && row.records_affected ? row.records_affected : 0, 0);
        map.set(date, entry);
      });
      return Array.from(map.values()).sort((a,b)=> (a.date < b.date ? 1 : -1));
    }
    function renderCompanyMetrics(data, days){
      const container = $('metricsContent');
      if(!container) return;
      const current = data && data.current ? data.current : {};
      const activity = data && data.activity ? data.activity : {};
      const daily = buildDailySummary(data && data.daily ? data.daily : []);
      const topUsers = Array.isArray(data && data.top_users ? data.top_users : []) ? data.top_users : [];
      const dailyRows = daily.map(row => (
        `<tr>`+
          `<td>${escapeHtml(String(row.date || ''))}</td>`+
          `<td>${escapeHtml(String(row.updates))}</td>`+
          `<td>${escapeHtml(String(row.deletes))}</td>`+
          `<td>${escapeHtml(String(row.restores))}</td>`+
          `<td>${escapeHtml(String(row.rollbacks))}</td>`+
          `<td>${escapeHtml(String(row.records))}</td>`+
        `</tr>`
      )).join('');
      const topUserRows = topUsers.map(user => (
        `<tr>`+
          `<td>${escapeHtml(String(user && (user.email || user.user_id) ? (user.email || user.user_id) : 'User'))}</td>`+
          `<td>${escapeHtml(formatMetricValue(user && user.total_actions ? user.total_actions : 0))}</td>`+
        `</tr>`
      )).join('');
      container.innerHTML =
        `<div class="metrics-section">`+
          `<h3>Current State</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.total_items)}</div><div class="metric-label">Total Items</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.total_quantity)}</div><div class="metric-label">Total Qty</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.low_stock_count)}</div><div class="metric-label">Low Stock</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.active_members)}</div><div class="metric-label">Team Members</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.snapshot_count)}</div><div class="metric-label">Snapshots</div></div>`+
          `</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Activity (Last ${escapeHtml(String(days))} Days)</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_updates)}</div><div class="metric-label">Updates</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_deletes)}</div><div class="metric-label">Deletes</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_restores)}</div><div class="metric-label">Restores</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_rollbacks)}</div><div class="metric-label">Rollbacks</div></div>`+
          `</div>`+
          `<div class="metrics-note">${formatMetricValue(activity.records_affected)} records affected | -${formatMetricValue(activity.quantity_removed)} qty | +${formatMetricValue(activity.quantity_added)} qty</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Daily Summary</h3>`+
          `${dailyRows ? `<table class="metrics-table"><thead><tr><th>Date</th><th>Updates</th><th>Deletes</th><th>Restores</th><th>Rollbacks</th><th>Records</th></tr></thead><tbody>${dailyRows}</tbody></table>` : '<div class="trash-empty">No activity recorded.</div>'}`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Top Contributors</h3>`+
          `${topUserRows ? `<table class="metrics-table"><thead><tr><th>User</th><th>Actions</th></tr></thead><tbody>${topUserRows}</tbody></table>` : '<div class="trash-empty">No activity in this period.</div>'}`+
        `</div>`;
    }
    function renderPlatformMetrics(data, days){
      const container = $('metricsContent');
      if(!container) return;
      const platform = data && data.platform ? data.platform : {};
      const activity = data && data.activity ? data.activity : {};
      const companies = Array.isArray(data && data.companies ? data.companies : []) ? data.companies : [];
      const daily = Array.isArray(data && data.daily ? data.daily : []) ? data.daily : [];
      const companyRows = companies.map(row => (
        `<tr>`+
          `<td>${escapeHtml(String(row && row.name ? row.name : row && row.id ? row.id : 'Company'))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.member_count ? row.member_count : 0))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.item_count ? row.item_count : 0))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.recent_actions ? row.recent_actions : 0))}</td>`+
        `</tr>`
      )).join('');
      const dailyRows = daily.map(row => (
        `<tr>`+
          `<td>${escapeHtml(String(row && row.date ? row.date : ''))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.total_actions ? row.total_actions : 0))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.active_companies ? row.active_companies : 0))}</td>`+
        `</tr>`
      )).join('');
      container.innerHTML =
        `<div class="metrics-section">`+
          `<h3>Platform Totals</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_companies)}</div><div class="metric-label">Companies</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_users)}</div><div class="metric-label">Users</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_items)}</div><div class="metric-label">Items</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_orders)}</div><div class="metric-label">Orders</div></div>`+
          `</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Activity (Last ${escapeHtml(String(days))} Days)</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_actions)}</div><div class="metric-label">Total Actions</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.active_companies)}</div><div class="metric-label">Active Companies</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.active_users)}</div><div class="metric-label">Active Users</div></div>`+
          `</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Company Activity</h3>`+
          `${companyRows ? `<table class="metrics-table"><thead><tr><th>Company</th><th>Members</th><th>Items</th><th>Recent Actions</th></tr></thead><tbody>${companyRows}</tbody></table>` : '<div class="trash-empty">No company activity found.</div>'}`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Daily Activity</h3>`+
          `${dailyRows ? `<table class="metrics-table"><thead><tr><th>Date</th><th>Total Actions</th><th>Active Companies</th></tr></thead><tbody>${dailyRows}</tbody></table>` : '<div class="trash-empty">No activity recorded.</div>'}`+
        `</div>`;
    }
    async function loadMetrics(){
      const container = $('metricsContent');
      if(container) container.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setMetricsMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        const rangeEl = $('metricsRange');
        const viewEl = $('metricsView');
        const days = toInt(rangeEl ? rangeEl.value : 30, 30);
        const view = viewEl && viewEl.style.display !== 'none' ? String(viewEl.value || 'company') : 'company';
        if(view === 'platform' && canPlatformMetricsView() && isEffectiveSuperUser() && hasTier('professional')){
          const { data, error } = await SB.client.rpc('get_platform_dashboard_metrics', { p_days: days });
          if(error) throw error;
          const title = $('metricsTitle'); if(title) title.textContent = 'Platform Metrics';
          renderPlatformMetrics(data || {}, days);
          return;
        }
        const { data, error } = await SB.client.rpc('get_company_dashboard_metrics', { p_company_id: SB.companyId, p_days: days });
        if(error) throw error;
        const title = $('metricsTitle'); if(title) title.textContent = 'Metrics Dashboard';
        renderCompanyMetrics(data || {}, days);
      }catch(e){
        const msg = e && e.message ? e.message : 'Failed to load metrics';
        if(container) container.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    function renderRoleManagerButton(){
      const allow = !!(SB.session && canAccessRoleManager());
      setProfileMenuItemVisibility('openRoleManager', allow);
      updateProfileTeamEmpty();
    }
    function renderUserMgmtButton(){
      const allow = !!(SB.session && hasTier('business') && canMembersView());
      setProfileMenuItemVisibility('openUserMgmt', allow);
      updateProfileTeamEmpty();
    }
    function renderUserMgmtHeaderActions(){
      const addBtn = $('btnUserMgmtAdd');
      if(addBtn){
        const allowInvite = !!(SB.session && canAccessInvites());
        addBtn.disabled = !allowInvite;
        addBtn.setAttribute('aria-disabled', allowInvite ? 'false' : 'true');
      }
    }
    function renderAdvancedCompanySwitcherButton(){
      const allow = !!(SB.session && isEffectiveSuperUser());
      setProfileMenuItemVisibility('openAdvancedCompanySwitcher', allow);
    }
    function renderProvisioningDashboardButton(){
      // Provisioning moved to hamburger menu in Manage Companies modal
    }
    function renderDiagnosticsButton(){
      const allow = !!(SB.session && isEffectiveSuperUser());
      setProfileMenuItemVisibility('openDiagnostics', allow);
    }
    function renderSubscriptionManagerButton(){
      const allow = !!(SB.session && isEffectiveSuperUser());
      setProfileMenuItemVisibility('openSubscriptionManager', allow);
    }
    function renderManageCompanyButton(){
      const allow = !!(SB.session && SB.companyId && canAccessCompanyLocations());
      setProfileMenuItemVisibility('openManageCompany', allow);
    }
    function renderCompanyLocationsButton(){
      const allow = !!(SB.session && SB.companyId && canAccessCompanyLocations());
      setProfileMenuItemVisibility('openCompanyLocations', allow);
    }
    function renderUserMgmtControls(){
      const controls = $('userMgmtControls');
      const select = $('userMgmtCompany');
      if(!controls || !select) return;
      renderUserMgmtHeaderActions();
      if(!SB.session || !isEffectiveSuperUser()){
        controls.style.display = 'none';
        return;
      }
      controls.style.display = '';
      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      select.innerHTML = '';
      if(!rows.length){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No companies available';
        select.appendChild(opt);
        select.disabled = true;
        _userMgmtCompanyId = '';
        return;
      }
      rows.forEach(row => {
        const id = String(row && row.company_id ? row.company_id : '').trim();
        if(!id) return;
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || id;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = name;
        select.appendChild(opt);
      });
      let desired = _userMgmtCompanyId;
      if(desired && !rows.some(r => String(r.company_id) === desired)) desired = '';
      if(!desired) desired = SB.companyId ? String(SB.companyId) : String(rows[0].company_id || '');
      _userMgmtCompanyId = desired || '';
      if(_userMgmtCompanyId) select.value = _userMgmtCompanyId;
      select.disabled = rows.length <= 1;
      renderPendingInvitesSection();
    }
    function getUserMgmtCompanyId(){
      if(isEffectiveSuperUser()){
        return String(_userMgmtCompanyId || SB.companyId || '').trim();
      }
      return SB.companyId ? String(SB.companyId).trim() : '';
    }
    function renderUserMgmtList(){
      const list = $('userMgmtList');
      if(!list) return;
      const rows = Array.isArray(state._userMgmtRows) ? state._userMgmtRows : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No users found.</div>`;
        return;
      }
      const currentUserId = SB.user && SB.user.id ? String(SB.user.id) : '';
      const roleOptions = ['admin','member','viewer'];
      list.innerHTML = rows.map(row => {
        const userId = String(row.user_id || '').trim();
        const profile = row.profile || {};
        const name = [profile.first_name, profile.last_name].filter(Boolean).join(' ').trim();
        const email = String(profile.email || row.email || '').trim();
        const displayName = name || email || 'User';
        const isSelf = currentUserId && userId === currentUserId;
        const isSuper = !!row.is_super_user;
        const currentRole = roleOptions.includes(String(row.role || '').trim()) ? String(row.role || '').trim() : 'member';
        const canEditRole = !!(canMembersChangeRole() && !isSuper && !isSelf);
        const canRemove = !!(canMembersRemove() && !isSuper && !isSelf);
        const joined = row.created_at ? formatEasternDateTime(row.created_at) : '';
        const metaParts = [];
        if(name && email) metaParts.push(email);
        if(joined) metaParts.push(`Joined ${joined}`);
        if(isSelf) metaParts.push('You');
        if(isSuper) metaParts.push('Super user');
        const roleSelect = isSuper
          ? `<select class="user-mgmt-role" disabled aria-disabled="true"><option selected>super_user</option></select>`
          : `<select class="user-mgmt-role" data-user-role-id="${escapeHtmlAttr(userId)}" data-current-role="${escapeHtmlAttr(currentRole)}" data-user-name="${escapeHtmlAttr(displayName)}" ${canEditRole ? '' : 'disabled aria-disabled="true"'}>`+
              roleOptions.map(r => `<option value="${escapeHtmlAttr(r)}"${r === currentRole ? ' selected' : ''}>${escapeHtml(r)}</option>`).join('')+
            `</select>`;
        const roleAction =
          `<div class="user-mgmt-action">`+
            `<svg class="user-mgmt-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
              `<path d="M12 20h9"></path>`+
              `<path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>`+
            `</svg>`+
            roleSelect+
          `</div>`;
        const removeAction =
          `<button class="btn-tertiary btn-sm user-mgmt-action-btn" data-user-remove-id="${escapeHtmlAttr(userId)}" data-user-name="${escapeHtmlAttr(displayName)}"${canRemove ? '' : ' disabled aria-disabled="true"'}>`+
            `<svg class="user-mgmt-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
              `<polyline points="3 6 5 6 21 6"></polyline>`+
              `<path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>`+
              `<path d="M10 11v6"></path>`+
              `<path d="M14 11v6"></path>`+
              `<path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>`+
            `</svg>`+
            `Remove`+
          `</button>`;
        return (
          `<div class="user-mgmt-card">`+
            `<div>`+
              `<div class="user-mgmt-name">${escapeHtml(displayName)}</div>`+
              `${metaParts.length ? `<div class="user-mgmt-meta">${escapeHtml(metaParts.join(' Â· '))}</div>` : ''}`+
            `</div>`+
            `<div class="user-mgmt-actions">`+
              roleAction+
              removeAction+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    function setPendingInvitesMessage(msg){
      const el = $('pendingInvitesMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function canAccessPendingInvites(){
      if(!SB.session) return false;
      if(isEffectiveSuperUser()) return true;
      const role = getEffectiveRole();
      if(role !== 'admin') return false;
      return canAccessInvites();
    }
    function renderPendingInvitesSection(){
      const section = $('pendingInvitesSection');
      if(!section) return;
      const allow = !!(SB.session && canAccessPendingInvites());
      section.style.display = allow ? '' : 'none';
    }
    function isInviteExpired(invite){
      const status = String(invite && invite.status ? invite.status : '').trim().toLowerCase();
      if(status === 'expired') return true;
      const expiresAt = invite && invite.expires_at ? new Date(invite.expires_at).getTime() : NaN;
      if(Number.isFinite(expiresAt) && expiresAt <= Date.now()) return true;
      return false;
    }
    function renderPendingInvitesList(){
      const list = $('pendingInvitesList');
      if(!list) return;
      const rows = Array.isArray(state._pendingInvites) ? state._pendingInvites : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No pending invites.</div>`;
        return;
      }
      const busyMap = state._pendingInviteBusy || {};
      const allowActions = canAccessPendingInvites();
      const header = (
        `<thead><tr>`+
          `<th>Email</th>`+
          `<th>Role</th>`+
          `<th>Sent At</th>`+
          `<th>Last Sent At</th>`+
          `<th>Expires At</th>`+
          `<th>Status</th>`+
          `<th>Resends</th>`+
          `<th>Actions</th>`+
        `</tr></thead>`
      );
      const body = rows.map(row => {
        const id = String(row.id || '').trim();
        const email = String(row.email || '').trim();
        const role = String(row.role || '').trim();
        const sentAt = row.sent_at ? formatEasternDateTime(row.sent_at) : 'â€”';
        const lastSentAt = row.last_sent_at ? formatEasternDateTime(row.last_sent_at) : 'â€”';
        const expiresAt = row.expires_at ? formatEasternDateTime(row.expires_at) : 'â€”';
        const resendCount = Number.isFinite(row.resend_count) ? row.resend_count : toInt(row.resend_count, 0);
        const expired = isInviteExpired(row);
        const status = expired ? 'expired' : 'pending';
        const busy = id ? String(busyMap[id] || '') : '';
        const isResendBusy = busy === 'resend';
        const isRevokeBusy = busy === 'revoke';
        const resendDisabled = !allowActions || expired || isResendBusy || isRevokeBusy;
        const revokeDisabled = !allowActions || isRevokeBusy || isResendBusy;
        const resendLabel = isResendBusy ? 'Resendingâ€¦' : 'Resend Invite';
        const revokeLabel = isRevokeBusy ? 'Revokingâ€¦' : 'Revoke Invite';
        return (
          `<tr class="${expired ? 'invite-row-expired' : ''}">`+
            `<td>${escapeHtml(email || 'â€”')}</td>`+
            `<td>${escapeHtml(role || 'member')}</td>`+
            `<td>${escapeHtml(sentAt)}</td>`+
            `<td>${escapeHtml(lastSentAt)}</td>`+
            `<td>${escapeHtml(expiresAt)}</td>`+
            `<td><span class="invite-status ${status}">${escapeHtml(status)}</span></td>`+
            `<td>${escapeHtml(String(resendCount))}</td>`+
            `<td>`+
              `<div class="pending-invites-actions">`+
                `<button class="btn-tertiary btn-sm" data-invite-resend-id="${escapeHtmlAttr(id)}"${resendDisabled ? ' disabled aria-disabled="true"' : ''}>${escapeHtml(resendLabel)}</button>`+
                `<button class="btn-tertiary btn-sm btn-danger" data-invite-revoke-id="${escapeHtmlAttr(id)}" data-invite-email="${escapeHtmlAttr(email)}"${revokeDisabled ? ' disabled aria-disabled="true"' : ''}>${escapeHtml(revokeLabel)}</button>`+
              `</div>`+
            `</td>`+
          `</tr>`
        );
      }).join('');
      list.innerHTML = (
        `<div class="pending-invites-table-wrap">`+
          `<table class="metrics-table pending-invites-table">${header}<tbody>${body}</tbody></table>`+
        `</div>`
      );
    }
    async function refreshPendingInvites(){
      const list = $('pendingInvitesList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setPendingInvitesMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) return;
        if(!canAccessPendingInvites()){
          state._pendingInvites = [];
          renderPendingInvitesList();
          return;
        }
        const companyId = getUserMgmtCompanyId();
        if(!companyId) throw new Error('No company selected');
        const { data, error } = await SB.client
          .from('company_invites')
          .select('id,email,role,sent_at,last_sent_at,expires_at,status,resend_count')
          .eq('company_id', companyId)
          .order('sent_at', { ascending: false });
        if(error) throw error;
        state._pendingInvites = Array.isArray(data) ? data : [];
        renderPendingInvitesList();
      }catch(e){
        state._pendingInvites = [];
        const msg = e && e.message ? e.message : 'Failed to load invites';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function sbResendCompanyInvite(inviteId){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!canAccessPendingInvites()) throw Error('Permission denied');
      const id = String(inviteId || '').trim();
      if(!id) throw Error('Invite required');
      const apiUrl = getInviteSendUrl();
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        if(SB.session && SB.session.access_token){
          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
        }
      }
      const baseUrl = `${window.location.origin}${window.location.pathname}`.replace(/\?[^#]*$/, '');
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify({ invite_id: id, app_url: baseUrl }),
      });
      const data = await res.json().catch(() => ({}));
      if(!res.ok){
        const err = data && data.error ? data.error : 'Resend failed';
        const error = new Error(err);
        error.details = data;
        throw error;
      }
      if(data && data.ok === false) throw new Error(data.error || 'Resend failed');
      return data || null;
    }
    async function sbRevokeCompanyInvite(inviteId){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!canAccessPendingInvites()) throw Error('Permission denied');
      const companyId = getUserMgmtCompanyId();
      if(!companyId) throw Error('No company selected');
      const id = String(inviteId || '').trim();
      if(!id) throw Error('Invite required');
      const { error } = await SB.client
        .from('company_invites')
        .delete()
        .eq('id', id)
        .eq('company_id', companyId);
      if(error) throw error;
    }
    async function refreshUserMgmtAll(){
      await refreshUserMgmt();
      await refreshPendingInvites();
    }
    async function refreshUserMgmt(){
      const list = $('userMgmtList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setUserMgmtMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!hasTier('business')) throw new Error('User management requires Business tier');
        if(!canMembersView()) throw new Error('Permission denied');
        const companyId = getUserMgmtCompanyId();
        if(!companyId) throw new Error('No company selected');
        const { data, error } = await SB.client
          .from('company_members')
          .select('user_id,role,is_super_user,invited_by,assigned_admin_id,created_at')
          .eq('company_id', companyId)
          .order('created_at', { ascending:true });
        if(error) throw error;
        const rows = Array.isArray(data) ? data : [];
        const userIds = rows.map(r => r.user_id).filter(Boolean);
        let profileMap = new Map();
        if(userIds.length){
          const { data: profiles, error: profErr } = await SB.client
            .from('profiles')
            .select('user_id,email,first_name,last_name')
            .in('user_id', userIds);
          if(profErr) throw profErr;
          profileMap = new Map((profiles || []).map(p => [String(p.user_id), p]));
        }
        state._userMgmtRows = rows.map(r => ({
          ...r,
          profile: profileMap.get(String(r.user_id)) || null,
        }));
        renderUserMgmtList();
      }catch(e){
        state._userMgmtRows = [];
        const msg = e && e.message ? e.message : 'Failed to load users';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openUserMgmtModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!hasTier('business')){ toast('User management requires Business tier', 'info'); return; }
      if(!canMembersView()){ toast('Permission denied', 'error'); return; }
      renderUserMgmtControls();
      renderUserMgmtHeaderActions();
      renderPendingInvitesSection();
      show('userMgmtModal', true);
      await refreshUserMgmtAll();
    }
    function closeUserMgmtModal(){
      show('userMgmtModal', false);
    }
    function openInviteFromUserMgmt(){
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!hasTier('business')){ toast('Invites require Business tier', 'info'); return; }
      if(!canMembersInvite()){ toast('Permission denied', 'error'); return; }
      show('userMgmtModal', false);
      renderInviteUi();
      show('inviteModal', true);
    }
    function openSubscriptionManagerModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!isEffectiveSuperUser()){ toast('Super user access required', 'error'); return; }
      if(!SB.companyId){ toast('Select a company first', 'warning'); return; }
      renderTierAdminSection();
      show('subscriptionManagerModal', true);
    }
    function closeSubscriptionManagerModal(){
      show('subscriptionManagerModal', false);
    }
    function renderManageCompanyModal(){
      const addressEl = $('manageCompanyReceiptAddress');
      if(addressEl) addressEl.textContent = getReceiptForwardingAddress();
    }
    function openManageCompanyModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!canAccessCompanyLocations()){ toast('Company admin access required', 'error'); return; }
      if(!SB.companyId){ toast('Select a company first', 'warning'); return; }
      renderManageCompanyModal();
      show('manageCompanyModal', true);
    }
    async function openTierOverrideFromUserMgmt(){
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!isEffectiveSuperUser()){ toast('Super user access required', 'error'); return; }
      const targetCompanyId = getUserMgmtCompanyId();
      if(!targetCompanyId){ toast('No company selected', 'warning'); return; }
      show('userMgmtModal', false);
      if(String(targetCompanyId) !== String(SB.companyId || '')){
        const ok = await openConfirmModal(
          'Switch company to update tier?',
          'Tier overrides apply to the selected company and will switch your active context.',
          { okText:'Switch', cancelText:'Cancel' }
        );
        if(!ok) return;
        const switched = await sbSwitchCompany(targetCompanyId, { persist:false, audit:true, source:'user_mgmt_tier' });
        if(!switched) return;
      }
      renderProfileUi();
      show('profileModal', true);
      const section = $('tierOverrideSection');
      if(section){
        section.scrollIntoView({ behavior:'smooth', block:'start' });
      }
    }
    // Feature: inventory.auth.roles
    const ROLE_PERMISSION_CATEGORIES = {
      'Inventory': [
        { key: PERMISSIONS.ITEMS_VIEW, label: 'View Items' },
        { key: PERMISSIONS.ITEMS_CREATE, label: 'Create Items' },
        { key: PERMISSIONS.ITEMS_EDIT, label: 'Edit Items' },
        { key: PERMISSIONS.ITEMS_DELETE, label: 'Delete Items' },
        { key: PERMISSIONS.ITEMS_RESTORE, label: 'Restore Items' },
        { key: PERMISSIONS.ITEMS_EXPORT, label: 'Export Items' },
        { key: PERMISSIONS.ITEMS_IMPORT, label: 'Import Items' },
      ],
      'Orders': [
        { key: PERMISSIONS.ORDERS_VIEW, label: 'View Orders' },
        { key: PERMISSIONS.ORDERS_CREATE, label: 'Create Orders' },
        { key: PERMISSIONS.ORDERS_EDIT, label: 'Edit Orders' },
        { key: PERMISSIONS.ORDERS_DELETE, label: 'Delete Orders' },
        { key: PERMISSIONS.ORDERS_RESTORE, label: 'Restore Orders' },
        { key: PERMISSIONS.ORDERS_MANAGE_SHIPPING, label: 'Manage Shipping Addresses' },
      ],
      'Receiving': [
        { key: PERMISSIONS.RECEIVING_VIEW, label: 'View Receipts' },
        { key: PERMISSIONS.RECEIVING_CREATE, label: 'Create Receipts' },
        { key: PERMISSIONS.RECEIVING_EDIT, label: 'Edit Draft Receipts' },
        { key: PERMISSIONS.RECEIVING_APPROVE, label: 'Receive Receipts' },
        { key: PERMISSIONS.RECEIVING_VOID, label: 'Void Receipts' },
      ],
      'Members': [
        { key: PERMISSIONS.MEMBERS_VIEW, label: 'View Members' },
        { key: PERMISSIONS.MEMBERS_INVITE, label: 'Invite Members' },
        { key: PERMISSIONS.MEMBERS_REMOVE, label: 'Remove Members' },
        { key: PERMISSIONS.MEMBERS_CHANGE_ROLE, label: 'Change Roles' },
      ],
      'Company': [
        { key: PERMISSIONS.COMPANY_VIEW_SETTINGS, label: 'View Settings' },
        { key: PERMISSIONS.COMPANY_EDIT_SETTINGS, label: 'Edit Settings' },
      ],
      'Audit and Metrics': [
        { key: PERMISSIONS.AUDIT_LOG_VIEW, label: 'View Audit Log' },
        { key: PERMISSIONS.METRICS_VIEW, label: 'View Metrics' },
        { key: PERMISSIONS.SNAPSHOTS_VIEW, label: 'View Snapshots' },
      ],
    };
    function setRoleManagerMessage(msg){
      const el = $('roleManagerMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    async function openRoleManagerModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!canAccessRoleManager()){
        toast(hasTier('business') ? 'Super user access required' : 'Role Manager requires Business tier');
        return;
      }
      show('roleManagerModal', true);
      await loadRoleConfigurations();
    }
    function closeRoleManagerModal(){
      show('roleManagerModal', false);
      state._roleChanges = {};
      setRoleManagerMessage('');
    }
    async function loadRoleConfigurations(){
      setRoleManagerMessage('');
      try{
        const { data, error } = await SB.client
          .from('role_configurations')
          .select('role_name,permissions');
        if(error) throw error;
        state._roleConfigs = {};
        (data || []).forEach(row => {
          const role = String(row && row.role_name ? row.role_name : '').trim();
          if(!role) return;
          state._roleConfigs[role] = row.permissions || {};
        });
        state._roleChanges = {};
        renderRoleManagerTable();
      }catch(e){
        const msg = e && e.message ? e.message : 'Failed to load roles';
        setRoleManagerMessage(msg);
      }
    }
    function renderRoleManagerTable(){
      const body = $('roleManagerBody');
      if(!body) return;
      const roles = ['admin','member','viewer'];
      let html = '';
      for(const [category, perms] of Object.entries(ROLE_PERMISSION_CATEGORIES)){
        html += `<tr class="role-manager-category"><td colspan="4">${escapeHtml(category)}</td></tr>`;
        perms.forEach(perm => {
          const key = perm.key;
          const label = perm.label;
          const cells = roles.map(role => {
            const current = state._roleChanges[role] || state._roleConfigs[role] || {};
            const checked = current[key] === true;
            return `<td><input type="checkbox" data-role="${escapeHtmlAttr(role)}" data-permission="${escapeHtmlAttr(key)}"${checked ? ' checked' : ''} /></td>`;
          }).join('');
          html += `<tr><td>${escapeHtml(label)}</td>${cells}</tr>`;
        });
      }
      body.innerHTML = html;
    }
    function handleRoleManagerToggle(target){
      const box = target && target.matches ? (target.matches('input[type="checkbox"][data-role][data-permission]') ? target : null) : null;
      if(!box) return;
      const role = String(box.dataset.role || '').trim();
      const perm = String(box.dataset.permission || '').trim();
      if(!role || !perm) return;
      if(!state._roleChanges[role]){
        state._roleChanges[role] = { ...(state._roleConfigs[role] || {}) };
      }
      state._roleChanges[role][perm] = !!box.checked;
    }
    async function saveRoleManagerChanges(){
      if(!canAccessRoleManager()){
        toast('Permission denied', 'error');
        return;
      }
      const entries = Object.entries(state._roleChanges || {});
      if(!entries.length){
        setRoleManagerMessage('No changes to save.');
        return;
      }
      setRoleManagerMessage('');
      try{
        for(const [role, permissions] of entries){
          const { error } = await SB.client
            .from('role_configurations')
            .update({
              permissions,
              updated_at: new Date().toISOString(),
              updated_by: SB.user ? SB.user.id : null,
            })
            .eq('role_name', role);
          if(error) throw error;
        }
        state._roleChanges = {};
        await loadRoleConfigurations();
        await sbLoadPermissions();
        applyPermissionUI();
        setRoleManagerMessage('Role permissions saved.');
        toast('Role permissions saved', 'success');
      }catch(e){
        const msg = e && e.message ? e.message : 'Save failed';
        setRoleManagerMessage(msg);
      }
    }
    async function sbUpdateMemberRole(userId, role){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!hasTier('business')) throw Error('Role changes require Business tier');
      if(!canMembersChangeRole()) throw Error('Permission denied');
      const companyId = getUserMgmtCompanyId();
      if(!companyId) throw Error('Company not selected');
      const uid = String(userId || '').trim();
      const cleanRole = String(role || '').trim();
      if(!uid) throw Error('User required');
      if(!cleanRole) throw Error('Role required');
      const { error } = await SB.client
        .from('company_members')
        .update({ role: cleanRole })
        .eq('company_id', companyId)
        .eq('user_id', uid);
      if(error) throw error;
    }
    async function sbRemoveMember(userId){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!hasTier('business')) throw Error('User removal requires Business tier');
      if(!canMembersRemove()) throw Error('Permission denied');
      const uid = String(userId || '').trim();
      if(!uid) throw Error('User required');
      const { data, error } = await SB.client.rpc('remove_company_member', { p_user_id: uid });
      if(error) throw error;
      if(data && data.success === false) throw new Error(data.error || 'Remove failed');
      return data || null;
    }
    async function sbSendPasswordReset(email){
      if(!SB.ready || !SB.client) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      if(!e) throw Error('Email required');
      const redirectTo = window.location.origin + window.location.pathname;
      const { error } = await SB.client.auth.resetPasswordForEmail(e, { redirectTo });
      if(error) throw error;
    }
    async function sbUpdatePassword(newPassword){
      if(!SB.ready || !SB.client) throw Error('Supabase not configured');
      const pw = String(newPassword||'');
      if(pw.length < 8) throw Error('Use at least 8 characters');
      const { error } = await SB.client.auth.updateUser({ password: pw });
      if(error) throw error;
    }
    function setProfileMessage(msg){
      const el = $('profileMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
	    // Auto-format phone number as (XXX) XXX-XXXX
	    function formatPhoneNumber(value){
	      let digits = String(value || '').replace(/\D/g, '');
	      // iOS often pastes US numbers as 1XXXXXXXXXX â€” drop the leading country code
	      while(digits.length > 10 && digits.startsWith('1')) digits = digits.slice(1);
	      digits = digits.slice(0, 10);
	      if(digits.length === 0) return '';
	      if(digits.length <= 3) return `(${digits}`;
	      if(digits.length <= 6) return `(${digits.slice(0,3)}) ${digits.slice(3)}`;
	      return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
	    }

	    function renderProfileUi(){
	      const email = SB.user && SB.user.email ? String(SB.user.email) : '';
	      const elEmail = $('profileEmailDisplay'); if(elEmail) elEmail.textContent = email ? `Signed in: ${email}` : '';
	      const elFirstName = $('profileFirstName'); if(elFirstName) elFirstName.value = (SB.profile && SB.profile.first_name) ? String(SB.profile.first_name) : '';
	      const elLastName = $('profileLastName'); if(elLastName) elLastName.value = (SB.profile && SB.profile.last_name) ? String(SB.profile.last_name) : '';
	      const elPhone = $('profilePhone'); if(elPhone) elPhone.value = formatPhoneNumber((SB.profile && SB.profile.phone) ? String(SB.profile.phone) : '');
      const elSilence = $('profileSilenceLowStockAlerts'); if(elSilence) elSilence.checked = lowStockAlertsSilenced();
	      let note = '';
	      if(SB.session && !SB.authorized){
	        if(!SB.companyId) note = 'No company access yet. Ask an admin for an invite.';
        else if(!SB.permissions || !hasPermission(PERMISSIONS.ITEMS_VIEW)) note = 'Your role does not allow inventory access.';
	      }
      if(note && SB.permissions && SB.permissions.assigned_admin_email){
        note += ` Contact: ${SB.permissions.assigned_admin_email}`;
      }
      setProfileMessage(note);
      renderCompanySwitcher();
      renderInviteUi();
      renderUserMgmtHeaderActions();
      renderTierAdminSection();
    }
    function renderProfileMenuVisibility(){
      const signedIn = !!SB.session;
      setProfileMenuItemVisibility('openProfileSettings', signedIn);
      setProfileMenuItemVisibility('openCompanySwitcher', signedIn);
      renderCompanyLocationsButton();
      renderManageCompanyButton();
      renderSubscriptionManagerButton();
      renderInviteMenuItem();
      renderUserMgmtButton();
      renderRoleManagerButton();
      renderAdvancedCompanySwitcherButton();
      renderProvisioningDashboardButton();
      renderDiagnosticsButton();
      updateProfileTeamEmpty();
      renderRoleTestingSwitcher();
    }
    function renderInviteMenuItem(){
      const allow = !!(SB.session && hasTier('business') && canMembersInvite());
      setProfileMenuItemVisibility('openInviteModal', allow);
      updateProfileTeamEmpty();
    }
	    function renderCompanySwitcher(){
      renderProfileHeaderInfo();
      syncProfileTabsForRole();
      renderProfileMenuVisibility();
      renderCompanyEnvBadge();
      if(state._companySwitcherMode === 'basic'){
        const modal = $('advancedCompanyModal');
        if(modal && modal.getAttribute('aria-hidden') === 'false'){
          renderBasicCompanyResults();
        }
      }
	    }
    function setAdvancedCompanyMessage(msg){
      const el = $('advancedCompanyMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    async function loadAdvancedInventoryCounts(companyIds){
      const ids = Array.isArray(companyIds) ? companyIds.filter(Boolean) : [];
      if(!ids.length){
        state._advancedInventoryCounts = {};
        state._advancedTotalOnHand = {};
        return;
      }
      const { data, error } = await SB.client
        .from('inventory_items')
        .select('company_id, quantity')
        .in('company_id', ids)
        .is('deleted_at', null);
      if(error) throw error;
      const counts = {};
      const totals = {};
      (Array.isArray(data) ? data : []).forEach(row => {
        const id = String(row.company_id || '').trim();
        if(!id) return;
        counts[id] = (counts[id] || 0) + 1;
        const qty = Number(row.quantity);
        totals[id] = (totals[id] || 0) + (Number.isFinite(qty) ? qty : 0);
      });
      state._advancedInventoryCounts = counts;
      state._advancedTotalOnHand = totals;
    }
    function getDefaultProductionCompanyId(){
      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      const preferred = state._defaultCompanyId ? String(state._defaultCompanyId) : '';
      if(preferred && rows.some(r => String(r.company_id) === preferred)){
        return preferred;
      }
      if(rows.length) return String(rows[0].company_id || '');
      return '';
    }
    function getAdvancedCompanyRow(targetId){
      const rows = Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [];
      const id = String(targetId || '').trim();
      if(!id) return null;
      return rows.find(r => String(r.company_id || '') === id) || null;
    }
    function formatCompanyIdShort(id){
      const raw = String(id || '').trim();
      if(raw.length <= 14) return raw;
      return `${raw.slice(0,8)}...${raw.slice(-4)}`;
    }
    function closeCompanyOverflowMenus(){
      document.querySelectorAll('.company-overflow.open').forEach(menu => {
        menu.classList.remove('open');
        const btn = menu.querySelector('[data-company-overflow]');
        if(btn) btn.setAttribute('aria-expanded', 'false');
      });
      state._companyOverflowOpenId = null;
    }
    function toggleCompanyOverflowMenu(id, btn){
      const targetId = String(id || '').trim();
      if(!targetId) return;
      const wrapper = document.querySelector(`.company-overflow[data-company-menu="${targetId}"]`);
      if(!wrapper) return;
      const isOpen = wrapper.classList.contains('open');
      closeCompanyOverflowMenus();
      if(isOpen) return;
      wrapper.classList.add('open');
      state._companyOverflowOpenId = targetId;
      if(btn) btn.setAttribute('aria-expanded', 'true');
      const menu = wrapper.querySelector('.company-overflow-menu');
      if(menu && btn){
        const btnRect = btn.getBoundingClientRect();
        const menuHeight = menu.offsetHeight || 200;
        const spaceBelow = window.innerHeight - btnRect.bottom - 8;
        const spaceAbove = btnRect.top - 8;
        if(spaceBelow >= menuHeight || spaceBelow >= spaceAbove){
          menu.style.top = (btnRect.bottom + 4) + 'px';
          menu.style.bottom = 'auto';
        } else {
          menu.style.bottom = (window.innerHeight - btnRect.top + 4) + 'px';
          menu.style.top = 'auto';
        }
        menu.style.right = (window.innerWidth - btnRect.right) + 'px';
        menu.style.left = 'auto';
      }
      const first = wrapper.querySelector('.company-overflow-item');
      if(first) first.focus();
    }
    function getSeedSourceCompanies(targetId){
      const target = String(targetId || '').trim();
      const map = new Map();
      const addRow = (row) => {
        if(!row) return;
        const id = String(row.company_id || row.id || '').trim();
        if(!id || id === target) return;
        if(map.has(id)) return;
        map.set(id, {
          company_id: id,
          company_name: String(row.company_name || row.company_slug || id || '').trim() || id,
          company_type: normalizeCompanyType(row.company_type)
        });
      };
      (Array.isArray(state._advancedCompanies) ? state._advancedCompanies : []).forEach(addRow);
      (Array.isArray(SB.companies) ? SB.companies : []).forEach(addRow);
      return Array.from(map.values());
    }
    function setCompanyEnvironmentMessage(msg){
      if(!state._companyEnvironment) return;
      state._companyEnvironment.message = String(msg || '');
      renderCompanyEnvironmentModal();
    }
    function setCompanyEnvironmentBusy(isBusy){
      state._companyEnvironmentBusy = !!isBusy;
      const select = $('companyEnvironmentSelect');
      const btn = $('btnCompanyEnvironmentConfirm');
      const cancel = $('btnCompanyEnvironmentCancel');
      if(select) select.disabled = !!isBusy;
      if(btn){
        btn.disabled = !!isBusy;
        btn.setAttribute('data-loading', isBusy ? 'true' : 'false');
      }
      if(cancel) cancel.disabled = !!isBusy;
    }
    function renderCompanyEnvironmentModal(){
      const data = state._companyEnvironment;
      if(!data) return;
      const nameEl = $('companyEnvironmentTargetName');
      const idEl = $('companyEnvironmentTargetId');
      const select = $('companyEnvironmentSelect');
      const note = $('companyEnvironmentNote');
      const busy = !!state._companyEnvironmentBusy;
      if(nameEl) nameEl.textContent = data.targetName || 'Company';
      if(idEl) idEl.textContent = data.targetId || '';
      if(select){
        select.value = data.nextType || data.currentType || 'production';
        select.disabled = busy;
      }
      if(note){
        const currentLabel = formatCompanyTypeLabel(data.currentType || 'production');
        const nextLabel = formatCompanyTypeLabel(data.nextType || data.currentType || 'production');
        const base = data.currentType === data.nextType
          ? `Current: ${currentLabel}`
          : `Current: ${currentLabel} \u2192 ${nextLabel}`;
        note.textContent = data.message ? data.message : base;
      }
    }
    function openCompanyEnvironmentModal(company, opts = {}){
      if(!company) return;
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const currentType = normalizeCompanyType(company.company_type);
      const requested = opts && opts.nextType ? normalizeCompanyType(opts.nextType) : currentType;
      state._companyEnvironment = {
        targetId: id,
        targetName: String(company.company_name || company.company_slug || id || '').trim() || 'Company',
        currentType,
        nextType: requested,
        message: ''
      };
      setCompanyEnvironmentBusy(false);
      renderCompanyEnvironmentModal();
      show('companyEnvironmentModal', true);
    }
    async function confirmCompanyEnvironment(){
      if(!state._companyEnvironment) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured', 'error');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const data = state._companyEnvironment;
      const targetId = String(data.targetId || '').trim();
      const nextType = normalizeCompanyType(data.nextType || data.currentType);
      if(!targetId) return;
      if(nextType !== 'production' && nextType !== 'test'){
        setCompanyEnvironmentMessage('Select a valid environment.');
        return;
      }
      if(nextType === data.currentType){
        show('companyEnvironmentModal', false);
        return;
      }
      const confirmText = nextType === 'test'
        ? 'This enables destructive actions for this company.'
        : 'This blocks destructive actions for this company.';
      const ok = await openConfirmModal(
        `Switch to ${formatCompanyTypeLabel(nextType)}?`,
        confirmText,
        { okText: 'Confirm', cancelText: 'Cancel' }
      );
      if(!ok) return;
      setCompanyEnvironmentBusy(true);
      setCompanyEnvironmentMessage('');
      try{
        const { data: result, error } = await SB.client.rpc('set_company_environment', {
          p_company_id: targetId,
          p_environment: nextType
        });
        if(error) throw error;
        if(result && result.success === false){
          throw new Error(result.error || 'Update failed');
        }
        if(String(SB.companyId || '') === targetId && SB.company){
          SB.company.company_type = nextType;
          renderCompanyEnvBadge();
        }
        show('companyEnvironmentModal', false);
        await loadAdvancedCompanies();
        toast(`Environment set to ${formatCompanyTypeLabel(nextType)}`);
      }catch(e){
        setCompanyEnvironmentMessage(e && e.message ? e.message : 'Update failed');
      }finally{
        setCompanyEnvironmentBusy(false);
      }
    }
    function setRenameCompanyMessage(msg){
      const el = $('renameCompanyMsg');
      if(el) el.textContent = String(msg || '');
    }
    function setRenameCompanyBusy(busy){
      state._renameCompanyBusy = !!busy;
      const btn = $('btnRenameCompanyConfirm');
      const input = $('renameCompanyName');
      if(btn){
        btn.disabled = busy;
        btn.textContent = busy ? 'Saving...' : 'Save';
      }
      if(input) input.disabled = busy;
    }
    function openRenameCompanyModal(company){
      if(!company) return;
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const id = String(company.company_id || '').trim();
      const name = String(company.company_name || '').trim();
      if(!id) return;
      state._renameCompany = { targetId: id, currentName: name };
      const input = $('renameCompanyName');
      const subtitle = $('renameCompanySubtitle');
      if(input) input.value = name;
      if(subtitle) subtitle.textContent = `ID: ${id.slice(0,8)}...`;
      setRenameCompanyMessage('');
      setRenameCompanyBusy(false);
      show('renameCompanyModal', true);
      if(input) input.focus();
    }
    async function confirmRenameCompany(){
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const data = state._renameCompany;
      if(!data || !data.targetId) return;
      const input = $('renameCompanyName');
      const newName = String(input ? input.value : '').trim();
      if(!newName){
        setRenameCompanyMessage('Please enter a company name.');
        return;
      }
      if(newName === data.currentName){
        show('renameCompanyModal', false);
        return;
      }
      setRenameCompanyBusy(true);
      setRenameCompanyMessage('');
      try{
        const { error } = await SB.client
          .from('companies')
          .update({ name: newName, updated_at: new Date().toISOString() })
          .eq('id', data.targetId);
        if(error) throw error;
        if(String(SB.companyId || '') === data.targetId && SB.company){
          SB.company.company_name = newName;
          SB.company.name = newName;
        }
        show('renameCompanyModal', false);
        await loadAdvancedCompanies();
        toast('Company renamed', 'success');
      }catch(e){
        setRenameCompanyMessage(e && e.message ? e.message : 'Rename failed');
      }finally{
        setRenameCompanyBusy(false);
      }
    }

    /* ============================================
       Manage Company Users Sub-Modal
       ============================================ */
    function setManageUsersMessage(msg){
      const el = $('manageCompanyUsersMsg');
      if(el) el.textContent = String(msg || '');
    }
    function updateManageUsersDeleteBtn(){
      const btn = $('btnDeleteSelectedUsers');
      const count = state._manageUsersSelected.size;
      if(btn){
        btn.disabled = count === 0 || state._manageUsersBusy;
        btn.textContent = count > 0 ? `Delete Selected (${count})` : 'Delete Selected';
      }
    }
    function renderManageUsersTable(){
      const container = $('manageCompanyUsersResults');
      if(!container) return;
      const users = state._manageUsersData || [];
      const selected = state._manageUsersSelected;
      if(!users.length){
        container.innerHTML = '<div class="manage-sub-empty">No users found for this company.</div>';
        return;
      }
      const header = `<thead><tr>
        <th class="col-check"></th>
        <th>Email</th>
        <th class="col-role">Role</th>
        <th class="col-date">Joined</th>
      </tr></thead>`;
      const body = users.map(u => {
        const id = String(u.user_id || '').trim();
        const email = escapeHtml(String(u.email || 'â€”'));
        const role = escapeHtml(String(u.role || 'member'));
        const joined = u.created_at ? new Date(u.created_at).toLocaleDateString() : 'â€”';
        const isChecked = selected.has(id);
        return `<tr class="${isChecked ? 'is-selected' : ''}" data-user-row="${escapeHtmlAttr(id)}">
          <td class="col-check"><input type="checkbox" data-manage-user-check="${escapeHtmlAttr(id)}" ${isChecked ? 'checked' : ''} /></td>
          <td>${email}</td>
          <td class="col-role">${role}</td>
          <td class="col-date">${escapeHtml(joined)}</td>
        </tr>`;
      }).join('');
      container.innerHTML = `<table class="manage-sub-table">${header}<tbody>${body}</tbody></table>`;
      updateManageUsersSelectAll();
      updateManageUsersDeleteBtn();
    }
    function updateManageUsersSelectAll(){
      const cb = $('manageUsersSelectAll');
      if(!cb) return;
      const users = state._manageUsersData || [];
      const selected = state._manageUsersSelected;
      cb.checked = users.length > 0 && users.every(u => selected.has(String(u.user_id || '')));
      cb.indeterminate = selected.size > 0 && selected.size < users.length;
    }
    async function openManageUsersModal(company){
      if(!company) return;
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const companyId = String(company.company_id || '').trim();
      const companyName = String(company.company_name || company.company_slug || '').trim();
      if(!companyId) return;
      state._manageUsersCompany = { id: companyId, name: companyName };
      state._manageUsersData = [];
      state._manageUsersSelected = new Set();
      state._manageUsersBusy = false;
      const subtitle = $('manageCompanyUsersSubtitle');
      if(subtitle) subtitle.textContent = companyName;
      setManageUsersMessage('Loading users...');
      renderManageUsersTable();
      show('manageCompanyUsersModal', true);
      try{
        const { data, error } = await SB.client
          .from('company_members')
          .select('user_id, role, created_at, profiles(email)')
          .eq('company_id', companyId)
          .order('created_at', { ascending: true });
        if(error) throw error;
        state._manageUsersData = (data || []).map(row => ({
          user_id: row.user_id,
          role: row.role,
          created_at: row.created_at,
          email: row.profiles && row.profiles.email ? row.profiles.email : null
        }));
        setManageUsersMessage('');
        renderManageUsersTable();
      }catch(e){
        console.warn('Failed to load users:', e);
        setManageUsersMessage('Failed to load users.');
      }
    }
    async function deleteSelectedUsers(){
      if(!isEffectiveSuperUser()) return;
      const company = state._manageUsersCompany;
      if(!company) return;
      const selected = Array.from(state._manageUsersSelected);
      if(!selected.length) return;
      const confirmed = await openConfirmModal(
        'Delete Selected Users?',
        `This will remove ${selected.length} user${selected.length === 1 ? '' : 's'} from "${company.name}". This cannot be undone.`,
        { okText: 'Delete', cancelText: 'Cancel', danger: true }
      );
      if(!confirmed) return;
      state._manageUsersBusy = true;
      updateManageUsersDeleteBtn();
      setManageUsersMessage('Deleting...');
      try{
        const { error } = await SB.client
          .from('company_members')
          .delete()
          .eq('company_id', company.id)
          .in('user_id', selected);
        if(error) throw error;
        state._manageUsersData = state._manageUsersData.filter(u => !selected.includes(String(u.user_id || '')));
        state._manageUsersSelected = new Set();
        renderManageUsersTable();
        setManageUsersMessage(`Deleted ${selected.length} user${selected.length === 1 ? '' : 's'}.`);
        await loadAdvancedCompanies();
      }catch(e){
        setManageUsersMessage(e && e.message ? e.message : 'Delete failed.');
      }finally{
        state._manageUsersBusy = false;
        updateManageUsersDeleteBtn();
      }
    }

    /* ============================================
       Manage Company Inventory Sub-Modal
       ============================================ */
    function setManageInventoryMessage(msg){
      const el = $('manageCompanyInventoryMsg');
      if(el) el.textContent = String(msg || '');
    }
    function updateManageInventoryDeleteBtn(){
      const btn = $('btnDeleteSelectedInventory');
      const count = state._manageInventorySelected.size;
      if(btn){
        btn.disabled = count === 0 || state._manageInventoryBusy;
        btn.textContent = count > 0 ? `Delete Selected (${count})` : 'Delete Selected';
      }
    }
    function getFilteredManageInventory(){
      const items = state._manageInventoryData || [];
      const search = String(state._manageInventorySearch || '').trim().toLowerCase();
      if(!search) return items;
      return items.filter(item => {
        const name = String(item.name || '').toLowerCase();
        const sku = String(item.sku || '').toLowerCase();
        return name.includes(search) || sku.includes(search);
      });
    }
    function renderManageInventoryTable(){
      const container = $('manageCompanyInventoryResults');
      if(!container) return;
      const items = getFilteredManageInventory();
      const allItems = state._manageInventoryData || [];
      const selected = state._manageInventorySelected;
      if(!allItems.length){
        container.innerHTML = '<div class="manage-sub-empty">No inventory items found for this company.</div>';
        return;
      }
      if(!items.length){
        container.innerHTML = '<div class="manage-sub-empty">No items match your search.</div>';
        return;
      }
      const header = `<thead><tr>
        <th class="col-check"></th>
        <th>Name</th>
        <th class="col-sku">SKU</th>
        <th class="col-qty">Qty</th>
      </tr></thead>`;
      const body = items.map(item => {
        const id = String(item.id || '').trim();
        const name = escapeHtml(String(item.name || 'â€”'));
        const sku = escapeHtml(String(item.sku || 'â€”'));
        const qty = item.quantity !== null && item.quantity !== undefined ? String(item.quantity) : '0';
        const isChecked = selected.has(id);
        return `<tr class="${isChecked ? 'is-selected' : ''}" data-inv-row="${escapeHtmlAttr(id)}">
          <td class="col-check"><input type="checkbox" data-manage-inv-check="${escapeHtmlAttr(id)}" ${isChecked ? 'checked' : ''} /></td>
          <td>${name}</td>
          <td class="col-sku">${sku}</td>
          <td class="col-qty">${escapeHtml(qty)}</td>
        </tr>`;
      }).join('');
      container.innerHTML = `<table class="manage-sub-table">${header}<tbody>${body}</tbody></table>`;
      updateManageInventorySelectAll();
      updateManageInventoryDeleteBtn();
    }
    function updateManageInventorySelectAll(){
      const cb = $('manageInventorySelectAll');
      if(!cb) return;
      const items = getFilteredManageInventory();
      const selected = state._manageInventorySelected;
      const filteredIds = items.map(i => String(i.id || ''));
      const allSelected = items.length > 0 && filteredIds.every(id => selected.has(id));
      const someSelected = filteredIds.some(id => selected.has(id));
      cb.checked = allSelected;
      cb.indeterminate = someSelected && !allSelected;
    }
    async function openManageInventoryModal(company){
      if(!company) return;
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const companyId = String(company.company_id || '').trim();
      const companyName = String(company.company_name || company.company_slug || '').trim();
      if(!companyId) return;
      state._manageInventoryCompany = { id: companyId, name: companyName };
      state._manageInventoryData = [];
      state._manageInventorySelected = new Set();
      state._manageInventoryBusy = false;
      state._manageInventorySearch = '';
      const subtitle = $('manageCompanyInventorySubtitle');
      const searchInput = $('manageInventorySearch');
      if(subtitle) subtitle.textContent = companyName;
      if(searchInput) searchInput.value = '';
      setManageInventoryMessage('Loading inventory...');
      renderManageInventoryTable();
      show('manageCompanyInventoryModal', true);
      try{
        const { data, error } = await SB.client
          .from('inventory_items')
          .select('id, name, sku, quantity')
          .eq('company_id', companyId)
          .is('deleted_at', null)
          .order('name', { ascending: true });
        if(error) throw error;
        state._manageInventoryData = data || [];
        setManageInventoryMessage('');
        renderManageInventoryTable();
      }catch(e){
        console.warn('Failed to load inventory:', e);
        setManageInventoryMessage('Failed to load inventory.');
      }
    }
    async function openManageCompanyLocationsModal(company){
      if(!company) return;
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const companyId = String(company.company_id || '').trim();
      if(!companyId) return;
      const companyName = String(company.company_name || company.company_slug || company.company_id || '').trim() || companyId;
      // Add nested class for higher z-index when opened from Manage Companies
      const modal = $('companyLocationsModal');
      if(modal) modal.classList.add('modal-nested');
      await openCompanyLocationsModal({
        companyId,
        companyName,
        source:'manage_companies'
      });
    }
    async function deleteSelectedInventory(){
      if(!isEffectiveSuperUser()) return;
      const company = state._manageInventoryCompany;
      if(!company) return;
      const selected = Array.from(state._manageInventorySelected);
      if(!selected.length) return;
      const confirmed = await openConfirmModal(
        'Delete Selected Items?',
        `This will permanently delete ${selected.length} item${selected.length === 1 ? '' : 's'} from "${company.name}". This cannot be undone.`,
        { okText: 'Delete', cancelText: 'Cancel', danger: true }
      );
      if(!confirmed) return;
      state._manageInventoryBusy = true;
      updateManageInventoryDeleteBtn();
      setManageInventoryMessage('Deleting...');
      try{
        const { error } = await SB.client
          .from('inventory_items')
          .delete()
          .eq('company_id', company.id)
          .in('id', selected);
        if(error) throw error;
        state._manageInventoryData = state._manageInventoryData.filter(i => !selected.includes(String(i.id || '')));
        state._manageInventorySelected = new Set();
        renderManageInventoryTable();
        setManageInventoryMessage(`Deleted ${selected.length} item${selected.length === 1 ? '' : 's'}.`);
        await loadAdvancedCompanies();
      }catch(e){
        setManageInventoryMessage(e && e.message ? e.message : 'Delete failed.');
      }finally{
        state._manageInventoryBusy = false;
        updateManageInventoryDeleteBtn();
      }
    }

    function toggleManageCompaniesMenu(){
      const menu = $('manageCompaniesMenu');
      const btn = $('manageCompaniesMenuBtn');
      if(!menu) return;
      const isOpen = menu.classList.toggle('is-open');
      if(btn) btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
    }
    function closeManageCompaniesMenu(){
      const menu = $('manageCompaniesMenu');
      const btn = $('manageCompaniesMenuBtn');
      if(menu) menu.classList.remove('is-open');
      if(btn) btn.setAttribute('aria-expanded', 'false');
    }
    function exportCompaniesToCSV(){
      const rows = Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [];
      if(!rows.length){
        toast('No companies to export');
        return;
      }
      const counts = state._advancedInventoryCounts || {};
      const totals = state._advancedTotalOnHand || {};
      const header = ['Company Name', 'Company ID', 'Environment Type', 'Members', 'Jobs', 'POs', 'Items', 'On Hand', 'Created At', 'Age (days)'];
      const csvRows = [header.join(',')];
      rows.forEach(row => {
        const name = String(row.company_name || '').replace(/"/g, '""');
        const id = String(row.company_id || '');
        const env = normalizeEnvironmentType(row.environment_type);
        const members = Number(row.member_count) || 0;
        const jobs = Number(row.job_count) || 0;
        const pos = Number(row.po_count) || 0;
        const items = counts[id] || 0;
        const onHand = totals[id] || 0;
        const createdAt = row && row.created_at ? String(row.created_at) : '';
        const ageDays = row && row.created_at ? Math.max(0, Math.floor((Date.now() - new Date(row.created_at).getTime()) / 86400000)) : '';
        csvRows.push(`"${name}","${id}","${env}",${members},${jobs},${pos},${items},${onHand},"${createdAt}",${ageDays}`);
      });
      const csv = csvRows.join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `companies-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      toast('Companies exported', 'success');
      closeManageCompaniesMenu();
    }
    function debouncedAdvancedSearch(){
      if(state._advancedSearchDebounce){
        clearTimeout(state._advancedSearchDebounce);
      }
      state._advancedSearchDebounce = setTimeout(()=>{
        state._advancedSearchDebounce = null;
        loadAdvancedCompanies();
      }, 300);
    }
    async function ensureCompanyTestEnvironment(company, actionLabel){
      if(!company) return false;
      const type = normalizeCompanyType(company.company_type);
      if(type === 'test') return true;
      const name = String(company.company_name || company.company_slug || company.company_id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Test environment required',
        `${actionLabel} is allowed only in Test. Switch ${name} to Test?`,
        { okText: 'Switch to Test', cancelText: 'Cancel' }
      );
      if(ok){
        openCompanyEnvironmentModal(company, { nextType: 'test' });
      }
      return false;
    }
    const SEED_INVENTORY_FIELDS = [
      {
        key:'items',
        label:'Items',
        note:'Creates missing items and copies name, SKU, description, unit, reorder point/qty, and active state.'
      },
      { key:'on_hand', label:'On Hand', note:'Quantity on hand.' },
      { key:'description', label:'Description' },
      { key:'sku', label:'SKU' },
      { key:'unit_of_measure', label:'Unit of Measure' },
      { key:'location', label:'Location' },
      { key:'category', label:'Category' },
      { key:'reorder_point', label:'Reorder Point' },
      { key:'reorder_qty', label:'Reorder Qty' },
      { key:'reorder_enabled', label:'Reorder Enabled' },
      { key:'is_active', label:'Active Status' }
    ];
    function getSeedInventorySelectedFields(){
      const data = state._seedInventory;
      const fields = data && Array.isArray(data.seedFields) ? data.seedFields : [];
      const unique = Array.from(new Set(fields.filter(Boolean)));
      return unique;
    }
    function getSeedInventoryDefaultFields(itemsSeeded){
      const keys = SEED_INVENTORY_FIELDS.map(field => field.key);
      return itemsSeeded ? keys.filter(key => key !== 'items') : keys;
    }
    function getSeedInventorySelectableFields(itemsSeeded){
      return SEED_INVENTORY_FIELDS
        .map(field => field.key)
        .filter(key => !(itemsSeeded && key === 'items'));
    }
    function setSeedInventoryFields(next){
      if(!state._seedInventory) return;
      const itemsSeeded = !!state._seedInventory.itemsSeeded;
      const normalized = Array.from(new Set((next || []).filter(Boolean)));
      state._seedInventory.seedFields = itemsSeeded
        ? normalized.filter(key => key !== 'items')
        : normalized;
    }
    function formatSeedFieldList(fields){
      const map = new Map(SEED_INVENTORY_FIELDS.map(field => [field.key, field.label]));
      return (fields || [])
        .map(field => map.get(field) || field)
        .join(', ');
    }
    async function loadSeedInventoryStatus(targetId){
      if(!SB.ready || !SB.session || !SB.client) return null;
      try{
        const { data, error } = await SB.client.rpc('get_inventory_seed_status', {
          p_target_company_id: targetId
        });
        if(error) throw error;
        if(data && data.success === false) return null;
        return data;
      }catch(e){
        console.warn('Seed status load failed:', e);
        return null;
      }
    }
    function setSeedInventoryMessage(msg){
      const el = $('seedInventoryMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function setSeedInventoryBusy(isBusy){
      state._seedInventoryBusy = !!isBusy;
      const select = $('seedInventorySource');
      const dedupe = $('seedInventoryDedupe');
      const selectAll = $('seedInventorySelectAll');
      const btn = $('btnSeedInventoryConfirm');
      const cancel = $('btnSeedInventoryCancel');
      if(select) select.disabled = !!isBusy;
      if(dedupe) dedupe.disabled = !!isBusy;
      if(selectAll) selectAll.disabled = !!isBusy;
      document.querySelectorAll('#seedInventoryFields input[data-seed-field]').forEach(input => {
        const key = String(input.getAttribute('data-seed-field') || '');
        const itemsLocked = key === 'items' && state._seedInventory && state._seedInventory.itemsSeeded;
        input.disabled = !!isBusy || !!itemsLocked;
      });
      if(btn){
        btn.disabled = !!isBusy;
        btn.setAttribute('data-loading', isBusy ? 'true' : 'false');
      }
      if(cancel) cancel.disabled = !!isBusy;
    }
    function renderSeedInventoryFields(){
      const data = state._seedInventory;
      const wrap = $('seedInventoryFields');
      if(!data || !wrap) return;
      const selected = new Set(getSeedInventorySelectedFields());
      const itemsSeeded = !!data.itemsSeeded;
      if(itemsSeeded && selected.has('items')){
        selected.delete('items');
        data.seedFields = Array.from(selected);
      }
      const busy = !!state._seedInventoryBusy;
      const html = SEED_INVENTORY_FIELDS.map(field => {
        const locked = field.key === 'items' && itemsSeeded;
        const checked = selected.has(field.key);
        const note = field.note ? `<span class="seed-field-note">${escapeHtml(field.note)}</span>` : '';
        return (
          `<div class="seed-field-option${locked ? ' is-locked' : ''}">` +
            `<input type="checkbox" id="seedField-${escapeHtmlAttr(field.key)}" data-seed-field="${escapeHtmlAttr(field.key)}"${checked ? ' checked' : ''}${busy || locked ? ' disabled' : ''}>` +
            `<label for="seedField-${escapeHtmlAttr(field.key)}">` +
              `<span class="seed-field-title">${escapeHtml(field.label)}</span>` +
              note +
            `</label>` +
          `</div>`
        );
      }).join('');
      wrap.innerHTML = html;
    }
    function renderSeedInventoryModal(){
      const data = state._seedInventory;
      if(!data) return;
      const nameEl = $('seedInventoryTargetName');
      const idEl = $('seedInventoryTargetId');
      const select = $('seedInventorySource');
      const dedupe = $('seedInventoryDedupe');
      const info = $('seedInventoryInfo');
      const selectAllBtn = $('seedInventorySelectAll');
      const btn = $('btnSeedInventoryConfirm');
      const busy = !!state._seedInventoryBusy;
      const isTest = normalizeCompanyType(data.targetType) === 'test';
      const targetName = data.targetName || 'Company';
      const targetId = data.targetId || '';
      if(nameEl) nameEl.textContent = targetName;
      if(idEl) idEl.textContent = targetId;
      if(select){
        const sources = getSeedSourceCompanies(targetId);
        const current = String(data.sourceId || '').trim();
        select.innerHTML = '';
        if(!sources.length){
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No source companies available';
          select.appendChild(opt);
          select.disabled = true;
          if(!state._seedInventoryBusy){
            setSeedInventoryMessage('No source companies available. Run a search to load companies.');
          }
        }else{
          sources.forEach(row => {
            const label = row.company_type
              ? `${row.company_name} (${formatCompanyTypeLabel(row.company_type)})`
              : row.company_name;
            const opt = document.createElement('option');
            opt.value = row.company_id;
            opt.textContent = label;
            select.appendChild(opt);
          });
          select.disabled = false;
          if(!state._seedInventoryBusy && !String($('seedInventoryMsg')?.textContent || '').trim()){
            setSeedInventoryMessage('');
          }
          if(current && sources.some(r => r.company_id === current)){
            select.value = current;
          }else{
            select.value = sources[0].company_id;
            data.sourceId = select.value;
          }
        }
        if(busy) select.disabled = true;
      }
      if(dedupe){
        dedupe.value = data.dedupeKey || 'sku';
        dedupe.disabled = busy;
      }
      renderSeedInventoryFields();
      if(info){
        const seeded = Array.isArray(data.seededFields) ? data.seededFields : [];
        const seededLabel = seeded.length ? `Previously seeded: ${formatSeedFieldList(seeded)}.` : '';
        if(data.itemsSeeded){
          info.textContent = 'Items already seeded for this target. You can seed additional fields or reset the seed lock to allow items again.';
        }else{
          info.textContent = 'Items can be seeded once per target unless the seed lock is reset.';
        }
        if(seededLabel){
          info.textContent = `${info.textContent} ${seededLabel}`;
        }
      }
      if(selectAllBtn){
        const selected = new Set(getSeedInventorySelectedFields());
        const selectable = getSeedInventorySelectableFields(!!data.itemsSeeded);
        const allSelected = selectable.length > 0 && selectable.every(key => selected.has(key));
        selectAllBtn.textContent = allSelected ? 'Deselect all' : 'Select all';
        selectAllBtn.setAttribute('aria-pressed', allSelected ? 'true' : 'false');
      }
      if(btn){
        const hasSource = select ? !!String(select.value || '').trim() : false;
        const fields = getSeedInventorySelectedFields();
        btn.disabled = busy || !hasSource || !isTest || fields.length === 0;
      }
      if(!isTest && !state._seedInventoryBusy){
        setSeedInventoryMessage('Target must be Test environment to seed inventory.');
      }
    }
    async function openSeedInventoryModal(company){
      if(!company) return;
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Inventory seeding'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      state._seedInventory = {
        targetId: id,
        targetName: String(company.company_name || company.company_slug || id || '').trim() || 'Company',
        sourceId: '',
        dedupeKey: 'sku',
        targetType: normalizeCompanyType(company.company_type),
        itemsSeeded: false,
        seedFields: getSeedInventoryDefaultFields(false),
        seededFields: []
      };
      setSeedInventoryBusy(false);
      setSeedInventoryMessage('');
      renderSeedInventoryModal();
      show('seedInventoryModal', true);
      const status = await loadSeedInventoryStatus(id);
      if(status){
        state._seedInventory.itemsSeeded = !!status.items_seeded;
        state._seedInventory.seededFields = Array.isArray(status.seeded_fields) ? status.seeded_fields : [];
        state._seedInventory.seedFields = getSeedInventoryDefaultFields(state._seedInventory.itemsSeeded);
        renderSeedInventoryModal();
      }
    }
    async function confirmSeedInventory(){
      if(!state._seedInventory) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured', 'error');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const data = state._seedInventory;
      const sourceSelect = $('seedInventorySource');
      const dedupeSelect = $('seedInventoryDedupe');
      const sourceId = String(sourceSelect ? sourceSelect.value : data.sourceId || '').trim();
      const targetId = String(data.targetId || '').trim();
      const dedupeKey = String(dedupeSelect ? dedupeSelect.value : data.dedupeKey || 'sku').trim() || 'sku';
      const seedFields = getSeedInventorySelectedFields();
      if(normalizeCompanyType(data.targetType) !== 'test'){
        setSeedInventoryMessage('Target must be Test environment to seed inventory.');
        return;
      }
      if(!sourceId){
        setSeedInventoryMessage('Select a source company.');
        return;
      }
      if(sourceId === targetId){
        setSeedInventoryMessage('Source and target must be different.');
        return;
      }
      if(!seedFields.length){
        setSeedInventoryMessage('Select at least one seed option.');
        return;
      }
      if(data.itemsSeeded && seedFields.includes('items')){
        setSeedInventoryMessage('Items already seeded. Remove Items or reset the seed lock to seed items again.');
        return;
      }
      setSeedInventoryMessage('Seeding inventory...');
      setSeedInventoryBusy(true);
      try{
        const hasItems = seedFields.includes('items');
        const mode = hasItems ? (seedFields.length > 1 ? 'items_and_fields' : 'items_only') : 'fields_only';
        const { data: result, error } = await SB.client.rpc('seed_company_inventory', {
          p_source_company_id: sourceId,
          p_target_company_id: targetId,
          p_mode: mode,
          p_dedupe_key: dedupeKey,
          p_seed_fields: seedFields
        });
        if(error) throw error;
        if(result && result.success === false){
          const msg = String(result.error || 'Seed failed');
          if(msg.toLowerCase().includes('already seeded')){
            setSeedInventoryMessage('Items already seeded. Use "Reset Seed Lock" in Manage Companies to seed items again.');
            return;
          }
          throw new Error(msg);
        }
        const copied = result && Number.isFinite(Number(result.items_copied_count))
          ? Number(result.items_copied_count)
          : null;
        const updated = result && Number.isFinite(Number(result.items_updated_count))
          ? Number(result.items_updated_count)
          : null;
        const parts = [];
        if(copied !== null) parts.push(`${copied} copied`);
        if(updated !== null) parts.push(`${updated} updated`);
        const countLabel = parts.length ? ` (${parts.join(', ')})` : '';
        toast(`Inventory seeded${countLabel}`);
        show('seedInventoryModal', false);
        await loadAdvancedCompanies();
      }catch(e){
        setSeedInventoryMessage(e && e.message ? e.message : 'Seed failed');
      }finally{
        setSeedInventoryBusy(false);
      }
    }
    async function getCompanyInventoryCount(companyId){
      const { count, error } = await SB.client
        .from('inventory_items')
        .select('id', { head:true, count:'exact' })
        .eq('company_id', companyId)
        .is('deleted_at', null);
      if(error) throw error;
      return Number.isFinite(count) ? count : 0;
    }
    async function getCompanyMemberCount(companyId, includeSuper = true){
      let query = SB.client
        .from('company_members')
        .select('user_id', { head:true, count:'exact' })
        .eq('company_id', companyId);
      if(!includeSuper){
        query = query.eq('is_super_user', false);
      }
      const { count, error } = await query;
      if(error) throw error;
      return Number.isFinite(count) ? count : 0;
    }
    async function deleteCompanyInventory(company){
      if(!company) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured', 'error');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Delete inventory'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const name = String(company.company_name || company.company_slug || id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Delete inventory?',
        `Delete ALL inventory items for ${name}?`,
        { okText:'Continue', cancelText:'Cancel' }
      );
      if(!ok) return;
      let count = 0;
      try{ count = await getCompanyInventoryCount(id); }catch(e){}
      const ok2 = await openConfirmModal(
        'Final confirmation',
        `This will permanently delete ${count} items from ${name}.`,
        { okText:'Delete Inventory', cancelText:'Cancel' }
      );
      if(!ok2) return;
      try{
        const { data, error } = await SB.client.rpc('delete_company_inventory', {
          p_company_id: id
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Delete failed');
        }
        const deletedCount = data && Number.isFinite(Number(data.deleted_count)) ? Number(data.deleted_count) : 0;
        if(deletedCount === 0){
          toast('No inventory items to delete.');
        }else{
          toast(`Deleted ${deletedCount} items`);
        }
        await loadAdvancedCompanies();
      }catch(e){
        toast(e && e.message ? e.message : 'Delete failed');
      }
    }
    async function deleteCompanyUsers(company){
      if(!company) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured', 'error');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Delete users'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const name = String(company.company_name || company.company_slug || id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Remove users?',
        `Remove all non-super users from ${name}?`,
        { okText:'Continue', cancelText:'Cancel' }
      );
      if(!ok) return;
      let count = 0;
      try{ count = await getCompanyMemberCount(id, false); }catch(e){}
      if(count === 0){
        toast('No removable users found.');
        return;
      }
      const ok2 = await openConfirmModal(
        'Final confirmation',
        `This will remove ${count} users from ${name}. Super users remain; user accounts are not deleted.`,
        { okText:'Remove Users', cancelText:'Cancel' }
      );
      if(!ok2) return;
      try{
        const { data, error } = await SB.client.rpc('delete_company_users', {
          p_company_id: id
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Remove users failed');
        }
        const deletedCount = data && Number.isFinite(Number(data.deleted_count)) ? Number(data.deleted_count) : count;
        toast(`Removed ${deletedCount} users`);
        await loadAdvancedCompanies();
      }catch(e){
        toast(e && e.message ? e.message : 'Remove users failed');
      }
    }
    async function deleteCompanyRecord(company){
      if(!company) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured', 'error');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Delete company'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const name = String(company.company_name || company.company_slug || id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Delete company?',
        `Delete ${name} and its company record?`,
        { okText:'Continue', cancelText:'Cancel' }
      );
      if(!ok) return;
      let inventoryCount = 0;
      let memberCount = 0;
      try{ inventoryCount = await getCompanyInventoryCount(id); }catch(e){}
      try{ memberCount = await getCompanyMemberCount(id, true); }catch(e){}
      const ok2 = await openConfirmModal(
        'Final confirmation',
        `This will attempt to delete ${name}. Remaining: ${inventoryCount} items, ${memberCount} users.`,
        { okText:'Delete Company', cancelText:'Cancel' }
      );
      if(!ok2) return;
      try{
        const { data, error } = await SB.client.rpc('delete_company_record', {
          p_company_id: id
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Delete failed');
        }
        state._advancedCompanies = (Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [])
          .filter(row => String(row.company_id || '') !== id);
        renderAdvancedCompanyResults();
        toast('Company deleted', 'success');
        if(String(SB.companyId || '') === id){
          const fallbackId = getDefaultProductionCompanyId();
          if(fallbackId && fallbackId !== id){
            await sbSwitchCompany(fallbackId, { persist:false, audit:true, source:'company_delete' });
          }
        }
      }catch(e){
        toast(e && e.message ? e.message : 'Delete failed');
      }
    }
    async function resetInventorySeedRun(company){
      if(!company) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured', 'error');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Reset seed lock'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const name = String(company.company_name || company.company_slug || id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Reset seed lock?',
        `Allow ${name} to be seeded again?`,
        { okText:'Continue', cancelText:'Cancel' }
      );
      if(!ok) return;
      const ok2 = await openConfirmModal(
        'Final confirmation',
        `This will remove the seed lock for ${name}.`,
        { okText:'Reset Seed Lock', cancelText:'Cancel' }
      );
      if(!ok2) return;
      try{
        const { data, error } = await SB.client.rpc('reset_inventory_seed_run', {
          p_target_company_id: id
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Reset failed');
        }
        toast('Seed lock reset');
        await loadAdvancedCompanies();
      }catch(e){
        toast(e && e.message ? e.message : 'Reset failed');
      }
    }
    function renderAdvancedCompanyResults(){
      if(state._companySwitcherMode !== 'advanced') return;
      const container = $('advancedCompanyResults');
      if(!container) return;
      closeCompanyOverflowMenus();
      const rows = Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [];
      if(!rows.length){
        container.innerHTML = '<div class="trash-empty">No companies found.</div>';
        return;
      }
      const counts = state._advancedInventoryCounts || {};
      const totals = state._advancedTotalOnHand || {};
      const header = (
        '<thead><tr>' +
          '<th>Company</th>' +
          '<th class="col-envtype">Environment</th>' +
          '<th class="col-age">Age</th>' +
          '<th class="col-jobs">Jobs</th>' +
          '<th class="col-pos">POs</th>' +
          '<th class="col-members">Members</th>' +
          '<th class="col-inventory">Items</th>' +
          '<th class="col-inventory">On Hand</th>' +
          '<th class="col-active">Active</th>' +
          '<th class="col-row-menu"></th>' +
        '</tr></thead>'
      );
      const body = rows.map(row => {
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || 'Company';
        const id = String(row.company_id || '').trim();
        const envType = normalizeEnvironmentType(row.environment_type);
        const envBadge = isNonProductionEnvironment(envType)
          ? `<span class="env-badge env-${escapeHtmlAttr(envType)}">${escapeHtml(formatEnvironmentBadgeText(envType))}</span>`
          : '';
        const envCell = envType === 'production'
          ? '<span class="muted">Production</span>'
          : `<span class="env-badge env-${escapeHtmlAttr(envType)}">${escapeHtml(formatEnvironmentTypeLabel(envType))}</span>`;
        const members = Number.isFinite(Number(row.member_count)) ? String(row.member_count) : '0';
        const ageLabel = formatCompanyAge(row && row.created_at ? row.created_at : null);
        const jobCount = Number(row && row.job_count) || 0;
        const poCount = Number(row && row.po_count) || 0;
        const shortId = formatCompanyIdShort(id);
        const isCurrent = String(SB.companyId || '') === id;
        const hasCount = Object.prototype.hasOwnProperty.call(counts, id);
        let invCount = hasCount ? Number(counts[id]) : null;
        if(invCount !== null && !Number.isFinite(invCount)) invCount = 0;
        if(invCount === null && isCurrent && Array.isArray(state.items)){
          invCount = state.items.length;
        }
        const invClass = invCount === null ? 'col-inventory muted' : (invCount > 0 ? 'col-inventory inv-positive' : 'col-inventory muted');
        const invText = invCount === null ? 'â€”' : String(invCount);
        const hasTotal = Object.prototype.hasOwnProperty.call(totals, id);
        let totalOnHand = hasTotal ? Number(totals[id]) : null;
        if(totalOnHand !== null && !Number.isFinite(totalOnHand)) totalOnHand = 0;
        if(totalOnHand === null && isCurrent && Array.isArray(state.items)){
          totalOnHand = state.items.reduce((sum, item) => sum + (Number(item.qty) || 0), 0);
        }
        const totalClass = totalOnHand === null ? 'col-inventory muted' : (totalOnHand > 0 ? 'col-inventory inv-positive' : 'col-inventory muted');
        const totalText = totalOnHand === null ? 'â€”' : totalOnHand.toLocaleString();
        const toggleHtml = `<label class="company-toggle">` +
          `<input type="checkbox" ${isCurrent ? 'checked disabled' : ''} data-company-toggle="${escapeHtmlAttr(id)}" aria-label="Set ${escapeHtmlAttr(name)} as active company">` +
          `<span class="company-toggle-track"><span class="company-toggle-thumb"></span></span>` +
        `</label>`;
        return (
          `<tr${isCurrent ? ' class="is-current"' : ''}>` +
            `<td>` +
              `<div class="manage-companies-name">` +
                `<span>${escapeHtml(name)}</span>` +
                `${envBadge}` +
                `${isCurrent ? '<span class="manage-companies-current">Current</span>' : ''}` +
              `</div>` +
              `<button class="company-id-copy" type="button" data-copy-company-id="${escapeHtmlAttr(id)}" title="Click to copy" aria-label="Copy company ID">` +
                `${escapeHtml(shortId)}` +
              `</button>` +
            `</td>` +
            `<td class="col-envtype">${envCell}</td>` +
            `<td class="col-age">${escapeHtml(ageLabel)}</td>` +
            `<td class="col-jobs">${escapeHtml(jobCount.toLocaleString())}</td>` +
            `<td class="col-pos">${escapeHtml(poCount.toLocaleString())}</td>` +
            `<td class="col-members">${escapeHtml(members)}</td>` +
            `<td class="${invClass}">${escapeHtml(invText)}</td>` +
            `<td class="${totalClass}">${totalText}</td>` +
            `<td class="col-active">${toggleHtml}</td>` +
            `<td class="col-row-menu">` +
              `<div class="company-overflow" data-company-menu="${escapeHtmlAttr(id)}">` +
                `<button class="icon-btn icon-btn--default company-overflow-btn" type="button" data-company-overflow="${escapeHtmlAttr(id)}" aria-haspopup="menu" aria-expanded="false" aria-label="Open company actions">` +
                  `${ICONS.moreHorizontal}` +
                `</button>` +
                `<div class="company-overflow-menu" role="menu" aria-label="Company actions">` +
                  `<div class="company-overflow-section">Manage</div>` +
                  `<button class="company-overflow-item" type="button" role="menuitem" data-manage-users="${escapeHtmlAttr(id)}">Manage Users</button>` +
                  `<button class="company-overflow-item" type="button" role="menuitem" data-manage-inventory="${escapeHtmlAttr(id)}">Manage Inventory</button>` +
                  `<button class="company-overflow-item" type="button" role="menuitem" data-manage-locations="${escapeHtmlAttr(id)}">Manage Locations</button>` +
                  `<div class="company-overflow-section">Data Operations</div>` +
                  `<button class="company-overflow-item" type="button" role="menuitem" data-advanced-seed="${escapeHtmlAttr(id)}">Seed Inventory</button>` +
                  `<button class="company-overflow-item" type="button" role="menuitem" data-advanced-reset-seed="${escapeHtmlAttr(id)}">Reset Seed Lock</button>` +
                  `<div class="company-overflow-section">Settings</div>` +
                  `<button class="company-overflow-item" type="button" role="menuitem" data-advanced-rename="${escapeHtmlAttr(id)}">Rename Company</button>` +
                  `<button class="company-overflow-item" type="button" role="menuitem" data-advanced-set-env="${escapeHtmlAttr(id)}">Set Environment</button>` +
                  `<div class="company-overflow-section">Danger Zone</div>` +
                  `<button class="company-overflow-item danger" type="button" role="menuitem" data-advanced-delete-inventory="${escapeHtmlAttr(id)}">Delete All Inventory</button>` +
                  `<button class="company-overflow-item danger" type="button" role="menuitem" data-advanced-delete-users="${escapeHtmlAttr(id)}">Delete All Users</button>` +
                  `<button class="company-overflow-item danger" type="button" role="menuitem" data-advanced-delete-company="${escapeHtmlAttr(id)}">Delete Company</button>` +
                `</div>` +
              `</div>` +
            `</td>` +
          `</tr>`
        );
      }).join('');
      // Calculate totals for summary row
      let totalMembers = 0;
      let totalItems = 0;
      let totalOnHandSum = 0;
      let totalJobs = 0;
      let totalPOs = 0;
      rows.forEach(row => {
        const id = String(row.company_id || '').trim();
        totalMembers += Number(row.member_count) || 0;
        totalJobs += Number(row.job_count) || 0;
        totalPOs += Number(row.po_count) || 0;
        const hasCount = Object.prototype.hasOwnProperty.call(counts, id);
        if(hasCount){
          totalItems += Number(counts[id]) || 0;
        }
        const hasTotal = Object.prototype.hasOwnProperty.call(totals, id);
        if(hasTotal){
          totalOnHandSum += Number(totals[id]) || 0;
        }
      });
      const summaryRow = `<tr class="summary-row">` +
        `<td colspan="2"><strong>Totals (${rows.length} ${rows.length === 1 ? 'company' : 'companies'})</strong></td>` +
        `<td class="col-age">â€”</td>` +
        `<td class="col-jobs"><strong>${totalJobs.toLocaleString()}</strong></td>` +
        `<td class="col-pos"><strong>${totalPOs.toLocaleString()}</strong></td>` +
        `<td class="col-members"><strong>${totalMembers.toLocaleString()}</strong></td>` +
        `<td class="col-inventory"><strong>${totalItems.toLocaleString()}</strong></td>` +
        `<td class="col-inventory"><strong>${totalOnHandSum.toLocaleString()}</strong></td>` +
        `<td class="col-active"></td>` +
        `<td class="col-row-menu"></td>` +
      `</tr>`;
      container.innerHTML = `<table class="manage-companies-table results-table advanced-switcher-table">${header}<tbody>${body}</tbody><tfoot>${summaryRow}</tfoot></table>`;
      if(!container._wired){
        container._wired = true;
        container.addEventListener('click', async (e)=>{
          const copyBtn = e.target.closest('[data-copy-company-id]');
          if(copyBtn){
            const cid = String(copyBtn.getAttribute('data-copy-company-id') || '').trim();
            if(cid){
              try{
                await navigator.clipboard.writeText(cid);
                toast('Company ID copied to clipboard', 'success');
              }catch(err){
                toast('Copy failed', 'error');
              }
            }
            return;
          }
          const overflowBtn = e.target.closest('[data-company-overflow]');
          if(overflowBtn){
            const menuId = String(overflowBtn.getAttribute('data-company-overflow') || '').trim();
            toggleCompanyOverflowMenu(menuId, overflowBtn);
            return;
          }
          const toggle = e.target.closest('[data-company-toggle]');
          if(toggle && toggle.tagName === 'INPUT'){
            closeCompanyOverflowMenus();
            const targetId = String(toggle.getAttribute('data-company-toggle') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row){
              toggle.checked = false;
              return;
            }
            // Prevent toggling off - can only toggle on
            if(!toggle.checked){
              toggle.checked = true;
              return;
            }
            // Uncheck all other toggles
            container.querySelectorAll('[data-company-toggle]').forEach(t => {
              if(t !== toggle) t.checked = false;
            });
            await handleAdvancedCompanySwitch(row);
            return;
          }
          const manageUsersBtn = e.target.closest('[data-manage-users]');
          if(manageUsersBtn){
            closeCompanyOverflowMenus();
            const targetId = String(manageUsersBtn.getAttribute('data-manage-users') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await openManageUsersModal(row);
            return;
          }
          const manageInvBtn = e.target.closest('[data-manage-inventory]');
          if(manageInvBtn){
            closeCompanyOverflowMenus();
            const targetId = String(manageInvBtn.getAttribute('data-manage-inventory') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await openManageInventoryModal(row);
            return;
          }
          const manageLocationsBtn = e.target.closest('[data-manage-locations]');
          if(manageLocationsBtn){
            closeCompanyOverflowMenus();
            const targetId = String(manageLocationsBtn.getAttribute('data-manage-locations') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await openManageCompanyLocationsModal(row);
            return;
          }
          const seedBtn = e.target.closest('[data-advanced-seed]');
          if(seedBtn){
            closeCompanyOverflowMenus();
            const targetId = String(seedBtn.getAttribute('data-advanced-seed') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await openSeedInventoryModal(row);
            return;
          }
          const resetSeedBtn = e.target.closest('[data-advanced-reset-seed]');
          if(resetSeedBtn){
            closeCompanyOverflowMenus();
            const targetId = String(resetSeedBtn.getAttribute('data-advanced-reset-seed') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await resetInventorySeedRun(row);
            return;
          }
          const renameBtn = e.target.closest('[data-advanced-rename]');
          if(renameBtn){
            closeCompanyOverflowMenus();
            const targetId = String(renameBtn.getAttribute('data-advanced-rename') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            openRenameCompanyModal(row);
            return;
          }
          const setEnvBtn = e.target.closest('[data-advanced-set-env]');
          if(setEnvBtn){
            closeCompanyOverflowMenus();
            const targetId = String(setEnvBtn.getAttribute('data-advanced-set-env') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            openCompanyEnvironmentModal(row);
            return;
          }
          const deleteInventoryBtn = e.target.closest('[data-advanced-delete-inventory]');
          if(deleteInventoryBtn){
            closeCompanyOverflowMenus();
            const targetId = String(deleteInventoryBtn.getAttribute('data-advanced-delete-inventory') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await deleteCompanyInventory(row);
            return;
          }
          const deleteUsersBtn = e.target.closest('[data-advanced-delete-users]');
          if(deleteUsersBtn){
            closeCompanyOverflowMenus();
            const targetId = String(deleteUsersBtn.getAttribute('data-advanced-delete-users') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await deleteCompanyUsers(row);
            return;
          }
          const deleteCompanyBtn = e.target.closest('[data-advanced-delete-company]');
          if(deleteCompanyBtn){
            closeCompanyOverflowMenus();
            const targetId = String(deleteCompanyBtn.getAttribute('data-advanced-delete-company') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await deleteCompanyRecord(row);
            return;
          }
        });
        container.addEventListener('scroll', closeCompanyOverflowMenus, { passive: true });
      }
    }
    async function sbFetchCompanySwitcherCompanies({ search, companyType, limit, environmentType }){
      if(!SB.ready || !SB.client) return [];
      const payload = {
        p_search: search || null,
        p_company_type: companyType || null,
        p_limit: Number.isFinite(Number(limit)) ? Number(limit) : 50,
        p_environment_type: environmentType || null
      };
      try{
        const { data, error } = await SB.client.rpc('get_company_switcher_companies', payload);
        if(error) throw error;
        return Array.isArray(data) ? data : [];
      }catch(e){
        const msg = String(e && e.message ? e.message : '');
        const shouldFallback = msg.includes('schema cache')
          || msg.includes('get_company_switcher_companies')
          || msg.includes('does not exist');
        if(!shouldFallback) throw e;
        const fallbackPayload = {
          p_search: search || null,
          p_company_type: companyType || null,
          p_limit: Number.isFinite(Number(limit)) ? Number(limit) : 50
        };
        const { data, error } = await SB.client.rpc('get_company_switcher_companies', fallbackPayload);
        if(error) throw error;
        return Array.isArray(data) ? data : [];
      }
    }
    async function loadAdvancedCompanies(){
      if(!SB.ready || !SB.session || !SB.client) return;
      if(state._companySwitcherMode !== 'advanced') return;
      if(!isEffectiveSuperUser()){
        setAdvancedCompanyMessage('Super user access required.');
        return;
      }
      const searchInput = $('advancedCompanySearch');
      const typeSelect = $('advancedCompanyTypeFilter');
      const search = String(searchInput ? searchInput.value : '').trim();
      const type = String(typeSelect ? typeSelect.value : '').trim();
      state._advancedSearch = search;
      state._advancedType = type;
      setAdvancedCompanyMessage('Loading...');
      try{
        const rows = await sbFetchCompanySwitcherCompanies({
          search,
          companyType: null,
          limit: 50,
          environmentType: type || null
        });
        state._advancedCompanies = Array.isArray(rows) ? rows : [];
        const countsFromRpc = {};
        const totalsFromRpc = {};
        state._advancedCompanies.forEach(row => {
          const id = String(row && row.company_id ? row.company_id : '').trim();
          if(!id) return;
          if(row && Object.prototype.hasOwnProperty.call(row, 'inventory_count')){
            const raw = Number(row.inventory_count);
            countsFromRpc[id] = Number.isFinite(raw) ? raw : 0;
          }
          if(row && Object.prototype.hasOwnProperty.call(row, 'total_on_hand')){
            const raw = Number(row.total_on_hand);
            totalsFromRpc[id] = Number.isFinite(raw) ? raw : 0;
          }
        });
        state._advancedInventoryCounts = countsFromRpc;
        state._advancedTotalOnHand = totalsFromRpc;
        // Fallback to direct query if RPC didn't return counts OR totals
        const needsFallback = Object.keys(countsFromRpc).length === 0 || Object.keys(totalsFromRpc).length === 0;
        if(needsFallback && state._advancedCompanies.length > 0){
          try{
            const ids = state._advancedCompanies.map(row => String(row.company_id || '').trim()).filter(Boolean);
            await loadAdvancedInventoryCounts(ids);
          }catch(e){
            console.warn('Inventory count query failed:', e);
            state._advancedInventoryCounts = {};
            state._advancedTotalOnHand = {};
          }
        }
        renderAdvancedCompanyResults();
        if(state._seedInventory){
          renderSeedInventoryModal();
        }
        if(!state._advancedCompanies.length){
          setAdvancedCompanyMessage('No companies found.');
        }else{
          setAdvancedCompanyMessage('');
        }
      }catch(e){
        console.warn('Advanced company search failed:', e);
        setAdvancedCompanyMessage(e && e.message ? e.message : 'Failed to load companies.');
        state._advancedCompanies = [];
        renderAdvancedCompanyResults();
      }
    }
    async function openAdvancedCompanySwitcher(){
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      setCompanySwitcherMode('advanced');
      const searchInput = $('advancedCompanySearch');
      const typeSelect = $('advancedCompanyTypeFilter');
      if(searchInput) searchInput.value = state._advancedSearch || '';
      if(typeSelect){
        const desiredType = Object.prototype.hasOwnProperty.call(state, '_advancedType')
          ? state._advancedType
          : '';
        typeSelect.value = desiredType === undefined ? '' : desiredType;
      }
      setAdvancedCompanyMessage('');
      show('advancedCompanyModal', true);
      await loadAdvancedCompanies();
    }
    function wireDeveloperProfileActions(){
      const advancedCompanyBtn = $('openAdvancedCompanySwitcher');
      if(advancedCompanyBtn && !advancedCompanyBtn._wired){
        advancedCompanyBtn._wired = true;
        advancedCompanyBtn.addEventListener('click', ()=>{
          closeProfileMenu();
          void openAdvancedCompanySwitcher();
        });
      }
      const diagnosticsBtn = $('openDiagnostics');
      if(diagnosticsBtn && !diagnosticsBtn._wired){
        diagnosticsBtn._wired = true;
        diagnosticsBtn.addEventListener('click', ()=>{
          closeProfileMenu();
          openDiagnosticsModal();
        });
      }
    }
    async function handleAdvancedCompanySwitch(company){
      if(!company) return;
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const envType = normalizeEnvironmentType(company.environment_type);
      if(envType !== 'production'){
        const ok = await openConfirmModal(
          'Switch to non-production',
          `You are about to switch into ${formatEnvironmentTypeLabel(envType)}. Continue?`,
          { okText: 'Switch', cancelText: 'Cancel' }
        );
        if(!ok) return;
      }
      const ok = await sbSwitchCompany(company.company_id, {
        persist: false,
        companyRow: company,
        audit: true,
        source: 'advanced_switcher'
      });
      if(ok){
        const name = String(company.company_name || company.company_slug || company.company_id || 'company');
        toast(`Switched to ${name}`);
        renderCompanyEnvBadge();
      }
    }
    function setProvisioningMessage(msg){
      const el = $('provisioningMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function slugifyCompanyName(value){
      return String(value || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }
    function isValidCompanySlug(value){
      const slug = String(value || '').trim();
      if(slug.length < 2) return false;
      return /^[a-z0-9][a-z0-9-]*[a-z0-9]$/.test(slug);
    }
    function renderProvisioningUsersList(){
      const list = $('provisioningUsersList');
      if(!list) return;
      const rows = Array.isArray(state._provisioningUsers) ? state._provisioningUsers : [];
      const busy = !!state._provisioningBusy;
      const existingUsers = Array.isArray(state._provisioningExistingUsers) ? state._provisioningExistingUsers : [];
      const existingUsersLoading = !!state._provisioningExistingUsersLoading;
      const existingUsersError = String(state._provisioningExistingUsersError || '');
      const needsExistingUsers = rows.length > 0;
      if(needsExistingUsers && !existingUsersLoading && !existingUsers.length && !existingUsersError){
        void loadProvisioningExistingUsers();
      }
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No users queued.</div>`;
        return;
      }
      const roleOptions = [
        { value: 'admin', label: 'admin' },
        { value: 'member', label: 'manager' },
        { value: 'viewer', label: 'viewer' },
      ];
      const header = (
        `<thead><tr>`+
          `<th>User</th>`+
          `<th>Role</th>`+
          `<th>Action</th>`+
        `</tr></thead>`
      );
      const buildUserSelect = (id, userId) => {
        const normalizedId = String(userId || '').trim().toLowerCase();
        const options = [];
        if(existingUsersLoading){
          options.push(`<option value="">Loading users...</option>`);
        }else if(existingUsers.length){
          options.push(`<option value="">Select a user</option>`);
          existingUsers.forEach(user => {
            const userEmail = String(user.email || '').trim();
            const uid = String(user.user_id || '').trim();
            if(!userEmail || !uid) return;
            const fullName = String(user.full_name || '').trim();
            const label = (fullName && fullName !== userEmail) ? `${fullName} - ${userEmail}` : userEmail;
            const selected = normalizedId && uid.toLowerCase() === normalizedId;
            options.push(`<option value="${escapeHtmlAttr(uid)}"${selected ? ' selected' : ''}>${escapeHtml(label)}</option>`);
          });
        }else{
          const emptyLabel = existingUsersError ? 'Unable to load users' : 'No users available';
          options.push(`<option value="">${escapeHtml(emptyLabel)}</option>`);
        }
        const disabled = busy || existingUsersLoading || !existingUsers.length;
        return (
          `<select data-provisioning-user-id="${escapeHtmlAttr(id)}" data-provisioning-user-field="user_id"${disabled ? ' disabled aria-disabled="true"' : ''}>`+
            options.join('')+
          `</select>`
        );
      };
      const body = rows.map(row => {
        const id = String(row.id || '').trim();
        const userId = String(row.user_id || '');
        const role = String(row.role || 'member');
        const roleSelect = `<select data-provisioning-user-id="${escapeHtmlAttr(id)}" data-provisioning-user-field="role"${busy ? ' disabled aria-disabled="true"' : ''}>`+
          roleOptions.map(opt => `<option value="${escapeHtmlAttr(opt.value)}"${opt.value === role ? ' selected' : ''}>${escapeHtml(opt.label)}</option>`).join('')+
        `</select>`;
        const userCell = buildUserSelect(id, userId);
        return (
          `<tr>`+
            `<td>${userCell}</td>`+
            `<td>${roleSelect}</td>`+
            `<td><button class="btn-tertiary btn-sm btn-danger" data-provisioning-user-remove="${escapeHtmlAttr(id)}"${busy ? ' disabled aria-disabled="true"' : ''}>Remove</button></td>`+
          `</tr>`
        );
      }).join('');
      const errorNote = (existingUsersError && needsExistingUsers)
        ? `<div class="provisioning-note">${escapeHtml(existingUsersError)}</div>`
        : '';
      list.innerHTML = (
        `<div class="provisioning-table-wrap">`+
          `<table class="metrics-table provisioning-table">${header}<tbody>${body}</tbody></table>`+
        `</div>`+
        errorNote
      );
    }
    function renderProvisioningSummary(){
      const summary = $('provisioningSummary');
      if(!summary) return;
      const result = state._provisioningResult;
      if(!result){
        summary.innerHTML = `<div class="muted">No provisioning run yet.</div>`;
        return;
      }
      const items = [];
      if(result.company && result.company.id){
        const name = escapeHtml(result.company.name || 'Company');
        const slug = escapeHtml(result.company.slug || '');
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Company</span> Â· ${name}${slug ? ` (${slug})` : ''}</div>`+
            `<div class="provisioning-status ok">created</div>`+
          `</div>`
        );
      }else{
        const err = escapeHtml(result.company && result.company.error ? result.company.error : 'Failed');
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Company</span> Â· ${err}</div>`+
            `<div class="provisioning-status fail">failed</div>`+
          `</div>`
        );
      }
      const userSummary = result.users && typeof result.users === 'object' ? result.users : null;
      if(userSummary){
        const count = Number.isFinite(userSummary.count) ? userSummary.count : 0;
        const statusClass = userSummary.error ? 'warn' : 'ok';
        const statusText = userSummary.error ? 'partial' : (count ? 'ok' : 'skipped');
        const detail = count ? `Assigned ${count}` : 'None';
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Users</span> Â· ${escapeHtml(detail)}</div>`+
            `<div class="provisioning-status ${statusClass}">${statusText}</div>`+
          `</div>`
        );
        if(userSummary.error){
          items.push(`<div class="provisioning-note">${escapeHtml(userSummary.error)}</div>`);
        }
      }else{
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Users</span> Â· None</div>`+
            `<div class="provisioning-status warn">skipped</div>`+
          `</div>`
        );
      }
      if(result.tier){
        const tierLabel = escapeHtml(String(result.tier.tier || ''));
        const tierStatus = result.tier.success ? 'ok' : (result.tier.error ? 'fail' : 'warn');
        const tierText = result.tier.success ? 'granted' : (result.tier.error ? 'failed' : 'skipped');
        const endLabel = result.tier.ends_at ? formatEasternDateTime(result.tier.ends_at) : '';
        const detail = tierLabel ? `${tierLabel}${endLabel ? ` Â· ends ${escapeHtml(endLabel)}` : ''}` : 'n/a';
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Subscription Tier</span> Â· ${detail}</div>`+
            `<div class="provisioning-status ${tierStatus}">${tierText}</div>`+
          `</div>`
        );
        if(result.tier.error){
          items.push(`<div class="provisioning-note">${escapeHtml(result.tier.error)}</div>`);
        }
      }
      if(result.seeding){
        const seedStatus = result.seeding.success ? 'ok' : (result.seeding.error ? (result.seeding.warning ? 'warn' : 'fail') : 'warn');
        const seedText = result.seeding.success ? 'seeded' : (result.seeding.error ? (result.seeding.warning ? 'skipped' : 'failed') : 'skipped');
        const seedDetail = result.seeding.source_name ? `${escapeHtml(result.seeding.source_name)} Â· ${escapeHtml(result.seeding.dedupe_key || '')}` : 'n/a';
        const count = Number.isFinite(result.seeding.items_copied_count) ? result.seeding.items_copied_count : null;
        const countText = count !== null ? ` Â· ${count} copied` : '';
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Inventory Seeding</span> Â· ${seedDetail}${countText}</div>`+
            `<div class="provisioning-status ${seedStatus}">${seedText}</div>`+
          `</div>`
        );
        if(result.seeding.error){
          items.push(`<div class="provisioning-note">${escapeHtml(result.seeding.error)}</div>`);
        }
      }
      if(result.company && result.company.id){
        const envAttr = result.company.environment_type
          ? ` data-provisioning-open-env="${escapeHtmlAttr(result.company.environment_type)}"`
          : '';
        items.push(
          `<div class="provisioning-users-actions">`+
            `<button class="btn-secondary" data-provisioning-open-id="${escapeHtmlAttr(result.company.id)}" data-provisioning-open-name="${escapeHtmlAttr(result.company.name || '')}" data-provisioning-open-slug="${escapeHtmlAttr(result.company.slug || '')}"${envAttr}>Open Company</button>`+
          `</div>`
        );
      }
      summary.innerHTML = items.join('');
    }
    function renderProvisioningSeedFields(){
      const toggle = $('provisioningSeedToggle');
      const fields = $('provisioningSeedFields');
      if(!toggle || !fields) return;
      fields.style.display = toggle.checked ? '' : 'none';
    }
    function renderProvisioningCompanies(){
      const select = $('provisioningSeedSource');
      if(!select) return;
      const rows = Array.isArray(state._provisioningCompanies) ? state._provisioningCompanies : [];
      const current = String(select.value || '').trim();
      select.innerHTML = '';
      if(!rows.length){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No companies available';
        select.appendChild(opt);
        select.disabled = true;
        return;
      }
      rows.forEach(row => {
        const id = String(row.company_id || row.id || '').trim();
        if(!id) return;
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || id;
        const type = normalizeCompanyType(row.company_type);
        const label = type ? `${name} (${formatCompanyTypeLabel(type)})` : name;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = label;
        select.appendChild(opt);
      });
      const next = rows.some(r => String(r.company_id || r.id) === current) ? current : String(rows[0].company_id || rows[0].id || '');
      if(next) select.value = next;
      select.disabled = rows.length <= 1;
    }
    async function loadProvisioningExistingUsers(){
      if(!SB.ready || !SB.session || !SB.client) return;
      if(!isEffectiveSuperUser()){
        state._provisioningExistingUsersError = 'Super user access required.';
        state._provisioningExistingUsers = [];
        renderProvisioningUsersList();
        return;
      }
      if(state._provisioningExistingUsersLoading) return;
      state._provisioningExistingUsersLoading = true;
      state._provisioningExistingUsersError = '';
      renderProvisioningUsersList();
      try{
        const { data, error } = await SB.client.rpc('get_all_users');
        if(error) throw error;
        const rows = Array.isArray(data) ? data : [];
        const seen = new Set();
        const users = [];
        rows.forEach(row => {
          const email = String(row.email || '').trim();
          if(!email) return;
          const key = String(row.user_id || email).toLowerCase();
          if(seen.has(key)) return;
          seen.add(key);
          users.push({
            user_id: row.user_id || null,
            email,
            full_name: String(row.full_name || '').trim()
          });
        });
        users.sort((a, b) => a.email.localeCompare(b.email));
        state._provisioningExistingUsers = users;
      }catch(e){
        console.warn('Provisioning users load failed:', e);
        state._provisioningExistingUsers = [];
        state._provisioningExistingUsersError = 'Unable to load existing users.';
      }finally{
        state._provisioningExistingUsersLoading = false;
        renderProvisioningUsersList();
      }
    }
    async function loadProvisioningCompanies(){
      if(!SB.ready || !SB.session || !SB.client) return;
      if(!isEffectiveSuperUser()){
        setProvisioningMessage('Super user access required.');
        return;
      }
      setProvisioningMessage('Loading companies...');
      try{
        const rows = await sbFetchCompanySwitcherCompanies({
          search: null,
          companyType: null,
          limit: 200,
          environmentType: null
        });
        state._provisioningCompanies = Array.isArray(rows) ? rows : [];
        renderProvisioningCompanies();
        setProvisioningMessage('');
      }catch(e){
        console.warn('Provisioning companies load failed:', e);
        state._provisioningCompanies = [];
        renderProvisioningCompanies();
        setProvisioningMessage(e && e.message ? e.message : 'Failed to load companies.');
      }
    }
    function resetProvisioningForm(){
      state._provisioningUsers = [];
      state._provisioningResult = null;
      state._provisioningBusy = false;
      state._provisioningExistingUsersError = '';
      const nameInput = $('provisioningCompanyName');
      const slugInput = $('provisioningCompanySlug');
      const onboardingInput = $('provisioningOnboardingState');
      const includeActor = $('provisioningIncludeActor');
      const tierSelect = $('provisioningTierOverride');
      const tierEndsAt = $('provisioningTierEndsAt');
      const envSelect = $('provisioningEnvironmentType');
      const envNote = $('provisioningEnvironmentNote');
      const seedToggle = $('provisioningSeedToggle');
      if(nameInput) nameInput.value = '';
      if(slugInput){
        slugInput.value = '';
        slugInput.dataset.manual = '';
      }
      if(onboardingInput) onboardingInput.value = 'UNINITIALIZED';
      if(includeActor) includeActor.checked = true;
      if(tierSelect) tierSelect.value = '';
      if(tierEndsAt) tierEndsAt.value = '';
      if(envSelect) envSelect.value = 'production';
      if(envNote) envNote.style.display = 'none';
      if(seedToggle) seedToggle.checked = false;
      renderProvisioningSeedFields();
      renderProvisioningUsersList();
      renderProvisioningSummary();
      setProvisioningMessage('');
    }
    async function openProvisioningModal(){
      if(!SB.ready || !SB.client){
        toast('Supabase not configured.');
        return;
      }
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      show('provisioningModal', true);
      renderProvisioningUsersList();
      renderProvisioningSummary();
      renderProvisioningSeedFields();
      if(!Array.isArray(state._provisioningCompanies) || !state._provisioningCompanies.length){
        await loadProvisioningCompanies();
      }else{
        renderProvisioningCompanies();
      }
      if(!Array.isArray(state._provisioningExistingUsers) || !state._provisioningExistingUsers.length){
        state._provisioningExistingUsersError = '';
        void loadProvisioningExistingUsers();
      }
    }
    function closeProvisioningModal(){
      show('provisioningModal', false);
    }
    async function runProvisioning(){
      if(!SB.ready || !SB.client){
        setProvisioningMessage('Supabase not configured.');
        return;
      }
      if(!SB.session || !isEffectiveSuperUser()){
        setProvisioningMessage('Super user access required.');
        return;
      }
      if(state._provisioningBusy) return;
      const nameInput = $('provisioningCompanyName');
      const slugInput = $('provisioningCompanySlug');
      const includeActor = $('provisioningIncludeActor');
      const tierSelect = $('provisioningTierOverride');
      const tierEndsAt = $('provisioningTierEndsAt');
      const envSelect = $('provisioningEnvironmentType');
      const seedToggle = $('provisioningSeedToggle');
      const seedSource = $('provisioningSeedSource');
      const seedDedupe = $('provisioningSeedDedupe');

      const companyName = String(nameInput ? nameInput.value : '').trim();
      if(!companyName){
        setProvisioningMessage('Company name is required.');
        return;
      }
      let slug = String(slugInput ? slugInput.value : '').trim();
      if(!slug) slug = slugifyCompanyName(companyName);
      if(!slug){
        setProvisioningMessage('Company slug is required.');
        return;
      }
      if(!isValidCompanySlug(slug)){
        setProvisioningMessage('Slug must be at least 2 characters and contain only lowercase letters, numbers, and hyphens.');
        return;
      }
      if(slugInput) slugInput.value = slug;

      const envRaw = String(envSelect ? envSelect.value : '').trim();
      const envType = normalizeEnvironmentType(envRaw || 'production');
      if(envSelect) envSelect.value = envType;
      if(envType !== 'production'){
        const confirmed = window.confirm('Non-production companies are not intended for real work. Continue?');
        if(!confirmed) return;
      }

      const userRows = Array.isArray(state._provisioningUsers) ? state._provisioningUsers : [];
      const assignments = [];
      const seenUsers = new Set();
      for(const row of userRows){
        const userId = String(row.user_id || '').trim();
        if(!userId){
          setProvisioningMessage('Select a user for each assignment.');
          return;
        }
        if(seenUsers.has(userId)){
          setProvisioningMessage('Duplicate users selected.');
          return;
        }
        seenUsers.add(userId);
        assignments.push({
          user_id: userId,
          role: String(row.role || 'member').trim() || 'member'
        });
      }

      const wantsSeed = !!(seedToggle && seedToggle.checked);
      const sourceCompanyId = String(seedSource ? seedSource.value : '').trim();
      if(wantsSeed && !sourceCompanyId){
        setProvisioningMessage('Select a source company to seed inventory.');
        return;
      }

      const btn = $('btnProvisioningRun');
      state._provisioningBusy = true;
      renderProvisioningUsersList();
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Provisioning...';
      }
      setProvisioningMessage('');
      state._provisioningResult = null;
      renderProvisioningSummary();

      const result = {
        company: null,
        users: null,
        tier: null,
        seeding: null,
      };

      try{
        const tierValue = String(tierSelect ? tierSelect.value : '').trim();
        const endsAtRaw = String(tierEndsAt ? tierEndsAt.value : '').trim();
        let endsAt = null;
        if(endsAtRaw){
          const parsed = new Date(endsAtRaw);
          if(Number.isNaN(parsed.getTime())){
            setProvisioningMessage('Override end date is invalid.');
            throw new Error('Invalid override end date');
          }
          endsAt = parsed.toISOString();
        }
        if(endsAt && !tierValue){
          setProvisioningMessage('Select a subscription tier before setting an end date.');
          throw new Error('Override tier required');
        }
        const payload = {
          p_name: companyName,
          p_slug: slug,
          p_subscription_tier: tierValue || null,
          p_subscription_tier_reason: 'Provisioning',
          p_subscription_tier_ends_at: endsAt,
          p_seed_inventory: wantsSeed,
          p_source_company_id: wantsSeed ? sourceCompanyId : null,
          p_seed_dedupe_key: String(seedDedupe ? seedDedupe.value : 'sku').trim() || 'sku',
          p_user_assignments: assignments,
          p_include_actor_as_admin: includeActor ? !!includeActor.checked : true,
          p_environment_type: envType
        };
        const { data, error } = await SB.client.rpc('provision_company', payload);
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Company creation failed');
        }
        const companyId = String((data && data.company_id) || '').trim();
        if(!companyId) throw new Error('Company id missing');
        result.company = {
          id: companyId,
          name: String(data.company_name || companyName),
          slug: String(data.company_slug || slug),
          environment_type: envType
        };
        if(Array.isArray(SB.companies)){
          const existingIdx = SB.companies.findIndex(row => String(row.company_id) === companyId);
          const newRow = {
            company_id: companyId,
            company_name: String(data.company_name || companyName),
            company_slug: String(data.company_slug || slug),
            my_role: 'super_user',
            is_super_user: true,
            company_type: 'production',
            environment_type: envType,
          };
          if(existingIdx >= 0){
            SB.companies[existingIdx] = { ...SB.companies[existingIdx], ...newRow };
          }else{
            SB.companies = [newRow, ...SB.companies];
          }
          renderCompanySwitcher();
        }
        result.users = { count: Number(data.users_added_count || 0) };
        result.tier = data.tier_override || null;
        result.seeding = data.inventory_seed || null;
        const sourceRow = (Array.isArray(state._provisioningCompanies) ? state._provisioningCompanies : [])
          .find(r => String(r.company_id || r.id) === sourceCompanyId);
        if(result.seeding){
          result.seeding.source_name = sourceRow ? String(sourceRow.company_name || sourceRow.company_slug || sourceRow.company_id || '') : '';
          result.seeding.dedupe_key = payload.p_seed_dedupe_key;
          const seedErr = String(result.seeding.error || '').toLowerCase();
          if(seedErr && seedErr.includes('already seeded')){
            result.seeding.warning = true;
          }
        }
      }catch(e){
        result.company = { name: companyName, slug, error: e && e.message ? e.message : 'Company creation failed' };
        state._provisioningResult = result;
        renderProvisioningSummary();
        setProvisioningMessage(result.company.error);
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Provision Company';
        }
        state._provisioningBusy = false;
        renderProvisioningUsersList();
        return;
      }

      state._provisioningResult = result;
      renderProvisioningSummary();
      const hasIssues = Boolean(
        (result.users && result.users.error) ||
        (result.tier && result.tier.error) ||
        (result.seeding && result.seeding.error && !result.seeding.warning)
      );
      setProvisioningMessage(hasIssues ? 'Provisioning completed with issues.' : 'Provisioning complete.');
      if(btn){
        btn.disabled = false;
        btn.setAttribute('aria-disabled', 'false');
        btn.textContent = 'Provision Company';
      }
      state._provisioningBusy = false;
      renderProvisioningUsersList();
    }
    function setDiagnosticsMessage(msg){
      const el = $('diagSimMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function setDiagnosticsMetricOutput(content){
      const el = $('diagMetricOutput');
      if(!el) return;
      el.textContent = content || '';
    }
    function getDiagnosticsRole(){
      const raw = state._diagRole ? String(state._diagRole) : '';
      const normalized = raw ? normalizeRoleName(raw) : '';
      if(normalized) return normalized;
      return getAuthorityRole() || 'super_user';
    }
    function getDiagnosticsTier(){
      const raw = state._diagTier ? String(state._diagTier) : '';
      const normalized = raw ? normalizeTier(raw) : '';
      if(normalized) return normalized;
      return normalizeTier(getCompanyTier()) || TIER_FALLBACK;
    }
    function isDiagnosticsTierSimulated(){
      return !!state._diagTier;
    }
    function isDiagnosticsRoleSimulated(){
      return !!state._diagRole;
    }
    function isTierAtLeast(current, required){
      const currentTier = normalizeTier(current);
      const requiredTier = normalizeTier(required);
      if(!requiredTier) return true;
      return TIER_ORDER.indexOf(currentTier) >= TIER_ORDER.indexOf(requiredTier);
    }
    function hasPermissionInSet(permissions, key){
      if(!permissions || !key) return false;
      if(Object.prototype.hasOwnProperty.call(permissions, key)){
        return permissions[key] === true;
      }
      const legacy = LEGACY_PERMISSION_MAP[key];
      if(legacy && Array.isArray(legacy.any)){
        return legacy.any.some(k => permissions[k] === true);
      }
      if(legacy && Array.isArray(legacy.all)){
        return legacy.all.every(k => permissions[k] === true);
      }
      return false;
    }
    async function applyDiagnosticsSimulation(){
      const roleSelect = $('diagRoleSelect');
      const tierSelect = $('diagTierSelect');
      const roleValue = roleSelect ? String(roleSelect.value || '').trim() : '';
      const tierValue = tierSelect ? String(tierSelect.value || '').trim() : '';
      state._diagRole = roleValue ? normalizeRoleName(roleValue) : '';
      state._diagTier = tierValue ? normalizeTier(tierValue) : '';
      state._diagPermissions = null;
      if(state._diagRole && state._diagRole !== 'super_user'){
        state._diagPermissions = await loadImpersonationPermissions(state._diagRole);
      }
      renderDiagnosticsChecks();
      updateDiagnosticsMetricTierHint();
      if(!state._diagRole && !state._diagTier){
        setDiagnosticsMessage('Simulation cleared.');
      }else{
        const roleLabel = state._diagRole ? state._diagRole : 'current';
        const tierLabel = state._diagTier ? formatTierLabel(state._diagTier) : 'current';
        setDiagnosticsMessage(`Simulation active: role=${roleLabel}, tier=${tierLabel}.`);
      }
    }
    function resetDiagnosticsSimulation(){
      state._diagRole = '';
      state._diagTier = '';
      state._diagPermissions = null;
      const roleSelect = $('diagRoleSelect');
      const tierSelect = $('diagTierSelect');
      if(roleSelect) roleSelect.value = '';
      if(tierSelect) tierSelect.value = '';
      renderDiagnosticsChecks();
      updateDiagnosticsMetricTierHint();
      setDiagnosticsMessage('Simulation cleared.');
    }
    function getDiagnosticsPermissions(){
      const role = getDiagnosticsRole();
      if(role === 'super_user') return null;
      if(state._diagPermissions && typeof state._diagPermissions === 'object') return state._diagPermissions;
      return getEffectivePermissions();
    }
    function getDiagnosticsTierLabel(){
      const tier = getDiagnosticsTier();
      const label = formatTierLabel(tier);
      return isDiagnosticsTierSimulated() ? `${label} (simulated)` : label;
    }
    const DIAGNOSTIC_CHECKS = [
      {
        id: 'items_view',
        label: 'Inventory Items: View',
        requiredTier: 'starter',
        requiredPermission: PERMISSIONS.ITEMS_VIEW,
        source: 'policy',
      },
      {
        id: 'items_export',
        label: 'Inventory: Export',
        requiredTier: 'professional',
        requiredPermission: PERMISSIONS.ITEMS_EXPORT,
        source: 'workflow',
      },
      {
        id: 'orders_view',
        label: 'Orders: View',
        requiredTier: 'business',
        requiredPermission: PERMISSIONS.ORDERS_VIEW,
        source: 'policy',
      },
      {
        id: 'orders_create',
        label: 'Orders: Create',
        requiredTier: 'business',
        requiredPermission: PERMISSIONS.ORDERS_CREATE,
        source: 'policy',
      },
      {
        id: 'snapshots_view',
        label: 'Snapshots: View',
        requiredTier: 'business',
        requiredPermission: PERMISSIONS.SNAPSHOTS_VIEW,
        source: 'workflow',
      },
      {
        id: 'metrics_dashboard',
        label: 'Metrics Dashboard',
        requiredTier: 'professional',
        requiredPermission: PERMISSIONS.METRICS_VIEW,
        source: 'workflow',
      },
      {
        id: 'audit_log_view',
        label: 'Audit Log: View',
        requiredTier: 'enterprise',
        requiredPermission: PERMISSIONS.AUDIT_LOG_VIEW,
        source: 'policy',
      },
      {
        id: 'platform_metrics',
        label: 'Platform Metrics',
        requiredTier: 'professional',
        requiredPermission: PERMISSIONS.PLATFORM_VIEW_METRICS,
        source: 'workflow',
      },
    ];
    function renderDiagnosticsChecks(){
      const container = $('diagChecks');
      if(!container) return;
      if(!SB.session || !isEffectiveSuperUser()){
        container.innerHTML = '<div class="trash-empty">Super user access required.</div>';
        return;
      }
      const role = getDiagnosticsRole();
      const tierLabel = getDiagnosticsTierLabel();
      const permissions = getDiagnosticsPermissions();
      const rows = DIAGNOSTIC_CHECKS.map(check => {
        const tierOk = role === 'super_user' ? true : isTierAtLeast(getDiagnosticsTier(), check.requiredTier);
        const permissionOk = role === 'super_user'
          ? true
          : (check.requiredPermission ? hasPermissionInSet(permissions, check.requiredPermission) : true);
        let rule = 'allowed';
        let allowed = true;
        if(role === 'super_user'){
          rule = 'super_user_bypass';
        }else if(!tierOk){
          rule = 'tier_gate';
          allowed = false;
        }else if(!permissionOk){
          rule = 'permission_gate';
          allowed = false;
        }
        const requiredPermission = check.requiredPermission || 'â€”';
        const badge = `<span class="diag-badge ${allowed ? 'pass' : 'fail'}">${allowed ? 'ALLOW' : 'BLOCK'}</span>`;
        return (
          `<tr>` +
            `<td>${escapeHtml(check.label)}</td>` +
            `<td>${escapeHtml(check.source)}</td>` +
            `<td>${escapeHtml(formatTierLabel(check.requiredTier))}</td>` +
            `<td>${escapeHtml(requiredPermission)}</td>` +
            `<td>${escapeHtml(tierLabel)}</td>` +
            `<td>${escapeHtml(rule)}</td>` +
            `<td>${badge}</td>` +
          `</tr>`
        );
      }).join('');
      container.innerHTML =
        `<table class="diag-table">` +
          `<thead>` +
            `<tr>` +
              `<th>Action</th>` +
              `<th>Source</th>` +
              `<th>Required Tier</th>` +
              `<th>Required Permission</th>` +
              `<th>Current Tier</th>` +
              `<th>Rule Fired</th>` +
              `<th>Result</th>` +
            `</tr>` +
          `</thead>` +
          `<tbody>${rows}</tbody>` +
        `</table>`;
    }
    function mapSubscriptionTierToMetricTier(tier){
      const normalized = normalizeTier(tier);
      if(normalized === 'starter') return 'TIER_1';
      if(normalized === 'professional') return 'TIER_2';
      if(normalized === 'business') return 'TIER_2';
      if(normalized === 'enterprise') return 'TIER_3';
      return 'TIER_1';
    }
    function updateDiagnosticsMetricTierHint(){
      const hint = $('diagMetricTierHint');
      if(!hint) return;
      const tier = getDiagnosticsTier();
      const metricTier = mapSubscriptionTierToMetricTier(tier);
      const label = isDiagnosticsTierSimulated()
        ? `Metric tier preview uses ${metricTier} (from simulated ${formatTierLabel(tier)}).`
        : `Metric tier preview uses ${metricTier} (from ${formatTierLabel(tier)}).`;
      hint.textContent = label;
    }
    function getMetricsPreviewUrl(){
      const override = (typeof window.METRICS_PREVIEW_URL === 'string') ? window.METRICS_PREVIEW_URL.trim() : '';
      if(override) return override;
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/metrics-preview`;
      return '/functions/v1/metrics-preview';
    }
    function parseDiagnosticsJson(value){
      const raw = String(value || '').trim();
      if(!raw) return {};
      return JSON.parse(raw);
    }
    async function runDiagnosticsMetricPreview(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const metricId = String($('diagMetricId')?.value || '').trim();
      if(!metricId){
        setDiagnosticsMetricOutput('Metric ID is required.');
        return;
      }
      let context = {};
      let inputs = {};
      try{
        context = parseDiagnosticsJson($('diagMetricContext')?.value || '');
      }catch(e){
        setDiagnosticsMetricOutput('Invalid JSON in Time Context.');
        return;
      }
      try{
        inputs = parseDiagnosticsJson($('diagMetricInputs')?.value || '');
      }catch(e){
        setDiagnosticsMetricOutput('Invalid JSON in Inputs.');
        return;
      }
      const metricTier = mapSubscriptionTierToMetricTier(getDiagnosticsTier());
      const payload = {
        metric_id: metricId,
        context,
        inputs,
        simulate_tier: metricTier
      };
      setDiagnosticsMetricOutput('Running preview...');
      try{
        const apiUrl = getMetricsPreviewUrl();
        const headers = { 'content-type': 'application/json' };
        const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
        const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
        if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
          headers['apikey'] = sbKey;
          if(SB.session && SB.session.access_token){
            headers['Authorization'] = `Bearer ${SB.session.access_token}`;
          }
        }
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if(!res.ok){
          const msg = data && data.error ? `${data.error.code || 'Error'}: ${data.error.message || ''}` : 'Preview failed';
          const tierEval = data && data.tier_evaluation ? data.tier_evaluation : null;
          const output = {
            ok: false,
            error: msg,
            tier_evaluation: tierEval,
          };
          setDiagnosticsMetricOutput(JSON.stringify(output, null, 2));
          return;
        }
        setDiagnosticsMetricOutput(JSON.stringify(data, null, 2));
      }catch(e){
        setDiagnosticsMetricOutput('Preview failed.');
      }
    }
    function openDiagnosticsModal(){
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return;
      }
      const roleSelect = $('diagRoleSelect');
      const tierSelect = $('diagTierSelect');
      if(roleSelect) roleSelect.value = state._diagRole ? state._diagRole : '';
      if(tierSelect) tierSelect.value = state._diagTier ? state._diagTier : '';
      renderDiagnosticsChecks();
      updateDiagnosticsMetricTierHint();
      setDiagnosticsMetricOutput('');
      if(state._diagRole || state._diagTier){
        const roleLabel = state._diagRole ? state._diagRole : 'current';
        const tierLabel = state._diagTier ? formatTierLabel(state._diagTier) : 'current';
        setDiagnosticsMessage(`Simulation active: role=${roleLabel}, tier=${tierLabel}.`);
      }else{
        setDiagnosticsMessage('');
      }
      show('diagnosticsModal', true);
    }
    function renderRoleTestingSwitcher(){
      renderRoleSwitcherPills();
    }
    function renderRoleSwitcherPills(){
      const section = $('roleSwitcherSection');
      const pillsContainer = $('rolePills');
      const testingBanner = $('testingBanner');
      const testingRoleName = $('testingRoleName');
      const exitBtn = $('btnExitTesting');
      if(!section) return;
      if(!SB.session || !isSuperUser()){
        section.style.display = 'none';
        if(testingBanner) testingBanner.style.display = 'none';
        return;
      }
      section.style.display = '';
      const impersonating = isImpersonating();
      const currentRole = ensureImpersonationRole(state._impersonationRole);
      if(testingBanner){
        testingBanner.style.display = impersonating ? 'flex' : 'none';
        if(testingRoleName && impersonating){
          testingRoleName.textContent = currentRole;
        }
      }
      if(pillsContainer){
        const pills = pillsContainer.querySelectorAll('.role-pill');
        pills.forEach(pill => {
          const role = pill.getAttribute('data-role');
          pill.classList.toggle('is-active', role === currentRole);
        });
        if(!pillsContainer._wired){
          pillsContainer._wired = true;
          pillsContainer.addEventListener('click', async (e)=>{
            const pill = e.target.closest('.role-pill');
            if(!pill) return;
            const nextRole = pill.getAttribute('data-role') || 'super_user';
            await setImpersonationRole(nextRole, 'role_pill');
          });
        }
      }
      if(exitBtn && !exitBtn._wired){
        exitBtn._wired = true;
        exitBtn.addEventListener('click', async ()=>{
          await setImpersonationRole('super_user', 'exit_banner');
        });
      }
    }
    function formatTierLabel(value){
      const tier = normalizeTier(value);
      if(!tier) return 'â€”';
      return TIER_LABELS[tier] || tier;
    }
    function formatBillingState(value){
      const state = String(value || '').trim().toLowerCase();
      if(!state) return 'â€”';
      if(state === 'none') return 'None';
      return state.charAt(0).toUpperCase() + state.slice(1);
    }
    function formatDurationMinutes(ms){
      const totalMinutes = Math.max(0, Math.floor(ms / 60000));
      const days = Math.floor(totalMinutes / 1440);
      const hours = Math.floor((totalMinutes % 1440) / 60);
      const minutes = totalMinutes % 60;
      const parts = [];
      if(days) parts.push(`${days}d`);
      if(hours || (days && minutes)) parts.push(`${hours}h`);
      if(!days && !hours) parts.push(`${minutes}m`);
      return parts.join(' ');
    }
    function formatOverrideExpiry(value){
      if(!value) return 'â€”';
      const end = new Date(value);
      if(Number.isNaN(end.getTime())) return 'â€”';
      const now = new Date();
      const delta = end.getTime() - now.getTime();
      const when = formatEasternDateTime(end);
      if(delta <= 0) return `${when} Â· expired`;
      return `${when} Â· in ${formatDurationMinutes(delta)}`;
    }
    function formatCompanyAge(value){
      if(!value) return 'â€”';
      const created = new Date(value);
      if(Number.isNaN(created.getTime())) return 'â€”';
      const days = Math.max(0, Math.floor((Date.now() - created.getTime()) / 86400000));
      if(days < 1) return '<1d';
      return `${days}d`;
    }
    function normalizeCompanyType(value){
      const type = String(value || '').trim().toLowerCase();
      if(type === 'staging' || type === 'sandbox' || type === 'development') return 'test';
      if(type === 'test' || type === 'production') return type;
      return 'production';
    }
    function formatCompanyTypeLabel(value){
      const type = normalizeCompanyType(value);
      if(type === 'test') return 'Test';
      return 'Production';
    }
    function normalizeEnvironmentType(value){
      const raw = String(value || '').trim().toLowerCase();
      if(raw === 'test' || raw === 'internal_test' || raw === 'internal-test' || raw === 'demo' || raw === 'sandbox') return 'test';
      if(raw === 'production') return 'production';
      return 'production';
    }
    function formatEnvironmentTypeLabel(value){
      const type = normalizeEnvironmentType(value);
      if(type === 'test') return 'Test';
      return 'Production';
    }
    function formatEnvironmentBadgeText(value){
      const type = normalizeEnvironmentType(value);
      if(type === 'test') return 'TEST';
      return '';
    }
    function isNonProductionEnvironment(value){
      return normalizeEnvironmentType(value) !== 'production';
    }
    function renderCompanyEnvBadge(){
      const badge = $('profileEnvBadge');
      const note = $('profileEnvNote');
      if(!badge) return;
      if(!SB.companyId){
        badge.textContent = '';
        badge.className = 'env-badge profile-env-badge hidden';
        if(note) note.style.display = 'none';
        return;
      }
      const envType = normalizeEnvironmentType(SB.company && SB.company.environment_type);
      const badgeText = formatEnvironmentBadgeText(envType);
      if(!badgeText){
        badge.textContent = '';
        badge.className = 'env-badge profile-env-badge hidden';
        if(note) note.style.display = 'none';
        return;
      }
      badge.textContent = badgeText;
      badge.className = `env-badge profile-env-badge env-${envType}`;
      if(note) note.style.display = '';
    }
    function getCompanyEnvironmentTypeById(companyId){
      const id = String(companyId || '').trim();
      if(!id) return 'production';
      const sources = [
        Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [],
        Array.isArray(state._locationsCompanies) ? state._locationsCompanies : [],
        Array.isArray(SB.companies) ? SB.companies : []
      ];
      for(const list of sources){
        const row = list.find(r => String((r && (r.company_id || r.id)) || '').trim() === id);
        if(row && row.environment_type){
          return String(row.environment_type || '').trim();
        }
      }
      if(SB.company && String(SB.companyId || '') === id && SB.company.environment_type){
        return String(SB.company.environment_type || '').trim();
      }
      return 'production';
    }
    function renderLocationsEnvBadge(companyId){
      const badge = $('locationsSelectedEnvBadge');
      if(!badge) return;
      const envType = normalizeEnvironmentType(getCompanyEnvironmentTypeById(companyId));
      const text = formatEnvironmentBadgeText(envType);
      if(!text){
        badge.textContent = '';
        badge.className = 'env-badge locations-env-badge hidden';
        return;
      }
      badge.textContent = text;
      badge.className = `env-badge locations-env-badge env-${envType}`;
    }
    function setTierOverrideMessage(msg){
      const el = $('tierOverrideMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    async function loadTierDetails(companyId){
      if(!SB.ready || !SB.session || !SB.client) return null;
      try{
        const { data, error } = await SB.client.rpc('get_company_tier_details', {
          p_company_id: companyId
        });
        if(error) throw error;
        const row = Array.isArray(data) ? data[0] : data;
        return row && typeof row === 'object' ? row : null;
      }catch(e){
        console.warn('Tier details load failed:', e);
        return null;
      }
    }
    async function refreshTierAdminDetails(){
      if(!SB.companyId) return;
      state._tierDetailsCompanyId = String(SB.companyId);
      state._tierDetails = await loadTierDetails(SB.companyId);
      renderTierAdminSection();
    }
    function renderTierAdminSection(){
      const section = $('tierOverrideSection');
      const divider = $('tierOverrideDivider');
      if(!section) return;
      if(!SB.session || !isEffectiveSuperUser() || !SB.companyId){
        section.style.display = 'none';
        if(divider) divider.style.display = 'none';
        return;
      }
      section.style.display = '';
      if(divider) divider.style.display = '';
      const companyName = SB.company ? String(SB.company.company_name || SB.company.company_slug || SB.company.company_id || '') : '';
      const meta = $('tierOverrideCompany');
      if(meta) meta.textContent = companyName ? `Company: ${companyName}` : '';

      const baseSelect = $('tierBaseSelect');
      if(baseSelect){
        baseSelect.innerHTML = TIER_ORDER.map(tier => (
          `<option value="${escapeHtmlAttr(tier)}">${escapeHtml(formatTierLabel(tier))}</option>`
        )).join('');
      }
      const overrideSelect = $('tierOverrideTierSelect');
      if(overrideSelect){
        const options = ['', ...TIER_ORDER];
        overrideSelect.innerHTML = options.map(tier => {
          const label = tier ? formatTierLabel(tier) : 'Select tier';
          return `<option value="${escapeHtmlAttr(tier)}">${escapeHtml(label)}</option>`;
        }).join('');
      }

      const details = (state._tierDetailsCompanyId === String(SB.companyId)) ? state._tierDetails : null;
      if(!details){
        if($('tierBaseValue')) $('tierBaseValue').textContent = 'Loadingâ€¦';
        if($('tierOverrideValue')) $('tierOverrideValue').textContent = 'Loadingâ€¦';
        if($('tierEffectiveValue')) $('tierEffectiveValue').textContent = 'Loadingâ€¦';
        if($('tierOverrideExpiresValue')) $('tierOverrideExpiresValue').textContent = 'Loadingâ€¦';
        if(baseSelect) baseSelect.value = '';
        if(overrideSelect) overrideSelect.value = '';
        const endsInput = $('tierOverrideEndsAt');
        if(endsInput) endsInput.value = '';
        setTierOverrideMessage('');
        void refreshTierAdminDetails();
        return;
      }

      if($('tierBaseValue')) $('tierBaseValue').textContent = formatTierLabel(details.base_tier);
      if($('tierOverrideValue')) $('tierOverrideValue').textContent = details.override_tier ? formatTierLabel(details.override_tier) : 'None';
      if($('tierEffectiveValue')) $('tierEffectiveValue').textContent = formatTierLabel(details.effective_tier);
      if($('tierOverrideExpiresValue')) $('tierOverrideExpiresValue').textContent = formatOverrideExpiry(details.override_ends_at);
      if(baseSelect) baseSelect.value = normalizeTier(details.base_tier) || 'starter';
      if(overrideSelect) overrideSelect.value = '';
      const endsInput = $('tierOverrideEndsAt');
      if(endsInput) endsInput.value = '';
      const revokeBtn = $('btnTierOverrideRevoke');
      if(revokeBtn){
        const canRevoke = !!details.override_tier;
        revokeBtn.disabled = !canRevoke;
        revokeBtn.setAttribute('aria-disabled', canRevoke ? 'false' : 'true');
      }
      setTierOverrideMessage('');
    }
	    function setInviteMessage(msg){
	      const el = $('inviteMsg'); if(!el) return;
	      el.textContent = String(msg || '');
	    }
	    function showInviteLink(url){
	      const row = $('inviteLinkRow');
	      const input = $('inviteLink');
	      if(!row || !input) return;
	      const value = String(url || '').trim();
	      input.value = value;
	      row.style.display = value ? 'flex' : 'none';
	    }
    function renderInviteUi(){
      const section = $('inviteSection');
      const email = $('inviteEmail');
      const role = $('inviteRole');
      const btn = $('btnInviteSend');
      const companyRow = $('inviteCompanyRow');
      const companySelect = $('inviteCompany');
      if(!section) return;
      if(!SB.session){
        section.style.display = 'none';
        return;
      }
      section.style.display = '';
      const superUser = isEffectiveSuperUser();
      if(companyRow) companyRow.style.display = superUser ? '' : 'none';
      let selectedCompanyId = SB.companyId ? String(SB.companyId) : '';
      if(superUser && companySelect){
        let rows = Array.isArray(SB.companies) ? SB.companies.slice() : [];
        // During onboarding, ensure the onboarding company is in the list
        if(_onboardingCompanyId && !rows.some(r => String(r.company_id) === _onboardingCompanyId)){
          // Add onboarding company from SB.company if available
          if(SB.company && String(SB.company.id || SB.company.company_id || '') === _onboardingCompanyId){
            rows.unshift({
              company_id: _onboardingCompanyId,
              company_name: SB.company.name || SB.company.company_name || 'Onboarding Company',
              company_slug: SB.company.slug || SB.company.company_slug || ''
            });
          }
        }
        companySelect.innerHTML = '';
        if(!rows.length){
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No companies available';
          companySelect.appendChild(opt);
          companySelect.disabled = true;
          selectedCompanyId = '';
        }else{
          rows.forEach(row => {
            const id = String(row && row.company_id ? row.company_id : '').trim();
            if(!id) return;
            const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || id;
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = name;
            companySelect.appendChild(opt);
          });
          // During onboarding, default to the onboarding company
          if(isOnboardingRoute() && _onboardingCompanyId && rows.some(r => String(r.company_id) === _onboardingCompanyId)){
            selectedCompanyId = _onboardingCompanyId;
          }else if(_inviteCompanyId && rows.some(r => String(r.company_id) === _inviteCompanyId)){
            selectedCompanyId = _inviteCompanyId;
          }else if(!selectedCompanyId || !rows.some(r => String(r.company_id) === selectedCompanyId)){
            selectedCompanyId = String(rows[0].company_id || '');
          }
          companySelect.value = selectedCompanyId || '';
          companySelect.disabled = rows.length <= 1;
        }
      }
      const currentCompanyId = superUser
        ? String(selectedCompanyId || '').trim()
        : (SB.companyId ? String(SB.companyId) : '');
      if(currentCompanyId !== _inviteCompanyId){
        _inviteCompanyId = currentCompanyId;
        showInviteLink('');
        setInviteMessage('');
      }
      const allow = !!(currentCompanyId && canAccessInvites());
      const disabled = !allow;
      if(email) email.disabled = disabled;
      if(role) role.disabled = disabled;
      if(btn){
	        btn.disabled = disabled;
	        btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
	      }
      if(disabled){
        showInviteLink('');
        if(!currentCompanyId){
          setInviteMessage('Select a company to invite users.');
        }else if(!hasTier('business')){
          setInviteMessage('Invites require Business tier.');
        }else if(!canInvite()){
          setInviteMessage('Invite permissions required.');
        }else{
	          setInviteMessage('');
	        }
	      }
	    }
	    function storeInviteTokenFromUrl(){
	      try{
	        const params = new URLSearchParams(window.location.search);
	        const token = params.get('invite') || params.get('invite_id');
	        if(!token) return '';
	        localStorage.setItem('inv.pendingInvite', token);
	        window.history.replaceState({}, '', window.location.pathname);
	        return token;
	      }catch(e){}
	      return '';
	    }
	    async function sbCheckPendingInvite(){
	      storeInviteTokenFromUrl();
	      if(!SB.ready || !SB.session || !SB.client) return false;
	      const token = localStorage.getItem('inv.pendingInvite');
	      if(!token) return false;
	      try{
	        const { data, error } = await SB.client.rpc('accept_company_invite', { p_invite_id: token });
	        if(error) throw error;
	        if(data && data.success){
	          localStorage.removeItem('inv.pendingInvite');
	          const role = data.role ? String(data.role) : 'member';
	          toast(`Welcome! Joined as ${role}.`);
	          return true;
	        }
	        const msg = data && data.error ? String(data.error) : 'Failed to accept invitation';
	        if(!/different email/i.test(msg)){
	          localStorage.removeItem('inv.pendingInvite');
	        }
	        toast(msg);
	      }catch(e){
	        toast('Invitation error');
	      }
	      return false;
	    }
    function getInviteAcceptUrl(){
      const override = (typeof window.INVITE_ACCEPT_URL === 'string') ? window.INVITE_ACCEPT_URL.trim() : '';
      if(override) return override;
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/accept-invite`;
      return '/functions/v1/accept-invite';
    }
    function getPendingInviteToken(){
      try{
        return localStorage.getItem('inv.pendingInvite') || '';
      }catch(e){
        return '';
      }
    }
    function setInviteAcceptMessage(msg){
      const el = $('inviteAcceptMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function resetInviteAcceptForm(){
      const pw = $('inviteAcceptPassword');
      const confirm = $('inviteAcceptPasswordConfirm');
      if(pw) pw.value = '';
      if(confirm) confirm.value = '';
      setInviteAcceptMessage('');
    }
    function openInviteAcceptModal(){
      resetInviteAcceptForm();
      show('inviteAcceptModal', true);
    }
    function closeInviteAcceptModal(){
      show('inviteAcceptModal', false);
    }
    async function sbCompleteInvite(password, confirm){
      const token = getPendingInviteToken();
      if(!token) throw Error('Invite token missing');
      const pw = String(password || '');
      const pwConfirm = String(confirm || '');
      if(pw.length < 8) throw Error('Use at least 8 characters');
      if(pw !== pwConfirm) throw Error('Passwords do not match');
      const apiUrl = getInviteAcceptUrl();
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        headers['Authorization'] = `Bearer ${SB.session && SB.session.access_token ? SB.session.access_token : sbKey}`;
      }
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify({ invite_id: token, password: pw }),
      });
      const data = await res.json().catch(() => ({}));
      if(!res.ok){
        const errText = data && (data.error || data.message) ? String(data.error || data.message) : 'Invite setup failed';
        return { ok: false, error: errText, code: data?.code, email: data?.email };
      }
      return data || { ok: true };
    }
    function getInviteSendUrl(){
      const override = (typeof window.INVITE_SEND_URL === 'string') ? window.INVITE_SEND_URL.trim() : '';
      if(override) return override;
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/send-invite`;
      return '/functions/v1/send-invite';
    }
    async function sbInviteUser(email, role, companyId, opts = {}){
      if(!SB.ready || !SB.client) throw Error('Not authorized');
      const options = (opts && typeof opts === 'object') ? opts : {};
      const targetCompanyId = String(companyId || '').trim() || (SB.companyId ? String(SB.companyId) : '');
      if(!targetCompanyId) throw Error('Company not selected');
      const currentCompanyId = SB.companyId ? String(SB.companyId) : '';
      const enforceChecks = options.skipChecks !== true && (!currentCompanyId || targetCompanyId === currentCompanyId);
      if(enforceChecks && !hasTier('business')) throw Error('Invites require Business tier');
      if(enforceChecks && !canInvite()) throw Error('Permission denied');
      const cleanEmail = String(email || '').trim();
      if(!cleanEmail) throw Error('Email required');
      const cleanRole = String(role || 'member').trim() || 'member';
      const apiUrl = getInviteSendUrl();
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        if(SB.session && SB.session.access_token){
          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
        }
      }
      const baseUrl = `${window.location.origin}${window.location.pathname}`.replace(/\?[^#]*$/, '');
      const payload = {
        email: cleanEmail,
        role: cleanRole,
        company_id: targetCompanyId,
        app_url: baseUrl,
      };
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload),
      });
      const data = await res.json().catch(() => ({}));
      if(!res.ok){
        return {
          ok: false,
          error: data && data.error ? data.error : 'Invite failed',
          invite_url: data && data.invite_url ? data.invite_url : '',
          invite_id: data && data.invite_id ? data.invite_id : '',
          expires_at: data && data.expires_at ? data.expires_at : null,
        };
      }
      if(data && data.ok === false){
        return {
          ok: false,
          error: data.error || 'Invite failed',
          invite_url: data.invite_url || '',
          invite_id: data.invite_id || '',
          expires_at: data.expires_at || null,
        };
      }
      return {
        ok: true,
        invite_url: data && data.invite_url ? data.invite_url : '',
        invite_id: data && data.invite_id ? data.invite_id : '',
        expires_at: data && data.expires_at ? data.expires_at : null,
      };
	    }
	    function resetCompanyScopedState(){
	      state.items = [];
	      try{ applySelectedRowIds([]); }catch(e){}
	      try{ clearAllOrderLines(); }catch(e){}
      state._orderHistoryRows = [];
      state._orderHistoryById = new Map();
      state._orderHistoryLinesByPo = new Map();
      state._orderHistoryFilter = '';
      state._orderHistoryStatusFilter = [];
      state._orderHistoryTab = 'orders';
      state._orderHistoryExpanded = new Set();
      state._orderHistoryReceipts = [];
      state._orderHistoryReceiptsCount = 0;
      state._orderHistoryReceiptsFilter = '';
      state._orderHistoryReceiptsLoaded = false;
      state._draftEmailReceipts = [];
      state._draftEmailReceiptsCount = 0;
      state._draftEmailReceiptsLoaded = false;
      state._receiveDraftSelected = new Set();
      state._draftEmailReceiptsNotified = false;
	      const orderHistoryFilter = $('orderHistoryFilter');
	      if(orderHistoryFilter) orderHistoryFilter.value = '';
	      const orderHistoryReceiptFilter = $('orderHistoryReceiptFilter');
	      if(orderHistoryReceiptFilter) orderHistoryReceiptFilter.value = '';
	      state._trashItems = [];
	      state._trashFilter = '';
	      const trashFilter = $('trashFilter');
	      if(trashFilter) trashFilter.value = '';
      state._auditRows = [];
      state._auditTableFilter = '';
      state._auditActionFilter = '';
      state._auditSearch = '';
      const auditSearch = $('auditSearchFilter');
      if(auditSearch) auditSearch.value = '';
      state._shippingAddresses = [];
      state._shippingAddressById = new Map();
      state._shippingAddressEditing = null;
      state._orderShippingOptions = [];
      state._orderShippingById = new Map();
      state._companyLocations = [];
      state._companyLocationById = new Map();
      state._companyLocationEditing = null;
      state._companyLocationsContext = null;
      state._locationsCompanies = [];
      state._locationsCompanySearch = '';
      state._locationsLocationCounts = {};
      state._receiveOrder = null;
      state._userMgmtRows = [];
      state._pendingInvites = [];
      state._pendingInviteBusy = {};
      state._snapshots = [];
      state._snapshotPreview = null;
      state._metrics = null;
      state._roleConfigs = {};
      state._roleChanges = {};
      _inviteCompanyId = '';
      _userMgmtCompanyId = '';
      updateOrderCounterBadge();
      const cachedCounts = getCachedMenuActionCounts(SB.companyId ? String(SB.companyId) : '');
      if(cachedCounts){
        applyMenuActionCounts(cachedCounts);
      }else{
        applyMenuActionCounts(createEmptyMenuActionCounts());
      }
      renderReceiptsInboxIndicator();
    }
	    async function sbSwitchCompany(nextCompanyId, opts = {}){
	      if(!SB.ready || !SB.session) return false;
      const options = (opts && typeof opts === 'object') ? opts : {};
      const persist = options.persist !== false;
      const audit = options.audit === true;
      const source = options.source ? String(options.source) : null;
      const rowOverride = options.companyRow && typeof options.companyRow === 'object' ? options.companyRow : null;
	      const nextId = String(nextCompanyId || '').trim();
	      if(!nextId || nextId === SB.companyId) return false;
	      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      let target = rowOverride ? { ...rowOverride } : (rows.find(r => String(r.company_id) === nextId) || null);
	      if(!target){
	        toast('Company not found');
	        renderCompanySwitcher();
	        return false;
	      }
      if(rowOverride && !isEffectiveSuperUser()){
        toast('Super user access required', 'error');
        return false;
      }
      const prev = {
        companyId: SB.companyId,
        company: SB.company,
        permissions: SB.permissions,
        authorized: SB.authorized,
        connected: SB.connected,
        companyType: normalizeCompanyType(SB.company && SB.company.company_type),
      };
      target.company_type = normalizeCompanyType(target.company_type);
      SB.companyId = nextId;
      SB.company = target;
      SB.companyTier = SB.company ? getCompanyTier() : null;
      state._tierDetails = null;
      state._tierDetailsCompanyId = null;
      if(persist) saveCompanyId(nextId);
      SB.permissions = null;
      SB.authorized = false;
      SB.connected = false;
      updateStatusBar();
      renderCompanySwitcher();
      renderTierAdminSection();
	      applyPermissionUI();
	      resetCompanyScopedState();
	      render();
	      if(_sbChannel && SB.client){ try{ SB.client.removeChannel(_sbChannel); }catch(e){} _sbChannel = null; }
	      try{
	        await sbLoadPermissions();
	      }catch(e){
	        console.warn('Permissions load failed:', e);
	        SB.companyId = prev.companyId;
	        SB.company = prev.company;
	        SB.permissions = prev.permissions;
	        SB.authorized = prev.authorized;
	        SB.connected = prev.connected;
	        updateStatusBar();
	        renderCompanySwitcher();
	        applyPermissionUI();
	        render();
	        toast('Company switch failed');
	        return false;
	      }
      resetImpersonationState('company_switch');
	      SB.authorized = !!(SB.permissions && hasPermission(PERMISSIONS.ITEMS_VIEW));
	      updateStatusBar();
      renderProfileUi();
      applyPermissionUI();
      if(audit && SB.client){
        try{
          await SB.client.rpc('log_company_switch', {
            p_company_id: nextId,
            p_from_company_id: prev.companyId ? String(prev.companyId) : null,
            p_from_company_type: prev.companyType || null,
            p_to_company_type: target.company_type || null,
            p_source: source || null
          });
        }catch(e){
          console.warn('Company switch audit failed:', e);
        }
      }
      if(isOnboardingRoute()){
        await handleOnboardingRoute();
      }
      if(!SB.authorized) return true;
      if(canAccessReceivingInbox()){
        void loadDraftEmailReceipts();
      }
      void refreshMenuJobsBadge();
      await checkServerHealth();
      if(isOnline()){
        await sbLoadSnapshot();
        sbStartRealtime();
      }
	      return true;
	    }
	    async function sbEnsureProfile(){
	      if(!SB.ready || !SB.user) return null;
	      try{
	        const { data, error } = await SB.client
	          .from('profiles')
	          .select('*')
	          .eq('user_id', SB.user.id)
	          .maybeSingle();
	        if(error) throw error;
	        if(data){
	          data.first_name = data.first_name || '';
	          data.last_name = data.last_name || '';
	          data.phone = data.phone || '';
	          if(typeof data.silence_low_stock_alerts === 'undefined'){
	            data.silence_low_stock_alerts = lowStockAlertsSilenced();
	          }else{
	            data.silence_low_stock_alerts = !!data.silence_low_stock_alerts;
	          }
          try{ localStorage.setItem('inv.pref.silenceLowStockAlerts', data.silence_low_stock_alerts ? '1' : '0'); }catch(e){}
          SB.profile = data;
          return data;
        }

        const desiredSilence = lowStockAlertsSilenced();
        const base = {
          user_id: SB.user.id,
          email: String(SB.user.email||'').trim(),
          first_name: '',
          last_name: '',
          phone: '',
        };
        const attempts = [
          { silence:true },
          { silence:false },
        ];
        let lastError = null;
        for(const a of attempts){
          const row = { ...base };
          if(a.silence) row.silence_low_stock_alerts = desiredSilence;
          const res = await SB.client.from('profiles').insert([row]);
          if(!res.error){
            SB.profile = { ...row };
            SB.profile.silence_low_stock_alerts = desiredSilence;
            return SB.profile;
        }
        lastError = res.error;
        const msg = errToText(res.error);
        if(!msg.includes('silence_low_stock_alerts')){
          break;
        }
        }
        if(lastError) throw lastError;
        throw Error('Profile create failed');
	      }catch(e){
	        console.warn('Profile ensure failed:', e);
	        SB.profile = {
	          user_id: SB.user.id,
	          email: String(SB.user.email||'').trim(),
	          first_name: '',
          last_name: '',
          phone: '',
          silence_low_stock_alerts: lowStockAlertsSilenced(),
        };
        return SB.profile;
      }
    }
    async function sbSaveProfile(firstName, lastName, phone, silenceLowStockAlerts){
      if(!SB.ready || !SB.user) throw Error('Not signed in');
      const desiredSilence = !!silenceLowStockAlerts;
      try{ localStorage.setItem('inv.pref.silenceLowStockAlerts', desiredSilence ? '1' : '0'); }catch(e){}

      const base = {
        user_id: SB.user.id,
        email: String(SB.user.email||'').trim(),
        first_name: String(firstName||'').trim(),
        last_name: String(lastName||'').trim(),
        phone: String(phone||'').trim(),
      };

      const attempts = [
        { silence:true },
        { silence:false },
      ];
      let lastError = null;
      for(const a of attempts){
        const row = { ...base };
        if(a.silence) row.silence_low_stock_alerts = desiredSilence;
        const res = await SB.client.from('profiles').upsert([row], { onConflict: 'user_id' });
        if(!res.error){
          SB.profile = { ...row };
          SB.profile.silence_low_stock_alerts = desiredSilence;
          return SB.profile;
        }
        lastError = res.error;
        const msg = String(res.error && res.error.message ? res.error.message : '');
        if(!msg.includes('silence_low_stock_alerts')){
          break;
        }
      }
      if(lastError) throw lastError;
      throw Error('Save failed');
    }
    async function sbRefreshAccess(){
      SB.authorized = false;
      SB.permissions = null;
      SB.companies = [];
      SB.companyId = null;
      SB.company = null;
      SB.companyTier = null;
      state._tierDetails = null;
      state._tierDetailsCompanyId = null;
      if(!SB.ready || !SB.user){ updateStatusBar(); return false; }
      try{
        await sbLoadCompanies();
      }catch(e){
        console.warn('Company load failed:', e);
        updateStatusBar();
        renderCompanySwitcher();
        renderAdvancedCompanySwitcherButton();
        renderProvisioningDashboardButton();
        renderDiagnosticsButton();
        renderSubscriptionManagerButton();
        renderCompanyLocationsButton();
        renderInviteUi();
        renderRoleManagerButton();
        renderUserMgmtButton();
        renderPendingInvitesSection();
        return false;
      }
      if(!SB.companyId){
        updateStatusBar();
        renderCompanySwitcher();
        renderAdvancedCompanySwitcherButton();
        renderProvisioningDashboardButton();
        renderDiagnosticsButton();
        renderSubscriptionManagerButton();
        renderCompanyLocationsButton();
        renderInviteUi();
        renderRoleManagerButton();
        renderUserMgmtButton();
        return false;
      }
      try{
        await sbLoadPermissions();
      }catch(e){
        console.warn('Permissions load failed:', e);
        updateStatusBar();
        renderCompanySwitcher();
        renderAdvancedCompanySwitcherButton();
        renderProvisioningDashboardButton();
        renderDiagnosticsButton();
        renderSubscriptionManagerButton();
        renderCompanyLocationsButton();
        renderInviteUi();
        renderRoleManagerButton();
        renderUserMgmtButton();
        return false;
      }
      SB.authorized = !!(SB.permissions && hasPermission(PERMISSIONS.ITEMS_VIEW));
      updateStatusBar();
      renderCompanySwitcher();
      renderAdvancedCompanySwitcherButton();
      renderProvisioningDashboardButton();
      renderDiagnosticsButton();
      renderSubscriptionManagerButton();
      renderCompanyLocationsButton();
      renderInviteUi();
      renderRoleManagerButton();
      renderUserMgmtButton();
      renderPendingInvitesSection();
      return SB.authorized;
    }
    async function sbHandleSession(session){
      SB.session = session || null;
      SB.user = session && session.user ? session.user : null;
      SB.connected = false;
      SB.authorized = false;
      SB.profile = null;
      SB.permissions = null;
      SB.companies = [];
      SB.companyId = null;
      SB.company = null;
      SB.companyTier = null;
      if(!session){
        state._diagRole = '';
        state._diagTier = '';
        state._diagPermissions = null;
      }
      updateStatusBar();
      applyPermissionUI();

      if(!SB.session){
        const inviteToken = storeInviteTokenFromUrl() || getPendingInviteToken();
        state.items = [];
        state._userMgmtRows = [];
        state._pendingInvites = [];
        state._pendingInviteBusy = {};
        state._snapshots = [];
        state._snapshotPreview = null;
        state._metrics = null;
        state._provisioningUsers = [];
        state._provisioningCompanies = [];
        state._provisioningExistingUsers = [];
        state._provisioningExistingUsersLoading = false;
        state._provisioningExistingUsersError = '';
        state._provisioningBusy = false;
        state._provisioningResult = null;
        state._roleConfigs = {};
        state._roleChanges = {};
        state._impersonationRole = 'super_user';
        state._impersonationPermissions = null;
        _inviteCompanyId = '';
        _userMgmtCompanyId = '';
        if(_sbChannel && SB.client){ try{ SB.client.removeChannel(_sbChannel); }catch{} _sbChannel=null; }
        render();
        if(inviteToken){
          show('authModal', false);
          openInviteAcceptModal();
        }else if(!isOnboardingRoute()){
          // Only show auth modal if NOT on onboarding route
          // Onboarding route handles its own signup flow
          show('authModal', true);
        }
        applyPermissionUI();
        renderCompanySwitcher();
        renderProvisioningDashboardButton();
        renderSubscriptionManagerButton();
        renderInviteUi();
        renderRoleManagerButton();
        renderUserMgmtButton();
        await handleOnboardingRoute();
        return;
      }

      show('authModal', false);
      setAuthMessage('');

      await sbEnsureProfile();
      await sbCheckPendingInvite();
      await sbRefreshAccess();
      renderProfileUi();
      applyPermissionUI();
      await handleOnboardingRoute();

      if(!SB.authorized){
        state.items = [];
        render();
        updateStatusBar();
        return;
      }

      if(canAccessReceivingInbox()){
        void loadDraftEmailReceipts();
      }
      void refreshMenuJobsBadge();
      await checkServerHealth();
      if(isOnline()){
        await sbLoadSnapshot();
        sbStartRealtime();
      }
    }
    async function sbAuthBoot(){
      if(!SB.ready || !SB.client) return;

      renderAuthUi();

      // Profile dropdown handlers
      const profileBtn = $('profileBtn');
      const profileDropdown = $('profileDropdown');
      const profileBackdrop = $('profileBackdrop');
      const profileSignIn = $('profileSignIn');
      function toggleProfileDropdown(open){
        if(profileDropdown){
          profileDropdown.style.display = '';
          profileDropdown.classList.toggle('open', open);
          profileDropdown.setAttribute('aria-hidden', open ? 'false' : 'true');
          if(profileBtn) profileBtn.setAttribute('aria-expanded', open);
          // Toggle backdrop for consistent blur/darken effect
          if(profileBackdrop){
            profileBackdrop.classList.toggle('open', open);
            profileBackdrop.setAttribute('aria-hidden', open ? 'false' : 'true');
          }
          if(open){
            initProfileTabs();
            restoreProfileTab();
          }
        }
      }

      if(profileBtn && !profileBtn._wired){
        profileBtn._wired = true;
        profileBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          toggleProfileDropdown(!profileDropdown.classList.contains('open'));
        });
      }

      if(profileSignIn && !profileSignIn._wired){
        profileSignIn._wired = true;
        profileSignIn.addEventListener('click', ()=>{
          toggleProfileDropdown(false);
          if(!SB.session) {
            show('authModal', true);
          } else {
            // Sign out
            sbSignOut();
          }
        });
      }

      // Close profile dropdown when clicking backdrop or outside
      if(profileBackdrop){
        profileBackdrop.addEventListener('click', ()=> toggleProfileDropdown(false));
      }
      document.addEventListener('click', (e)=>{
        if(profileDropdown && profileDropdown.classList.contains('open')){
          if(!e.target.closest('.profile-menu')){
            toggleProfileDropdown(false);
          }
        }
      });

      try{
        const { data } = await SB.client.auth.getSession();
        await sbHandleSession(data && data.session ? data.session : null);
      }catch(e){
        console.warn('Auth boot failed:', e);
        await sbHandleSession(null);
      }

      SB.client.auth.onAuthStateChange((event, session)=>{
        if(event === 'PASSWORD_RECOVERY'){
          show('authModal', false);
          show('resetModal', true);
          setResetMessage('');
        }
        void sbHandleSession(session);
      });
    }
    async function sbSignIn(email, password){
      if(!SB.ready) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      const p = String(password||'');
      if(!e) throw Error('Email required');
      if(!p) throw Error('Password required');
      const { error } = await SB.client.auth.signInWithPassword({ email: e, password: p });
      if(error) throw error;
    }
    async function sbSignOut(){
      if(!SB.ready || !SB.client) return;
      await SB.client.auth.signOut();
    }

    // ---------- Auth/Profile modal events ----------
    const btnAuthSubmit = $('btnAuthSubmit');
    if(btnAuthSubmit) btnAuthSubmit.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      const password = $('authPassword')?.value || '';
      setAuthMessage('');
      btnAuthSubmit.disabled = true;
      try{
        await sbSignIn(email, password);
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Authentication failed');
      }finally{
        btnAuthSubmit.disabled = false;
      }
    });

    const btnAuthForgot = $('btnAuthForgot');
    if(btnAuthForgot) btnAuthForgot.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      setAuthMessage('');
      btnAuthForgot.disabled = true;
      btnAuthForgot.setAttribute('aria-disabled', 'true');
      try{
        await sbSendPasswordReset(email);
        setAuthMessage('Password reset email sent.');
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Reset failed');
      }finally{
        btnAuthForgot.disabled = false;
        btnAuthForgot.setAttribute('aria-disabled', 'false');
      }
    });

    const authPassword = $('authPassword');
    if(authPassword) authPassword.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); $('btnAuthSubmit')?.click(); }
    });

    const btnInviteAcceptSubmit = $('btnInviteAcceptSubmit');
    if(btnInviteAcceptSubmit) btnInviteAcceptSubmit.addEventListener('click', async ()=>{
      const password = $('inviteAcceptPassword')?.value || '';
      const confirm = $('inviteAcceptPasswordConfirm')?.value || '';
      setInviteAcceptMessage('');
      btnInviteAcceptSubmit.disabled = true;
      btnInviteAcceptSubmit.setAttribute('aria-disabled', 'true');
      try{
        const result = await sbCompleteInvite(password, confirm);
        if(result && result.ok){
          const email = String(result.email || '').trim();
          if(!email) throw new Error('Invite email missing');
          try{ localStorage.removeItem('inv.pendingInvite'); }catch(e){}
          setInviteAcceptMessage('Account created. Signing you in...');
          await sbSignIn(email, password);
          closeInviteAcceptModal();
        }else{
          const code = result && result.code ? String(result.code) : '';
          const email = result && result.email ? String(result.email) : '';
          if(code === 'ExistingUser'){
            if(email) $('authEmail') && ($('authEmail').value = email);
            closeInviteAcceptModal();
            show('authModal', true);
            setAuthMessage('Account already exists. Please sign in.');
          }else{
            const msg = result && result.error ? String(result.error) : 'Invite setup failed';
            setInviteAcceptMessage(msg);
          }
        }
      }catch(e){
        setInviteAcceptMessage(e && e.message ? e.message : 'Invite setup failed');
      }finally{
        btnInviteAcceptSubmit.disabled = false;
        btnInviteAcceptSubmit.setAttribute('aria-disabled', 'false');
      }
    });

    const inviteAcceptConfirm = $('inviteAcceptPasswordConfirm');
    if(inviteAcceptConfirm) inviteAcceptConfirm.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); $('btnInviteAcceptSubmit')?.click(); }
    });

    const btnInviteAcceptClose = $('btnInviteAcceptClose');
    if(btnInviteAcceptClose) btnInviteAcceptClose.addEventListener('click', ()=>{
      closeInviteAcceptModal();
      show('authModal', true);
    });

    const btnInviteAcceptSignIn = $('btnInviteAcceptSignIn');
    if(btnInviteAcceptSignIn) btnInviteAcceptSignIn.addEventListener('click', ()=>{
      closeInviteAcceptModal();
      show('authModal', true);
    });

    const btnResetSubmit = $('btnResetSubmit');
    if(btnResetSubmit) btnResetSubmit.addEventListener('click', async ()=>{
      const pw = $('resetPassword')?.value || '';
      const confirm = $('resetPasswordConfirm')?.value || '';
      setResetMessage('');
      if(!pw || !confirm){ setResetMessage('Enter and confirm your new password'); return; }
      if(pw !== confirm){ setResetMessage('Passwords do not match'); return; }
      btnResetSubmit.disabled = true;
      btnResetSubmit.setAttribute('aria-disabled', 'true');
      try{
        await sbUpdatePassword(pw);
        setResetMessage('Password updated. You can close this window.');
        toast('Password updated', 'success');
      }catch(e){
        setResetMessage(e && e.message ? e.message : 'Update failed');
      }finally{
        btnResetSubmit.disabled = false;
        btnResetSubmit.setAttribute('aria-disabled', 'false');
      }
    });

    const btnResetClose = $('btnResetClose');
    if(btnResetClose) btnResetClose.addEventListener('click', ()=> show('resetModal', false));

    const btnTierBaseSave = $('btnTierBaseSave');
    if(btnTierBaseSave) btnTierBaseSave.addEventListener('click', async ()=>{
      const selected = String($('tierBaseSelect')?.value || '').trim();
      setTierOverrideMessage('');
      if(!SB.session || !isEffectiveSuperUser()){
        setTierOverrideMessage('Super user access required.');
        return;
      }
      if(!SB.companyId){
        setTierOverrideMessage('Select a company first.');
        return;
      }
      if(!selected){
        setTierOverrideMessage('Select a base tier.');
        return;
      }
      btnTierBaseSave.disabled = true;
      btnTierBaseSave.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('set_company_base_tier', {
          p_company_id: SB.companyId,
          p_new_base_tier: selected
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Base tier update failed');
        }
        await sbRefreshAccess();
        await refreshTierAdminDetails();
        setTierOverrideMessage('Base tier updated.');
        toast('Base tier updated', 'success');
      }catch(e){
        setTierOverrideMessage(e && e.message ? e.message : 'Base tier update failed');
      }finally{
        btnTierBaseSave.disabled = false;
        btnTierBaseSave.setAttribute('aria-disabled', 'false');
      }
    });

    const btnTierOverrideGrant = $('btnTierOverrideGrant');
    if(btnTierOverrideGrant) btnTierOverrideGrant.addEventListener('click', async ()=>{
      const selected = String($('tierOverrideTierSelect')?.value || '').trim();
      const endsAtRaw = String($('tierOverrideEndsAt')?.value || '').trim();
      const endsAt = endsAtRaw ? new Date(endsAtRaw).toISOString() : null;
      setTierOverrideMessage('');
      if(!SB.session || !isEffectiveSuperUser()){
        setTierOverrideMessage('Super user access required.');
        return;
      }
      if(!SB.companyId){
        setTierOverrideMessage('Select a company first.');
        return;
      }
      if(!selected){
        setTierOverrideMessage('Select an override tier.');
        return;
      }
      btnTierOverrideGrant.disabled = true;
      btnTierOverrideGrant.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('grant_company_tier_override', {
          p_company_id: SB.companyId,
          p_override_tier: selected,
          p_ends_at: endsAt
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Override failed');
        }
        await sbRefreshAccess();
        await refreshTierAdminDetails();
        setTierOverrideMessage('Override granted.');
        toast('Override granted');
        const endsInput = $('tierOverrideEndsAt');
        if(endsInput) endsInput.value = '';
      }catch(e){
        setTierOverrideMessage(e && e.message ? e.message : 'Override failed');
      }finally{
        btnTierOverrideGrant.disabled = false;
        btnTierOverrideGrant.setAttribute('aria-disabled', 'false');
      }
    });

    const btnTierOverrideRevoke = $('btnTierOverrideRevoke');
    if(btnTierOverrideRevoke) btnTierOverrideRevoke.addEventListener('click', async ()=>{
      setTierOverrideMessage('');
      if(!SB.session || !isEffectiveSuperUser()){
        setTierOverrideMessage('Super user access required.');
        return;
      }
      if(!SB.companyId){
        setTierOverrideMessage('Select a company first.');
        return;
      }
      btnTierOverrideRevoke.disabled = true;
      btnTierOverrideRevoke.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('revoke_company_tier_override', {
          p_company_id: SB.companyId
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Override revoke failed');
        }
        await sbRefreshAccess();
        await refreshTierAdminDetails();
        setTierOverrideMessage('Override revoked.');
        toast('Override revoked');
      }catch(e){
        setTierOverrideMessage(e && e.message ? e.message : 'Override revoke failed');
      }finally{
        btnTierOverrideRevoke.disabled = false;
        btnTierOverrideRevoke.setAttribute('aria-disabled', 'false');
      }
    });

    const advancedCompanyClose = $('advancedCompanyClose');
    if(advancedCompanyClose) advancedCompanyClose.addEventListener('click', ()=>{
      show('advancedCompanyModal', false);
    });
    const advancedCompanySearch = $('advancedCompanySearch');
    if(advancedCompanySearch){
      advancedCompanySearch.addEventListener('input', ()=>{
        debouncedAdvancedSearch();
      });
      advancedCompanySearch.addEventListener('keydown', async (e)=>{
        if(e.key !== 'Enter') return;
        e.preventDefault();
        if(state._advancedSearchDebounce){
          clearTimeout(state._advancedSearchDebounce);
          state._advancedSearchDebounce = null;
        }
        await loadAdvancedCompanies();
      });
    }
    const advancedCompanyTypeFilter = $('advancedCompanyTypeFilter');
    if(advancedCompanyTypeFilter) advancedCompanyTypeFilter.addEventListener('change', async ()=>{
      await loadAdvancedCompanies();
    });
    const manageCompaniesMenuBtn = $('manageCompaniesMenuBtn');
    if(manageCompaniesMenuBtn) manageCompaniesMenuBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      toggleManageCompaniesMenu();
    });
    const btnCreateNewCompany = $('btnCreateNewCompany');
    if(btnCreateNewCompany) btnCreateNewCompany.addEventListener('click', ()=>{
      closeManageCompaniesMenu();
      show('advancedCompanyModal', false);
      void openProvisioningModal();
    });
    const btnExportCompanies = $('btnExportCompanies');
    if(btnExportCompanies) btnExportCompanies.addEventListener('click', ()=>{
      exportCompaniesToCSV();
    });
    const btnRefreshCompanies = $('btnRefreshCompanies');
    if(btnRefreshCompanies) btnRefreshCompanies.addEventListener('click', async ()=>{
      closeManageCompaniesMenu();
      await loadAdvancedCompanies();
      toast('List refreshed');
    });
    const btnRenameCompanyConfirm = $('btnRenameCompanyConfirm');
    if(btnRenameCompanyConfirm) btnRenameCompanyConfirm.addEventListener('click', ()=>{
      void confirmRenameCompany();
    });
    const renameCompanyName = $('renameCompanyName');
    if(renameCompanyName) renameCompanyName.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        void confirmRenameCompany();
      }
    });

    // Manage Users sub-modal handlers
    const btnDeleteSelectedUsers = $('btnDeleteSelectedUsers');
    if(btnDeleteSelectedUsers) btnDeleteSelectedUsers.addEventListener('click', ()=>{
      void deleteSelectedUsers();
    });
    const manageUsersSelectAll = $('manageUsersSelectAll');
    if(manageUsersSelectAll) manageUsersSelectAll.addEventListener('change', ()=>{
      const users = state._manageUsersData || [];
      if(manageUsersSelectAll.checked){
        users.forEach(u => state._manageUsersSelected.add(String(u.user_id || '')));
      }else{
        state._manageUsersSelected.clear();
      }
      renderManageUsersTable();
    });
    const manageUsersResults = $('manageCompanyUsersResults');
    if(manageUsersResults) manageUsersResults.addEventListener('change', (e)=>{
      const cb = e.target.closest('[data-manage-user-check]');
      if(!cb) return;
      const id = String(cb.getAttribute('data-manage-user-check') || '').trim();
      if(!id) return;
      if(cb.checked){
        state._manageUsersSelected.add(id);
      }else{
        state._manageUsersSelected.delete(id);
      }
      const row = manageUsersResults.querySelector(`[data-user-row="${id}"]`);
      if(row) row.classList.toggle('is-selected', cb.checked);
      updateManageUsersSelectAll();
      updateManageUsersDeleteBtn();
    });

    // Manage Inventory sub-modal handlers
    const btnDeleteSelectedInventory = $('btnDeleteSelectedInventory');
    if(btnDeleteSelectedInventory) btnDeleteSelectedInventory.addEventListener('click', ()=>{
      void deleteSelectedInventory();
    });
    const manageInventorySelectAll = $('manageInventorySelectAll');
    if(manageInventorySelectAll) manageInventorySelectAll.addEventListener('change', ()=>{
      const items = getFilteredManageInventory();
      if(manageInventorySelectAll.checked){
        items.forEach(i => state._manageInventorySelected.add(String(i.id || '')));
      }else{
        const filteredIds = items.map(i => String(i.id || ''));
        filteredIds.forEach(id => state._manageInventorySelected.delete(id));
      }
      renderManageInventoryTable();
    });
    const manageInventorySearch = $('manageInventorySearch');
    if(manageInventorySearch) manageInventorySearch.addEventListener('input', ()=>{
      state._manageInventorySearch = manageInventorySearch.value;
      renderManageInventoryTable();
    });
    const manageInventoryResults = $('manageCompanyInventoryResults');
    if(manageInventoryResults) manageInventoryResults.addEventListener('change', (e)=>{
      const cb = e.target.closest('[data-manage-inv-check]');
      if(!cb) return;
      const id = String(cb.getAttribute('data-manage-inv-check') || '').trim();
      if(!id) return;
      if(cb.checked){
        state._manageInventorySelected.add(id);
      }else{
        state._manageInventorySelected.delete(id);
      }
      const row = manageInventoryResults.querySelector(`[data-inv-row="${id}"]`);
      if(row) row.classList.toggle('is-selected', cb.checked);
      updateManageInventorySelectAll();
      updateManageInventoryDeleteBtn();
    });

    if(!document._manageCompaniesMenuWired){
      document._manageCompaniesMenuWired = true;
      document.addEventListener('click', (e)=>{
        const menu = $('manageCompaniesMenu');
        if(!menu || !menu.classList.contains('is-open')) return;
        if(e.target && e.target.closest && e.target.closest('#manageCompaniesMenu')) return;
        closeManageCompaniesMenu();
      });
    }
    if(!document._companyOverflowWired){
      document._companyOverflowWired = true;
      document.addEventListener('click', (e)=>{
        if(!state._companyOverflowOpenId) return;
        if(e.target && e.target.closest && e.target.closest('.company-overflow')) return;
        closeCompanyOverflowMenus();
      });
      document.addEventListener('keydown', (e)=>{
        if(!state._companyOverflowOpenId) return;
        if(e.key === 'Escape'){
          e.preventDefault();
          closeCompanyOverflowMenus();
          return;
        }
        if(e.key !== 'Tab') return;
        const wrapper = document.querySelector(`.company-overflow[data-company-menu="${state._companyOverflowOpenId}"]`);
        if(!wrapper) return;
        const items = Array.from(wrapper.querySelectorAll('.company-overflow-item'));
        if(!items.length) return;
        const first = items[0];
        const last = items[items.length - 1];
        if(e.shiftKey && document.activeElement === first){
          e.preventDefault();
          last.focus();
        }else if(!e.shiftKey && document.activeElement === last){
          e.preventDefault();
          first.focus();
        }
      });
    }
    const btnSeedInventoryCancel = $('btnSeedInventoryCancel');
    if(btnSeedInventoryCancel) btnSeedInventoryCancel.addEventListener('click', ()=>{
      show('seedInventoryModal', false);
    });
    const btnSeedInventoryConfirm = $('btnSeedInventoryConfirm');
    if(btnSeedInventoryConfirm) btnSeedInventoryConfirm.addEventListener('click', confirmSeedInventory);
    const seedInventorySource = $('seedInventorySource');
    if(seedInventorySource) seedInventorySource.addEventListener('change', ()=>{
      if(!state._seedInventory) return;
      state._seedInventory.sourceId = String(seedInventorySource.value || '').trim();
      renderSeedInventoryModal();
    });
    const seedInventoryDedupe = $('seedInventoryDedupe');
    if(seedInventoryDedupe) seedInventoryDedupe.addEventListener('change', ()=>{
      if(!state._seedInventory) return;
      state._seedInventory.dedupeKey = String(seedInventoryDedupe.value || 'sku').trim() || 'sku';
      renderSeedInventoryModal();
    });
    const seedInventorySelectAll = $('seedInventorySelectAll');
    if(seedInventorySelectAll) seedInventorySelectAll.addEventListener('click', ()=>{
      if(!state._seedInventory || state._seedInventoryBusy) return;
      const selectable = getSeedInventorySelectableFields(!!state._seedInventory.itemsSeeded);
      const selected = new Set(getSeedInventorySelectedFields());
      const allSelected = selectable.length > 0 && selectable.every(key => selected.has(key));
      setSeedInventoryFields(allSelected ? [] : selectable);
      renderSeedInventoryModal();
    });
    const seedInventoryFields = $('seedInventoryFields');
    if(seedInventoryFields && !seedInventoryFields._wired){
      seedInventoryFields._wired = true;
      seedInventoryFields.addEventListener('change', (e)=>{
        if(!state._seedInventory || state._seedInventoryBusy) return;
        const input = e.target && e.target.closest ? e.target.closest('input[data-seed-field]') : null;
        if(!input) return;
        const key = String(input.getAttribute('data-seed-field') || '').trim();
        if(!key) return;
        const next = new Set(getSeedInventorySelectedFields());
        if(input.checked){
          next.add(key);
        }else{
          next.delete(key);
        }
        setSeedInventoryFields(Array.from(next));
        renderSeedInventoryModal();
      });
    }
    const btnCompanyEnvironmentCancel = $('btnCompanyEnvironmentCancel');
    if(btnCompanyEnvironmentCancel) btnCompanyEnvironmentCancel.addEventListener('click', ()=>{
      show('companyEnvironmentModal', false);
    });
    const btnCompanyEnvironmentConfirm = $('btnCompanyEnvironmentConfirm');
    if(btnCompanyEnvironmentConfirm) btnCompanyEnvironmentConfirm.addEventListener('click', confirmCompanyEnvironment);
    const companyEnvironmentSelect = $('companyEnvironmentSelect');
    if(companyEnvironmentSelect) companyEnvironmentSelect.addEventListener('change', ()=>{
      if(!state._companyEnvironment) return;
      state._companyEnvironment.nextType = normalizeCompanyType(companyEnvironmentSelect.value);
      renderCompanyEnvironmentModal();
    });

    const btnProvisioningClose = $('btnProvisioningClose');
    if(btnProvisioningClose) btnProvisioningClose.addEventListener('click', closeProvisioningModal);
    const btnProvisioningRun = $('btnProvisioningRun');
    if(btnProvisioningRun) btnProvisioningRun.addEventListener('click', async ()=>{
      await runProvisioning();
    });
    const btnProvisioningReset = $('btnProvisioningReset');
    if(btnProvisioningReset) btnProvisioningReset.addEventListener('click', resetProvisioningForm);
    const btnProvisioningAddUser = $('btnProvisioningAddUser');
    if(btnProvisioningAddUser) btnProvisioningAddUser.addEventListener('click', ()=>{
      state._provisioningUsers = Array.isArray(state._provisioningUsers) ? state._provisioningUsers : [];
      state._provisioningUsers.push({ id: randomUUID(), user_id: '', role: 'member' });
      renderProvisioningUsersList();
    });
    const btnProvisioningRefreshCompanies = $('btnProvisioningRefreshCompanies');
    if(btnProvisioningRefreshCompanies) btnProvisioningRefreshCompanies.addEventListener('click', async ()=>{
      await loadProvisioningCompanies();
    });
    const provisioningSeedToggle = $('provisioningSeedToggle');
    if(provisioningSeedToggle) provisioningSeedToggle.addEventListener('change', ()=>{
      if(provisioningSeedToggle.checked){
        const confirmed = window.confirm('Copy inventory from an existing company? This action is explicit and auditable.');
        if(!confirmed){
          provisioningSeedToggle.checked = false;
          renderProvisioningSeedFields();
          return;
        }
        void loadProvisioningCompanies();
      }
      renderProvisioningSeedFields();
    });
    const provisioningName = $('provisioningCompanyName');
    const provisioningSlug = $('provisioningCompanySlug');
    if(provisioningName) provisioningName.addEventListener('input', ()=>{
      if(!provisioningSlug) return;
      if(provisioningSlug.dataset.manual === 'true') return;
      provisioningSlug.value = slugifyCompanyName(provisioningName.value);
      provisioningSlug.dataset.manual = 'false';
    });
    if(provisioningSlug) provisioningSlug.addEventListener('input', ()=>{
      provisioningSlug.dataset.manual = 'true';
    });
    const provisioningEnvSelect = $('provisioningEnvironmentType');
    const provisioningEnvNote = $('provisioningEnvironmentNote');
    if(provisioningEnvSelect){
      const syncProvisioningEnvNote = () => {
        const envType = normalizeEnvironmentType(provisioningEnvSelect.value);
        if(provisioningEnvNote) provisioningEnvNote.style.display = envType !== 'production' ? '' : 'none';
      };
      provisioningEnvSelect.addEventListener('change', syncProvisioningEnvNote);
      syncProvisioningEnvNote();
    }
    const provisioningUsersList = $('provisioningUsersList');
    if(provisioningUsersList) provisioningUsersList.addEventListener('change', (e)=>{
      const target = e.target;
      if(!target) return;
      const field = target.getAttribute && target.getAttribute('data-provisioning-user-field');
      const id = target.getAttribute && target.getAttribute('data-provisioning-user-id');
      if(!field || !id) return;
      const rows = Array.isArray(state._provisioningUsers) ? state._provisioningUsers : [];
      const idx = rows.findIndex(r => String(r.id) === String(id));
      if(idx < 0) return;
      const value = target.value;
      rows[idx] = { ...rows[idx], [field]: value };
      state._provisioningUsers = rows;
    });
    if(provisioningUsersList) provisioningUsersList.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-provisioning-user-remove]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-provisioning-user-remove') || '').trim();
      if(!id) return;
      state._provisioningUsers = (Array.isArray(state._provisioningUsers) ? state._provisioningUsers : []).filter(r => String(r.id) !== id);
      renderProvisioningUsersList();
    });
    const provisioningSummary = $('provisioningSummary');
    if(provisioningSummary) provisioningSummary.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-provisioning-open-id]');
      if(!btn) return;
      const companyId = String(btn.getAttribute('data-provisioning-open-id') || '').trim();
      if(!companyId) return;
      const companyName = String(btn.getAttribute('data-provisioning-open-name') || '').trim();
      const companySlug = String(btn.getAttribute('data-provisioning-open-slug') || '').trim();
      const companyEnv = String(btn.getAttribute('data-provisioning-open-env') || '').trim();
      const companyRow = {
        company_id: companyId,
        company_name: companyName || null,
        company_slug: companySlug || null,
        company_type: 'production',
        environment_type: companyEnv ? normalizeEnvironmentType(companyEnv) : 'production',
      };
      const ok = await sbSwitchCompany(companyId, {
        persist: false,
        audit: true,
        source: 'provisioning',
        companyRow,
      });
      if(ok){
        toast(`Switched to ${companyName || 'company'}`);
        show('provisioningModal', false);
      }
    });

    const diagApply = $('diagApply');
    if(diagApply) diagApply.addEventListener('click', async ()=>{
      await applyDiagnosticsSimulation();
    });
    const diagReset = $('diagReset');
    if(diagReset) diagReset.addEventListener('click', ()=>{
      resetDiagnosticsSimulation();
    });
    const diagClose = $('diagClose');
    if(diagClose) diagClose.addEventListener('click', ()=>{
      show('diagnosticsModal', false);
    });
    const diagMetricRun = $('diagMetricRun');
    if(diagMetricRun) diagMetricRun.addEventListener('click', async ()=>{
      await runDiagnosticsMetricPreview();
    });
    const diagRoleSelect = $('diagRoleSelect');
    if(diagRoleSelect) diagRoleSelect.addEventListener('change', ()=>{
      setDiagnosticsMessage('Simulation changed. Apply to activate.');
    });
    const diagTierSelect = $('diagTierSelect');
    if(diagTierSelect) diagTierSelect.addEventListener('change', ()=>{
      setDiagnosticsMessage('Simulation changed. Apply to activate.');
      updateDiagnosticsMetricTierHint();
    });

    const btnProfileClose = $('btnProfileClose');
    if(btnProfileClose) btnProfileClose.addEventListener('click', ()=> {
      if(_profileAutoSaveTimer){ clearTimeout(_profileAutoSaveTimer); _profileAutoSaveTimer = null; }
      show('profileModal', false);
    });

    const btnInviteSend = $('btnInviteSend');
    if(btnInviteSend) btnInviteSend.addEventListener('click', async ()=>{
      if(!btnInviteSend) return;
      const email = $('inviteEmail')?.value || '';
      const role = $('inviteRole')?.value || 'member';
      const companyId = _inviteCompanyId || (SB.companyId ? String(SB.companyId) : '');
      setInviteMessage('');
      showInviteLink('');
      btnInviteSend.disabled = true;
      btnInviteSend.setAttribute('aria-disabled', 'true');
      try{
        const data = await sbInviteUser(email, role, companyId);
        const createdInvite = !!(data && (data.ok || data.invite_id || data.invite_url));
        if(data && data.ok){
          const expiry = data && data.expires_at ? formatEasternDateTime(data.expires_at) : '';
          const suffix = expiry ? ` Expires ${expiry}.` : '';
          if(data.invite_url) showInviteLink(data.invite_url);
          setInviteMessage(`Invite email sent to ${String(email || '').trim()}.${suffix}`);
          await refreshPendingInvites();
          if(createdInvite) await maybeAdvanceOnboardingAfterInvite();
        }else{
          const msg = data && data.error ? String(data.error) : 'Invite failed';
          if(data && data.invite_url) showInviteLink(data.invite_url);
          setInviteMessage(msg);
          if(data && (data.invite_id || data.invite_url)){
            await refreshPendingInvites();
            if(createdInvite) await maybeAdvanceOnboardingAfterInvite();
          }
        }
      }catch(e){
        setInviteMessage(e && e.message ? e.message : 'Invite failed');
      }finally{
        btnInviteSend.disabled = false;
        btnInviteSend.setAttribute('aria-disabled', 'false');
        renderInviteUi();
      }
    });

    const btnInviteCopy = $('btnInviteCopy');
    if(btnInviteCopy) btnInviteCopy.addEventListener('click', async ()=>{
      const url = $('inviteLink')?.value || '';
      if(!url){ toast('No invite link'); return; }
      try{
        await copyText(String(url));
        toast('Invite link copied', 'success');
      }catch(e){
        toast('Copy failed', 'error');
      }
    });

    const inviteEmail = $('inviteEmail');
    if(inviteEmail) inviteEmail.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        $('btnInviteSend')?.click();
      }
    });
    const inviteCompany = $('inviteCompany');
    if(inviteCompany && !inviteCompany._wired){
      inviteCompany._wired = true;
      inviteCompany.addEventListener('change', ()=>{
        _inviteCompanyId = inviteCompany.value || '';
        showInviteLink('');
        setInviteMessage('');
        renderInviteUi();
      });
    }

    const openProfileSettings = $('openProfileSettings');
    if(openProfileSettings) openProfileSettings.addEventListener('click', ()=>{
      closeProfileMenu();
      renderProfileUi();
      show('profileModal', true);
    });


    const openCompanySwitcher = $('openCompanySwitcher');
    if(openCompanySwitcher) openCompanySwitcher.addEventListener('click', ()=>{
      closeProfileMenu();
      void openCompanySwitcherModal();
    });

    const openCompanyLocations = $('openCompanyLocations');
    if(openCompanyLocations) openCompanyLocations.addEventListener('click', ()=>{
      closeProfileMenu();
      void openCompanyLocationsModal();
    });
    const openManageCompany = $('openManageCompany');
    if(openManageCompany) openManageCompany.addEventListener('click', ()=>{
      closeProfileMenu();
      openManageCompanyModal();
    });

    const openSubscriptionManager = $('openSubscriptionManager');
    if(openSubscriptionManager) openSubscriptionManager.addEventListener('click', ()=>{
      closeProfileMenu();
      openSubscriptionManagerModal();
    });
    const manageCompanyModal = $('manageCompanyModal');
    if(manageCompanyModal && !manageCompanyModal._wired){
      manageCompanyModal._wired = true;
      manageCompanyModal.addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-copy-receipt-address]');
        if(!btn) return;
        const address = getReceiptForwardingAddress();
        if(!address) return;
        try{
          await copyText(String(address));
          toast('Receipt address copied to clipboard', 'success');
        }catch(err){
          toast('Copy failed', 'error');
        }
      });
    }

    const openInviteModal = $('openInviteModal');
    if(openInviteModal) openInviteModal.addEventListener('click', ()=>{
      closeProfileMenu();
      if(!SB.session){
        show('authModal', true);
        return;
      }
      renderInviteUi();
      show('inviteModal', true);
    });

    const openUserMgmt = $('openUserMgmt');
    if(openUserMgmt) openUserMgmt.addEventListener('click', ()=>{
      closeProfileMenu();
      openUserMgmtModal();
    });

    const openRoleManager = $('openRoleManager');
    if(openRoleManager) openRoleManager.addEventListener('click', ()=>{
      closeProfileMenu();
      openRoleManagerModal();
    });

    const btnInviteClose = $('btnInviteClose');
    if(btnInviteClose) btnInviteClose.addEventListener('click', ()=>{
      show('inviteModal', false);
    });

    const btnRoleManagerClose = $('btnRoleManagerClose');
    if(btnRoleManagerClose) btnRoleManagerClose.addEventListener('click', closeRoleManagerModal);
    const btnRoleManagerSave = $('btnRoleManagerSave');
    if(btnRoleManagerSave) btnRoleManagerSave.addEventListener('click', saveRoleManagerChanges);
    const roleManagerBody = $('roleManagerBody');
    if(roleManagerBody) roleManagerBody.addEventListener('change', (e)=> handleRoleManagerToggle(e.target));

    const btnUserMgmtClose = $('btnUserMgmtClose');
    if(btnUserMgmtClose) btnUserMgmtClose.addEventListener('click', closeUserMgmtModal);
    const btnSubscriptionManagerClose = $('btnSubscriptionManagerClose');
    if(btnSubscriptionManagerClose) btnSubscriptionManagerClose.addEventListener('click', closeSubscriptionManagerModal);
    const btnUserMgmtRefresh = $('btnUserMgmtRefresh');
    if(btnUserMgmtRefresh) btnUserMgmtRefresh.addEventListener('click', refreshUserMgmtAll);
    const btnUserMgmtAdd = $('btnUserMgmtAdd');
    if(btnUserMgmtAdd) btnUserMgmtAdd.addEventListener('click', openInviteFromUserMgmt);
    const btnPendingInvitesRefresh = $('btnPendingInvitesRefresh');
    if(btnPendingInvitesRefresh) btnPendingInvitesRefresh.addEventListener('click', refreshPendingInvites);
    const userMgmtCompany = $('userMgmtCompany');
    if(userMgmtCompany && !userMgmtCompany._wired){
      userMgmtCompany._wired = true;
      userMgmtCompany.addEventListener('change', async (e)=>{
        _userMgmtCompanyId = e && e.target ? e.target.value : '';
        await refreshUserMgmtAll();
      });
    }
    const userMgmtList = $('userMgmtList');
    if(userMgmtList) userMgmtList.addEventListener('change', async (e)=>{
      const select = e.target.closest('[data-user-role-id]');
      if(!select) return;
      const userId = String(select.getAttribute('data-user-role-id') || '').trim();
      const currentRole = String(select.getAttribute('data-current-role') || '').trim();
      const nextRole = String(select.value || '').trim();
      if(!userId || !nextRole || nextRole === currentRole) return;
      const displayName = String(select.getAttribute('data-user-name') || 'user');
      const ok = await openConfirmModal(
        `Change role for ${displayName}?`,
        `This will set the role to ${nextRole}.`,
        { okText:'Update', cancelText:'Cancel' }
      );
      if(!ok){
        select.value = currentRole;
        return;
      }
      try{
        await sbUpdateMemberRole(userId, nextRole);
        toast('Role updated', 'success');
        await refreshUserMgmt();
      }catch(err){
        select.value = currentRole;
        toast(err && err.message ? err.message : 'Update failed');
      }
    });
    if(userMgmtList) userMgmtList.addEventListener('click', async (e)=>{
      const removeBtn = e.target.closest('[data-user-remove-id]');
      if(!removeBtn) return;
      if(removeBtn.disabled) return;
      const userId = String(removeBtn.getAttribute('data-user-remove-id') || '').trim();
      if(!userId) return;
      const displayName = String(removeBtn.getAttribute('data-user-name') || 'user');
      const ok = await openConfirmModal(
        `Remove ${displayName}?`,
        'This will revoke their access to the company.',
        { okText:'Remove', cancelText:'Cancel' }
      );
      if(!ok) return;
      try{
        await sbRemoveMember(userId);
        toast('User removed');
        await refreshUserMgmt();
      }catch(err){
        toast(err && err.message ? err.message : 'Remove failed');
      }
    });
    const pendingInvitesList = $('pendingInvitesList');
    if(pendingInvitesList) pendingInvitesList.addEventListener('click', async (e)=>{
      const resendBtn = e.target.closest('[data-invite-resend-id]');
      const revokeBtn = e.target.closest('[data-invite-revoke-id]');
      if(resendBtn){
        if(resendBtn.disabled) return;
        const inviteId = String(resendBtn.getAttribute('data-invite-resend-id') || '').trim();
        if(!inviteId) return;
        state._pendingInviteBusy = state._pendingInviteBusy || {};
        state._pendingInviteBusy[inviteId] = 'resend';
        renderPendingInvitesList();
        try{
          const data = await sbResendCompanyInvite(inviteId);
          const idx = (state._pendingInvites || []).findIndex(row => String(row.id) === inviteId);
          if(idx >= 0){
            const current = state._pendingInvites[idx];
            const nextResend = (data && typeof data.resend_count === 'number') ? data.resend_count : (toInt(current.resend_count, 0) + 1);
            const nextLastSent = data && data.last_sent_at ? data.last_sent_at : new Date().toISOString();
            state._pendingInvites[idx] = { ...current, resend_count: nextResend, last_sent_at: nextLastSent };
            renderPendingInvitesList();
          }
          toast('Invite resent', 'success');
        }catch(err){
          toast(err && err.message ? err.message : 'Resend failed');
        }finally{
          delete state._pendingInviteBusy[inviteId];
          await refreshPendingInvites();
        }
        return;
      }
      if(revokeBtn){
        if(revokeBtn.disabled) return;
        const inviteId = String(revokeBtn.getAttribute('data-invite-revoke-id') || '').trim();
        if(!inviteId) return;
        const email = String(revokeBtn.getAttribute('data-invite-email') || 'this invite');
        const ok = await openConfirmModal(
          `Revoke invite for ${email}?`,
          'This will delete the invite.',
          { okText:'Revoke', cancelText:'Cancel' }
        );
        if(!ok) return;
        state._pendingInviteBusy = state._pendingInviteBusy || {};
        state._pendingInviteBusy[inviteId] = 'revoke';
        const prev = Array.isArray(state._pendingInvites) ? state._pendingInvites.slice() : [];
        state._pendingInvites = prev.filter(row => String(row.id) !== inviteId);
        renderPendingInvitesList();
        try{
          await sbRevokeCompanyInvite(inviteId);
          toast('Invite revoked');
        }catch(err){
          state._pendingInvites = prev;
          renderPendingInvitesList();
          toast(err && err.message ? err.message : 'Revoke failed');
        }finally{
          delete state._pendingInviteBusy[inviteId];
          await refreshPendingInvites();
        }
      }
    });

    const profilePhoneInput = $('profilePhone');
    if(profilePhoneInput){
      profilePhoneInput.addEventListener('input', (e)=>{
        const cursorPos = e.target.selectionStart;
        const oldLen = e.target.value.length;
        e.target.value = formatPhoneNumber(e.target.value);
        const newLen = e.target.value.length;
        // Adjust cursor position after formatting
        const newPos = Math.max(0, cursorPos + (newLen - oldLen));
        e.target.setSelectionRange(newPos, newPos);
      });
    }

	    // Profile auto-save
    let _profileAutoSaveTimer = null;
    async function autoSaveProfile(){
      const modal = $('profileModal');
      if(!modal || modal.getAttribute('aria-hidden') === 'true') return;
      const firstName = $('profileFirstName')?.value || '';
      const lastName = $('profileLastName')?.value || '';
      const phone = $('profilePhone')?.value || '';
      const silenceLowStockAlerts = !!($('profileSilenceLowStockAlerts')?.checked);
      setProfileMessage('');
      try{
        await sbSaveProfile(firstName, lastName, phone, silenceLowStockAlerts);
        renderProfileUi();
        try{ renderTable(); }catch(e){}
        toast('Auto-saved', 'success');
      }catch(e){
        setProfileMessage(e && e.message ? e.message : 'Save failed');
      }
    }
    function scheduleProfileAutoSave(){
      if(_profileAutoSaveTimer) clearTimeout(_profileAutoSaveTimer);
      _profileAutoSaveTimer = setTimeout(()=> autoSaveProfile(), 600);
    }
    // Attach auto-save listeners to profile inputs
    ['profileFirstName','profileLastName','profilePhone'].forEach(id=>{
      const el = $(id);
      if(el){
        el.addEventListener('blur', scheduleProfileAutoSave);
        el.addEventListener('change', scheduleProfileAutoSave);
      }
    });
    const profileSilenceToggle = $('profileSilenceLowStockAlerts');
    if(profileSilenceToggle) profileSilenceToggle.addEventListener('change', ()=> autoSaveProfile());

    const btnSignOut = $('btnSignOut');
    if(btnSignOut) btnSignOut.addEventListener('click', async ()=>{
      try{
        await sbSignOut();
        show('profileModal', false);
        toast('Signed out');
      }catch(e){
        toast(e && e.message ? e.message : 'Sign out failed');
      }
    });
		    async function sbLoadSnapshot(){
		      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
		      let data = null;
		      const baseSel = 'id,name,description,quantity,sku,category_id,location_id,reorder_point,reorder_quantity,updated_at,deleted_at';
		
		      function buildSel(){
		        let sel = baseSel;
		        if(SB.itemsHasLowStockQty !== false) sel += ',low_stock_qty';
		        if(SB.itemsHasReorderEnabled !== false) sel += ',reorder_enabled';
		        if(SB.itemsHasUnitOfMeasure !== false) sel += ',unit_of_measure';
		        return sel;
		      }
		
		      for(let attempt=0; attempt<3; attempt++){
		        const sel = buildSel();
		        const res = await SB.client
		          .from('inventory_items')
		          .select(sel)
		          .eq('company_id', SB.companyId)
		          .is('deleted_at', null)
		          .order('name', { ascending:true });
		        if(!res.error){
		          data = res.data;
		          if(sel.includes('low_stock_qty')) SB.itemsHasLowStockQty = true;
		          if(sel.includes('reorder_enabled')) SB.itemsHasReorderEnabled = true;
		          if(sel.includes('unit_of_measure')) SB.itemsHasUnitOfMeasure = true;
		          break;
		        }
		        const e = res.error;
		        const msg = errToText(e).toLowerCase();
		        let changed = false;
		
		        if(msg.includes('low_stock_qty')){
		          if(SB.itemsHasLowStockQty !== false) changed = true;
		          SB.itemsHasLowStockQty = false;
		          if(isSchemaCacheMissingColumnError(e, 'low_stock_qty') && !SB.warnedLowStockSchema){
		            SB.warnedLowStockSchema = true;
		            toast("Supabase needs schema reload for low stock (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing inventory_items.low_stock_qty. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		        if(msg.includes('reorder_enabled')){
		          if(SB.itemsHasReorderEnabled !== false) changed = true;
		          SB.itemsHasReorderEnabled = false;
		          if(isSchemaCacheMissingColumnError(e, 'reorder_enabled') && !SB.warnedReorderSchema){
		            SB.warnedReorderSchema = true;
		            toast("Supabase needs schema reload for reorder settings (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing inventory_items.reorder_enabled. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		        if(msg.includes('unit_of_measure')){
		          if(SB.itemsHasUnitOfMeasure !== false) changed = true;
		          SB.itemsHasUnitOfMeasure = false;
		          if(isSchemaCacheMissingColumnError(e, 'unit_of_measure') && !SB.warnedUnitSchema){
		            SB.warnedUnitSchema = true;
		            toast("Supabase needs schema reload for units of measure (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing inventory_items.unit_of_measure. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		
		        if(!changed){
		          console.warn('Supabase load error', e);
		          return;
		        }
		      }
		
		      if(data === null) return;
		      state.items = (data||[]).map(r => ({
		        id:r.id,
		        name:r.name||'',
		        desc:r.description||'',
		        qty:toInt(r.quantity,0),
		        sku: r.sku || '',
		        unitOfMeasure: (r && Object.prototype.hasOwnProperty.call(r, 'unit_of_measure')) ? String(r.unit_of_measure || '').trim() : '',
		        categoryId: String(r.category_id || '').trim(),
		        locationId: String(r.location_id || '').trim(),
		        reorderPoint: (r && Object.prototype.hasOwnProperty.call(r,'reorder_point') && r.reorder_point !== null && typeof r.reorder_point !== 'undefined') ? toInt(r.reorder_point,0) : null,
		        reorderQty: (r && Object.prototype.hasOwnProperty.call(r,'reorder_quantity') && r.reorder_quantity !== null && typeof r.reorder_quantity !== 'undefined') ? toInt(r.reorder_quantity,0) : null,
		        lowStockQty: (r && Object.prototype.hasOwnProperty.call(r,'low_stock_qty') && r.low_stock_qty !== null) ? toInt(r.low_stock_qty,0) : null,
		        reorderEnabled: (r && Object.prototype.hasOwnProperty.call(r,'reorder_enabled')) ? !!r.reorder_enabled : true,
		        updatedAt:r.updated_at||null
		      }));
		      refreshComputedItemColWidth(state.items);
		      setUpdated(); render();
		    }
    let _sbChannel=null;
    function sbStartRealtime(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
      if(_sbChannel){ SB.client.removeChannel(_sbChannel); _sbChannel=null; }
      _sbChannel = SB.client.channel('inventory_items_all')
        .on('postgres_changes', {event:'*', schema:'public', table:'inventory_items', filter:`company_id=eq.${SB.companyId}`}, payload=>{
          const row = payload.new || payload.old;
          console.log('[realtime]', payload.eventType, row && row.id, row);
		          if(payload.eventType==='INSERT'){
		            if(row && row.deleted_at) return;
		            const i = state.items.findIndex(x=> x.id===row.id);
		            if(i===-1) state.items.push({
		              id:row.id,
		              name:row.name,
		              desc:row.description||'',
		              qty:toInt(row.quantity,0),
		              sku: row.sku || '',
		              unitOfMeasure: (row && Object.prototype.hasOwnProperty.call(row,'unit_of_measure')) ? String(row.unit_of_measure || '').trim() : '',
		              categoryId: String(row.category_id || '').trim(),
		              locationId: String(row.location_id || '').trim(),
		              reorderPoint: (row && Object.prototype.hasOwnProperty.call(row,'reorder_point') && row.reorder_point !== null && typeof row.reorder_point !== 'undefined') ? toInt(row.reorder_point,0) : null,
		              reorderQty: (row && Object.prototype.hasOwnProperty.call(row,'reorder_quantity') && row.reorder_quantity !== null && typeof row.reorder_quantity !== 'undefined') ? toInt(row.reorder_quantity,0) : null,
		              lowStockQty: (row && Object.prototype.hasOwnProperty.call(row,'low_stock_qty') && row.low_stock_qty !== null) ? toInt(row.low_stock_qty,0) : null,
		              reorderEnabled: (row && Object.prototype.hasOwnProperty.call(row,'reorder_enabled')) ? !!row.reorder_enabled : true,
		              updatedAt:row.updated_at
		            });
		          }else if(payload.eventType==='UPDATE'){
		            if(row && row.deleted_at){
		              state.items = state.items.filter(x=> x.id!==row.id);
		              setUpdated(); render();
		              return;
		            }
		            const it = state.items.find(x=> x.id===row.id);
		            if(it){
		              it.name=row.name;
		              it.desc=row.description||'';
		              it.qty=toInt(row.quantity,0);
		              if(Object.prototype.hasOwnProperty.call(row,'sku')) it.sku = row.sku || '';
		              if(Object.prototype.hasOwnProperty.call(row,'unit_of_measure')) it.unitOfMeasure = String(row.unit_of_measure || '').trim();
		              if(Object.prototype.hasOwnProperty.call(row,'category_id')) it.categoryId = String(row.category_id || '').trim();
		              if(Object.prototype.hasOwnProperty.call(row,'location_id')) it.locationId = String(row.location_id || '').trim();
		              if(Object.prototype.hasOwnProperty.call(row,'reorder_point')){
		                it.reorderPoint = (row.reorder_point === null || typeof row.reorder_point === 'undefined') ? null : toInt(row.reorder_point,0);
		              }
		              if(Object.prototype.hasOwnProperty.call(row,'reorder_quantity')){
		                it.reorderQty = (row.reorder_quantity === null || typeof row.reorder_quantity === 'undefined') ? null : toInt(row.reorder_quantity,0);
		              }
		              if(Object.prototype.hasOwnProperty.call(row,'low_stock_qty')){
		                it.lowStockQty = (row.low_stock_qty === null) ? null : toInt(row.low_stock_qty,0);
		              }
		              if(Object.prototype.hasOwnProperty.call(row,'reorder_enabled')){
		                it.reorderEnabled = !!row.reorder_enabled;
		              }
		              it.updatedAt=row.updated_at;
		            }
		          }else if(payload.eventType==='DELETE'){
	            state.items = state.items.filter(x=> x.id!==row.id);
	          }
          refreshComputedItemColWidth(state.items);
          setUpdated(); render();
        })
        .subscribe();
    }
    async function sbAddItem(name, desc, qty){
      if(!canCreate()) throw Error('Permission denied');
      if(!SB.companyId) throw Error('Company not selected');
      const id = randomUUID();
      const { error } = await SB.client.from('inventory_items').insert([{
        id,
        company_id: SB.companyId,
        name,
        description:desc||'',
        quantity: toInt(qty,0),
        reorder_enabled: true,
        created_by: SB.user ? SB.user.id : null,
      }]);
      if(error) throw error; return id;
    }
	    async function sbUpdateFields(id, fields){
	      if(!canUpdate()) throw Error('Permission denied');
	      if(!SB.companyId) throw Error('Company not selected');
	      const clean = {};
	      if('name' in fields) clean.name = String(fields.name||'');
	      if('desc' in fields) clean.description = String(fields.desc||'');
	      if('sku' in fields) clean.sku = String(fields.sku||'');
	      if('unitOfMeasure' in fields && SB.itemsHasUnitOfMeasure !== false){
	        const raw = String(fields.unitOfMeasure || '').trim();
	        clean.unit_of_measure = raw ? raw : null;
	      }
	      if('locationId' in fields){
	        const raw = String(fields.locationId || '').trim();
	        clean.location_id = raw ? raw : null;
	      }
	      if('categoryId' in fields){
	        const raw = String(fields.categoryId || '').trim();
	        clean.category_id = raw ? raw : null;
	      }
	      if('qty'  in fields) clean.quantity  = toInt(fields.qty,0);
	      if('reorderEnabled' in fields) clean.reorder_enabled = !!fields.reorderEnabled;
	      if('reorderPoint' in fields){
	        const raw = fields.reorderPoint;
	        if(raw === null || typeof raw === 'undefined' || String(raw).trim() === ''){
	          clean.reorder_point = null;
	        }else{
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Reorder point must be integer â‰¥ 0');
	          clean.reorder_point = v;
	        }
	      }
	      if('reorderQty' in fields){
	        const raw = fields.reorderQty;
	        if(raw === null || typeof raw === 'undefined' || String(raw).trim() === ''){
	          clean.reorder_quantity = null;
	        }else{
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Reorder qty must be integer â‰¥ 0');
	          clean.reorder_quantity = v;
	        }
	      }
	      if('lowStockQty' in fields){
		        const raw = fields.lowStockQty;
		        if(raw === null || typeof raw === 'undefined' || String(raw).trim() === ''){
		          clean.low_stock_qty = null;
		        }else{
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Low stock qty must be integer â‰¥ 0');
	          clean.low_stock_qty = v;
	        }
	      }
	      const { error } = await SB.client
	        .from('inventory_items')
	        .update(clean)
	        .eq('id', id)
	        .eq('company_id', SB.companyId)
	        .is('deleted_at', null);
	      if(error) throw error;
	    }

	    async function sbFetchItemQtyMap(ids){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      const requested = Array.isArray(ids) ? ids.map(x=> String(x||'').trim()).filter(Boolean) : [];
	      const out = new Map();
	      if(!requested.length) return out;
	      const size = 200;
	      for(let i=0;i<requested.length;i+=size){
	        const chunk = requested.slice(i, i+size);
	        const { data, error } = await SB.client
	          .from('inventory_items')
	          .select('id,quantity')
	          .eq('company_id', SB.companyId)
	          .is('deleted_at', null)
	          .in('id', chunk);
	        if(error) throw error;
	        (Array.isArray(data) ? data : []).forEach(r=>{
	          if(r && r.id) out.set(String(r.id), toInt(r.quantity, 0));
	        });
	      }
	      return out;
	    }

	    async function sbUpdateItemQtyIfMatch(itemId, expectedQty, nextQty){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      if(!canUpdate()) throw new Error('Permission denied');
	      const id = String(itemId || '').trim();
	      if(!id) throw new Error('Invalid item ID');
	      const { data, error } = await SB.client
	        .from('inventory_items')
	        .update({ quantity: toInt(nextQty, 0) })
	        .eq('id', id)
	        .eq('company_id', SB.companyId)
	        .eq('quantity', toInt(expectedQty, 0))
	        .is('deleted_at', null)
	        .select('id');
	      if(error) throw error;
	      return Array.isArray(data) && data.length > 0;
	    }

	    function errToText(err){
	      if(!err) return '';
	      if(typeof err === 'string') return err;
	      const parts = [];
	      try{
	        if(err.message) parts.push(String(err.message));
	        if(err.details) parts.push(String(err.details));
	        if(err.hint) parts.push(String(err.hint));
	        if(err.code) parts.push(String(err.code));
	      }catch(e){}
	      return parts.join(' ');
	    }

	    function isMissingRelationError(err){
	      const msg = errToText(err);
	      if(!msg) return false;
	      const status = Number(err && (err.status || err.statusCode));
	      if(status === 404) return true;
	      const lower = msg.toLowerCase();
	      if(lower.includes('schema cache') && lower.includes('relationship')) return true;
	      return (
	        lower.includes('does not exist') ||
	        lower.includes('relation') ||
	        lower.includes('could not find the table') ||
	        String(err && err.code || '') === '42P01' ||
	        String(err && err.code || '') === 'PGRST205'
	      );
	    }

	    function isSchemaCacheMissingColumnError(err, column){
	      const msg = errToText(err);
	      if(!msg) return false;
	      const lower = msg.toLowerCase();
	      if(!lower.includes('schema cache')) return false;
	      if(column && !errorMentionsColumn(lower, column)) return false;
	      return true;
	    }

	    function isPostgrestMissingColumnError(err, column){
	      const msg = errToText(err);
	      if(!msg) return false;
	      const lower = msg.toLowerCase();
	      if(column && !errorMentionsColumn(lower, column)) return false;
	      return lower.includes('schema cache') || (lower.includes('column') && lower.includes('does not exist'));
	    }

	    function errorMentionsColumn(lowerMsg, column){
	      if(!column) return true;
	      const col = String(column || '').trim().toLowerCase();
	      if(!col) return false;
	      if(!lowerMsg) return false;
	      const escaped = col.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
	      const re = new RegExp(`\\b${escaped}\\b`);
	      return re.test(lowerMsg);
	    }
	
	    function isMissingColumnError(err, column){
	      return isPostgrestMissingColumnError(err, column) || isSchemaCacheMissingColumnError(err, column);
	    }

	    function isAnyMissingColumnError(err){
	      return isPostgrestMissingColumnError(err) || isSchemaCacheMissingColumnError(err);
	    }

	    function isAuthOrPermissionError(err){
	      const status = Number(err && (err.status || err.statusCode));
	      if(status === 401 || status === 403) return true;
	      const msg = errToText(err).toLowerCase();
	      return msg.includes('permission') || msg.includes('not authorized') || msg.includes('insufficient');
	    }

	    function shouldRetryOrderSelect(err){
	      if(!err) return false;
	      if(isAuthOrPermissionError(err)) return false;
	      const status = Number(err && (err.status || err.statusCode));
	      if(status === 400) return true;
	      return isMissingRelationError(err) || isAnyMissingColumnError(err);
	    }

	    function isOrdersReceiptColumnsMissingError(err){
	      return [
	        'receiving_at','receiving_by','receiving_snapshot',
	        'received_at','received_by','received_snapshot',
	        'received_undone_at','received_undone_by',
	      ].some(c => isPostgrestMissingColumnError(err, c));
	    }
	
	    function showSchemaCacheReloadHelp(tableName, columnName){
	      const sql = "NOTIFY pgrst, 'reload schema';";
	      try{
	        if(navigator.clipboard && navigator.clipboard.writeText){
	          navigator.clipboard.writeText(sql)
	            .then(()=> toast('Copied schema reload SQL'))
	            .catch(()=>{});
	        }
	      }catch(e){}
	      openMsgModal(
	        'Supabase schema cache',
	        `Supabase is reporting â€œcolumn not found in schema cacheâ€ for ${tableName}.${columnName}.\n\n`+
	          `This usually means PostgREST hasnâ€™t reloaded its schema cache yet.\n\n`+
	          `Fix:\n`+
	          `1) Supabase Dashboard â†’ SQL Editor\n`+
	          `2) Run:\n${sql}\n`+
	          `3) Refresh this page\n\n`+
	          `If it still fails, wait ~30 seconds and try again.`,
	        sql
	      );
	    }
	    async function sbDeleteMany(ids){
	      if(!canDelete()) throw Error('Permission denied');
	      if(!SB.companyId) throw Error('Company not selected');
	      const requested = Array.isArray(ids) ? ids.filter(Boolean) : [];
	      if(requested.length===0) return { deleted:0, requested:0 };
	      const { data, error } = await SB.client
	        .rpc('soft_delete_items', { p_item_ids: requested });
	      if (error) throw error;
	      if(data && data.success === false){
	        throw new Error(data.error || 'Delete failed');
	      }
      return { deleted: requested.length, requested: requested.length };
    }
    async function sbUpsertMany(rows){
      if(!canItemsImport()) throw Error('Permission denied');
      if(!SB.companyId) throw Error('Company not selected');
      const payload = (Array.isArray(rows) ? rows : [])
        .map(r => ({
          name: String(r && r.name ? r.name : '').trim(),
          desc: String(r && r.desc ? r.desc : '').trim(),
          qty: toInt(r && r.qty ? r.qty : 0, 0),
        }))
        .filter(r => r.name);
      if(!payload.length) throw Error('No valid rows to import');

      const { data, error } = await SB.client.rpc('bulk_upsert_inventory_items', {
        p_company_id: SB.companyId,
        p_items: payload,
      });
      if(error) throw error;
      if(data && data.success === false){
        throw new Error(data.error || 'Import failed');
      }
    }

    async function sbExportItems(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
      if(!canItemsExport()) throw new Error('Export permission required');
      const { data, error } = await SB.client.rpc('export_inventory_items', { p_company_id: SB.companyId });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }

    // ========================
    // Rendering & inline edit
    // ========================
    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function escapeHtmlAttr(s){
      return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function bindInventorySortHandlers(){
      document.querySelectorAll('#invTable thead th.sortable').forEach(th=>{
        if(th.dataset.sortBound === '1') return;
        th.dataset.sortBound = '1';
        th.addEventListener('click', (e)=>{
          if(e && e.target && e.target.closest){
            const isSelectAll = e.target.closest('#chkAll');
            if(isSelectAll) return;
          }
          const col = th.getAttribute('data-col'); if(!col) return;
          const srt = getSort();
          if(!srt || srt.col !== col){
            state._sort = { col, dir: 'asc' };
          }else if(srt.dir === 'asc'){
            state._sort = { col, dir: 'desc' };
          }else{
            state._sort = null;
          }
          renderTable();
          if(_invViewMode === 'cards') renderInventoryCards();
          save();
        });
      });
    }
    function renderInventoryTableShell(config){
      const table = $('invTable');
      const colgroup = $('invTableColgroup');
      const thead = $('invTableHead');
      if(!table || !colgroup || !thead) return;
      const layout = getInventoryLayoutFromConfig(config);
      const columnDefs = layout.columnDefs || [];
      _inventoryActiveColumns = columnDefs.slice();
      const colHtml = [`<col style="width:${escapeHtmlAttr(layout.itemWidth)}px">`];
      columnDefs.forEach(def=>{
        const width = getInventoryColumnRequiredWidth(def);
        colHtml.push(`<col style="width:${escapeHtmlAttr(width)}px">`);
      });
      if(layout.showActions){
        const actionsWidth = Number(INVENTORY_ACTIONS_DEF && INVENTORY_ACTIONS_DEF.minWidth) || 0;
        colHtml.push(`<col style="width:${escapeHtmlAttr(actionsWidth)}px">`);
      }
      colgroup.innerHTML = colHtml.join('');
      const sortDefs = getInventorySortDefsFromConfig({ order: layout.order, visible: layout.visible });
      ensureSortVisible(sortDefs);
      const sortSpan = ' <span class="sort-ind"></span>';
      const thHtml = [];
      const selectAll = `<label class="inv-select-all"><input type="checkbox" id="chkAll" aria-label="Select all"><span>Item</span></label>`;
      thHtml.push(`<th scope="col" class="sortable" data-col="name">${selectAll}${sortSpan}</th>`);
      columnDefs.forEach(def=>{
        if(!def) return;
        const col = def.dataCol || def.key;
        const label = def.label || def.key;
        const classes = [];
        if(def.sortable) classes.push('sortable');
        if(def.align === 'left') classes.push('align-left');
        if(def.align === 'center') classes.push('num');
        if(def.thClass) classes.push(def.thClass);
        const classAttr = classes.length ? ` class="${classes.join(' ')}"` : '';
        const sortHtml = def.sortable ? sortSpan : '';
        thHtml.push(`<th scope="col"${classAttr} data-col="${escapeHtmlAttr(col)}">${escapeHtml(label)}${sortHtml}</th>`);
      });
      if(layout.showActions && INVENTORY_ACTIONS_DEF){
        thHtml.push(`<th scope="col" class="actions" data-col="${escapeHtmlAttr(INVENTORY_ACTIONS_DEF.dataCol)}">${escapeHtml(INVENTORY_ACTIONS_DEF.label)}</th>`);
      }
      thead.innerHTML = `<tr>${thHtml.join('')}</tr>`;
      rebuildMobileSortOptions(sortDefs);
      bindInventorySortHandlers();
    }
    function renderColumnBuilderList(config){
      const list = $('columnBuilderList');
      if(!list) return;
      const order = (config && Array.isArray(config.order)) ? config.order : defaultInventoryOrder();
      const visible = new Set((config && Array.isArray(config.visible)) ? config.visible : defaultInventoryVisibleKeys());
      list.innerHTML = order.map(key => INVENTORY_COLUMN_MAP.get(key)).filter(Boolean).map(def=>{
        const checked = visible.has(def.key) ? ' checked' : '';
        const isLocked = def.lock || def.key === INVENTORY_ANCHOR_KEY;
        const disabled = isLocked ? ' disabled' : '';
        const draggable = isLocked ? 'false' : 'true';
        const rowClass = `${!isLocked ? ' is-draggable' : ''}`;
        const handle = `<span class="drag-handle${isLocked ? ' disabled' : ''}" aria-hidden="true"></span>`;
        return (
          `<div class="column-option${rowClass}" data-col-key="${escapeHtmlAttr(def.key)}" data-draggable="${draggable}">`+
            `<input type="checkbox" data-col-key="${escapeHtmlAttr(def.key)}"${checked}${disabled}>`+
            `<span class="column-option-label">${escapeHtml(def.label)}</span>`+
            `${handle}`+
          `</div>`
        );
      }).join('');
    }
    function getInventoryColumnConfig(){
      const config = loadInventoryColumnConfig();
      const orderSig = Array.isArray(config.order) ? config.order.join('|') : '';
      const visibleSig = Array.isArray(config.visible) ? config.visible.join('|') : '';
      const sig = `${orderSig}::${visibleSig}`;
      if(sig !== _inventoryColumnSig){
        _inventoryColumnSig = sig;
        _inventoryColumnConfig = { order: config.order.slice(), visible: config.visible.slice() };
        renderInventoryTableShell(config);
        renderColumnBuilderList(config);
      }
      return config;
    }
    function getInventoryColumnDefsFromConfig(config){
      return getInventoryLayoutFromConfig(config).columnDefs.slice();
    }
    function appendInventorySortExtras(defs){
      const list = Array.isArray(defs) ? defs : [];
      const hasUpdated = list.some(def => (def && (def.dataCol || def.key)) === 'updatedAt');
      if(!hasUpdated){
        list.push({ id:'updatedAt', key:'updatedAt', dataCol:'updatedAt', label:'Last Updated', sortable:true });
      }
      return list;
    }
    function getInventorySortDefsFromConfig(config){
      const defs = [];
      const anchor = INVENTORY_COLUMN_MAP.get(INVENTORY_ANCHOR_KEY);
      if(anchor) defs.push(anchor);
      const layout = getInventoryLayoutFromConfig(config);
      return appendInventorySortExtras(defs.concat(layout.columnDefs || []));
    }
    function getInventoryVisibleColumnDefs(){
      const layout = getInventoryLayout();
      return layout.columnDefs ? layout.columnDefs.slice() : [];
    }
    function getInventorySortDefs(){
      const layout = getInventoryLayout();
      const anchor = INVENTORY_COLUMN_MAP.get(INVENTORY_ANCHOR_KEY);
      const defs = [];
      if(anchor) defs.push(anchor);
      return appendInventorySortExtras(defs.concat(layout.columnDefs || []));
    }
    function formatInventoryDate(value){
      const t = Date.parse(String(value || ''));
      if(!Number.isFinite(t)) return '';
      return new Date(t).toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' });
    }
    function renderTextCell(value){
      const txt = String(value ?? '').trim();
      const inner = txt ? escapeHtml(txt) : '<span class="muted">â€”</span>';
      return `<span class="cell-val">${inner}</span>`;
    }
    function renderNumberCell(value){
      const inner = (value === null || typeof value === 'undefined' || value === '')
        ? '<span class="muted">â€”</span>'
        : escapeHtml(formatQty(value));
      return `<span class="cell-val">${inner}</span>`;
    }
    function getInventoryReservedQty(item){
      if(!item || !Object.prototype.hasOwnProperty.call(item, 'reserved')) return null;
      const v = Number(item.reserved);
      return Number.isFinite(v) ? v : null;
    }
    function getInventoryIncomingQty(itemId){
      const id = String(itemId || '').trim();
      if(!id) return 0;
      const incomingMap = (state._incomingByItemId && typeof state._incomingByItemId.get === 'function')
        ? state._incomingByItemId
        : buildInventoryIncomingMap();
      state._incomingByItemId = incomingMap;
      const entry = incomingMap.get(id);
      return entry ? Number(entry.qty || 0) : 0;
    }
    function getInventoryReorderPoint(item){
      if(!item) return null;
      if(Object.prototype.hasOwnProperty.call(item, 'reorderPoint') && item.reorderPoint !== null && typeof item.reorderPoint !== 'undefined'){
        return item.reorderPoint;
      }
      if(Object.prototype.hasOwnProperty.call(item, 'lowStockQty') && item.lowStockQty !== null && typeof item.lowStockQty !== 'undefined'){
        return item.lowStockQty;
      }
      return null;
    }
    function render(){
      refreshInventoryLayout();
      renderKpis();
    }
    function ensureButtonSpinners(root){
      const scope = root && root.querySelectorAll ? root : document;
      const buttons = scope.querySelectorAll('.btn-primary, .btn-secondary, .btn-tertiary, .icon-btn');
      buttons.forEach(btn=>{
        if(btn.querySelector('.btn-spinner')) return;
        const spinner = document.createElement('span');
        spinner.className = 'btn-spinner';
        spinner.innerHTML = ICONS.loader2;
        btn.appendChild(spinner);
      });
    }
    function initButtonSystem(){
      ensureButtonSpinners();
      if(initButtonSystem._wired) return;
      initButtonSystem._wired = true;
      document.addEventListener('pointerdown', (e)=>{
        const btn = e.target && e.target.closest ? e.target.closest('.btn-primary, .btn-secondary, .btn-tertiary, .icon-btn') : null;
        if(!btn) return;
        if(btn.disabled || btn.getAttribute('aria-disabled') === 'true' || btn.dataset.loading === 'true') return;
        if(e.button && e.button !== 0) return;
        const rect = btn.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const ripple = document.createElement('span');
        ripple.className = 'btn-ripple';
        ripple.style.width = `${size}px`;
        ripple.style.height = `${size}px`;
        ripple.style.left = `${e.clientX - rect.left - size / 2}px`;
        ripple.style.top = `${e.clientY - rect.top - size / 2}px`;
        btn.appendChild(ripple);
        setTimeout(()=>{ if(ripple && ripple.parentNode) ripple.parentNode.removeChild(ripple); }, 520);
      }, { passive:true });
    }
    initButtonSystem.refresh = ensureButtonSpinners;

function adjustTitleSize(){
  try{
    const h1=document.querySelector('header h1');
    if(!h1) return;
    const wrap=document.querySelector('.brandtext');
    if(!wrap) return;
    h1.style.whiteSpace='nowrap'; h1.style.maxWidth='100%';
    h1.style.fontSize='';
    const rootStyles = getComputedStyle(document.documentElement);
    let min = parseFloat(rootStyles.getPropertyValue('--title-min')) || 12;
    let max = parseFloat(rootStyles.getPropertyValue('--title-max')) || 56;
    let size=parseFloat(getComputedStyle(h1).fontSize)||32;
    const roomEl = stack || wrap;
    const room = Math.max(0, roomEl.getBoundingClientRect().width - 8);
    const fits = ()=> h1.scrollWidth <= room;
    if(!fits()){
      while(size>min && !fits()){ size-=1; h1.style.fontSize=size+'px'; }
    }else{
      while(size<max){ h1.style.fontSize=(size+1)+'px'; if(!fits()){ h1.style.fontSize=size+'px'; break; } size+=1; }
    }
  }catch(e){}
}

	function getSort(){
	  if(!state._sort) return null;
	  // Handle if array was saved (convert back to single)
	  if(Array.isArray(state._sort)) return state._sort[0] || null;
	  if(!state._sort.col) return null;
	  return {col:state._sort.col, dir:state._sort.dir === 'desc' ? 'desc' : 'asc'};
	}
	function ensureSortVisible(defs){
	  const srt = getSort();
	  if(!srt) return;
	  const visibleCols = new Set((Array.isArray(defs) ? defs : []).map(def => def && (def.dataCol || def.key)).filter(Boolean));
	  if(!visibleCols.has(srt.col)){
	    state._sort = null;
	  }
	}
	function syncMobileSortSelect(){
	  const sel = $('mobileSort');
	  if(!sel) return;
	  const srt = getSort();
	  if(!srt){
	    sel.value = '';
	    return;
	  }
	  const key = `${srt.col}:${srt.dir}`;
	  const has = Array.from(sel.options || []).some(o => o.value === key);
	  if(has) sel.value = key;
	}
	function updateSortOptionsUI(srt){
	  const cur = srt || getSort();
	  const options = document.querySelectorAll('.inv-sort-option[data-sort]');
	  options.forEach(opt=>{
	    const sortValue = String(opt.getAttribute('data-sort') || '').trim();
	    const parts = sortValue.split(':');
	    const col = (parts[0] || '').trim();
	    const dir = (parts[1] || '').trim() === 'desc' ? 'desc' : 'asc';
	    const isActive = !!(cur && col && cur.col === col);
	    opt.classList.toggle('is-active', isActive);
	    const activeDir = isActive ? cur.dir : dir;
	    opt.classList.toggle('is-desc', activeDir === 'desc');
	    opt.classList.toggle('is-asc', activeDir !== 'desc');
	  });
	}
	function rebuildMobileSortOptions(defs){
	  const sel = $('mobileSort');
	  if(!sel) return;
	  const numericCols = new Set(['qty','incoming','reserved','available','reorderPoint','reorderQty']);
	  const dateCols = new Set(['updatedAt']);
	  const opts = ['<option value=\"\">No sort</option>'];
	  (Array.isArray(defs) ? defs : []).forEach(def=>{
	    const col = def ? (def.dataCol || def.key) : '';
	    if(!col || !def || !def.sortable) return;
	    const label = def.label || col;
	    if(dateCols.has(col)){
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:asc\">${escapeHtml(label)} (Oldest)</option>`);
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:desc\">${escapeHtml(label)} (Newest)</option>`);
	    }else if(numericCols.has(col)){
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:asc\">${escapeHtml(label)} (Lowâ€“High)</option>`);
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:desc\">${escapeHtml(label)} (Highâ€“Low)</option>`);
	    }else{
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:asc\">${escapeHtml(label)} (Aâ€“Z)</option>`);
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:desc\">${escapeHtml(label)} (Zâ€“A)</option>`);
	    }
	  });
	  sel.innerHTML = opts.join('');
	  syncMobileSortSelect();
	}
	function applySortIndicators(){
	  const srt = getSort();
	  document.querySelectorAll('#invTable thead th.sortable').forEach(th=>{
	    const col = th.getAttribute('data-col');
	    th.removeAttribute('aria-sort');
	    th.classList.remove('sorted-asc','sorted-desc');
	    if(srt && col === srt.col){
	      const desc = (srt.dir === 'desc');
	      th.setAttribute('aria-sort', desc ? 'descending' : 'ascending');
	      th.classList.add(desc ? 'sorted-desc' : 'sorted-asc');
	    }
	  });
	  syncMobileSortSelect();
	  updateSortOptionsUI(srt);
	}

	function toTime(v){
	  const t = Date.parse(String(v || ''));
	  return Number.isFinite(t) ? t : 0;
	}
	function sortItems(arr){
	  const srt = getSort();
	  if(!srt) return arr;
	  const dir = srt.dir === 'desc' ? -1 : 1;
	  const col = srt.col || 'name';
	  const incomingMap = (state._incomingByItemId && typeof state._incomingByItemId.get === 'function')
	    ? state._incomingByItemId
	    : buildInventoryIncomingMap();
	  state._incomingByItemId = incomingMap;
	  const rows = arr.map((item, index) => ({ item, index }));
	  const getValue = (it)=>{
	    if(col === 'qty') return { type:'number', value: toInt(it.qty,0) };
	    if(col === 'incoming'){
	      const entry = incomingMap.get(String(it.id || '').trim());
	      const incomingQty = entry ? Number(entry.qty || 0) : 0;
	      return { type:'number', value: incomingQty };
	    }
	    if(col === 'reserved') return { type:'number', value: getInventoryReservedQty(it) };
	    if(col === 'available'){
	      const reserved = getInventoryReservedQty(it);
	      return { type:'number', value: toInt(it.qty,0) - (Number.isFinite(reserved) ? reserved : 0) };
	    }
	    if(col === 'reorderPoint') return { type:'number', value: getInventoryReorderPoint(it) };
	    if(col === 'reorderQty') return { type:'number', value: Number.isFinite(Number(it.reorderQty)) ? Number(it.reorderQty) : null };
	    if(col === 'updatedAt') return { type:'number', value: toTime(it.updatedAt) };
	    if(col === 'location') return { type:'string', value: toKey(String(inventoryLocationLabel(it) || '')) };
	    if(col === 'category') return { type:'string', value: toKey(String(it.categoryId || '')) };
	    if(col === 'sku') return { type:'string', value: toKey(String(it.sku || '')) };
	    if(col === 'desc') return { type:'string', value: toKey(String(it.desc || '')) };
	    return { type:'string', value: toKey(String(it.name || '')) };
	  };
	  rows.sort((a,b)=>{
	    const av = getValue(a.item);
	    const bv = getValue(b.item);
	    if(av.type === 'number'){
	      const aNil = av.value === null || typeof av.value === 'undefined' || Number.isNaN(av.value);
	      const bNil = bv.value === null || typeof bv.value === 'undefined' || Number.isNaN(bv.value);
	      if(aNil && bNil) return a.index - b.index;
	      if(aNil) return 1;
	      if(bNil) return -1;
	      if(av.value !== bv.value) return (av.value - bv.value) * dir;
	    }else{
	      const aVal = av.value || '';
	      const bVal = bv.value || '';
	      if(aVal !== bVal) return aVal.localeCompare(bVal) * dir;
	    }
	    return a.index - b.index;
	  });
	  return rows.map(r => r.item);
	}

	function adjustDescColumnWidth(){
	  return;
	}

		function isMobileUx(){
		  try{
		    if(!window.matchMedia) return false;
		    return window.matchMedia('(pointer: coarse)').matches;
		  }catch(e){ return false; }
		}
		function isMobileStacked(){ return isMobileUx(); }

	    function renderKpis(){
	      const el=$('lastUpdate');
	      if(!el) return;
	      el.textContent = state.updatedAt? `Last Update: ${new Date(state.updatedAt).toLocaleString(undefined,{hour12:true})}` : '';
      const fb=$('filterBox'); if(fb) fb.value = state._filter || '';
          }

    // -------- Partial-optimistic DOM helpers --------
	function tbodyEl(){ return document.querySelector('#invTable tbody'); }
	function rowElById(id){ return tbodyEl()?.querySelector(`tr[data-id="${id}"]`) || null; }
		function cellEl(tr, col){ return tr?.querySelector(`td[data-col="${col}"]`) || null; }
		function getSelectedRowIds(){
		  return Array.from(document.querySelectorAll('.rowChk:checked'))
		    .map(cb => String(cb.dataset.id || '').trim())
		    .filter(Boolean);
		}
		function applySelectedRowIds(ids){
		  const set = new Set((ids || []).map(id => String(id || '').trim()).filter(Boolean));
		  document.querySelectorAll('.rowChk').forEach(cb => {
		    const id = String(cb.dataset.id || '').trim();
		    cb.checked = set.has(id);
		  });
		  const all = document.querySelectorAll('.rowChk');
		  const checked = document.querySelectorAll('.rowChk:checked');
		  const m = $('chkAll');
		  if(m){
		    m.checked = (checked.length === all.length && all.length > 0);
		    m.indeterminate = (checked.length > 0 && checked.length < all.length);
		  }
		}
		function normalizeDescValue(value){
		  return String(value || '').replace(/[\r\n]+/g,' ').trim();
		}
		function truncateForConfirm(value, max = 60){
		  const txt = String(value || '');
		  if(!txt) return '(blank)';
		  return txt.length > max ? `${txt.slice(0, max - 1)}â€¦` : txt;
		}
			let _expandedCardId = '';
		function collapseExpandedCard(){
		  if(!_expandedCardId) return;
		  const tr = rowElById(_expandedCardId);
		  if(tr) tr.classList.remove('card-expanded');
		  const tbody = tbodyEl();
		  if(tbody){
		    const rows = Array.from(tbody.querySelectorAll('tr.inv-detail-row'));
		    rows.forEach(row=>{
		      if(String(row.dataset.detailId || '') === String(_expandedCardId)) row.remove();
		    });
		  }
		  _expandedCardId = '';
		}
		function expandCard(id){
		  const nextId = String(id || '').trim();
		  if(!nextId) return;
		  if(_expandedCardId === nextId) return;
		  collapseExpandedCard();
		  const tr = rowElById(nextId);
		  if(!tr) return;
		  tr.classList.add('card-expanded');
		  _expandedCardId = nextId;
		  const it = state.items.find(x=> x && String(x.id || '') === nextId) || null;
		  if(!it) return;
		  const layout = getInventoryLayout();
		  const incomingMap = (state._incomingByItemId && typeof state._incomingByItemId.get === 'function')
		    ? state._incomingByItemId
		    : buildInventoryIncomingMap();
		  state._incomingByItemId = incomingMap;
		  const detailRow = document.createElement('tr');
		  detailRow.className = 'inv-detail-row';
		  detailRow.dataset.detailId = nextId;
		  detailRow.innerHTML = buildInventoryDetailRow(it, layout, incomingMap);
		  if(tr.parentNode){
		    if(tr.nextSibling) tr.parentNode.insertBefore(detailRow, tr.nextSibling);
		    else tr.parentNode.appendChild(detailRow);
		  }
		}
		function toggleExpandedCard(id){
		  const nextId = String(id || '').trim();
		  if(!nextId) return;
		  if(_expandedCardId === nextId) collapseExpandedCard();
		  else expandCard(nextId);
		}
	function clampNum(v, min, max){
	  return Math.max(min, Math.min(max, v));
	}		function syncOrderIndicatorForRow(id){
		  const itemId = String(id || '').trim();
		  if(!itemId) return;
		  let inOrder = false;
		  try{
		    const ord = orderState();
		    inOrder = !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && String(l.id || '').trim() === itemId));
		  }catch(e){}

		  // Update table row if exists
		  const tr = rowElById(itemId);
		  if(tr){
		    const orderBtn = tr.querySelector('.row-order-btn');
		    if(orderBtn){
		      orderBtn.classList.toggle('row-order-btn--active', inOrder);
		      orderBtn.setAttribute('aria-pressed', inOrder ? 'true' : 'false');
		      const label = inOrder ? 'Remove from order' : 'Add to order';
		      orderBtn.setAttribute('aria-label', label);
		      orderBtn.setAttribute('title', label);
		    }
		    const detailBtn = document.querySelector(`tr.inv-detail-row[data-detail-id="${CSS.escape(itemId)}"] button[data-detail-action="order"]`);
		    if(detailBtn){
		      const label = inOrder ? 'Remove from Order' : 'Add to Order';
		      detailBtn.setAttribute('aria-label', label);
		      detailBtn.setAttribute('title', label);
		      const text = detailBtn.querySelector('span');
		      if(text) text.textContent = label;
		    }
		    tr.classList.toggle('order-selected', inOrder);
		    updateOrderTrayButtonLabel(tr);
		  }

		  // Update card if exists
		  const card = document.querySelector(`.inv-card[data-item-id="${CSS.escape(itemId)}"]`);
		  if(card){
		    card.classList.toggle('order-selected', inOrder);
		    // Force repaint on mobile Safari
		    card.style.transform = 'translateZ(0)';
		    void card.offsetHeight;
		    card.style.transform = '';
		    const cardOrderBtn = card.querySelector('[data-card-order]');
		    if(cardOrderBtn){
		      const label = inOrder ? 'Remove from order' : 'Add to order';
		      cardOrderBtn.setAttribute('title', label);
		      cardOrderBtn.setAttribute('aria-label', label);
		    }
		  }
		}
		function toggleOrderLineForItemId(id){
		  const itemId = String(id || '').trim();
		  if(!itemId) return;
		  if(!canOrdersCreate()) return;
		  const item = state.items.find(x => x && x.id === itemId);
		  if(!item) return;
		  let exists = false;
		  try{
		    const ord = orderState();
		    exists = !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && l.id === itemId));
		  }catch(e){ exists = false; }
		  if(exists) removeOrderLine(itemId);
		  else upsertOrderLineFromItem(item, 1);
		}
		function syncLowStockOverrideIndicatorForRow(id){
		  const tr = rowElById(id);
		  if(!tr) return;
		  const item = state.items.find(x => x && x.id === id);
	  if(!item) return;
	  const hasLowStockOverride = getItemLowStockQtyOverride(item) !== null;

	  const btn = tr.querySelector('.row-stock-btn');
	  if(btn){
	    btn.classList.toggle('has-override', hasLowStockOverride);
	    const lowStockBtnLabel = 'Set reorder point';
	    btn.setAttribute('aria-label', lowStockBtnLabel);
	    btn.setAttribute('title', lowStockBtnLabel);
	  }
	}
	function syncLowStockIndicatorForRowNow(id){
	  const tr = rowElById(id);
	  if(!tr) return;
	  const item = state.items.find(x => x && x.id === id);
	  if(!item) return;
	  const silenced = lowStockAlertsSilenced();
	  const qty = toInt(item.qty, 0);
	  const isLowStock = !silenced && isLowStockItem(item);
	  const isOutOfStock = isLowStock && qty === 0;
	  const isLowButInStock = isLowStock && qty > 0;
	  const led = tr.querySelector('.card-led--lowstock');
	  if(led){
	    led.classList.toggle('card-led--outofstock', isOutOfStock);
	    led.classList.toggle('card-led--on', isLowButInStock);
	  }
	}
	// Debounced version - waits for user to stop clicking before updating LED
	function syncLowStockIndicatorForRow(id){
	  const existing = _qtyLedSync.get(id);
	  if(existing) clearTimeout(existing);
	  _qtyLedSync.set(id, setTimeout(()=> {
	    _qtyLedSync.delete(id);
	    syncLowStockIndicatorForRowNow(id);
	  }, 300));
	}
		function inventoryLocationLabel(it){
		  const id = String(it && it.locationId ? it.locationId : '').trim();
		  if(!id) return '';
		  const map = state._companyLocationById;
		  const row = map && typeof map.get === 'function' ? map.get(id) : null;
		  return row && row.name ? String(row.name) : id;
		}
		function inventorySignalValue(def, it){
		  if(!def || !it) return '';
		  if(def.key === 'description') return normalizeDescValue(it.desc || '');
		  if(def.key === 'sku') return String(it.sku || '').trim();
		  if(def.key === 'location') return inventoryLocationLabel(it);
		  if(def.key === 'on_hand') return formatQty(toInt(it.qty,0));
		  if(def.key === 'incoming') return formatQty(getInventoryIncomingQty(it.id));
		  if(def.key === 'reserved'){
		    const reserved = getInventoryReservedQty(it);
		    return Number.isFinite(reserved) ? formatQty(reserved) : '';
		  }
		  if(def.key === 'available'){
		    const reserved = getInventoryReservedQty(it);
		    const available = toInt(it.qty,0) - (Number.isFinite(reserved) ? reserved : 0);
		    return formatQty(available);
		  }
		  if(def.key === 'reorder_point'){
		    const rp = getInventoryReorderPoint(it);
		    return (rp === null || typeof rp === 'undefined') ? '' : formatQty(rp);
		  }
		  if(def.key === 'reorder_qty'){
		    const rq = Number.isFinite(Number(it.reorderQty)) ? Number(it.reorderQty) : null;
		    return (rq === null || typeof rq === 'undefined') ? '' : formatQty(rq);
		  }
		  if(def.key === 'category') return String(it.categoryId || '').trim();
		  return '';
		}
		function isItemInOrder(itemId){
		  const id = String(itemId || '').trim();
		  if(!id) return false;
		  try{
		    const ord = orderState();
		    return !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && String(l.id || '') === id));
		  }catch(e){
		    return false;
		  }
		}
		function buildInventoryIncomingMap(){
		  const map = new Map();
		  const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
		  if(!rows.length) return map;
		  const lineMap = state._orderHistoryLinesByPo || new Map();
		  for(const row of rows){
		    const orderId = String(row && row.id ? row.id : '').trim();
		    if(!orderId) continue;
		    const totals = getPurchaseOrderLineTotalsById(orderId, lineMap);
		    applyPurchaseOrderLineTotals(row, totals);
		    const receiveState = getPurchaseOrderReceiveState(row, totals);
		    if(receiveState === 'draft' || receiveState === 'cancelled' || receiveState === 'closed' || receiveState === 'voided') continue;
		    if(totals.hasLines && totals.remaining <= 0) continue;
		    const lines = normalizePurchaseOrderLines(lineMap.get(orderId) || []);
		    for(const line of lines){
		      const itemId = String(line.item_id || '').trim();
		      if(!itemId) continue;
		      const ordered = toQty(line.quantity_ordered, 0);
		      const received = toQty(line.quantity_received, 0);
		      const remaining = Math.max(0, ordered - received);
		      if(remaining <= 0) continue;
		      let entry = map.get(itemId);
		      if(!entry){
		        entry = { qty: 0, orders: new Set() };
		      }
		      entry.qty += remaining;
		      entry.orders.add(orderId);
		      map.set(itemId, entry);
		    }
		  }
		  return map;
		}
		function buildInventorySignalsHtml(it, defs){
		  const list = Array.isArray(defs) ? defs : [];
		  if(!list.length) return '';
		  return list.map(def=>{
		    const raw = inventorySignalValue(def, it);
		    const display = (raw === '' || raw === null || typeof raw === 'undefined') ? 'â€”' : String(raw);
		    const label = def.label || def.key;
		    const title = `${label}: ${display}`;
		    return (
		      `<span class="inv-signal" title="${escapeHtmlAttr(title)}">`+
		        `<span class="inv-signal-label">${escapeHtml(label)}</span>`+
		        `<span class="inv-signal-value">${escapeHtml(display)}</span>`+
		      `</span>`
		    );
		  }).join('');
		}
		function buildInventoryQtyStepper(it, ctx){
		  const qty = toInt(it.qty,0);
		  const display = escapeHtml(formatQty(qty));
		  if(!ctx || !ctx.allowInlineEdit){
		    return `<div class="qty-stepper qty-stepper--table" aria-label="On hand quantity"><span class="qty-value">${display}</span></div>`;
		  }
		  return (
		    `<div class="qty-stepper qty-stepper--table" aria-label="On hand quantity">`+
		      `<button type="button" class="qty-step" data-id="${escapeHtmlAttr(ctx.id)}" data-delta="-1"${qty <= 0 ? ' disabled' : ''}>âˆ’</button>`+
		      `<span class="qty-value">${display}</span>`+
		      `<button type="button" class="qty-step" data-id="${escapeHtmlAttr(ctx.id)}" data-delta="1">+</button>`+
		    `</div>`
		  );
		}
		function buildInventoryItemCell(ctx){
		  const it = ctx.item;
		  const name = String(it.name || '').trim();
		  const checkbox = `<input type="checkbox" class="rowChk inv-row-check" data-id="${escapeHtmlAttr(ctx.id)}"${ctx.allowSelect ? '' : ' disabled'}>`;
		  return (
		    `<td data-col="name">`+
		      `<div class="card-leds" aria-hidden="true">`+
		        `<span class="${ctx.lowstockLedClass}"></span>`+
		      `</div>`+
		      `<div class="inv-item-main">`+
		        checkbox+
		        `<div class="inv-item-line">`+
		          `<span class="inv-item-name" title="${escapeHtmlAttr(name)}">${escapeHtml(name || '(Unnamed item)')}</span>`+
		        `</div>`+
		      `</div>`+
		    `</td>`
		  );
		}
		function buildInventoryColumnCellInner(it, def, ctx){
		  if(!def) return renderTextCell('');
		  if(def.key === 'on_hand'){
		    return renderNumberCell(toInt(it.qty,0));
		  }
		  if(def.key === 'sku'){
		    const sku = String(it.sku || '').trim();
		    return renderTextCell(sku);
		  }
		  if(def.key === 'description'){
		    const desc = normalizeDescValue(it.desc || '');
		    return renderTextCell(desc);
		  }
		  if(def.key === 'location'){
		    const loc = inventoryLocationLabel(it);
		    return renderTextCell(loc);
		  }
		  if(def.key === 'incoming'){
		    return renderNumberCell(getInventoryIncomingQty(it.id));
		  }
		  if(def.key === 'reserved'){
		    const reserved = getInventoryReservedQty(it);
		    return renderNumberCell(reserved);
		  }
		  if(def.key === 'available'){
		    const reserved = getInventoryReservedQty(it);
		    const available = toInt(it.qty,0) - (Number.isFinite(reserved) ? reserved : 0);
		    return renderNumberCell(available);
		  }
		  if(def.key === 'reorder_point'){
		    const rp = getInventoryReorderPoint(it);
		    return renderNumberCell(rp);
		  }
		  if(def.key === 'reorder_qty'){
		    const rq = Number.isFinite(Number(it.reorderQty)) ? Number(it.reorderQty) : null;
		    return renderNumberCell(rq);
		  }
		  if(def.key === 'category'){
		    const cat = String(it.categoryId || '').trim();
		    return renderTextCell(cat);
		  }
		  const fallback = inventorySignalValue(def, it);
		  return renderTextCell(fallback);
		}
		function buildInventoryColumnCells(it, columnDefs, ctx){
		  const defs = Array.isArray(columnDefs) ? columnDefs : [];
		  if(!defs.length) return '';
		  return defs.map(def=>{
		    if(!def) return '';
		    const col = def.dataCol || def.key;
		    const numeric = def.align === 'center';
		    const alignLeft = def.align === 'left';
		    const classAttr = (numeric || alignLeft) ? ` class="${numeric ? 'num' : 'align-left'}"` : '';
		    const inner = buildInventoryColumnCellInner(it, def, ctx);
		    return `<td data-col="${escapeHtmlAttr(col)}"${classAttr}>${inner}</td>`;
		  }).join('');
		}
		function buildInventoryActionsCell(ctx, showActions){
		  if(!showActions) return '';
		  const actions = getVisibleInventoryRowActions();
		  if(!actions.length){
		    return '<td class="actions" data-col="actions"><div class="actions-wrap"></div></td>';
		  }
		  const buttons = actions.map(key=>{
		    const meta = inventoryActionMetaForKey(key);
		    if(!meta) return '';
		    const label = meta.label ? meta.label(ctx) : '';
		    const ariaPressed = (key === 'order_item') ? ` aria-pressed="${ctx.inOrder ? 'true' : 'false'}"` : '';
		    const extraClass = (key === 'order_item') ? ` ${ctx.orderBtnClass}` : '';
		    return (
		      '<button class="'+meta.btnClass+extraClass+'" data-id="'+ctx.id+'" aria-label="'+escapeHtmlAttr(label)+'" title="'+escapeHtmlAttr(label)+'"'+ariaPressed+'>'+
		        meta.icon()+
		      '</button>'
		    );
		  }).join('');
		  return '<td class="actions" data-col="actions"><div class="actions-wrap">'+buttons+'</div></td>';
		}
		function buildInventoryDetailRow(it, layout, incomingMap){
		  if(!it || !layout) return '';
		  const id = String(it.id || '').trim();
		  const colCount = 1 + (layout.columnDefs ? layout.columnDefs.length : 0) + (layout.showActions ? 1 : 0);
		  const qty = toInt(it.qty, 0);
		  const reserved = getInventoryReservedQty(it);
		  const reservedNum = Number.isFinite(reserved) ? reserved : 0;
		  const available = Math.max(0, qty - reservedNum);
		  const incoming = incomingMap && incomingMap.get(id) ? incomingMap.get(id) : null;
		  const incomingQty = incoming ? incoming.qty : 0;
		  const incomingOrders = incoming ? incoming.orders.size : 0;
		  const incomingText = (incomingQty > 0)
		    ? `+${formatQty(incomingQty)} from ${incomingOrders} open order${incomingOrders === 1 ? '' : 's'}`
		    : '';
		  const incomingHtml = incomingQty > 0
		    ? `<span class="inv-detail-incoming">${ICONS.package}<span class="inv-detail-incoming-text">${escapeHtml(incomingText)}</span></span>`
		    : '<span class="muted">â€”</span>';
		  const hasDescColumn = Array.isArray(layout.columnKeys) && layout.columnKeys.includes('description');
		  const desc = normalizeDescValue(it.desc || '');
		  const descHtml = (!hasDescColumn && desc)
		    ? `<div class="inv-detail-section">`+
		        `<div class="inv-detail-title">Description</div>`+
		        `<div class="inv-detail-desc">${escapeHtml(desc)}</div>`+
		      `</div>`
		    : '';
		  const actions = [];
		  const inOrder = isItemInOrder(id);
		  if(isInventoryActionVisible('order_item') && canOrdersCreate()){
		    const label = inOrder ? 'Remove from Order' : 'Add to Order';
		    actions.push(
		      `<button class="btn-tertiary btn-sm btn-with-icon" type="button" data-detail-action="order" data-id="${escapeHtmlAttr(id)}" aria-label="${escapeHtmlAttr(label)}" title="${escapeHtmlAttr(label)}">`+
		        ICONS.shoppingBag+
		        `<span>${escapeHtml(label)}</span>`+
		      `</button>`
		    );
		  }
		  if(isInventoryActionVisible('add_to_job')){
		    actions.push(
		      `<button class="btn-tertiary btn-sm btn-with-icon" type="button" data-detail-action="job" data-id="${escapeHtmlAttr(id)}" aria-label="Add to Job" title="Add to Job">`+
		        ICONS.briefcasePlus+
		        `<span>Add to Job</span>`+
		      `</button>`
		    );
		  }
		  if(isInventoryActionVisible('edit_item') && canItemsEdit()){
		    actions.push(
		      `<button class="btn-tertiary btn-sm btn-with-icon" type="button" data-detail-action="edit" data-id="${escapeHtmlAttr(id)}" aria-label="Edit Item" title="Edit Item">`+
		        ICONS.pencil+
		        `<span>Edit Item</span>`+
		      `</button>`
		    );
		  }
		  const actionsHtml = actions.length
		    ? `<div class="inv-detail-section">`+
		        `<div class="inv-detail-title">Quick Actions</div>`+
		        `<div class="inv-detail-actions">${actions.join('')}</div>`+
		      `</div>`
		    : '';
		  return (
		    `<td colspan="${colCount}">`+
		      `<div class="inv-detail-panel">`+
		        `<div class="inv-detail-section">`+
		          `<div class="inv-detail-title">Inventory Snapshot</div>`+
		          `<div class="inv-detail-metrics">`+
		            `<div class="inv-detail-metric">`+
		              `<span class="inv-detail-label">On Hand</span>`+
		              `<span class="inv-detail-value">${escapeHtml(formatQty(qty))}</span>`+
		            `</div>`+
		            `<div class="inv-detail-metric">`+
		              `<span class="inv-detail-label">Incoming</span>`+
		              `<span class="inv-detail-value">${incomingHtml}</span>`+
		            `</div>`+
		            `<div class="inv-detail-metric">`+
		              `<span class="inv-detail-label">Allocated</span>`+
		              `<span class="inv-detail-value">${(reserved === null || typeof reserved === 'undefined') ? '<span class=\"muted\">â€”</span>' : escapeHtml(formatQty(reserved))}</span>`+
		            `</div>`+
		            `<div class="inv-detail-metric">`+
		              `<span class="inv-detail-label">Available</span>`+
		              `<span class="inv-detail-value">${escapeHtml(formatQty(available))}</span>`+
		            `</div>`+
		          `</div>`+
		        `</div>`+
		        `${descHtml}`+
		        `${actionsHtml}`+
		      `</div>`+
		    `</td>`
		  );
		}
		function buildRowHTML(it, columnDefs, layout){
		  const rawId = String(it && it.id ? it.id : '');
		  const id = escapeHtmlAttr(rawId);
		  const allowSelect = canItemsCreate() || canItemsEdit() || canItemsDelete();
		  const canEdit = canItemsEdit();
		  const isLowStock = isLowStockItem(it);
		  const inOrder = isItemInOrder(rawId);
		  const showLowStockLed = isLowStock && !lowStockAlertsSilenced();
		  const qty = toInt(it.qty, 0);
		  const isOutOfStock = showLowStockLed && qty === 0;
		  const isLowButInStock = showLowStockLed && qty > 0;
		  const lowstockLedClass = isOutOfStock ? 'card-led card-led--lowstock card-led--outofstock' : (isLowButInStock ? 'card-led card-led--lowstock card-led--on' : 'card-led card-led--lowstock');
		  const orderBtnClass = inOrder ? 'row-order-btn--active' : '';
		  const cols = Array.isArray(columnDefs) ? columnDefs : getInventoryVisibleColumnDefs();
		  const showActions = layout && typeof layout.showActions === 'boolean' ? layout.showActions : getInventoryLayout().showActions;
		  const ctx = { item: it, id, allowSelect, canEdit, inOrder, lowstockLedClass, orderBtnClass, allowInlineEdit: canEdit && !isMobileUx() };
		  let html = buildInventoryItemCell(ctx);
		  html += buildInventoryColumnCells(it, cols, ctx);
		  if(showActions){
		    html += buildInventoryActionsCell(ctx, showActions);
		  }
		  return html;
		}
// Insert a row into the table in sorted position by name
function insertRowSorted(it){
  const tb = tbodyEl(); if(!tb) return;
  const empty = tb.querySelector('tr[data-empty="1"]'); if(empty) empty.remove();
  const trs = Array.from(tb.querySelectorAll('tr[data-id]'));
  const k = toKey(it.name);
  let anchor = null;
  for(const tr of trs){
    const nm = tr.querySelector('.inv-item-name')?.textContent || '';
    if(toKey(nm) > k){ anchor = tr; break; }
  }
  const tr = document.createElement('tr');
  tr.dataset.id = it.id;
  tr.innerHTML = buildRowHTML(it, _inventoryActiveColumns, getInventoryLayout());
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing(); // attach listeners to the new row
}
// Reposition existing row if its name changed
function repositionRowByName(id){
  const tb = tbodyEl(); if(!tb) return;
  const tr = rowElById(id); if(!tr) return;
  const it = state.items.find(x=> x.id===id); if(!it) return;
  tr.innerHTML = buildRowHTML(it, _inventoryActiveColumns, getInventoryLayout()); // refresh cells
  const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
  const k = toKey(it.name);
  let anchor = null;
  for(const r of others){
    const nm = r.querySelector('.inv-item-name')?.textContent || '';
    if(toKey(nm) > k){ anchor = r; break; }
  }
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing();
}
// Update just one cell
	function updateCellDisplay(id, col, value){
	  const tr = rowElById(id); if(!tr) return;
	  const td = cellEl(tr, col); if(!td) return;
		  if(col==='qty'){
		    const v = String(toInt(value,0));
		    const cellVal = td.querySelector('.cell-val');
		    const stepVal = td.querySelector('.qty-value');
		    if(cellVal) cellVal.textContent = v;
		    else if(stepVal) stepVal.textContent = v;
		    else td.textContent = v;
		    return;
		  }
	  td.textContent = String(value||'');
	}

function updateFilterClearBtn(){
  const fb = $('filterBox');
  const btn = $('btnClearFilter');
  if(!fb || !btn) return;
  const has = String(fb.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderSearchClearBtn(){
  const inp = $('orderSearch');
  const btn = $('btnClearOrderSearch');
  if(!inp || !btn) return;
  const has = String(inp.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderHistoryFilterClearBtn(){
  const inp = $('orderHistoryFilter');
  const btn = $('btnClearOrderHistoryFilter');
  if(!inp || !btn) return;
  const hasText = String(inp.value || '').length > 0;
  const hasStatus = Array.isArray(state._orderHistoryStatusFilter) && state._orderHistoryStatusFilter.length > 0;
  const has = hasText || hasStatus;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}
// Ensure an empty-state row exists when there are no data rows
function emptyStateHtml(){
  const gate = explainGate();
  if(!gate){
    return 'No items yet. Use <b>Import File</b> or <b>Paste Data</b> above, or <b>Add Item</b> to create one.';
  }
  if(gate === 'Sign in required'){
    return 'Sign in to view your inventory. Tap the status bar above.';
  }
  if(gate === 'No company access'){
    return 'No company access yet. Tap the status bar above for account details.';
  }
  if(gate === 'Permission denied'){
    return 'Your role does not allow inventory access. Tap the status bar above for account details.';
  }
  if(gate === 'Not authorized'){
    return 'Not authorized for this inventory. Tap the status bar above for account details.';
  }
  if(gate.startsWith('Offline')){
    return 'Offline. Connect to load your inventory.';
  }
  return escapeHtml(gate);
}
	function ensureEmptyState(){
	  const tb = tbodyEl(); if(!tb) return;
	  const hasRows = tb.querySelector('tr[data-id]') !== null;
	  const existingEmpty = tb.querySelector('tr[data-empty="1"]');
	  if(!hasRows && !existingEmpty){
	    const layout = getInventoryLayout();
	    const activeCols = Array.isArray(layout.columnDefs) ? layout.columnDefs : getInventoryVisibleColumnDefs();
	    const colCount = 1 + activeCols.length + (layout.showActions ? 1 : 0);
	    const tr=document.createElement('tr'); tr.setAttribute('data-empty','1');
	    tr.innerHTML = '<td colspan="'+colCount+'" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
	    tb.appendChild(tr);
	  } else if(hasRows && existingEmpty){
	    existingEmpty.remove();
	  }
	}

	function isCompactTotals(){
	  try{ return window.matchMedia && window.matchMedia('(max-width:520px)').matches; }catch(e){ return false; }
	}
	function totalsLabel(key){
	  const compact = isCompactTotals();
	  if(key === 'items') return compact ? 'Items' : 'Total Items';
	  if(key === 'inStock') return compact ? 'Stock' : 'In Stock';
	  if(key === 'lowStock') return compact ? 'Low' : 'Low Stock';
	  if(key === 'outOfStock') return compact ? 'Out' : 'Out of Stock';
	  if(key === 'qty') return compact ? 'Qty' : 'Total Qty';
	  return String(key || '');
	}
	function getTotalsValue(elId){
	  const el = $(elId);
	  if(!el) return null;
	  const dv = el.dataset ? String(el.dataset.value || '').trim() : '';
	  if(dv){
	    const v = Number(dv);
	    if(Number.isFinite(v)) return Math.trunc(v);
	  }
	  const m = /:\s*(\d+)/.exec(el.textContent || '');
	  if(!m) return null;
	  return toInt(m[1], 0);
	}
	function setTotalsMetric(elId, key, value){
	  const v = Math.max(0, toInt(value,0));
	  const el = $(elId);
	  if(el){
	    if(el.dataset) el.dataset.value = String(v);
	    el.textContent = `${totalsLabel(key)}: ${v}`;
	  }
	  // Update new stat cards
	  const statMap = {
	    totalItems: 'statTotalItems',
	    totalInStock: 'statInStock',
	    totalLowStock: 'statLowStock',
	    totalOutOfStock: 'statOutOfStock',
	    totalQty: 'statTotalQty'
	  };
	  const statElId = statMap[elId];
	  if(statElId){
	    const statEl = $(statElId);
	    if(statEl) statEl.textContent = v.toLocaleString();
	  }
	}
    function refreshTotalsLabels(){
      const vItems = getTotalsValue('totalItems'); if(vItems !== null) setTotalsMetric('totalItems','items', vItems);
      const vStock = getTotalsValue('totalInStock'); if(vStock !== null) setTotalsMetric('totalInStock','inStock', vStock);
      const vLow = getTotalsValue('totalLowStock'); if(vLow !== null) setTotalsMetric('totalLowStock','lowStock', vLow);
      const vOut = getTotalsValue('totalOutOfStock'); if(vOut !== null) setTotalsMetric('totalOutOfStock','outOfStock', vOut);
      const vQty = getTotalsValue('totalQty'); if(vQty !== null) setTotalsMetric('totalQty','qty', vQty);
    }
    function updateInventoryStickyOffset(){
      const header = document.querySelector('header');
      const toolbar = document.querySelector('#appMain .toolbar');
      const headerHeight = header ? header.getBoundingClientRect().height : 0;
      const toolbarHeight = toolbar ? toolbar.getBoundingClientRect().height : 0;
      const offset = Math.round(headerHeight + toolbarHeight + 6);
      if(headerHeight > 0){
        document.documentElement.style.setProperty('--app-header-offset', `${Math.round(headerHeight)}px`);
      }
      document.documentElement.style.setProperty('--inventory-sticky-offset', `${offset}px`);
    }
	    function renderTable(columnDefsOverride, layoutOverride){
		      const config = getInventoryColumnConfig();
	      const layout = layoutOverride || getInventoryLayoutFromConfig(config);
	      let columnDefs = Array.isArray(columnDefsOverride) ? columnDefsOverride.slice() : null;
	      if(!columnDefs){
	        columnDefs = Array.isArray(layout.columnDefs) ? layout.columnDefs.slice() : getInventoryColumnDefsFromConfig(config);
	      }
	      _inventoryActiveColumns = columnDefs.slice();
	      applySortIndicators();
		      const tbody=$('#invTable').querySelector('tbody'); tbody.innerHTML='';
		      const term=(state._filter||'').trim().toLowerCase();

      let items = applyInventoryQuickFilter(state.items);
      if(term){
        items = items.filter(it=>{
          const name=(it.name||'').toLowerCase();
          const desc=(it.desc||'').toLowerCase();
          const qty = String(toInt(it.qty,0));
          return name.includes(term) || desc.includes(term) || qty.includes(term);
        });
      }
      items = sortItems(items);
      const incomingMap = buildInventoryIncomingMap();
      state._incomingByItemId = incomingMap;
		      // Calculate stats from ALL items, not filtered items
		      const allItems = Array.isArray(state.items) ? state.items : [];
		      const totalItems = allItems.length;
		      const totalQty = allItems.reduce((sum, it) => sum + toInt(it.qty,0), 0);
		      let inStock = 0, lowStock = 0, outOfStock = 0;
		      for(const it of allItems){
		        const qty = toInt(it && it.qty, 0);
		        if(qty === 0){ outOfStock++; }
		        else {
		          const minStock = effectiveLowStockQty(it);
		          if(qty <= minStock) lowStock++;
		          else inStock++;
		        }
		      }
		      setTotalsMetric('totalItems', 'items', totalItems);
		      setTotalsMetric('totalQty', 'qty', totalQty);
		      setTotalsMetric('totalInStock', 'inStock', inStock);
		      setTotalsMetric('totalLowStock', 'lowStock', lowStock);
		      setTotalsMetric('totalOutOfStock', 'outOfStock', outOfStock);
		      if(items.length===0){
	      const tr=document.createElement('tr');
	      const colCount = 1 + columnDefs.length + (layout.showActions ? 1 : 0);
	      tr.innerHTML = '<td colspan="'+colCount+'" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
	      tbody.appendChild(tr);
      return;
      }
				      for(const it of items){
				        const tr=document.createElement('tr'); tr.dataset.id=it.id;
				        const inOrder = isItemInOrder(it.id);
				        if(inOrder) tr.classList.add('order-selected');
				        const isExpanded = _expandedCardId && String(it.id) === String(_expandedCardId);
				        if(isExpanded) tr.classList.add('card-expanded');
				        tr.innerHTML = buildRowHTML(it, columnDefs, layout);
				        tbody.appendChild(tr);
				        if(isExpanded){
				          const detailRow = document.createElement('tr');
				          detailRow.className = 'inv-detail-row';
				          detailRow.dataset.detailId = String(it.id || '');
				          detailRow.innerHTML = buildInventoryDetailRow(it, layout, incomingMap);
				          tbody.appendChild(detailRow);
				        }
				      }
	      enableInlineEditing();
	      try{ initButtonSystem.refresh(); }catch(e){}
	      try{ requestAnimationFrame(()=>{ adjustTitleSize(); }); }catch(e){}
	    }

      let _inventoryLayoutTimer = null;
      function refreshInventoryLayout(){
        const config = getInventoryColumnConfig();
        _inventoryLayoutSig = '';
        renderInventoryTableShell(config);
        renderTable();
        // Also render cards if in card view mode
        if(_invViewMode === 'cards'){
          try{ renderInventoryCards(); }catch(e){}
        }
      }
      function scheduleInventoryLayoutRefresh(){
        if(_inventoryLayoutTimer) clearTimeout(_inventoryLayoutTimer);
        _inventoryLayoutTimer = setTimeout(()=>{
          _inventoryLayoutTimer = null;
              try{ refreshInventoryLayout(); }catch(e){}
          try{ adjustTitleSize(); }catch(e){}
          try{ setEditHint(); }catch(e){}
          try{ refreshTotalsLabels(); }catch(e){}
        }, 120);
      }

    /* ============================================
       Inventory View Toggle & Card Rendering
       ============================================ */
    const INV_VIEW_MODE_KEY = 'inventoryViewMode';
    let _invViewMode = 'table'; // 'cards' or 'table'

    function getInventoryViewMode(){
      try{
        const stored = localStorage.getItem(INV_VIEW_MODE_KEY);
        if(stored === 'cards' || stored === 'table') return stored;
      }catch(e){}
      return 'table';
    }
    function saveInventoryViewMode(mode){
      try{ localStorage.setItem(INV_VIEW_MODE_KEY, mode); }catch(e){}
    }

    function setInventoryViewMode(mode){
      _invViewMode = mode === 'cards' ? 'cards' : 'table';
      saveInventoryViewMode(_invViewMode);
      const btnCards = $('btnViewCards');
      const btnTable = $('btnViewTable');
      const cardGrid = $('invCardGrid');
      const tableWrap = $('tableWrap');
      if(btnCards){
        btnCards.classList.toggle('is-active', _invViewMode === 'cards');
        btnCards.setAttribute('aria-pressed', _invViewMode === 'cards' ? 'true' : 'false');
      }
      if(btnTable){
        btnTable.classList.toggle('is-active', _invViewMode === 'table');
        btnTable.setAttribute('aria-pressed', _invViewMode === 'table' ? 'true' : 'false');
      }
      if(cardGrid) cardGrid.style.display = _invViewMode === 'cards' ? '' : 'none';
      if(tableWrap) tableWrap.style.display = _invViewMode === 'table' ? '' : 'none';
      if(_invViewMode === 'cards') renderInventoryCards();
    }

    function getStockStatus(item){
      const qty = toInt(item && item.qty, 0);
      if(qty === 0) return 'out';
      const minStock = effectiveLowStockQty(item);
      if(qty <= minStock) return 'low';
      return 'good';
    }

    function renderInventoryCards(){
      const cardGrid = $('invCardGrid');
      if(!cardGrid) return;
      let items = getFilteredInventoryItems();
      if(!items || items.length === 0){
        cardGrid.innerHTML = '';
        return;
      }
      const config = getInventoryColumnConfig();
      const order = Array.isArray(config.order) ? config.order : [];
      const visible = new Set(Array.isArray(config.visible) ? config.visible : []);
      const incomingMap = (state._incomingByItemId && typeof state._incomingByItemId.get === 'function')
        ? state._incomingByItemId
        : buildInventoryIncomingMap();
      state._incomingByItemId = incomingMap;
      items = sortItems(items);

      // Define field types for card layout
      const TEXT_FIELDS = new Set(['description', 'sku', 'location']);
      const STAT_FIELDS = new Set(['on_hand', 'incoming', 'reserved', 'available', 'reorder_point']);
      const FIELD_LABELS = {
        description: 'Desc',
        sku: 'SKU',
        location: 'Location',
        on_hand: 'On Hand',
        incoming: 'Incoming',
        reserved: 'Allocated',
        available: 'Available',
        reorder_point: 'Min Stock'
      };

      // Build ordered field lists based on config.order
      const orderedTextFields = order.filter(k => TEXT_FIELDS.has(k) && visible.has(k));
      const orderedStatFields = order.filter(k => STAT_FIELDS.has(k) && visible.has(k));
      const showStatus = visible.has('on_hand') || visible.has('reorder_point');

      const html = items.map(item => {
        const status = getStockStatus(item);
        const ledClass = status === 'good' ? 'inv-led--good' : status === 'low' ? 'inv-led--low' : 'inv-led--out';
        const name = escapeHtml(String(item.name || ''));
        const id = escapeHtmlAttr(String(item.id || ''));
        const inOrder = isItemInOrder(item.id);
        const orderTitle = inOrder ? 'Remove from order' : 'Add to order';

        // Prepare field values
        const onHand = toInt(item.qty, 0);
        const reservedQty = (() => { const v = getInventoryReservedQty(item); return Number.isFinite(v) ? v : 0; })();
        const incomingEntry = incomingMap.get(String(item.id || '').trim());
        const incomingQty = incomingEntry ? Number(incomingEntry.qty || 0) : 0;
        const fieldValues = {
          description: escapeHtml(String(item.desc || '')),
          sku: escapeHtml(String(item.sku || '')),
          location: escapeHtml(inventoryLocationLabel(item) || ''),
          on_hand: onHand,
          incoming: incomingQty,
          reserved: reservedQty,
          available: Math.max(0, onHand - reservedQty),
          reorder_point: effectiveLowStockQty(item)
        };

        // Build body (text fields) in order
        const bodyHtml = orderedTextFields.map(key => {
          const val = fieldValues[key];
          if(!val) return '';
          const isDesc = key === 'description';
          return `<div class="inv-card-field">
            <span class="inv-card-field-label">${FIELD_LABELS[key]}</span>
            <span class="inv-card-field-value${isDesc ? ' is-desc' : ''}">${val}</span>
          </div>`;
        }).filter(Boolean).join('');

        // Build stats (numeric fields) in order
        const statsHtml = orderedStatFields.map(key => {
          const val = fieldValues[key];
          // Skip reserved if 0
          if(key === 'reserved' && val === 0) return '';
          let statClass = '';
          if(key === 'on_hand'){
            statClass = status === 'good' ? 'inv-card-stat--good' : status === 'low' ? 'inv-card-stat--low' : 'inv-card-stat--out';
          } else if(key === 'reserved'){
            statClass = 'inv-card-stat--reserved';
          } else {
            statClass = 'inv-card-stat--muted';
          }
          return `<div class="inv-card-stat ${statClass}">
            <span class="inv-card-stat-value">${val}</span>
            <span class="inv-card-stat-label">${FIELD_LABELS[key]}</span>
          </div>`;
        }).filter(Boolean).join('');

        // Status badge
        const statusBadgeHtml = status === 'low'
          ? '<span class="inv-status-badge inv-status-badge--low">âš  Low</span>'
          : status === 'out'
            ? '<span class="inv-status-badge inv-status-badge--out">Out</span>'
            : '';

        return `
          <div class="inv-card${inOrder ? ' order-selected' : ''}" role="listitem" data-item-id="${id}">
            <div class="inv-card-header">
              ${showStatus ? `<span class="inv-led ${ledClass}"></span>` : ''}
              <h3 class="inv-card-title">${name}</h3>
              <div class="inv-card-actions">
                ${isInventoryActionVisible('edit_item') && canItemsEdit()
                  ? `<button class="inv-card-action-btn" data-card-edit="${id}" title="Edit item" type="button">${ICONS.pencil}</button>`
                  : ''
                }
                ${isInventoryActionVisible('add_to_job')
                  ? `<button class="inv-card-action-btn" data-card-job="${id}" title="Add to job" type="button">${ICONS.briefcasePlus}</button>`
                  : ''
                }
                ${isInventoryActionVisible('order_item') && canOrdersCreate()
                  ? `<button class="inv-card-action-btn" data-card-order="${id}" title="${escapeHtmlAttr(orderTitle)}" type="button">${ICONS.shoppingCart}</button>`
                  : ''
                }
              </div>
            </div>
            ${bodyHtml ? `<div class="inv-card-body">${bodyHtml}</div>` : ''}
            ${statsHtml || (showStatus && statusBadgeHtml) ? `<div class="inv-card-footer">
              ${statsHtml ? `<div class="inv-card-stats">${statsHtml}</div>` : ''}
              ${showStatus ? statusBadgeHtml : ''}
            </div>` : ''}
          </div>
        `;
      }).join('');
      cardGrid.innerHTML = html;
    }
    function refreshInventoryCardsForOrderState(){
      if(_invViewMode !== 'cards') return;
      try{ requestAnimationFrame(()=> renderInventoryCards()); }catch(e){}
    }

    function getFilteredInventoryItems(){
      // Get filtered items based on current filter and search
      const items = state.items;
      if(!items || !Array.isArray(items)) return [];
      const filterBox = $('filterBox');
      const search = filterBox ? String(filterBox.value || '').toLowerCase().trim() : '';
      const activeFilter = document.querySelector('.inv-filter-pill.is-active');
      const filter = activeFilter ? String(activeFilter.getAttribute('data-filter') || 'all') : 'all';

      return items.filter(item => {
        const status = getStockStatus(item);
        // Filter match - use getStockStatus() for consistency with stat cards
        if(filter === 'in_stock' && status !== 'good') return false;
        if(filter === 'low_stock' && status !== 'low') return false;
        if(filter === 'out_of_stock' && status !== 'out') return false;
        // Search match
        if(search){
          const name = String(item.name || '').toLowerCase();
          const desc = String(item.desc || '').toLowerCase();
          const sku = String(item.sku || '').toLowerCase();
          if(!name.includes(search) && !desc.includes(search) && !sku.includes(search)) return false;
        }
        return true;
      });
    }

    // Inventory header tabs toggle
    function initInventoryTabs(){
      let activeTab = null;
      const tabs = document.querySelectorAll('.inv-header-tab[data-inv-tab]');
      const contents = document.querySelectorAll('.inv-tab-content[data-inv-tab-content]');

      function closeActiveTab(){
        if(!activeTab) return;
        const tabBtn = document.querySelector(`.inv-header-tab[data-inv-tab="${activeTab}"]`);
        const tabContent = document.querySelector(`.inv-tab-content[data-inv-tab-content="${activeTab}"]`);
        if(tabBtn) tabBtn.classList.remove('is-active');
        if(tabContent) tabContent.classList.remove('is-active');
        tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
        activeTab = null;
      }

      function toggleTab(tabName){
        const tabBtn = document.querySelector(`.inv-header-tab[data-inv-tab="${tabName}"]`);
        const tabContent = document.querySelector(`.inv-tab-content[data-inv-tab-content="${tabName}"]`);

        if(activeTab === tabName){
          closeActiveTab();
          return;
        }

        // Close all tabs
        tabs.forEach(t => {
          t.classList.remove('is-active');
          t.setAttribute('aria-selected', 'false');
        });
        contents.forEach(c => c.classList.remove('is-active'));

        // Open selected tab
        if(tabBtn){
          tabBtn.classList.add('is-active');
          tabBtn.setAttribute('aria-selected', 'true');
        }
        if(tabContent) tabContent.classList.add('is-active');
        activeTab = tabName;
      }

      // Bind tab click handlers
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.getAttribute('data-inv-tab');
          if(tabName) toggleTab(tabName);
        });
      });

      document.addEventListener('click', (e)=>{
        if(!activeTab) return;
        const target = e && e.target ? e.target : null;
        if(target && target.closest){
          if(target.closest('.inv-header-tabs')) return;
          if(target.closest('.inv-tab-content')) return;
        }
        closeActiveTab();
      }, { passive:true });

      // Bind sort option handlers
      const sortOptions = document.querySelectorAll('.inv-sort-option[data-sort]');
      const mobileSort = $('mobileSort');
      sortOptions.forEach(opt => {
        opt.addEventListener('click', () => {
          const sortValue = opt.getAttribute('data-sort');
          if(!sortValue) return;

          // Update visual state
          sortOptions.forEach(o => o.classList.remove('is-active'));
          opt.classList.add('is-active');

          // Parse sort value and apply directly
          const parts = sortValue.split(':');
          const col = (parts[0] || '').trim();
          const current = getSort();
          let dir = (parts[1] || '').trim() === 'desc' ? 'desc' : 'asc';
          if(current && current.col === col){
            dir = current.dir === 'asc' ? 'desc' : 'asc';
          }
          if(col){
            state._sort = { col, dir };
          } else {
            state._sort = null;
          }
          renderTable();
          if(_invViewMode === 'cards') renderInventoryCards();
          save();

          // Also sync the hidden select for consistency
          if(mobileSort && col) mobileSort.value = `${col}:${dir}`;
        });
      });

      // Bind stat card click handlers for quick filtering
      const statCards = document.querySelectorAll('.inv-stat-card[data-stat-filter]');
      statCards.forEach(card => {
        card.addEventListener('click', () => {
          const filter = card.getAttribute('data-stat-filter');
          if(!filter) return;

          // Update stat card visual state
          statCards.forEach(c => c.classList.remove('is-active'));
          if(filter !== 'all') card.classList.add('is-active');

          // Trigger filter pill
          const pill = document.querySelector(`.inv-filter-pill[data-filter="${filter}"]`);
          if(pill) pill.click();
        });
      });

      // Bind layout button handlers (Grid/List)
      const layoutBtns = document.querySelectorAll('.inv-layout-btn');
      layoutBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          layoutBtns.forEach(b => b.classList.remove('is-active'));
          btn.classList.add('is-active');
        });
      });
    }

    function initInventoryViews(){
      _invViewMode = getInventoryViewMode();
      const btnCards = $('btnViewCards');
      const btnTable = $('btnViewTable');
      const resetBtn = $('btnResetFilters');
      const cardGrid = $('invCardGrid');

      // Set initial state
      if(btnCards){
        btnCards.classList.toggle('is-active', _invViewMode === 'cards');
        btnCards.setAttribute('aria-pressed', _invViewMode === 'cards' ? 'true' : 'false');
        btnCards.addEventListener('click', () => setInventoryViewMode('cards'));
      }
      if(btnTable){
        btnTable.classList.toggle('is-active', _invViewMode === 'table');
        btnTable.setAttribute('aria-pressed', _invViewMode === 'table' ? 'true' : 'false');
        btnTable.addEventListener('click', () => setInventoryViewMode('table'));
      }

      // Set initial display
      if(cardGrid) cardGrid.style.display = _invViewMode === 'cards' ? '' : 'none';
      const tableWrap = $('tableWrap');
      if(tableWrap) tableWrap.style.display = _invViewMode === 'table' ? '' : 'none';

      // Reset filters button
      if(resetBtn){
        resetBtn.addEventListener('click', () => {
          const filterBox = $('filterBox');
          if(filterBox) filterBox.value = '';
          document.querySelectorAll('.inv-filter-pill').forEach(pill => {
            pill.classList.remove('is-active');
            pill.setAttribute('aria-pressed', 'false');
          });
          const allPill = document.querySelector('.inv-filter-pill[data-filter="all"]');
          if(allPill){
            allPill.classList.add('is-active');
            allPill.setAttribute('aria-pressed', 'true');
          }
          setInventoryQuickFilter('all');
        });
      }

      // Card grid click handlers
      if(cardGrid){
        cardGrid.addEventListener('click', (e) => {
          const editBtn = e.target.closest('[data-card-edit]');
          if(editBtn){
            const id = String(editBtn.getAttribute('data-card-edit') || '').trim();
            if(id) openEditItemModal(id);
            return;
          }
          const jobBtn = e.target.closest('[data-card-job]');
          if(jobBtn){
            const id = String(jobBtn.getAttribute('data-card-job') || '').trim();
            if(id) openAddToJobModal(id);
            return;
          }
          const orderBtn = e.target.closest('[data-card-order]');
          if(orderBtn){
            const id = String(orderBtn.getAttribute('data-card-order') || '').trim();
            if(!id) return;
            if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
            toggleOrderLineForItemId(id);
            return;
          }
          // Card tap - use row tap preference
          const card = e.target.closest('.inv-card');
          if(card){
            const id = String(card.getAttribute('data-item-id') || '').trim();
            if(id) handleInventoryRowTap(id);
          }
        });
      }

      // Selection bar handlers
      const selectionBar = $('invSelectionBar');
      const btnClear = $('btnSelectionClear');
      const btnExport = $('btnSelectionExport');
      const btnDelete = $('btnSelectionDelete');
      if(btnClear){
        btnClear.addEventListener('click', () => {
          clearAllSelections();
          updateSelectionBar();
        });
      }
      if(btnExport){
        btnExport.addEventListener('click', () => {
          const selected = getSelectedItemIds();
          if(selected.length > 0) exportSelectedItems(selected);
        });
      }
      if(btnDelete){
        btnDelete.addEventListener('click', async () => {
          const selected = getSelectedItemIds();
          if(selected.length === 0) return;
          const confirmed = await openConfirmModal(
            'Delete Selected Items?',
            `This will permanently delete ${selected.length} item${selected.length === 1 ? '' : 's'}.`,
            { okText: 'Delete', cancelText: 'Cancel', danger: true }
          );
          if(confirmed) await deleteSelectedItems(selected);
        });
      }

      // Card rendering happens automatically via refreshInventoryLayout() when data loads
    }

    function getSelectedItemIds(){
      const checked = document.querySelectorAll('#invTable tbody input[type="checkbox"]:checked');
      const ids = [];
      checked.forEach(cb => {
        const tr = cb.closest('tr');
        if(tr && tr.dataset && tr.dataset.id) ids.push(tr.dataset.id);
      });
      return ids;
    }

    function clearAllSelections(){
      document.querySelectorAll('#invTable tbody input[type="checkbox"]:checked').forEach(cb => {
        cb.checked = false;
      });
      const chkAll = $('chkAll');
      if(chkAll) chkAll.checked = false;
    }

    function updateSelectionBar(){
      const selected = getSelectedItemIds();
      const bar = $('invSelectionBar');
      const count = $('invSelectionCount');
      if(!bar) return;
      if(selected.length > 0){
        bar.style.display = '';
        if(count) count.textContent = `${selected.length} selected`;
      }else{
        bar.style.display = 'none';
      }
    }

    async function exportSelectedItems(ids){
      const items = ids.map(id => getInventoryById(id)).filter(Boolean);
      if(items.length === 0) return;
      // Simple CSV export
      const headers = ['Item', 'Description', 'SKU', 'Qty', 'Reserved', 'Location'];
      const rows = items.map(i => [
        String(i.name || ''),
        String(i.desc || ''),
        String(i.sku || ''),
        String(i.qty || 0),
        String(i.reserved || 0),
        String(i.location || '')
      ]);
      const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c.replace(/"/g, '""')}"`).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `inventory-export-${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      toast(`Exported ${items.length} item${items.length === 1 ? '' : 's'}`);
    }

    async function deleteSelectedItems(ids){
      let deleted = 0;
      for(const id of ids){
        try{
          const result = await deleteInventoryItem(id);
          if(result) deleted++;
        }catch(e){}
      }
      clearAllSelections();
      updateSelectionBar();
      toast(`Deleted ${deleted} item${deleted === 1 ? '' : 's'}`);
      renderTable();
      if(_invViewMode === 'cards') renderInventoryCards();
    }

	    function initColumnBuilder(){
	      const btn = $('btnColumnBuilder'); // May be null in new inline design
	      const panel = $('columnBuilder');
	      const list = $('columnBuilderList');
	      const resetBtn = $('btnColumnsReset'); // May be null in new inline design
	      const closeBtn = $('btnColumnsClose'); // May be null in new inline design
	      const dragHandle = $('columnBuilderDrag'); // May be null in new inline design
	      const tapWrap = $('columnBuilderTap');
	      if(!panel || !list) return; // Only require panel and list for drag functionality
	      const syncTapUI = ()=>{
	        if(!tapWrap) return;
	        const allowed = getAllowedInventoryRowTapOptions();
	        tapWrap.querySelectorAll('[data-tap-option]').forEach(label=>{
	          const key = String(label.getAttribute('data-tap-option') || '').trim();
	          const visible = allowed.has(key);
	          label.style.display = visible ? '' : 'none';
	          const input = label.querySelector('input[name="rowTapPref"]');
	          if(input) input.disabled = !visible;
	        });
	        const pref = getInventoryRowTapPref();
	        tapWrap.querySelectorAll('input[name="rowTapPref"]').forEach(input=>{
	          input.checked = String(input.value || '') === pref;
	        });
	      };

	      const applyPanelOffset = (x, y)=>{
	        if(panel.classList.contains('column-builder--centered')) return;
	        const nx = Number.isFinite(x) ? x : 0;
	        const ny = Number.isFinite(y) ? y : 0;
	        panel.dataset.offsetX = String(nx);
	        panel.dataset.offsetY = String(ny);
	        panel.style.transform = `translate(${nx}px, ${ny}px)`;
	      };
	      const getPanelOffset = ()=>{
	        const x = Number(panel.dataset.offsetX || '0');
	        const y = Number(panel.dataset.offsetY || '0');
	        return { x: Number.isFinite(x) ? x : 0, y: Number.isFinite(y) ? y : 0 };
	      };
	      const open = ()=>{
	        getInventoryColumnConfig();
	        const mobile = isMobileUx();
	        panel.classList.toggle('column-builder--centered', mobile);
	        if(mobile){
	          panel.dataset.offsetX = '0';
	          panel.dataset.offsetY = '0';
	          panel.style.transform = '';
	        }else{
	          const offset = getPanelOffset();
	          applyPanelOffset(offset.x, offset.y);
	        }
	        panel.classList.add('open');
	        panel.setAttribute('aria-hidden', 'false');
	        if(btn) btn.setAttribute('aria-expanded', 'true');
	        syncTapUI();
	      };
	      const close = ()=>{
	        panel.classList.remove('open');
	        panel.setAttribute('aria-hidden', 'true');
	        if(btn) btn.setAttribute('aria-expanded', 'false');
	      };

	      if(btn && !btn._wired){
	        btn._wired = true;
	        btn.addEventListener('click', (e)=>{
	          e.preventDefault();
	          e.stopPropagation();
	          if(panel.classList.contains('open')) close();
	          else open();
	        });
	      }
	      if(closeBtn && !closeBtn._wired){
	        closeBtn._wired = true;
	        closeBtn.addEventListener('click', (e)=>{
	          e.preventDefault();
	          close();
	        });
	      }
	      if(dragHandle && !dragHandle._wired){
	        dragHandle._wired = true;
	        dragHandle.addEventListener('pointerdown', (e)=>{
	          if(!panel.classList.contains('open')) return;
	          if(panel.classList.contains('column-builder--centered')) return;
	          e.preventDefault();
	          const start = getPanelOffset();
	          const startX = e.clientX;
	          const startY = e.clientY;
	          panel.classList.add('dragging-panel');
	          const onMove = (ev)=>{
	            const nx = start.x + (ev.clientX - startX);
	            const ny = start.y + (ev.clientY - startY);
	            applyPanelOffset(nx, ny);
	          };
	          const onUp = ()=>{
	            panel.classList.remove('dragging-panel');
	            document.removeEventListener('pointermove', onMove);
	            document.removeEventListener('pointerup', onUp);
	          };
	          document.addEventListener('pointermove', onMove);
	          document.addEventListener('pointerup', onUp);
	        });
	      }
	      if(resetBtn && !resetBtn._wired){
	        resetBtn._wired = true;
	        resetBtn.addEventListener('click', (e)=>{
	          e.preventDefault();
	          saveInventoryColumnConfig({ order: defaultInventoryOrder(), visible: defaultInventoryVisibleKeys() });
	          getInventoryColumnConfig();
	          renderTable();
	          if(_invViewMode === 'cards') renderInventoryCards();
	          syncTapUI();
	        });
	      }
	      if(tapWrap && !tapWrap._wired){
	        tapWrap._wired = true;
	        tapWrap.addEventListener('change', (e)=>{
	          const target = e.target;
	          if(!target || !target.matches || !target.matches('input[name="rowTapPref"]')) return;
	          setInventoryRowTapPref(String(target.value || ''));
	        });
	      }
	      if(!list._wired){
	        list._wired = true;
	        const dragState = list._dragState || { key:null, overEl:null, lastTargetKey:null, lastAfter:null, initialOrder:null, dropped:false };
	        list._dragState = dragState;

	        const getListOrder = ()=> Array.from(list.querySelectorAll('.column-option'))
	          .map(el => el.getAttribute('data-col-key'))
	          .filter(Boolean);
	        const updateTablePreview = (order)=>{
	          const config = loadInventoryColumnConfig();
	          const nextOrder = normalizeInventoryOrder(order);
	          const previewConfig = { order: nextOrder, visible: config.visible };
	          const layout = getInventoryLayoutFromConfig(previewConfig, { force:true });
	          const columnDefs = layout.columnDefs;
	          renderInventoryTableShell(previewConfig);
	          renderTable(columnDefs, layout);
	        };
	        const clearDragStyles = ()=>{
	          list.querySelectorAll('.column-option.drag-over').forEach(el=> el.classList.remove('drag-over'));
	          list.querySelectorAll('.column-option.dragging').forEach(el=> el.classList.remove('dragging'));
	          dragState.overEl = null;
	        };
	        const capturePositions = ()=>{
	          const map = new Map();
	          list.querySelectorAll('.column-option').forEach(el=>{
	            map.set(el.dataset.colKey, el.getBoundingClientRect());
	          });
	          return map;
	        };
	        const animateReorder = (firstRects)=>{
	          requestAnimationFrame(()=>{
	            list.querySelectorAll('.column-option').forEach(el=>{
	              const first = firstRects.get(el.dataset.colKey);
	              if(!first) return;
	              const last = el.getBoundingClientRect();
	              const deltaY = first.top - last.top;
	              if(Math.abs(deltaY) < 1) return;
	              el.style.transform = `translateY(${deltaY}px)`;
	              el.style.transition = 'transform 0s';
	              requestAnimationFrame(()=>{
	                el.style.transition = '';
	                el.style.transform = '';
	              });
	            });
	          });
	        };
	        const moveDomItem = (dragKey, targetKey, insertAfter)=>{
	          const draggingEl = list.querySelector(`.column-option[data-col-key="${dragKey}"]`);
	          const targetEl = list.querySelector(`.column-option[data-col-key="${targetKey}"]`);
	          if(!draggingEl || !targetEl || draggingEl === targetEl) return false;
	          if(targetKey === INVENTORY_ANCHOR_KEY) insertAfter = true;
	          const firstRects = capturePositions();
	          if(insertAfter){
	            if(targetEl.nextSibling !== draggingEl) targetEl.after(draggingEl);
	          }else{
	            if(targetEl.previousSibling !== draggingEl) targetEl.before(draggingEl);
	          }
	          animateReorder(firstRects);
	          return true;
	        };

	        list.addEventListener('change', (e)=>{
	          const target = e.target;
	          if(!target || !target.matches || !target.matches('input[type="checkbox"][data-col-key]')) return;
	          const key = target.getAttribute('data-col-key');
	          if(!key) return;
	          const config = loadInventoryColumnConfig();
	          const visible = new Set(config.visible || []);
	          if(target.checked) visible.add(key); else visible.delete(key);
	          visible.add(INVENTORY_ANCHOR_KEY);
	          const next = {
	            order: config.order,
	            visible: normalizeInventoryVisible(Array.from(visible), config.order)
	          };
	          saveInventoryColumnConfig(next);
	          getInventoryColumnConfig();
	          renderTable();
	          if(_invViewMode === 'cards') renderInventoryCards();
	        });
	        // Pointer-based drag for real-time row movement
	        list.addEventListener('pointerdown', (e)=>{
	          const handle = e.target && e.target.closest ? e.target.closest('.drag-handle') : null;
	          if(!handle || handle.classList.contains('disabled')) return;
	          const row = handle.closest('.column-option');
	          if(!row) return;
	          if(String(row.getAttribute('data-draggable') || '') !== 'true') return;
	          const key = row.getAttribute('data-col-key');
	          if(!key || key === INVENTORY_ANCHOR_KEY) return;
	          e.preventDefault();

	          // Capture initial state
	          const rect = row.getBoundingClientRect();
	          dragState.key = key;
	          dragState.initialOrder = getListOrder();
	          dragState.offsetX = e.clientX - rect.left;
	          dragState.offsetY = e.clientY - rect.top;

	          // Create placeholder in original position
	          const placeholder = document.createElement('div');
	          placeholder.className = 'column-option drag-placeholder';
	          placeholder.style.height = rect.height + 'px';
	          placeholder.setAttribute('data-placeholder', 'true');
	          row.parentNode.insertBefore(placeholder, row);
	          dragState.placeholder = placeholder;

	          // Move row to body to avoid transform issues with position:fixed
	          document.body.appendChild(row);
	          row.classList.add('dragging');
	          row.style.width = rect.width + 'px';
	          row.style.left = (e.clientX - dragState.offsetX) + 'px';
	          row.style.top = (e.clientY - dragState.offsetY) + 'px';

	          // iOS-style drag with hysteresis to prevent glitching
	          const SWAP_THRESHOLD = 20; // pixels to trigger initial swap
	          const HYSTERESIS = 30; // extra pixels needed to reverse direction
	          let lastSwapDirection = null; // 'up', 'down', or null
	          let lastSwapY = null; // cursor Y when last swap occurred

	          const onMove = (ev)=>{
	            if(!dragState.key) return;
	            row.style.left = (ev.clientX - dragState.offsetX) + 'px';
	            row.style.top = (ev.clientY - dragState.offsetY) + 'px';

	            const placeholderRect = placeholder.getBoundingClientRect();
	            const placeholderMid = placeholderRect.top + placeholderRect.height / 2;
	            const cursorY = ev.clientY;

	            // Calculate thresholds with hysteresis
	            // If last swap was UP, need to move further DOWN to reverse (and vice versa)
	            const upThreshold = lastSwapDirection === 'down'
	              ? placeholderMid - SWAP_THRESHOLD - HYSTERESIS
	              : placeholderMid - SWAP_THRESHOLD;
	            const downThreshold = lastSwapDirection === 'up'
	              ? placeholderMid + SWAP_THRESHOLD + HYSTERESIS
	              : placeholderMid + SWAP_THRESHOLD;

	            if(cursorY < upThreshold){
	              // Dragging UP - find item directly above placeholder
	              const itemAbove = placeholder.previousElementSibling;
	              if(itemAbove && itemAbove.classList.contains('column-option') && !itemAbove.hasAttribute('data-placeholder')){
	                const targetKey = itemAbove.getAttribute('data-col-key');
	                if(targetKey && targetKey !== INVENTORY_ANCHOR_KEY){
	                  // FLIP animation
	                  const firstRect = itemAbove.getBoundingClientRect();
	                  itemAbove.before(placeholder);
	                  const lastRect = itemAbove.getBoundingClientRect();
	                  const deltaY = firstRect.top - lastRect.top;
	                  if(Math.abs(deltaY) > 1){
	                    itemAbove.style.transform = `translateY(${deltaY}px)`;
	                    itemAbove.style.transition = 'transform 0s';
	                    requestAnimationFrame(()=>{
	                      itemAbove.style.transition = '';
	                      itemAbove.style.transform = '';
	                    });
	                  }
	                  lastSwapDirection = 'up';
	                  lastSwapY = cursorY;
	                }
	              }
	            } else if(cursorY > downThreshold){
	              // Dragging DOWN - find item directly below placeholder
	              const itemBelow = placeholder.nextElementSibling;
	              if(itemBelow && itemBelow.classList.contains('column-option') && !itemBelow.hasAttribute('data-placeholder')){
	                const targetKey = itemBelow.getAttribute('data-col-key');
	                if(targetKey && targetKey !== INVENTORY_ANCHOR_KEY){
	                  // FLIP animation
	                  const firstRect = itemBelow.getBoundingClientRect();
	                  itemBelow.after(placeholder);
	                  const lastRect = itemBelow.getBoundingClientRect();
	                  const deltaY = firstRect.top - lastRect.top;
	                  if(Math.abs(deltaY) > 1){
	                    itemBelow.style.transform = `translateY(${deltaY}px)`;
	                    itemBelow.style.transition = 'transform 0s';
	                    requestAnimationFrame(()=>{
	                      itemBelow.style.transition = '';
	                      itemBelow.style.transform = '';
	                    });
	                  }
	                  lastSwapDirection = 'down';
	                  lastSwapY = cursorY;
	                }
	              }
	            }
	          };

	          const onUp = ()=>{
	            if(!dragState.key) return;
	            document.removeEventListener('pointermove', onMove);
	            document.removeEventListener('pointerup', onUp);

	            // Clear styles before moving back
	            row.classList.remove('dragging');
	            row.style.width = '';
	            row.style.left = '';
	            row.style.top = '';

	            // Move row back to list at placeholder position
	            if(dragState.placeholder && dragState.placeholder.parentNode){
	              dragState.placeholder.parentNode.insertBefore(row, dragState.placeholder);
	              dragState.placeholder.remove();
	            }

	            // Save new order
	            const config = loadInventoryColumnConfig();
	            const order = normalizeInventoryOrder(getListOrder());
	            saveInventoryColumnConfig({ order, visible: config.visible });
	            getInventoryColumnConfig();
	            const layout = getInventoryLayoutFromConfig({ order, visible: config.visible }, { force: true });
	            renderInventoryTableShell({ order, visible: config.visible });
	            renderTable(layout.columnDefs, layout);
	            if(_invViewMode === 'cards') renderInventoryCards();

	            dragState.key = null;
	            dragState.placeholder = null;
	          };

	          document.addEventListener('pointermove', onMove);
	          document.addEventListener('pointerup', onUp);
	        });
	      }

	      if(!initColumnBuilder._wired){
	        initColumnBuilder._wired = true;
	        document.addEventListener('click', (e)=>{
	          if(!panel.classList.contains('open')) return;
	          if(panel.contains(e.target) || (btn && btn.contains(e.target))) return;
	          close();
	        });
	        document.addEventListener('keydown', (e)=>{
	          if(e.key === 'Escape') close();
	        });
	      }
	    }

    function enableInlineEditing(){
      return;
      const tbody=$('#invTable').querySelector('tbody');
      const editableCols = new Set(['name','desc','qty']);
      tbody.querySelectorAll('td').forEach(td=>{
        if(td.classList.contains('sel')) return; // skip checkbox column
        const col = td.getAttribute('data-col');
        if(!editableCols.has(col)) return;
        td.addEventListener('click', (e)=> startCellEdit(td, e));
        td.addEventListener('dblclick', (e)=> startCellEdit(td, e));
      });
    }

    // Mobile-friendly modal editor (helps iOS cursor/precision issues)
    let _editItemCtx = null;
    let _lastEditHintPref = null;
    const _qtyCommit = new Map(); // id -> { timer, desiredQty, inFlight }
    const _qtyReposition = new Map(); // id -> timer for debounced row repositioning
    const _qtyLedSync = new Map(); // id -> timer for debounced low stock LED sync

    function isIOS(){
      try{
        const ua = navigator.userAgent || '';
        const platform = navigator.platform || '';
        return /iPad|iPhone|iPod/.test(ua) || (platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }catch(e){ return false; }
    }
    function prefersModalEditing(){
      try{
        if(isIOS()) return true;
        const hasTouch = ('ontouchstart' in window) || (navigator && navigator.maxTouchPoints > 0);
        if(!hasTouch) return false;
        return window.matchMedia && (
          window.matchMedia('(pointer: coarse)').matches ||
          window.matchMedia('(hover: none)').matches ||
          window.matchMedia('(max-width: 768px)').matches
        );
      }catch(e){ return false; }
    }
	    function setEditHint(){
	      const el = $('editHint');
	      if(!el) return;
	      if(SB.session && SB.authorized && !canUpdate()){
	        el.textContent = 'Read-only access.';
	        _lastEditHintPref = 'readonly';
	        return;
	      }
	      el.textContent = 'Use the pencil icon to edit item details.';
	      _lastEditHintPref = 'icon';
	    }

    function setEditItemMessage(msg){
      const el = $('editItemMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function closeEditItemModal(){
      _editItemCtx = null;
      setEditItemMessage('');
      show('editItemModal', false);
    }
	    const DEFAULT_UOM_OPTIONS = ['Each','Box','Case','Pack','Pallet','Set','Pair','Roll','Foot','Meter'];
	    function renderEditItemUomOptions(selected){
	      const select = $('editItemUom');
	      if(!select) return;
	      const values = new Set(DEFAULT_UOM_OPTIONS);
	      (state.items || []).forEach(it=>{
	        const val = String(it.unitOfMeasure || '').trim();
	        if(val) values.add(val);
	      });
	      const current = String(selected || '').trim();
	      const sorted = Array.from(values.values()).sort((a,b)=> a.localeCompare(b));
	      select.innerHTML = `<option value="">Unspecified</option>` + sorted.map(val => (
	        `<option value="${escapeHtmlAttr(val)}">${escapeHtml(val)}</option>`
	      )).join('');
	      if(current && !values.has(current)){
	        const opt = document.createElement('option');
	        opt.value = current;
	        opt.textContent = current;
	        opt.selected = true;
	        select.appendChild(opt);
	      }
	      select.value = current || '';
	    }
	    function renderEditItemLocationOptions(selectedId){
	      const select = $('editItemLocation');
	      if(!select) return;
	      const current = String(selectedId || '').trim();
	      const rows = Array.isArray(state._companyLocations) ? state._companyLocations : [];
	      const active = rows.filter(r => r && r.is_active);
	      select.innerHTML = `<option value="">Unassigned</option>` + active.map(row => (
	        `<option value="${escapeHtmlAttr(String(row.id || ''))}">${escapeHtml(String(row.name || 'Location'))}</option>`
	      )).join('');
	      if(current && !active.some(row => String(row.id || '') === current)){
	        const opt = document.createElement('option');
	        opt.value = current;
	        opt.textContent = current;
	        opt.selected = true;
	        select.appendChild(opt);
	      }
	      select.value = current || '';
	    }
	    function renderEditItemCategoryOptions(selectedId){
	      const input = $('editItemCategory');
	      const list = $('editItemCategoryList');
	      if(!input || !list) return;
	      const current = String(selectedId || '').trim();
	      const values = new Set();
	      (state.items || []).forEach(it=>{
	        const val = String(it.categoryId || '').trim();
	        if(val) values.add(val);
	      });
	      const sorted = Array.from(values.values()).sort((a,b)=> a.localeCompare(b));
	      list.innerHTML = sorted.map(val => `<option value="${escapeHtmlAttr(val)}"></option>`).join('');
	      input.value = current;
	    }
	    async function ensureEditItemLookups(selectedLocationId, selectedCategoryId, selectedUom){
	      renderEditItemUomOptions(selectedUom);
	      renderEditItemCategoryOptions(selectedCategoryId);
	      renderEditItemLocationOptions(selectedLocationId);
	      // Always refresh locations to ensure we have current company's locations
	      try{
	        await loadCompanyLocations();
	      }catch(e){}
	      renderEditItemLocationOptions(selectedLocationId);
	    }
	    function openEditItemModal(id){
	      if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
	      const it = state.items.find(x=> x.id===id); if(!it) return;
	      _editItemCtx = { id };

	      // Details tab
	      const name = $('editItemName'); if(name) name.value = String(it.name||'');
	      const sku = $('editItemSku'); if(sku) sku.value = String(it.sku||'');
	      const desc = $('editItemDesc'); if(desc) desc.value = String(it.desc||'');

      // Inventory tab - display-only values
      updateEditItemInventoryDisplay();

	      // Settings tab
	      const lowStockOverride = getItemLowStockQtyOverride(it);
	      const reorderPointValue = (Object.prototype.hasOwnProperty.call(it, 'reorderPoint') && it.reorderPoint !== null && typeof it.reorderPoint !== 'undefined')
	        ? it.reorderPoint
	        : lowStockOverride;
	      const lowStockQty = $('editLowStockQty');
	      const rpVal = (reorderPointValue === null) ? 0 : reorderPointValue;
	      if(lowStockQty) lowStockQty.value = String(rpVal);
	      const rpDisplay = $('editReorderPointValue'); if(rpDisplay) rpDisplay.textContent = String(rpVal);

	      const reorderQty = $('editItemReorderQty');
	      const rqVal = (it.reorderQty === null || typeof it.reorderQty === 'undefined') ? 0 : toInt(it.reorderQty, 0);
	      if(reorderQty) reorderQty.value = String(rqVal);
	      const rqDisplay = $('editReorderQtyValue'); if(rqDisplay) rqDisplay.textContent = String(rqVal);

		      const uomValue = String(it.unitOfMeasure || '').trim();
		      const locationId = String(it.locationId || '').trim();
		      const categoryId = String(it.categoryId || '').trim();
		      void ensureEditItemLookups(locationId, categoryId, uomValue);
		      const reorderEnabled = $('editReorderEnabled');
		      if(reorderEnabled) reorderEnabled.checked = getItemReorderEnabled(it);

	      // Update dynamic header
	      updateEditItemHeader();

	      // Reset to first tab
	      switchEditItemTab('details');

	      setEditItemMessage('');
	      show('editItemModal', true);
	      setTimeout(()=>{
	        const inp = $('editItemName');
        if(!inp) return;
        inp.focus();
        try{ inp.select(); }catch(e){}
      }, 0);
    }

    // Edit Item Tab Switching
    function switchEditItemTab(tab){
      const tabs = document.querySelectorAll('.edit-tab');
      const panels = document.querySelectorAll('.edit-tab-content');
      tabs.forEach(t => {
        const isActive = t.dataset.tab === tab;
        t.classList.toggle('is-active', isActive);
        t.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      panels.forEach(p => {
        p.classList.toggle('is-active', p.dataset.tab === tab);
      });
    }

    // Update dynamic header based on current item state
    function updateEditItemHeader(){
      const nameInput = $('editItemName');
      const skuInput = $('editItemSku');
      const locationSelect = $('editItemLocation');
      const title = $('editItemTitle');
      const subtitle = $('editItemSubtitle');

      const itemName = nameInput ? String(nameInput.value || '').trim() : '';
      const skuVal = skuInput ? String(skuInput.value || '').trim() : '';
      const locVal = locationSelect ? String(locationSelect.options[locationSelect.selectedIndex]?.text || '').trim() : '';

      if(title) title.textContent = itemName || 'Edit Item';

      const skuPart = skuVal || 'No SKU';
      const locPart = (locVal && locVal !== 'Unassigned') ? locVal : 'Unassigned';
      if(subtitle) subtitle.textContent = `${skuPart} Â· ${locPart}`;
    }

    // Update inventory display (derived, read-only)
    function updateEditItemInventoryDisplay(){
      const onHandDisplay = $('editInvOnHandValue');
      const incomingDisplay = $('editInvIncomingValue');
      const allocatedDisplay = $('editInvAllocatedValue');
      const remainingDisplay = $('editInvRemainingValue');

      const ctx = _editItemCtx;
      const itemId = ctx && ctx.id ? String(ctx.id) : '';
      const it = itemId ? state.items.find(x=> x && x.id === itemId) : null;
      const onHand = it ? toInt(it.qty, 0) : 0;
      const reservedRaw = it ? getInventoryReservedQty(it) : 0;
      const allocated = Number.isFinite(reservedRaw) ? reservedRaw : 0;
      const incomingMap = (state._incomingByItemId && typeof state._incomingByItemId.get === 'function')
        ? state._incomingByItemId
        : buildInventoryIncomingMap();
      state._incomingByItemId = incomingMap;
      const incomingEntry = itemId ? incomingMap.get(itemId) : null;
      const incomingQty = incomingEntry ? Number(incomingEntry.qty || 0) : 0;
      const remaining = onHand - allocated;

      if(onHandDisplay) onHandDisplay.textContent = formatQty(onHand);
      if(incomingDisplay) incomingDisplay.textContent = formatQty(incomingQty);
      if(allocatedDisplay) allocatedDisplay.textContent = formatQty(allocated);
      if(remainingDisplay){
        remainingDisplay.textContent = formatQty(remaining);
        remainingDisplay.classList.remove('positive', 'negative');
        if(remaining > 0) remainingDisplay.classList.add('positive');
        else if(remaining < 0) remainingDisplay.classList.add('negative');
      }
    }
	    function bumpEditItemLowStockQty(delta){
	      const inp = $('editLowStockQty'); if(!inp) return;
	      const curRaw = String(inp.value ?? '').trim();
	      const cur = (curRaw === '') ? 0 : toInt(curRaw, 0);
	      const step = toSignedInt(delta, 0);
	      const nv = Math.max(0, cur + step);
	      inp.value = String(nv);
	      // Update display
	      const display = $('editReorderPointValue');
	      if(display) display.textContent = String(nv);
	    }
	    function bumpEditItemReorderQty(delta){
	      const inp = $('editItemReorderQty'); if(!inp) return;
	      const curRaw = String(inp.value ?? '').trim();
	      const cur = (curRaw === '') ? 0 : toInt(curRaw, 0);
	      const step = toSignedInt(delta, 0);
	      const nv = Math.max(0, cur + step);
	      inp.value = String(nv);
	      // Update display
	      const display = $('editReorderQtyValue');
	      if(display) display.textContent = String(nv);
	    }

    async function commitItemUpdate(id, updates){
      const it = state.items.find(x=> x.id===id);
      if(!it) throw Error('Item not found');

      const fields = {};
      if(updates && 'name' in updates){
        const nv = String(updates.name||'').trim();
        if(!nv) throw Error('Name required');
        const prev = String(it.name||'');
        if(nv !== prev){
          if(toKey(nv)!==toKey(prev) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))) throw Error('Duplicate name');
          fields.name = nv;
        }
      }
      if(updates && 'desc' in updates){
        const nv = String(updates.desc||'').replace(/[\r\n]+/g,' ').trim();
        const prev = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
        if(nv !== prev) fields.desc = nv;
      }
      if(updates && 'sku' in updates){
        const nv = String(updates.sku||'').trim();
        const prev = String(it.sku||'').trim();
        if(nv !== prev) fields.sku = nv;
      }
      if(updates && 'unitOfMeasure' in updates){
        const nv = String(updates.unitOfMeasure||'').trim();
        const prev = String(it.unitOfMeasure||'').trim();
        if(nv !== prev) fields.unitOfMeasure = nv;
      }
      if(updates && 'locationId' in updates){
        const nv = String(updates.locationId||'').trim();
        const prev = String(it.locationId||'').trim();
        if(nv !== prev) fields.locationId = nv;
      }
      if(updates && 'categoryId' in updates){
        const nv = String(updates.categoryId||'').trim();
        const prev = String(it.categoryId||'').trim();
        if(nv !== prev) fields.categoryId = nv;
      }
	      if(updates && 'qty' in updates){
	        const q = toInt(updates.qty, -1); if(q < 0) throw Error('Qty must be integer â‰¥ 0');
	        const prev = toInt(it.qty, 0);
	        if(q !== prev) fields.qty = q;
	      }
	      if(updates && 'reorderPoint' in updates){
	        const raw = updates.reorderPoint;
	        let next = null;
	        if(!(raw === null || typeof raw === 'undefined' || String(raw).trim() === '')){
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Reorder point must be integer â‰¥ 0');
	          next = v;
	        }
	        const prev = Object.prototype.hasOwnProperty.call(it, 'reorderPoint') ? it.reorderPoint : null;
	        if(next !== prev) fields.reorderPoint = next;
	      }
	      if(updates && 'reorderQty' in updates){
	        const raw = updates.reorderQty;
	        let next = null;
	        if(!(raw === null || typeof raw === 'undefined' || String(raw).trim() === '')){
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Reorder qty must be integer â‰¥ 0');
	          next = v;
	        }
	        const prev = Object.prototype.hasOwnProperty.call(it, 'reorderQty') ? it.reorderQty : null;
	        if(next !== prev) fields.reorderQty = next;
	      }
	      if(updates && 'reorderEnabled' in updates){
	        const nv = !!updates.reorderEnabled;
	        const prev = getItemReorderEnabled(it);
	        if(nv !== prev) fields.reorderEnabled = nv;
	      }
	      if(updates && 'lowStockQty' in updates){
	        const raw = updates.lowStockQty;
	        let next = null;
	        if(!(raw === null || typeof raw === 'undefined' || String(raw).trim() === '')){
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Low stock qty must be integer â‰¥ 0');
	          next = v;
	        }
	        const prev = getItemLowStockQtyOverride(it);
	        if(next !== prev) fields.lowStockQty = next;
	      }

	      if(Object.keys(fields).length === 0) return;
	      await sbUpdateFields(id, fields);
	      await sbLoadSnapshot();
	    }
    async function commitItemField(id, col, rawValue){
      if(col==='name') return commitItemUpdate(id, { name: rawValue });
      if(col==='desc') return commitItemUpdate(id, { desc: rawValue });
      if(col==='qty')  return commitItemUpdate(id, { qty: rawValue });
      throw Error('Unknown field');
    }

	    async function autoSaveEditItem(){
	      if(!_editItemCtx) return false;
	      const modal = $('editItemModal');
	      if(!modal || modal.getAttribute('aria-hidden') === 'true') return false;
	      if(!requireOnline()) return false;

	      const id = _editItemCtx.id;
	      const name = $('editItemName') ? $('editItemName').value : '';
	      const sku = $('editItemSku') ? $('editItemSku').value : '';
	      const desc = $('editItemDesc') ? $('editItemDesc').value : '';
	      const unitOfMeasure = $('editItemUom') ? $('editItemUom').value : '';
	      const locationId = $('editItemLocation') ? $('editItemLocation').value : '';
	      const categoryId = $('editItemCategory') ? $('editItemCategory').value : '';
	      const lowStockQty = $('editLowStockQty') ? $('editLowStockQty').value : '';
	      const reorderQty = $('editItemReorderQty') ? $('editItemReorderQty').value : '';
	      const reorderEnabled = $('editReorderEnabled') ? $('editReorderEnabled').checked : true;

	      const btnCancel = $('btnEditItemCancel');
	      if(btnCancel) btnCancel.disabled = true;
	      setEditItemMessage('');

	      try{
	        await commitItemUpdate(id, { name, sku, desc, unitOfMeasure, locationId, categoryId, lowStockQty, reorderPoint: lowStockQty, reorderQty, reorderEnabled });
	        try{ syncLowStockOverrideIndicatorForRow(id); }catch(e){}
	        try{ syncLowStockIndicatorForRow(id); }catch(e){}
	        toast('Auto-saved', 'success');
	        return true;
	      }catch(e){
	        const msg = (e && e.message) ? e.message : 'Update failed';
	        setEditItemMessage(msg);
	        toast(msg);
	        return false;
      }finally{
        if(btnCancel) btnCancel.disabled = false;
	      }
	    }
	    let _editItemAutoSaveTimer = null;
	    function scheduleEditItemAutoSave(){
	      if(_editItemAutoSaveTimer) clearTimeout(_editItemAutoSaveTimer);
	      _editItemAutoSaveTimer = setTimeout(()=> autoSaveEditItem(), 600);
	    }
	
	    async function deleteEditItemModal(){
	      if(!_editItemCtx) return;
	      if(!requireOnline()) return;
	      if(!requirePermission(PERMISSIONS.ITEMS_DELETE, 'Delete not allowed')) return;

	      const id = _editItemCtx.id;
	      const item = state.items.find(x=> x && x.id === id);
	      const itemName = item && item.name ? String(item.name) : 'this item';
	      if(!(await openConfirmModal('Delete item?', `Delete "${itemName}"?`, { okText:'Delete', cancelText:'Cancel' }))) return;

	      const btnDelete = $('btnEditItemDelete');
	      const btnCancel = $('btnEditItemCancel');
	      if(btnDelete) btnDelete.disabled = true;
	      if(btnCancel) btnCancel.disabled = true;
	      setEditItemMessage('');
	
	      try{
	        await sbDeleteMany([id]);
	        try{ removeOrderLine(id); }catch(e){}
	        await sbLoadSnapshot();
	        closeEditItemModal();
	        toast('Item deleted', 'success');
	      }catch(e){
	        const msg = (e && e.message) ? e.message : 'Delete failed';
	        setEditItemMessage(msg);
	        toast(msg);
	      }finally{
	        if(btnDelete) btnDelete.disabled = false;
	        if(btnCancel) btnCancel.disabled = false;
	      }
	    }

	    // Modal editor events
	    const btnEditItemDelete = $('btnEditItemDelete');
	    if(btnEditItemDelete) btnEditItemDelete.addEventListener('click', deleteEditItemModal);
	    const btnEditItemCancel = $('btnEditItemCancel');
	    if(btnEditItemCancel) btnEditItemCancel.addEventListener('click', closeEditItemModal);
	    // Auto-save listeners for edit item modal
		    ['editItemName','editItemSku','editItemDesc','editLowStockQty','editItemReorderQty','editItemUom','editItemLocation','editItemCategory'].forEach(id=>{
		      const el = $(id);
		      if(el){
		        el.addEventListener('blur', scheduleEditItemAutoSave);
		        el.addEventListener('change', scheduleEditItemAutoSave);
		      }
		    });
	    const btnLowStockMinus = $('editLowStockMinus');
	    if(btnLowStockMinus) btnLowStockMinus.addEventListener('click', ()=> { bumpEditItemLowStockQty(-1); scheduleEditItemAutoSave(); });
	    const btnLowStockPlus = $('editLowStockPlus');
	    if(btnLowStockPlus) btnLowStockPlus.addEventListener('click', ()=> { bumpEditItemLowStockQty(1); scheduleEditItemAutoSave(); });
	    const btnReorderQtyMinus = $('editItemReorderQtyMinus');
	    if(btnReorderQtyMinus) btnReorderQtyMinus.addEventListener('click', ()=> { bumpEditItemReorderQty(-1); scheduleEditItemAutoSave(); });
	    const btnReorderQtyPlus = $('editItemReorderQtyPlus');
	    if(btnReorderQtyPlus) btnReorderQtyPlus.addEventListener('click', ()=> { bumpEditItemReorderQty(1); scheduleEditItemAutoSave(); });
	    const editReorderEnabled = $('editReorderEnabled');
	    if(editReorderEnabled) editReorderEnabled.addEventListener('change', scheduleEditItemAutoSave);

    // Tab switching for edit modal
    document.querySelectorAll('.edit-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        switchEditItemTab(tab.dataset.tab);
      });
    });

    // New inventory tab controls removed (read-only)

    // Settings tab stepper controls
    const btnReorderPointMinus = $('editReorderPointMinus');
    if(btnReorderPointMinus) btnReorderPointMinus.addEventListener('click', ()=> { bumpEditItemLowStockQty(-1); scheduleEditItemAutoSave(); });
    const btnReorderPointPlus = $('editReorderPointPlus');
    if(btnReorderPointPlus) btnReorderPointPlus.addEventListener('click', ()=> { bumpEditItemLowStockQty(1); scheduleEditItemAutoSave(); });
    const btnReorderQtyMinusNew = $('editReorderQtyMinus');
    if(btnReorderQtyMinusNew) btnReorderQtyMinusNew.addEventListener('click', ()=> { bumpEditItemReorderQty(-1); scheduleEditItemAutoSave(); });
    const btnReorderQtyPlusNew = $('editReorderQtyPlus');
    if(btnReorderQtyPlusNew) btnReorderQtyPlusNew.addEventListener('click', ()=> { bumpEditItemReorderQty(1); scheduleEditItemAutoSave(); });

    // Update header on name/sku/location change
    const editItemName = $('editItemName');
    if(editItemName){
      editItemName.addEventListener('keydown', e=>{
        if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
        if(e.key==='Enter'){
          // On mobile, Enter often means "Done" â€” move to description instead of saving.
          e.preventDefault();
          $('editItemDesc')?.focus();
        }
      });
      editItemName.addEventListener('input', updateEditItemHeader);
    }
    const editItemSku = $('editItemSku');
    if(editItemSku) editItemSku.addEventListener('input', updateEditItemHeader);
    const editItemLocation = $('editItemLocation');
    if(editItemLocation) editItemLocation.addEventListener('change', updateEditItemHeader);

	    const btnEditItemDone = $('btnEditItemDone');
	    if(btnEditItemDone) btnEditItemDone.addEventListener('click', async ()=>{
	      const ok = await autoSaveEditItem();
	      if(ok) closeEditItemModal();
	    });
	    const editLowStockQty = $('editLowStockQty');
	    if(editLowStockQty) editLowStockQty.addEventListener('keydown', e=>{
	      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
	      if(e.key==='Enter'){ e.preventDefault(); autoSaveEditItem().then(()=> closeEditItemModal()); }
	    });
	    if(editLowStockQty) editLowStockQty.addEventListener('click', async (e)=>{
	      if(!isMobileUx()) return;
	      if(!requireOnline()) return;
	      e.preventDefault();
	      e.stopPropagation();

	      const id = _editItemCtx && _editItemCtx.id ? String(_editItemCtx.id) : '';
	      const it = id ? state.items.find(x => x && x.id === id) : null;
	      const itemName = it ? String(it.name || '').trim() : '';
	      const curRaw = String(editLowStockQty.value ?? '').trim();
	      const oldQty = (curRaw === '') ? 0 : toInt(curRaw, 0);
	      const next = await openQtyEntryModal('Low Stock Threshold', itemName || 'Low Stock Threshold', oldQty, { min:0, okText:'Save', cancelText:'Cancel' });
	      if(next === null || typeof next === 'undefined') return;
	      const newQty = Math.max(0, toInt(next, oldQty));
	      if(newQty === oldQty) return;
	      editLowStockQty.value = String(newQty);
	      scheduleEditItemAutoSave();
	    });
		    const editItemDesc = $('editItemDesc');
		    if(editItemDesc) editItemDesc.addEventListener('keydown', e=>{
		      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
		      if((e.key==='Enter' || e.key==='NumpadEnter') && (e.metaKey || e.ctrlKey)){
		        e.preventDefault(); autoSaveEditItem().then(()=> closeEditItemModal());
		      }
		    });
	
	    // Table Qty +/- (mobile): optimistic UI + debounced commit
	    function toSignedInt(v, f=0){
	      const n = Number(v);
      if(!Number.isFinite(n)) return f;
      return Math.trunc(n);
    }
			    function adjustDisplayedTotalQty(delta){
			      const cur = getTotalsValue('totalQty');
			      if(cur === null) return;
			      setTotalsMetric('totalQty', 'qty', Math.max(0, cur + toSignedInt(delta,0)));
			    }
				    function adjustDisplayedInStock(prevQty, nextQty){
				      const cur = getTotalsValue('totalInStock');
				      if(cur === null) return;
				      const was = toInt(prevQty, 0) > 0;
				      const now = toInt(nextQty, 0) > 0;
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalInStock', 'inStock', Math.max(0, cur + delta));
				    }
				    function adjustDisplayedLowStock(item, prevQty, nextQty){
				      const cur = getTotalsValue('totalLowStock');
				      if(cur === null) return;
				      const thr = effectiveLowStockQty(item);
				      const was = toInt(prevQty, 0) <= thr;
				      const now = toInt(nextQty, 0) <= thr;
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalLowStock', 'lowStock', Math.max(0, cur + delta));
				    }
				    function adjustDisplayedLowStockThreshold(item, prevThr, nextThr){
				      const cur = getTotalsValue('totalLowStock');
				      if(cur === null) return;
				      const qty = toInt(item && item.qty, 0);
				      const was = qty <= toInt(prevThr, 0);
				      const now = qty <= toInt(nextThr, 0);
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalLowStock', 'lowStock', Math.max(0, cur + delta));
				    }
			    function updateQtyCellUIForRow(id, qty){
			      const tr = rowElById(id);
			      const nextVal = String(toInt(qty,0));
			      const val = tr ? tr.querySelector('td[data-col="qty"] .cell-val, td[data-col="qty"] .qty-value') : null;
			      if(val) val.textContent = nextVal;
			      refreshInventoryRowColumns(id);
			    }
    function refreshInventoryRowColumns(id){
      const tr = rowElById(id);
      if(!tr) return;
      const it = state.items.find(x=> x && x.id === id);
      if(!it) return;
      const columnDefs = Array.isArray(_inventoryActiveColumns) ? _inventoryActiveColumns : getInventoryVisibleColumnDefs();
      columnDefs.forEach(def=>{
        if(!def) return;
        const col = def.dataCol || def.key;
        const td = tr.querySelector(`td[data-col="${col}"]`);
        if(!td) return;
        td.innerHTML = buildInventoryColumnCellInner(it, def, { id: String(id || ''), canEdit: canItemsEdit(), allowInlineEdit: canItemsEdit() && !isMobileUx() });
      });
      const detailRow = document.querySelector(`tr.inv-detail-row[data-detail-id="${CSS.escape(String(id || ''))}"]`);
      if(detailRow){
        const layout = getInventoryLayout();
        const incomingMap = (state._incomingByItemId && typeof state._incomingByItemId.get === 'function')
          ? state._incomingByItemId
          : buildInventoryIncomingMap();
        state._incomingByItemId = incomingMap;
        detailRow.innerHTML = buildInventoryDetailRow(it, layout, incomingMap);
      }
    }
    function repositionRowByQtyNow(id){
      const srt = getSort();
      if(!srt || srt.col !== 'qty') return;
      const tb = tbodyEl(); if(!tb) return;
      const tr = rowElById(id); if(!tr) return;
      const it = state.items.find(x=> x.id===id); if(!it) return;
      const myQty = toInt(it.qty,0);
      const myName = toKey(it.name||'');
      const desc = (srt.dir === 'desc');
      const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
      let anchor = null;
      for(const r of others){
        const rid = r.dataset.id;
        const o = state.items.find(x=> x.id===rid);
        if(!o) continue;
        const oq = toInt(o.qty,0);
        const on = toKey(o.name||'');
        if(desc){
          if(oq < myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }else{
          if(oq > myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }
      }
      if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
    }
    // Debounced version - waits for user to stop clicking before repositioning
    function repositionRowByQty(id){
      const existing = _qtyReposition.get(id);
      if(existing) clearTimeout(existing);
      _qtyReposition.set(id, setTimeout(()=> {
        _qtyReposition.delete(id);
        repositionRowByQtyNow(id);
      }, 350));
    }
    function queueQtyCommit(id, desiredQty){
      if(!id) return;
      const q = toInt(desiredQty, 0);
      let entry = _qtyCommit.get(id);
      if(!entry){
        entry = { timer:null, desiredQty:q, inFlight:false };
        _qtyCommit.set(id, entry);
      }
      entry.desiredQty = q;
      if(entry.timer) clearTimeout(entry.timer);
      entry.timer = setTimeout(()=> flushQtyCommit(id), 400);
    }
    async function flushQtyCommit(id){
      const entry = _qtyCommit.get(id);
      if(!entry) return;
      entry.timer = null;
      if(entry.inFlight) return;
      entry.inFlight = true;
      const qtyToSend = entry.desiredQty;
      try{
        await sbUpdateFields(id, { qty: qtyToSend });
      }catch(e){
        toast((e && e.message) ? e.message : 'Qty update failed');
        try{ await sbLoadSnapshot(); }catch{}
      }finally{
        entry.inFlight = false;
        if(entry.desiredQty !== qtyToSend){
          queueQtyCommit(id, entry.desiredQty);
        }
      }
    }

		    const invTable = $('invTable');
		    const tableWrap = $('tableWrap');
		    if(invTable){

	      

      // Expanded detail panel actions
      invTable.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-detail-action]');
        if(!btn) return;
        const id = String(btn.dataset.id || '').trim();
        const action = String(btn.dataset.detailAction || '').trim();
        if(!id || !action) return;
        e.preventDefault();
        e.stopPropagation();
        if(action === 'order'){
          if(!canOrdersCreate() || !isInventoryActionVisible('order_item')) return;
          toggleOrderLineForItemId(id);
          return;
        }
        if(action === 'job'){
          if(!isInventoryActionVisible('add_to_job')) return;
          openAddToJobModal(id);
          return;
        }
        if(action === 'edit'){
          if(!isInventoryActionVisible('edit_item') || !canItemsEdit()) return;
          openEditItemModal(id);
          return;
        }
      });

	      // Tap row to edit (mobile and desktop)
      invTable.addEventListener('click', (e)=>{
        const tr = e.target.closest('tr[data-id]');
        if(!tr) return;
        if(e.target.closest('button, input, textarea, select, a, .actions-wrap')) return;
        const id = String(tr.dataset.id || '').trim();
        if(!id) return;
        handleInventoryRowTap(id);
      });
		    }

	    function startCellEdit(td, ev){
	      // If the user tapped a control inside the cell, don't open an editor.
	      if(ev && ev.target && ev.target.closest('button, input, textarea, select, a')) return;
	      if(td.querySelector('input')) return;
	      if(isMobileUx()) return;
	      const col=td.getAttribute('data-col'); if(!col) return;
	      const tr=td.closest('tr'); const id=tr?.dataset?.id; if(!id) return;
	      const it=state.items.find(x=> x.id===id); if(!it) return;
	      const selectedIds = getSelectedRowIds();
	      const batchIds = (selectedIds.length > 1 && selectedIds.includes(id)) ? selectedIds : [];
	      const isBatch = batchIds.length > 1;
	      const prevBatch = isBatch ? new Map(
	        batchIds
	          .map(batchId => {
	            const item = getInventoryById(batchId);
	            if(!item) return null;
	            return [batchId, { name: String(item.name||''), desc: String(item.desc||''), qty: toInt(item.qty,0) }];
	          })
	          .filter(Boolean)
	      ) : null;

      if(prefersModalEditing()){
        if(!requireOnline()) return;
        if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
        openEditItemModal(id);
        return;
      }

      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
      const fb = $('filterBox'); if (fb) fb.value = '';
	      state._filter = '';
	      try{ updateFilterClearBtn(); }catch(e){}

	      const oldVal = (col==='qty'? String(toInt(it.qty,0)) : String(col==='name'?it.name:(it.desc||'')));
	      const prevName = String(it.name||'');
	      const prevDesc = String(it.desc||'');
	      const prevQty = toInt(it.qty,0);
	      const inp=document.createElement('input');
	      inp.type = (col==='qty')? 'number' : 'text';
	      if(col==='qty'){ inp.min='0'; inp.step='1'; inp.inputMode='numeric'; inp.pattern='[0-9]*'; inp.setAttribute('enterkeyhint','done'); }
	      inp.value = oldVal; inp.autocapitalize='off'; inp.autocomplete='off'; inp.spellcheck=false;
	      td.classList.add('editing'); td.innerHTML=''; td.appendChild(inp);
	      setTimeout(()=>{ inp.focus(); inp.select(); }, 0);

	      let _done = false;
	      const restore = ()=>{
	        if(_done) return;
	        _done = true;
	        td.classList.remove('editing');
	        if(col==='qty') td.innerHTML = qtyCellHTML(it);
	        else td.innerHTML = '<span class="cell-val">' + escapeHtml((col==='name') ? String(it.name||'') : String(it.desc||'')) + '</span>';
	      };
	      const cancel=()=>{
	        it.name = prevName;
	        it.desc = prevDesc;
	        it.qty = prevQty;
	        restore();
	      };

	      const commit = async () => {
	        if(_done) return;
	        const raw = inp.value;
	        try{
	          if(isBatch){
	            if(!requireOnline()) return;
	            const count = batchIds.length;
	            if(col === 'name'){
	              const nv = String(raw||'').trim();
	              if(!nv){ cancel(); toast('Name required'); return; }
	              const normNv = toKey(nv);
	              const dup = state.items.some(x => x && x.id && !batchIds.includes(x.id) && toKey(String(x.name||'')) === normNv);
	              if(dup){ cancel(); toast('Duplicate name'); return; }
	              const allSame = batchIds.every(batchId => {
	                const item = getInventoryById(batchId);
	                return item && toKey(String(item.name||'')) === normNv;
	              });
	              if(allSame){ cancel(); return; }
	              const ok = await openConfirmModal('Batch edit?', `Set Item to "${truncateForConfirm(nv)}" for ${count} selected items?`, { okText:'Apply', cancelText:'Cancel' });
	              if(!ok){ cancel(); return; }
	              batchIds.forEach(batchId => {
	                const item = getInventoryById(batchId);
	                if(item) item.name = nv;
	              });
	              restore();
	              renderTable();
	              applySelectedRowIds(batchIds);
	              try{
	                await Promise.all(batchIds.map(batchId => sbUpdateFields(batchId, { name: nv })));
	              }catch(e){
	                if(prevBatch){
	                  prevBatch.forEach((prev, batchId) => {
	                    const item = getInventoryById(batchId);
	                    if(item){
	                      item.name = prev.name;
	                      item.desc = prev.desc;
	                      item.qty = prev.qty;
	                    }
	                  });
	                  renderTable();
	                  applySelectedRowIds(batchIds);
	                }
	                toast((e && e.message) ? e.message : 'Batch update failed');
	                try{ await sbLoadSnapshot(); }catch{}
	              }
	              return;
	            }
	            if(col === 'desc'){
	              const nv = normalizeDescValue(raw);
	              const allSame = batchIds.every(batchId => {
	                const item = getInventoryById(batchId);
	                return item && normalizeDescValue(item.desc) === nv;
	              });
	              if(allSame){ cancel(); return; }
	              const ok = await openConfirmModal('Batch edit?', `Set Description to "${truncateForConfirm(nv)}" for ${count} selected items?`, { okText:'Apply', cancelText:'Cancel' });
	              if(!ok){ cancel(); return; }
	              batchIds.forEach(batchId => {
	                const item = getInventoryById(batchId);
	                if(item) item.desc = nv;
	              });
	              restore();
	              renderTable();
	              applySelectedRowIds(batchIds);
	              try{
	                await Promise.all(batchIds.map(batchId => sbUpdateFields(batchId, { desc: nv })));
	              }catch(e){
	                if(prevBatch){
	                  prevBatch.forEach((prev, batchId) => {
	                    const item = getInventoryById(batchId);
	                    if(item){
	                      item.name = prev.name;
	                      item.desc = prev.desc;
	                      item.qty = prev.qty;
	                    }
	                  });
	                  renderTable();
	                  applySelectedRowIds(batchIds);
	                }
	                toast((e && e.message) ? e.message : 'Batch update failed');
	                try{ await sbLoadSnapshot(); }catch{}
	              }
	              return;
	            }
	            if(col === 'qty'){
	              const q = toInt(raw, -1);
	              if(q < 0){ cancel(); toast('Qty must be integer â‰¥ 0'); return; }
	              const allSame = batchIds.every(batchId => {
	                const item = getInventoryById(batchId);
	                return item && toInt(item.qty, 0) === q;
	              });
	              if(allSame){ cancel(); return; }
	              const ok = await openConfirmModal('Batch edit?', `Set Qty to ${q} for ${count} selected items?`, { okText:'Apply', cancelText:'Cancel' });
	              if(!ok){ cancel(); return; }
	              batchIds.forEach(batchId => {
	                const item = getInventoryById(batchId);
	                if(item) item.qty = q;
	              });
	              restore();
	              renderTable();
	              applySelectedRowIds(batchIds);
	              batchIds.forEach(batchId => queueQtyCommit(batchId, q));
	              return;
	            }
	            cancel();
	            return;
	          }
	          if(col==='name'){
	            const nv = String(raw||'').trim();
	            if(!nv){ cancel(); toast('Name required'); return; }
	            if(nv === prevName){ cancel(); return; }
	            if(toKey(nv)!==toKey(prevName) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))){ cancel(); toast('Duplicate name'); return; }
	            it.name = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'name') renderTable();
	            await sbUpdateFields(id, { name: nv });
	            return;
	          }
	          if(col==='desc'){
	            const nv = normalizeDescValue(raw);
	            const pv = normalizeDescValue(prevDesc);
	            if(nv === pv){ cancel(); return; }
	            it.desc = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'desc') renderTable();
	            await sbUpdateFields(id, { desc: nv });
	            return;
	          }
			          if(col==='qty'){
			            const q = toInt(raw, -1);
			            if(q < 0){ cancel(); toast('Qty must be integer â‰¥ 0'); return; }
			            if(q === prevQty){ cancel(); return; }
			            it.qty = q;
			            restore();
			            adjustDisplayedTotalQty(q - prevQty);
			            adjustDisplayedInStock(prevQty, q);
			            adjustDisplayedLowStock(it, prevQty, q);
			            repositionRowByQty(id);
			            queueQtyCommit(id, q);
			            try{ syncLowStockIndicatorForRow(id); }catch(e){}
			            return;
			          }
	          cancel();
	        }catch(e){
	          it.name = prevName;
	          it.desc = prevDesc;
	          it.qty = prevQty;
	          try{ renderTable(); }catch(_){}
	          toast((e && e.message) ? e.message : 'Update failed');
	          try{ await sbLoadSnapshot(); }catch{}
	        }
	      };

	      inp.addEventListener('keydown', e=>{
	        if(e.key==='Enter'){ e.preventDefault(); commit(); }
	        if(e.key==='Escape'){ e.preventDefault(); cancel(); }
	      });
	      inp.addEventListener('blur', commit);
	    }

    // ========================
    // Hamburger Menu Toggle
    // ========================
    const hamburgerBtn = $('hamburgerBtn');
    const menuBackdrop = $('menuBackdrop');
    const menuPanel = $('menuPanel');
    const menuCloseBtn = $('menuCloseBtn');
    const menuTabList = $('menuTabList');
    let _menuOpen = false;

    function setMenuTab(tabKey, opts = {}){
      const tabs = Array.from(document.querySelectorAll('#menuTabList .menu-tab'));
      const panels = Array.from(document.querySelectorAll('#menuTabPanels .menu-tab-panel'));
      if(!tabs.length) return;
      const desired = String(tabKey || '').trim();
      const resolved = tabs.some(tab => tab.dataset.tab === desired) ? desired : 'inventory';
      const current = tabs.find(tab => tab.classList.contains('is-active'));
      if(current && current.dataset.tab === resolved && !opts.force) return;
      tabs.forEach(tab => {
        const active = tab.dataset.tab === resolved;
        tab.classList.toggle('is-active', active);
        tab.setAttribute('aria-selected', active ? 'true' : 'false');
        tab.tabIndex = active ? 0 : -1;
      });
      panels.forEach(panel => {
        const active = panel.dataset.panel === resolved;
        if(active){
          panel.classList.add('is-active');
          panel.classList.remove('is-leaving');
          return;
        }
        if(panel.classList.contains('is-active')){
          panel.classList.add('is-leaving');
          setTimeout(() => {
            panel.classList.remove('is-active');
            panel.classList.remove('is-leaving');
          }, 160);
        }else{
          panel.classList.remove('is-active');
          panel.classList.remove('is-leaving');
        }
      });
      try{ sessionStorage.setItem(MENU_TAB_STORAGE_KEY, resolved); }catch(e){}
    }
    function restoreMenuTab(){
      let target = '';
      try{ target = sessionStorage.getItem(MENU_TAB_STORAGE_KEY) || ''; }catch(e){}
      setMenuTab(target || 'inventory', { force:true });
    }
    function initMenuTabs(){
      if(!menuTabList || menuTabList._wired) return;
      menuTabList._wired = true;
      menuTabList.addEventListener('click', (e)=>{
        const btn = e.target.closest('.menu-tab');
        if(!btn) return;
        setMenuTab(btn.dataset.tab);
      });
      menuTabList.addEventListener('keydown', (e)=>{
        if(e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;
        const tabs = Array.from(menuTabList.querySelectorAll('.menu-tab'));
        if(!tabs.length) return;
        const idx = tabs.findIndex(tab => tab.classList.contains('is-active'));
        if(idx < 0) return;
        const dir = e.key === 'ArrowRight' ? 1 : -1;
        const nextIdx = (idx + dir + tabs.length) % tabs.length;
        const nextTab = tabs[nextIdx];
        if(nextTab){
          e.preventDefault();
          setMenuTab(nextTab.dataset.tab);
          nextTab.focus();
        }
      });
    }
    function getMenuFocusables(){
      if(!menuPanel) return [];
      return Array.from(menuPanel.querySelectorAll(MODAL_FOCUSABLE))
        .filter(el => !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true' && el.tabIndex !== -1);
    }
    function focusMenuFirst(){
      const items = getMenuFocusables();
      if(items.length){
        items[0].focus();
        return;
      }
      if(menuPanel){
        menuPanel.setAttribute('tabindex', '-1');
        menuPanel.focus();
      }
    }
    function handleMenuKeydown(e){
      if(!_menuOpen) return;
      if(e.key === 'Escape'){
        toggleMenu(false);
        return;
      }
      if(e.key !== 'Tab') return;
      const items = getMenuFocusables();
      if(!items.length){
        e.preventDefault();
        return;
      }
      const first = items[0];
      const last = items[items.length - 1];
      if(e.shiftKey){
        if(document.activeElement === first){
          e.preventDefault();
          last.focus();
        }
      }else if(document.activeElement === last){
        e.preventDefault();
        first.focus();
      }
    }
    function toggleMenu(open) {
      const isOpen = open !== undefined ? open : !menuBackdrop.classList.contains('open');
      _menuOpen = isOpen;
      if(menuBackdrop){
        menuBackdrop.classList.toggle('open', isOpen);
        menuBackdrop.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
      }
      if(hamburgerBtn){
        hamburgerBtn.classList.toggle('open', isOpen);
        hamburgerBtn.setAttribute('aria-expanded', isOpen);
      }
      if(isOpen){
        initMenuTabs();
        restoreMenuTab();
        scheduleMenuActionBadgeRefresh();
        focusMenuFirst();
      }
    }

    if(hamburgerBtn) hamburgerBtn.addEventListener('click', () => toggleMenu());
    if(menuCloseBtn) menuCloseBtn.addEventListener('click', () => toggleMenu(false));
    if(menuBackdrop) menuBackdrop.addEventListener('click', (e) => {
      if(e.target === menuBackdrop) toggleMenu(false);
    });
    document.addEventListener('keydown', handleMenuKeydown);

    // ========================
    // Import / Paste / Export
    // ========================
    $('menuImport').addEventListener('click', ()=> {
      toggleMenu(false);
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk import requires import permission' : 'Bulk import requires Professional tier');
        return;
      }
      $('#fileImport').click();
    });
    $('#fileImport').addEventListener('change', async ev=>{
      if(!requireOnline()){ ev.target.value=''; return; }
      const f=ev.target.files[0]; if(!f) return; await handleFile(f); ev.target.value='';
    });

    $('menuPaste').addEventListener('click', ()=>{
      toggleMenu(false);
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk paste requires import permission' : 'Bulk paste requires Professional tier');
        return;
      }
      $('#pasteArea').value='';
      show('pasteModal', true);
    });
    $('btnPasteCancel').addEventListener('click', ()=> show('pasteModal', false));
    $('btnPasteApply').addEventListener('click', ()=>{
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk paste requires import permission' : 'Bulk paste requires Professional tier');
        return;
      }
      const text=$('#pasteArea').value||''; if(!text.trim()){ toast('Nothing to import'); return; }
      const rows=parseDelimitedSmart(text); const items=rowsToItems(rows);
      if(!items.length){ toast('Could not detect headers or rows'); return; }
      show('pasteModal', false);
      showPreview(items);
    });

    const drop=$('#dropZone');
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#0e1621'; });
    drop.addEventListener('dragleave', ()=>{ drop.style.background=''; });
    drop.addEventListener('drop', async e=>{
      e.preventDefault(); drop.style.background='';
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk import requires import permission' : 'Bulk import requires Professional tier');
        return;
      }
      const f=e.dataTransfer.files[0]; if(f) await handleFile(f);
    });

    $('#fileImportModal').addEventListener('change', async ev=>{ if(!requireOnline()){ ev.target.value=''; return; } const f=ev.target.files[0]; if(f) await handleFile(f); ev.target.value=''; });

    async function handleFile(f){
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk import requires import permission' : 'Bulk import requires Professional tier');
        return;
      }
      try{
        const items=await parseAnyFile(f);
        if(!items.length){ toast('No rows found in file'); return; }
        show('pasteModal', false);
        showPreview(items);
      }catch(err){ toast(err.message||'Import failed'); }
    }
    function buildPreview(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      const rows=[]; let add=0, upd=0, same=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        const it=index.get(k);
        if(!it){ rows.push({name:r.name, desc:r.desc||'', oldQty:'â€”', newQty:toInt(r.qty,0), action:'Add'}); add++; }
        else{
          const oldQ=toInt(it.qty,0), newQ=toInt(r.qty,0);
          const act = (oldQ===newQ && (r.desc||'').trim()===String(it.desc||'').trim())? 'No change' : 'Update';
          if(act==='Update') upd++; else same++;
          rows.push({name:it.name, desc:(r.desc||it.desc||''), oldQty:oldQ, newQty:newQ, action:act});
        }
      }
      return {rows, add, upd, same, total: imported.length};
    }
    function showPreview(imported){
      const pv=buildPreview(imported);
      const info=$('previewInfo'); if(info){ info.textContent = `${pv.total} row(s): ${pv.add} add, ${pv.upd} update, ${pv.same} unchanged`; }
      const tbody=$('previewBody'); if(tbody){
        tbody.innerHTML='';
        for(const r of pv.rows){
          const tr=document.createElement('tr');
          tr.innerHTML =
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.name)}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.desc||'')}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.oldQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.newQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${r.action}</td>`;
          tbody.appendChild(tr);
        }
      }
      state._pendingImport = imported;
      show('previewModal', true);
    }
    $('btnPreviewCancel').addEventListener('click', ()=>{ state._pendingImport=null; show('previewModal', false); });
    $('btnPreviewApply').addEventListener('click', async ()=>{
      if(!requireOnline()) return;
      const imp = state._pendingImport||[]; state._pendingImport=null; show('previewModal', false);
      if(!imp.length){ toast('Nothing to import'); return; }
      try{
        await sbUpsertMany(imp);
        await sbLoadSnapshot();
        toast('Import applied');
      }catch(e){ toast(e.message || 'Import failed'); }
    });

	    $('menuExport').addEventListener('click', ()=>{
	      toggleMenu(false);
	      if(!requireOnline()) return;
	      if(!canItemsExport()){
	        toast(hasTier('professional') ? 'Export permission required' : 'Export requires Professional tier');
	        return;
	      }
	      (async ()=>{
	        try{
	          const items = await sbExportItems();
	          if(!items.length){ toast('No items to export'); return; }
	          const rows=[["Item","Description","Qty"]];
	          for(const it of items){ rows.push([it.name||'', it.description||'', String(toInt(it.quantity,0))]); }
	          const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
	          const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
	          const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventory.csv'; a.click(); URL.revokeObjectURL(url);
	        }catch(e){
	          toast(e && e.message ? e.message : 'Export failed');
	        }
	      })();
	    });

			    // ========================
			    // Inventory report
			    // ========================
	    function getItemLowStockQtyOverride(item){
	      if(!item) return null;
	      const v = Object.prototype.hasOwnProperty.call(item, 'lowStockQty') ? item.lowStockQty : null;
	      if(v === null || typeof v === 'undefined') return null;
	      const n = Number(v);
	      if(!Number.isFinite(n)) return null;
	      const i = Math.trunc(n);
	      if(i < 0) return null;
	      return i;
	    }
	    function getItemReorderEnabled(item){
	      if(!item) return true;
	      if(!Object.prototype.hasOwnProperty.call(item, 'reorderEnabled')) return true;
	      return !!item.reorderEnabled;
	    }
	    function effectiveLowStockQty(item){
	      const override = getItemLowStockQtyOverride(item);
	      return override !== null ? override : 0;
	    }
	    function isLowStockItem(item){
	      if(!getItemReorderEnabled(item)) return false;
	      const qty = toInt(item && item.qty, 0);
	      const thr = effectiveLowStockQty(item);
	      return qty <= thr;
	    }
	    function isExemptLowStockItem(item){
	      if(getItemReorderEnabled(item)) return false;
	      const qty = toInt(item && item.qty, 0);
	      const thr = effectiveLowStockQty(item);
	      return qty <= thr;
	    }
	    function reportDataSnapshot(){
	      const all = (Array.isArray(state.items) ? state.items : [])
	        .filter(Boolean)
		        .map(it => ({
		          id: it.id,
		          name: String(it.name||''),
		          desc: String(it.desc||''),
		          qty: toInt(it.qty,0),
		          lowStockQty: getItemLowStockQtyOverride(it),
		          reorderEnabled: getItemReorderEnabled(it),
		        }))
	        .sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
	      const totalItems = all.length;
	      const totalQty = all.reduce((sum, it) => sum + toInt(it.qty,0), 0);
	      const inStock = all.filter(it => toInt(it.qty,0) > 0);
	      const lowStock = all.filter(it => isLowStockItem(it));
	      const exemptLowStock = all.filter(it => isExemptLowStockItem(it));
	      return {
	        all,
	        inStock,
	        lowStock,
	        exemptLowStock,
	        totalItems,
	        totalQty,
	        inStockCount: inStock.length,
	        lowStockCount: lowStock.length,
	        exemptLowStockCount: exemptLowStock.length,
	      };
	    }
	    function reportCsvEscape(value){
	      const s = String(value ?? '');
	      return '"' + s.replace(/"/g, '""') + '"';
	    }
	    function buildInventoryReportCsv(data){
	      const d = data || reportDataSnapshot();
	      const out = [];
	      out.push(['Item','Description','Qty','In Stock'].map(reportCsvEscape).join(','));
	      for(const it of d.all){
	        out.push([
	          it.name || '',
	          String(it.desc||'').replace(/[\r\n]+/g,' ').trim(),
	          String(toInt(it.qty,0)),
	          toInt(it.qty,0) > 0 ? 'Yes' : 'No',
	        ].map(reportCsvEscape).join(','));
	      }
	      return out.join('\n');
	    }
	    function buildInventoryReportText(data, opts = {}){
	      const d = data || reportDataSnapshot();
	      const maxLines = Math.max(10, Math.min(500, toInt(opts.maxLines, 180)));
	      const out = [];
	      const when = formatEasternDateTime(new Date());
	      out.push(`Inventory Report`);
	      out.push(`Generated: ${when}`);
	      out.push('');
	      out.push(`Total Items: ${d.totalItems}`);
	      out.push(`In Stock: ${d.inStockCount}`);
	      out.push(`Low Stock: ${d.lowStockCount}`);
	      out.push(`Total Qty: ${d.totalQty}`);
	      out.push('');
	      out.push('Inventory:');
	      out.push('');
	      if(!d.all.length){
	        out.push('(none)');
	        return out.join('\n');
	      }
	      let linesUsed = out.length;
	      for(const it of d.all){
	        if(linesUsed >= maxLines){
	          out.push('');
	          out.push(`(trimmed; use CSV for full report)`);
	          break;
	        }
	        const qty = toInt(it.qty,0);
	        const desc = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
	        out.push(`${it.name}\t${qty}\t${desc}`);
	        linesUsed++;
	      }
	      return out.join('\n');
	    }
	
	    function reportTableHtml(items, opts = {}){
	      const rows = Array.isArray(items) ? items : [];
	      const showThreshold = !!opts.showThreshold;
	      let html = '<table class="report-table" role="table">';
	      html += '<thead><tr>';
	      html += '<th>Item</th>';
	      html += '<th>Description</th>';
	      html += '<th class="qty">Qty</th>';
	      if(showThreshold) html += '<th class="thr">Low</th>';
	      html += '</tr></thead><tbody>';
	      for(const it of rows){
	        const name = escapeHtml(it && it.name ? it.name : '');
	        const descRaw = String(it && it.desc ? it.desc : '').replace(/[\r\n]+/g,' ').trim();
	        const desc = escapeHtml(descRaw);
	        const qty = toInt(it && it.qty, 0);
	        html += '<tr>';
	        html += `<td class="item">${name}</td>`;
	        html += `<td class="desc">${desc}</td>`;
	        html += `<td class="qty">${qty}</td>`;
	        if(showThreshold){
	          const thr = effectiveLowStockQty(it);
	          html += `<td class="thr">${toInt(thr,0)}</td>`;
	        }
	        html += '</tr>';
	      }
	      html += '</tbody></table>';
	      return html;
	    }
	    function reportOrderHasItem(id){
	      const ord = orderState();
	      const key = String(id || '').trim();
	      return !!(key && ord && Array.isArray(ord.lines) && ord.lines.some(l => String(l && l.id ? l.id : '').trim() === key));
	    }
	    function reportRowButtonHtml(item, opts = {}){
	      const it = item || {};
	      const id = String(it.id || '').trim();
	      if(!id) return '';
	      const safeId = id.replace(/"/g, '&quot;');
	      const name = escapeHtml(String(it.name || '').trim());
	      const descRaw = String(it.desc || '').replace(/[\r\n]+/g,' ').trim();
	      const desc = escapeHtml(descRaw);
	      const qty = toInt(it.qty, 0);
	      const showThreshold = !!opts.showThreshold;
	      const thr = showThreshold ? toInt(effectiveLowStockQty(it), 0) : null;
	      const selected = reportOrderHasItem(id);
	      const dotClass = selected ? 'led-dot--green' : 'led-dot--off';
	      const pressed = selected ? 'true' : 'false';

	      return (
	        `<button type="button" class="report-row" data-report-order-id="${safeId}" aria-pressed="${pressed}">`+
	          `<div class="report-row-main">`+
	            `<div class="report-item">`+
	              `<span class="led-dot ${dotClass}" aria-hidden="true"></span>`+
	              `<span class="report-item-name">${name}</span>`+
	            `</div>`+
	            (desc ? `<div class="report-desc">${desc}</div>` : ``)+
	          `</div>`+
	          `<div class="report-qty">`+
	            `${qty}`+
	            (showThreshold ? `<div class="muted">Low: ${thr}</div>` : ``)+
	          `</div>`+
	        `</button>`
	      );
	    }
	    function reportRowsHtml(items, opts = {}){
	      const rows = Array.isArray(items) ? items : [];
	      if(!rows.length){
	        const emptyText = (opts && typeof opts.emptyText === 'string') ? opts.emptyText : 'No items.';
	        return `<div class="order-empty">${escapeHtml(emptyText)}</div>`;
	      }
	      const sepText = (opts && typeof opts.separatorText === 'string') ? opts.separatorText : 'Not in Cart';
	      const selected = [];
	      const rest = [];
	      for(const it of rows){
	        const id = String(it && it.id ? it.id : '').trim();
	        if(id && reportOrderHasItem(id)) selected.push(it);
	        else rest.push(it);
	      }
	      let html = '';
	      if(selected.length) html += selected.map(it => reportRowButtonHtml(it, opts)).join('');
	      if(selected.length && rest.length){
	        html += `<div class="report-separator" role="separator"><span>${escapeHtml(sepText)}</span></div>`;
	      }
	      if(rest.length) html += rest.map(it => reportRowButtonHtml(it, opts)).join('');
	      return html;
	    }
	    function updateReportOrderBadge(){
	      const modal = $('reportModal');
	      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
	      const pillContainer = $('reportOrderPillContainer');
	      const pill = $('reportOrderBadge');
	      const valueEl = $('reportOrderCount');
	      if(!pillContainer || !pill || !valueEl) return;
	      const ord = orderState();
	      const count = Array.isArray(ord.lines) ? ord.lines.length : 0;
	      if(count > 0){
	        pillContainer.style.display = 'flex';
	        valueEl.textContent = String(count);
	        const labelEl = pill.querySelector('.order-pill-label');
	        if(labelEl) labelEl.textContent = count === 1 ? 'Item in Cart' : 'Items in Cart';
	      }else{
	        pillContainer.style.display = 'none';
	        valueEl.textContent = '0';
	      }
	    }
		    function syncReportOrderIndicators(){
		      const modal = $('reportModal');
		      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
		      const ord = orderState();
		      const ids = new Set((Array.isArray(ord.lines) ? ord.lines : []).map(l => String(l && l.id ? l.id : '').trim()).filter(Boolean));
	      document.querySelectorAll('[data-report-order-id]').forEach(el=>{
	        const id = String(el.dataset && el.dataset.reportOrderId ? el.dataset.reportOrderId : '').trim();
	        if(!id) return;
	        const selected = ids.has(id);
	        el.setAttribute('aria-pressed', selected ? 'true' : 'false');
	        const dot = el.querySelector('.led-dot');
	        if(dot){
	          dot.classList.toggle('led-dot--green', selected);
	          dot.classList.toggle('led-dot--off', !selected);
	        }
	      });
		      updateReportOrderBadge();
		    }
		    function batchAddLowStockToCart(){
		      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		      const d = reportDataSnapshot();
		      const rows = Array.isArray(d.lowStock) ? d.lowStock : [];
		      if(!rows.length){ toast('No low stock items'); return; }
		      let added = 0;
		      for(const it of rows){
		        const need = Math.max(1, toInt(effectiveLowStockQty(it), 0) - toInt(it.qty, 0));
		        if(upsertOrderLineFromItem(it, need)) added++;
		      }
		      if(added){
		        toast(`Added ${added} low stock ${added === 1 ? 'item' : 'items'} to cart`);
		      }else{
		        toast('Low stock items already in cart');
		      }
		      try{ syncReportOrderIndicators(); }catch(e){}
		    }
			    function renderInventoryReport(){
			      const d = reportDataSnapshot();
			      const elTotal = $('reportMetricTotalItems'); if(elTotal) elTotal.textContent = String(d.totalItems);
			      const elQty = $('reportMetricTotalQty'); if(elQty) elQty.textContent = String(d.totalQty);
			      const elLowCount = $('reportLowStockCount'); if(elLowCount) elLowCount.textContent = `(${d.lowStockCount})`;
			      const elExemptCount = $('reportExemptCount'); if(elExemptCount) elExemptCount.textContent = `(${d.exemptLowStockCount})`;
			      const elInCount = $('reportInStockCount'); if(elInCount) elInCount.textContent = `(${d.inStockCount})`;

			      const lowSection = $('reportLowStockSection');
			      const lowList = $('reportLowStockList');
			      if(lowSection && lowList){
			        lowList.innerHTML = reportRowsHtml(d.lowStock, { showThreshold:true, emptyText:'No low stock items.' });
			      }

			      const exemptSection = $('reportExemptSection');
			      const exemptList = $('reportExemptList');
			      if(exemptSection && exemptList){
			        exemptList.innerHTML = reportRowsHtml(d.exemptLowStock, { showThreshold:true, emptyText:'No exempt low stock items.' });
			      }

		      const list = $('reportList');
		      if(list){
		        list.innerHTML = reportRowsHtml(d.inStock, { showThreshold:false, emptyText:'No in-stock items.' });
		      }
		      updateReportOrderBadge();
		    }
		    function downloadInventoryReportCsv(){
		      try{
		        const csv = buildInventoryReportCsv(reportDataSnapshot());
		        const stamp = new Date().toISOString().slice(0,10);
	        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
	        const url = URL.createObjectURL(blob);
	        const a = document.createElement('a');
	        a.href = url;
	        a.download = `inventory-report-${stamp}.csv`;
	        document.body.appendChild(a);
	        a.click();
	        document.body.removeChild(a);
	        URL.revokeObjectURL(url);
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Download failed');
		      }
		    }
		    const MODULUS_LOGO_HORIZONTAL_SVG = `<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2030.96 800">
  <g>
    <polygon points="103.57 382.69 103.76 312.57 161.49 343.09 265.73 288.14 298.02 272.49 298.42 341.25 197.12 395.72 161.56 414.15 103.57 382.69"/>
    <polygon points="87.48 516.09 23.36 481.08 23.4 271.54 87.22 304.49 87.48 516.09"/>
    <path d="M229.31,517.53l-.3-113.92c22.55-12.88,44.55-24.16,68.94-35.85l.13,113.06-68.77,36.71Z"/>
  </g>
  <g>
    <path d="M473.02,438.27l-8.31-31.8c-1.33-5.42-2.29-11.2-2.29-14.33-2.41,4.94-4.94,9.76-11.44,20.96l-9.64,16.5c-4.94,8.79-9.03,10.12-15.78,10.12s-11.08-1.21-16.14-10.12l-10.72-19.27c-6.14-10.84-8.07-14.46-9.88-18.19-.6,3.85-1.57,8.67-2.89,13.73l-8.07,32.4h-27.34l19.51-69.5c2.41-8.43,8.55-12.53,15.66-12.53s11.8,3.73,15.18,9.52l13.25,22.16c7.47,12.41,10,16.74,11.92,20.72,1.93-3.98,4.46-8.19,11.8-20.6l13.25-22.28c3.25-5.54,7.95-9.52,15.3-9.52,6.87,0,13.13,4.1,15.54,12.53,6.38,23.13,12.53,46.38,18.91,69.5h-27.82Z"/>
    <path d="M574.81,439.59c-39.99,0-60.11-12.89-60.11-41.68s20.12-41.56,60.11-41.56,60.23,12.77,60.23,41.56-20.24,41.68-60.23,41.68ZM574.81,379.85c-24.09,0-32.28,2.05-32.28,18.07s8.19,18.19,32.28,18.19,32.4-2.29,32.4-18.19-8.19-18.07-32.4-18.07Z"/>
    <path d="M659.85,438.27v-50.23h27.95v27.1h26.98c12.65,0,21.68-4.7,21.68-17.95,0-10.96-9.52-16.02-21.68-16.02h-54.93l17.71-23.49h37.22c28.67,0,49.39,16.26,49.39,39.51s-20.96,41.07-49.39,41.07h-54.93Z"/>
    <path d="M867.39,357.68h28.07v45.41c0,24.33-16.98,36.5-51.19,36.5-39.39,0-56.37-12.17-56.37-36.5v-45.41h27.82v45.41c0,10.48,3.49,13.37,28.55,13.37,16.98,0,23.13-3.73,23.13-13.37v-45.41Z"/>
    <path d="M921.84,438.27v-80.58h27.82v57.46h61.19l-17.95,23.13h-71.07Z"/>
    <path d="M1109.75,357.68h28.07v45.41c0,24.33-16.98,36.5-51.19,36.5-39.39,0-56.37-12.17-56.37-36.5v-45.41h27.82v45.41c0,10.48,3.49,13.37,28.55,13.37,16.98,0,23.13-3.73,23.13-13.37v-45.41Z"/>
    <path d="M1159.38,438.27l17.95-23.13h60.83c3.61,0,5.66-1.33,5.66-4.22s-2.05-4.21-5.9-4.21h-45.53c-20.84,0-30.35-9.76-30.35-23.37,0-16.26,10.12-25.66,35.29-25.66h71.07l-17.95,23.49h-55.77c-3.73,0-5.66.96-5.66,3.86s1.93,3.97,5.66,3.97h45.77c19.51,0,30.23,7.59,30.23,22.28,0,16.62-7.95,26.98-32.88,26.98h-78.42Z"/>
  </g>
  <g>
    <path d="M1359.68,388.44c-3.08-3.95-7.47-6.07-16.09-6.07-7.08,0-12.96,1.45-12.96,6.02,0,3.42,3.18,4.38,14.75,5.45,10.65.96,19.85,1.25,19.85,10.02,0,9.2-10.12,11.37-18.79,11.37-11.85,0-18.41-4.05-21.49-9.11l3.9-1.78c3.42,4.34,8.14,7.04,17.69,7.04,7.85,0,13.83-1.83,13.83-7.13,0-4.14-3.61-4.96-15.66-6.07-10.55-1.01-18.89-1.45-18.89-9.35,0-8.43,9.78-10.36,18.02-10.36,11.42,0,17.01,3.71,19.81,8.24l-3.95,1.74Z"/>
    <path d="M1381.45,396.87c0-10.12,7.47-18.41,22.7-18.41s22.79,8.29,22.79,18.41-7.57,18.36-22.79,18.36-22.7-8.24-22.7-18.36ZM1422.08,396.87c0-8.29-6.12-14.5-17.93-14.5s-17.83,6.22-17.83,14.5,6.02,14.46,17.83,14.46,17.93-6.22,17.93-14.46Z"/>
    <path d="M1446.26,414.12v-34.46h31.71v3.9h-27.13v11.9h17.01v3.9h-17.01v14.75h-4.58Z"/>
    <path d="M1507.02,414.12v-30.55h-16.58v-3.9h37.68v3.9h-16.53v30.55h-4.58Z"/>
    <path d="M1540.8,379.66h5.06l11.28,27.42,10.55-27.42h2.89l10.5,27.32,11.28-27.32h4.72l-14.65,34.46h-2.89l-10.65-27.52-10.55,27.52h-2.89l-14.65-34.46Z"/>
    <path d="M1611.82,414.12h-4.96l18.94-34.46h3.18l18.94,34.46h-5.54l-5.01-9.4h-20.53l-5.01,9.4ZM1618.95,400.82h16.29l-8.14-15.23-8.14,15.23Z"/>
    <path d="M1702.84,414.12c-1.49.53-2.79.87-4.72.87-13.3,0-7.13-16.48-18.84-16.48h-9.98v15.61h-4.58v-34.46h23.23c7.71,0,13.16,3.18,13.16,9.4s-5.59,9.35-13.16,9.35h-.29v.1c5.83,3.57,4.67,12.24,11.37,12.24,1.11,0,2.6-.24,3.81-.58v3.95ZM1669.3,383.57v11.04h19.13c4.05,0,7.85-1.4,7.85-5.54s-3.81-5.49-7.85-5.49h-19.13Z"/>
    <path d="M1721.53,414.12v-34.46h31.71v3.9h-27.13v10.94h17.01v3.9h-17.01v11.8h29.35v3.9h-33.92Z"/>
    <path d="M1781.13,413.15c0,5.01-3.52,9.98-8.38,9.98v-2.6c1.88-.38,4.82-2.36,4.82-6.41h-5.01v-5.06h8.58v4.1Z"/>
    <path d="M1829.65,379.66h4.58v30.55h25.64v3.9h-30.21v-34.46Z"/>
    <path d="M1877.11,379.66h4.58v30.55h25.64v3.9h-30.21v-34.46Z"/>
    <path d="M1962.83,406.89c-2.55,2.75-7.85,8.34-20.29,8.34-15.13,0-22.65-8.24-22.65-18.36s7.52-18.41,22.79-18.41c12.58,0,17.68,5.59,19.56,7.42l-3.42,2.65c-4.14-3.37-7.95-6.17-16.43-6.17-11.85,0-17.68,6.26-17.68,14.46s6.02,14.5,17.97,14.5c9.01,0,12.96-3.52,16.72-7.08l3.42,2.65Z"/>
  </g>
</svg>`;
		    function buildModulusLogoHtml({ width = 220, color = '#111', marginTop = 18 } = {}){
		      const svg = MODULUS_LOGO_HORIZONTAL_SVG.replace(
		        '<svg ',
		        `<svg role="img" aria-label="Modulus Software, LLC" fill="currentColor" style="width:${width}px;height:auto;display:block;" `
		      );
		      return `<div style="margin-top:${marginTop}px;display:flex;justify-content:center;color:${color};">${svg}</div>`;
		    }
		    function inventoryReportEmailTableHtml(items, opts = {}){
		      const rows = Array.isArray(items) ? items : [];
		      const showThreshold = !!opts.showThreshold;

		      const th = (label, alignRight) => (
		        `<th style="padding:10px;border:1px solid #d0d7de;${alignRight ? 'text-align:right;' : 'text-align:left;'}background:#f6f8fa;font-size:12px;text-transform:uppercase;letter-spacing:.06em;">${label}</th>`
		      );
		      const td = (value, alignRight, extra = '') => (
		        `<td style="padding:10px;border:1px solid #d0d7de;${alignRight ? 'text-align:right;font-variant-numeric:tabular-nums;font-weight:700;' : 'text-align:left;'}${extra}">${value}</td>`
		      );

		      let html = `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;">`;
		      html += `<thead><tr>`;
		      html += th('Item', false);
		      html += th('Description', false);
		      html += th('Qty', true);
		      if(showThreshold) html += th('Low', true);
		      html += `</tr></thead><tbody>`;

		      for(const it of rows){
		        const name = escapeHtml(it && it.name ? it.name : '');
		        const descRaw = String(it && it.desc ? it.desc : '').replace(/[\r\n]+/g,' ').trim();
		        const desc = escapeHtml(descRaw);
		        const qty = toInt(it && it.qty, 0);
		        html += `<tr>`;
		        html += td(`<strong>${name}</strong>`, false, 'word-break:break-word;overflow-wrap:anywhere;');
		        html += td(desc, false, 'word-break:break-word;overflow-wrap:anywhere;');
		        html += td(String(qty), true, '');
		        if(showThreshold){
		          const thr = effectiveLowStockQty(it);
		          html += td(String(toInt(thr,0)), true, '');
		        }
		        html += `</tr>`;
		      }

		      html += `</tbody></table>`;
		      return html;
		    }
		    function buildInventoryReportEmailHtml(data){
		      const d = data || reportDataSnapshot();
		      const when = formatEasternDateTime(new Date());

		      const metricsRow = (label, val) => (
		        `<tr>`+
		          `<td style="padding:8px 10px;border:1px solid #d0d7de;background:#f6f8fa;font-weight:700;">${label}</td>`+
		          `<td style="padding:8px 10px;border:1px solid #d0d7de;text-align:right;font-variant-numeric:tabular-nums;font-weight:800;">${val}</td>`+
		        `</tr>`
		      );

		      const metricsTable =
		        `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;margin:12px 0 18px;">`+
		          `<tbody>`+
		            metricsRow('Total Items', String(d.totalItems))+
		            metricsRow('In Stock', String(d.inStockCount))+
		            metricsRow('Low Stock', String(d.lowStockCount))+
		            metricsRow('Total Qty', String(d.totalQty))+
		          `</tbody>`+
		        `</table>`;

		      const lowStockBlock = d.lowStock && d.lowStock.length
		        ? (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Low Stock Items</div>`+
		            inventoryReportEmailTableHtml(d.lowStock, { showThreshold:true })+
		          `</div>`
		        )
		        : '';

		      const inventoryBlock = d.inStock && d.inStock.length
		        ? (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Current Inventory</div>`+
		            inventoryReportEmailTableHtml(d.inStock, { showThreshold:false })+
		          `</div>`
		        )
		        : (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Current Inventory</div>`+
		            `<div style="color:#57606a;">No in-stock items.</div>`+
		          `</div>`
		        );

		      const brandLogo = buildModulusLogoHtml({ width: 220, color: '#111', marginTop: 18 });
		      const brandLine = `<div style="margin-top:8px;font-size:12px;color:#6a737d;text-align:center;">contact@modulus-software.com</div>`;

		      return (
		        `<!doctype html>`+
		        `<html><body style="margin:0;padding:0;background:#ffffff;">`+
		          `<div style="max-width:760px;margin:0 auto;padding:18px 16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.35;">`+
		            `<h2 style="margin:0 0 10px;font-size:18px;">Inventory Report</h2>`+
		            `<div style="font-size:13px;color:#444;margin:0 0 6px;"><strong>Generated:</strong> ${escapeHtml(when)}</div>`+
		            `${metricsTable}`+
		            `${lowStockBlock}`+
		            `${inventoryBlock}`+
		            `${brandLogo}`+
		            `${brandLine}`+
		          `</div>`+
		        `</body></html>`
		      );
		    }

		    let _reportEmailHtml = '';
		    function setReportEmailMessage(msg){
		      const el = $('reportEmailMsg');
		      if(el) el.textContent = String(msg || '');
		    }
		    function renderReportEmailPreview(html){
		      const wrap = $('reportEmailPreview');
		      if(!wrap) return;
		      const safe = String(html || '').replace(/"/g, '&quot;');
		      wrap.innerHTML = `<iframe srcdoc="${safe}" sandbox="allow-same-origin"></iframe>`;
		    }
		    function defaultInventoryReportEmailSubject(){
		      const stamp = new Date().toISOString().slice(0,10);
		      return `Inventory Report (${stamp})`;
		    }
		    function openReportEmailModal(){
		      const data = reportDataSnapshot();
		      _reportEmailHtml = buildInventoryReportEmailHtml(data);
		      const to = $('reportEmailTo');
		      const subject = $('reportEmailSubject');
		      if(subject) subject.value = defaultInventoryReportEmailSubject();
		      if(to && !String(to.value || '').trim()){
		        const signed = getSignedInEmail();
		        if(signed) to.value = signed;
		      }
		      renderReportEmailPreview(_reportEmailHtml);
		      setReportEmailMessage('');
		      show('reportEmailModal', true);
		    }
		    function closeReportEmailModal(){
		      show('reportEmailModal', false);
		      setReportEmailMessage('');
		    }
		    async function sendInventoryReportEmailViaApi({ toEmail, subjectLine, html }){
		      const to = String(toEmail || '').trim();
		      const subject = String(subjectLine || '').trim() || defaultInventoryReportEmailSubject();
		      const replyTo = getSignedInEmail();
		      const apiUrl = getOrderApiUrl();

		      const headers = { 'content-type': 'application/json' };
		      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
		      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
		      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
		        headers['apikey'] = sbKey;
		        if(SB.session && SB.session.access_token){
		          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
		        }
		      }

		      const res = await fetch(apiUrl, {
		        method: 'POST',
		        headers,
		        body: JSON.stringify({ to, subject, html: String(html || ''), replyTo }),
		      });
		      let data = null;
		      try { data = await res.json(); } catch {}
		      if(!res.ok || !data || data.ok !== true){
		        const msg = (data && data.error) ? String(data.error) : `Send failed (${res.status})`;
		        throw Object.assign(new Error(msg), { status: res.status, data });
		      }
		      return data;
		    }

		    async function shareInventoryReport(){
		      openReportEmailModal();
		    }
		    function lowStockAlertsSilenced(){
		      try{
		        if(SB && SB.profile && typeof SB.profile.silence_low_stock_alerts !== 'undefined'){
		          return !!SB.profile.silence_low_stock_alerts;
		        }
	      }catch(e){}
	      try{
	        const raw = localStorage.getItem('inv.pref.silenceLowStockAlerts');
	        return raw === '1' || raw === 'true';
		      }catch(e){ return false; }
		    }
		    let _reportLoadToken = 0;
		    function setReportLoading(isLoading){
		      const prog = $('reportProgress');
		      const content = $('reportContent');
		      if(prog) prog.style.display = isLoading ? 'block' : 'none';
		      if(content) content.style.display = isLoading ? 'none' : 'block';
		    }
		    function setReportProgress(progress, label){
		      const p = Math.max(0, Math.min(100, Math.round(Number(progress) || 0)));
		      const labelEl = $('reportProgressLabel');
		      const valueEl = $('reportProgressValue');
		      const barEl = $('reportProgressBar');
		      const trackEl = $('reportProgress')?.querySelector('.report-progress-track');
		      if(labelEl && typeof label === 'string') labelEl.textContent = label;
		      if(valueEl) valueEl.textContent = `${p}%`;
		      if(barEl) barEl.style.width = `${p}%`;
		      if(trackEl) trackEl.setAttribute('aria-valuenow', String(p));
		    }
		    function simulateReportProgress(token){
		      let progress = 0;
		      const baseMs = 1000;
		      const phaseOneTarget = 40 + Math.random() * 10; // 40â€“50%
		      let phaseTwo = false;
		      let label = 'Analyzing Low Stock Items...';
		      const start = performance.now();
		      setReportProgress(0, label);

		      const tick = () => {
		        if(token !== _reportLoadToken) return;
		        const modal = $('reportModal');
		        if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;

		        const elapsed = performance.now() - start;
		        const timeCap = Math.min(100, (elapsed / baseMs) * 100 + 12);
		        const increment = (Math.random() * 9) + 3; // 3â€“12%
		        progress = Math.min(progress + increment, timeCap, 100);

		        if(!phaseTwo && progress >= phaseOneTarget){
		          phaseTwo = true;
		          label = 'Generating Current Inventory...';
		        }
		        setReportProgress(progress, label);

		        if(progress >= 100 || elapsed >= baseMs){
		          setReportProgress(100, label);
		          finishReportLoad(token);
		          return;
		        }

		        let delay = (Math.random() * 100) + 50; // 50â€“150ms
		        if(Math.random() < 0.14) delay += (Math.random() * 250) + 200; // occasional pause
		        setTimeout(tick, delay);
		      };
		      tick();
		    }
			    function finishReportLoad(token){
			      if(token !== _reportLoadToken) return;
			      setReportLoading(false);
			      renderInventoryReport();
			      const lowSection = $('reportLowStockSection'); if(lowSection) lowSection.open = false;
			      const exemptSection = $('reportExemptSection'); if(exemptSection) exemptSection.open = false;
			      const invSection = $('reportInventorySection'); if(invSection) invSection.open = false;
			      try{ syncReportOrderIndicators(); }catch(e){}
			    }
			    function startReportLoad(){
			      _reportLoadToken++;
			      const token = _reportLoadToken;
			      setReportLoading(true);
			      const lowSection = $('reportLowStockSection'); if(lowSection) lowSection.open = false;
			      const exemptSection = $('reportExemptSection'); if(exemptSection) exemptSection.open = false;
			      const invSection = $('reportInventorySection'); if(invSection) invSection.open = false;
			      simulateReportProgress(token);
			    }
				    function openReportModal(){
				      show('reportModal', true);
				      startReportLoad();
				    }
		    function closeReportModal(){
		      _reportLoadToken++;
		      show('reportModal', false);
		    }

	    // ========================
	    // Order engine (email-based)
	    // ========================
	    function getSignedInEmail(){
      return (SB && SB.user && SB.user.email) ? String(SB.user.email).trim() : '';
    }
    function userNameFromEmail(email){
      const e = String(email || '').trim();
      const local = e.includes('@') ? e.split('@')[0] : e;
      const cleaned = local
        .replace(/[._-]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      if(!cleaned) return '';
      return cleaned
        .split(' ')
        .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : '')
        .join(' ')
        .trim();
    }
    function formatStateToken(token){
      const t = String(token || '').trim().replace(/[.,]$/,'');
      if(!t) return '';
      if(t.length === 2) return t.toUpperCase();
      return t
        .split(/[\s_-]+/)
        .map(w => w ? (w[0].toUpperCase() + w.slice(1).toLowerCase()) : '')
        .join(' ')
        .trim();
    }
    function formatEasternDateTime(value){
      const d = (value instanceof Date) ? value : new Date(value);
      try{
        return new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/New_York',
          year: 'numeric',
          month: 'short',
          day: '2-digit',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true,
          timeZoneName: 'short',
        }).format(d);
      }catch{
        return d.toLocaleString(undefined, { hour12:true });
      }
    }
    function formatDateShort(value){
      if(!value) return '';
      const d = (value instanceof Date) ? value : new Date(value);
      if(Number.isNaN(d.getTime())) return String(value);
      try{
        return new Intl.DateTimeFormat('en-US', {
          year: 'numeric',
          month: 'short',
          day: '2-digit',
        }).format(d);
      }catch{
        return d.toLocaleDateString();
      }
    }
	    function getOrderCompanyName(){
	      const name = SB && SB.company && SB.company.company_name ? String(SB.company.company_name).trim() : '';
	      return name;
	    }
	    function generateInternalPoNumber(){
	      const digits = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
	      const letters = 'ABCDEFGHJKMNPQRSTVWXYZ';
	      let suffix = '';
	      for(let i = 0; i < 4; i++){
	        const idx = Math.floor(Math.random() * letters.length);
	        suffix += letters.charAt(idx);
	      }
	      return `${digits}-${suffix}`;
	    }
	    function ensureOrderIdentifiers(ord){
	      if(!ord) return;
	      if(!ord.internalPoNumber) ord.internalPoNumber = generateInternalPoNumber();
	    }
	    function getOrderIdentifier(ord){
	      if(!ord) return '';
	      const companyPo = String(ord.companyPoNumber || '').trim();
	      if(companyPo) return companyPo;
	      ensureOrderIdentifiers(ord);
	      return String(ord.internalPoNumber || '').trim();
	    }
    function composeOrderSubject(ord){
      const companyName = getOrderCompanyName();
      if(!companyName) return '';
      const po = getOrderIdentifier(ord);
      return po ? `Purchase Order ${po} \u2013 ${companyName}` : `Purchase Order \u2013 ${companyName}`;
    }
    function orderSubjectFromRow(row){
      const r = row || {};
      const explicit = String(r.subject_line || r.subject || '').trim();
      if(explicit) return explicit;
      const companyName = getOrderCompanyName();
      const po = String(
        r.company_po_number ||
        r.po_number ||
        r.internal_po_number ||
        r.internalPoNumber ||
        r.poNumber ||
        r.id ||
        ''
      ).trim();
      if(po && companyName) return `Purchase Order ${po} \u2013 ${companyName}`;
      if(po) return `Purchase Order ${po}`;
      if(companyName) return `Purchase Order \u2013 ${companyName}`;
      return 'Purchase Order';
    }
    function orderActiveLines(){
      const ord = orderState();
      return ord.lines
        .filter(l => toInt(l.qty, 0) > 0)
        .slice()
        .sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
    }
    function createEmptyOrderState(){
      return {
        lines:[],
        email:'',
        companyPoNumber:'',
        internalPoNumber:'',
        subject:'',
        notes:'',
        contactName:'',
        search:'',
        shippingAddressId:'',
        shippingAddressSnapshot:null,
        shortfall:null,
        shortfallAttached:false,
        source:'',
        relatedJobId:'',
        supplierId:'',
        supplierName:'',
        blockerBannerDismissed:false,
        blockerMultiSupplier:false,
        blockerHasUnknownSupplier:false,
        draftId: randomUUID()
      };
    }
    function orderState(){
      if(!state._order){
        state._order = createEmptyOrderState();
      }
      if(!Object.prototype.hasOwnProperty.call(state._order, 'shortfall')) state._order.shortfall = null;
      if(!Object.prototype.hasOwnProperty.call(state._order, 'shortfallAttached')) state._order.shortfallAttached = false;
      if(!Object.prototype.hasOwnProperty.call(state._order, 'source')) state._order.source = '';
      if(!Object.prototype.hasOwnProperty.call(state._order, 'relatedJobId')) state._order.relatedJobId = '';
      if(!Object.prototype.hasOwnProperty.call(state._order, 'supplierId')) state._order.supplierId = '';
      if(!Object.prototype.hasOwnProperty.call(state._order, 'supplierName')) state._order.supplierName = '';
      if(!Object.prototype.hasOwnProperty.call(state._order, 'blockerBannerDismissed')) state._order.blockerBannerDismissed = false;
      if(!Object.prototype.hasOwnProperty.call(state._order, 'blockerMultiSupplier')) state._order.blockerMultiSupplier = false;
      if(!Object.prototype.hasOwnProperty.call(state._order, 'blockerHasUnknownSupplier')) state._order.blockerHasUnknownSupplier = false;
      if(!state._order.draftId) state._order.draftId = randomUUID();
      ensureOrderIdentifiers(state._order);
      return state._order;
    }
    function setOrderShortfallLink({ shortfallId, jobId, itemId, qtyMissing } = {}){
      const id = String(shortfallId || '').trim();
      if(!id) return;
      const missing = Number(qtyMissing || 0);
      const ord = orderState();
      ord.shortfall = {
        id,
        jobId: String(jobId || '').trim(),
        itemId: String(itemId || '').trim(),
        qtyMissing: Number.isFinite(missing) ? missing : 0
      };
      ord.shortfallAttached = true;
    }
    function clearOrderShortfallLink(){
      const ord = orderState();
      ord.shortfall = null;
      ord.shortfallAttached = false;
    }
    function getOrderShortfallContext(ord){
      const entry = ord && ord.shortfall ? ord.shortfall : null;
      if(!entry || !entry.id) return null;
      const jobId = String(entry.jobId || '').trim();
      const itemId = String(entry.itemId || '').trim();
      const jobRow = jobId ? getJobById(jobId) : null;
      const jobName = jobRow ? String(jobRow.name || '').trim() : '';
      const jobNumber = getJobNumberValue(jobRow);
      const itemName = itemId ? String((getInventoryById(itemId) || {}).name || '').trim() : '';
      const qtyMissing = Number(entry.qtyMissing || 0);
      return { shortfallId: String(entry.id || '').trim(), jobId, itemId, jobName, jobNumber, itemName, qtyMissing };
    }
    function getJobShortfallTotal(jobId){
      const id = String(jobId || '').trim();
      if(!id || !state._jobShortfallsByJobId || typeof state._jobShortfallsByJobId.get !== 'function') return null;
      const jobMap = state._jobShortfallsByJobId.get(id);
      if(!jobMap || typeof jobMap.forEach !== 'function') return null;
      let total = 0;
      jobMap.forEach(entry=>{
        const qty = shortfallQtyFromEntry(entry);
        if(Number.isFinite(qty)) total += Math.max(0, qty);
      });
      return total;
    }
    function formatOrderShortfallSummary(ctx){
      if(!ctx) return '';
      const jobLabel = ctx.jobName
        ? ctx.jobName
        : (ctx.jobNumber ? `Job ${ctx.jobNumber}` : (ctx.jobId ? `Job ${shortId(ctx.jobId)}` : 'Job'));
      const totalMissing = ctx.jobId ? getJobShortfallTotal(ctx.jobId) : null;
      const missingValue = Number.isFinite(totalMissing) && totalMissing > 0
        ? totalMissing
        : (Number.isFinite(ctx.qtyMissing) ? ctx.qtyMissing : null);
      const missingLabel = Number.isFinite(missingValue) ? `Missing ${formatQty(missingValue)}` : 'Missing â€”';
      return `${jobLabel} â€¢ ${missingLabel}`;
    }
    function getOrderCommitmentKey(itemIds){
      const ids = Array.isArray(itemIds) ? itemIds.map(id => String(id || '').trim()).filter(Boolean) : [];
      ids.sort();
      return ids.join('|');
    }
    function normalizeSupplierId(value){
      const id = String(value || '').trim();
      return id;
    }
    function getItemSupplierId(item){
      if(!item) return '';
      const preferred = normalizeSupplierId(item.preferredSupplierId || item.preferred_supplier_id);
      if(preferred) return preferred;
      const fallback = normalizeSupplierId(item.defaultSupplierId || item.default_supplier_id);
      return fallback;
    }
    async function sbFetchItemSupplierMap(itemIds){
      const ids = Array.isArray(itemIds) ? itemIds.map(id => String(id || '').trim()).filter(Boolean) : [];
      if(!ids.length) return new Map();
      if(!SB.ready || !SB.session || !SB.companyId) return new Map();
      let data = null;
      for(let attempt = 0; attempt < 2; attempt++){
        let sel = 'id';
        if(SB.itemsHasPreferredSupplierId !== false) sel += ',preferred_supplier_id';
        if(SB.itemsHasDefaultSupplierId !== false) sel += ',default_supplier_id';
        if(sel === 'id') return new Map();
        const res = await SB.client
          .from('inventory_items')
          .select(sel)
          .eq('company_id', SB.companyId)
          .in('id', ids)
          .is('deleted_at', null);
        if(!res.error){
          data = res.data || [];
          if(sel.includes('preferred_supplier_id')) SB.itemsHasPreferredSupplierId = true;
          if(sel.includes('default_supplier_id')) SB.itemsHasDefaultSupplierId = true;
          break;
        }
        const msg = errToText(res.error).toLowerCase();
        let changed = false;
        if(msg.includes('preferred_supplier_id')){
          if(SB.itemsHasPreferredSupplierId !== false) changed = true;
          SB.itemsHasPreferredSupplierId = false;
        }
        if(msg.includes('default_supplier_id')){
          if(SB.itemsHasDefaultSupplierId !== false) changed = true;
          SB.itemsHasDefaultSupplierId = false;
        }
        if(!changed){
          console.warn('Supplier lookup failed', res.error);
          return new Map();
        }
      }
      const map = new Map();
      (Array.isArray(data) ? data : []).forEach(row=>{
        const id = String(row && row.id ? row.id : '').trim();
        if(!id) return;
        map.set(id, {
          preferred: normalizeSupplierId(row.preferred_supplier_id),
          fallback: normalizeSupplierId(row.default_supplier_id)
        });
      });
      return map;
    }
    async function sbFetchVendorsByIds(ids){
      const list = Array.isArray(ids) ? ids.map(id => String(id || '').trim()).filter(Boolean) : [];
      if(!list.length) return new Map();
      if(!SB.ready || !SB.session || !SB.companyId) return new Map();
      const { data, error } = await SB.client
        .from('vendors')
        .select('id,name')
        .eq('company_id', SB.companyId)
        .in('id', list);
      if(error){
        console.warn('Vendor lookup failed', error);
        return new Map();
      }
      const map = state._vendorsById && typeof state._vendorsById.get === 'function'
        ? state._vendorsById
        : new Map();
      (Array.isArray(data) ? data : []).forEach(row=>{
        const id = String(row && row.id ? row.id : '').trim();
        if(!id) return;
        map.set(id, String(row && row.name ? row.name : '').trim());
      });
      state._vendorsById = map;
      return map;
    }
    async function ensureVendorMap(ids){
      const map = state._vendorsById && typeof state._vendorsById.get === 'function'
        ? state._vendorsById
        : new Map();
      const missing = Array.isArray(ids)
        ? ids.filter(id => {
            const key = String(id || '').trim();
            return key && !map.has(key);
          })
        : [];
      if(missing.length){
        await sbFetchVendorsByIds(missing);
      }
      return state._vendorsById || new Map();
    }
    function getOrderDraftQueue(){
      if(!Array.isArray(state._orderDraftQueue)) state._orderDraftQueue = [];
      return state._orderDraftQueue;
    }
    function ensureOrderDraftQueue(){
      const queue = getOrderDraftQueue();
      const ord = orderState();
      if(!queue.some(o => o && o.draftId === ord.draftId)){
        queue.unshift(ord);
      }
      return queue;
    }
    function syncOrderInputsFromState(){
      const ord = orderState();
      const s = $('orderSearch'); if(s) s.value = ord.search || '';
      const e = $('orderEmail'); if(e) e.value = ord.email || '';
      const companyPo = $('orderCompanyPoNumber'); if(companyPo) companyPo.value = ord.companyPoNumber || '';
      const internalPo = $('orderInternalPoNumber'); if(internalPo) internalPo.value = ord.internalPoNumber || '';
      const sub = $('orderSubject'); if(sub) sub.value = ord.subject || composeOrderSubject(ord);
      const n = $('orderNotes'); if(n) n.value = ord.notes || '';
      try{ updateOrderSearchClearBtn(); }catch(e){}
      try{ renderOrderShippingOptionsList(); }catch(e){}
      try{ renderOrderPreview(); }catch(e){}
      try{ updateOrderWizardReviewSummary(); }catch(e){}
      try{ updateOrderWizardCartSummary(); }catch(e){}
    }
    function updateOrderDraftSelector(){
      const wrap = $('orderDraftSelector');
      const sel = $('orderDraftSelect');
      const meta = $('orderDraftMeta');
      if(!wrap || !sel) return;
      const queue = getOrderDraftQueue();
      if(queue.length <= 1){
        wrap.style.display = 'none';
        return;
      }
      wrap.style.display = 'flex';
      const options = queue.map((ord, idx)=>{
        const supplierLabel = ord.supplierName
          || (ord.supplierId ? `Supplier ${shortId(ord.supplierId)}` : 'Unassigned supplier');
        const count = (ord.lines || []).length;
        const itemsLabel = `${count} ${count === 1 ? 'item' : 'items'}`;
        return `<option value="${escapeHtmlAttr(ord.draftId)}">${escapeHtml(supplierLabel)} â€¢ ${escapeHtml(itemsLabel)}</option>`;
      });
      sel.innerHTML = options.join('');
      const activeId = orderState().draftId;
      if(activeId) sel.value = activeId;
      if(meta) meta.textContent = `${queue.length} draft orders`;
    }
    function setActiveOrderDraft(draftId){
      const queue = getOrderDraftQueue();
      const id = String(draftId || '').trim();
      if(!id) return;
      const ord = queue.find(o => o && o.draftId === id);
      if(!ord) return;
      state._order = ord;
      ensureOrderIdentifiers(state._order);
      syncOrderInputsFromState();
      renderOrderResults();
      renderOrderLines();
      updateOrderDraftSelector();
      try{ orderWizardUpdateUI(); }catch(e){}
    }
    async function loadOrderCommitmentsForCart(itemIds){
      const ids = Array.isArray(itemIds) ? itemIds.map(id => String(id || '').trim()).filter(Boolean) : [];
      const key = getOrderCommitmentKey(ids);
      if(state._orderCommitmentLoading) return false;
      if(key && state._orderCommitmentKey === key) return false;

      if(!ids.length){
        state._orderCommittedByItemId = new Map();
        state._orderJobCountByItemId = new Map();
        state._orderDraftJobCountByItemId = new Map();
        state._orderDraftJobAllocationsByItemId = new Map();
        state._orderIncomingByItemId = {};
        state._orderCommitmentKey = '';
        state._orderCommitmentError = '';
        return true;
      }
      if(!SB.ready || !SB.session || !SB.companyId) return false;

      state._orderCommitmentLoading = true;
      state._orderCommitmentKey = key;

      const committedMap = new Map();
      const jobCountMap = new Map();
      const draftCountMap = new Map();
      const draftRowsByItem = new Map();
      const draftJobSets = new Map();
      try{
        const incomingByItemId = await sbFetchIncomingInventoryByItem(SB.companyId, ids);
        const { data: committedRows, error: committedError } = await SB.client
          .from('inventory_committed_by_item')
          .select('item_id,committed_qty')
          .eq('company_id', SB.companyId)
          .in('item_id', ids);
        if(committedError) throw committedError;

        (Array.isArray(committedRows) ? committedRows : []).forEach(row=>{
          const itemId = String(row && row.item_id ? row.item_id : '').trim();
          if(!itemId) return;
          const qty = Number(row.committed_qty || 0);
          if(!Number.isFinite(qty)) return;
          committedMap.set(itemId, qty);
        });

        const { data: jobRows, error: jobError } = await SB.client
          .from('job_item_allocations')
          .select('item_id,job_id')
          .eq('company_id', SB.companyId)
          .in('item_id', ids)
          .in('status', ['approved','active']);
        if(jobError) throw jobError;

        const jobSets = new Map();
        (Array.isArray(jobRows) ? jobRows : []).forEach(row=>{
          const itemId = String(row && row.item_id ? row.item_id : '').trim();
          const jobId = String(row && row.job_id ? row.job_id : '').trim();
          if(!itemId || !jobId) return;
          if(!jobSets.has(itemId)) jobSets.set(itemId, new Set());
          jobSets.get(itemId).add(jobId);
        });
        jobSets.forEach((set, itemId)=>{
          jobCountMap.set(itemId, set.size);
        });

        const { data: draftRows, error: draftError } = await SB.client
          .from('job_item_allocations')
          .select('item_id,job_id,qty_required')
          .eq('company_id', SB.companyId)
          .in('item_id', ids)
          .eq('status', 'planned');
        if(!draftError && Array.isArray(draftRows)){
          draftRows.forEach(row=>{
            const itemId = String(row && row.item_id ? row.item_id : '').trim();
            const jobId = String(row && row.job_id ? row.job_id : '').trim();
            if(!itemId || !jobId) return;
            const qty = Number(row && row.qty_required != null ? row.qty_required : 0);
            if(!draftRowsByItem.has(itemId)) draftRowsByItem.set(itemId, []);
            draftRowsByItem.get(itemId).push({ job_id: jobId, qty_required: qty });
            if(!draftJobSets.has(itemId)) draftJobSets.set(itemId, new Set());
            draftJobSets.get(itemId).add(jobId);
          });
        }

        const missingDraftIds = ids.filter(itemId => !draftRowsByItem.has(itemId));
        if(missingDraftIds.length){
          const derivedDraft = await buildDraftDemandSnapshot(missingDraftIds);
          if(derivedDraft && derivedDraft.rowsByItem && typeof derivedDraft.rowsByItem.forEach === 'function'){
            derivedDraft.rowsByItem.forEach((rows, itemId)=>{
              if(!draftRowsByItem.has(itemId)) draftRowsByItem.set(itemId, []);
              (rows || []).forEach(row=>{
                const jobId = String(row && row.job_id ? row.job_id : '').trim();
                if(!jobId) return;
                draftRowsByItem.get(itemId).push(row);
                if(!draftJobSets.has(itemId)) draftJobSets.set(itemId, new Set());
                draftJobSets.get(itemId).add(jobId);
              });
            });
          }
        }

        draftJobSets.forEach((set, itemId)=>{
          draftCountMap.set(itemId, set.size);
        });

        state._orderCommittedByItemId = committedMap;
        state._orderJobCountByItemId = jobCountMap;
        state._orderDraftJobCountByItemId = draftCountMap;
        state._orderIncomingByItemId = incomingByItemId || {};
        state._orderDraftJobAllocationsByItemId = new Map();
        ids.forEach(itemId=>{
          state._orderDraftJobAllocationsByItemId.set(itemId, {
            rows: draftRowsByItem.get(itemId) || [],
            loading: false,
            loaded: true,
            error: ''
          });
        });
        state._orderCommitmentError = '';
        return true;
      }catch(e){
        state._orderCommitmentError = e && e.message ? e.message : 'Failed to load commitments';
        state._orderCommitmentKey = '';
        state._orderDraftJobCountByItemId = new Map();
        state._orderDraftJobAllocationsByItemId = new Map();
        state._orderIncomingByItemId = {};
        return false;
      }finally{
        state._orderCommitmentLoading = false;
      }
    }
    async function buildDraftDemandSnapshot(itemIds){
      const ids = Array.isArray(itemIds) ? itemIds.map(id => String(id || '').trim()).filter(Boolean) : [];
      const countMap = new Map();
      const rowsByItem = new Map();
      if(!ids.length) return { countMap, rowsByItem };
      if(!SB.ready || !SB.session || !SB.companyId) return { countMap, rowsByItem };

      let jobs = Array.isArray(state._jobs) ? state._jobs : [];
      if(!jobs.length){
        try{
          jobs = await sbFetchJobs();
          state._jobs = jobs;
          state._jobsById = new Map((jobs || []).map(r => [String(r && r.id ? r.id : ''), r]).filter(x => x[0]));
        }catch(e){
          return { countMap, rowsByItem };
        }
      }

      const draftJobs = (jobs || []).filter(job => ['draft', 'quoted'].includes(String(job && job.status ? job.status : '').trim()));
      if(!draftJobs.length) return { countMap, rowsByItem };
      const jobIds = draftJobs.map(job => job && job.id).filter(Boolean);
      if(!jobIds.length) return { countMap, rowsByItem };

      let jobBomMap = new Map();
      const bomCache = state._jobBomByJobId && typeof state._jobBomByJobId.get === 'function';
      const hasBomCache = bomCache && jobIds.every(id => state._jobBomByJobId.has(id));
      if(hasBomCache){
        jobBomMap = state._jobBomByJobId;
      }else{
        try{
          jobBomMap = await sbFetchJobBomForJobs(jobIds);
        }catch(e){
          jobBomMap = new Map();
        }
      }

      let reservedMap = (state._jobReservedMap && typeof state._jobReservedMap.get === 'function')
        ? state._jobReservedMap
        : null;
      if(!reservedMap){
        try{
          reservedMap = await sbFetchReservedMap();
          state._jobReservedMap = reservedMap;
        }catch(e){
          reservedMap = new Map();
        }
      }

      const inventoryMap = (state._jobInventoryByItemId && typeof state._jobInventoryByItemId.get === 'function')
        ? state._jobInventoryByItemId
        : null;
      const itemSet = new Set(ids);
      const itemJobQtyMap = new Map();

      draftJobs.forEach(job=>{
        const jobId = String(job && job.id ? job.id : '').trim();
        if(!jobId) return;
        const lines = jobBomMap && typeof jobBomMap.get === 'function' ? (jobBomMap.get(jobId) || []) : [];
        (lines || []).forEach(line=>{
          const itemId = String(line && line.item_id ? line.item_id : '').trim();
          if(!itemId || !itemSet.has(itemId)) return;
          const qtyPlanned = Number(line && line.qty_planned != null ? line.qty_planned : 0);
          if(!Number.isFinite(qtyPlanned) || qtyPlanned <= 0) return;
          if(!itemJobQtyMap.has(itemId)) itemJobQtyMap.set(itemId, new Map());
          const jobQtyMap = itemJobQtyMap.get(itemId);
          jobQtyMap.set(jobId, (jobQtyMap.get(jobId) || 0) + qtyPlanned);
        });
      });

      const jobSets = new Map();
      itemJobQtyMap.forEach((jobQtyMap, itemId)=>{
        jobQtyMap.forEach((qtyPlanned, jobId)=>{
          const stats = computeJobLineStats(itemId, qtyPlanned, reservedMap, inventoryMap);
          const shortfall = Math.max(0, Number(stats && stats.shortfall != null ? stats.shortfall : 0));
          if(shortfall <= 0) return;
          if(!rowsByItem.has(itemId)) rowsByItem.set(itemId, []);
          rowsByItem.get(itemId).push({ job_id: jobId, qty_required: qtyPlanned, shortfall });
          if(!jobSets.has(itemId)) jobSets.set(itemId, new Set());
          jobSets.get(itemId).add(jobId);
        });
      });

      jobSets.forEach((set, itemId)=>{
        countMap.set(itemId, set.size);
      });
      return { countMap, rowsByItem };
    }
    function applyOrderCommitmentStats(line, onHandValue){
      const committedMap = state._orderCommittedByItemId || new Map();
      const jobCountMap = state._orderJobCountByItemId || new Map();
      const incomingMap = state._orderIncomingByItemId || {};
      const committed = Number(committedMap.get(line.id) || 0);
      const jobCount = Number(jobCountMap.get(line.id) || 0);
      const onHand = Number.isFinite(onHandValue) ? onHandValue : 0;
      const incoming = Number(incomingMap[line.id] || 0);
      const available = onHand + incoming - committed;
      const shortfall = Math.max(0, committed - (onHand + incoming));
      const out = { committed, available, shortfall, jobCount, incoming };
      line._commitment = out;
      return out;
    }
    function isOrderLineExpanded(itemId){
      const set = state._orderLineExpanded || new Set();
      return set.has(String(itemId || '').trim());
    }
    function toggleOrderLineExpanded(itemId){
      const id = String(itemId || '').trim();
      if(!id) return;
      if(!state._orderLineExpanded) state._orderLineExpanded = new Set();
      if(state._orderLineExpanded.has(id)){
        state._orderLineExpanded.delete(id);
      }else{
        state._orderLineExpanded.add(id);
      }
      renderOrderLines();
      if(state._orderLineExpanded.has(id)){
        void loadOrderJobAllocationsForItem(id).then(()=> renderOrderLines());
      }
    }
    function getOrderJobAllocationsState(itemId){
      if(!state._orderJobAllocationsByItemId) state._orderJobAllocationsByItemId = new Map();
      const id = String(itemId || '').trim();
      if(!state._orderJobAllocationsByItemId.has(id)){
        state._orderJobAllocationsByItemId.set(id, { rows: [], loading: false, loaded: false, error: '' });
      }
      return state._orderJobAllocationsByItemId.get(id);
    }
    function getJobById(jobId){
      const id = String(jobId || '').trim();
      if(!id) return null;
      return (state._jobsById && typeof state._jobsById.get === 'function')
        ? (state._jobsById.get(id) || null)
        : null;
    }
    function getJobNumberValue(job){
      const raw = job ? (job.job_number || job.jobNumber) : '';
      const val = String(raw || '').trim();
      return val;
    }
    function formatJobNumberLabel(job){
      const num = getJobNumberValue(job);
      return num ? `Job ${num}` : 'Job';
    }
    function formatJobNameWithNumber(job){
      const num = getJobNumberValue(job);
      const name = job ? String(job.name || '').trim() : '';
      if(num && name) return `Job ${num} - ${name}`;
      if(num) return `Job ${num}`;
      return name || 'Job';
    }
    function getJobCompletionDate(job){
      if(!job) return '';
      const raw = job.completed_at || job.completed_on || job.completed_date || (String(job.status || '') === 'completed' ? job.updated_at : '');
      return raw ? formatDateShort(raw) : '';
    }
    function getOrderRelatedJobNumbers(ord){
      const list = [];
      const seen = new Set();
      const addNumber = (num) => {
        const val = String(num || '').trim();
        if(!val || seen.has(val)) return;
        seen.add(val);
        list.push(val);
      };
      const addJobId = (id) => {
        const row = getJobById(id);
        if(row){
          const num = getJobNumberValue(row);
          if(num) addNumber(num);
        }
      };
      if(ord){
        if(Array.isArray(ord.relatedJobNumbers)){
          ord.relatedJobNumbers.forEach(addNumber);
        }
        if(ord.relatedJobId) addJobId(ord.relatedJobId);
        if(ord.shortfall && ord.shortfall.jobId) addJobId(ord.shortfall.jobId);
      }
      return list;
    }
    function getOrderJobLabel(jobId){
      const id = String(jobId || '').trim();
      if(!id) return 'Job';
      const row = getJobById(id);
      const name = row ? String(row.name || '').trim() : '';
      const num = getJobNumberValue(row);
      if(num && name) return `Job ${num} - ${name}`;
      if(num) return `Job ${num}`;
      return name || `Job ${shortId(id) || id}`;
    }
    async function loadOrderJobAllocationsForItem(itemId){
      const id = String(itemId || '').trim();
      if(!id) return;
      const entry = getOrderJobAllocationsState(id);
      if(entry.loading) return;
      if(!SB.ready || !SB.session || !SB.companyId) return;

      entry.loading = true;
      entry.error = '';
      try{
        const { data, error } = await SB.client
          .from('job_item_allocations')
          .select('job_id,qty_required,status')
          .eq('company_id', SB.companyId)
          .eq('item_id', id)
          .in('status', ['approved','active']);
        if(error) throw error;
        entry.rows = Array.isArray(data) ? data : [];
        entry.loaded = true;
      }catch(e){
        entry.error = e && e.message ? e.message : 'Unable to load jobs';
        entry.rows = [];
        entry.loaded = false;
      }finally{
        entry.loading = false;
      }
    }
    function getOrderDraftJobAllocationsState(itemId){
      if(!state._orderDraftJobAllocationsByItemId) state._orderDraftJobAllocationsByItemId = new Map();
      const id = String(itemId || '').trim();
      if(!state._orderDraftJobAllocationsByItemId.has(id)){
        state._orderDraftJobAllocationsByItemId.set(id, { rows: [], loading: false, loaded: false, error: '' });
      }
      return state._orderDraftJobAllocationsByItemId.get(id);
    }
    async function loadOrderDraftJobAllocationsForItem(itemId){
      const id = String(itemId || '').trim();
      if(!id) return;
      const entry = getOrderDraftJobAllocationsState(id);
      if(entry.loaded) return;
      if(entry.loading) return;
      if(!SB.ready || !SB.session || !SB.companyId) return;

      entry.loading = true;
      entry.error = '';
      try{
        const { data, error } = await SB.client
          .from('job_item_allocations')
          .select('job_id,qty_required,status')
          .eq('company_id', SB.companyId)
          .eq('item_id', id)
          .eq('status', 'planned');
        if(error) throw error;
        entry.rows = Array.isArray(data) ? data : [];
        entry.loaded = true;
      }catch(e){
        entry.error = e && e.message ? e.message : 'Unable to load draft jobs';
        entry.rows = [];
        entry.loaded = false;
      }finally{
        entry.loading = false;
      }
    }
    function renderOrderMiniCard({ title, qty, badgeLabel, badgeClass, cardClass, subtext } = {}){
      const safeTitle = String(title || '').trim() || 'Job';
      const qtyValue = Number.isFinite(qty) ? `${formatQty(qty)} units` : '';
      const subText = String(subtext || '').trim();
      const cardTone = cardClass ? `mini-card ${cardClass}` : 'mini-card';
      const badgeTone = badgeClass ? `mini-card-badge ${badgeClass}` : 'mini-card-badge';
      const qtyHtml = qtyValue ? `<div class="mini-card-qty">${escapeHtml(qtyValue)}</div>` : '';
      const subHtml = subText ? `<div class="mini-card-subtext">${escapeHtml(subText)}</div>` : '';
      const badgeHtml = badgeLabel
        ? `<div class="${badgeTone}">${escapeHtml(String(badgeLabel))}</div>`
        : '';
      return (
        `<div class="${cardTone}">`+
          `<div class="mini-card-main">`+
            `<div class="mini-card-title">${escapeHtml(safeTitle)}</div>`+
            subHtml+
          `</div>`+
          `<div class="mini-card-meta">`+
            qtyHtml+
            badgeHtml+
          `</div>`+
        `</div>`
      );
    }
    function renderOrderDraftDemandSummaryCard({ requiredQty, remainingQty } = {}){
      const req = Number(requiredQty || 0);
      if(!Number.isFinite(req) || req <= 0) return '';
      const remaining = Math.max(0, Number(remainingQty || 0));
      const subtext = `${formatQty(req)} units required`;
      if(remaining === 0){
        return (
          `<div class="mini-card mini-card--committed">`+
            `<div class="mini-card-main">`+
              `<div class="mini-card-title">Draft demand</div>`+
              `<div class="mini-card-subtext">${escapeHtml(subtext)}</div>`+
            `</div>`+
            `<div class="mini-card-meta">`+
              `<div class="mini-card-status mini-card-status--success">`+
                `${ICONS.checkCircle}`+
                `<span>This order will unblock all draft jobs</span>`+
              `</div>`+
            `</div>`+
          `</div>`
        );
      }
      return (
        `<div class="mini-card mini-card--draft">`+
          `<div class="mini-card-main">`+
            `<div class="mini-card-title">Draft demand</div>`+
            `<div class="mini-card-subtext">${escapeHtml(subtext)}</div>`+
          `</div>`+
          `<div class="mini-card-meta">`+
            `<div class="mini-card-status mini-card-status--warning">`+
              `${ICONS.alertTriangle}`+
              `<span>${escapeHtml(formatQty(remaining))} more needed to approve jobs</span>`+
            `</div>`+
          `</div>`+
        `</div>`
      );
    }
    function renderOrderMiniCardPlaceholder(text){
      const label = String(text || '').trim() || 'None';
      return `<div class="mini-card mini-card--empty"><div class="mini-card-title">${escapeHtml(label)}</div></div>`;
    }
    function computeOrderDraftImpact(lines){
      const result = {
        totalDraftJobs: 0,
        unblockedDraftJobs: 0,
        remainingDraftJobs: 0,
        ready: false,
        unblockedJobIds: []
      };
      if(!Array.isArray(lines) || !lines.length) return result;
      const draftMap = state._orderDraftJobAllocationsByItemId;
      if(!draftMap || typeof draftMap.get !== 'function') return result;

      const lineQtyByItem = new Map();
      lines.forEach(line => {
        const itemId = String(line && line.id ? line.id : '').trim();
        if(!itemId) return;
        lineQtyByItem.set(itemId, toInt(line && line.qty != null ? line.qty : 0, 0));
      });

      const jobItemRequirements = new Map();
      for(const [itemId, cartQty] of lineQtyByItem.entries()){
        const entry = draftMap.get(itemId);
        if(!entry) continue;
        if(entry.loading || (!entry.loaded && !entry.error)) return result;
        if(entry.error) return result;
        if(!Array.isArray(entry.rows) || !entry.rows.length) continue;
        entry.rows.forEach(row => {
          const jobId = String(row && row.job_id ? row.job_id : '').trim();
          if(!jobId) return;
          const qty = toInt(row && row.qty_required != null ? row.qty_required : 0, 0);
          if(qty <= 0) return;
          if(!jobItemRequirements.has(jobId)) jobItemRequirements.set(jobId, new Map());
          const itemMap = jobItemRequirements.get(jobId);
          itemMap.set(itemId, (itemMap.get(itemId) || 0) + qty);
        });
      }

      if(jobItemRequirements.size === 0){
        result.ready = true;
        return result;
      }

      let unblocked = 0;
      const unblockedJobIds = [];
      jobItemRequirements.forEach((itemMap, jobId) => {
        let satisfied = true;
        itemMap.forEach((requiredQty, itemId) => {
          const cartQty = lineQtyByItem.get(itemId) || 0;
          if(cartQty < requiredQty){
            satisfied = false;
          }
        });
        if(satisfied){
          unblocked += 1;
          if(jobId) unblockedJobIds.push(jobId);
        }
      });

      result.totalDraftJobs = jobItemRequirements.size;
      result.unblockedDraftJobs = unblocked;
      result.remainingDraftJobs = Math.max(0, result.totalDraftJobs - unblocked);
      result.unblockedJobIds = unblockedJobIds;
      result.ready = true;
      return result;
    }
    function updateOrderImpactCard(lines){
      const card = $('orderImpactCard');
      if(!card) return;
      if(typeof state._orderImpactExpanded !== 'boolean') state._orderImpactExpanded = false;
      const impact = computeOrderDraftImpact(lines);
      if(!impact.ready || impact.totalDraftJobs === 0){
        state._orderImpactExpanded = false;
        card.style.display = 'none';
        card.innerHTML = '';
        return;
      }
      const unblocked = impact.unblockedDraftJobs;
      const remaining = impact.remainingDraftJobs;
      const unblockedJobIds = Array.isArray(impact.unblockedJobIds) ? impact.unblockedJobIds : [];
      const unblockedLabels = unblockedJobIds.map(id => getOrderJobLabel(id)).filter(Boolean);
      const incomingMap = state._orderIncomingByItemId || {};
      let hasIncomingForDraft = false;
      if(remaining > 0 && Array.isArray(lines)){
        const draftMap = state._orderDraftJobAllocationsByItemId;
        if(draftMap && typeof draftMap.get === 'function'){
          lines.forEach(line=>{
            const itemId = String(line && line.id ? line.id : '').trim();
            if(!itemId) return;
            const entry = draftMap.get(itemId);
            if(!entry || !Array.isArray(entry.rows) || !entry.rows.length) return;
            const incoming = Number(incomingMap[itemId] || 0);
            if(incoming > 0) hasIncomingForDraft = true;
          });
        }
      }
      const showJobs = unblockedLabels.length > 0;
      const isExpanded = !!state._orderImpactExpanded;
      const incomingNote = (remaining > 0 && hasIncomingForDraft)
        ? `<div class="order-impact-note">Some items are already on order.</div>`
        : '';
      const jobsMarkup = showJobs
        ? (
          `<div class="order-impact-jobs">`+
            `<button type="button" class="order-impact-toggle${isExpanded ? ' is-expanded' : ''}" data-order-impact-toggle="true">`+
              `<span>${isExpanded ? 'Hide jobs' : `Show ${unblockedLabels.length} ${unblockedLabels.length === 1 ? 'job' : 'jobs'}`}</span>`+
              `${ICONS.chevronDown}`+
            `</button>`+
            `<div class="order-impact-joblist${isExpanded ? ' is-expanded' : ''}">`+
              `${unblockedLabels.map(label => `<div class="order-impact-job">${escapeHtml(label)}</div>`).join('')}`+
            `</div>`+
          `</div>`
        )
        : '';
      if(remaining === 0){
        card.className = 'order-impact-card order-impact-card--success';
        card.innerHTML =
          `<div class="order-impact-title">Order impact</div>`+
          `<div class="order-impact-main">`+
            `<span class="order-impact-icon">${ICONS.checkCircle}</span>`+
            `<span>This order will unblock all draft jobs.</span>`+
          `</div>`+
          `<div class="order-impact-secondary">${formatQty(unblocked)} ${unblocked === 1 ? 'job' : 'jobs'} can now be approved.</div>`+
          jobsMarkup;
      }else{
        card.className = 'order-impact-card order-impact-card--warning';
        card.innerHTML =
          `<div class="order-impact-title">Order impact</div>`+
          `<div class="order-impact-main">`+
            `<span class="order-impact-icon">${ICONS.alertTriangle}</span>`+
            `<span>This order will unblock ${formatQty(unblocked)} ${unblocked === 1 ? 'draft job' : 'draft jobs'}.</span>`+
          `</div>`+
          `<div class="order-impact-secondary">${formatQty(remaining)} ${remaining === 1 ? 'job will' : 'jobs will'} still require inventory.</div>`+
          incomingNote+
          jobsMarkup;
      }
      card.style.display = '';
      const toggle = card.querySelector('[data-order-impact-toggle]');
      if(toggle){
        toggle.addEventListener('click', ()=>{
          state._orderImpactExpanded = !state._orderImpactExpanded;
          updateOrderImpactCard(orderState().lines || []);
        });
      }
    }

    // =========================================
    // ORDER WIZARD NAVIGATION
    // =========================================
    let _orderWizardStep = 0;
    const ORDER_WIZARD_STEPS = ['Cart', 'Delivery', 'Review'];

    function orderWizardGoTo(step){
      const maxStep = ORDER_WIZARD_STEPS.length - 1;
      const newStep = Math.max(0, Math.min(maxStep, step));
      if(newStep === _orderWizardStep) return;
      _orderWizardStep = newStep;
      orderWizardUpdateUI();
    }

    function orderWizardNext(){
      const ord = orderState();
      // Validate current step before proceeding
      if(_orderWizardStep === 0){
        // Cart step: must have at least 1 item
        if(!ord.lines.length){
          toast('Add at least 1 item to continue');
          return;
        }
      } else if(_orderWizardStep === 1){
        // Delivery step: must have email
        const email = String(ord.email || '').trim();
        if(!email){
          toast('Enter a recipient email');
          const emailInput = $('orderEmail');
          if(emailInput) emailInput.focus();
          return;
        }
        // Render email preview when moving to review
        renderOrderPreview();
      }
      orderWizardGoTo(_orderWizardStep + 1);
    }

    function orderWizardPrev(){
      orderWizardGoTo(_orderWizardStep - 1);
    }

    function orderWizardUpdateUI(){
      const step = _orderWizardStep;
      const ord = orderState();

      // Update stepper pills
      for(let i = 0; i < ORDER_WIZARD_STEPS.length; i++){
        const stepEl = $('orderWizStep' + i);
        const connEl = $('orderWizConn' + (i + 1));
        const panelEl = $('orderWizPanel' + i);
        if(!stepEl) continue;

        stepEl.classList.remove('active', 'completed');
        if(i < step){
          stepEl.classList.add('completed');
        } else if(i === step){
          stepEl.classList.add('active');
        }

        if(connEl){
          connEl.classList.remove('active', 'completed');
          if(i < step){
            connEl.classList.add('completed');
          } else if(i === step){
            connEl.classList.add('active');
          }
        }

        if(panelEl){
          panelEl.classList.remove('active', 'exit-left');
          if(i === step){
            panelEl.classList.add('active');
          } else if(i < step){
            panelEl.classList.add('exit-left');
          }
        }
      }

      // Update footer buttons
      const btnPrev = $('btnOrderWizPrev');
      const btnNext = $('btnOrderWizNext');
      const btnSubmit = $('btnOrderSubmit');
      const btnCopy = $('btnOrderCopy');

      if(btnPrev){
        btnPrev.style.display = step > 0 ? '' : 'none';
      }
      if(btnNext){
        btnNext.style.display = step < ORDER_WIZARD_STEPS.length - 1 ? '' : 'none';
        // Disable next if cart is empty on step 0
        if(step === 0){
          btnNext.disabled = !ord.lines.length;
        } else if(step === 1){
          btnNext.disabled = !String(ord.email || '').trim();
        } else {
          btnNext.disabled = false;
        }
      }
      if(btnSubmit){
        btnSubmit.style.display = step === ORDER_WIZARD_STEPS.length - 1 ? '' : 'none';
      }
      if(btnCopy){
        btnCopy.style.display = step === ORDER_WIZARD_STEPS.length - 1 ? '' : 'none';
      }
      const btnHistory = $('btnOrderHistory');
      if(btnHistory){
        btnHistory.style.display = step === ORDER_WIZARD_STEPS.length - 1 ? '' : 'none';
      }

      // Update cart summary
      updateOrderWizardCartSummary();

      // Update shipping preview
      if(step === 1){
        updateOrderWizardShippingPreview();
      }

      // Update review summary card
      if(step === ORDER_WIZARD_STEPS.length - 1){
        updateOrderWizardReviewSummary();
      }
    }

    function updateOrderWizardCartSummary(){
      const ord = orderState();
      const count = ord.lines.length;
      const summary = $('orderCartSummary');
      const countEl = $('orderCartCount');
      const countBadge = $('orderCartCountBadge');
      if(summary){
        summary.style.display = count > 0 ? 'flex' : 'none';
      }
      if(countEl){
        countEl.textContent = String(count);
      }
      if(countBadge){
        countBadge.textContent = `${count} ${count === 1 ? 'item' : 'items'}`;
        countBadge.style.display = count > 0 ? 'inline-flex' : 'none';
      }
    }

    function updateOrderWizardShippingPreview(){
      const ord = orderState();
      renderOrderShippingOptionsList();
      const previewWrap = $('orderShippingPreview');
      const nameEl = $('orderShippingPreviewName');
      const textEl = $('orderShippingPreviewText');
      if(!previewWrap) return;

      const addressId = ord.shippingAddressId;
      if(!addressId){
        previewWrap.style.display = 'none';
        return;
      }

      const row = (state._orderShippingById && typeof state._orderShippingById.get === 'function'
        ? state._orderShippingById.get(addressId)
        : null)
        || (state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
          ? state._shippingAddressById.get(addressId)
          : null);

      if(!row){
        previewWrap.style.display = 'none';
        return;
      }

      previewWrap.style.display = 'block';
      if(nameEl) nameEl.textContent = row.label || 'Address';
      if(textEl) textEl.textContent = row.address || '';
    }

    function updateOrderWizardReviewSummary(){
      const ord = orderState();
      const itemCountEl = $('orderReviewItemCount');
      const recipientEl = $('orderReviewRecipient');
      const shipToEl = $('orderReviewShipTo');
      const jobsRow = $('orderReviewJobsRow');
      const jobsLabel = $('orderReviewJobsLabel');
      const jobsValue = $('orderReviewJobsValue');
      const shortfallRow = $('orderReviewShortfallRow');
      const shortfallValue = $('orderReviewShortfallValue');
      const shortfallToggle = $('orderReviewShortfallToggle');
      const shortfallToggleInput = $('orderShortfallAttachToggle');
      const shortfallHint = $('orderReviewShortfallHint');

      if(itemCountEl){
        itemCountEl.textContent = String(ord.lines.length);
      }

      if(recipientEl){
        const email = String(ord.email || '').trim();
        recipientEl.textContent = email || 'â€”';
      }

      if(shipToEl){
        const addressId = ord.shippingAddressId;
        let shipLabel = 'â€”';
        let shipAddress = '';
        if(addressId){
          const row = (state._orderShippingById && typeof state._orderShippingById.get === 'function'
            ? state._orderShippingById.get(addressId)
            : null)
            || (state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
              ? state._shippingAddressById.get(addressId)
              : null);
          if(row){
            shipLabel = row.label || 'Address';
            shipAddress = row.address || '';
          }
        }
        if(shipLabel === 'â€”' && !shipAddress){
          shipToEl.textContent = 'â€”';
        }else{
          const labelHtml = escapeHtml(shipLabel || 'Address');
          const addressHtml = shipAddress
            ? `<span class="address">${escapeHtml(shipAddress)}</span>`
            : '';
          shipToEl.innerHTML = `${labelHtml}${addressHtml}`;
        }
      }

      const relatedJobs = getOrderRelatedJobNumbers(ord);
      if(relatedJobs.length){
        if(jobsRow) jobsRow.style.display = '';
        if(jobsLabel) jobsLabel.textContent = relatedJobs.length === 1 ? 'Related job' : 'Related jobs';
        if(jobsValue) jobsValue.innerHTML = relatedJobs.map(n => escapeHtml(n)).join('<br>');
      }else{
        if(jobsRow) jobsRow.style.display = 'none';
        if(jobsValue) jobsValue.textContent = 'â€”';
      }
      const shortfallCtx = getOrderShortfallContext(ord);
      if(shortfallCtx){
        const summary = formatOrderShortfallSummary(shortfallCtx);
        if(shortfallValue) shortfallValue.textContent = summary || 'â€”';
        if(shortfallRow) shortfallRow.style.display = '';
        if(shortfallToggle) shortfallToggle.style.display = '';
        if(shortfallToggleInput){
          shortfallToggleInput.checked = !!ord.shortfallAttached;
          shortfallToggleInput.disabled = false;
        }
        if(shortfallHint){
          shortfallHint.textContent = ord.shortfallAttached
            ? 'Traceability only. Shortfalls resolve through allocation, not ordering.'
            : 'Not attached. This order will not be linked to the shortfall.';
        }
      }else{
        if(shortfallRow) shortfallRow.style.display = 'none';
        if(shortfallToggle) shortfallToggle.style.display = 'none';
        if(shortfallValue) shortfallValue.textContent = 'â€”';
        if(shortfallHint) shortfallHint.textContent = '';
        if(shortfallToggleInput) shortfallToggleInput.checked = false;
      }
    }

    function resetOrderWizard(){
      _orderWizardStep = 0;
      orderWizardUpdateUI();
    }

    function getOrderRecommendationState(){
      if(!state._orderRecommendations){
        state._orderRecommendations = {
          plannedByItemId: new Map(),
          incomingSupplyByItemId: new Map(),
          ready: false,
          loading: false,
          updatedAt: null,
          error: ''
        };
      }
      return state._orderRecommendations;
    }
    function buildApprovedIncomingSupplyMap(){
      const map = new Map();
      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
      if(!rows.length) return map;
      const lineMap = state._orderHistoryLinesByPo || new Map();
      rows.forEach(row=>{
        const status = normalizePurchaseOrderStatus(row && row.status ? row.status : '');
        if(status !== 'submitted' && status !== 'partially_received') return;
        const orderId = String(row && row.id ? row.id : '').trim();
        if(!orderId) return;
        const lines = normalizePurchaseOrderLines(lineMap.get(orderId) || []);
        lines.forEach(line=>{
          const itemId = String(line.item_id || '').trim();
          if(!itemId) return;
          const ordered = toQty(line.quantity_ordered, 0);
          const received = toQty(line.quantity_received, 0);
          const remaining = Math.max(0, ordered - received);
          if(remaining <= 0) return;
          map.set(itemId, (map.get(itemId) || 0) + remaining);
        });
      });
      return map;
    }
    async function ensureOrderRecommendationData(force = false){
      const recState = getOrderRecommendationState();
      if(recState.loading) return;
      if(recState.ready && !force) return;
      recState.loading = true;
      recState.ready = false;
      recState.error = '';
      try{
        await ensureInventoryLoaded();
        let jobs = Array.isArray(state._jobs) ? state._jobs : [];
        if(!jobs.length || force){
          jobs = await sbFetchJobs();
          state._jobs = jobs;
          state._jobsById = new Map((jobs || []).map(r => [String(r && r.id ? r.id : ''), r]).filter(x => x[0]));
        }
        const approvedJobs = (jobs || []).filter(j => String(j && j.status ? j.status : '').trim() === 'approved');
        const jobIds = approvedJobs.map(j => j && j.id).filter(Boolean);
        let jobBomMap = new Map();
        if(jobIds.length){
          jobBomMap = await sbFetchJobBomForJobs(jobIds);
        }
        const plannedByItemId = new Map();
        jobBomMap.forEach(lines=>{
          (lines || []).forEach(line=>{
            const itemId = String(line && line.item_id ? line.item_id : '').trim();
            if(!itemId) return;
            const qty = Number(line && line.qty_planned ? line.qty_planned : 0);
            if(!Number.isFinite(qty)) return;
            plannedByItemId.set(itemId, (plannedByItemId.get(itemId) || 0) + qty);
          });
        });
        await ensureIncomingOrdersLoaded(force);
        const incomingSupplyByItemId = buildApprovedIncomingSupplyMap();
        recState.plannedByItemId = plannedByItemId;
        recState.incomingSupplyByItemId = incomingSupplyByItemId;
        recState.ready = true;
        recState.updatedAt = Date.now();
      }catch(e){
        recState.plannedByItemId = new Map();
        recState.incomingSupplyByItemId = new Map();
        recState.ready = true;
        recState.error = e && e.message ? e.message : 'Recommendations unavailable';
      }finally{
        recState.loading = false;
      }
    }
    function getOrderRecommendationForItem(itemId){
      const recState = getOrderRecommendationState();
      const item = getInventoryById(itemId);
      const onHand = item ? toInt(item.qty, 0) : 0;
      const planned = recState.plannedByItemId && typeof recState.plannedByItemId.get === 'function'
        ? (recState.plannedByItemId.get(itemId) || 0)
        : 0;
      const incoming = recState.incomingSupplyByItemId && typeof recState.incomingSupplyByItemId.get === 'function'
        ? (recState.incomingSupplyByItemId.get(itemId) || 0)
        : 0;
      const jobDemand = Math.max(0, planned - onHand);
      const jobRequired = Math.max(0, jobDemand - incoming);
      const reorderPoint = item ? getInventoryReorderPoint(item) : null;
      const reorderEnabled = item ? getItemReorderEnabled(item) : true;
      const reorderAllowed = reorderEnabled && reorderPoint !== null && typeof reorderPoint !== 'undefined';
      const policyRequired = reorderAllowed ? Math.max(0, Number(reorderPoint) - (onHand + incoming)) : null;
      const recommended = policyRequired === null ? jobRequired : Math.max(jobRequired, policyRequired);
      return { onHand, planned, incoming, jobRequired, policyRequired, recommended, reorderPoint, reorderAllowed };
    }
    function applyOrderRecommendationDefaults(line, rec){
      if(!line || !rec) return;
      if(line._manualQty) return;
      if(line._autoQtyApplied) return;
      const baseQty = line.includeReorder ? rec.recommended : rec.jobRequired;
      if(!Number.isFinite(baseQty)) return;
      line.qty = toInt(baseQty, 0);
      line._autoQtyApplied = true;
    }
    function resetOrderIdentifiers(){
      const ord = orderState();
      ord.companyPoNumber = '';
      ord.internalPoNumber = generateInternalPoNumber();
      ord.subject = composeOrderSubject(ord);
    }
    const orderLineSelection = new Set();
    function pruneOrderLineSelection(lines){
      const ids = new Set((lines || []).map(l => String(l && l.id ? l.id : '').trim()).filter(Boolean));
      for(const id of Array.from(orderLineSelection)){
        if(!ids.has(id)) orderLineSelection.delete(id);
      }
    }
    function orderLineSelectedIds(){
      return Array.from(orderLineSelection);
    }
    function setOrderLineSelected(id, selected){
      const key = String(id || '').trim();
      if(!key) return;
      if(selected) orderLineSelection.add(key);
      else orderLineSelection.delete(key);
    }
    function updateOrderCounterBadge(){
      const ord = orderState();
      const count = ord.lines.length;
      // Update new main pill (below totals)
      const pillContainer = $('orderPillContainer');
      const pillValue = $('orderPillValue');
      const pill = $('orderPill');
      if(pillContainer){
        if(count > 0){
          pillContainer.style.display = 'flex';
          if(pillValue) pillValue.textContent = String(count);
          const labelEl = pill && pill.querySelector('.order-pill-label');
          if(labelEl) labelEl.textContent = count === 1 ? 'Item in Cart' : 'Items in Cart';
        }else{
          pillContainer.style.display = 'none';
        }
        try{ syncToastZoneVisibility(); }catch(e){}
      }
      try{
        const modal = $('reportModal');
        const content = $('reportContent');
        if(modal && modal.getAttribute('aria-hidden') === 'false' && content && content.style.display !== 'none'){
          renderInventoryReport();
        }else{
          syncReportOrderIndicators();
        }
      }catch(e){}
      try{ updateInventoryStickyOffset(); }catch(e){}
    }
    function afterOrderStateChanged(){
      try{ updateOrderCounterBadge(); }catch(e){}
      refreshInventoryCardsForOrderState();
      try{ updateOrderDraftSelector(); }catch(e){}
      try{ orderWizardUpdateUI(); }catch(e){}
      try{ refreshJobBomCardsForOrderState(); }catch(e){}
      try{
        const modal = $('jobEditorModal');
        if(modal && modal.getAttribute('aria-hidden') === 'false'){
          renderJobBomTable();
        }
      }catch(e){}
    }
    // Update job BOM card indicators when cart changes
    function refreshJobBomCardsForOrderState(){
      // Update all visible "In Cart" badges and order buttons
      document.querySelectorAll('.job-bom-card').forEach(card => {
        const badge = card.querySelector('.job-bom-in-cart');
        const btn = card.querySelector('.job-bom-order-btn');
        const itemId = badge ? badge.getAttribute('data-item-id') : (btn ? btn.getAttribute('data-item-id') : null);
        if(!itemId) return;

        const inCartQty = getOrderQtyForItem(itemId);
        const footer = card.querySelector('.job-bom-card-footer');

        if(inCartQty > 0){
          // Item is in cart - show badge, hide button
          if(btn) btn.remove();
          if(!badge && footer){
            const newBadge = document.createElement('span');
            newBadge.className = 'job-bom-in-cart';
            newBadge.setAttribute('data-item-id', itemId);
            newBadge.innerHTML = `${ICONS.shoppingCart} ${inCartQty} in cart`;
            footer.innerHTML = '';
            footer.appendChild(newBadge);
          }else if(badge){
            badge.innerHTML = `${ICONS.shoppingCart} ${inCartQty} in cart`;
          }
        }else{
          // Item not in cart - remove badge (button will reappear on re-render)
          if(badge){
            // Need to restore the order button - easier to just trigger a re-render of job list
            try{ renderJobsList(); }catch(e){}
            return; // Exit early since we re-rendered
          }
        }
      });
    }
    function clearAllOrderLines(){
      const ord = orderState();
      const ids = ord.lines.map(l => l.id);
      ord.lines = [];
      clearOrderShortfallLink();
      ord.source = '';
      ord.relatedJobId = '';
      ord.supplierId = '';
      ord.supplierName = '';
      ord.blockerBannerDismissed = false;
      ord.blockerMultiSupplier = false;
      ord.blockerHasUnknownSupplier = false;
      try{ orderLineSelection.clear(); }catch(e){}
      try{ state._orderLineExpanded = new Set(); }catch(e){}
      try{ state._orderJobAllocationsByItemId = new Map(); }catch(e){}
      try{ state._orderDraftJobAllocationsByItemId = new Map(); }catch(e){}
      try{ state._orderDraftJobCountByItemId = new Map(); }catch(e){}
      ids.forEach(id => { try{ syncOrderIndicatorForRow(String(id)); }catch(e){} });
      afterOrderStateChanged();
    }
    function getInventoryById(id){
      return state.items.find(x => x && x.id === id) || null;
    }
    function getOrderQtyForItem(id){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      return line ? toInt(line.qty, 0) : 0;
    }
    function upsertOrderLineFromItem(it, qty = 1){
      const ord = orderState();
      if(!it || !it.id) return false;
      if(ord.lines.some(l => l.id === it.id)) return false;
	      ord.lines.push({
	        id: it.id,
	        name: String(it.name||'').trim(),
	        desc: String(it.desc||'').trim(),
	        qty: toInt(qty, 1),
	        includeReorder: false,
	        _manualQty: false,
	        _autoQtyApplied: false
	      });
      ord.lines.sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      try{ syncOrderIndicatorForRow(String(it.id)); }catch(e){}
      afterOrderStateChanged();
      return true;
    }
    function removeOrderLine(id){
      const ord = orderState();
      ord.lines = ord.lines.filter(l => l.id !== id);
      if(ord.shortfall && String(ord.shortfall.itemId || '') === String(id || '')){
        clearOrderShortfallLink();
      }
      try{ orderLineSelection.delete(String(id || '').trim()); }catch(e){}
      try{ if(state._orderLineExpanded) state._orderLineExpanded.delete(String(id || '').trim()); }catch(e){}
      try{ if(state._orderJobAllocationsByItemId) state._orderJobAllocationsByItemId.delete(String(id || '').trim()); }catch(e){}
      try{ if(state._orderDraftJobAllocationsByItemId) state._orderDraftJobAllocationsByItemId.delete(String(id || '').trim()); }catch(e){}
      try{ if(state._orderDraftJobCountByItemId) state._orderDraftJobCountByItemId.delete(String(id || '').trim()); }catch(e){}
      try{ syncOrderIndicatorForRow(String(id)); }catch(e){}
      afterOrderStateChanged();
    }
    function showCartAddedFeedback(btn, qty){
      if(!btn) return;
      // Add highlight class to button
      btn.classList.add('cart-added');
      // Remove any existing toast
      const existingToast = document.querySelector('.cart-feedback-toast');
      if(existingToast) existingToast.remove();
      // Create fixed toast notification
      const toastEl = document.createElement('div');
      toastEl.className = 'cart-feedback-toast';
      toastEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg><span>+${qty} added to order</span>`;
      const zone = $('headerToastZone');
      if(zone){
        zone.appendChild(toastEl);
        try{ syncToastZoneVisibility(); }catch(e){}
      }else{
        document.body.appendChild(toastEl);
      }
      // Remove after animation
      setTimeout(()=>{
        toastEl.style.animation = 'cartToastOut 0.3s ease forwards';
        setTimeout(()=>{
          toastEl.remove();
          btn.classList.remove('cart-added');
          try{ syncToastZoneVisibility(); }catch(e){}
        }, 300);
      }, 1700);
    }
    function addToOrderFromBom(itemId, shortage, opts = {}){
      const item = getInventoryById(itemId);
      if(!item){
        toast('Item not found', 'error');
        return;
      }
      const ord = orderState();
        const ctx = opts || {};
        let shortfallId = String(ctx.shortfallId || '').trim();
        let shortfallQty = Number(ctx.shortfallQty || 0);
        if(!shortfallId && ctx.jobId && state._jobShortfallsByJobId && typeof state._jobShortfallsByJobId.get === 'function'){
          const jobMap = state._jobShortfallsByJobId.get(String(ctx.jobId)) || null;
          if(jobMap && typeof jobMap.has === 'function' && jobMap.has(itemId)){
            const entry = jobMap.get(itemId);
            shortfallId = shortfallIdFromEntry(entry);
            shortfallQty = shortfallQtyFromEntry(entry);
          }
        }
        if(shortfallId){
          if(!ord.shortfall || !ord.shortfall.id){
            setOrderShortfallLink({
              shortfallId,
              jobId: ctx.jobId,
              itemId,
              qtyMissing: Number.isFinite(shortfallQty) ? shortfallQty : Number(shortage || 0)
            });
          }else if(String(ord.shortfall.id) !== shortfallId){
            toast('Order already linked to a shortfall. Additional items will not be linked.');
          }
        }
	      const existing = ord.lines.find(l => l.id === itemId);
	      if(existing){
	        existing.qty = Math.max(existing.qty, toInt(shortage, 1));
        existing._manualQty = true;
        existing._autoQtyApplied = true;
	        toast(`Updated ${item.name} qty to ${existing.qty}`);
	      }else{
	        upsertOrderLineFromItem(item, shortage);
	        toast(`Added ${item.name} (Ã—${shortage}) to cart`);
	      }
      try{ syncOrderIndicatorForRow(String(itemId)); }catch(e){}
      afterOrderStateChanged();
    }
    function buildJobBlockerOrderLines(blockingItems){
      const neededByItem = new Map();
      (Array.isArray(blockingItems) ? blockingItems : []).forEach(item=>{
        const itemId = String(item && item.itemId ? item.itemId : '').trim();
        if(!itemId) return;
        const required = Number(item && item.requiredQty != null ? item.requiredQty : 0);
        const available = Number(item && item.availableQty != null ? item.availableQty : 0);
        if(!Number.isFinite(required) || required <= 0) return;
        const needed = Math.max(0, required - available);
        if(needed <= 0) return;
        neededByItem.set(itemId, (neededByItem.get(itemId) || 0) + needed);
      });
      return neededByItem;
    }
    function addOrderLineToDraft(ord, item, qty){
      if(!ord || !item || !item.id) return;
      const nextQty = Math.max(0, toInt(qty, 0));
      const existing = ord.lines.find(l => l && l.id === item.id);
      if(existing){
        existing.qty = Math.max(toInt(existing.qty, 0), nextQty);
        existing._manualQty = true;
        existing._autoQtyApplied = true;
        return;
      }
      ord.lines.push({
        id: item.id,
        name: String(item.name || '').trim(),
        desc: String(item.desc || '').trim(),
        qty: nextQty,
        includeReorder: false,
        _manualQty: true,
        _autoQtyApplied: true
      });
    }
    function finalizeDraftLines(ord){
      if(!ord || !Array.isArray(ord.lines)) return;
      ord.lines.sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
    }
    async function resolveSupplierByItemIds(itemIds){
      const ids = Array.isArray(itemIds) ? itemIds.map(id => String(id || '').trim()).filter(Boolean) : [];
      const map = new Map();
      const missing = [];
      ids.forEach(id=>{
        const item = getInventoryById(id);
        const supplierId = getItemSupplierId(item);
        if(supplierId){
          map.set(id, supplierId);
        }else{
          missing.push(id);
        }
      });
      if(missing.length){
        const fetched = await sbFetchItemSupplierMap(missing);
        missing.forEach(id=>{
          const entry = fetched.get(id);
          const supplierId = entry ? (entry.preferred || entry.fallback) : '';
          if(supplierId) map.set(id, supplierId);
        });
      }
      return map;
    }
    function buildJobBlockerSupplierGroups(neededByItem, supplierByItem){
      const groups = new Map();
      neededByItem.forEach((neededQty, itemId)=>{
        const supplierId = normalizeSupplierId(supplierByItem.get(itemId) || '');
        if(!groups.has(supplierId)) groups.set(supplierId, []);
        groups.get(supplierId).push({ itemId, qty: neededQty });
      });
      return groups;
    }
    function applyJobBlockerGroupToOrder(ord, jobId, group, opts = {}){
      if(!ord || !group) return;
      const supplierId = String(group.supplierId || '').trim();
      const vendorMap = opts.vendorMap && typeof opts.vendorMap.get === 'function' ? opts.vendorMap : new Map();
      ord.source = 'job_blockers';
      ord.relatedJobId = String(jobId || '').trim();
      ord.blockerBannerDismissed = false;
      ord.blockerMultiSupplier = !!opts.multiSupplier;
      ord.blockerHasUnknownSupplier = !!opts.hasUnknownSupplier;
      ord.supplierId = supplierId;
      ord.supplierName = supplierId ? String(vendorMap.get(supplierId) || '').trim() : '';
      (group.items || []).forEach(entry=>{
        const itemId = String(entry && entry.itemId ? entry.itemId : '').trim();
        if(!itemId) return;
        const item = getInventoryById(itemId);
        if(!item) return;
        addOrderLineToDraft(ord, item, entry.qty);
        try{ syncOrderIndicatorForRow(String(itemId)); }catch(e){}
      });
      finalizeDraftLines(ord);
      ensureOrderIdentifiers(ord);
    }
    async function createOrderFromJobBlockers(jobId, blockingItems){
      try{
        const neededByItem = buildJobBlockerOrderLines(blockingItems);
        if(!neededByItem.size){
          toast('All blockers are already covered by on-hand and incoming inventory.');
          return;
        }
        const itemIds = Array.from(neededByItem.keys());
        const supplierByItem = await resolveSupplierByItemIds(itemIds);
        const groupMap = buildJobBlockerSupplierGroups(neededByItem, supplierByItem);
        const groups = Array.from(groupMap.entries()).map(([supplierId, items])=>({ supplierId, items }));
        if(!groups.length){
          toast('No blockers require ordering.');
          return;
        }
        const vendorMap = await ensureVendorMap(groups.map(g => g.supplierId).filter(Boolean));
        const multiSupplier = groups.length > 1;
        const hasUnknownSupplier = groupMap.has('');
        const baseOrd = orderState();
        const baseHasLines = Array.isArray(baseOrd.lines) && baseOrd.lines.length > 0;
        const baseSameJob = baseOrd.source === 'job_blockers' && String(baseOrd.relatedJobId || '').trim() === String(jobId || '').trim();
        const baseSupplier = normalizeSupplierId(baseOrd.supplierId);
        const drafts = [];
        let remaining = groups.slice();
        if(!baseHasLines || baseSameJob){
          let baseGroup = null;
          if(baseSupplier){
            baseGroup = remaining.find(group => String(group.supplierId || '').trim() === baseSupplier);
          }
          if(!baseGroup){
            baseGroup = remaining[0];
          }
          if(baseGroup){
            applyJobBlockerGroupToOrder(baseOrd, jobId, baseGroup, {
              vendorMap,
              multiSupplier,
              hasUnknownSupplier
            });
            drafts.push(baseOrd);
            remaining = remaining.filter(group => group !== baseGroup);
          }
        }
        remaining.forEach(group=>{
          const ord = createEmptyOrderState();
          applyJobBlockerGroupToOrder(ord, jobId, group, {
            vendorMap,
            multiSupplier,
            hasUnknownSupplier
          });
          drafts.push(ord);
        });
        if(drafts.length === 0){
          toast('No blockers require ordering.');
          return;
        }
        if(baseHasLines && !drafts.includes(baseOrd)){
          drafts.push(baseOrd);
        }
        state._orderDraftQueue = drafts;
        state._order = drafts[0];
        ensureOrderIdentifiers(state._order);
        void openOrderModal({ addSelected:false });
      }catch(e){
        console.warn('Create PO from blockers failed', e);
        toast('Unable to create draft orders.');
      }
    }
    function setOrderQty(id, qty, opts = {}){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      if(!line) return;
      line.qty = toInt(qty, 0);
      if(opts.manual) line._manualQty = true;
      if(opts.auto) line._autoQtyApplied = true;
    }
    function normalizeEmailLineItems(lineItems){
      const arr = Array.isArray(lineItems) ? lineItems : [];
      return arr
        .map((x) => {
          const item_id = String(x?.item_id || x?.itemId || x?.id || '').trim();
          const part = String(x?.part || x?.name || x?.item || '').trim();
          const desc = String(x?.desc || x?.description || '').trim();
          const qty = toInt(x?.qty, 0);
          return { item_id, part, desc, qty };
        })
        .filter((x) => x.part && x.qty > 0)
        .sort((a,b)=> toKey(a.part).localeCompare(toKey(b.part)));
    }
    function normalizeShippingSnapshot(value){
      if(!value || typeof value !== 'object') return null;
      const label = String(value.label || '').trim();
      const address = String(value.address || '').trim();
      if(!label && !address) return null;
      return { label, address };
    }
    function formatShippingSnapshotLines(value){
      const snap = normalizeShippingSnapshot(value);
      if(!snap) return [];
      const lines = [];
      if(snap.label) lines.push(snap.label);
      if(snap.address) lines.push(snap.address);
      return lines;
    }
    function buildOrderBodyFromData({ subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber, jobNumbers }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim();
      const out = [];
      const jobs = (Array.isArray(jobNumbers) ? jobNumbers : []).map(n => String(n || '').trim()).filter(Boolean);

      out.push(subject);
      out.push(`Date: ${when}`);
      if(companyName) out.push(`Company: ${companyName}`);
      if(companyPoNumber) out.push(`Company PO: ${companyPoNumber}`);
      if(internalPoNumber) out.push(`Internal PO: ${internalPoNumber}`);
      if(jobs.length === 1){
        out.push(`Related Job: ${jobs[0]}`);
      }else if(jobs.length > 1){
        out.push('Related Jobs:');
        jobs.forEach(num => out.push(`- ${num}`));
      }
      out.push('');
      out.push('Items:');
      out.push('');

      const active = normalizeEmailLineItems(lineItems);
      if(!active.length){
        out.push('(none)');
      }else{
        const parts = active.map(l => String(l.part||'').trim());
        const descs = active.map(l => String(l.desc||'').trim());
        const partW = Math.min(25, Math.max(4, ...parts.map(p => p.length)));
        const descW = Math.min(35, Math.max(11, ...descs.map(d => d.length)));
        const qtyW = Math.min(6, Math.max(3, ...active.map(l => String(toInt(l.qty, 0)).length)));
        out.push(`${'Item'.padEnd(partW)} | ${'Description'.padEnd(descW)} | ${'Qty'.padStart(qtyW)}`);
        out.push(`${'-'.repeat(partW)}-+-${'-'.repeat(descW)}-+-${'-'.repeat(qtyW)}`);
        for(const l of active){
          const part = String(l.part||'').replace(/\t/g,' ').trim();
          const desc = String(l.desc||'').replace(/\t/g,' ').trim();
          const qty = String(toInt(l.qty, 0)).padStart(qtyW, ' ');
          out.push(`${part.padEnd(partW)} | ${desc.padEnd(descW)} | ${qty}`);
        }
      }

      const nt = String(notes||'').trim();
      if(nt){
        out.push('');
        out.push('Notes:');
        out.push(nt);
      }

      // Add sender info from profile
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const deliveryLines = [];
      if(fullName) deliveryLines.push(fullName);
      if(userPhone) deliveryLines.push(userPhone);
      if(userEmail) deliveryLines.push(userEmail);

      if(deliveryLines.length){
        out.push('');
        out.push('Contact:');
        for(const line of deliveryLines) out.push(line);
      }

      const shippingLines = formatShippingSnapshotLines(shippingAddress);
      if(shippingLines.length){
        out.push('');
        out.push('Shipping Address:');
        for(const line of shippingLines) out.push(line);
      }

      out.push('');
      out.push('contact@modulus-software.com');
      return out.join('\n');
    }
    function buildOrderHtmlFromData({ subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber, jobNumbers }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim();
      const jobs = (Array.isArray(jobNumbers) ? jobNumbers : []).map(n => String(n || '').trim()).filter(Boolean);

      const active = normalizeEmailLineItems(lineItems);
      const rows = active.map(l=>{
        const part = escapeHtml(String(l.part||'').trim());
        const desc = escapeHtml(String(l.desc||'').trim());
        const qty = toInt(l.qty, 0);
        return (
          `<tr>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;font-weight:600;">${part}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;">${desc}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;text-align:right;font-variant-numeric:tabular-nums;font-weight:700;">${qty}</td>`+
          `</tr>`
        );
      }).join('');

      const notesRaw = String(notes||'').trim();
      const notesHtml = notesRaw ? escapeHtml(notesRaw).replace(/\n/g, '<br>') : '';

      // Build contact + shipping blocks
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const contactLines = [];
      if(fullName) contactLines.push(escapeHtml(fullName));
      if(userPhone) contactLines.push(escapeHtml(userPhone));
      if(userEmail) contactLines.push(`<a href="mailto:${escapeHtmlAttr(userEmail)}" style="color:#0969da;text-decoration:underline;">${escapeHtml(userEmail)}</a>`);

      const contactBlock = contactLines.length
        ? (
          `<div style="margin:16px 0 16px;padding:12px;background:#f6f8fa;border:1px solid #d0d7de;border-radius:6px;">`+
            `<div style="font-weight:700;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Contact</div>`+
            `<div style="font-size:14px;line-height:1.5;">${contactLines.join('<br>')}</div>`+
          `</div>`
        )
        : '';

      const shippingLines = formatShippingSnapshotLines(shippingAddress);
      const shippingBlock = shippingLines.length
        ? (
          `<div style="margin:16px 0 16px;padding:12px;background:#f6f8fa;border:1px solid #d0d7de;border-radius:6px;">`+
            `<div style="font-weight:700;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Shipping Address</div>`+
            `<div style="font-size:14px;line-height:1.5;">${shippingLines.map(l => escapeHtml(l).replace(/\\n/g, '<br>')).join('<br>')}</div>`+
          `</div>`
        )
        : '';

      const metaLines = [];
      if(companyName) metaLines.push(`<div><strong>Company:</strong> ${escapeHtml(companyName)}</div>`);
      if(companyPoNumber) metaLines.push(`<div><strong>Company PO:</strong> ${escapeHtml(companyPoNumber)}</div>`);
      if(internalPoNumber) metaLines.push(`<div><strong>Internal PO:</strong> ${escapeHtml(internalPoNumber)}</div>`);
      if(jobs.length){
        const jobHtml = jobs.map(num => escapeHtml(num)).join('<br>');
        metaLines.push(`<div><strong>Related Job${jobs.length > 1 ? 's' : ''}:</strong><br>${jobHtml}</div>`);
      }
      const metaBlock = metaLines.length
        ? `<div style="margin:12px 0 0;font-size:14px;line-height:1.5;">${metaLines.join('')}</div>`
        : '';

      const notesBlock = notesHtml
        ? (
          `<div style="margin-top:16px;">`+
            `<div style="font-weight:700;margin-bottom:6px;">Notes</div>`+
            `<div>${notesHtml}</div>`+
          `</div>`
        )
        : '';

      const itemsBlock = active.length
        ? (
          `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;table-layout:fixed;">`+
            `<colgroup>`+
              `<col style="width:35%;">`+
              `<col style="width:50%;">`+
              `<col style="width:15%;">`+
            `</colgroup>`+
            `<thead>`+
              `<tr>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Item</th>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Description</th>`+
                `<th align="right" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Qty</th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>${rows}</tbody>`+
          `</table>`
        )
        : `<div style="padding:12px;border:1px dashed #d0d7de;color:#444;">(No items)</div>`;

      const brandLogo = buildModulusLogoHtml({ width: 200, color: '#111', marginTop: 18 });
      const brandLine = `<div style="margin-top:8px;font-size:12px;color:#6a737d;text-align:center;">contact@modulus-software.com</div>`;

      return (
        `<!doctype html>`+
        `<html><body style="margin:0;padding:0;background:#ffffff;">`+
        `<div style="max-width:620px;margin:0 auto;padding:18px 16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.35;">`+
          `<h2 style="margin:0 0 10px;font-size:18px;">${escapeHtml(subject)}</h2>`+
          `<div style="font-size:13px;color:#444;margin:0 0 16px;">`+
            `<div style="margin:2px 0;"><strong>Date:</strong> ${escapeHtml(when)}</div>`+
            `${metaBlock}`+
          `</div>`+
          `<div style="margin:0 0 10px;">Please supply the following materials:</div>`+
          `${itemsBlock}`+
          `${notesBlock}`+
          `${contactBlock}`+
          `${shippingBlock}`+
          `${brandLogo}`+
          `${brandLine}`+
        `</div>`+
        `</body></html>`
      );
    }
    function looksLikeEmailAddress(email){
      const s = String(email || '').trim();
      if(!s) return false;
      if(s.length > 254) return false;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    }
    function getOrderShippingSnapshot(ord){
      if(!ord) return null;
      const direct = normalizeShippingSnapshot(ord.shippingAddressSnapshot);
      if(direct) return direct;
      const id = String(ord.shippingAddressId || '').trim();
      if(!id) return null;
      const row = (state._orderShippingById && typeof state._orderShippingById.get === 'function'
        ? state._orderShippingById.get(id)
        : null)
        || (state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
          ? state._shippingAddressById.get(id)
          : null);
      if(!row) return null;
      return normalizeShippingSnapshot({ label: row.label, address: row.address });
    }
    function getOrderShippingSnapshotFromRow(row){
      if(!row) return null;
      const direct = normalizeShippingSnapshot(row.shipping_address_snapshot);
      if(direct) return direct;
      const id = String(row.ship_to_location_id || row.shipping_address_id || '').trim();
      if(!id) return null;
      const match = (state._orderShippingById && typeof state._orderShippingById.get === 'function'
        ? state._orderShippingById.get(id)
        : null)
        || (state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
          ? state._shippingAddressById.get(id)
          : null);
      if(!match) return null;
      return normalizeShippingSnapshot({ label: match.label, address: match.address });
    }
    function formatOrderShipToHtml(row){
      const lines = formatShippingSnapshotLines(getOrderShippingSnapshotFromRow(row));
      return lines.length ? lines.map(line => escapeHtml(line).replace(/\n/g, '<br>')).join('<br>') : '';
    }
    function formatOrderSentToLabel(row, supplierOverride){
      const email = String(row && (row.recipient_email || row.recipientEmail || row.to_email || row.toEmail) || '').trim();
      const vendor = String(supplierOverride || (row && (row.vendor_name || (row.vendor && row.vendor.name) || row.vendor_id) || '')).trim();
      const parts = [];
      if(email) parts.push(email);
      if(vendor && vendor !== email) parts.push(vendor);
      return parts.join(' â€¢ ');
    }
    function buildOrderBody(){
      const ord = orderState();
      const subjectLine = composeOrderSubject(ord);
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shippingAddress = getOrderShippingSnapshot(ord);
      const companyName = getOrderCompanyName();
      const companyPoNumber = String(ord.companyPoNumber||'').trim();
      const internalPoNumber = String(ord.internalPoNumber||'').trim();
      const jobNumbers = getOrderRelatedJobNumbers(ord);
      return buildOrderBodyFromData({ subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber, jobNumbers });
    }
    function buildOrderHtml(){
      const ord = orderState();
      const subjectLine = composeOrderSubject(ord);
      const notesRaw = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shippingAddress = getOrderShippingSnapshot(ord);
      const companyName = getOrderCompanyName();
      const companyPoNumber = String(ord.companyPoNumber||'').trim();
      const internalPoNumber = String(ord.internalPoNumber||'').trim();
      const jobNumbers = getOrderRelatedJobNumbers(ord);
      return buildOrderHtmlFromData({ subjectLine, notes: notesRaw, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber, jobNumbers });
    }
    function buildMailtoUrl(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const subject = composeOrderSubject(ord);
      const body = buildOrderBody();
      if(!to) return '';
      return `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    function getOrderApiUrl(){
      // Allow explicit override via window.ORDER_API_URL
      const override = (typeof window.ORDER_API_URL === 'string') ? window.ORDER_API_URL.trim() : '';
      if(override) return override;
      // Use Supabase Edge Function if available
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/send-order`;
      // Fallback to local dev server
      return '/api/send-order';
    }
    async function sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber, jobNumbers }){
      const toEmail = String(to||'').trim();
      const replyTo = getSignedInEmail();
      const subject = String(subjectLine||'').trim();
      const text = buildOrderBodyFromData({ subjectLine: subject, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber, jobNumbers });
      const html = buildOrderHtmlFromData({ subjectLine: subject, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber, jobNumbers });
      const apiUrl = getOrderApiUrl();

      // Build headers - include Supabase auth if using Edge Function
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        // Add auth token if user is signed in
        if(SB.session && SB.session.access_token){
          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
        }
      }

      const payload = {
        to: toEmail,
        subject,
        text,
        html,
        replyTo,
      };
      if(Array.isArray(jobNumbers) && jobNumbers.length){
        payload.related_job_numbers = jobNumbers;
      }
      if(SB.companyId){
        payload.company_id = SB.companyId;
      }

      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload),
      });
      let data = null;
      try { data = await res.json(); } catch {}
      if(!res.ok || !data || data.ok !== true){
        const msg = (data && data.error) ? String(data.error) : `Send failed (${res.status})`;
        throw Object.assign(new Error(msg), { status: res.status, data });
      }
      return data;
    }
    async function sendOrderViaApi(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const companyName = getOrderCompanyName();
      if(!companyName) throw new Error('Company name is required to send orders');
      const subjectLine = composeOrderSubject(ord);
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shippingAddress = getOrderShippingSnapshot(ord);
      const companyPoNumber = String(ord.companyPoNumber||'').trim();
      const internalPoNumber = String(ord.internalPoNumber||'').trim();
      const jobNumbers = getOrderRelatedJobNumbers(ord);
      return sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber, jobNumbers });
    }
    async function copyText(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return;
      }
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position='fixed';
      ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
    async function copyOrderToClipboard(){
      try{
        await copyText(buildOrderBody());
        toast('Copied order text', 'success');
      }catch{
        toast('Copy failed', 'error');
      }
    }

    function setShippingAddressMessage(msg){
      const el = $('shippingAddressMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function clearShippingAddressForm(){
      state._shippingAddressEditing = null;
      const label = $('shippingAddressLabel'); if(label) label.value = '';
      const address = $('shippingAddressValue'); if(address) address.value = '';
      const isDefault = $('shippingAddressDefault'); if(isDefault) isDefault.checked = false;
      const title = $('shippingAddressFormTitle'); if(title) title.textContent = 'Add Shipping Address';
      setShippingAddressMessage('');
    }
    function renderShippingAddressList(){
      const list = $('shippingAddressList');
      if(!list) return;
      const rows = Array.isArray(state._shippingAddresses) ? state._shippingAddresses : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No shipping addresses yet.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const id = String(row.id || '').trim();
        const label = String(row.label || '').trim();
        const address = String(row.address || '').trim();
        const isDefault = !!row.is_default;
        const meta = [isDefault ? 'Default' : '', id ? `ID: ${id.slice(0,8)}` : ''].filter(Boolean).join(' Â· ');
        return (
          `<div class="shipping-address-card" data-shipping-id="${escapeHtmlAttr(id)}">`+
            `<div>`+
              `<div style="font-weight:700;">${escapeHtml(label || 'Address')}</div>`+
              `<div class="shipping-address-meta">${escapeHtml(meta)}</div>`+
              `<div style="margin-top:6px;white-space:pre-wrap;">${escapeHtml(address)}</div>`+
            `</div>`+
            `<div class="shipping-address-actions">`+
              `<button class="btn-tertiary btn-sm" type="button" data-shipping-edit="${escapeHtmlAttr(id)}">Edit</button>`+
              `<button class="btn-tertiary btn-sm btn-danger" type="button" data-shipping-delete="${escapeHtmlAttr(id)}">Delete</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    function renderOrderShippingOptionsList(){
      const wrap = $('orderShippingOptions');
      if(!wrap) return;
      const rows = Array.isArray(state._orderShippingOptions) ? state._orderShippingOptions : [];
      if(!rows.length){
        wrap.innerHTML = '<div class="order-shipping-empty">No locations available.</div>';
        return;
      }
      const ord = orderState();
      const selectedId = String(ord.shippingAddressId || '').trim();
      wrap.innerHTML = rows.map(row => {
        const id = String(row && row.id ? row.id : '').trim();
        if(!id) return '';
        const label = String(row.label || row.address || 'Location').trim() || 'Location';
        const address = String(row.address || '').trim() || 'Address not provided';
        const isSelected = id === selectedId;
        const badge = row.is_default ? '<span class="order-shipping-badge">Default</span>' : '';
        return (
          `<button type="button" class="order-shipping-option${isSelected ? ' is-selected' : ''}" data-order-shipping-id="${escapeHtmlAttr(id)}" aria-pressed="${isSelected ? 'true' : 'false'}">`+
            `<span class="order-shipping-radio"></span>`+
            `<span class="order-shipping-info">`+
              `<span class="order-shipping-name">${escapeHtml(label)}</span>`+
              `<span class="order-shipping-address">${escapeHtml(address)}</span>`+
            `</span>`+
            `${badge}`+
          `</button>`
        );
      }).join('');
    }
    function renderShippingAddressSelect(){
      const select = $('orderShippingAddress');
      if(!select){
        renderOrderShippingOptionsList();
        return;
      }
      const rows = Array.isArray(state._orderShippingOptions) ? state._orderShippingOptions : [];
      select.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = rows.length ? 'Select shipping location' : 'No locations';
      placeholder.disabled = !rows.length;
      select.appendChild(placeholder);
      rows.forEach(row => {
        const id = String(row && row.id ? row.id : '').trim();
        if(!id) return;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = String(row.label || row.address || id).trim();
        select.appendChild(opt);
      });
      const ord = orderState();
      if(ord.shippingAddressId && !rows.some(r => String(r.id) === String(ord.shippingAddressId))){
        ord.shippingAddressId = '';
        ord.shippingAddressSnapshot = null;
      }
      if(!ord.shippingAddressId && rows.length){
        const def = rows.find(r => r && r.is_default) || rows[0];
        ord.shippingAddressId = def ? String(def.id) : '';
        ord.shippingAddressSnapshot = def ? { label: def.label, address: def.address } : null;
      }
      select.value = ord.shippingAddressId || '';
      const manageBtn = $('btnOrderShippingManage');
      if(manageBtn){
        manageBtn.disabled = !canAccessCompanyLocations();
        manageBtn.style.display = canAccessCompanyLocations() ? '' : 'none';
      }
      renderOrderShippingOptionsList();
    }
    function mapLocationToOrderShipping(row){
      if(!row) return null;
      const id = String(row.id || '').trim();
      if(!id) return null;
      const label = String(row.name || '').trim() || 'Location';
      return {
        id,
        label,
        address: formatLocationAddress(row),
        is_default: !!row.is_default_ship_to,
        source: 'location'
      };
    }
    function buildOrderShippingOptions(locationRows){
      const options = [];
      const seen = new Set();
      const add = (opt) => {
        if(!opt || !opt.id || seen.has(opt.id)) return;
        seen.add(opt.id);
        options.push(opt);
      };
      (locationRows || []).forEach(row => add(mapLocationToOrderShipping(row)));
      return options;
    }
    async function sbFetchOrderShippingLocations(){
      if(!SB.ready || !SB.session || !SB.companyId) return [];
      const { data, error } = await SB.client
        .from('company_locations')
        .select('id,name,location_type,google_formatted_address,google_place_id,google_address_components,is_active,is_default_ship_to')
        .eq('company_id', SB.companyId)
        .eq('is_active', true)
        .order('is_default_ship_to', { ascending:false })
        .order('name', { ascending:true });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function loadOrderShippingOptions(){
      let locations = [];
      try{
        locations = await sbFetchOrderShippingLocations();
      }catch(e){
        if(!isMissingRelationError(e)){
          console.warn('Order shipping locations load failed:', e);
        }
      }
      const options = buildOrderShippingOptions(locations);
      state._orderShippingOptions = options;
      state._orderShippingById = new Map(options.map(r => [String(r.id || '').trim(), r]).filter(x => x[0]));
      renderShippingAddressSelect();
    }
    async function sbFetchShippingAddresses(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
      if(!canOrdersView()) return [];
      const { data, error } = await SB.client
        .from('company_shipping_addresses')
        .select('id,label,address,is_default,created_at,updated_at')
        .eq('company_id', SB.companyId)
        .order('is_default', { ascending:false })
        .order('label', { ascending:true });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function loadShippingAddresses(){
      const rows = await sbFetchShippingAddresses();
      state._shippingAddresses = rows;
      state._shippingAddressById = new Map(rows.map(r => [String(r.id || '').trim(), r]).filter(x => x[0]));
      renderShippingAddressList();
    }
    async function openShippingAddressModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!canOrdersManageShipping()){ toast('Shipping address permissions required'); return; }
      clearShippingAddressForm();
      show('shippingAddressModal', true);
      try{ await loadShippingAddresses(); }catch(e){ setShippingAddressMessage(e && e.message ? e.message : 'Failed to load addresses'); }
    }
    function closeShippingAddressModal(){
      show('shippingAddressModal', false);
    }
    async function saveShippingAddress(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
      if(!canOrdersManageShipping()) throw new Error('Permission denied');
      const label = String($('shippingAddressLabel')?.value || '').trim();
      const address = String($('shippingAddressValue')?.value || '').trim();
      const isDefault = !!($('shippingAddressDefault')?.checked);
      if(!label || !address) throw new Error('Label and address are required');
      if(isDefault){
        await SB.client
          .from('company_shipping_addresses')
          .update({ is_default: false })
          .eq('company_id', SB.companyId);
      }
      const payload = {
        company_id: SB.companyId,
        label,
        address,
        is_default: isDefault,
        updated_at: new Date().toISOString(),
        updated_by: SB.user ? SB.user.id : null,
      };
      if(state._shippingAddressEditing){
        payload.id = state._shippingAddressEditing;
      }else{
        payload.created_by = SB.user ? SB.user.id : null;
      }
      const { error } = await SB.client
        .from('company_shipping_addresses')
        .upsert([payload], { onConflict: 'id' });
      if(error) throw error;
      await loadShippingAddresses();
      clearShippingAddressForm();
      renderOrderPreview();
    }
    async function deleteShippingAddress(id){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
      if(!canOrdersManageShipping()) throw new Error('Permission denied');
      const addrId = String(id || '').trim();
      if(!addrId) return;
      const { error } = await SB.client
        .from('company_shipping_addresses')
        .delete()
        .eq('id', addrId)
        .eq('company_id', SB.companyId);
      if(error) throw error;
      await loadShippingAddresses();
      const ord = orderState();
      if(String(ord.shippingAddressId || '') === addrId){
        ord.shippingAddressId = '';
        ord.shippingAddressSnapshot = null;
        renderOrderPreview();
      }
    }

    function setCompanyLocationsContext(context){
      if(context && context.companyId){
        state._companyLocationsContext = {
          companyId: String(context.companyId || '').trim(),
          companyName: String(context.companyName || '').trim(),
          source: String(context.source || '').trim()
        };
      }else{
        state._companyLocationsContext = null;
      }
    }
    function getCompanyLocationsCompanyId(){
      const ctx = state._companyLocationsContext;
      if(ctx && ctx.companyId) return ctx.companyId;
      return SB.companyId ? String(SB.companyId).trim() : '';
    }
    function updateCompanyLocationsContextDisplay(){
      const el = $('companyLocationsContext');
      if(!el) return;
      const ctx = state._companyLocationsContext;
      const label = ctx ? (ctx.companyName || ctx.companyId) : '';
      if(label){
        el.textContent = `Company: ${label}`;
        el.hidden = false;
      }else{
        el.textContent = '';
        el.hidden = true;
      }
    }
    function setCompanyLocationsMessage(msg){
      const el = $('companyLocationsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setCompanyLocationEditorMessage(msg, isError = true){
      const el = $('companyLocationEditorMsg'); if(!el) return;
      el.textContent = String(msg || '');
      el.classList.toggle('error', isError && !!msg);
    }
    function formatLocationTypeLabel(value){
      return formatStateToken(value || '');
    }
    function splitLocationAddress(raw){
      const value = String(raw || '').trim();
      if(!value) return [];
      if(value.includes('\n')){
        return value.split('\n').map(s => s.trim()).filter(Boolean);
      }
      return value.split(',').map(s => s.trim()).filter(Boolean);
    }
    function formatLocationAddress(row){
      const raw = String(row && row.google_formatted_address ? row.google_formatted_address : '').trim();
      if(!raw) return '';
      const parts = splitLocationAddress(raw);
      if(!parts.length) return '';
      if(parts.length === 1) return parts[0];
      return `${parts[0]}\n${parts.slice(1).join(', ')}`;
    }
    function getLocationAddressLines(row){
      const raw = String(row && row.google_formatted_address ? row.google_formatted_address : '').trim();
      const parts = splitLocationAddress(raw);
      const line1 = parts[0] || '';
      const line2 = parts.length > 1 ? parts.slice(1).join(', ') : '';
      return {
        line1,
        line2,
        full: parts.length ? [line1, line2].filter(Boolean).join('\n') : ''
      };
    }
    function renderCompanyLocationsList(){
      const list = $('companyLocationsList');
      const countValue = $('locationsCountValue');
      const countLabel = $('locationsCountLabel');
      if(!list) return;
      const rows = Array.isArray(state._companyLocations) ? state._companyLocations : [];
      const totalCount = rows.length;
      if(countValue) countValue.textContent = String(totalCount);
      if(countLabel) countLabel.textContent = totalCount === 1 ? 'location' : 'locations';
      if(!rows.length){
        list.innerHTML = `<div class="locations-empty">No locations yet. Add your first location to enable receiving.</div>`;
        return;
      }
      const canManage = canManageCompanyLocations();
      const editSvg = ICONS.pencil;
      const shipSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">'+
        '<rect x="1" y="3" width="15" height="13" rx="2"></rect>'+
        '<polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon>'+
        '<circle cx="5.5" cy="18.5" r="2.5"></circle>'+
        '<circle cx="18.5" cy="18.5" r="2.5"></circle>'+
      '</svg>';
      const receiveSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">'+
        '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>'+
        '<circle cx="12" cy="10" r="3"></circle>'+
      '</svg>';
      const archiveSvg = ICONS.trash2;
      const restoreSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">'+
        '<path d="M3 12a9 9 0 1 0 3-6.7"></path>'+
        '<polyline points="3 4 3 10 9 10"></polyline>'+
      '</svg>';
      const cards = rows.map(row => {
        const id = String(row && row.id ? row.id : '').trim();
        const name = String(row && row.name ? row.name : '').trim() || 'Location';
        const type = formatLocationTypeLabel(row && row.location_type ? row.location_type : '');
        const addressLines = getLocationAddressLines(row);
        const addressLine1 = addressLines.line1 || 'Address not set';
        const addressLine2 = addressLines.line2;
        const addressMuted = !addressLines.full;
        const active = !!(row && row.is_active);
        const shipDefault = !!(row && row.is_default_ship_to);
        const receiveDefault = !!(row && row.is_default_receive_at);
        const isDefault = shipDefault || receiveDefault;
        const disableActions = !canManage;
        const cardClasses = [
          'location-card',
          'locations-row',
          isDefault ? 'is-default' : '',
          active ? '' : 'is-archived'
        ].filter(Boolean).join(' ');
        const defaultPips = (shipDefault || receiveDefault)
          ? `<div class="default-indicators">`+
              `${shipDefault ? '<span class="default-pip ship-to" title="Default Ship-To"></span>' : ''}`+
              `${receiveDefault ? '<span class="default-pip receive-at" title="Default Receive-At"></span>' : ''}`+
            `</div>`
          : '';
        const editBtn = canManage
          ? `<button class="icon-btn location-card-edit" type="button" data-location-edit="${escapeHtmlAttr(id)}" data-tooltip="Edit" aria-label="Edit location"${disableActions ? ' disabled aria-disabled="true"' : ''}>${editSvg}</button>`
          : '';
        const shipBtn = active
          ? `<button class="icon-btn ship-to${shipDefault ? ' is-set' : ''}" type="button" data-location-default="${escapeHtmlAttr(id)}" data-default-type="ship_to" data-tooltip="${shipDefault ? 'Ship-To (Default)' : 'Set as Ship-To'}"${disableActions || shipDefault ? ' disabled aria-disabled="true"' : ''} aria-label="Set Ship-To">${shipSvg}</button>`
          : '';
        const receiveBtn = active
          ? `<button class="icon-btn receive-at${receiveDefault ? ' is-set' : ''}" type="button" data-location-default="${escapeHtmlAttr(id)}" data-default-type="receive_at" data-tooltip="${receiveDefault ? 'Receive-At (Default)' : 'Set as Receive-At'}"${disableActions || receiveDefault ? ' disabled aria-disabled="true"' : ''} aria-label="Set Receive-At">${receiveSvg}</button>`
          : '';
        const archiveBtn = active
          ? `<button class="icon-btn icon-btn--danger" type="button" data-location-archive="${escapeHtmlAttr(id)}" data-tooltip="Archive"${disableActions ? ' disabled aria-disabled="true"' : ''} aria-label="Archive location">${archiveSvg}</button>`
          : '';
        const restoreBtn = !active
          ? `<button class="icon-btn restore" type="button" data-location-restore="${escapeHtmlAttr(id)}" data-tooltip="Restore"${disableActions ? ' disabled aria-disabled="true"' : ''} aria-label="Restore location">${restoreSvg}</button>`
          : '';
        return (
          `<div class="${escapeHtmlAttr(cardClasses)}" data-location-id="${escapeHtmlAttr(id)}" data-location-row="${escapeHtmlAttr(id)}">`+
            `<div class="card-row">`+
              editBtn+
              `<div class="card-info">`+
                `<div class="card-info-top">`+
                  `<span class="location-name" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</span>`+
                  `<span class="type-badge">${escapeHtml(type || 'Other')}</span>`+
                  `<span class="status-dot${active ? '' : ' archived'}" title="${active ? 'Active' : 'Archived'}"></span>`+
                  `${defaultPips}`+
                `</div>`+
                `<div class="card-info-bottom">`+
                  `<span class="address-text${addressMuted ? ' muted' : ''}">${escapeHtml(addressLine1)}${addressLine2 ? `, ${escapeHtml(addressLine2)}` : ''}</span>`+
                `</div>`+
              `</div>`+
              `<div class="card-actions">`+
                shipBtn+
                receiveBtn+
                archiveBtn+
                restoreBtn+
              `</div>`+
            `</div>`+
          `</div>`
        );
      }).join('');
      list.innerHTML = cards;
      try{ initButtonSystem.refresh(); }catch(e){}
    }
    async function sbFetchCompanyLocations(){
      if(!SB.ready || !SB.session) return [];
      if(!canAccessCompanyLocations()) return [];
      const companyId = getCompanyLocationsCompanyId();
      if(!companyId) return [];
      const { data, error } = await SB.client
        .from('company_locations')
        .select('id,company_id,name,location_type,google_formatted_address,google_place_id,google_address_components,is_active,is_default_ship_to,is_default_receive_at,created_at,updated_at')
        .eq('company_id', companyId)
        .order('is_active', { ascending:false })
        .order('name', { ascending:true });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function loadCompanyLocations(){
      const rows = await sbFetchCompanyLocations();
      state._companyLocations = rows;
      state._companyLocationById = new Map(rows.map(r => [String(r.id || '').trim(), r]).filter(x => x[0]));
      renderCompanyLocationsList();
    }
    // Load companies for super user selector in Locations modal
    async function loadLocationsCompanies(){
      if(!isEffectiveSuperUser()) return;
      const search = state._locationsCompanySearch || '';
      try{
        const rows = await sbFetchCompanySwitcherCompanies({
          search,
          companyType: null,
          limit: 100,
          environmentType: null
        });
        state._locationsCompanies = Array.isArray(rows) ? rows : [];
      }catch(e){
        console.warn('Locations companies load failed:', e);
        state._locationsCompanies = [];
      }
      await loadLocationsCompanyCounts();
      renderLocationsCompanyList();
    }
    // Fetch location counts per company
    async function loadLocationsCompanyCounts(){
      const companyIds = (state._locationsCompanies || []).map(c => c.company_id);
      if(!companyIds.length) return;
      const { data, error } = await SB.client
        .from('company_locations')
        .select('company_id')
        .in('company_id', companyIds)
        .eq('is_active', true);
      if(error){ console.warn(error); return; }
      const counts = {};
      (data || []).forEach(row => {
        const id = row.company_id;
        counts[id] = (counts[id] || 0) + 1;
      });
      state._locationsLocationCounts = counts;
    }
    function renderLocationsCompanyList(){
      const container = $('locationsCompanyList');
      if(!container) return;
      const companies = state._locationsCompanies || [];
      const counts = state._locationsLocationCounts || {};
      if(!companies.length){
        container.innerHTML = '<div class="muted" style="padding:12px;">No companies found.</div>';
        return;
      }
      container.innerHTML = companies.map(c => {
        const count = counts[c.company_id] || 0;
        const badge = count === 0
          ? '<span class="locations-no-locations">No Locations</span>'
          : `<span class="locations-has-locations">${count} location${count !== 1 ? 's' : ''}</span>`;
        const displayName = String(c.company_name || c.company_slug || '').trim() || 'Unnamed Company';
        return `<div class="locations-company-item" data-locations-select-company="${escapeHtmlAttr(c.company_id)}">
          <span class="locations-company-name">${escapeHtml(displayName)}</span>
          ${badge}
        </div>`;
      }).join('');
    }
    function showLocationsCompanySelector(showSelector){
      const selector = $('locationsCompanySelector');
      const selected = $('locationsSelectedCompany');
      const toolbar = document.querySelector('.locations-toolbar');
      const scroll = document.querySelector('.locations-scroll');
      const legend = document.querySelector('.locations-legend');
      if(selector) selector.hidden = !showSelector;
      if(selected) selected.hidden = showSelector;
      if(toolbar) toolbar.style.display = showSelector ? 'none' : '';
      if(scroll) scroll.style.display = showSelector ? 'none' : '';
      if(legend) legend.style.display = showSelector ? 'none' : '';
    }
    function selectLocationsCompany(companyId, companyName){
      setCompanyLocationsContext({ companyId, companyName, source: 'super_user_selector' });
      const nameEl = $('locationsSelectedName');
      if(nameEl) nameEl.textContent = companyName || 'Unnamed Company';
      renderLocationsEnvBadge(companyId);
      // Show the selected company header
      const selectedDiv = $('locationsSelectedCompany');
      if(selectedDiv) selectedDiv.hidden = false;
      showLocationsCompanySelector(false);
      // Re-enable the Add Location button now that a company is selected
      const btnNew = $('btnCompanyLocationNew');
      if(btnNew){
        btnNew.disabled = false;
        btnNew.setAttribute('aria-disabled', 'false');
      }
      loadCompanyLocations();
    }
    function clearCompanyLocationForm(){
      state._companyLocationEditing = null;
      const name = $('companyLocationName'); if(name) name.value = '';
      const type = $('companyLocationType'); if(type) type.value = 'warehouse';
      setInputValueById('companyLocationAddress1', '');
      setAutocompleteStoredValue('companyLocationAddress1', '');
      setInputValueById('companyLocationAddress1Value', '');
      const placeId = $('companyLocationPlaceId'); if(placeId) placeId.value = '';
      const components = $('companyLocationAddressComponents'); if(components) components.value = '';
      const ship = $('companyLocationDefaultShipTo'); if(ship){ ship.checked = false; ship.disabled = false; }
      const receive = $('companyLocationDefaultReceiveAt'); if(receive){ receive.checked = false; receive.disabled = false; }
      const title = $('companyLocationEditorTitle'); if(title) title.textContent = 'Add Location';
      setCompanyLocationEditorMessage('');
    }
    function openCompanyLocationEditor(locationId){
      const id = String(locationId || '').trim();
      if(id){
        const row = state._companyLocationById && typeof state._companyLocationById.get === 'function'
          ? state._companyLocationById.get(id)
          : null;
        if(!row) return;
        state._companyLocationEditing = id;
        const title = $('companyLocationEditorTitle'); if(title) title.textContent = row.is_active ? 'Edit Location' : 'Edit Location (Archived)';
        const name = $('companyLocationName'); if(name) name.value = row.name || '';
        const type = $('companyLocationType'); if(type) type.value = row.location_type || 'warehouse';
        const formatted = String(row.google_formatted_address || '').trim();
        setInputValueById('companyLocationAddress1', formatted);
        setInputValueById('companyLocationAddress1Value', formatted);
        setAutocompleteStoredValue('companyLocationAddress1', formatted);
        const placeId = $('companyLocationPlaceId'); if(placeId) placeId.value = row.google_place_id || '';
        const components = $('companyLocationAddressComponents');
        if(components){
          const rawComponents = row.google_address_components;
          if(typeof rawComponents === 'string'){
            components.value = rawComponents;
          }else if(rawComponents){
            try{ components.value = JSON.stringify(rawComponents); }catch(e){ components.value = ''; }
          }else{
            components.value = '';
          }
        }
        const isArchived = !row.is_active;
        const ship = $('companyLocationDefaultShipTo');
        if(ship){
          ship.checked = !!row.is_default_ship_to;
          ship.disabled = isArchived || !!row.is_default_ship_to;
        }
        const receive = $('companyLocationDefaultReceiveAt');
        if(receive){
          receive.checked = !!row.is_default_receive_at;
          receive.disabled = isArchived || !!row.is_default_receive_at;
        }
        setCompanyLocationEditorMessage(isArchived ? 'Archived locations can be edited, but must be restored before use.' : '');
      }else{
        clearCompanyLocationForm();
      }
      // Add nested class if parent modal is nested (for proper z-index stacking)
      const editorModal = $('companyLocationEditorModal');
      const parentModal = $('companyLocationsModal');
      if(editorModal && parentModal && parentModal.classList.contains('modal-nested')){
        editorModal.classList.add('modal-nested');
      }else if(editorModal){
        editorModal.classList.add('modal-nested'); // Always nest since opened from locations modal
      }
      show('companyLocationEditorModal', true);
      // Initialize Google Places autocomplete after modal is visible
      void ensureGooglePlacesLoaded().then((ok)=>{
        if(!ok) {
          console.warn('[Places] Google Places not available');
          return;
        }
        initAddressAutocomplete('companyLocationAddress1', {
          address1: 'companyLocationAddress1',
          formatted: 'companyLocationAddress1Value',
          placeId: 'companyLocationPlaceId',
          components: 'companyLocationAddressComponents'
        }, true);
      });
    }
    function closeCompanyLocationEditor(){
      show('companyLocationEditorModal', false);
      const editorModal = $('companyLocationEditorModal');
      if(editorModal) editorModal.classList.remove('modal-nested');
    }
    async function openCompanyLocationsModal(context){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      const ctx = (context && context.companyId) ? {
        companyId: String(context.companyId || '').trim(),
        companyName: String(context.companyName || '').trim(),
        source: String(context.source || '').trim()
      } : null;
      if(ctx && ctx.companyId && String(ctx.companyId) !== String(SB.companyId || '').trim()){
        if(!isEffectiveSuperUser()){
          toast('Super user access required', 'error');
          return;
        }
      }
      // If no context provided, default to current user's company
      const currentCompanyName = SB.company
        ? String(SB.company.company_name || SB.company.company_slug || '').trim()
        : '';
      const effectiveCtx = ctx || {
        companyId: SB.companyId,
        companyName: currentCompanyName,
        source: 'current_user'
      };
      setCompanyLocationsContext(effectiveCtx);
      updateCompanyLocationsContextDisplay();

      if(!canAccessCompanyLocations()){
        toast('Company admin access required', 'error');
        setCompanyLocationsContext(null);
        updateCompanyLocationsContextDisplay();
        return;
      }
      const list = $('companyLocationsList');
      if(list) list.innerHTML = `<div class="muted">Loading locations...</div>`;
      setCompanyLocationsMessage('');
      show('companyLocationsModal', true);

      const btnNew = $('btnCompanyLocationNew');
      if(btnNew){
        const canManage = canManageCompanyLocations();
        btnNew.disabled = !canManage;
        btnNew.setAttribute('aria-disabled', canManage ? 'false' : 'true');
      }

      // Always hide the company selector initially, show locations directly
      showLocationsCompanySelector(false);

      // For super users, show the "Managing: Company" header with "Change Company" option
      const selectedDiv = $('locationsSelectedCompany');
      if(isEffectiveSuperUser()){
        const nameEl = $('locationsSelectedName');
        if(nameEl) nameEl.textContent = effectiveCtx.companyName || 'Unnamed Company';
        renderLocationsEnvBadge(effectiveCtx.companyId);
        if(selectedDiv) selectedDiv.hidden = false;
      }else{
        // Non-super users don't see the company header at all
        if(selectedDiv) selectedDiv.hidden = true;
      }

      try{
        await loadCompanyLocations();
      }catch(e){
        const msg = e && e.message ? e.message : 'Failed to load locations';
        if(isMissingRelationError(e)){
          setCompanyLocationsMessage('Locations are not available yet.');
        }else{
          setCompanyLocationsMessage(msg);
        }
      }
    }
    async function closeCompanyLocationsModal(){
      show('companyLocationsModal', false);
      // Remove nested class when closing
      const modal = $('companyLocationsModal');
      if(modal) modal.classList.remove('modal-nested');
      const ctx = state._companyLocationsContext;
      const override = ctx && ctx.companyId && String(ctx.companyId) !== String(SB.companyId || '').trim();
      setCompanyLocationsContext(null);
      updateCompanyLocationsContextDisplay();
      if(override){
        try{
          await loadCompanyLocations();
        }catch(e){}
      }
      const isOnboardingLocations = isOnboardingRoute() && (
        state._onboardingStep === 'locations' ||
        !!document.querySelector('[data-onboarding-step="locations"].active')
      );
      if(!isOnboardingLocations) return;
      let rows = [];
      try{
        rows = await sbFetchCompanyLocations();
      }catch(e){}
      renderOnboardingLocationsStatus(rows);
      const activeCount = Array.isArray(rows) ? rows.filter(r => r && r.is_active).length : 0;
      if(activeCount < 1) return;
      setOnboardingMessage('onboardingLocationsMsg', '');
      try{
        await advanceOnboardingState('LOCATIONS_CONFIGURED');
      }catch(e){
        setOnboardingMessage('onboardingLocationsMsg', e && e.message ? e.message : 'Unable to advance onboarding.');
        return;
      }
      setTimeout(()=>{ void handleOnboardingRoute(); }, 500);
    }
    function companyLocationFormPayload(){
      try{
        const pae = document.getElementById('companyLocationAddress1');
        if(pae && isPlaceAutocompleteEl(pae)){
          syncPlaceAutocompleteToHidden(pae, 'companyLocationAddress1Value');
        }
      }catch(e){}
      const addressLine1 = getInputValueById('companyLocationAddress1');
      const storedAddress = String($('companyLocationAddress1Value')?.value || '').trim();
      const formattedAddress = String(storedAddress || addressLine1 || '').trim();
      if(formattedAddress && formattedAddress !== storedAddress){
        setInputValueById('companyLocationAddress1Value', formattedAddress);
      }
      const placeId = String($('companyLocationPlaceId')?.value || '').trim();
      const componentsRaw = String($('companyLocationAddressComponents')?.value || '').trim();
      let components = null;
      if(componentsRaw){
        try{
          components = JSON.parse(componentsRaw);
        }catch(e){
          components = null;
        }
      }
      return {
        name: String($('companyLocationName')?.value || '').trim(),
        locationType: String($('companyLocationType')?.value || '').trim(),
        googleFormattedAddress: formattedAddress,
        googlePlaceId: placeId,
        googleAddressComponents: components,
        setDefaultShipTo: !!$('companyLocationDefaultShipTo')?.checked,
        setDefaultReceiveAt: !!$('companyLocationDefaultReceiveAt')?.checked
      };
    }
    function validateCompanyLocationPayload(payload){
      if(!payload.name) return 'Name is required.';
      if(!payload.locationType) return 'Location type is required.';
      if(!payload.googleFormattedAddress) return 'Address is required.';
      return '';
    }
    async function saveCompanyLocation(){
      if(!SB.ready || !SB.session) return;
      const companyId = getCompanyLocationsCompanyId();
      if(!companyId){
        setCompanyLocationEditorMessage('No company selected.');
        return;
      }
      if(!canManageCompanyLocations()){
        setCompanyLocationEditorMessage('Location permissions required.');
        return;
      }
      const payload = companyLocationFormPayload();
      const errorMsg = validateCompanyLocationPayload(payload);
      if(errorMsg){
        setCompanyLocationEditorMessage(errorMsg);
        return;
      }
      const btn = $('btnCompanyLocationSave');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Saving...'; }
      try{
        if(state._companyLocationEditing){
          const locationId = state._companyLocationEditing;
          const { data, error } = await SB.client.rpc('update_company_location', {
            p_location_id: locationId,
            p_name: payload.name,
            p_location_type: payload.locationType,
            p_google_formatted_address: payload.googleFormattedAddress,
            p_google_place_id: payload.googlePlaceId || null,
            p_google_address_components: payload.googleAddressComponents || null
          });
          if(error) throw error;
          if(data && data.success === false){
            throw new Error(data.error || 'Update failed');
          }
          const row = state._companyLocationById && typeof state._companyLocationById.get === 'function'
            ? state._companyLocationById.get(locationId)
            : null;
          const isActive = row ? !!row.is_active : true;
          if(isActive && payload.setDefaultShipTo && row && !row.is_default_ship_to){
            const { data: defData, error: defError } = await SB.client.rpc('set_default_location', {
              p_location_id: locationId,
              p_default_type: 'ship_to'
            });
            if(defError) throw defError;
            if(defData && defData.success === false){
              throw new Error(defData.error || 'Failed to set default ship-to');
            }
          }
          if(isActive && payload.setDefaultReceiveAt && row && !row.is_default_receive_at){
            const { data: defData, error: defError } = await SB.client.rpc('set_default_location', {
              p_location_id: locationId,
              p_default_type: 'receive_at'
            });
            if(defError) throw defError;
            if(defData && defData.success === false){
              throw new Error(defData.error || 'Failed to set default receive-at');
            }
          }
        }else{
          const { data, error } = await SB.client.rpc('create_company_location', {
            p_company_id: companyId,
            p_name: payload.name,
            p_location_type: payload.locationType,
            p_google_formatted_address: payload.googleFormattedAddress,
            p_google_place_id: payload.googlePlaceId || null,
            p_google_address_components: payload.googleAddressComponents || null,
            p_set_default_ship_to: payload.setDefaultShipTo,
            p_set_default_receive_at: payload.setDefaultReceiveAt
          });
          if(error) throw error;
          if(data && data.success === false){
            throw new Error(data.error || 'Create failed');
          }
        }
        await loadCompanyLocations();
        closeCompanyLocationEditor();
        clearCompanyLocationForm();
        toast('Location saved', 'success');
        const isOnboardingLocations = isOnboardingRoute() && (
          state._onboardingStep === 'locations' ||
          !!document.querySelector('[data-onboarding-step="locations"].active')
        );
        if(isOnboardingLocations){
          void closeCompanyLocationsModal();
        }
      }catch(e){
        setCompanyLocationEditorMessage(e && e.message ? e.message : 'Save failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Save'; }
      }
    }
    async function setDefaultCompanyLocation(locationId, defaultType){
      const id = String(locationId || '').trim();
      const type = String(defaultType || '').trim();
      if(!id || !type) return;
      if(!canManageCompanyLocations()){
        toast('Location permissions required');
        return;
      }
      const { data, error } = await SB.client.rpc('set_default_location', {
        p_location_id: id,
        p_default_type: type
      });
      if(error) throw error;
      if(data && data.success === false){
        throw new Error(data.error || 'Default update failed');
      }
      await loadCompanyLocations();
    }
    async function archiveCompanyLocation(locationId){
      const id = String(locationId || '').trim();
      if(!id) return;
      if(!canManageCompanyLocations()){
        toast('Location permissions required');
        return;
      }
      const ok = await openConfirmModal(
        'Archive location?',
        'Archived locations cannot be used for new shipments or receipts.',
        { okText:'Archive', cancelText:'Cancel' }
      );
      if(!ok) return;
      const { data, error } = await SB.client.rpc('archive_company_location', { p_location_id: id });
      if(error) throw error;
      if(data && data.success === false){
        throw new Error(data.error || 'Archive failed');
      }
      await loadCompanyLocations();
      toast('Location archived');
    }
    async function restoreCompanyLocation(locationId){
      const id = String(locationId || '').trim();
      if(!id) return;
      if(!canManageCompanyLocations()){
        toast('Location permissions required');
        return;
      }
      const { data, error } = await SB.client.rpc('restore_company_location', { p_location_id: id });
      if(error) throw error;
      if(data && data.success === false){
        throw new Error(data.error || 'Restore failed');
      }
      await loadCompanyLocations();
      toast('Location restored');
    }

    async function sbFetchOrderRecipientSuggestions(prefix){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
      if(!canOrdersView()) return [];
      const q = String(prefix||'').trim();
      const variants = [
        { withCompany: true, select: 'email,name,last_used_at' },
        { withCompany: true, select: 'email,last_used_at' },
        { withCompany: false, select: 'email,name,last_used_at' },
        { withCompany: false, select: 'email,last_used_at' },
      ];
      let lastError = null;
      for(const variant of variants){
        let req = SB.client
          .from('order_recipients')
          .select(variant.select);
        if(variant.withCompany) req = req.eq('company_id', SB.companyId);
        req = req.order('last_used_at', { ascending:false }).limit(20);
        if(q) req = req.ilike('email', q + '%');
        const { data, error } = await req;
        if(!error) return Array.isArray(data) ? data : [];
        if(
          !isMissingColumnError(error, 'company_id') &&
          !isMissingColumnError(error, 'name')
        ){
          throw error;
        }
        lastError = error;
      }
      if(lastError) throw lastError;
      return [];
    }
    async function sbRecordOrderRecipient(email, name){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
      if(!canOrdersCreate()) throw new Error('Permission denied');
      const e = String(email||'').trim().toLowerCase();
      if(!e) return;
      const row = {
        company_id: SB.companyId,
        email: e,
        last_used_at: new Date().toISOString(),
        created_by: SB.user ? SB.user.id : null,
      };
      const nm = String(name||'').trim();
      if(nm) row.name = nm;
      let onConflict = 'company_id,email';
      let attemptRow = { ...row };
      for(let attempt = 0; attempt < 3; attempt++){
        const { error } = await SB.client
          .from('order_recipients')
          .upsert([attemptRow], { onConflict });
        if(!error) return;
        const msg = errToText(error).toLowerCase();
        let adjusted = false;
        if(onConflict === 'company_id,email' && (isMissingColumnError(error, 'company_id') || msg.includes('on_conflict'))){
          onConflict = 'email';
          delete attemptRow.company_id;
          adjusted = true;
        }
        if(isMissingColumnError(error, 'created_by')){
          delete attemptRow.created_by;
          adjusted = true;
        }
        if(isMissingColumnError(error, 'name')){
          delete attemptRow.name;
          adjusted = true;
        }
        if(!adjusted) throw error;
      }
    }
    function normalizeOrderLineItems(value){
      const arr = Array.isArray(value) ? value : [];
      return arr
        .map((x) => {
          const item_id = String(x?.item_id || x?.itemId || x?.id || '').trim();
          const part = String(x?.part || x?.name || x?.item || '').trim();
          let desc = String(x?.desc || x?.description || '').trim();
          // Fallback: look up description from inventory if not stored
          if(!desc && part){
            const inv = state.items.find(it => it.name === part);
            if(inv) desc = String(inv.desc || '').trim();
          }
          const qty = toInt(x?.qty, 0);
          return { item_id, part, desc, qty };
        })
        .filter((x) => x.part);
    }
    async function sbInsertOrderHistoryFromData({ toEmail, subjectLine, contactName, notes, lineItems, providerResult, companyPoNumber, internalPoNumber, shippingAddressId, shippingAddressSnapshot, shortfallId, jobNumbers }){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.user || !SB.companyId) return;
      if(!canOrdersCreate()) throw new Error('Permission denied');
      const cleaned = normalizeEmailLineItems(lineItems).map(x => ({ item_id: x.item_id ? String(x.item_id).trim() : null, part: x.part, desc: x.desc, qty: x.qty }));
      const jobs = (Array.isArray(jobNumbers) ? jobNumbers : []).map(n => String(n || '').trim()).filter(Boolean);
      // Use company PO number or internal PO number as the po_number
      const poNumber = String(companyPoNumber || internalPoNumber || '').trim();
      if(!poNumber) throw new Error('PO number is required');
      // Insert into purchase_orders table
      const poRow = {
        company_id: SB.companyId,
        created_by: SB.user.id,
        po_number: poNumber,
        status: 'submitted',
        recipient_email: String(toEmail||'').trim() || null,
        recipient_name: String(contactName||'').trim() || null,
        notes: String(notes||'').trim() || null,
        email_subject: String(subjectLine||'').trim() || null,
        ship_to_location_id: shippingAddressId ? String(shippingAddressId).trim() : null,
        related_job_numbers: jobs.length ? jobs : null,
      };
      const { data: poData, error: poError } = await SB.client
        .from('purchase_orders')
        .insert([poRow])
        .select('id')
        .single();
      if(poError) throw poError;
      const poId = poData && poData.id;
      if(!poId) throw new Error('Failed to create purchase order');
      // Insert line items into purchase_order_items
      if(cleaned.length > 0){
        const lineRows = cleaned.map(ln => ({
          purchase_order_id: poId,
          item_id: ln.item_id || null,
          item_name: String(ln.part || '').trim(),
          item_sku: String(ln.desc || '').trim() || null,
          quantity_ordered: toInt(ln.qty, 0),
        }));
        const { error: linesError } = await SB.client
          .from('purchase_order_items')
          .insert(lineRows);
        if(linesError) throw linesError;
      }
    }
    async function sbInsertOrderHistory(providerResult){
      const ord = orderState();
      const lineItems = orderActiveLines().map(l => ({ item_id: String(l.id || '').trim() || null, part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shortfallId = (ord.shortfallAttached && ord.shortfall && ord.shortfall.id)
        ? String(ord.shortfall.id)
        : null;
      const jobNumbers = getOrderRelatedJobNumbers(ord);
      return sbInsertOrderHistoryFromData({
        toEmail: String(ord.email||'').trim(),
        subjectLine: composeOrderSubject(ord),
        contactName: String(ord.contactName||'').trim(),
        notes: String(ord.notes||'').trim(),
        lineItems,
        providerResult,
        companyPoNumber: String(ord.companyPoNumber||'').trim(),
        internalPoNumber: String(ord.internalPoNumber||'').trim(),
        shippingAddressId: ord.shippingAddressId,
        shippingAddressSnapshot: getOrderShippingSnapshot(ord),
        shortfallId,
        jobNumbers,
      });
    }
    const PURCHASE_ORDER_BASE_COLUMNS = [
      'id',
      'po_number',
      'status',
      'order_date',
      'expected_date',
      'received_date',
      'notes',
      'vendor_id',
      'vendor_name',
      'recipient_email',
      'recipient_name',
      'ship_to_location_id',
      'created_at',
      'related_job_numbers',
    ];
    const PURCHASE_ORDER_MIN_COLUMNS = [
      'id',
      'po_number',
      'status',
      'created_at',
    ];
    function normalizePurchaseOrderColumns(columns){
      const list = Array.isArray(columns) ? columns : [];
      const out = [];
      for(const col of list){
        const key = String(col || '').trim();
        if(!key) continue;
        if(!out.includes(key)) out.push(key);
      }
      return out.length ? out : PURCHASE_ORDER_MIN_COLUMNS.slice();
    }
    function buildPurchaseOrderSelect(columns){
      const list = normalizePurchaseOrderColumns(columns);
      return list.join(',');
    }
    function dropMissingPurchaseOrderColumns(columns, error){
      const list = normalizePurchaseOrderColumns(columns);
      const missing = list.filter(col => isMissingColumnError(error, col));
      if(!missing.length) return { columns: list, changed: false, missing };
      const next = list.filter(col => !missing.includes(col));
      return { columns: next.length ? next : PURCHASE_ORDER_MIN_COLUMNS.slice(), changed: true, missing };
    }
	    async function sbFetchOrders(limit = 50){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
	      if(!canOrdersView()) return [];
	      const lim = Math.max(1, Math.min(200, toInt(limit, 50)));
	      let rows = [];
	      let lastError = null;
	      let allowOrderDate = true;
	      let columns = PURCHASE_ORDER_BASE_COLUMNS.slice();
	      let attemptedMinimal = false;
	      for(let attempt = 0; attempt < 6; attempt++){
	        columns = normalizePurchaseOrderColumns(columns);
	        const canOrderByDate = allowOrderDate && columns.includes('order_date');
	        const req = SB.client
	          .from('purchase_orders')
	          .select(buildPurchaseOrderSelect(columns))
	          .eq('company_id', SB.companyId);
	        if(canOrderByDate){
	          req.order('order_date', { ascending:false }).order('created_at', { ascending:false });
	        }else{
	          req.order('created_at', { ascending:false });
	        }
	        req.limit(lim);
	        const { data, error } = await req;
	        if(!error){
	          rows = Array.isArray(data) ? data : [];
	          return rows.map(normalizePurchaseOrderRow);
	        }
	        const dropResult = dropMissingPurchaseOrderColumns(columns, error);
	        if(dropResult.changed){
	          columns = dropResult.columns;
	          if(dropResult.missing.includes('order_date')) allowOrderDate = false;
	          continue;
	        }
	        if(canOrderByDate && isMissingColumnError(error, 'order_date')){
	          allowOrderDate = false;
	          columns = columns.filter(c => c !== 'order_date');
	          continue;
	        }
	        if(!attemptedMinimal){
	          attemptedMinimal = true;
	          columns = PURCHASE_ORDER_MIN_COLUMNS.slice();
	          allowOrderDate = false;
	          continue;
	        }
	        if(!shouldRetryOrderSelect(error)){
	          throw error;
	        }
	        lastError = error;
	        break;
	      }
	      if(lastError) throw lastError;
	      return rows.map(normalizePurchaseOrderRow);
	    }
	    async function sbFetchAllOrders(pageSize = 200){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
	      const size = Math.max(1, Math.min(200, toInt(pageSize, 200)));
	      let offset = 0;
	      const out = [];
	      let allowOrderDate = true;
	      for(let page=0; page<200; page++){
	        let rows = [];
	        let lastError = null;
	        let columns = PURCHASE_ORDER_BASE_COLUMNS.slice();
	        let attemptedMinimal = false;
	        for(let attempt = 0; attempt < 6; attempt++){
	          columns = normalizePurchaseOrderColumns(columns);
	          const canOrderByDate = allowOrderDate && columns.includes('order_date');
	          const req = SB.client
	            .from('purchase_orders')
	            .select(buildPurchaseOrderSelect(columns))
	            .eq('company_id', SB.companyId);
	          if(canOrderByDate){
	            req.order('order_date', { ascending:false }).order('created_at', { ascending:false });
	          }else{
	            req.order('created_at', { ascending:false });
	          }
	          req.range(offset, offset + size - 1);
	          const { data, error } = await req;
	          if(!error){
	            rows = Array.isArray(data) ? data : [];
	            break;
	          }
	          const dropResult = dropMissingPurchaseOrderColumns(columns, error);
	          if(dropResult.changed){
	            columns = dropResult.columns;
	            if(dropResult.missing.includes('order_date')) allowOrderDate = false;
	            continue;
	          }
	          if(canOrderByDate && isMissingColumnError(error, 'order_date')){
	            allowOrderDate = false;
	            columns = columns.filter(c => c !== 'order_date');
	            continue;
	          }
	          if(!attemptedMinimal){
	            attemptedMinimal = true;
	            columns = PURCHASE_ORDER_MIN_COLUMNS.slice();
	            allowOrderDate = false;
	            continue;
	          }
	          if(!shouldRetryOrderSelect(error)) throw error;
	          lastError = error;
	          break;
	        }
	        if(!rows.length && lastError) throw lastError;
	        out.push(...rows.map(normalizePurchaseOrderRow));
	        if(rows.length < size) break;
	        offset += size;
	      }
	      return out;
	    }
      function normalizePurchaseOrderRow(row){
        const vendorName = row && row.vendor && row.vendor.name ? String(row.vendor.name).trim() : '';
        const fallbackVendor = String(row && row.vendor_name ? row.vendor_name : '').trim();
        return { ...row, vendor_name: vendorName || fallbackVendor };
      }
      function lineQtyOrdered(row){
        return toQty(
          row && (
            row.quantity_ordered ??
            row.qty_ordered ??
            row.ordered_qty ??
            row.quantity ??
            row.qty
          ),
          0
        );
      }
      function lineQtyReceived(row){
        return toQty(
          row && (
            row.quantity_received ??
            row.qty_received ??
            row.received_qty ??
            row.qty_received_total
          ),
          0
        );
      }
      function normalizePurchaseOrderLine(row){
        return {
          id: row && row.id ? String(row.id).trim() : '',
          purchase_order_id: row && row.purchase_order_id ? String(row.purchase_order_id).trim() : '',
          item_id: row && row.item_id ? String(row.item_id).trim() : '',
          item_name: String(row && (row.item_name || row.name || row.item) ? (row.item_name || row.name || row.item) : '').trim(),
          item_sku: String(row && (row.item_sku || row.sku) ? (row.item_sku || row.sku) : '').trim(),
          quantity_ordered: lineQtyOrdered(row),
          quantity_received: lineQtyReceived(row),
          unit_cost: row && row.unit_cost !== undefined ? row.unit_cost : null,
          notes: String(row && row.notes ? row.notes : '').trim(),
          created_at: row && row.created_at ? row.created_at : null,
        };
      }
      function normalizePurchaseOrderLines(rows){
        const list = Array.isArray(rows) ? rows : [];
        return list.map(normalizePurchaseOrderLine);
      }
      async function sbFetchPurchaseOrderLinesByPoIds(poIds){
        const ids = Array.isArray(poIds) ? poIds.filter(Boolean) : [];
        const map = new Map();
        if(!ids.length) return map;
        const select =
          'id,purchase_order_id,item_id,item_name,item_sku,quantity_ordered,quantity_received,unit_cost,notes,created_at';
        let data = null;
        let error = null;
        const primaryTable = state._poLinesTable || 'purchase_order_items';
        ({ data, error } = await SB.client
          .from(primaryTable)
          .select(select)
          .in('purchase_order_id', ids));
        if(error && isMissingRelationError(error)){
          if(primaryTable === 'purchase_order_items'){
            state._poLinesTable = 'purchase_order_lines';
          }
          ({ data, error } = await SB.client
            .from(state._poLinesTable)
            .select(select)
            .in('purchase_order_id', ids));
        }
        if(error) throw error;
        const rows = normalizePurchaseOrderLines(data || []);
        for(const row of rows){
          const key = String(row.purchase_order_id || '').trim();
          if(!key) continue;
          if(!map.has(key)) map.set(key, []);
          map.get(key).push(row);
        }
        return map;
      }
	    function csvEscape(value){
	      const s = String(value ?? '');
	      return '"' + s.replace(/"/g, '""') + '"';
	    }
	    function orderLineItemsToCsvCell(value){
	      const items = normalizePurchaseOrderLines(value);
	      if(!items.length) return '';
	      return items
	        .map(it => {
	          const name = String(it.item_name || '').trim();
	          const sku = String(it.item_sku || '').trim();
	          const qty = formatQty(it.quantity_ordered);
	          const label = sku ? `${name} (${sku})` : name;
	          return `${label} | ${qty}`;
	        })
	        .join(' ; ');
	    }
	    function buildOrderHistoryCsv(rows, lineMap){
      const header = [
        'PO ID',
        'PO Number',
        'Status',
        'Order Date',
        'Expected Date',
        'Received Date',
        'Vendor',
        'Notes',
        'Item Count',
        'Items',
      ];
	      const out = [header.map(csvEscape).join(',')];
	      const list = Array.isArray(rows) ? rows : [];
	      for(const o of list){
	        const id = String(o?.id || '').trim();
        const poNumber = String(o?.po_number || '').trim();
        const status = String(o?.status || '').trim();
        const orderDate = String(o?.order_date || '').trim();
        const expectedDate = String(o?.expected_date || '').trim();
        const receivedDate = String(o?.received_date || '').trim();
        const vendor = String(o?.vendor_name || o?.vendor?.name || o?.vendor_id || '').trim();
        const notes = String(o?.notes || '').trim();
        const lines = lineMap && typeof lineMap.get === 'function' ? (lineMap.get(id) || []) : [];
        const items = normalizePurchaseOrderLines(lines);
        const itemsCell = orderLineItemsToCsvCell(lines);
        out.push([
          id,
          poNumber,
          status,
          orderDate,
          expectedDate,
          receivedDate,
          vendor,
          notes,
          String(items.length),
          itemsCell,
        ].map(csvEscape).join(','));
      }
	      // Add BOM so Excel opens UTF-8 correctly
	      return '\ufeff' + out.join('\n');
	    }
	    async function downloadOrderHistoryCsv(){
	      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
	      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }

	      const btn = $('btnOrderHistoryDownload');
	      const priorTitle = btn ? btn.getAttribute('title') : '';
	      if(btn){ btn.disabled = true; btn.setAttribute('title', 'Downloadingâ€¦'); }
	      try{
	        toast('Downloading order historyâ€¦');
	        const rows = await sbFetchAllOrders(200);
	        if(!rows.length){ toast('No orders to download'); return; }
	        const lineMap = await sbFetchPurchaseOrderLinesByPoIds(rows.map(r => r && r.id));
	        const csv = buildOrderHistoryCsv(rows, lineMap);
	        const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
	        const url = URL.createObjectURL(blob);
	        const a = document.createElement('a');
	        a.href = url;
	        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
	        a.download = `order-history-${stamp}.csv`;
	        document.body.appendChild(a);
	        a.click();
	        document.body.removeChild(a);
	        URL.revokeObjectURL(url);
	        toast(`Downloaded ${rows.length} order(s)`);
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Download failed');
	      }finally{
	        if(btn){ btn.disabled = false; btn.setAttribute('title', priorTitle || 'Download CSV'); }
	      }
	    }
	    async function sbDeleteOrder(orderId){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      if(!canOrdersDelete()) throw new Error('Permission denied');
	      const id = String(orderId || '').trim();
	      if(!id) throw new Error('Invalid order ID');
	      const { data, error } = await SB.client
	        .rpc('soft_delete_order', { p_order_id: id });
	      if(error) throw error;
	      if(data && data.success === false){
	        throw new Error(data.error || 'Delete failed');
	      }
	    }

	    async function deleteOrderFromHistory(orderId, btnEl){
	      const id = String(orderId || '').trim();
	      if(!id) return false;
	      if(!canOrdersDelete()){ toast('Delete not allowed'); return false; }
	      if(!(await openConfirmModal('Delete order?', 'Delete this order from history?', { okText:'Delete', cancelText:'Cancel' }))) return false;
	      if(btnEl) btnEl.disabled = true;
	      try{
	        await sbDeleteOrder(id);
	        try{
	          if(state._orderHistoryById && typeof state._orderHistoryById.delete === 'function'){
	            state._orderHistoryById.delete(id);
	          }
	          if(Array.isArray(state._orderHistoryRows)){
	            state._orderHistoryRows = state._orderHistoryRows.filter(r => String(r && r.id ? r.id : '') !== id);
	          }
        }catch(e){}
        renderOrderHistoryFiltered();
        updateOrderHistoryTabBadges();
        updateMenuOrderBadgesFromState();
        scheduleMenuActionBadgeRefresh({ force: true });
        toast('Order deleted', 'success');
        return true;
	      }catch(err){
	        toast(err && err.message ? err.message : 'Delete failed');
	        if(btnEl) btnEl.disabled = false;
	        return false;
	      }
	    }

	    async function sbUpdateOrder(orderId, fields){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      if(!canOrdersEdit()) throw new Error('Permission denied');
	      const id = String(orderId || '').trim();
	      if(!id) throw new Error('Invalid order ID');
	      const { error } = await SB.client
	        .from('orders')
	        .update(fields || {})
	        .eq('id', id)
	        .eq('company_id', SB.companyId)
	        .is('deleted_at', null);
	      if(error) throw error;
	    }

	    function normalizePurchaseOrderStatus(status){
	      const s = String(status || '').trim().toLowerCase();
	      if(!s) return '';
	      if(s === 'received' || s === 'completed' || s === 'fully_received') return 'fully_received';
	      if(s === 'partial' || s === 'partially_received') return 'partially_received';
	      if(s === 'sent' || s === 'approved' || s === 'confirmed') return 'submitted';
	      if(s === 'canceled') return 'cancelled';
	      return s;
	    }

	    function getPurchaseOrderLineTotalsById(orderId, lineMap){
	      const id = String(orderId || '').trim();
	      if(!id) return { ordered:0, received:0, remaining:0, hasLines:false };
	      const map = lineMap || state._orderHistoryLinesByPo || new Map();
	      const lines = normalizePurchaseOrderLines(map.get(id) || []);
	      if(!lines.length) return { ordered:0, received:0, remaining:0, hasLines:false };
	      let ordered = 0;
	      let received = 0;
	      let remaining = 0;
	      for(const line of lines){
	        const qtyOrdered = toQty(line.quantity_ordered, 0);
	        const qtyReceived = toQty(line.quantity_received, 0);
	        ordered += qtyOrdered;
	        received += qtyReceived;
	        remaining += Math.max(0, qtyOrdered - qtyReceived);
	      }
	      return { ordered, received, remaining, hasLines:true };
	    }

	    function applyPurchaseOrderLineTotals(orderRow, totals){
	      if(!orderRow || !totals) return;
	      orderRow.ordered_total_qty = totals.ordered;
	      orderRow.received_total_qty = totals.received;
	      orderRow.remaining_total_qty = totals.remaining;
	      orderRow.has_line_items = totals.hasLines;
	    }

	    function getPurchaseOrderReceiveState(orderRow, totals){
	      const statusKey = normalizePurchaseOrderStatus(orderRow && orderRow.status);
	      if(statusKey === 'draft') return 'draft';
	      if(statusKey === 'cancelled' || statusKey === 'closed' || statusKey === 'voided') return statusKey;
	      if(totals && totals.hasLines){
	        if(totals.remaining <= 0 && totals.ordered > 0) return 'fully_received';
	        if(totals.received > 0 && totals.remaining > 0) return 'partially_received';
	        if(totals.received === 0 && totals.remaining > 0) return 'submitted';
	      }
	      if(statusKey === 'partially_received' || statusKey === 'fully_received') return statusKey;
	      if(statusKey === 'submitted') return 'submitted';
	      return statusKey;
	    }

	    function formatPurchaseOrderStatusLabel(orderRow, totals){
	      const state = getPurchaseOrderReceiveState(orderRow, totals);
	      if(state === 'draft') return 'Draft';
	      if(state === 'submitted') return 'Submitted';
	      if(state === 'partially_received') return 'Partially Received';
	      if(state === 'fully_received') return 'Fully Received';
	      if(state === 'cancelled') return 'Cancelled';
	      if(state === 'closed') return 'Closed';
	      if(state === 'voided') return 'Voided';
	      return formatStateToken(state || (orderRow && orderRow.status) || '');
	    }

	    function isOrderCurrentlyReceived(orderRow){
	      const totals = getPurchaseOrderLineTotalsById(orderRow && orderRow.id);
	      if(totals.hasLines){
	        return totals.remaining <= 0 && totals.ordered > 0;
	      }
	      const statusKey = normalizePurchaseOrderStatus(orderRow && orderRow.status);
	      return statusKey === 'fully_received';
	    }

	    function orderReceiptMetaText(orderRow){
	      const totals = getPurchaseOrderLineTotalsById(orderRow && orderRow.id);
	      return formatPurchaseOrderStatusLabel(orderRow, totals);
	    }

	    function getOrderHistoryRowById(orderId){
	      const id = String(orderId || '').trim();
	      if(!id) return null;
	      if(state._orderHistoryById && typeof state._orderHistoryById.get === 'function'){
	        const row = state._orderHistoryById.get(id) || null;
	        if(row) return row;
	      }
	      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
	      return rows.find(r => String(r && r.id ? r.id : '').trim() === id) || null;
	    }

	    function patchOrderHistoryRow(orderId, patch){
	      const id = String(orderId || '').trim();
	      if(!id || !patch || typeof patch !== 'object') return;
	      try{
	        const row = getOrderHistoryRowById(id);
	        if(row) Object.assign(row, patch);
	      }catch(e){}
	      try{
	        if(state._orderHistoryById && typeof state._orderHistoryById.get === 'function'){
	          const row2 = state._orderHistoryById.get(id) || null;
	          if(row2) Object.assign(row2, patch);
	        }
	      }catch(e){}
	      try{
	        if(Array.isArray(state._orderHistoryRows)){
	          const i = state._orderHistoryRows.findIndex(r => String(r && r.id ? r.id : '').trim() === id);
	          if(i >= 0 && state._orderHistoryRows[i]) Object.assign(state._orderHistoryRows[i], patch);
	        }
	      }catch(e){}
	    }

	    function setLocalItemQty(itemId, qty){
	      const id = String(itemId || '').trim();
	      if(!id) return;
	      const it = state.items.find(x => x && x.id === id);
	      if(!it) return;
	      it.qty = toInt(qty, 0);
	    }

	    function resolveInventoryItemForOrderLine(line){
	      const storedId = String(line && line.item_id ? line.item_id : '').trim();
	      if(storedId){
	        const byId = getInventoryById(storedId);
	        if(byId) return byId;
	      }
	      const part = String(line && line.part ? line.part : '').trim();
	      const k = toKey(part);
	      if(!k) return null;
	      return state.items.find(it => it && toKey(it.name) === k) || null;
	    }

	    function normalizeReceiptLines(value){
	      const arr = Array.isArray(value) ? value : [];
	      return arr
	        .map((x) => ({
	          item_id: String(x && x.item_id ? x.item_id : '').trim(),
	          part: String(x && x.part ? x.part : '').trim(),
	          delta_qty: toInt(x && x.delta_qty, 0),
	          prev_qty: toInt(x && x.prev_qty, 0),
	          next_qty: toInt(x && x.next_qty, 0),
	        }))
	        .filter((l) => l.item_id && l.part && l.delta_qty > 0);
	    }

	    function normalizeReceiptSkipped(value){
	      const arr = Array.isArray(value) ? value : [];
	      return arr
	        .map((x) => ({
	          part: String(x && (x.part || x.name || x.item) ? (x.part || x.name || x.item) : '').trim(),
	          reason: String(x && x.reason ? x.reason : '').trim() || 'not_found',
	        }))
	        .filter((s) => s.part);
	    }

	    function receiptSkipText(s){
	      const reason = String(s && s.reason ? s.reason : '').trim();
	      const part = String(s && s.part ? s.part : '').trim();
	      if(reason === 'conflict') return `${part} (qty changed)`;
	      if(reason === 'deleted') return `${part} (item deleted)`;
	      return `${part} (not found)`;
	    }

	    function receiptAppliedLineText(line, mode){
	      const l = line || {};
	      const part = String(l.part || '').trim();
	      const delta = toInt(l.delta_qty, 0);
	      const prev = toInt(l.prev_qty, 0);
	      const next = toInt(l.next_qty, 0);
	      if(mode === 'undo') return `${part}: -${delta} (${next} â†’ ${prev})`;
	      return `${part}: +${delta} (${prev} â†’ ${next})`;
	    }

	    function buildReceiptSummary({ subject, applied, skipped, mode }){
	      const title = (mode === 'undo') ? 'Receive undone' : 'Order received';
	      const lines = Array.isArray(applied) ? applied : [];
	      const skips = Array.isArray(skipped) ? skipped : [];
	      const body = [
	        subject ? `Order: ${subject}` : '',
	        '',
	        `Applied: ${lines.length}`,
	        `Skipped: ${skips.length}`,
	        '',
	        'Applied lines:',
	        lines.length ? lines.map(l => `- ${receiptAppliedLineText(l, mode)}`).join('\n') : '(none)',
	        '',
	        'Skipped lines:',
	        skips.length ? skips.map(s => `- ${receiptSkipText(s)}`).join('\n') : '(none)',
	      ].filter((x, i, arr) => !(x === '' && arr[i-1] === '')).join('\n');
	      const copy = JSON.stringify({ mode, subject, applied: lines, skipped: skips }, null, 2);
	      return { title, body, copy };
	    }

	    async function buildReceivingSnapshotForOrder(orderRow){
	      const items = normalizeOrderLineItems(orderRow && orderRow.line_items ? orderRow.line_items : []);
	      const skipped = [];
	      const agg = new Map(); // itemId -> { item_id, part, delta_qty }
	      for(const it of items){
	        const delta = toInt(it && it.qty, 0);
	        if(delta <= 0) continue;
	        const inv = resolveInventoryItemForOrderLine(it);
	        if(!inv){
	          const part = String(it && it.part ? it.part : '').trim();
	          if(part) skipped.push({ part, reason:'not_found' });
	          continue;
	        }
	        const key = String(inv.id || '').trim();
	        if(!key) continue;
	        const existing = agg.get(key);
	        const part = String(it && it.part ? it.part : (inv.name || '')).trim();
	        if(existing){
	          existing.delta_qty += delta;
	        }else{
	          agg.set(key, { item_id: key, part: part || String(inv.name||'').trim(), delta_qty: delta });
	        }
	      }

	      const ids = Array.from(agg.keys());
	      const qtyMap = await sbFetchItemQtyMap(ids);
	      const lines = [];
	      for(const [id, entry] of agg){
	        const prev = qtyMap.get(id);
	        if(typeof prev !== 'number'){
	          const part = String(entry && entry.part ? entry.part : '').trim();
	          if(part) skipped.push({ part, reason:'not_found' });
	          continue;
	        }
	        const delta = toInt(entry.delta_qty, 0);
	        if(delta <= 0) continue;
	        lines.push({
	          item_id: id,
	          part: String(entry.part || '').trim() || id,
	          delta_qty: delta,
	          prev_qty: prev,
	          next_qty: prev + delta,
	        });
	      }

	      return {
	        planned_at: new Date().toISOString(),
	        planned_by: SB.user ? SB.user.id : null,
	        lines,
	        skipped,
	      };
	    }

	    async function applyReceivingSnapshot(orderId, snapshot){
	      const planned = (snapshot && typeof snapshot === 'object') ? snapshot : {};
	      const lines = normalizeReceiptLines(planned.lines);
	      const baseSkipped = normalizeReceiptSkipped(planned.skipped).map(s => ({ part: s.part, reason: 'not_found' }));
	      const ids = lines.map(l => l.item_id);
	      const qtyMap = await sbFetchItemQtyMap(ids);
	      const applied = [];
	      const skipped = baseSkipped.slice();

	      for(const l of lines){
	        const current = qtyMap.get(l.item_id);
	        if(typeof current !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        if(current === l.next_qty){
	          applied.push(l);
	          setLocalItemQty(l.item_id, l.next_qty);
	          continue;
	        }
	        if(current !== l.prev_qty){
	          skipped.push({ part: l.part, reason:'conflict' });
	          continue;
	        }
	        const ok = await sbUpdateItemQtyIfMatch(l.item_id, l.prev_qty, l.next_qty);
	        if(ok){
	          qtyMap.set(l.item_id, l.next_qty);
	          applied.push(l);
	          setLocalItemQty(l.item_id, l.next_qty);
	          continue;
	        }
	        const refreshed = await sbFetchItemQtyMap([l.item_id]);
	        const current2 = refreshed.get(l.item_id);
	        if(typeof current2 !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        qtyMap.set(l.item_id, current2);
	        if(current2 === l.next_qty){
	          applied.push(l);
	          setLocalItemQty(l.item_id, l.next_qty);
	          continue;
	        }
	        skipped.push({ part: l.part, reason:'conflict' });
	      }

	      const appliedAt = new Date().toISOString();
	      const receivedSnapshot = {
	        applied_at: appliedAt,
	        applied_by: SB.user ? SB.user.id : null,
	        lines: applied,
	        skipped,
	      };
	      const patch = {
	        receiving_at: null,
	        receiving_by: null,
	        receiving_snapshot: null,
	        received_at: appliedAt,
	        received_by: SB.user ? SB.user.id : null,
	        received_snapshot: receivedSnapshot,
	        received_undone_at: null,
	        received_undone_by: null,
	      };
	      await sbUpdateOrder(orderId, patch);
	      patchOrderHistoryRow(orderId, patch);
	      try{ setUpdated(); render(); }catch(e){}
	      try{ renderOrderHistoryFiltered(); }catch(e){}
	      return { receivedSnapshot, applied, skipped };
	    }

	    async function undoReceivedSnapshot(orderId, receivedSnapshot){
	      const snap = (receivedSnapshot && typeof receivedSnapshot === 'object') ? receivedSnapshot : {};
	      const lines = normalizeReceiptLines(snap.lines);
	      if(!lines.length) return { undone: [], skipped: [] };

	      const ids = lines.map(l => l.item_id);
	      const qtyMap = await sbFetchItemQtyMap(ids);
	      const undone = [];
	      const skipped = [];

	      for(const l of lines){
	        const current = qtyMap.get(l.item_id);
	        if(typeof current !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        if(current === l.prev_qty){
	          undone.push(l);
	          setLocalItemQty(l.item_id, l.prev_qty);
	          continue;
	        }
	        if(current !== l.next_qty){
	          skipped.push({ part: l.part, reason:'conflict' });
	          continue;
	        }
	        const ok = await sbUpdateItemQtyIfMatch(l.item_id, l.next_qty, l.prev_qty);
	        if(ok){
	          qtyMap.set(l.item_id, l.prev_qty);
	          undone.push(l);
	          setLocalItemQty(l.item_id, l.prev_qty);
	          continue;
	        }
	        const refreshed = await sbFetchItemQtyMap([l.item_id]);
	        const current2 = refreshed.get(l.item_id);
	        if(typeof current2 !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        qtyMap.set(l.item_id, current2);
	        if(current2 === l.prev_qty){
	          undone.push(l);
	          setLocalItemQty(l.item_id, l.prev_qty);
	          continue;
	        }
	        skipped.push({ part: l.part, reason:'conflict' });
	      }

	      const undoneAt = new Date().toISOString();
	      const patch = {
	        receiving_at: null,
	        receiving_by: null,
	        receiving_snapshot: null,
	        received_undone_at: undoneAt,
	        received_undone_by: SB.user ? SB.user.id : null,
	      };
	      await sbUpdateOrder(orderId, patch);
	      patchOrderHistoryRow(orderId, patch);
	      try{ setUpdated(); render(); }catch(e){}
	      try{ renderOrderHistoryFiltered(); }catch(e){}
	      return { undone, skipped };
	    }

	    function showOrderReceivingSetupHelp(){
	      const sql = "NOTIFY pgrst, 'reload schema';";
	      openMsgModal(
	        'Enable order receiving',
	        `Order receiving requires a Supabase schema update.\n\n`+
	          `Run the latest SUPABASE_SECURE_SETUP.sql in Supabase SQL Editor, then run:\n${sql}\n\n`+
	          `After that, refresh this page and tap Receive again.`,
	        sql
	      );
	    }

	    function setReceiveOrderMessage(msg){
	      const el = $('receiveOrderMsg'); if(!el) return;
	      el.textContent = String(msg || '');
	    }
	    function setReceiveOrderWarning(msg){
	      const el = $('receiveOrderWarning'); if(!el) return;
	      el.textContent = String(msg || '');
	    }
	    function shortId(value){
	      const id = String(value || '').trim();
	      return id ? id.slice(0, 8) : '';
	    }
	    function receiveLineOverBy(line){
	      const remainingRaw = line ? line.remaining_qty : null;
	      if(remainingRaw === null || typeof remainingRaw === 'undefined') return 0;
	      const remaining = Number(remainingRaw);
	      if(!Number.isFinite(remaining)) return 0;
	      const total = toInt(line && line.qty_received, 0) + toInt(line && line.qty_rejected, 0);
	      return total - remaining;
	    }
	    function receiveLineHasOverage(line){
	      return receiveLineOverBy(line) > 0;
	    }
	    function updateReceiveLineDom(line){
	      const key = String(line && line.key ? line.key : '').trim();
	      if(!key) return;
	      let selector = `[data-receive-line-key="${key}"]`;
	      try{
	        if(window.CSS && CSS.escape){
	          selector = `[data-receive-line-key="${CSS.escape(key)}"]`;
	        }
	      }catch(e){}
	      const row = document.querySelector(`.receive-line${selector}`);
	      if(!row) return;
	      const warningEl = row.querySelector('[data-receive-line-warning]');
	      const overBy = receiveLineOverBy(line);
	      if(overBy > 0){
	        row.classList.add('over');
	        if(warningEl) warningEl.textContent = `âš  Over by ${formatQty(overBy)}`;
	      }else{
	        row.classList.remove('over');
	        if(warningEl) warningEl.textContent = '';
	      }
	      // Update stepper dec button disabled states
	      const receivedVal = toInt(line.qty_received, 0);
	      const rejectedVal = toInt(line.qty_rejected, 0);
	      const receivedDecBtn = row.querySelector(`[data-receive-stepper="dec"][data-receive-field="received"]`);
	      const rejectedDecBtn = row.querySelector(`[data-receive-stepper="dec"][data-receive-field="rejected"]`);
	      if(receivedDecBtn) receivedDecBtn.disabled = receivedVal <= 0 || row.classList.contains('disabled');
	      if(rejectedDecBtn) rejectedDecBtn.disabled = rejectedVal <= 0 || row.classList.contains('disabled');
	      // Update reason input disabled state
	      const reasonInput = row.querySelector('.receive-line-reason-input');
	      if(reasonInput){
	        const shouldDisable = rejectedVal === 0 || row.classList.contains('disabled');
	        reasonInput.disabled = shouldDisable;
	        if(shouldDisable && reasonInput.value){
	          reasonInput.value = '';
	          // Also update the line data
	          if(line) line.rejection_reason = '';
	        }
	      }
	    }
	    function getReceiveOrderLineByKey(key){
	      const ro = state._receiveOrder;
	      if(!ro || !Array.isArray(ro.lines)) return null;
	      const id = String(key || '').trim();
	      if(!id) return null;
	      return ro.lines.find(l => String(l && l.key ? l.key : '').trim() === id) || null;
	    }
	    function updateReceiveLineFromInput(input, opts = {}){
	      const el = input;
	      if(!el) return null;
	      const key = String(el.dataset.receiveLineKey || '').trim();
	      const field = String(el.dataset.receiveField || '').trim();
	      if(!key || (field !== 'received' && field !== 'rejected' && field !== 'reason')) return null;
	      const line = getReceiveOrderLineByKey(key);
	      if(!line || line.disabled) return null;
	      if(field === 'reason'){
	        line.rejection_reason = String(el.value || '').trim();
	        return line;
	      }
	      const raw = String(el.value || '');
	      const numeric = Number(raw);
	      const invalid = raw !== '' && (!Number.isFinite(numeric) || !Number.isInteger(numeric));
	      const negative = Number.isFinite(numeric) && numeric < 0;
	      let next = Number.isFinite(numeric) ? Math.floor(numeric) : 0;
	      if(next < 0) next = 0;
	      if(field === 'received') line.qty_received = next;
	      else line.qty_rejected = next;
	      if(opts.format){
	        el.value = String(next);
	      }
	      if(opts.showError){
	        const msgEl = $('receiveOrderMsg');
	        if(negative){
	          setReceiveOrderMessage('Quantities must be 0 or higher.');
	        }else if(invalid){
	          setReceiveOrderMessage('Enter a whole number.');
	        }else if(msgEl){
	          const existing = String(msgEl.textContent || '').trim();
	          if(existing === 'Quantities must be 0 or higher.' || existing === 'Enter a whole number.'){
	            setReceiveOrderMessage('');
	          }
	        }
	      }
	      updateReceiveLineDom(line);
	      updateReceiveOrderWarning();
	      return line;
	    }
	    function updateReceiveOrderWarning(){
	      const ro = state._receiveOrder;
	      if(!ro){
	        setReceiveOrderWarning('');
	        return;
	      }
        const warnings = [];
        const receiptStatus = String(ro.receiptStatus || '').trim().toLowerCase();
        const draftLike = isReceiptDraftLike(receiptStatus);
        if(ro.possibleDuplicate && draftLike){
          warnings.push('This receipt looks similar to another one. Please review carefully.');
        }
	      if(String(ro.mode || '') === 'order' && draftLike){
	        const overCount = ro.lines.filter(l => !l.disabled && receiveLineHasOverage(l)).length;
          if(overCount){
            warnings.push(`${overCount} line${overCount === 1 ? '' : 's'} exceed remaining quantities. Over-receipt is allowed but will be flagged.`);
          }
	      }
	      setReceiveOrderWarning(warnings.join(' '));
	    }
	    function computeReceiveTotals(lines){
	      const totals = { ordered:0, received:0, remaining:0 };
	      for(const line of lines){
	        totals.ordered += Number(line.ordered_qty || 0);
	        totals.received += Number(line.prev_received || 0);
	        totals.remaining += Number(line.remaining_qty || 0);
	      }
	      return totals;
	    }
	    async function sbFetchPurchaseOrderById(poId){
	      const id = String(poId || '').trim();
	      if(!id) throw new Error('Invalid purchase order');
	      let columns = PURCHASE_ORDER_BASE_COLUMNS.slice();
	      let attemptedMinimal = false;
	      let lastError = null;
	      for(let attempt = 0; attempt < 6; attempt++){
	        columns = normalizePurchaseOrderColumns(columns);
	        const { data, error } = await SB.client
	          .from('purchase_orders')
	          .select(buildPurchaseOrderSelect(columns))
	          .eq('id', id)
	          .single();
	        if(!error) return normalizePurchaseOrderRow(data);
	        const dropResult = dropMissingPurchaseOrderColumns(columns, error);
	        if(dropResult.changed){
	          columns = dropResult.columns;
	          continue;
	        }
	        if(!attemptedMinimal){
	          attemptedMinimal = true;
	          columns = PURCHASE_ORDER_MIN_COLUMNS.slice();
	          continue;
	        }
	        if(!shouldRetryOrderSelect(error)) throw error;
	        lastError = error;
	        break;
	      }
	      if(lastError) throw lastError;
	      throw new Error('Failed to fetch purchase order');
	    }
	    async function sbFetchReceiptDataForPo(poId){
	      const id = String(poId || '').trim();
	      if(!id) return { receipts: [], receiptLines: [] };
	      const { data: receipts, error } = await SB.client
	        .from('receipts')
	        .select('id,status,created_at,updated_at,submitted_at,received_at,voided_at,notes,received_by,submitted_by,voided_by,possible_duplicate')
	        .eq('purchase_order_id', id)
	        .order('created_at', { ascending:false });
	      if(error) throw error;
	      const receiptIds = (receipts || []).map(r => r && r.id).filter(Boolean);
	      if(!receiptIds.length){
	        return { receipts: Array.isArray(receipts) ? receipts : [], receiptLines: [] };
	      }
	      const { data: lines, error: lineError } = await SB.client
	        .from('receipt_lines')
	        .select('id,receipt_id,item_id,po_line_id,expected_qty,received_qty,rejected_qty,rejection_reason,created_at,updated_at')
	        .in('receipt_id', receiptIds);
	      if(lineError) throw lineError;
	      return {
	        receipts: Array.isArray(receipts) ? receipts : [],
	        receiptLines: Array.isArray(lines) ? lines : [],
	      };
	    }
	    function buildReceiveOrderState(po, poLines, receipts, receiptLines, opts = {}){
	      const normalizedLines = normalizePurchaseOrderLines(poLines || []);
	      const lineByItemId = new Map();
	      normalizedLines.forEach(line => {
	        if(line.item_id) lineByItemId.set(line.item_id, line);
	      });

	      const normalizedReceiptLines = (Array.isArray(receiptLines) ? receiptLines : []).map((line) => ({
	        id: String(line && line.id ? line.id : '').trim(),
	        receipt_id: String(line && line.receipt_id ? line.receipt_id : '').trim(),
	        item_id: String(line && line.item_id ? line.item_id : '').trim(),
	        po_line_id: String(line && line.po_line_id ? line.po_line_id : '').trim(),
	        expected_qty: (line && line.expected_qty !== undefined && line.expected_qty !== null) ? toInt(line.expected_qty, 0) : null,
	        received_qty: toInt(line && line.received_qty, 0),
	        rejected_qty: toInt(line && line.rejected_qty, 0),
	        rejection_reason: String(line && line.rejection_reason ? line.rejection_reason : '').trim(),
	        created_at: line && line.created_at ? line.created_at : null,
	        updated_at: line && line.updated_at ? line.updated_at : null,
	      }));

	      const preferredId = String(opts.receiptId || '').trim();
	      let activeReceipt = null;
	      if(preferredId){
	        activeReceipt = (receipts || []).find(r => String(r && r.id ? r.id : '').trim() === preferredId) || null;
	      }
	      if(!activeReceipt){
	        const draftReceipts = (receipts || []).filter(r => String(r && r.status ? r.status : '').trim() === 'draft');
	        activeReceipt = draftReceipts
	          .slice()
	          .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0))[0] || null;
	      }
	      const activeReceiptId = activeReceipt && activeReceipt.id ? String(activeReceipt.id) : preferredId;
	      const receiptStatus = normalizeReceiptStatus(
	        activeReceipt && activeReceipt.status ? String(activeReceipt.status).trim() : (opts.receiptStatus || 'draft')
	      );
	      const receiptNotes = activeReceipt && typeof activeReceipt.notes !== 'undefined'
	        ? String(activeReceipt.notes || '')
	        : String(opts.receiptNotes || '');
        const possibleDuplicate = activeReceipt && typeof activeReceipt.possible_duplicate !== 'undefined'
          ? !!activeReceipt.possible_duplicate
          : !!(opts && opts.possibleDuplicate);

	      const activeLineMap = new Map();
	      if(activeReceiptId){
	        normalizedReceiptLines
	          .filter(l => l.receipt_id === activeReceiptId)
	          .forEach(l => {
	            if(l.po_line_id) activeLineMap.set(`po:${l.po_line_id}`, l);
	            if(l.item_id) activeLineMap.set(`item:${l.item_id}`, l);
	          });
	      }

	      const completedReceiptIds = new Set(
	        (receipts || [])
	          .filter(r => normalizeReceiptStatus(String(r && r.status ? r.status : '')) === 'received')
	          .map(r => String(r && r.id ? r.id : '').trim())
	          .filter(Boolean)
	      );
	      const receivedByItem = new Map();
	      for(const line of normalizedReceiptLines){
	        if(!completedReceiptIds.has(line.receipt_id)) continue;
	        if(!line.item_id) continue;
	        const prev = receivedByItem.get(line.item_id) || 0;
	        receivedByItem.set(line.item_id, prev + toInt(line.received_qty, 0));
	      }

	      const lines = normalizedLines.map((line, idx) => {
	        const key = line.id || line.item_id || `line-${idx}`;
	        const ordered = toInt(line.quantity_ordered, 0);
	        const prevReceived = receivedByItem.get(line.item_id) || 0;
	        const remaining = Math.max(0, ordered - prevReceived);
	        const mapKey = line.id ? `po:${line.id}` : (line.item_id ? `item:${line.item_id}` : '');
	        const draftLine = mapKey ? activeLineMap.get(mapKey) : null;
	        const qtyReceived = draftLine ? toInt(draftLine.received_qty, 0) : 0;
	        const qtyRejected = draftLine ? toInt(draftLine.rejected_qty, 0) : 0;
	        const rejectionReason = draftLine ? String(draftLine.rejection_reason || '').trim() : '';
	        return {
	          ...line,
	          key,
	          ordered_qty: ordered,
	          expected_qty: ordered,
	          prev_received: prevReceived,
	          remaining_qty: remaining,
	          qty_received: qtyReceived,
	          qty_rejected: qtyRejected,
	          rejection_reason: rejectionReason,
	          receipt_line_id: draftLine ? String(draftLine.id || '').trim() : '',
	          po_line_id: line.id || '',
	          unit_cost: line.unit_cost !== undefined ? line.unit_cost : null,
	          disabled: !line.item_id,
	        };
	      });

	      const receiptLinesByReceipt = new Map();
	      for(const line of normalizedReceiptLines){
	        const receiptId = String(line.receipt_id || '').trim();
	        if(!receiptId) continue;
	        if(!receiptLinesByReceipt.has(receiptId)) receiptLinesByReceipt.set(receiptId, []);
	        const poLine = lineByItemId.get(line.item_id);
	        receiptLinesByReceipt.get(receiptId).push({
	          ...line,
	          item_name: poLine ? poLine.item_name : '',
	          item_sku: poLine ? poLine.item_sku : '',
	        });
	      }

	      return {
	        po,
	        lines,
	        receipts: Array.isArray(receipts) ? receipts : [],
	        receiptLines: normalizedReceiptLines,
	        receiptLinesByReceipt,
	        receiptId: activeReceiptId,
	        receiptStatus,
	        receiptNotes,
          possibleDuplicate,
	        mode: opts && opts.mode ? opts.mode : 'order',
	      };
	    }
      function getReceiptForwardingDomain(){
        const rawSettings = SB.company && (SB.company.settings || SB.company.company_settings);
        const companySettings = (rawSettings && typeof rawSettings === 'object' && !Array.isArray(rawSettings))
          ? rawSettings
          : null;
        const settingsDomain = (companySettings && typeof companySettings.receipt_forward_domain === 'string')
          ? companySettings.receipt_forward_domain.trim()
          : '';
        const settingsLegacy = (companySettings && typeof companySettings.receipt_forwarding_domain === 'string')
          ? companySettings.receipt_forwarding_domain.trim()
          : '';
        const primary = (typeof window.INBOUND_RECEIPT_DOMAIN === 'string') ? window.INBOUND_RECEIPT_DOMAIN.trim() : '';
        const legacy = (typeof window.RECEIPT_FORWARD_DOMAIN === 'string') ? window.RECEIPT_FORWARD_DOMAIN.trim() : '';
        return settingsDomain || settingsLegacy || primary || legacy || 'inbound.inventorymanager.modulus-software.com';
      }
      function getReceiptForwardingAddress(){
        const slug = String((SB.company && (SB.company.slug || SB.company.company_slug)) || '').trim();
        const domain = getReceiptForwardingDomain();
        return slug ? `receipts+${slug}@${domain}` : `receipts+<company_slug>@${domain}`;
      }
      function normalizeReceiptStatus(status){
        const s = String(status || '').trim().toLowerCase();
        if(s === 'completed') return 'received';
        return s;
      }
      function isReceiptDeleteSafeStatus(status){
        const s = normalizeReceiptStatus(status);
        return s === 'draft' || s === 'blocked_by_plan' || s === 'voided';
      }
      function canReceiptDelete(){
        if(!SB.session || !SB.authorized) return false;
        if(isEffectiveSuperUser()) return true;
        return getEffectiveRole() === 'admin';
      }
      function canDeleteReceiptRow(status){
        if(!canReceiptDelete()) return false;
        if(isEffectiveSuperUser()) return true;
        return isReceiptDeleteSafeStatus(status);
      }
      function formatReceiptStatusLabel(status){
        const normalized = normalizeReceiptStatus(status);
        if(!normalized) return '';
        if(normalized === 'received') return 'Received';
        return formatStateToken(normalized);
      }
      function isReceiptDraftLike(status){
        const s = String(status || '').trim().toLowerCase();
        return s === 'draft' || s === 'blocked_by_plan';
      }
      function isReceiptPlanBlocked(status){
        return String(status || '').trim().toLowerCase() === 'blocked_by_plan' && !hasTier('professional');
      }
      const RECEIVE_TABS = ['quick', 'scanned', 'po'];
      function getReceiveActiveTab(receiveState){
        const ro = receiveState || state._receiveOrder;
        const tab = ro && typeof ro.tab === 'string' ? ro.tab : '';
        if(tab && RECEIVE_TABS.includes(tab)) return tab;
        const mode = ro ? String(ro.mode || '') : '';
        if(mode === 'order') return 'po';
        if(mode === 'inbox') return 'scanned';
        return 'quick';
      }
      function updateReceiveTabBadge(){
        const badge = $('receiveTabScannedCount');
        if(!badge) return;
        const count = toInt(state._draftEmailReceiptsCount, 0);
        badge.textContent = String(count);
        badge.style.display = count > 0 ? 'inline-flex' : 'none';
      }
      function applyReceiveTabState(tab){
        const root = $('receiveOrderModal');
        if(!root) return;
        root.querySelectorAll('[data-receive-tab]').forEach(btn=>{
          const active = String(btn.dataset.receiveTab || '') === tab;
          btn.classList.toggle('active', active);
          btn.setAttribute('aria-selected', active ? 'true' : 'false');
        });
        root.querySelectorAll('[data-receive-panel]').forEach(panel=>{
          const active = String(panel.dataset.receivePanel || '') === tab;
          panel.classList.toggle('is-active', active);
        });
      }
      async function handleReceiveTabClick(tab){
        const next = String(tab || '').trim();
        if(!next) return;
        const current = getReceiveActiveTab(state._receiveOrder);
        if(next === current) return;
        if(next === 'quick'){
          await openReceiveManualModal();
          return;
        }
        if(next === 'scanned'){
          await openReceiveInboxModal();
          return;
        }
        if(next === 'po'){
          if(state._receiveOrder) state._receiveOrder.tab = 'po';
          renderReceiveOrderModal();
        }
      }
      function getReceiveForwardingHintKey(){
        const companyId = SB.companyId ? String(SB.companyId) : 'unknown';
        return `inv.receive.forwarding_hint.${companyId}`;
      }
      function isReceiveForwardingHintDismissed(){
        try{
          return localStorage.getItem(getReceiveForwardingHintKey()) === '1';
        }catch(e){
          return false;
        }
      }
      function dismissReceiveForwardingHint(){
        try{
          localStorage.setItem(getReceiveForwardingHintKey(), '1');
        }catch(e){}
      }
      function formatReceiptMoney(value){
        const num = Number(value);
        if(!Number.isFinite(num)) return 'â€”';
        return `$${num.toFixed(2)}`;
      }
      function formatReceiptSourceLabel(source){
        const raw = String(source || '').toLowerCase();
        if(!raw) return '';
        if(raw.includes('pdf')) return 'PDF';
        if(raw.includes('image')) return 'Image';
        if(raw.includes('email')) return 'Email';
        return 'Receipt';
      }
      function formatReceiptInputValue(value){
        const num = Number(value);
        if(!Number.isFinite(num)) return '';
        return String(num);
      }
      function parseReceiptNumber(value){
        const raw = String(value ?? '').trim();
        if(!raw) return null;
        const num = Number(raw);
        if(!Number.isFinite(num)) return null;
        return num;
      }
      function formatReceiptAttachmentSize(bytes){
        const size = Number(bytes);
        if(!Number.isFinite(size) || size <= 0) return 'â€”';
        if(size < 1024) return `${size} B`;
        if(size < 1024 * 1024) return `${(size / 1024).toFixed(1)} KB`;
        return `${(size / (1024 * 1024)).toFixed(1)} MB`;
      }
      function formatReceiptAttachmentType(contentType){
        const raw = String(contentType || '').toLowerCase();
        if(!raw) return 'File';
        if(raw.includes('pdf')) return 'PDF';
        if(raw.startsWith('image/')) return 'Image';
        if(raw.startsWith('text/')) return 'Text';
        const part = raw.split('/').pop() || '';
        return part ? part.toUpperCase() : 'File';
      }
      function canReceiptAttachmentStorage(){
        return hasTier('professional');
      }
      function getReceiptsApiUrl(){
        const override = (typeof window.RECEIPTS_API_URL === 'string') ? window.RECEIPTS_API_URL.trim() : '';
        if(override) return override;
        const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
        if(sbUrl) return `${sbUrl}/functions/v1/api`;
        return '/functions/v1/api';
      }
      function buildReceiptsApiHeaders(apiUrl){
        const headers = {};
        const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
        const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
        if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
          headers.apikey = sbKey;
          if(SB.session && SB.session.access_token){
            headers.Authorization = `Bearer ${SB.session.access_token}`;
          }
        }
        return headers;
      }
      async function sbFetchReceiptAttachments(receiptId){
        if(!SB.ready || !SB.session || !SB.authorized) throw new Error('Not authorized');
        const id = String(receiptId || '').trim();
        if(!id) return [];
        const apiUrl = getReceiptsApiUrl();
        const headers = buildReceiptsApiHeaders(apiUrl);
        const res = await fetch(`${apiUrl}/v1/receipts/${id}/attachments`, { headers });
        const payload = await res.json().catch(() => ({}));
        if(!res.ok){
          const msg = payload?.error?.message || payload?.error || 'Failed to load attachments';
          throw new Error(msg);
        }
        return Array.isArray(payload?.data) ? payload.data : [];
      }
      async function sbFetchReceiptAttachmentDownloadUrl(receiptId, attachmentId){
        if(!SB.ready || !SB.session || !SB.authorized) throw new Error('Not authorized');
        const rid = String(receiptId || '').trim();
        const aid = String(attachmentId || '').trim();
        if(!rid || !aid) throw new Error('Attachment required');
        const apiUrl = getReceiptsApiUrl();
        const headers = buildReceiptsApiHeaders(apiUrl);
        const res = await fetch(`${apiUrl}/v1/receipts/${rid}/attachments/${aid}/download`, { headers });
        const payload = await res.json().catch(() => ({}));
        if(!res.ok){
          const msg = payload?.error?.message || payload?.error || 'Download failed';
          throw new Error(msg);
        }
        const url = payload?.data?.url ? String(payload.data.url) : '';
        if(!url) throw new Error('Download unavailable');
        return url;
      }
      async function sbDeleteReceiptAttachment(receiptId, attachmentId){
        if(!SB.ready || !SB.session || !SB.authorized) throw new Error('Not authorized');
        const rid = String(receiptId || '').trim();
        const aid = String(attachmentId || '').trim();
        if(!rid || !aid) throw new Error('Attachment required');
        const apiUrl = getReceiptsApiUrl();
        const headers = buildReceiptsApiHeaders(apiUrl);
        const res = await fetch(`${apiUrl}/v1/receipts/${rid}/attachments/${aid}`, {
          method: 'DELETE',
          headers,
        });
        if(!res.ok){
          const payload = await res.json().catch(() => ({}));
          const msg = payload?.error?.message || payload?.error || 'Delete failed';
          throw new Error(msg);
        }
        return true;
      }
      function normalizeParsedLineItems(raw){
        if(!Array.isArray(raw)) return [];
        return raw.map(item => ({
          description: String(item && item.description ? item.description : '').trim(),
          sku: item && item.sku ? String(item.sku).trim() : null,
          qty: parseReceiptNumber(item && item.qty),
          unit_price: parseReceiptNumber(item && item.unit_price),
          line_total: parseReceiptNumber(item && item.line_total),
          item_id: item && item.item_id ? String(item.item_id).trim() : null,
          qty_received: item && typeof item.qty_received !== 'undefined' ? parseReceiptNumber(item.qty_received) : null,
          rejection_reason: item && item.rejection_reason ? String(item.rejection_reason).trim() : null,
        })).slice(0, 200);
      }
      function sanitizeParsedLineItems(lines){
        if(!Array.isArray(lines)) return null;
        const cleaned = lines.map(item => ({
          description: String(item && item.description ? item.description : '').trim(),
          sku: item && item.sku ? String(item.sku).trim() : null,
          qty: parseReceiptNumber(item && item.qty),
          unit_price: parseReceiptNumber(item && item.unit_price),
          line_total: parseReceiptNumber(item && item.line_total),
          item_id: item && item.item_id ? String(item.item_id).trim() : null,
          qty_received: item && typeof item.qty_received !== 'undefined' ? parseReceiptNumber(item.qty_received) : null,
          rejection_reason: item && item.rejection_reason ? String(item.rejection_reason).trim() : null,
        })).filter(item => item.description || item.sku || item.qty !== null || item.unit_price !== null || item.line_total !== null);
        return cleaned.length ? cleaned : null;
      }
      function getParsedLineTotal(line){
        const qty = parseReceiptNumber(line && line.qty);
        const unit = parseReceiptNumber(line && line.unit_price);
        if(qty !== null && unit !== null) return qty * unit;
        const existing = parseReceiptNumber(line && line.line_total);
        return existing !== null ? existing : null;
      }
      async function sbFetchDraftEmailReceipts(){
        if(!SB.ready || !SB.session || !SB.authorized) return { rows: [], count: 0 };
        const query = SB.client
          .from('receipts_with_company')
          .select('receipt_id,company_id,company_name,company_slug,vendor_name,receipt_date,total,receipt_source,status,created_at', { count: 'exact' })
          .in('status', ['draft','blocked_by_plan'])
          .order('created_at', { ascending: false })
          .limit(60);
        if(!isEffectiveSuperUser()){
          if(!SB.companyId) return { rows: [], count: 0 };
          query.eq('company_id', SB.companyId);
        }
        const { data, error, count } = await query;
        if(error) throw error;
        const rows = Array.isArray(data)
          ? data.map(row => ({
              id: row.receipt_id,
              receipt_id: row.receipt_id,
              company_id: row.company_id,
              company_name: row.company_name,
              company_slug: row.company_slug,
              vendor_name: row.vendor_name,
              receipt_date: row.receipt_date,
              total: row.total,
              receipt_source: row.receipt_source,
              status: row.status,
              created_at: row.created_at,
          }))
          : [];
        return { rows, count: Number.isFinite(count) ? count : rows.length };
      }
      function syncReceiveDraftSelection(rows){
        if(!canReceiptDelete()){
          state._receiveDraftSelected = new Set();
          return;
        }
        const selected = state._receiveDraftSelected;
        if(!selected || typeof selected.has !== 'function'){
          state._receiveDraftSelected = new Set();
          return;
        }
        const validIds = new Set();
        (rows || []).forEach(r => {
          const id = String((r && (r.id || r.receipt_id)) || '').trim();
          if(!id) return;
          if(!canDeleteReceiptRow(r && r.status)) return;
          validIds.add(id);
        });
        selected.forEach(id => {
          if(!validIds.has(id)) selected.delete(id);
        });
      }
      function renderReceiveDraftBatchBar(rows){
        const bar = $('receiveDraftBatchBar');
        if(!bar) return;
        if(!canReceiptDelete() || !(rows && rows.length)){
          bar.style.display = 'none';
          return;
        }
        bar.style.display = '';
        const selected = state._receiveDraftSelected || new Set();
        const selectableIds = [];
        (rows || []).forEach(r => {
          const id = String((r && (r.id || r.receipt_id)) || '').trim();
          if(!id) return;
          if(!canDeleteReceiptRow(r && r.status)) return;
          selectableIds.push(id);
        });
        const selectedVisible = selectableIds.filter(id => selected.has(id));

        const countEl = $('receiveDraftSelectedCount');
        if(countEl) countEl.textContent = `${selectedVisible.length} selected`;

        const selectAll = $('receiveDraftSelectAll');
        if(selectAll){
          selectAll.disabled = selectableIds.length === 0;
          selectAll.checked = selectableIds.length > 0 && selectedVisible.length === selectableIds.length;
          selectAll.indeterminate = selectedVisible.length > 0 && selectedVisible.length < selectableIds.length;
        }

        const deleteBtn = $('btnReceiveDraftDelete');
        if(deleteBtn) deleteBtn.disabled = selectedVisible.length === 0;
      }
      function setReceiveDraftSelected(id, isSelected){
        const receiptId = String(id || '').trim();
        if(!receiptId) return;
        const selected = state._receiveDraftSelected || new Set();
        if(isSelected) selected.add(receiptId);
        else selected.delete(receiptId);
        state._receiveDraftSelected = selected;
      }
      function renderReceiveDraftInbox(){
        const wrap = $('receiveDraftInbox');
        if(!wrap) return;
        const ro = state._receiveOrder;
        const drafts = Array.isArray(state._draftEmailReceipts) ? state._draftEmailReceipts : [];
        const isInboxMode = !!(ro && ro.mode === 'inbox');
        syncReceiveDraftSelection(drafts);
        const allowDelete = canReceiptDelete();
        const selected = allowDelete ? (state._receiveDraftSelected || new Set()) : new Set();
        if(!drafts.length && !isInboxMode){
          wrap.style.display = 'none';
          wrap.innerHTML = '';
          return;
        }
        const count = Number.isFinite(state._draftEmailReceiptsCount)
          ? state._draftEmailReceiptsCount
          : drafts.length;
        const countLabel = count === 1 ? '1 receipt' : `${count} receipts`;
        wrap.style.display = '';
        wrap.innerHTML =
          `<div class="receive-draft-inbox-header">`+
            `<div>`+
              `<div class="receive-draft-inbox-title">Receipts inbox</div>`+
              `<div class="receive-draft-inbox-subtitle">Review before inventory is updated. Receipts are never received automatically.</div>`+
            `</div>`+
            `<div class="receive-draft-inbox-count">${escapeHtml(countLabel)}</div>`+
          `</div>`+
          `<div class="receive-draft-batch-bar" id="receiveDraftBatchBar" style="display:none;">`+
            `<div class="receive-draft-batch-actions">`+
              `<label class="receive-draft-select-all">`+
                `<input type="checkbox" id="receiveDraftSelectAll" aria-label="Select all receipts" />`+
                `<span>Select all</span>`+
              `</label>`+
              `<span class="receive-draft-batch-count" id="receiveDraftSelectedCount">0 selected</span>`+
              `<button class="btn-tertiary btn-sm btn-danger" id="btnReceiveDraftDelete" type="button" disabled>Delete selected</button>`+
            `</div>`+
          `</div>`+
          `<div class="scanned-queue">`+
            (drafts.length ? drafts.map(row => {
              const vendor = String(row.vendor_name || '').trim() || 'Unknown vendor';
              const companyName = String(row.company_name || row.company_slug || row.company_id || '').trim() || 'Unknown company';
              const dateText = row.receipt_date ? formatDateShort(row.receipt_date) : (row.created_at ? formatDateShort(row.created_at) : '');
              const totalText = formatReceiptMoney(row.total);
              const totalLabel = totalText && totalText !== 'â€”' ? `Total ${totalText}` : '';
              const status = String(row.status || '').trim().toLowerCase();
              const statusKey = status === 'blocked_by_plan' ? 'blocked_by_plan' : 'draft';
              const statusLabel = statusKey === 'blocked_by_plan' ? 'Upgrade required' : 'Needs review';
              const statusClass = statusKey === 'blocked_by_plan' ? 'queue-item-tag--blocked' : 'queue-item-tag--needs';
              const sourceLabel = formatReceiptSourceLabel(row.receipt_source) || 'Email';
              const receiptId = String(row.id || '').trim();
              const companyId = String(row.company_id || '').trim();
              const isActive = ro && String(ro.receiptId || '').trim() === receiptId;
              const canSelect = allowDelete && canDeleteReceiptRow(row && row.status);
              const isSelected = selected.has(receiptId);
              const selectHtml = allowDelete
                ? `<label class="receive-draft-select${canSelect ? '' : ' is-disabled'}">`+
                    `<input type="checkbox" data-receipt-select="${escapeHtmlAttr(receiptId)}" aria-label="Select receipt"${isSelected ? ' checked' : ''}${canSelect ? '' : ' disabled'} />`+
                  `</label>`
                : '';
              return (
                `<div class="queue-item${isActive ? ' active' : ''}${isSelected ? ' is-selected' : ''}" data-receipt-review-id="${escapeHtmlAttr(receiptId)}" data-receipt-company-id="${escapeHtmlAttr(companyId)}">`+
                  `${selectHtml}`+
                  `<div class="queue-item-icon">`+
                    `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
                      `<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>`+
                      `<polyline points="14 2 14 8 20 8"></polyline>`+
                      `<line x1="16" y1="13" x2="8" y2="13"></line>`+
                      `<line x1="16" y1="17" x2="8" y2="17"></line>`+
                    `</svg>`+
                  `</div>`+
                  `<div class="queue-item-info">`+
                    `<div class="queue-item-title">${escapeHtml(vendor)}</div>`+
                    `<div class="queue-item-meta">`+
                      `${companyName ? `<span>${escapeHtml(companyName)}</span>` : ''}`+
                      `${dateText ? `<span>${escapeHtml(dateText)}</span>` : ''}`+
                      `${totalLabel ? `<span>${escapeHtml(totalLabel)}</span>` : ''}`+
                      `<span class="queue-item-tag ${statusClass}">${escapeHtml(statusLabel)}</span>`+
                      `${sourceLabel ? `<span class="queue-item-tag queue-item-tag--source">${escapeHtml(sourceLabel)}</span>` : ''}`+
                    `</div>`+
                  `</div>`+
                  `<span class="queue-item-arrow">`+
                    `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
                      `<polyline points="9 18 15 12 9 6"></polyline>`+
                    `</svg>`+
                  `</span>`+
                `</div>`
              );
            }).join('') : (
              `<div class="queue-empty">`+
                `<div class="queue-empty-title">No receipts waiting</div>`+
                `<div class="queue-empty-text">Forward receipts to create drafts for review.</div>`+
              `</div>`
            )) +
          `</div>`;
        renderReceiveDraftBatchBar(drafts);
      }
      async function loadDraftEmailReceipts(){
        try{
          const result = await sbFetchDraftEmailReceipts();
          const rows = result && Array.isArray(result.rows) ? result.rows : [];
          state._draftEmailReceipts = rows;
          state._draftEmailReceiptsCount = Number.isFinite(result && result.count) ? result.count : rows.length;
          state._draftEmailReceiptsLoaded = true;
          renderReceiveDraftInbox();
          updateReceiveTabBadge();
          renderReceiptsInboxIndicator();
          if(!state._draftEmailReceiptsNotified && rows.length){
            toast('New receipt received â€” ready for review.');
            state._draftEmailReceiptsNotified = true;
          }
        }catch(e){
          state._draftEmailReceipts = [];
          state._draftEmailReceiptsCount = 0;
          state._draftEmailReceiptsLoaded = true;
          renderReceiveDraftInbox();
          updateReceiveTabBadge();
          renderReceiptsInboxIndicator();
        }
      }
      async function deleteSelectedDraftReceipts(){
        if(!canReceiptDelete()){
          toast('Admin access required');
          return;
        }
        const rows = Array.isArray(state._draftEmailReceipts) ? state._draftEmailReceipts : [];
        const selected = state._receiveDraftSelected || new Set();
        const selectedRows = rows.filter(r => selected.has(String((r && (r.id || r.receipt_id)) || '').trim()));
        if(!selectedRows.length){
          toast('Select receipts to delete');
          return;
        }
        const requiresForce = selectedRows.some(r => !isReceiptDeleteSafeStatus(r && r.status));
        if(requiresForce && !isEffectiveSuperUser()){
          toast('Only super users can delete received or pending receipts');
          return;
        }
        const count = selectedRows.length;
        const title = requiresForce ? 'Delete receipts permanently?' : 'Delete receipts?';
        const message = requiresForce
          ? `This will permanently delete ${count} receipt${count === 1 ? '' : 's'}, including received or pending receipts. This can break inventory history and audit trails. Continue?`
          : `Delete ${count} receipt${count === 1 ? '' : 's'}?`;
        const ok = await openConfirmModal(title, message, {
          okText: requiresForce ? 'Delete Permanently' : 'Delete',
          cancelText: 'Cancel',
          okClass: 'btn-danger'
        });
        if(!ok) return;

        const btn = $('btnReceiveDraftDelete');
        const prior = btn ? btn.textContent : '';
        if(btn){ btn.disabled = true; btn.textContent = 'Deletingâ€¦'; }
        try{
          const ids = selectedRows
            .map(r => String((r && (r.id || r.receipt_id)) || '').trim())
            .filter(Boolean);
          const result = await sbDeleteReceipts(ids, requiresForce);
          state._receiveDraftSelected = new Set();
          const activeId = state._receiveOrder && state._receiveOrder.receiptId
            ? String(state._receiveOrder.receiptId).trim()
            : '';
          if(activeId && ids.includes(activeId)){
            await openReceiveInboxModal();
          }else{
            await loadDraftEmailReceipts();
          }
          const deletedCount = result && typeof result === 'object' && Number.isFinite(result.deleted_receipts)
            ? result.deleted_receipts
            : ids.length;
          const missingCount = result && typeof result === 'object' && Number.isFinite(result.missing)
            ? result.missing
            : 0;
          const msg = missingCount > 0
            ? `Deleted ${deletedCount} receipt${deletedCount === 1 ? '' : 's'} (${missingCount} missing)`
            : `Deleted ${deletedCount} receipt${deletedCount === 1 ? '' : 's'}`;
          toast(msg);
        }catch(e){
          toast((e && e.message) ? e.message : 'Delete failed');
        }finally{
          if(btn){
            btn.disabled = false;
            btn.textContent = prior || 'Delete selected';
          }
        }
      }
      async function loadReceiptAttachments(receiptId){
        const ro = state._receiveOrder;
        const id = String(receiptId || '').trim();
        if(!ro || !id) return;
        if(ro.attachmentsLoading) return;
        if(ro._attachmentsLoadedFor === id && ro._attachmentsLoaded) return;
        ro._attachmentsLoadedFor = id;
        ro._attachmentsLoaded = false;
        ro.attachmentsLoading = true;
        ro.attachmentsError = '';
        renderReceiveOrderModal();
        if(!canReceiptAttachmentStorage()){
          ro.attachments = [];
          ro.attachmentsLoading = false;
          ro._attachmentsLoaded = true;
          renderReceiveOrderModal();
          return;
        }
        try{
          const rows = await sbFetchReceiptAttachments(id);
          ro.attachments = Array.isArray(rows) ? rows : [];
          ro.attachmentsError = '';
          ro._attachmentsLoaded = true;
        }catch(e){
          ro.attachments = [];
          ro.attachmentsError = e && e.message ? e.message : 'Failed to load attachments';
          ro._attachmentsLoaded = false;
        }finally{
          ro.attachmentsLoading = false;
          renderReceiveOrderModal();
        }
      }
      function renderReceiptsInboxIndicator(){
        if(!canAccessReceivingInbox()){
          applyMenuActionCounts({ receiving: { receipts: 0, pending: 0 } }, { merge: true });
          return;
        }
        if(isEffectiveSuperUser()){
          scheduleMenuActionBadgeRefresh({ force: true });
          return;
        }
        if(!state._draftEmailReceiptsLoaded) return;
        const count = toInt(state._draftEmailReceiptsCount, 0);
        applyMenuActionCounts({ receiving: { receipts: count } }, { merge: true });
      }
      async function handleReceiptAttachmentDownload(attachmentId){
        const ro = state._receiveOrder;
        const receiptId = ro && ro.receiptId ? String(ro.receiptId).trim() : '';
        const id = String(attachmentId || '').trim();
        if(!receiptId || !id) return;
        try{
          const url = await sbFetchReceiptAttachmentDownloadUrl(receiptId, id);
          const link = document.createElement('a');
          link.href = url;
          link.target = '_blank';
          link.rel = 'noopener';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }catch(e){
          toast(e && e.message ? e.message : 'Download failed');
        }
      }
      async function handleReceiptAttachmentDelete(attachmentId){
        const ro = state._receiveOrder;
        const receiptId = ro && ro.receiptId ? String(ro.receiptId).trim() : '';
        const id = String(attachmentId || '').trim();
        if(!receiptId || !id) return;
        if(!canManageReceiptAttachments()){
          toast('Attachment delete permission required');
          return;
        }
        const ok = await openConfirmModal(
          'Delete attachment?',
          'This removes the stored file. Receipt data remains unchanged.',
          { okText:'Delete', cancelText:'Cancel' }
        );
        if(!ok) return;
        try{
          await sbDeleteReceiptAttachment(receiptId, id);
          if(ro && Array.isArray(ro.attachments)){
            ro.attachments = ro.attachments.filter(att => String(att && att.id ? att.id : '') !== id);
          }
          toast('Attachment deleted', 'success');
          renderReceiveOrderModal();
        }catch(e){
          toast(e && e.message ? e.message : 'Delete failed');
        }
      }
      async function openReceiveDraftReceipt(receiptId, companyId){
        const id = String(receiptId || '').trim();
        if(!id) return;
        if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
        if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
        if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
        if(!canAccessReceivingInbox()){ toast('Receiving access required'); return; }
        let receiptCompanyId = String(companyId || '').trim() || (SB.companyId ? String(SB.companyId) : '');
        if(receiptCompanyId && SB.companyId && receiptCompanyId !== String(SB.companyId) && isEffectiveSuperUser()){
          const switched = await sbSwitchCompany(receiptCompanyId, { persist:false, audit:true, source:'receipts_inbox' });
          if(!switched) return;
          receiptCompanyId = SB.companyId ? String(SB.companyId) : receiptCompanyId;
        }

        setReceiveOrderMessage('');
        setReceiveOrderWarning('');
        state._receiveOrder = {
          mode: 'manual',
          tab: 'scanned',
          companyId: receiptCompanyId,
          poId: '',
          po: null,
          lines: [],
          receipts: [],
          receiptLines: [],
          receiptLinesByReceipt: new Map(),
          receiptId: id,
          receiptStatus: 'draft',
          receiptNotes: '',
          receiptVendor: '',
          receiptDate: '',
          receiptTotal: '',
          parsedLineItems: [],
          possibleDuplicate: false,
          manualSearch: '',
          loading:true,
          rawReceiptText: '',
          receiptSource: '',
          attachments: [],
          attachmentsLoading: false,
          attachmentsError: '',
          _attachmentsLoaded: false,
          _attachmentsLoadedFor: ''
        };
        show('receiveOrderModal', true);
        renderReceiveOrderModal();
        try{
          await ensureInventoryLoaded();
          await ensureIncomingOrdersLoaded();
          let receiptQuery = SB.client
            .from('receipts')
            .select('id,receipt_number,status,notes,raw_receipt_text,receipt_source,possible_duplicate,vendor_name,receipt_date,total,parsed_line_items')
            .eq('id', id);
          if(receiptCompanyId){
            receiptQuery = receiptQuery.eq('company_id', receiptCompanyId);
          }else if(SB.companyId){
            receiptQuery = receiptQuery.eq('company_id', SB.companyId);
          }
          const { data: receiptRow, error: receiptErr } = await receiptQuery.maybeSingle();
          if(receiptErr) throw receiptErr;
          if(!receiptRow){
            throw new Error('Receipt not found');
          }
          const { data: receiptLines, error: linesErr } = await SB.client
            .from('receipt_lines')
            .select('id,receipt_id,item_id,expected_qty,received_qty,rejected_qty,rejection_reason,unit_cost')
            .eq('receipt_id', id);
          if(linesErr) throw linesErr;
          const lines = (Array.isArray(receiptLines) ? receiptLines : []).map(line => {
            const itemId = String(line.item_id || '').trim();
            const item = itemId ? getInventoryById(itemId) : null;
            return {
              key: `manual-${itemId || line.id}`,
              item_id: itemId,
              item_name: String(item && item.name ? item.name : line.item_id || '').trim() || '(Unnamed item)',
              item_sku: String(item && item.sku ? item.sku : '').trim(),
              ordered_qty: 0,
              expected_qty: (line.expected_qty === null || typeof line.expected_qty === 'undefined') ? null : toInt(line.expected_qty, 0),
              prev_received: 0,
              remaining_qty: null,
              qty_received: toInt(line.received_qty, 0),
              qty_rejected: toInt(line.rejected_qty, 0),
              rejection_reason: String(line.rejection_reason || '').trim(),
              receipt_line_id: String(line.id || '').trim(),
              po_line_id: '',
              unit_cost: line.unit_cost === null || typeof line.unit_cost === 'undefined' ? null : line.unit_cost,
              disabled: !itemId
            };
          });
          state._receiveOrder.lines = lines;
          state._receiveOrder.receiptStatus = normalizeReceiptStatus(receiptRow.status || 'draft');
          state._receiveOrder.receiptNotes = String(receiptRow.notes || '').trim();
          state._receiveOrder.possibleDuplicate = !!receiptRow.possible_duplicate;
          state._receiveOrder.rawReceiptText = String(receiptRow.raw_receipt_text || '').trim();
          state._receiveOrder.receiptSource = String(receiptRow.receipt_source || '').trim();
          state._receiveOrder.receiptVendor = String(receiptRow.vendor_name || '').trim();
          state._receiveOrder.receiptDate = receiptRow.receipt_date ? String(receiptRow.receipt_date).trim() : '';
          state._receiveOrder.receiptTotal = (typeof receiptRow.total === 'number' || typeof receiptRow.total === 'string')
            ? String(receiptRow.total).trim()
            : '';
          state._receiveOrder.parsedLineItems = normalizeParsedLineItems(receiptRow.parsed_line_items);
          // Auto-match parsed lines to inventory by SKU
          const autoMatched = autoMatchParsedLinesBySku();
          if(autoMatched > 0){
            console.log(`Auto-matched ${autoMatched} item(s) by SKU`);
          }
          state._receiveOrder._lastSavedMetaKey = JSON.stringify({
            vendor_name: state._receiveOrder.receiptVendor || null,
            receipt_date: state._receiveOrder.receiptDate || null,
            total: parseReceiptNumber(state._receiveOrder.receiptTotal),
            parsed_line_items: sanitizeParsedLineItems(state._receiveOrder.parsedLineItems),
          });
          state._receiveOrder.loading = false;
          renderReceiveOrderModal();
          if(state._receiveOrder.receiptId){
            void loadReceiptAttachments(state._receiveOrder.receiptId);
          }
        }catch(e){
          state._receiveOrder.loading = false;
          renderReceiveOrderModal();
          setReceiveOrderMessage(e && e.message ? e.message : 'Failed to load receipt');
        }
      }
      function renderReceiveForwardingHint(){
        const hint = $('receiveForwardingHint');
        if(!hint) return;
        const ro = state._receiveOrder;
        const activeTab = getReceiveActiveTab(ro);
        const isInboxMode = ro && String(ro.mode || '') === 'inbox';
        if(activeTab !== 'scanned' || !isInboxMode){
          hint.style.display = 'none';
          hint.innerHTML = '';
          return;
        }
        if(isReceiveForwardingHintDismissed()){
          hint.style.display = 'none';
          hint.innerHTML = '';
          return;
        }
        const address = getReceiptForwardingAddress();
        hint.style.display = '';
        hint.innerHTML =
          `<div class="receive-forward-head">`+
            `<div><strong>Forward receipts to</strong> `+
              `<span class="forward-address">${escapeHtml(address)}</span>`+
            `</div>`+
            `<button class="receive-forward-dismiss" type="button" data-dismiss-receive-forward-hint aria-label="Dismiss">`+
              `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
                `<line x1="18" y1="6" x2="6" y2="18"></line>`+
                `<line x1="6" y1="6" x2="18" y2="18"></line>`+
              `</svg>`+
            `</button>`+
          `</div>`;
      }
	    function renderReceiveOrderModal(){
	      const ro = state._receiveOrder;
	      const meta = $('receiveOrderMeta');
      const summary = $('receiveOrderSummary');
      const linesWrap = $('receiveOrderLines');
      const receiptsWrap = $('receiveOrderReceipts');
      const statusEl = $('receiveReceiptStatus');
      const modeEl = $('receiveReceiptMode');
      const receiptIdEl = $('receiveReceiptId');
      const notesEl = $('receiveReceiptNotes');
      const reviewSection = $('receiptReviewSection');
      const vendorEl = $('receiveReceiptVendor');
      const dateEl = $('receiveReceiptDate');
      const totalEl = $('receiveReceiptTotal');
      const sourceBadge = $('receiveReceiptSourceBadge');
      const parsedLinesWrap = $('receiptParsedLines');
      const parsedCount = $('receiveParsedCount');
      const parsedSection = $('receiveParsedSection');
      const poLinkCard = $('receivePoLinkCard');
      const poLinkTitle = $('receivePoLinkTitle');
      const poLinkDesc = $('receivePoLinkDesc');
      const poLinkAction = $('receivePoLinkAction');
      const planUpgrade = $('receivePlanUpgrade');
      const rawWrap = $('receiveReceiptRaw');
      const rawTextEl = $('receiveReceiptRawText');
      const attachmentsWrap = $('receiveReceiptAttachments');
      const attachmentsList = $('receiveReceiptAttachmentsList');
      const attachmentsGate = $('receiveReceiptAttachmentsGate');
      const manualSection = $('receiveManualSection');
      const summarySection = $('receiveOrderSummarySection');
      const receiptsSection = $('receiveOrderReceiptsSection');
      const detailPanel = $('receiveDetailPanel');
      const scannedList = $('receiveScannedList');
      const scannedHeader = $('receiveScannedHeader');
      const scannedTitleMain = $('receiveScannedTitleMain');
      const scannedTitleSub = $('receiveScannedTitleSub');
      const scannedTotal = $('receiveScannedTotal');
      const poEmpty = $('receivePoEmpty');
      const poList = $('receivePoList');
      const linesSection = linesWrap ? linesWrap.closest('.form-section') : null;
      const activeTab = getReceiveActiveTab(ro);
      applyReceiveTabState(activeTab);
      updateReceiveTabBadge();
      if(ro && !ro.tab) ro.tab = activeTab;
	      if(!meta || !summary || !linesWrap || !receiptsWrap) return;
        renderReceiveForwardingHint();

      if(!ro || ro.loading){
        const mode = ro ? String(ro.mode || '') : '';
        const isInboxLoading = mode === 'inbox';
        if(statusEl){
          statusEl.textContent = 'Draft';
          statusEl.dataset.status = 'draft';
        }
        if(modeEl){
          modeEl.textContent = activeTab === 'po' ? 'PO Receipt'
            : (activeTab === 'scanned' ? 'Scanned Receipts' : 'Quick Add');
        }
        if(receiptIdEl) receiptIdEl.textContent = '';
        if(notesEl){ notesEl.value = ''; notesEl.disabled = true; }
        if(reviewSection) reviewSection.style.display = 'none';
        if(vendorEl){ vendorEl.value = ''; vendorEl.disabled = true; }
        if(dateEl){ dateEl.value = ''; dateEl.disabled = true; }
        if(totalEl){ totalEl.value = ''; totalEl.disabled = true; }
        if(sourceBadge){ sourceBadge.style.display = 'none'; sourceBadge.textContent = ''; }
        if(scannedTotal){
          scannedTotal.textContent = '';
          scannedTotal.style.display = 'none';
        }
        if(parsedLinesWrap) parsedLinesWrap.innerHTML = '';
        if(parsedCount) parsedCount.textContent = '0 items';
        if(poLinkCard && poLinkTitle && poLinkDesc){
          poLinkCard.classList.add('po-link-card--none');
          poLinkTitle.textContent = 'No PO linked';
          poLinkDesc.textContent = 'Link to a purchase order to auto-reconcile';
          if(poLinkAction){
            poLinkAction.textContent = 'Link PO';
            poLinkAction.disabled = true;
            poLinkAction.setAttribute('aria-disabled', 'true');
          }
        }
        if(planUpgrade) planUpgrade.style.display = 'none';
        if(rawWrap && rawTextEl){
          rawWrap.style.display = 'none';
          rawTextEl.textContent = '';
        }
        if(attachmentsWrap && attachmentsList && attachmentsGate){
          attachmentsWrap.style.display = 'none';
          attachmentsList.innerHTML = '';
          attachmentsGate.style.display = 'none';
        }
        if(meta) meta.innerHTML = '';
        if(summary) summary.innerHTML = '';
        if(linesWrap) linesWrap.innerHTML = `<div class="muted">Loading receipt detailsâ€¦</div>`;
        if(receiptsWrap) receiptsWrap.innerHTML = '';
        if(manualSection) manualSection.style.display = activeTab === 'quick' ? '' : 'none';
        if(summarySection) summarySection.style.display = 'none';
        if(receiptsSection) receiptsSection.style.display = 'none';
        if(linesSection) linesSection.style.display = isInboxLoading ? 'none' : '';
        if(detailPanel) detailPanel.style.display = isInboxLoading ? 'none' : '';
        if(scannedList) scannedList.style.display = activeTab === 'scanned' ? '' : 'none';
        if(scannedHeader) scannedHeader.style.display = 'none';
        if(poList){
          poList.style.display = 'none';
          poList.innerHTML = '';
        }
        if(poEmpty) poEmpty.style.display = activeTab === 'po' ? '' : 'none';
        return;
	      }

	      const mode = String(ro.mode || 'order');
	      const isOrderMode = mode === 'order';
	      const isInboxMode = mode === 'inbox';
	      const receiptStatusRaw = String(ro.receiptStatus || 'draft').trim().toLowerCase();
	      const receiptStatus = normalizeReceiptStatus(receiptStatusRaw);
	      const statusText = formatReceiptStatusLabel(receiptStatus || 'draft');
	      const isDraftLike = isReceiptDraftLike(receiptStatus);
	      const isEditable = isDraftLike && canReceivingEdit();
	      const planBlocked = isReceiptPlanBlocked(receiptStatus);

	      if(statusEl){
	        statusEl.textContent = isInboxMode ? 'Inbox' : (statusText || 'Draft');
	        statusEl.dataset.status = isInboxMode ? 'draft' : (receiptStatus || 'draft');
	      }
      if(modeEl){
        modeEl.textContent = activeTab === 'po' ? 'PO Receipt'
          : (activeTab === 'scanned' ? 'Scanned Receipts' : 'Quick Add');
      }
	      if(receiptIdEl){
	        receiptIdEl.innerHTML = ro.receiptId
	          ? `Receipt ID: <span>${escapeHtml(shortId(ro.receiptId) || ro.receiptId)}</span>`
	          : '';
	      }
      if(notesEl){
        notesEl.value = String(ro.receiptNotes || '');
        notesEl.disabled = !isEditable || isInboxMode;
        const notesWrap = notesEl.closest('.notes-section');
        if(notesWrap) notesWrap.style.display = isInboxMode ? 'none' : '';
      }
      if(rawWrap && rawTextEl){
        if(isInboxMode){
          rawWrap.style.display = 'none';
          rawTextEl.textContent = '';
        }else{
          const rawText = String(ro.rawReceiptText || '').trim();
          if(rawText){
            rawTextEl.textContent = rawText;
            rawWrap.style.display = '';
          }else{
            rawWrap.style.display = 'none';
            rawTextEl.textContent = '';
          }
        }
      }
      if(attachmentsWrap && attachmentsList && attachmentsGate){
        const attachments = Array.isArray(ro.attachments) ? ro.attachments.filter(att => att && att.id) : [];
        const hasAttachments = attachments.length > 0;
        const showAttachments = !isInboxMode && !!ro.receiptId && (hasAttachments || ro.attachmentsLoading);
        if(!showAttachments){
          attachmentsWrap.style.display = 'none';
          attachmentsList.innerHTML = '';
          attachmentsGate.style.display = 'none';
        }else{
          attachmentsWrap.style.display = '';
          if(!canReceiptAttachmentStorage()){
            attachmentsGate.style.display = '';
            attachmentsList.innerHTML = `<div class="receive-attachments-empty">Receipt scans and storage are available on Pro plans.</div>`;
          }else{
            attachmentsGate.style.display = 'none';
            if(ro.attachmentsLoading){
              attachmentsList.innerHTML = `<div class="receive-attachments-empty">Loading attachmentsâ€¦</div>`;
            }else if(ro.attachmentsError){
              attachmentsList.innerHTML = `<div class="receive-attachments-empty">${escapeHtml(ro.attachmentsError)}</div>`;
            }else{
              const allowDelete = canManageReceiptAttachments();
              attachmentsList.innerHTML = attachments.map(att => {
                const id = String(att.id || '').trim();
                const name = String(att.file_name || 'Attachment').trim() || 'Attachment';
                const contentType = String(att.content_type || '').trim();
                const typeLabel = formatReceiptAttachmentType(contentType);
                const sizeLabel = formatReceiptAttachmentSize(att.byte_size);
                const metaText = [typeLabel, sizeLabel].filter(Boolean).join(' â€¢ ');
                const deleteBtn = allowDelete
                  ? `<button class="btn-tertiary btn-sm btn-danger" type="button" data-receipt-attachment-delete="${escapeHtmlAttr(id)}">Delete</button>`
                  : '';
                return (
                  `<div class="receive-attachment-item" data-receipt-attachment-id="${escapeHtmlAttr(id)}">`+
                    `<div class="receive-attachment-info">`+
                      `<div class="receive-attachment-name" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</div>`+
                      `<div class="receive-attachment-meta">${escapeHtml(metaText || 'File')}</div>`+
                    `</div>`+
                    `<div class="receive-attachment-actions">`+
                      `<button class="btn-tertiary btn-sm" type="button" data-receipt-attachment-download="${escapeHtmlAttr(id)}">Download</button>`+
                      `${deleteBtn}`+
                    `</div>`+
                  `</div>`
                );
              }).join('');
            }
          }
        }
      }

      const hasReceiptDetails = !!(
        String(ro.receiptSource || '').trim() ||
        String(ro.rawReceiptText || '').trim() ||
        (Array.isArray(ro.parsedLineItems) && ro.parsedLineItems.length) ||
        String(ro.receiptVendor || '').trim() ||
        String(ro.receiptDate || '').trim() ||
        String(ro.receiptTotal || '').trim()
      );
      const showReviewSection = !isInboxMode && (activeTab === 'scanned' || activeTab === 'quick')
        && (hasReceiptDetails || isEditable || !!ro.receiptId);
      if(reviewSection) reviewSection.style.display = showReviewSection ? '' : 'none';
      const allowDetailsEdit = !isInboxMode && isEditable && showReviewSection;
      if(vendorEl){
        vendorEl.value = String(ro.receiptVendor || '');
        vendorEl.disabled = !allowDetailsEdit;
      }
      if(dateEl){
        dateEl.value = String(ro.receiptDate || '');
        dateEl.disabled = !allowDetailsEdit;
      }
      if(totalEl){
        totalEl.value = formatReceiptInputValue(ro.receiptTotal);
        totalEl.disabled = !allowDetailsEdit;
      }
      if(sourceBadge){
        const label = formatReceiptSourceLabel(ro.receiptSource);
        if(label){
          sourceBadge.textContent = label;
          sourceBadge.style.display = '';
        }else{
          sourceBadge.textContent = '';
          sourceBadge.style.display = 'none';
        }
      }
      if(poLinkCard && poLinkTitle && poLinkDesc){
        if(isOrderMode && ro.po){
          const poNumber = String(ro.po.po_number || '').trim() || shortId(ro.po.id || '');
          const vendor = String(ro.po.vendor_name || (ro.po.vendor && ro.po.vendor.name) || ro.po.vendor_id || '').trim();
          poLinkCard.classList.remove('po-link-card--none');
          poLinkTitle.textContent = poNumber ? `Linked to ${poNumber}` : 'Linked purchase order';
          poLinkDesc.textContent = vendor || 'Purchase order linked';
          if(poLinkAction){
            poLinkAction.textContent = 'View PO';
            poLinkAction.disabled = false;
            poLinkAction.setAttribute('aria-disabled', 'false');
          }
        }else{
          poLinkCard.classList.add('po-link-card--none');
          poLinkTitle.textContent = 'No PO linked';
          poLinkDesc.textContent = 'Link to a purchase order to auto-reconcile';
          if(poLinkAction){
            poLinkAction.textContent = 'Link PO';
            poLinkAction.disabled = true;
            poLinkAction.setAttribute('aria-disabled', 'true');
          }
        }
      }
      if(parsedLinesWrap){
        const parsedLines = Array.isArray(ro.parsedLineItems) ? ro.parsedLineItems : [];
        // Hide section if not a parsed receipt (no items and never had any)
        const hasParsedItems = parsedLines.length > 0;
        const isFromParsing = ro.receiptSource === 'email' || ro.receiptSource === 'scan' || ro.receiptSource === 'upload' || hasParsedItems;
        if(parsedSection){
          parsedSection.style.display = isFromParsing ? '' : 'none';
        }
        if(parsedCount){
          const matchedCount = parsedLines.filter(l => l && l.item_id).length;
          const countLabel = parsedLines.length === 1 ? '1 item' : `${parsedLines.length} items`;
          const matchLabel = matchedCount > 0 ? ` (${matchedCount} matched)` : '';
          parsedCount.textContent = countLabel + matchLabel;
        }
        const stepperMinusSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
        const stepperPlusSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
        const linesHtml = parsedLines.length
          ? parsedLines.map((line, idx) => {
              const desc = String(line && line.description ? line.description : '');
              const skuVal = String(line && line.sku ? line.sku : '');
              const qtyParsed = line && line.qty != null ? Number(line.qty) : 0;
              const qtyVal = String(qtyParsed || 0);
              const unitVal = formatReceiptInputValue(line && line.unit_price);
              const lineTotal = getParsedLineTotal(line);
              const totalText = (lineTotal === null || typeof lineTotal === 'undefined')
                ? 'â€”'
                : formatReceiptMoney(lineTotal);
              const disabled = !allowDetailsEdit;
              const disabledAttr = disabled ? ' disabled' : '';
              const itemId = line && line.item_id ? String(line.item_id).trim() : '';
              const isMatched = !!itemId;
              const matchedItem = isMatched ? getInventoryById(itemId) : null;
              const matchedName = matchedItem ? String(matchedItem.name || '').trim() : '';
              const matchedSku = matchedItem ? String(matchedItem.sku || '').trim() : '';
              const qtyReceivedNum = line && typeof line.qty_received !== 'undefined' ? Number(line.qty_received) : qtyParsed;
              const qtyReceived = String(qtyReceivedNum || 0);
              const rejectionReason = line && line.rejection_reason ? String(line.rejection_reason).trim() : '';
              const hasMismatch = qtyReceivedNum < qtyParsed;
              const statusClass = isMatched ? 'parsed-item-status--matched' : 'parsed-item-status--unmatched';
              const statusIcon = isMatched
                ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="20 6 9 17 4 12"></polyline></svg>`
                : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
              const matchRow = isMatched
                ? `<div class="parsed-item-match-row">`+
                    `<div class="parsed-item-matched-info">`+
                      `<span class="parsed-item-matched-name" title="${escapeHtmlAttr(matchedName)}">${escapeHtml(matchedName || 'Matched item')}</span>`+
                      (matchedSku ? `<span class="parsed-item-matched-sku">SKU: ${escapeHtml(matchedSku)}</span>` : '')+
                    `</div>`+
                    (allowDetailsEdit ? `<button class="btn-unmatch" type="button" data-parsed-line-unmatch="${idx}">Unmatch</button>` : '')+
                  `</div>`
                : `<div class="parsed-item-match-row">`+
                    `<div class="parsed-item-search" data-parsed-line-search="${idx}">`+
                      `<input type="text" placeholder="Search inventory to match..." data-parsed-line-search-input="${idx}"${disabledAttr}>`+
                      `<div class="parsed-item-search-results" data-parsed-line-results="${idx}" style="display:none;"></div>`+
                    `</div>`+
                  `</div>`;
              // Actuals row with steppers - shown for all items
              const receivedStepperClass = hasMismatch ? 'qty-stepper qty-stepper--mismatch' : 'qty-stepper qty-stepper--received';
              const actualsRow = `<div class="parsed-item-actuals">`+
                  `<div class="parsed-item-actuals-row">`+
                    `<div class="parsed-item-actuals-group">`+
                      `<span class="parsed-item-actuals-label">Parsed</span>`+
                      `<div class="qty-stepper">`+
                        `<button type="button" class="qty-stepper-btn" data-stepper-action="dec" data-stepper-field="qty" data-stepper-index="${idx}"${disabledAttr}>${stepperMinusSvg}</button>`+
                        `<div class="qty-stepper-value">`+
                          `<input type="number" inputmode="numeric" step="1" min="0" value="${escapeHtmlAttr(qtyVal)}" data-receipt-line-field="qty" data-receipt-line-index="${idx}"${disabledAttr}>`+
                        `</div>`+
                        `<button type="button" class="qty-stepper-btn" data-stepper-action="inc" data-stepper-field="qty" data-stepper-index="${idx}"${disabledAttr}>${stepperPlusSvg}</button>`+
                      `</div>`+
                    `</div>`+
                    `<div class="parsed-item-actuals-group">`+
                      `<span class="parsed-item-actuals-label">Received</span>`+
                      `<div class="${receivedStepperClass}" data-stepper-received="${idx}">`+
                        `<button type="button" class="qty-stepper-btn" data-stepper-action="dec" data-stepper-field="qty_received" data-stepper-index="${idx}"${disabledAttr}>${stepperMinusSvg}</button>`+
                        `<div class="qty-stepper-value">`+
                          `<input type="number" inputmode="numeric" step="1" min="0" value="${escapeHtmlAttr(qtyReceived)}" data-parsed-line-field="qty_received" data-parsed-line-index="${idx}"${disabledAttr}>`+
                        `</div>`+
                        `<button type="button" class="qty-stepper-btn" data-stepper-action="inc" data-stepper-field="qty_received" data-stepper-index="${idx}"${disabledAttr}>${stepperPlusSvg}</button>`+
                      `</div>`+
                    `</div>`+
                  `</div>`+
                  `<div class="parsed-item-rejection${hasMismatch ? ' is-visible' : ''}" data-rejection-row="${idx}">`+
                    `<textarea placeholder="Rejection reason (required when received < parsed)" data-parsed-line-field="rejection_reason" data-parsed-line-index="${idx}"${disabledAttr}>${escapeHtml(rejectionReason)}</textarea>`+
                  `</div>`+
                `</div>`;
              return (
                `<div class="parsed-item receipt-parsed-line${isMatched ? ' is-matched' : ''}" data-receipt-line-index="${idx}">`+
                  `<div class="parsed-item-main">`+
                    `<div class="parsed-item-status ${statusClass}">`+
                      statusIcon+
                    `</div>`+
                    `<div class="parsed-item-info">`+
                      `<div class="parsed-item-name">`+
                        `<input type="text" value="${escapeHtmlAttr(desc)}" data-receipt-line-field="description" data-receipt-line-index="${idx}" placeholder="Item description"${disabledAttr}>`+
                      `</div>`+
                      `<div class="parsed-item-sku">`+
                        `<input type="text" value="${escapeHtmlAttr(skuVal)}" data-receipt-line-field="sku" data-receipt-line-index="${idx}" placeholder="SKU / Item #"${disabledAttr}>`+
                      `</div>`+
                    `</div>`+
                    `<div class="parsed-item-values">`+
                      `<div class="parsed-item-price">`+
                        `<div class="parsed-item-unit">`+
                          `<input type="number" inputmode="decimal" step="0.01" min="0" value="${escapeHtmlAttr(unitVal)}" data-receipt-line-field="unit_price" data-receipt-line-index="${idx}"${disabledAttr}>`+
                        `</div>`+
                        `<div class="parsed-item-total receipt-parsed-total-value">${escapeHtml(totalText)}</div>`+
                      `</div>`+
                    `</div>`+
                  `</div>`+
                  matchRow+
                  actualsRow+
                `</div>`
              );
            }).join('')
          : `<div class="parsed-empty">No parsed items yet.</div>`;
        const addAction = allowDetailsEdit
          ? `<div class="parsed-items-action"><button class="btn-tertiary btn-sm" type="button" data-receipt-line-add>Add line item</button></div>`
          : '';
        parsedLinesWrap.innerHTML = linesHtml + addAction;
      }

      const isQuickTab = activeTab === 'quick';
      const isScannedTab = activeTab === 'scanned';
      const isPoTab = activeTab === 'po';
      const showDetailPanel = !isInboxMode && (isQuickTab || (isScannedTab && !isInboxMode) || (isPoTab && isOrderMode));
      if(detailPanel) detailPanel.style.display = showDetailPanel ? '' : 'none';
      if(scannedList) scannedList.style.display = (isScannedTab && isInboxMode) ? '' : 'none';
      if(scannedHeader) scannedHeader.style.display = (isScannedTab && !isInboxMode) ? '' : 'none';
      if(scannedTitleMain && scannedTitleSub){
        if(isScannedTab && !isInboxMode){
          const vendor = String(ro.receiptVendor || '').trim() || 'Receipt review';
          const dateText = ro.receiptDate ? formatDateShort(ro.receiptDate) : '';
          scannedTitleMain.textContent = vendor;
          scannedTitleSub.textContent = dateText || 'Review before inventory is updated.';
        }else{
          scannedTitleMain.textContent = 'Receipt review';
          scannedTitleSub.textContent = 'Review before inventory is updated.';
        }
      }
      if(scannedTotal){
        if(isScannedTab && !isInboxMode){
          const totalNum = parseReceiptNumber(ro.receiptTotal);
          if(totalNum !== null && typeof totalNum !== 'undefined'){
            scannedTotal.textContent = formatReceiptMoney(totalNum);
            scannedTotal.style.display = '';
          }else{
            scannedTotal.textContent = '';
            scannedTotal.style.display = 'none';
          }
        }else{
          scannedTotal.textContent = '';
          scannedTotal.style.display = 'none';
        }
      }

      if(summarySection) summarySection.style.display = (isPoTab && isOrderMode) ? '' : 'none';
      if(receiptsSection) receiptsSection.style.display = (isPoTab && isOrderMode) ? '' : 'none';
      if(manualSection) manualSection.style.display = isQuickTab ? '' : 'none';
      if(linesSection) linesSection.style.display = showDetailPanel ? '' : 'none';

      let poListCount = 0;
      if(poList){
        if(isPoTab && !isOrderMode){
          const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
          const lineMap = state._orderHistoryLinesByPo || new Map();
          const openRows = rows.filter(row => {
            const id = row && row.id ? String(row.id) : '';
            if(!id) return false;
            const totals = getPurchaseOrderLineTotalsById(id, lineMap);
            const receiveState = getPurchaseOrderReceiveState(row, totals);
            return receiveState && !['draft','cancelled','closed','voided','fully_received'].includes(receiveState);
          });
          const sorted = openRows.slice().sort((a, b) => {
            const aDate = new Date(a && (a.order_date || a.created_at || 0));
            const bDate = new Date(b && (b.order_date || b.created_at || 0));
            return bDate - aDate;
          });
          const list = sorted.slice(0, 8);
          poListCount = list.length;
          poList.style.display = poListCount ? '' : 'none';
          poList.innerHTML = poListCount ? list.map(row => {
            const id = String(row && row.id ? row.id : '').trim();
            const poNumber = String(row && row.po_number ? row.po_number : '').trim();
            const vendor = String(row && (row.vendor_name || row.vendor_id || '') || '').trim() || 'Unknown vendor';
            const totals = getPurchaseOrderLineTotalsById(id, lineMap);
            const statusLabel = formatPurchaseOrderStatusLabel(row, totals);
            const lines = lineMap && typeof lineMap.get === 'function' ? (lineMap.get(id) || []) : [];
            const count = Array.isArray(lines) ? lines.length : 0;
            const expected = row && (row.expected_date || row.order_date || row.created_at) ? formatDateShort(row.expected_date || row.order_date || row.created_at) : '';
            const meta = [
              count ? `${count} item${count === 1 ? '' : 's'}` : 'No lines',
              expected ? `Expected ${expected}` : ''
            ].filter(Boolean).join(' â€¢ ');
            return (
              `<div class="receive-po-card" data-receive-po-id="${escapeHtmlAttr(id)}">`+
                `<div class="receive-po-icon">${ICONS.package}</div>`+
                `<div class="receive-po-info">`+
                  `<div class="receive-po-title">${escapeHtml(poNumber || shortId(id))} â€¢ ${escapeHtml(vendor)}</div>`+
                  `<div class="receive-po-meta">${escapeHtml(meta)}</div>`+
                `</div>`+
                `<span class="receive-po-status">${escapeHtml(statusLabel || 'Open')}</span>`+
                `<span class="receive-po-arrow">${ICONS.chevronRight}</span>`+
              `</div>`
            );
          }).join('') : '';
        }else{
          poList.style.display = 'none';
          poList.innerHTML = '';
        }
      }
      if(poEmpty) poEmpty.style.display = (isPoTab && !isOrderMode && !poListCount) ? '' : 'none';

      if(isQuickTab && !isInboxMode && ro.mode === 'manual'){
        const manualInput = $('receiveManualSearch');
        if(manualInput){
          manualInput.value = String(ro.manualSearch || '');
          manualInput.disabled = !isEditable;
        }
        updateReceiveManualClearBtn();
        renderReceiveManualResults();
      }

	      if(isOrderMode){
	        const po = ro.po || {};
	        const poNumber = String(po.po_number || '').trim();
	        const supplier = String(po.vendor_name || (po.vendor && po.vendor.name) || po.vendor_id || '').trim() || 'Unknown';
	        const vendorEmail = String(po.vendor_email || (po.vendor && po.vendor.email) || '').trim();
	        const sentAt = po.sent_at || po.created_at || null;
	        const poSent = !!po.sent_at;
	        const totals = computeReceiveTotals(ro.lines || []);
	        const poTotals = {
	          ordered: totals.ordered,
	          received: totals.received,
	          remaining: totals.remaining,
	          hasLines: Array.isArray(ro.lines) && ro.lines.length > 0
	        };
	        const statusLabel = formatPurchaseOrderStatusLabel(po, poTotals);
	        const statusClass = statusLabel.toLowerCase().includes('partial') ? 'partial' 
	          : statusLabel.toLowerCase().includes('received') ? 'received' : 'open';

	        // Format sent date/time
	        let sentDateHtml = '';
	        if(sentAt){
	          try{
	            const sentDate = new Date(sentAt);
	            const dateStr = sentDate.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
	            const timeStr = sentDate.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' });
	            sentDateHtml = `${dateStr} at ${timeStr}`;
	          }catch(e){ sentDateHtml = String(sentAt); }
	        }

	        // Calculate lead time (days from PO sent/created to now)
	        let leadTimeDays = null;
	        if(sentAt){
	          try{
	            const sentDate = new Date(sentAt);
	            const now = new Date();
	            const diffTime = Math.abs(now - sentDate);
	            leadTimeDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
	          }catch(e){}
	        }

	        meta.innerHTML =
	          `<div class="po-header-card">`+
	            `<div class="po-header-top">`+
	              `<div class="po-header-main">`+
	                `<div class="po-number">`+
	                  `${escapeHtml(poNumber || String(po.id || '').trim() || 'â€”')}`+
	                  (poSent ? `<span class="po-number-badge"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>Sent</span>` : '')+
	                `</div>`+
	                `<div class="po-vendor">`+
	                  `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`+
	                  `<span class="po-vendor-name">${escapeHtml(supplier)}</span>`+
	                `</div>`+
	              `</div>`+
	              `<span class="po-status-badge po-status-badge--${statusClass}">${escapeHtml(statusLabel || 'â€”')}</span>`+
	            `</div>`+
	            `<div class="po-details-row">`+
	              (vendorEmail ? 
	                `<div class="po-detail">`+
	                  `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>`+
	                  `<span>Sent to:</span>`+
	                  `<span class="po-detail-value"><a href="mailto:${escapeHtmlAttr(vendorEmail)}">${escapeHtml(vendorEmail)}</a></span>`+
	                `</div>` : '')+
	              (sentDateHtml ? 
	                `<div class="po-detail">`+
	                  `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`+
	                  `<span>Order placed:</span>`+
	                  `<span class="po-detail-value">${escapeHtml(sentDateHtml)}</span>`+
	                `</div>` : '')+
	            `</div>`+
	          `</div>`;

	        summary.innerHTML =
	          `<div class="receive-summary">`+
	            `<div class="receive-order-card">`+
	              `<div class="label">Expected Qty</div>`+
	              `<div class="value">${formatQty(totals.ordered)}</div>`+
	            `</div>`+
	            `<div class="receive-order-card">`+
	              `<div class="label">Prev Received</div>`+
	              `<div class="value" style="color:#22c55e;">${formatQty(totals.received)}</div>`+
	            `</div>`+
	            `<div class="receive-order-card">`+
	              `<div class="label">Remaining</div>`+
	              `<div class="value" style="color:#f59e0b;">${formatQty(totals.remaining)}</div>`+
	            `</div>`+
	          `</div>`+
	          (leadTimeDays !== null ? 
	            `<div class="lead-time-card">`+
	              `<div class="lead-time-info">`+
	                `<div class="lead-time-icon">`+
	                  `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`+
	                `</div>`+
	                `<div>`+
	                  `<div class="lead-time-label">Order to Inventory</div>`+
	                  `<div class="lead-time-sublabel">Days from PO sent â†’ received into system</div>`+
	                `</div>`+
	              `</div>`+
	              `<div class="lead-time-value">`+
	                `<div class="lead-time-days">${leadTimeDays}</div>`+
	                `<div class="lead-time-days-label">days</div>`+
	              `</div>`+
	            `</div>` : '');
	      }else{
	        meta.innerHTML = '';
	        summary.innerHTML = '';
	      }

	      if(!ro.lines || !ro.lines.length){
	        linesWrap.innerHTML = `<div class="order-empty">${isOrderMode ? 'No line items found.' : 'No items added yet.'}</div>`;
	      }else{
	        const incomingMap = state._incomingByItemId && typeof state._incomingByItemId.get === 'function'
	          ? state._incomingByItemId
	          : buildInventoryIncomingMap();
	        state._incomingByItemId = incomingMap;
	        linesWrap.innerHTML = ro.lines.map(line => {
	          const name = line.item_name || '(Unnamed item)';
	          const sku = line.item_sku || '';
	          const remainingNum = (line.remaining_qty === null || typeof line.remaining_qty === 'undefined') ? 0 : toInt(line.remaining_qty, 0);
	          const remaining = (line.remaining_qty === null || typeof line.remaining_qty === 'undefined')
	            ? 'â€”'
	            : formatQty(line.remaining_qty);
	          const disabled = line.disabled || !isEditable;
	          const disabledAttr = disabled ? ' disabled' : '';
	          const receivedVal = toInt(line.qty_received, 0);
	          const rejectedVal = toInt(line.qty_rejected, 0);
	          const reasonVal = String(line.rejection_reason || '').trim();
	          const reasonDisabled = rejectedVal === 0;
	          const invItem = line.item_id ? getInventoryById(line.item_id) : null;
	          const onHand = invItem ? toInt(invItem.qty, 0) : null;
	          const incomingEntry = line.item_id ? incomingMap.get(line.item_id) : null;
	          const incomingQty = incomingEntry ? incomingEntry.qty : 0;
	          const onHandText = (onHand === null || typeof onHand === 'undefined') ? 'â€”' : formatQty(onHand);
	          const incomingText = incomingQty > 0 ? formatQty(incomingQty) : 'â€”';
	          const stepperMinusSvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
	          const stepperPlusSvg = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
	          return (
	            `<div class="receive-line${disabled ? ' disabled' : ''}" data-receive-line-key="${escapeHtmlAttr(line.key)}">`+
	              `<div class="receive-line-header">`+
	                `<div class="receive-line-info">`+
	                  `<div class="receive-line-title" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</div>`+
	                  (sku ? `<div class="receive-line-sku">SKU: ${escapeHtml(sku)}</div>` : '')+
	                `</div>`+
	                `<div class="receive-line-remaining">`+
	                  `<span class="receive-line-remaining-label">Rem</span>`+
	                  `<span class="receive-line-remaining-value">${remaining}</span>`+
	                `</div>`+
	              `</div>`+
	              (isOrderMode ? 
	                `<div class="receive-line-stats">`+
	                  `<div class="receive-line-stat">`+
	                    `<div class="receive-line-stat-value">${formatQty(line.expected_qty)}</div>`+
	                    `<div class="receive-line-stat-label">Expected</div>`+
	                  `</div>`+
	                  `<div class="receive-line-stat">`+
	                    `<div class="receive-line-stat-value">${formatQty(line.prev_received)}</div>`+
	                    `<div class="receive-line-stat-label">Prev</div>`+
	                  `</div>`+
	                  `<div class="receive-line-stat">`+
	                    `<div class="receive-line-stat-value">${onHandText}</div>`+
	                    `<div class="receive-line-stat-label">On Hand</div>`+
	                  `</div>`+
	                  `<div class="receive-line-stat">`+
	                    `<div class="receive-line-stat-value">${incomingText}</div>`+
	                    `<div class="receive-line-stat-label">Incoming</div>`+
	                  `</div>`+
	                `</div>` : '')+
	              `<div class="receive-line-inputs">`+
	                `<div class="receive-line-stepper-row">`+
	                  `<label>Received</label>`+
	                  `<div class="qty-stepper qty-stepper--received">`+
	                    `<button type="button" class="qty-stepper-btn" data-receive-stepper="dec" data-receive-line-key="${escapeHtmlAttr(line.key)}" data-receive-field="received"${disabledAttr}${receivedVal <= 0 ? ' disabled' : ''}>${stepperMinusSvg}</button>`+
	                    `<input type="number" class="qty-stepper-input" inputmode="numeric" step="1" min="0" data-receive-line-key="${escapeHtmlAttr(line.key)}" data-receive-field="received" value="${receivedVal}"${disabledAttr}>`+
	                    `<button type="button" class="qty-stepper-btn" data-receive-stepper="inc" data-receive-line-key="${escapeHtmlAttr(line.key)}" data-receive-field="received"${disabledAttr}>${stepperPlusSvg}</button>`+
	                  `</div>`+
	                  (remainingNum > 0 ? `<button type="button" class="receive-line-receive-all" data-receive-all="${remainingNum}" data-receive-line-key="${escapeHtmlAttr(line.key)}"${disabledAttr}>All</button>` : '')+
	                `</div>`+
	                `<div class="receive-line-stepper-row">`+
	                  `<label>Rejected</label>`+
	                  `<div class="qty-stepper">`+
	                    `<button type="button" class="qty-stepper-btn" data-receive-stepper="dec" data-receive-line-key="${escapeHtmlAttr(line.key)}" data-receive-field="rejected"${disabledAttr}${rejectedVal <= 0 ? ' disabled' : ''}>${stepperMinusSvg}</button>`+
	                    `<input type="number" class="qty-stepper-input" inputmode="numeric" step="1" min="0" data-receive-line-key="${escapeHtmlAttr(line.key)}" data-receive-field="rejected" value="${rejectedVal}"${disabledAttr}>`+
	                    `<button type="button" class="qty-stepper-btn" data-receive-stepper="inc" data-receive-line-key="${escapeHtmlAttr(line.key)}" data-receive-field="rejected"${disabledAttr}>${stepperPlusSvg}</button>`+
	                  `</div>`+
	                `</div>`+
	                `<div class="receive-line-reason-row">`+
	                  `<label>Reason</label>`+
	                  `<input type="text" class="receive-line-reason-input" data-receive-line-key="${escapeHtmlAttr(line.key)}" data-receive-field="reason" placeholder="Required if rejected qty > 0" value="${escapeHtmlAttr(reasonVal)}"${disabledAttr}${reasonDisabled ? ' disabled' : ''}>`+
	                `</div>`+
	              `</div>`+
	              `<div class="receive-line-warning" data-receive-line-warning>âš  Receiving more than remaining quantity</div>`+
	              (line.disabled ? `<div class="receive-line-note">Item mapping missing. This line cannot be received.</div>` : '')+
	            `</div>`
	          );
	        }).join('');
	        ro.lines.forEach(updateReceiveLineDom);
	      }

	      if(isOrderMode){
	        const visibleReceipts = (ro.receipts || []).filter(r => !isReceiptDraftLike(String(r && r.status ? r.status : '').trim()));
	        if(!visibleReceipts.length){
	          receiptsWrap.innerHTML = `<div class="muted">No receipts yet.</div>`;
	        }else{
	          receiptsWrap.innerHTML =
	            `<div class="muted" style="letter-spacing:.08em;text-transform:uppercase;font-weight:800;">Previous Receipts</div>`+
	            visibleReceipts.map(r => {
	              const receiptId = String(r && r.id ? r.id : '').trim();
	              const rStatus = String(r && r.status ? r.status : '').trim();
	              const statusLabel = formatReceiptStatusLabel(rStatus || '');
	              const when = r && (r.received_at || r.voided_at || r.created_at)
	                ? formatEasternDateTime(r.received_at || r.voided_at || r.created_at)
	                : '';
	              const lines = ro.receiptLinesByReceipt && ro.receiptLinesByReceipt.get(receiptId) ? ro.receiptLinesByReceipt.get(receiptId) : [];
	              const totalReceived = lines.reduce((sum, l) => sum + toInt(l.received_qty, 0), 0);
	              const totalRejected = lines.reduce((sum, l) => sum + toInt(l.rejected_qty, 0), 0);
	              const canVoid = (normalizeReceiptStatus(rStatus) === 'received') && canReceivingVoid();
	              return (
	                `<div class="receive-receipt">`+
	                  `<div class="receive-receipt-header">`+
	                    `<div>`+
	                      `<div class="receive-receipt-title">Receipt ${escapeHtml(shortId(receiptId) || receiptId)}</div>`+
	                      `<div class="receive-receipt-meta">${escapeHtml(statusLabel || '')}${when ? ` â€¢ ${escapeHtml(when)}` : ''}</div>`+
	                    `</div>`+
	                  `</div>`+
	                  `<div class="receive-receipt-meta">Received: ${formatQty(totalReceived)} â€¢ Rejected: ${formatQty(totalRejected)}</div>`+
	                  `<div class="receive-receipt-lines">`+
	                    (lines.length ? lines.map(line => {
	                      const itemName = line.item_name || line.item_id || 'Item';
	                      const sku = line.item_sku ? ` (${line.item_sku})` : '';
	                      return (
	                        `<div class="receive-receipt-line">`+
	                          `<div>${escapeHtml(itemName)}${escapeHtml(sku)}</div>`+
	                          `<span>+${formatQty(line.received_qty)}</span>`+
	                          `<span>âˆ’${formatQty(line.rejected_qty)}</span>`+
	                        `</div>`
	                      );
	                    }).join('') : `<div class="muted">No lines.</div>`) +
	                  `</div>`+
	                  (canVoid
	                    ? `<div class="receive-void-row">`+
	                        `<input type="text" placeholder="Void reason (min 10 chars)" data-void-receipt-reason="${escapeHtmlAttr(receiptId)}">`+
	                        `<button class="btn-tertiary btn-sm btn-danger" type="button" data-void-receipt-id="${escapeHtmlAttr(receiptId)}">Void</button>`+
	                      `</div>`
	                    : ''
	                  )+
	                `</div>`
	              );
	            }).join('');
	        }
	      }else{
	        receiptsWrap.innerHTML = '';
	      }

      if(isInboxMode){
        setReceiveOrderMessage('Review before inventory is updated. Receipts are never received automatically.');
      }else if(receiptStatus === 'pending'){
        setReceiveOrderMessage('Receipt is pending approval.');
      }else if(receiptStatus === 'received'){
        setReceiveOrderMessage('Receipt received. Inventory updated on confirmation.');
      }else if(receiptStatus === 'voided'){
        setReceiveOrderMessage('Receipt voided. Inventory unchanged.');
      }else if(receiptStatus === 'blocked_by_plan'){
        setReceiveOrderMessage(planBlocked
          ? 'Upgrade to enable receipt-based receiving.'
          : 'Draft receipt ready. Save or receive to update inventory.');
      }else if(receiptStatus === 'draft'){
        setReceiveOrderMessage('Draft receipt ready. Save or receive to update inventory.');
      }else{
        setReceiveOrderMessage('');
      }
      if(isPoTab && !isOrderMode){
        setReceiveOrderMessage('Select a purchase order to receive.');
      }
      if(planUpgrade){
        planUpgrade.style.display = receiptStatus === 'blocked_by_plan' ? '' : 'none';
      }

	      updateReceiveOrderWarning();
	      const saveBtn = $('btnReceiveOrderSave');
	      const completeBtn = $('btnReceiveOrderComplete');
	      const cancelBtn = $('btnReceiveOrderCancel');
	      const canSave = showDetailPanel && !isInboxMode && isEditable;
	      const canComplete = showDetailPanel && !isInboxMode && ((isDraftLike && canCompleteReceipt()) ||
	        (receiptStatus === 'pending' && canReceivingApprove()));
	      if(saveBtn) saveBtn.disabled = !canSave;
	      if(completeBtn) completeBtn.disabled = !canComplete;
	      if(cancelBtn) cancelBtn.disabled = false;
	    }
	    async function refreshReceiveOrderModal(poId){
	      const id = String(poId || '').trim();
	      if(!id) return;
	      const existingState = state._receiveOrder;
	      const existing = state._receiveOrder && state._receiveOrder.po ? state._receiveOrder.po : null;
	      const poRow = existing && String(existing.id || '').trim() === id ? existing : (getOrderHistoryRowById(id) || await sbFetchPurchaseOrderById(id));
	      let lineMap = state._orderHistoryLinesByPo && state._orderHistoryLinesByPo.get ? state._orderHistoryLinesByPo : new Map();
	      let poLines = lineMap.get(id) || null;
	      if(!poLines){
	        const fetched = await sbFetchPurchaseOrderLinesByPoIds([id]);
	        poLines = fetched.get(id) || [];
	      }
	      const { receipts, receiptLines } = await sbFetchReceiptDataForPo(id);
      const next = buildReceiveOrderState(poRow, poLines, receipts, receiptLines, {
        receiptId: existingState ? existingState.receiptId : '',
        receiptStatus: existingState ? existingState.receiptStatus : 'draft',
        receiptNotes: existingState ? existingState.receiptNotes : '',
        mode: 'order'
      });
      next.loading = false;
      next.attachments = [];
      next.attachmentsLoading = false;
      next.attachmentsError = '';
      next._attachmentsLoaded = false;
      next._attachmentsLoadedFor = '';
      state._receiveOrder = next;
      renderReceiveOrderModal();
      if(next.receiptId){
        void loadReceiptAttachments(next.receiptId);
      }
    }
	    async function ensureDraftReceiptId(receiveState){
	      if(receiveState.receiptId) return receiveState.receiptId;
	      const payload = { p_company_id: SB.companyId };
	      const poId = receiveState.po && receiveState.po.id ? receiveState.po.id : receiveState.poId;
	      if(poId) payload.p_purchase_order_id = poId;
	      const { data, error } = await SB.client.rpc('create_receipt', payload);
	      if(error) throw error;
	      if(data && data.success === false){
	        throw new Error(data.error || 'Failed to create receipt');
	      }
      const receiptId = data && (data.receipt_id || data.id) ? String(data.receipt_id || data.id).trim() : '';
      if(!receiptId) throw new Error('Failed to create receipt');
      const status = data && (data.status || data.receipt_status) ? String(data.status || data.receipt_status).trim() : 'draft';
      receiveState.receiptId = receiptId;
      receiveState.receiptStatus = normalizeReceiptStatus(status || 'draft');
      return receiptId;
    }
      async function saveReceiptNotes(receiveState, receiptId){
        if(!receiveState || !receiptId) return;
        const status = String(receiveState.receiptStatus || '').trim().toLowerCase();
        if(status && !isReceiptDraftLike(status)) return;
        const notes = String(receiveState.receiptNotes || '').trim();
        const last = String(receiveState._lastSavedNotes || '');
        if(notes === last) return;
        const companyId = receiveState.companyId || SB.companyId;
        const patch = {
          notes: notes ? notes : null,
          updated_at: new Date().toISOString(),
          updated_by: SB.user ? SB.user.id : null
        };
        let query = SB.client
          .from('receipts')
          .update(patch)
          .eq('id', receiptId);
        if(companyId){
          query = query.eq('company_id', companyId);
        }
        const { error } = await query;
        if(error) throw error;
        receiveState._lastSavedNotes = notes;
      }
      async function saveReceiptMeta(receiveState, receiptId){
        if(!receiveState || !receiptId) return;
        const status = String(receiveState.receiptStatus || '').trim().toLowerCase();
        if(status && !isReceiptDraftLike(status)) return;
        const companyId = receiveState.companyId || SB.companyId;
        const vendor = String(receiveState.receiptVendor || '').trim();
        const receiptDate = String(receiveState.receiptDate || '').trim();
        const total = parseReceiptNumber(receiveState.receiptTotal);
        const parsedLineItems = sanitizeParsedLineItems(receiveState.parsedLineItems);
        const metaPayload = {
          vendor_name: vendor || null,
          receipt_date: receiptDate || null,
          total: total,
          parsed_line_items: parsedLineItems,
        };
        const metaKey = JSON.stringify(metaPayload);
        if(metaKey === receiveState._lastSavedMetaKey) return;
        const patch = {
          ...metaPayload,
          updated_at: new Date().toISOString(),
          updated_by: SB.user ? SB.user.id : null,
        };
        let query = SB.client
          .from('receipts')
          .update(patch)
          .eq('id', receiptId);
        if(companyId){
          query = query.eq('company_id', companyId);
        }
        const { error } = await query;
        if(error) throw error;
        receiveState._lastSavedMetaKey = metaKey;
      }
	    async function saveReceiptLines(receiveState, opts = {}){
	      const lines = receiveState.lines || [];
	      const requireLine = !!opts.requireLine;
      const hasAny = lines.some(l => !l.disabled && (toInt(l.qty_received, 0) > 0 || toInt(l.qty_rejected, 0) > 0));
      if(requireLine && !hasAny) throw new Error('Enter at least one received or rejected quantity.');
      const receiptId = await ensureDraftReceiptId(receiveState);
      await saveReceiptMeta(receiveState, receiptId);
      await saveReceiptNotes(receiveState, receiptId);
      for(const line of lines){
	        if(line.disabled) continue;
	        if(!line.item_id) continue;
	        const qtyReceived = toInt(line.qty_received, 0);
	        const qtyRejected = toInt(line.qty_rejected, 0);
	        const reason = String(line.rejection_reason || '').trim();
	        if(qtyRejected > 0 && !reason){
	          throw new Error('Rejection reason required when rejecting items.');
	        }
	        const hasLineId = !!line.receipt_line_id;
	        const shouldPersist = hasLineId || qtyReceived > 0 || qtyRejected > 0;
	        if(!shouldPersist) continue;
	        if(hasLineId){
	          const { data, error } = await SB.client.rpc('update_receipt_line', {
	            p_receipt_id: receiptId,
	            p_line_id: line.receipt_line_id,
	            p_received_qty: qtyReceived,
	            p_rejected_qty: qtyRejected,
	            p_rejection_reason: reason || null,
	          });
	          if(error) throw error;
	          if(data && data.success === false){
	            throw new Error(data.error || 'Failed to update receipt line');
	          }
	        }else{
	          const { data, error } = await SB.client.rpc('add_receipt_line', {
	            p_receipt_id: receiptId,
	            p_item_id: line.item_id,
	            p_po_line_id: line.po_line_id || null,
	            p_expected_qty: (line.expected_qty === null || typeof line.expected_qty === 'undefined') ? null : toInt(line.expected_qty, 0),
	            p_received_qty: qtyReceived,
	            p_rejected_qty: qtyRejected,
	            p_rejection_reason: reason || null,
	            p_unit_cost: (line.unit_cost === null || typeof line.unit_cost === 'undefined') ? null : line.unit_cost,
	          });
	          if(error) throw error;
	          if(data && data.success === false){
	            throw new Error(data.error || 'Failed to add receipt line');
	          }
	          const lineId = data && (data.receipt_line_id || data.line_id || data.id) ? String(data.receipt_line_id || data.line_id || data.id).trim() : '';
	          if(lineId) line.receipt_line_id = lineId;
	        }
	      }
	      return receiptId;
	    }
	    function canCompleteReceipt(){
	      if(canReceivingApprove()) return true;
	      const tier = normalizeTier(getCompanyTier());
	      return tier === 'professional' && canReceivingEdit();
	    }
	    async function refreshInventoryAfterReceipt(receiveState){
	      const lines = receiveState && Array.isArray(receiveState.lines) ? receiveState.lines : [];
	      const itemIds = Array.from(new Set(lines.map(l => l && l.item_id ? String(l.item_id).trim() : '').filter(Boolean)));
	      if(itemIds.length){
	        try{
	          const inventoryMap = await sbFetchInventoryByItemIds(itemIds);
	          for(const [id, entry] of inventoryMap){
	            const item = state.items.find(x => x && String(x.id || '') === id);
	            if(item && entry && typeof entry.onHand !== 'undefined'){
	              item.qty = toInt(entry.onHand, 0);
	            }
	          }
	        }catch(e){}
	      }
	      try{ await ensureIncomingOrdersLoaded(true); }catch(e){}
	      try{ state._incomingByItemId = buildInventoryIncomingMap(); }catch(e){}
	      try{ refreshInventoryLayout(); }catch(e){}
	      try{ renderOrderHistoryFiltered(); }catch(e){}
	      try{
	        const jobsModal = $('jobsModal');
	        if(jobsModal && jobsModal.getAttribute('aria-hidden') === 'false'){
	          await refreshJobs();
	        }
	      }catch(e){}
	    }
	    async function handleSaveReceiptDraft(){
	      const ro = state._receiveOrder;
	      if(!ro) return;
	      if(!isReceiptDraftLike(String(ro.receiptStatus || '').trim().toLowerCase())){
	        toast('Receipt is locked');
	        return;
	      }
      if(!canReceivingEdit()){
        toast('Receipt edit permission required');
        return;
      }
      const btn = $('btnReceiveOrderSave');
      const labelEl = btn ? btn.querySelector('span') : null;
      const prior = labelEl ? labelEl.textContent : (btn ? btn.textContent : '');
      if(btn){
        btn.disabled = true;
        if(labelEl){
          labelEl.textContent = 'Saving...';
        }else{
          btn.textContent = 'Saving...';
        }
      }
      try{
        await saveReceiptLines(ro, { requireLine:false });
        toast('Draft saved', 'success');
        setReceiveOrderMessage('Draft saved.');
        scheduleMenuActionBadgeRefresh({ force: true });
      }catch(e){
        setReceiveOrderMessage(e && e.message ? e.message : 'Failed to save draft');
      }finally{
        if(btn){
          btn.disabled = false;
          if(labelEl){
            labelEl.textContent = prior || 'Save Draft';
          }else{
            btn.textContent = prior || 'Save Draft';
          }
        }
      }
    }
	    async function handleCompleteReceipt(){
	      const ro = state._receiveOrder;
	      if(!ro) return;
	      const status = String(ro.receiptStatus || '').trim().toLowerCase();
	      const draftLike = isReceiptDraftLike(status);
	      if(!draftLike && status !== 'pending'){
	        toast('Receipt is locked');
	        return;
	      }
	      if(!(draftLike ? canCompleteReceipt() : canReceivingApprove())){
	        toast('Receive receipt permission required');
	        return;
	      }
	      const ok = await openConfirmModal(
        'Confirm & receive inventory?',
        'Review before inventory is updated. Receipts are never received automatically.',
	        { okText:'Receive', cancelText:'Cancel' }
	      );
	      if(!ok) return;

	      const btn = $('btnReceiveOrderComplete');
	      const prior = btn ? btn.textContent : '';
	      if(btn){ btn.disabled = true; btn.textContent = 'Completingâ€¦'; }
	      try{
	        const receiptId = draftLike
	          ? await saveReceiptLines(ro, { requireLine:true })
	          : String(ro.receiptId || '').trim();
	        if(!receiptId) throw new Error('Receipt not found.');
	        const transitionToReceived = async () => {
          const { data, error } = await SB.client.rpc('transition_receipt_status', {
            p_receipt_id: receiptId,
            p_next_status: 'received'
          });
	          if(error) throw error;
	          if(data && data.success === false){
	            throw new Error(data.error || 'Failed to receive receipt');
	          }
	          return data || {};
	        };
	        try{
	          await transitionToReceived();
	        }catch(err){
	          const msg = err && err.message ? String(err.message) : '';
	          if(draftLike && canReceivingApprove()){
            const { data: pendData, error: pendErr } = await SB.client.rpc('transition_receipt_status', {
              p_receipt_id: receiptId,
              p_next_status: 'pending'
            });
	            if(pendErr) throw pendErr;
	            if(pendData && pendData.success === false){
	            throw new Error(pendData.error || 'Failed to submit receipt');
	          }
	            await transitionToReceived();
	          }else{
	            throw new Error(msg || 'Failed to receive receipt');
	          }
	        }
	        ro.receiptStatus = 'received';
	        toast('Receipt received');
	        setReceiveOrderMessage('Receipt received. Inventory updated on confirmation.');
	        await refreshInventoryAfterReceipt(ro);
	        if(ro.mode === 'order'){
	          await refreshReceiveOrderModal(ro.po && ro.po.id ? ro.po.id : ro.poId);
	        }else{
	          renderReceiveOrderModal();
	        }
        scheduleMenuActionBadgeRefresh({ force: true });
	      }catch(e){
	        setReceiveOrderMessage(e && e.message ? e.message : 'Failed to receive receipt');
	      }finally{
	        if(btn){ btn.disabled = false; btn.textContent = prior || 'Receive Receipt'; }
	      }
	    }
	    async function handleVoidReceipt(receiptId, btnEl){
	      const id = String(receiptId || '').trim();
	      if(!id) return;
	      if(!canReceivingVoid()){
	        toast('Void receipt permission required');
	        return;
	      }
	      let reasonInput = null;
	      try{
	        const sel = (window.CSS && CSS.escape)
	          ? `[data-void-receipt-reason="${CSS.escape(id)}"]`
	          : `[data-void-receipt-reason="${id}"]`;
	        reasonInput = document.querySelector(sel);
	      }catch(e){}
	      const voidReason = reasonInput ? String(reasonInput.value || '').trim() : '';
	      if(voidReason.length < 10){
	        toast('Void reason required (min 10 characters).');
	        if(reasonInput) reasonInput.focus();
	        return;
	      }
	      const ok = await openConfirmModal(
	        'Void receipt?',
	        'Voiding does not change inventory. Use a corrective receipt or manual adjustment for reversals.',
	        { okText:'Void', cancelText:'Cancel' }
	      );
	      if(!ok) return;
	      const btn = btnEl || null;
	      const prior = btn ? btn.textContent : '';
	      if(btn){
	        btn.disabled = true;
	        btn.textContent = 'Voidingâ€¦';
	      }
	      try{
        const { data, error } = await SB.client.rpc('transition_receipt_status', {
          p_receipt_id: id,
          p_next_status: 'voided',
          p_reason: voidReason
        });
	        if(error) throw error;
	        if(data && data.success === false){
	          throw new Error(data.error || 'Failed to void receipt');
	        }
	        toast('Receipt voided');
	        const ro = state._receiveOrder;
	        if(ro){
	          if(String(ro.receiptId || '') === id){
	            ro.receiptStatus = 'voided';
	          }
	          if(ro.mode === 'order'){
	            await refreshReceiveOrderModal(ro.po && ro.po.id ? ro.po.id : ro.poId);
	          }else{
	            renderReceiveOrderModal();
	          }
	        }
        scheduleMenuActionBadgeRefresh({ force: true });
	      }catch(e){
	        toast(e && e.message ? e.message : 'Failed to void receipt');
	      }finally{
	        if(btn && btn.isConnected){
	          btn.disabled = false;
	          btn.textContent = prior || 'Void';
	        }
	      }
	    }
	    function closeReceiveOrderModal(){
	      state._receiveOrder = null;
	      setReceiveOrderMessage('');
	      setReceiveOrderWarning('');
	      show('receiveOrderModal', false);
	    }
	    async function openReceiveOrderModal(orderId){
	      const id = String(orderId || '').trim();
	      if(!id) return;
	      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
	      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
	      if(!canReceiveOrders()){ toast('Receiving access required'); return; }

	      setReceiveOrderMessage('');
	      setReceiveOrderWarning('');
      state._receiveOrder = {
        mode: 'order',
        tab: 'po',
        companyId: SB.companyId ? String(SB.companyId) : '',
        poId: id,
        po: getOrderHistoryRowById(id),
        lines: [],
        receipts: [],
        receiptLines: [],
        receiptLinesByReceipt: new Map(),
        receiptId: '',
        receiptStatus: 'draft',
        receiptNotes: '',
        receiptVendor: '',
        receiptDate: '',
        receiptTotal: '',
        parsedLineItems: [],
        possibleDuplicate: false,
        manualSearch: '',
        loading:true,
        rawReceiptText: '',
        receiptSource: '',
        attachments: [],
        attachmentsLoading: false,
        attachmentsError: '',
        _attachmentsLoaded: false,
        _attachmentsLoadedFor: ''
      };
      show('receiveOrderModal', true);
      renderReceiveOrderModal();
      try{
        await ensureInventoryLoaded();
        await ensureIncomingOrdersLoaded();
        await loadDraftEmailReceipts();
        await ensureDraftReceiptId(state._receiveOrder);
        await refreshReceiveOrderModal(id);
      }catch(e){
        setReceiveOrderMessage(e && e.message ? e.message : 'Failed to load receipt data');
        renderReceiveOrderModal();
	      }
	    }

	    async function openReceiveInboxModal(){
	      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
	      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
	      if(!canAccessReceivingInbox()){ toast('Receiving access required'); return; }

	      setReceiveOrderMessage('');
	      setReceiveOrderWarning('');
      state._receiveOrder = {
        mode: 'inbox',
        tab: 'scanned',
        companyId: SB.companyId ? String(SB.companyId) : '',
        poId: '',
        po: null,
        lines: [],
        receipts: [],
        receiptLines: [],
        receiptLinesByReceipt: new Map(),
        receiptId: '',
        receiptStatus: 'draft',
        receiptNotes: '',
        receiptVendor: '',
        receiptDate: '',
        receiptTotal: '',
        parsedLineItems: [],
        possibleDuplicate: false,
        manualSearch: '',
        loading:true,
        rawReceiptText: '',
        receiptSource: '',
        attachments: [],
        attachmentsLoading: false,
        attachmentsError: '',
        _attachmentsLoaded: false,
        _attachmentsLoadedFor: ''
      };
      show('receiveOrderModal', true);
      renderReceiveOrderModal();
      try{
        await ensureInventoryLoaded();
        await ensureIncomingOrdersLoaded();
        await loadDraftEmailReceipts();
      }catch(e){
        setReceiveOrderMessage(e && e.message ? e.message : 'Failed to load receipts');
      }finally{
        if(state._receiveOrder) state._receiveOrder.loading = false;
	        renderReceiveOrderModal();
	      }
	    }

	    async function openReceivePendingModal(){
	      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
	      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
	      if(!canReceiveOrders()){ toast('Receiving access required'); return; }

	      setReceiveOrderMessage('');
	      setReceiveOrderWarning('');
      state._receiveOrder = {
        mode: 'manual',
        tab: 'po',
        companyId: SB.companyId ? String(SB.companyId) : '',
        poId: '',
        po: null,
        lines: [],
        receipts: [],
        receiptLines: [],
        receiptLinesByReceipt: new Map(),
        receiptId: '',
        receiptStatus: 'draft',
        receiptNotes: '',
        receiptVendor: '',
        receiptDate: '',
        receiptTotal: '',
        parsedLineItems: [],
        possibleDuplicate: false,
        manualSearch: '',
        loading:true,
        rawReceiptText: '',
        receiptSource: '',
        attachments: [],
        attachmentsLoading: false,
        attachmentsError: '',
        _attachmentsLoaded: false,
        _attachmentsLoadedFor: ''
      };
      show('receiveOrderModal', true);
      renderReceiveOrderModal();
      try{
        await ensureInventoryLoaded();
        await ensureIncomingOrdersLoaded();
        await loadDraftEmailReceipts();
      }catch(e){
        setReceiveOrderMessage(e && e.message ? e.message : 'Failed to load pending orders');
      }finally{
        if(state._receiveOrder) state._receiveOrder.loading = false;
        renderReceiveOrderModal();
      }
	    }

	    async function openReceiveManualModal(){
	      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
	      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
	      if(!canAccessReceivingInbox()){ toast('Receiving access required'); return; }
	      if(!canReceiveOrders()){
	        await openReceiveInboxModal();
	        return;
	      }

	      setReceiveOrderMessage('');
	      setReceiveOrderWarning('');
      state._receiveOrder = {
        mode: 'manual',
        tab: 'quick',
        companyId: SB.companyId ? String(SB.companyId) : '',
        poId: '',
        po: null,
        lines: [],
        receipts: [],
        receiptLines: [],
        receiptLinesByReceipt: new Map(),
        receiptId: '',
        receiptStatus: 'draft',
        receiptNotes: '',
        receiptVendor: '',
        receiptDate: '',
        receiptTotal: '',
        parsedLineItems: [],
        possibleDuplicate: false,
        manualSearch: '',
        loading:true,
        rawReceiptText: '',
        receiptSource: '',
        attachments: [],
        attachmentsLoading: false,
        attachmentsError: '',
        _attachmentsLoaded: false,
        _attachmentsLoadedFor: ''
      };
      show('receiveOrderModal', true);
      renderReceiveOrderModal();
      try{
        await ensureInventoryLoaded();
        await ensureIncomingOrdersLoaded();
        await loadDraftEmailReceipts();
        await ensureDraftReceiptId(state._receiveOrder);
        state._receiveOrder.loading = false;
        renderReceiveOrderModal();
      }catch(e){
        setReceiveOrderMessage(e && e.message ? e.message : 'Failed to create receipt');
	        state._receiveOrder.loading = false;
	        renderReceiveOrderModal();
	      }
	    }

	    function updateReceiveManualClearBtn(){
	      const inp = $('receiveManualSearch');
	      const btn = $('btnReceiveManualClear');
	      if(!inp || !btn) return;
	      const has = String(inp.value || '').length > 0;
	      btn.style.display = has ? 'flex' : 'none';
	      btn.disabled = !has;
	      btn.setAttribute('aria-hidden', has ? 'false' : 'true');
	    }

	    function renderReceiveManualResults(){
	      const ro = state._receiveOrder;
	      const wrap = $('receiveManualResults');
	      if(!wrap || !ro || ro.mode !== 'manual') return;
	      const term = String(ro.manualSearch || '').trim().toLowerCase();
	      if(!term){
	        wrap.innerHTML = `<div class="receive-search-empty">Search for items to add to this receipt.</div>`;
	        return;
	      }
	      const items = Array.isArray(state.items) ? state.items : [];
	      const existing = new Set((ro.lines || []).map(l => String(l && l.item_id ? l.item_id : '').trim()).filter(Boolean));
	      const matches = items.filter(it => {
	        const name = String(it && it.name ? it.name : '').toLowerCase();
	        const sku = String(it && it.sku ? it.sku : '').toLowerCase();
	        const desc = String(it && it.desc ? it.desc : '').toLowerCase();
	        return name.includes(term) || sku.includes(term) || desc.includes(term);
	      });
	      if(!matches.length){
	        wrap.innerHTML = `<div class="receive-search-empty">No matching items.</div>`;
	        return;
	      }
	      const status = String(ro.receiptStatus || '').trim().toLowerCase();
	      const canEdit = isReceiptDraftLike(status) && canReceivingEdit();
	      const max = 20;
	      wrap.innerHTML = matches.slice(0, max).map(it => {
	        const id = String(it && it.id ? it.id : '').trim();
	        if(!id) return '';
	        const name = String(it && it.name ? it.name : '').trim() || '(Unnamed item)';
	        const sku = String(it && it.sku ? it.sku : '').trim();
	        const onHand = formatQty(toInt(it && it.qty !== undefined ? it.qty : 0, 0));
	        const added = existing.has(id);
	        const disabled = added || !canEdit;
	        const btnLabel = !canEdit ? 'Locked' : (added ? 'Added' : 'Add');
	        const meta = [
	          sku ? `SKU: ${escapeHtml(sku)}` : '',
	          `On Hand: ${escapeHtml(onHand)}`
	        ].filter(Boolean).join(' â€¢ ');
	        return (
	          `<div class="receive-search-item">`+
	            `<div>`+
	              `<div class="receive-search-item-title" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</div>`+
	              `<div class="receive-search-item-meta">${meta}</div>`+
	            `</div>`+
	            `<button class="btn-tertiary btn-sm" type="button" data-receive-add-item-id="${escapeHtmlAttr(id)}"${disabled ? ' disabled aria-disabled="true"' : ''}>${escapeHtml(btnLabel)}</button>`+
	          `</div>`
	        );
	      }).join('');
	    }

	    async function addManualReceiveLine(itemId){
	      const ro = state._receiveOrder;
	      if(!ro || ro.mode !== 'manual') return;
	      const status = String(ro.receiptStatus || '').trim().toLowerCase();
	      if(!isReceiptDraftLike(status)){
	        toast('Receipt is locked');
	        return;
	      }
	      const id = String(itemId || '').trim();
	      if(!id) return;
	      if(ro.lines && ro.lines.some(l => String(l && l.item_id ? l.item_id : '').trim() === id)) return;
	      const item = getInventoryById(id);
	      if(!item){
	        toast('Item not found', 'error');
	        return;
	      }
	      const newLine = {
	        key: `manual-${id}`,
	        item_id: id,
	        item_name: String(item.name || '').trim(),
	        item_sku: String(item.sku || '').trim(),
	        ordered_qty: 0,
	        expected_qty: null,
	        prev_received: 0,
	        remaining_qty: null,
	        qty_received: 0,
	        qty_rejected: 0,
	        rejection_reason: '',
	        receipt_line_id: '',
	        po_line_id: '',
	        unit_cost: null,
	        disabled: false
	      };
	      ro.lines = Array.isArray(ro.lines) ? ro.lines.concat([newLine]) : [newLine];
	      ro.lines.sort((a, b) => toKey(a.item_name || '').localeCompare(toKey(b.item_name || '')));
	      renderReceiveOrderModal();
	      try{
	        const receiptId = await ensureDraftReceiptId(ro);
	        const { data, error } = await SB.client.rpc('add_receipt_line', {
	          p_receipt_id: receiptId,
	          p_item_id: id,
	          p_received_qty: 0,
	          p_rejected_qty: 0
	        });
	        if(error) throw error;
	        if(data && data.success === false){
	          throw new Error(data.error || 'Failed to add receipt line');
	        }
	        const lineId = data && (data.receipt_line_id || data.line_id || data.id) ? String(data.receipt_line_id || data.line_id || data.id).trim() : '';
	        if(lineId) newLine.receipt_line_id = lineId;
	      }catch(e){
	        ro.lines = ro.lines.filter(l => l !== newLine);
	        renderReceiveOrderModal();
	        toast(e && e.message ? e.message : 'Failed to add receipt line');
	      }
	    }

	    async function handleOrderReceiptButtonClick(orderId, btnEl){
	      const id = String(orderId || '').trim();
	      if(!id) return;
	      const row = getOrderHistoryRowById(id);
	      const totals = getPurchaseOrderLineTotalsById(id);
	      if(row) applyPurchaseOrderLineTotals(row, totals);
	      const receiveState = getPurchaseOrderReceiveState(row || {}, totals);
	      if(receiveState === 'draft'){
	        toast('Draft orders cannot be received');
	        return;
	      }
	      if(receiveState === 'cancelled' || receiveState === 'closed' || receiveState === 'voided'){
	        toast('This order is closed and cannot be received');
	        return;
	      }
	      if(totals.hasLines && totals.remaining <= 0){
	        toast('All quantities have been received');
	        return;
	      }
	      if(btnEl){
	        btnEl.disabled = true;
	      }
	      try{
	        await openReceiveOrderModal(id);
	      }finally{
	        if(btnEl){
	          btnEl.disabled = false;
	        }
	      }
	    }

	    function orderHistoryStatusClass(receiveState){
	      const stateKey = String(receiveState || '').trim().toLowerCase();
	      if(stateKey === 'partially_received') return 'status-pill--partial';
	      if(stateKey === 'fully_received') return 'status-pill--received';
	      if(stateKey === 'submitted') return 'status-pill--submitted';
	      if(stateKey === 'draft') return 'status-pill--draft';
	      if(stateKey === 'cancelled' || stateKey === 'closed' || stateKey === 'voided') return 'status-pill--closed';
	      return 'status-pill--draft';
	    }
	    function orderHistoryStatusLabel(receiveState, orderRow, totals){
	      const stateKey = String(receiveState || '').trim().toLowerCase();
	      if(stateKey === 'partially_received') return 'Partial';
	      if(stateKey === 'fully_received') return 'Received';
	      if(stateKey === 'submitted') return 'Submitted';
	      if(stateKey === 'draft') return 'Draft';
	      if(stateKey === 'cancelled') return 'Cancelled';
	      if(stateKey === 'closed') return 'Closed';
	      if(stateKey === 'voided') return 'Voided';
	      return formatPurchaseOrderStatusLabel(orderRow, totals) || '';
	    }
	    function formatOrderHistoryId(orderRow){
	      const raw = String(orderRow && (orderRow.po_number || orderRow.company_po_number || orderRow.internal_po_number || orderRow.internalPoNumber) || '').trim();
	      if(raw){
	        const lower = raw.toLowerCase();
	        if(lower.startsWith('po')) return raw;
	        return `PO-${raw}`;
	      }
	      const fallback = String(orderRow && orderRow.id ? orderRow.id : '').trim();
	      return fallback ? `PO-${shortId(fallback)}` : 'PO';
	    }
	    function renderOrderHistoryList(list, opts = {}){
	      const wrap = $('orderHistoryList');
	      if(!wrap) return;
	      const rows = Array.isArray(list) ? list : [];
	      if(!rows.length){
	        const emptyText = (opts && typeof opts.emptyText === 'string' && opts.emptyText.trim())
	          ? opts.emptyText.trim()
	          : 'No orders yet.';
	        const subText = emptyText.toLowerCase().includes('matching')
	          ? 'Try adjusting your filters.'
	          : 'Orders you send will appear here.';
	        wrap.innerHTML =
	          `<div class="order-history-empty">`+
	            `<div class="order-history-empty-title">${escapeHtml(emptyText)}</div>`+
	            `<div class="order-history-empty-text">${escapeHtml(subText)}</div>`+
	          `</div>`;
	        return;
	      }
	      const expanded = state._orderHistoryExpanded || new Set();
	      const lineMap = state._orderHistoryLinesByPo || new Map();
	      const calendarIcon =
	        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
	          '<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>'+
	          '<line x1="16" y1="2" x2="16" y2="6"></line>'+
	          '<line x1="8" y1="2" x2="8" y2="6"></line>'+
	          '<line x1="3" y1="10" x2="21" y2="10"></line>'+
	        '</svg>';
	      const linkIcon =
	        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
	          '<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>'+
	          '<path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>'+
	        '</svg>';
	      const mailIcon =
	        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
	          '<path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>'+
	          '<polyline points="22,6 12,13 2,6"></polyline>'+
	        '</svg>';
	      const locationIcon =
	        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
	          '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>'+
	          '<circle cx="12" cy="10" r="3"></circle>'+
	        '</svg>';
	      const notesIcon =
	        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
	          '<line x1="17" y1="10" x2="3" y2="10"></line>'+
	          '<line x1="21" y1="6" x2="3" y2="6"></line>'+
	          '<line x1="21" y1="14" x2="3" y2="14"></line>'+
	          '<line x1="17" y1="18" x2="3" y2="18"></line>'+
	        '</svg>';
	      const receiveIcon = ICONS.package;
	      const resendIcon = mailIcon;
	      const editIcon = ICONS.pencil;
	      const chevronIcon = ICONS.chevronDown;

	      wrap.innerHTML = rows.map(o => {
	        const orderId = String(o && o.id ? o.id : '').trim();
	        if(!orderId) return '';
	        const items = normalizePurchaseOrderLines(lineMap.get(orderId) || []);
	        const itemCountLabel = `${items.length} item${items.length === 1 ? '' : 's'}`;
	        const orderDate = formatDateShort(o.order_date || o.created_at || '');
	        const relatedJobs = Array.isArray(o.related_job_numbers)
	          ? o.related_job_numbers.map(n => String(n || '').trim()).filter(Boolean)
	          : [];
	        const jobLabel = relatedJobs.length > 1
	          ? `${relatedJobs[0]} +${relatedJobs.length - 1}`
	          : (relatedJobs[0] || '');

	        const metaParts = [];
	        if(orderDate){
	          metaParts.push(`<span class="po-card-meta-item">${calendarIcon}${escapeHtml(orderDate)}</span>`);
	        }
	        if(itemCountLabel){
	          metaParts.push(`<span class="po-card-meta-item">${escapeHtml(itemCountLabel)}</span>`);
	        }
	        if(jobLabel){
	          metaParts.push(`<span class="po-card-meta-item">${linkIcon}${escapeHtml(jobLabel)}</span>`);
	        }

	        const totals = getPurchaseOrderLineTotalsById(orderId, lineMap);
	        applyPurchaseOrderLineTotals(o, totals);
	        const receiveState = getPurchaseOrderReceiveState(o, totals);
	        const statusLabel = orderHistoryStatusLabel(receiveState, o, totals);
	        const statusClass = orderHistoryStatusClass(receiveState);

	        const vendor = String(o.vendor_name || (o.vendor && o.vendor.name) || o.vendor_id || '').trim() || 'Unknown vendor';
	        const sentToText = formatOrderSentToLabel(o, vendor);
	        const shipToHtml = formatOrderShipToHtml(o);
	        const notes = String(o.notes || '').trim();

	        const canPermission = canReceiveOrders();
	        const remainingTotal = totals.remaining;
	        const canReceipt = canPermission &&
	          receiveState !== 'draft' &&
	          receiveState !== 'cancelled' &&
	          receiveState !== 'closed' &&
	          receiveState !== 'voided' &&
	          remainingTotal > 0;
	        const receiveBtnTitle = !canPermission
	          ? 'Receiving not allowed'
	          : (receiveState === 'draft'
	            ? 'Draft orders cannot be received'
	            : (remainingTotal <= 0 ? 'All items received' : 'Receive Order'));

	        const linesHtml = items.length ? (
	          `<div class="po-lines-table">`+
	            `<div class="po-line-row po-line-row--header">`+
	              `<span>Item</span>`+
	              `<span style="text-align:center">Ordered</span>`+
	              `<span style="text-align:center">Received</span>`+
	              `<span style="text-align:center">Remaining</span>`+
	            `</div>`+
	            items.map(line => {
	              const ordered = toQty(line.quantity_ordered, 0);
	              const received = toQty(line.quantity_received, 0);
	              const remaining = Math.max(0, ordered - received);
	              return (
	                `<div class="po-line-row">`+
	                  `<div class="po-line-item">`+
	                    `<div class="po-line-name" title="${escapeHtmlAttr(line.item_name || '(Unnamed item)')}">${escapeHtml(line.item_name || '(Unnamed item)')}</div>`+
	                    `<div class="po-line-sku">${escapeHtml(line.item_sku || '')}</div>`+
	                  `</div>`+
	                  `<span class="po-line-value">${escapeHtml(formatQty(ordered))}</span>`+
	                  `<span class="po-line-value po-line-value--muted">${escapeHtml(formatQty(received))}</span>`+
	                  `<span class="po-line-value po-line-value--amber">${escapeHtml(formatQty(remaining))}</span>`+
	                `</div>`
	              );
	            }).join('')+
	          `</div>`
	        ) : `<div class="po-lines-empty">No line items yet.</div>`;

	        const detailsSent = sentToText ? escapeHtml(sentToText) : '<span class="muted">Not set</span>';
	        const detailsShip = shipToHtml ? shipToHtml : '<span class="muted">Not set</span>';
	        const detailsNotes = notes ? escapeHtml(notes) : '<span class="muted">No notes</span>';

	        return (
	          `<div class="po-card${expanded.has(orderId) ? ' is-expanded' : ''}" data-order-history-card="${escapeHtmlAttr(orderId)}">`+
	            `<div class="po-card-header" data-order-history-toggle="${escapeHtmlAttr(orderId)}">`+
	              `<div class="po-card-icon">${ICONS.package}</div>`+
	              `<div class="po-card-info">`+
	                `<div class="po-card-title">`+
	                  `<span class="po-card-id">${escapeHtml(formatOrderHistoryId(o))}</span>`+
	                  `<span class="po-card-vendor">â€¢ ${escapeHtml(vendor)}</span>`+
	                `</div>`+
	                `<div class="po-card-meta">${metaParts.join('')}</div>`+
	              `</div>`+
	              (statusLabel ? `<span class="status-pill ${escapeHtmlAttr(statusClass)}">${escapeHtml(statusLabel)}</span>` : '')+
	              `<button class="po-card-expand" type="button" data-order-history-toggle="${escapeHtmlAttr(orderId)}" aria-label="Toggle order details">`+
	                chevronIcon+
	              `</button>`+
	            `</div>`+
	            `<div class="po-card-body">`+
	              `<div class="po-quick-actions">`+
	                `<button class="po-action-btn po-action-btn--primary" type="button" data-receive-order-id="${escapeHtmlAttr(orderId)}" title="${escapeHtmlAttr(receiveBtnTitle)}"${canReceipt ? '' : ' disabled'}>`+
	                  receiveIcon+
	                  `<span>Receive</span>`+
	                `</button>`+
	                `<button class="po-action-btn" type="button" disabled title="Resend coming soon">`+
	                  resendIcon+
	                  `<span>Resend</span>`+
	                `</button>`+
	                `<button class="po-action-btn" type="button" disabled title="Edit coming soon">`+
	                  editIcon+
	                  `<span>Edit</span>`+
	                `</button>`+
	              `</div>`+
	              `<div class="po-details">`+
	                `<div class="po-detail">`+
	                  `<div class="po-detail-icon">${mailIcon}</div>`+
	                  `<div class="po-detail-content">`+
	                    `<div class="po-detail-label">Sent to</div>`+
	                    `<div class="po-detail-value">${detailsSent}</div>`+
	                  `</div>`+
	                `</div>`+
	                `<div class="po-detail">`+
	                  `<div class="po-detail-icon">${locationIcon}</div>`+
	                  `<div class="po-detail-content">`+
	                    `<div class="po-detail-label">Ship to</div>`+
	                    `<div class="po-detail-value">${detailsShip}</div>`+
	                  `</div>`+
	                `</div>`+
	                `<div class="po-detail po-detail--full">`+
	                  `<div class="po-detail-icon">${notesIcon}</div>`+
	                  `<div class="po-detail-content">`+
	                    `<div class="po-detail-label">Notes</div>`+
	                    `<div class="po-detail-value">${detailsNotes}</div>`+
	                  `</div>`+
	                `</div>`+
	              `</div>`+
	              `<div class="po-lines-header">`+
	                `<span class="po-lines-title">Line Items</span>`+
	                `<span class="po-lines-count">${escapeHtml(itemCountLabel)}</span>`+
	              `</div>`+
	              linesHtml+
	              `<div class="po-receipts-section">`+
	                `<div class="po-receipts-header">`+
	                  `<span class="po-receipts-title">`+
	                    `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
	                      `<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>`+
	                      `<polyline points="14 2 14 8 20 8"></polyline>`+
	                    `</svg>`+
	                    `Linked Receipts`+
	                  `</span>`+
	                `</div>`+
	                `<div class="no-receipts">No receipts linked to this order yet</div>`+
	              `</div>`+
	            `</div>`+
	          `</div>`
	        );
	      }).join('');
	    }
	    function orderHistorySearchText(orderRow){
	      const o = orderRow || {};
	      const createdAt = String(o.created_at || '').trim();
	      const orderDate = String(formatDateShort(o.order_date || '') || '').trim();
	      const expectedDate = String(formatDateShort(o.expected_date || '') || '').trim();
	      const receivedDate = String(formatDateShort(o.received_date || '') || '').trim();
	      const subject = orderSubjectFromRow(o);
	      const notes = String(o.notes || '').trim();
	      const id = String(o.id || '').trim();
	      const poNumber = String(o.po_number || '').trim();
	      const companyPo = String(o.company_po_number || '').trim();
	      const internalPo = String(o.internal_po_number || o.internalPoNumber || '').trim();
	      const status = String(o.status || '').trim();
	      const vendor = String(o.vendor_name || (o.vendor && o.vendor.name) || o.vendor_id || '').trim();
	      const recipientEmail = String(o.recipient_email || o.recipientEmail || '').trim();
	      const shipToText = formatShippingSnapshotLines(getOrderShippingSnapshotFromRow(o)).join(' ');
	      const jobs = Array.isArray(o.related_job_numbers) ? o.related_job_numbers.join(' ') : '';
	      const lineMap = state._orderHistoryLinesByPo || new Map();
	      const items = normalizePurchaseOrderLines(lineMap.get(id) || []);
	      const itemText = items.map(it => `${it.item_name} ${it.item_sku} ${formatQty(it.quantity_ordered)}`).join(' ');
	      return `${id} ${poNumber} ${companyPo} ${internalPo} ${status} ${orderDate} ${expectedDate} ${receivedDate} ${createdAt} ${subject} ${vendor} ${recipientEmail} ${shipToText} ${notes} ${jobs} ${itemText}`.toLowerCase();
	    }
	    function normalizeOrderHistoryStatusFilter(list){
	      if(!Array.isArray(list)) return [];
	      const out = [];
	      list.forEach(entry=>{
	        const key = normalizePurchaseOrderStatus(entry);
	        if(!key) return;
	        if(!out.includes(key)) out.push(key);
	      });
	      return out;
	    }
	    function setOrderHistoryStatusFilter(list){
	      state._orderHistoryStatusFilter = normalizeOrderHistoryStatusFilter(list);
	    }
	    function renderOrderHistoryFiltered(){
	      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
	      const statusFilter = Array.isArray(state._orderHistoryStatusFilter)
	        ? state._orderHistoryStatusFilter.filter(Boolean)
	        : [];
	      const raw = String(state._orderHistoryFilter || '').trim().toLowerCase();
	      let filtered = rows;
	      if(statusFilter.length){
	        const lineMap = state._orderHistoryLinesByPo || new Map();
	        filtered = filtered.filter(row => {
	          const id = row && row.id ? String(row.id) : '';
	          if(!id) return false;
	          const totals = getPurchaseOrderLineTotalsById(id, lineMap);
	          const receiveState = getPurchaseOrderReceiveState(row, totals);
	          return statusFilter.includes(receiveState);
	        });
	      }
	      if(!raw){
	        renderOrderHistoryList(filtered, { emptyText: 'No orders yet.' });
	        return;
	      }
	      const tokens = raw.split(/\s+/g).filter(Boolean);
	      const out = filtered.filter(r => {
	        const hay = orderHistorySearchText(r);
	        return tokens.every(t => hay.includes(t));
	      });
	      renderOrderHistoryList(out, { emptyText: 'No matching orders.' });
	    }
	    const ORDER_HISTORY_TABS = ['orders', 'receipts'];
	    function getOrderHistoryActiveTab(){
	      const tab = String(state._orderHistoryTab || '').trim();
	      return ORDER_HISTORY_TABS.includes(tab) ? tab : 'orders';
	    }
	    function applyOrderHistoryTabState(tab){
	      const root = $('orderHistoryModal');
	      if(!root) return;
	      root.querySelectorAll('[data-order-history-tab]').forEach(btn=>{
	        const key = String(btn.dataset.orderHistoryTab || '').trim();
	        const active = key === tab;
	        btn.classList.toggle('is-active', active);
	        btn.setAttribute('aria-selected', active ? 'true' : 'false');
	      });
	      root.querySelectorAll('[data-order-history-panel]').forEach(panel=>{
	        const key = String(panel.dataset.orderHistoryPanel || '').trim();
	        panel.classList.toggle('is-active', key === tab);
	      });
	    }
	    function updateOrderHistoryTabBadges(){
	      const ordersBadge = $('orderHistoryOrdersBadge');
	      const ordersCount = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows.length : 0;
	      if(ordersBadge) ordersBadge.textContent = String(ordersCount);
	      const receiptsBadge = $('orderHistoryReceiptsBadge');
	      const receiptsCount = Number.isFinite(state._orderHistoryReceiptsCount)
	        ? state._orderHistoryReceiptsCount
	        : (Array.isArray(state._orderHistoryReceipts) ? state._orderHistoryReceipts.length : 0);
	      if(receiptsBadge) receiptsBadge.textContent = String(receiptsCount);
	    }
	    async function handleOrderHistoryTabClick(tab){
	      const next = String(tab || '').trim();
	      if(!next) return;
	      const current = getOrderHistoryActiveTab();
	      if(next === current) return;
	      state._orderHistoryTab = next;
	      applyOrderHistoryTabState(next);
	      if(next === 'receipts'){
	        if(!state._orderHistoryReceiptsLoaded){
	          await refreshOrderHistoryReceipts();
	        }else{
	          renderOrderHistoryReceiptsFiltered();
	        }
	      }
	    }
	    function orderHistoryReceiptSearchText(receiptRow){
	      const r = receiptRow || {};
	      const id = String(r.id || r.receipt_id || '').trim();
	      const vendor = String(r.vendor_name || '').trim();
	      const company = String(r.company_name || r.company_slug || '').trim();
	      const status = String(r.status || '').trim();
	      const source = String(r.receipt_source || '').trim();
	      const date = String(r.receipt_date || '').trim();
	      const total = (r.total !== undefined && r.total !== null) ? String(r.total) : '';
	      return `${id} ${vendor} ${company} ${status} ${source} ${date} ${total}`.toLowerCase();
	    }
	    function getOrderHistoryReceiptsFilteredRows(){
	      const rows = Array.isArray(state._orderHistoryReceipts) ? state._orderHistoryReceipts : [];
	      const raw = String(state._orderHistoryReceiptsFilter || '').trim().toLowerCase();
	      if(!raw) return rows;
	      const tokens = raw.split(/\s+/g).filter(Boolean);
	      return rows.filter(r => {
	        const hay = orderHistoryReceiptSearchText(r);
	        return tokens.every(t => hay.includes(t));
	      });
	    }
	    function renderOrderHistoryReceiptsList(list, opts = {}){
	      const wrap = $('orderHistoryReceiptsList');
	      if(!wrap) return;
	      const rows = Array.isArray(list) ? list : [];
	      if(!rows.length){
	        const emptyText = (opts && typeof opts.emptyText === 'string' && opts.emptyText.trim())
	          ? opts.emptyText.trim()
	          : 'No receipts yet.';
	        const subText = emptyText.toLowerCase().includes('matching')
	          ? 'Try adjusting your filters.'
	          : 'Receipts will appear here once received.';
	        wrap.innerHTML =
	          `<div class="order-history-empty">`+
	            `<div class="order-history-empty-title">${escapeHtml(emptyText)}</div>`+
	            `<div class="order-history-empty-text">${escapeHtml(subText)}</div>`+
	          `</div>`;
	        return;
	      }
	      const scannedIcon =
	        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
	          '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>'+
	          '<polyline points="14 2 14 8 20 8"></polyline>'+
	          '<line x1="16" y1="13" x2="8" y2="13"></line>'+
	          '<line x1="16" y1="17" x2="8" y2="17"></line>'+
	        '</svg>';
	      const manualIcon = ICONS.pencil;
	      const poIcon =
	        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
	          '<path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>'+
	          '<rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>'+
	          '<path d="M9 14l2 2 4-4"></path>'+
	        '</svg>';
	      const arrowIcon = ICONS.chevronRight;
	      const showCompany = isEffectiveSuperUser();

	      wrap.innerHTML = rows.map(r => {
	        const id = String(r.id || r.receipt_id || '').trim();
	        if(!id) return '';
	        const companyId = String(r.company_id || '').trim();
	        const vendor = String(r.vendor_name || '').trim() || 'Unknown vendor';
	        const companyLabel = String(r.company_name || r.company_slug || r.company_id || '').trim();
	        const dateText = r.receipt_date ? formatDateShort(r.receipt_date) : (r.created_at ? formatDateShort(r.created_at) : '');
	        const totalText = formatReceiptMoney(r.total);
	        const sourceLabel = formatReceiptSourceLabel(r.receipt_source) || 'Receipt';
        const source = String(r.receipt_source || '').toLowerCase();

	        let iconClass = 'receipt-card-icon--scanned';
	        let iconSvg = scannedIcon;
	        let tagClass = 'receipt-card-tag--standalone';
	        let tagLabel = sourceLabel || 'Scanned';
	        if(source.includes('manual') || source.includes('quick')){
	          iconClass = 'receipt-card-icon--manual';
	          iconSvg = manualIcon;
	          tagClass = 'receipt-card-tag--manual';
	          tagLabel = 'Quick Add';
	        }else if(source.includes('po') || source.includes('order')){
	          iconClass = 'receipt-card-icon--po';
	          iconSvg = poIcon;
	          tagClass = 'receipt-card-tag--po';
	          tagLabel = 'PO Receipt';
	        }else if(source.includes('email') || source.includes('pdf') || source.includes('image')){
	          iconClass = 'receipt-card-icon--scanned';
	          iconSvg = scannedIcon;
	          tagClass = 'receipt-card-tag--standalone';
	          tagLabel = sourceLabel || 'Scanned';
	        }

	        const metaParts = [];
	        if(showCompany && companyLabel){
	          metaParts.push(`<span>${escapeHtml(companyLabel)}</span>`);
	        }
	        if(dateText){
	          metaParts.push(`<span>${escapeHtml(dateText)}</span>`);
	        }
	        if(totalText){
	          metaParts.push(`<span>Total ${escapeHtml(totalText)}</span>`);
	        }
	        if(tagLabel){
	          metaParts.push(`<span class="receipt-card-tag ${escapeHtmlAttr(tagClass)}">${escapeHtml(tagLabel)}</span>`);
	        }

	        return (
	          `<div class="receipt-card" data-receipt-review-id="${escapeHtmlAttr(id)}" data-receipt-company-id="${escapeHtmlAttr(companyId)}">`+
	            `<div class="receipt-card-icon ${escapeHtmlAttr(iconClass)}">${iconSvg}</div>`+
	            `<div class="receipt-card-info">`+
	              `<div class="receipt-card-title">${escapeHtml(vendor)}</div>`+
	              `<div class="receipt-card-meta">${metaParts.join('')}</div>`+
	            `</div>`+
	            `<span class="receipt-card-arrow">${arrowIcon}</span>`+
	          `</div>`
	        );
	      }).join('');
	    }
	    function renderOrderHistoryReceiptsFiltered(){
	      const rows = getOrderHistoryReceiptsFilteredRows();
	      const emptyText = String(state._orderHistoryReceiptsFilter || '').trim()
	        ? 'No matching receipts.'
	        : 'No receipts yet.';
	      renderOrderHistoryReceiptsList(rows, { emptyText });
	    }
	    async function sbFetchOrderHistoryReceipts(limit = 60){
	      if(!SB.ready) throw new Error('Supabase not configured');
	      if(!SB.session) throw new Error('Sign in required');
	      if(!SB.authorized) throw new Error('Not authorized');
	      const query = SB.client
	        .from('receipts_with_company')
	        .select('receipt_id,company_id,company_name,company_slug,vendor_name,receipt_date,total,receipt_source,status,created_at', { count: 'exact' })
	        .order('created_at', { ascending: false })
	        .limit(limit);
	      if(!isEffectiveSuperUser()){
	        if(!SB.companyId) return { rows: [], count: 0 };
	        query.eq('company_id', SB.companyId);
	      }
	      const { data, error, count } = await query;
	      if(error) throw error;
	      const rows = Array.isArray(data)
	        ? data.map(row => ({
	            id: row.receipt_id,
	            receipt_id: row.receipt_id,
	            company_id: row.company_id,
	            company_name: row.company_name,
	            company_slug: row.company_slug,
	            vendor_name: row.vendor_name,
	            receipt_date: row.receipt_date,
	            total: row.total,
	            receipt_source: row.receipt_source,
	            status: row.status,
	            created_at: row.created_at,
	          }))
	        : [];
	      return { rows, count: Number.isFinite(count) ? count : rows.length };
	    }
	    async function sbDeleteReceipts(receiptIds, force){
	      if(!SB.ready) throw new Error('Supabase not configured');
	      if(!SB.session) throw new Error('Sign in required');
	      if(!SB.authorized) throw new Error('Not authorized');
	      const ids = Array.isArray(receiptIds) ? receiptIds.filter(Boolean) : [];
	      if(!ids.length) return null;
	      const { data, error } = await SB.client.rpc('delete_receipts', {
	        p_receipt_ids: ids,
	        p_force: !!force
	      });
	      if(error) throw error;
	      return data;
	    }
	    async function refreshOrderHistoryReceipts(){
	      const wrap = $('orderHistoryReceiptsList');
	      if(wrap){
	        wrap.innerHTML =
	          `<div class="order-history-empty">`+
	            `<div class="order-history-empty-title">Loading receiptsâ€¦</div>`+
	            `<div class="order-history-empty-text">Fetching latest receipts.</div>`+
	          `</div>`;
	      }
	      try{
	        const result = await sbFetchOrderHistoryReceipts(60);
	        const rows = result && Array.isArray(result.rows) ? result.rows : [];
	        state._orderHistoryReceipts = rows;
	        state._orderHistoryReceiptsCount = Number.isFinite(result && result.count) ? result.count : rows.length;
	        state._orderHistoryReceiptsLoaded = true;
	        renderOrderHistoryReceiptsFiltered();
	      }catch(e){
	        state._orderHistoryReceipts = [];
	        state._orderHistoryReceiptsCount = 0;
	        state._orderHistoryReceiptsLoaded = true;
	        const msg = e && e.message ? e.message : 'Failed to load receipts';
	        if(wrap){
	          wrap.innerHTML =
	            `<div class="order-history-empty">`+
	              `<div class="order-history-empty-title">${escapeHtml(msg)}</div>`+
	              `<div class="order-history-empty-text">Try again in a moment.</div>`+
	            `</div>`;
	        }
	      }finally{
	        updateOrderHistoryTabBadges();
	      }
	    }
		    let _orderSuggestTimer = null;
		    function renderOrderEmailSuggestions(list){
		      const wrap = $('orderEmailSuggest');
		      if(!wrap) return;
	      wrap.innerHTML = '';
	      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
	      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
	      wrap.classList.add('has-suggest');
	      rows.forEach(r=>{
	        const btn = document.createElement('button');
	        btn.type = 'button';
	        btn.className = 'suggest-chip';
	        btn.dataset.suggestEmail = String(r.email);
	        btn.textContent = String(r.email);
	        wrap.appendChild(btn);
	      });
	    }
	    function hideOrderEmailSuggestions(){
	      if(_orderSuggestTimer){ clearTimeout(_orderSuggestTimer); _orderSuggestTimer = null; }
	      renderOrderEmailSuggestions([]);
	    }
    function orderNonEmpty(value){
      const s = String(value || '').trim();
      return s ? s : '';
    }
	    function requestOrderEmailSuggestions(prefix){
	      if(_orderSuggestTimer) clearTimeout(_orderSuggestTimer);
	      const q = String(prefix||'');
	      _orderSuggestTimer = setTimeout(async ()=>{
	        const wrap = $('orderEmailSuggest');
	        const inp = $('orderEmail');
	        const ae = document.activeElement;
	        const allow = (inp && ae === inp) || (wrap && ae && wrap.contains(ae));
	        if(!allow){ hideOrderEmailSuggestions(); return; }
	        try{
	          const data = await sbFetchOrderRecipientSuggestions(q);
	          // If focus moved away while we awaited, don't reopen the list.
	          const wrap2 = $('orderEmailSuggest');
	          const inp2 = $('orderEmail');
	          const ae2 = document.activeElement;
	          const allow2 = (inp2 && ae2 === inp2) || (wrap2 && ae2 && wrap2.contains(ae2));
	          if(!allow2){ hideOrderEmailSuggestions(); return; }
	          renderOrderEmailSuggestions(data);
	        }catch{
	          renderOrderEmailSuggestions([]);
	        }
	      }, 160);
	    }

    const _forwardSuggestTimers = new Map();
    function renderForwardEmailSuggestions(orderId, list){
      const id = String(orderId || '').trim();
      if(!id) return;
      const wrap = document.querySelector(`[data-forward-suggest-id="${id}"]`);
      if(!wrap) return;
      wrap.innerHTML = '';
      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
      wrap.classList.add('has-suggest');
      rows.forEach(r=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggest-chip';
        btn.dataset.forwardSuggestEmail = String(r.email);
        btn.textContent = String(r.email);
        wrap.appendChild(btn);
      });
    }
    function requestForwardEmailSuggestions(orderId, prefix){
      const id = String(orderId || '').trim();
      if(!id) return;
      const prev = _forwardSuggestTimers.get(id);
      if(prev) clearTimeout(prev);
      const q = String(prefix||'');
      const t = setTimeout(async ()=>{
        try{
          const data = await sbFetchOrderRecipientSuggestions(q);
          renderForwardEmailSuggestions(id, data);
        }catch{
          renderForwardEmailSuggestions(id, []);
        }
      }, 160);
      _forwardSuggestTimers.set(id, t);
    }
    async function forwardOrderFromHistory(orderId){
      const id = String(orderId || '').trim();
      if(!id) return;
      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }

      const row = state._orderHistoryById && typeof state._orderHistoryById.get === 'function'
        ? (state._orderHistoryById.get(id) || null)
        : null;
      if(!row){ toast('Order not found'); return; }

      const input = document.querySelector(`[data-forward-email-id="${id}"]`);
      const to = String(input && input.value ? input.value : '').trim();
      if(!looksLikeEmailAddress(to)){ toast('Enter a valid email'); return; }

      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Sendingâ€¦'; }

      try{
        const subjectLine = orderSubjectFromRow(row);
        const notes = String(row.notes||'').trim();
        const lineItems = Array.isArray(row.line_items) ? row.line_items : [];
        const companyName = getOrderCompanyName();
        if(!companyName) throw new Error('Company name is required to send orders');
        const shippingAddress = getOrderShippingSnapshotFromRow(row);
        const companyPoNumber = String(row.company_po_number || '').trim();
        const internalPoNumber = String(row.internal_po_number || '').trim();

        const sendRes = await sendOrderPayloadViaApi({
          to,
          subjectLine,
          notes,
          lineItems,
          shippingAddress,
          companyName,
          companyPoNumber,
          internalPoNumber,
        });
        try{ await sbRecordOrderRecipient(to, ''); }catch{}
        try{
          await sbInsertOrderHistoryFromData({
            toEmail: to,
            subjectLine,
            contactName: '',
            notes,
            lineItems,
            providerResult: sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes,
            companyPoNumber,
            internalPoNumber,
            shippingAddressId: row.ship_to_location_id || row.shipping_address_id,
            shippingAddressSnapshot: shippingAddress,
          });
        }catch{}

        toast('Forwarded');
        if(input) input.value = '';
        renderForwardEmailSuggestions(id, []);
      }catch(e){
        toast((e && e.message) ? e.message : 'Forward failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Forward'; }
      }
    }
    let _orderHistoryReturnToOrder = false;
	    async function refreshOrderHistory(){
	      const wrap = $('orderHistoryList');
	      if(wrap){
	        wrap.innerHTML =
	          `<div class="order-history-empty">`+
	            `<div class="order-history-empty-title">Loading ordersâ€¦</div>`+
	            `<div class="order-history-empty-text">Fetching latest orders.</div>`+
	          `</div>`;
	      }
	      const btn = $('btnOrderHistoryRefresh');
	      const prior = btn ? btn.textContent : '';
	      if(btn){ btn.disabled = true; btn.textContent = 'Loadingâ€¦'; }
	      try{
	        const rows = await sbFetchOrders(60);
	        state._orderHistoryRows = Array.isArray(rows) ? rows : [];
	        state._orderHistoryById = new Map((rows||[]).map(r => [String(r && r.id ? r.id : ''), r]).filter(x=>x[0]));
	        state._orderHistoryLinesByPo = await sbFetchPurchaseOrderLinesByPoIds(
	          (rows || []).map(r => r && r.id)
	        );
	        await loadOrderShippingOptions();
	        const lineMap = state._orderHistoryLinesByPo || new Map();
        (state._orderHistoryRows || []).forEach(row=>{
          const totals = getPurchaseOrderLineTotalsById(row && row.id, lineMap);
          applyPurchaseOrderLineTotals(row, totals);
        });
        renderOrderHistoryFiltered();
        updateMenuOrderBadgesFromState();
        scheduleMenuActionBadgeRefresh({ force: true });
      }catch(e){
	        state._orderHistoryById = new Map();
	        state._orderHistoryRows = [];
          state._orderHistoryLinesByPo = new Map();
	        const msg = e && e.message ? e.message : 'Failed to load history';
	        if(wrap){
	          wrap.innerHTML =
	            `<div class="order-history-empty">`+
	              `<div class="order-history-empty-title">${escapeHtml(msg)}</div>`+
	              `<div class="order-history-empty-text">Try again in a moment.</div>`+
	            `</div>`;
	        }
	      }finally{
	        updateOrderHistoryTabBadges();
	        if(btn){ btn.disabled = false; btn.textContent = prior || 'Refresh'; }
	      }
	    }
    async function openOrderHistoryModal(opts = {}){
      const returnToOrder = !!opts.returnToOrder;
      const tabOverride = typeof opts.tab === 'string' ? String(opts.tab || '').trim() : '';
      const hasStatusOverride = Object.prototype.hasOwnProperty.call(opts, 'statusFilter');
      const hasSearchOverride = Object.prototype.hasOwnProperty.call(opts, 'searchFilter');
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!canOrdersView()){ toast('Order history access required'); return; }
      if(tabOverride) state._orderHistoryTab = tabOverride;
      if(hasStatusOverride) setOrderHistoryStatusFilter(opts.statusFilter);
      if(hasSearchOverride) state._orderHistoryFilter = typeof opts.searchFilter === 'string' ? opts.searchFilter : '';
      _orderHistoryReturnToOrder = returnToOrder;
      if(returnToOrder) show('orderModal', false);
      show('orderHistoryModal', true);
      const activeTab = getOrderHistoryActiveTab();
      applyOrderHistoryTabState(activeTab);
      const f = $('orderHistoryFilter'); if(f) f.value = state._orderHistoryFilter || '';
      const rf = $('orderHistoryReceiptFilter'); if(rf) rf.value = state._orderHistoryReceiptsFilter || '';
      try{ updateOrderHistoryFilterClearBtn(); }catch(e){}
	      await refreshOrderHistory();
	      if(activeTab === 'receipts'){
	        await refreshOrderHistoryReceipts();
	      }
	    }
    function closeOrderHistoryModal(){
      show('orderHistoryModal', false);
      if(_orderHistoryReturnToOrder){
        _orderHistoryReturnToOrder = false;
        show('orderModal', true);
        renderOrderPreview();
      }
    }

    function jobStatusLabel(status){
      const s = String(status || 'draft').trim();
      if(s === 'draft') return 'Draft';
      if(s === 'quoted') return 'Quoted';
      if(s === 'approved') return 'Approved';
      if(s === 'in_progress') return 'In Progress';
      if(s === 'completed') return 'Completed';
      if(s === 'voided') return 'Voided';
      return s;
    }
    const JOB_READINESS_REASON_LABELS = {
      job_not_approved: 'Job not approved',
      shortfall_exists: 'Shortfall exists',
      allocation_incomplete: 'Allocation incomplete'
    };
    function jobReadinessLabel(isReady){
      return isReady ? 'Ready' : 'Not Ready';
    }
    function formatJobReadinessReasons(reasons){
      const list = Array.isArray(reasons) ? reasons : [];
      return list.map(reason => JOB_READINESS_REASON_LABELS[reason] || String(reason));
    }
    function shortfallQtyFromEntry(entry){
      if(entry && typeof entry === 'object'){
        const qty = Number(entry.qty_missing ?? entry.qty ?? entry.shortfall ?? 0);
        return Number.isFinite(qty) ? qty : 0;
      }
      const num = Number(entry ?? 0);
      return Number.isFinite(num) ? num : 0;
    }
    function shortfallIdFromEntry(entry){
      if(entry && typeof entry === 'object'){
        const id = entry.shortfall_id || entry.shortfallId || entry.id || '';
        return String(id || '').trim();
      }
      return '';
    }
    function jobStatusClass(status){
      const s = String(status || 'draft').trim();
      return `job-status--${s}`;
    }
    function isJobEditable(status){
      return ['draft', 'quoted'].includes(String(status || 'draft'));
    }
    function canApproveJob(status){
      return ['draft', 'quoted'].includes(String(status || ''));
    }
    function canCompleteJob(status){
      return ['approved', 'in_progress'].includes(String(status || ''));
    }
    function canVoidJob(status){
      return ['draft', 'quoted', 'approved', 'in_progress'].includes(String(status || ''));
    }
    function setJobsMessage(msg){
      const el = $('jobsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setJobEditorMessage(msg){
      const el = $('jobEditorMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setJobBomMessage(msg){
      const el = $('jobBomMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setJobCompleteMessage(msg){
      const el = $('jobCompleteMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    const JOB_TABS = ['details', 'materials', 'execution'];
    let _jobEditorIconsReady = false;
    function getJobEditorTab(){
      const tab = String(state._jobEditorTab || 'details');
      return JOB_TABS.includes(tab) ? tab : 'details';
    }
    function setJobEditorTab(tab){
      const next = JOB_TABS.includes(tab) ? tab : 'details';
      state._jobEditorTab = next;
      applyJobEditorTabState();
    }
    function applyJobEditorTabState(){
      const active = getJobEditorTab();
      document.querySelectorAll('.job-tab').forEach(btn=>{
        const key = String(btn.dataset.jobTab || '').trim();
        const isActive = key === active;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      document.querySelectorAll('.job-tab-panel').forEach(panel=>{
        const key = String(panel.dataset.jobTabPanel || '').trim();
        panel.style.display = (key === active) ? 'block' : 'none';
      });
      document.querySelectorAll('.job-step-item').forEach(btn=>{
        const key = String(btn.dataset.jobStep || '').trim();
        btn.classList.toggle('is-active', key === active);
      });
    }
    function ensureJobEditorIcons(){
      if(_jobEditorIconsReady) return;
      _jobEditorIconsReady = true;
      document.querySelectorAll('.job-next-step-icon').forEach(el=>{ el.innerHTML = ICONS.chevronRight; });
      document.querySelectorAll('.job-add-item-icon').forEach(el=>{ el.innerHTML = ICONS.plus; });
      document.querySelectorAll('.job-action-card-icon').forEach(el=>{ el.innerHTML = ICONS.checkCircle; });
      document.querySelectorAll('.job-shortfall-info-icon').forEach(el=>{ el.innerHTML = ICONS.info; });
      document.querySelectorAll('.job-shortfall-benefit-icon').forEach(el=>{ el.innerHTML = ICONS.check; });
    }
    function syncJobActualDraftFromDom(){
      const editor = state._jobEditor;
      if(!editor) return;
      // Only select the card containers, not the buttons inside them
      const rows = Array.from(document.querySelectorAll('.job-completion-card[data-actual-item-id]'));
      if(!rows.length) return;
      const map = new Map();
      rows.forEach(row=>{
        const itemId = String(row.getAttribute('data-actual-item-id') || '').trim();
        if(!itemId) return;
        const input = row.querySelector('[data-actual-qty-input]');
        if(!input) return;
        const qty = Number(input.value || 0);
        map.set(itemId, Number.isFinite(qty) ? qty : 0);
      });
      editor.actualsDraft = map;
    }
    function getJobEditorLines(editor){
      const lines = editor && Array.isArray(editor.bomLines) ? editor.bomLines : [];
      if(lines.length) return lines;
      const pending = editor && Array.isArray(editor.pendingBomLines) ? editor.pendingBomLines : [];
      return pending;
    }
    function getJobActualMap(editor){
      if(editor && editor.actualsDraft && editor.actualsDraft.size) return new Map(editor.actualsDraft);
      const actuals = editor && Array.isArray(editor.actuals) ? editor.actuals : [];
      const map = new Map();
      actuals.forEach(row=>{
        const itemId = String(row && row.item_id ? row.item_id : '').trim();
        if(!itemId) return;
        map.set(itemId, Number(row.qty_used || 0));
      });
      return map;
    }
    function computeJobTotals(editor){
      const lines = getJobEditorLines(editor);
      const reservedMap = editor ? editor.reservedMap : new Map();
      const inventoryMap = editor ? editor.inventoryMap : new Map();
      const jobShortfalls = editor && editor.jobShortfalls ? editor.jobShortfalls : new Map();
      const status = editor && editor.job ? String(editor.job.status || '') : '';
      const isCompleted = status === 'completed';
      const usesPlannedShortfall = !isCompleted && ['draft', 'quoted'].includes(status);
      const actualMap = getJobActualMap(editor);
      let totalPlanned = 0;
      let totalOnHand = 0;
      let totalShortfall = 0;
      let totalActual = 0;
      lines.forEach(line=>{
        const itemId = String(line && line.item_id ? line.item_id : '').trim();
        const planned = Number(line && line.qty_planned ? line.qty_planned : 0);
        if(!itemId) return;
        totalPlanned += planned;
        if(!isCompleted){
          const stats = computeJobLineStats(itemId, planned, reservedMap, inventoryMap);
          const hasRecorded = jobShortfalls && typeof jobShortfalls.has === 'function' && jobShortfalls.has(itemId);
          const recordedShortfall = hasRecorded ? shortfallQtyFromEntry(jobShortfalls.get(itemId)) : null;
          const shortfallQty = Number.isFinite(recordedShortfall)
            ? recordedShortfall
            : (usesPlannedShortfall ? stats.shortfall : 0);
          totalOnHand += stats.onHand;
          totalShortfall += Math.max(0, shortfallQty);
        }
        const actual = actualMap.has(itemId) ? Number(actualMap.get(itemId)) : 0;
        totalActual += actual;
      });
      const completionPercent = totalPlanned > 0 ? Math.round((totalActual / totalPlanned) * 100) : 0;
      return { totalPlanned, totalOnHand, totalShortfall, totalActual, completionPercent };
    }
    function buildJobCompletionAudit(editor){
      if(!editor || !editor.job) return '';
      const job = editor.job;
      const actuals = Array.isArray(editor.actuals) ? editor.actuals : [];
      const actualMap = new Map();
      actuals.forEach(row=>{
        const itemId = String(row && row.item_id ? row.item_id : '').trim();
        if(!itemId) return;
        const qty = Number(row.qty_used || 0);
        if(!Number.isFinite(qty) || qty === 0) return;
        actualMap.set(itemId, (actualMap.get(itemId) || 0) + qty);
      });
      const consumed = [];
      const returned = [];
      let net = 0;
      actualMap.forEach((qty, itemId)=>{
        const item = getInventoryById(itemId);
        const name = item && item.name ? String(item.name || '').trim() : `Item ${shortId(itemId)}`;
        if(qty > 0){
          consumed.push({ name, qty });
        }else if(qty < 0){
          returned.push({ name, qty: Math.abs(qty) });
        }
        net += qty;
      });
      const sections = [];
      if(consumed.length || returned.length){
        const impactParts = [];
        if(consumed.length){
          impactParts.push('<div class="job-audit-subtitle">Items consumed</div>');
          impactParts.push(
            '<div class="job-audit-list">' +
            consumed.map(item=>(
              `<div class="job-audit-item">`+
                `<span class="job-audit-item-name" title="${escapeHtmlAttr(item.name)}">${escapeHtml(item.name)}</span>`+
                `<span class="job-audit-item-qty">${escapeHtml(formatQty(item.qty))}</span>`+
              `</div>`
            )).join('') +
            '</div>'
          );
        }
        if(returned.length){
          impactParts.push('<div class="job-audit-subtitle">Items returned</div>');
          impactParts.push(
            '<div class="job-audit-list">' +
            returned.map(item=>(
              `<div class="job-audit-item">`+
                `<span class="job-audit-item-name" title="${escapeHtmlAttr(item.name)}">${escapeHtml(item.name)}</span>`+
                `<span class="job-audit-item-qty">${escapeHtml(formatQty(item.qty))}</span>`+
              `</div>`
            )).join('') +
            '</div>'
          );
        }
        const netAbs = Math.abs(net);
        const netText = net === 0 ? '0' : (net > 0 ? `+${formatQty(netAbs)}` : `-${formatQty(netAbs)}`);
        impactParts.push(
          `<div class="job-audit-row">`+
            `<span>Net inventory delta</span>`+
            `<span>${escapeHtml(netText)}</span>`+
          `</div>`
        );
        sections.push(`<div class="job-audit-section">${impactParts.join('')}</div>`);
      }else{
        sections.push('<div class="job-audit-empty">No inventory changes were recorded for this job.</div>');
      }

      const summaryRows = [];
      const jobNumberLabel = formatJobNumberLabel(job);
      if(jobNumberLabel && jobNumberLabel !== 'Job'){
        summaryRows.push(
          `<div class="job-audit-row">`+
            `<span>Job</span>`+
            `<span>${escapeHtml(jobNumberLabel)}</span>`+
          `</div>`
        );
      }
      const startRaw = job.execution_started_at || job.started_at || job.start_date || job.execution_start || '';
      if(startRaw){
        summaryRows.push(
          `<div class="job-audit-row">`+
            `<span>Execution start</span>`+
            `<span>${escapeHtml(formatDateShort(startRaw))}</span>`+
          `</div>`
        );
      }
      const completedRaw = job.completed_at || job.completed_on || job.completed_date || (job.status === 'completed' ? job.updated_at : '');
      if(completedRaw){
        summaryRows.push(
          `<div class="job-audit-row">`+
            `<span>Completion date</span>`+
            `<span>${escapeHtml(formatDateShort(completedRaw))}</span>`+
          `</div>`
        );
      }
      const completedBy = job.completed_by_name || job.completed_by_email || job.completed_by || job.updated_by_email || job.updated_by || '';
      if(completedBy){
        summaryRows.push(
          `<div class="job-audit-row">`+
            `<span>Completed by</span>`+
            `<span>${escapeHtml(String(completedBy))}</span>`+
          `</div>`
        );
      }
      if(summaryRows.length){
        sections.push(
          `<div class="job-audit-section">`+
            `<div class="job-audit-subtitle">Execution summary</div>`+
            summaryRows.join('')+
          `</div>`
        );
      }

      const notes = job.execution_notes || job.completion_notes || '';
      if(notes && String(notes).trim()){
        sections.push(
          `<div class="job-audit-section">`+
            `<div class="job-audit-subtitle">Final notes</div>`+
            `<div class="job-audit-notes">${escapeHtml(String(notes).trim())}</div>`+
          `</div>`
        );
      }

      return sections.join('');
    }
    function buildJobCompletionSummary(editor){
      if(!editor || !editor.job) return '';
      const job = editor.job;
      const completedDate = getJobCompletionDate(job);
      const completedBy = job.completed_by_name || job.completed_by_email || job.completed_by || job.updated_by_email || job.updated_by || '';
      const actuals = Array.isArray(editor.actuals) ? editor.actuals : [];
      let consumed = 0;
      let returned = 0;
      actuals.forEach(row=>{
        const qty = Number(row && row.qty_used != null ? row.qty_used : 0);
        if(!Number.isFinite(qty) || qty === 0) return;
        if(qty > 0) consumed += qty;
        if(qty < 0) returned += Math.abs(qty);
      });
      const sections = [];
      const summaryRows = [];
      if(completedDate){
        summaryRows.push(
          `<div class="job-audit-row">`+
            `<span>Completion date</span>`+
            `<span>${escapeHtml(completedDate)}</span>`+
          `</div>`
        );
      }
      if(completedBy){
        summaryRows.push(
          `<div class="job-audit-row">`+
            `<span>Completed by</span>`+
            `<span>${escapeHtml(String(completedBy))}</span>`+
          `</div>`
        );
      }
      if(summaryRows.length){
        sections.push(
          `<div class="job-audit-section">`+
            `<div class="job-audit-subtitle">Completion</div>`+
            summaryRows.join('')+
          `</div>`
        );
      }
      if(consumed || returned){
        const net = consumed - returned;
        const impactRows = [];
        if(consumed){
          impactRows.push(
            `<div class="job-audit-row">`+
              `<span>Items consumed</span>`+
              `<span>${escapeHtml(formatQty(consumed))}</span>`+
            `</div>`
          );
        }
        if(returned){
          impactRows.push(
            `<div class="job-audit-row">`+
              `<span>Items returned</span>`+
              `<span>${escapeHtml(formatQty(returned))}</span>`+
            `</div>`
          );
        }
        const netAbs = Math.abs(net);
        const netText = net === 0 ? '0' : (net > 0 ? `+${formatQty(netAbs)}` : `-${formatQty(netAbs)}`);
        impactRows.push(
          `<div class="job-audit-row">`+
            `<span>Net inventory delta</span>`+
            `<span>${escapeHtml(netText)}</span>`+
          `</div>`
        );
        sections.push(
          `<div class="job-audit-section">`+
            `<div class="job-audit-subtitle">Inventory impact</div>`+
            impactRows.join('')+
          `</div>`
        );
      }else{
        sections.push('<div class="job-audit-empty">No inventory changes were recorded for this job.</div>');
      }
      return sections.join('');
    }
    function buildJobCompletionOrders(editor){
      if(!editor || !editor.job) return '';
      const job = editor.job;
      const jobNumber = getJobNumberValue(job);
      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
      if(!jobNumber || !rows.length){
        return '<div class="job-audit-empty">No purchase orders were linked to this job.</div>';
      }
      const matches = rows.filter(o=>{
        const related = Array.isArray(o && o.related_job_numbers) ? o.related_job_numbers : [];
        const normalized = related.map(n => String(n || '').trim()).filter(Boolean);
        return normalized.includes(jobNumber);
      });
      if(!matches.length){
        return '<div class="job-audit-empty">No purchase orders were linked to this job.</div>';
      }
      const lineMap = state._orderHistoryLinesByPo || new Map();
      return (
        `<div class="job-audit-list">`+
          matches.map(o=>{
            const poNumber = String(o && (o.po_number || o.poNumber) || '').trim() || shortId(String(o && o.id ? o.id : ''));
            const totals = getPurchaseOrderLineTotalsById(o && o.id, lineMap);
            const statusLabel = formatPurchaseOrderStatusLabel(o, totals);
            const submitted = formatDateShort(o && (o.order_date || o.created_at || '') || '');
            const meta = [statusLabel, submitted].filter(Boolean).join(' â€¢ ');
            return (
              `<div class="job-audit-item">`+
                `<span class="job-audit-item-name" title="${escapeHtmlAttr(poNumber)}">PO ${escapeHtml(poNumber)}</span>`+
                `<span class="job-audit-item-qty">${escapeHtml(meta || '')}</span>`+
              `</div>`
            );
          }).join('')+
        `</div>`
      );
    }
    function updateJobProgressStepper(editor){
      const job = editor ? editor.job : null;
      const nameOk = !!(job && String(job.name || '').trim());
      const hasItems = getJobEditorLines(editor).length > 0;
      const isComplete = job && String(job.status || '') === 'completed';
      const totals = computeJobTotals(editor);
      const hasShortfalls = !isComplete && totals.totalShortfall > 0;
      const materialsBlocked = hasShortfalls;
      const active = getJobEditorTab();
      const steps = [
        { key:'details', complete: nameOk, label:'Details', index:1 },
        { key:'materials', complete: hasItems, blocked: materialsBlocked, label:'Materials', index:2 },
        { key:'execution', complete: isComplete, label:'Execution', index:3 }
      ];
      steps.forEach(step=>{
        const circle = document.querySelector(`[data-job-step-circle="${CSS.escape(step.key)}"]`);
        const label = document.querySelector(`[data-job-step-label="${CSS.escape(step.key)}"]`);
        if(circle){
          circle.classList.remove('complete','current','future','blocked');
          if(step.complete){
            if(step.blocked){
              circle.classList.add('blocked');
              circle.innerHTML = ICONS.alertTriangle;
            }else{
              circle.classList.add('complete');
              circle.innerHTML = ICONS.check;
            }
          }else{
            circle.classList.add(active === step.key ? 'current' : 'future');
            circle.textContent = String(step.index);
          }
        }
        if(label){
          label.classList.remove('complete','current','blocked');
          if(step.blocked){
            label.classList.add('blocked');
          }else if(step.complete){
            label.classList.add('complete');
          }
          if(active === step.key && !step.blocked) label.classList.add('current');
        }
      });
      const connector1 = document.querySelector('[data-job-step-connector="details"]');
      if(connector1) connector1.classList.toggle('complete', steps[0].complete);
      const connector2 = document.querySelector('[data-job-step-connector="materials"]');
      if(connector2) connector2.classList.toggle('complete', steps[1].complete);
    }
    async function ensureIncomingOrdersLoaded(force = false){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
      const hasRows = Array.isArray(state._orderHistoryRows) && state._orderHistoryRows.length > 0;
      const hasLines = state._orderHistoryLinesByPo && typeof state._orderHistoryLinesByPo.get === 'function' && state._orderHistoryLinesByPo.size > 0;
      if(!force && hasRows && hasLines) return;
      try{
        const rows = await sbFetchOrders(200);
        state._orderHistoryRows = Array.isArray(rows) ? rows : [];
        state._orderHistoryById = new Map((state._orderHistoryRows || []).map(r => [String(r && r.id ? r.id : ''), r]).filter(x => x[0]));
        state._orderHistoryLinesByPo = await sbFetchPurchaseOrderLinesByPoIds(
          (state._orderHistoryRows || []).map(r => r && r.id ? r.id : null)
        );
        const lineMap = state._orderHistoryLinesByPo || new Map();
        (state._orderHistoryRows || []).forEach(row=>{
          const totals = getPurchaseOrderLineTotalsById(row && row.id, lineMap);
          applyPurchaseOrderLineTotals(row, totals);
        });
        updateMenuOrderBadgesFromState();
      }catch(e){
        state._orderHistoryRows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
        state._orderHistoryById = state._orderHistoryById || new Map();
        state._orderHistoryLinesByPo = state._orderHistoryLinesByPo || new Map();
      }
    }

    async function sbFetchJobs(){
      if(!SB.ready) throw new Error('Supabase not configured');
      if(!SB.session) throw new Error('Sign in required');
      if(!SB.companyId) throw new Error('No company selected');
      const { data, error } = await SB.client
        .from('jobs')
        .select('id,company_id,job_number,name,status,notes,created_at,updated_at,created_by')
        .eq('company_id', SB.companyId)
        .order('created_at', { ascending:false });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbFetchJobBom(jobId){
      const { data, error } = await SB.client
        .from('job_bom')
        .select('job_id,item_id,qty_planned')
        .eq('job_id', jobId);
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbFetchJobBomForJobs(jobIds){
      const ids = Array.isArray(jobIds) ? jobIds.filter(Boolean) : [];
      const map = new Map();
      if(!ids.length) return map;
      const { data, error } = await SB.client
        .from('job_bom')
        .select('job_id,item_id,qty_planned')
        .in('job_id', ids);
      if(error) throw error;
      (Array.isArray(data) ? data : []).forEach(line=>{
        const jobId = String(line.job_id || '').trim();
        if(!jobId) return;
        if(!map.has(jobId)) map.set(jobId, []);
        map.get(jobId).push(line);
      });
      return map;
    }
    async function sbFetchJobActuals(jobId){
      const { data, error } = await SB.client
        .from('job_actuals')
        .select('job_id,item_id,qty_used')
        .eq('job_id', jobId);
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbFetchAllocationsForJobs(jobIds){
      const ids = Array.isArray(jobIds) ? jobIds.filter(Boolean) : [];
      const map = new Map();
      if(!ids.length) return map;
      const { data, error } = await SB.client
        .from('allocations')
        .select('job_id,item_id,qty_allocated')
        .in('job_id', ids);
      if(error) throw error;
      (Array.isArray(data) ? data : []).forEach(row=>{
        const jobId = String(row.job_id || '').trim();
        const itemId = String(row.item_id || '').trim();
        if(!jobId || !itemId) return;
        const qty = Number(row.qty_allocated || 0);
        if(!Number.isFinite(qty)) return;
        if(!map.has(jobId)) map.set(jobId, new Map());
        map.get(jobId).set(itemId, qty);
      });
      return map;
    }
    async function sbFetchShortfallsForJobs(jobIds){
      const ids = Array.isArray(jobIds) ? jobIds.filter(Boolean) : [];
      const map = new Map();
      if(!ids.length) return map;
      const { data, error } = await SB.client
        .from('shortfalls')
        .select('shortfall_id,job_id,item_id,qty_missing,status')
        .in('job_id', ids)
        .eq('status', 'active');
      if(error) throw error;
      (Array.isArray(data) ? data : []).forEach(row=>{
        const jobId = String(row.job_id || '').trim();
        const itemId = String(row.item_id || '').trim();
        if(!jobId || !itemId) return;
        const qty = Number(row.qty_missing || 0);
        if(!Number.isFinite(qty)) return;
        if(!map.has(jobId)) map.set(jobId, new Map());
        map.get(jobId).set(itemId, {
          shortfall_id: String(row.shortfall_id || '').trim(),
          shortfallId: String(row.shortfall_id || '').trim(),
          job_id: jobId,
          item_id: itemId,
          qty_missing: qty,
          qty,
          status: String(row.status || '').trim()
        });
      });
      return map;
    }
    function collectShortfallIdsFromMap(shortfallsByJob){
      const ids = new Set();
      if(!shortfallsByJob || typeof shortfallsByJob.forEach !== 'function') return [];
      shortfallsByJob.forEach(value=>{
        if(value && typeof value.forEach === 'function'){
          value.forEach(entry=>{
            const id = shortfallIdFromEntry(entry);
            if(id) ids.add(id);
          });
          return;
        }
        const id = shortfallIdFromEntry(value);
        if(id) ids.add(id);
      });
      return Array.from(ids);
    }
    async function sbFetchOrderShortfallLinks(shortfallIds){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return new Map();
      if(!canOrdersView()) return new Map();
      const ids = Array.isArray(shortfallIds) ? shortfallIds.filter(Boolean) : [];
      if(!ids.length) return new Map();
      let query = SB.client
        .from('orders')
        .select('id,shortfall_id')
        .eq('company_id', SB.companyId)
        .is('deleted_at', null)
        .not('shortfall_id', 'is', null);
      query = query.in('shortfall_id', ids);
      const { data, error } = await query;
      if(error) throw error;
      const map = new Map();
      (Array.isArray(data) ? data : []).forEach(row=>{
        const shortfallId = String(row && row.shortfall_id ? row.shortfall_id : '').trim();
        if(!shortfallId) return;
        map.set(shortfallId, (map.get(shortfallId) || 0) + 1);
      });
      return map;
    }
    async function sbFetchJobReadiness(jobIds){
      if(!SB.companyId) throw new Error('No company selected');
      const ids = Array.isArray(jobIds) ? jobIds.filter(Boolean) : [];
      const map = new Map();
      if(!ids.length) return map;
      const { data, error } = await SB.client.rpc('get_job_readiness', {
        p_company_id: SB.companyId,
        p_job_ids: ids
      });
      if(error) throw error;
      (Array.isArray(data) ? data : []).forEach(row=>{
        const jobId = String(row && row.job_id ? row.job_id : '').trim();
        if(!jobId) return;
        map.set(jobId, {
          ready: !!(row && row.ready),
          reasons: Array.isArray(row && row.reasons) ? row.reasons : []
        });
      });
      return map;
    }
    function normalizeJobAllocationStatus(status){
      const raw = String(status || '').trim().toLowerCase();
      return raw === 'draft' ? 'planned' : raw;
    }
    async function sbFetchJobReadinessDetails(jobId){
      if(!SB.ready) throw new Error('Supabase not configured');
      if(!SB.session) throw new Error('Sign in required');
      if(!SB.companyId) throw new Error('No company selected');
      const id = String(jobId || '').trim();
      if(!id) return null;

      const { data: allocationRows, error: allocationError } = await SB.client
        .from('job_item_allocations')
        .select('item_id,qty_required,status')
        .eq('company_id', SB.companyId)
        .eq('job_id', id)
        .in('status', ['draft','planned','approved','active']);
      if(allocationError) throw allocationError;

      const requiredByItem = new Map();
      const committedByItemForJob = new Map();
      (Array.isArray(allocationRows) ? allocationRows : []).forEach(row=>{
        const itemId = String(row && row.item_id ? row.item_id : '').trim();
        if(!itemId) return;
        const qty = toInt(row && row.qty_required != null ? row.qty_required : 0, 0);
        if(qty <= 0) return;
        requiredByItem.set(itemId, (requiredByItem.get(itemId) || 0) + qty);
        const status = normalizeJobAllocationStatus(row && row.status);
        if(status === 'approved' || status === 'active'){
          committedByItemForJob.set(itemId, (committedByItemForJob.get(itemId) || 0) + qty);
        }
      });

      const itemIds = Array.from(requiredByItem.keys());
      if(!itemIds.length){
        return { ready_for_approval: true, blocking_items: [] };
      }

      const incomingByItem = await sbFetchIncomingInventoryByItem(SB.companyId, itemIds);
      const { data: inventoryRows, error: inventoryError } = await SB.client
        .from('inventory_items')
        .select('id,quantity')
        .eq('company_id', SB.companyId)
        .in('id', itemIds)
        .is('deleted_at', null);
      if(inventoryError) throw inventoryError;

      const onHandMap = new Map();
      (Array.isArray(inventoryRows) ? inventoryRows : []).forEach(row=>{
        const itemId = String(row && row.id ? row.id : '').trim();
        if(!itemId) return;
        onHandMap.set(itemId, toInt(row && row.quantity != null ? row.quantity : 0, 0));
      });

      const { data: committedRows, error: committedError } = await SB.client
        .from('inventory_committed_by_item')
        .select('item_id,committed_qty')
        .eq('company_id', SB.companyId)
        .in('item_id', itemIds);
      if(committedError) throw committedError;

      const committedMap = new Map();
      (Array.isArray(committedRows) ? committedRows : []).forEach(row=>{
        const itemId = String(row && row.item_id ? row.item_id : '').trim();
        if(!itemId) return;
        const qty = Number(row && row.committed_qty != null ? row.committed_qty : 0);
        committedMap.set(itemId, Number.isFinite(qty) ? qty : 0);
      });

      const blockingItems = [];
      itemIds.forEach(itemId=>{
        const requiredQty = requiredByItem.get(itemId) || 0;
        const onHand = onHandMap.get(itemId) || 0;
        const committedTotal = committedMap.get(itemId) || 0;
        const committedForJob = committedByItemForJob.get(itemId) || 0;
        const committedOther = Math.max(0, committedTotal - committedForJob);
        const incomingQty = Number(incomingByItem[itemId] || 0) || 0;
        const availableQty = onHand + incomingQty - committedOther;
        const availableNow = onHand - committedOther;
        if(availableNow < requiredQty){
          const shortfallQty = Math.max(0, requiredQty - availableNow);
          blockingItems.push({
            itemId,
            requiredQty,
            availableQty,
            shortfallQty,
            incoming_qty: incomingQty
          });
        }
      });

      return {
        ready_for_approval: blockingItems.length === 0,
        blocking_items: blockingItems
      };
    }
    function getJobBomItemIds(lines){
      const ids = new Set();
      (Array.isArray(lines) ? lines : []).forEach(line=>{
        const itemId = String(line && line.item_id ? line.item_id : '').trim();
        if(itemId) ids.add(itemId);
      });
      return Array.from(ids);
    }
    async function sbFetchReservedMap(){
      const reserved = new Map();
      const { data, error } = await SB.client
        .from('allocations')
        .select('item_id,qty_allocated')
        .eq('company_id', SB.companyId);
      if(error) throw error;
      (Array.isArray(data) ? data : []).forEach(line=>{
        const itemId = String(line.item_id || '');
        if(!itemId) return;
        const qty = Number(line.qty_allocated || 0);
        if(!Number.isFinite(qty)) return;
        reserved.set(itemId, (reserved.get(itemId) || 0) + qty);
      });
      return reserved;
    }
    async function sbFetchInventoryByItemIds(itemIds){
      if(!SB.ready) throw new Error('Supabase not configured');
      if(!SB.session) throw new Error('Sign in required');
      if(!SB.companyId) throw new Error('No company selected');
      const ids = Array.isArray(itemIds) ? itemIds.map(id => String(id || '').trim()).filter(Boolean) : [];
      if(!ids.length) return new Map();
      const { data, error } = await SB.client
        .from('inventory_items')
        .select('id,quantity')
        .eq('company_id', SB.companyId)
        .in('id', ids)
        .is('deleted_at', null);
      if(error) throw error;
      const map = new Map();
      (Array.isArray(data) ? data : []).forEach(row=>{
        const id = String(row && row.id ? row.id : '').trim();
        if(!id) return;
        map.set(id, { onHand: toInt(row.quantity, 0) });
      });
      return map;
    }
    async function sbFetchIncomingInventoryByItem(companyId, itemIds){
      try{
        const ids = (itemIds || []).map(id => String(id || '').trim()).filter(Boolean);
        const company = String(companyId || '').trim();
        if(!company || !ids.length) return {};
        if(!SB.ready || !SB.session) return {};
        const { data, error } = await SB.client
          .from('inventory_incoming_by_item')
          .select('item_id,incoming_qty')
          .eq('company_id', company)
          .in('item_id', ids);
        if(error) throw error;
        const m = {};
        (data || []).forEach(r => {
          const itemId = String(r && r.item_id ? r.item_id : '').trim();
          if(!itemId) return;
          m[itemId] = Number(r && r.incoming_qty != null ? r.incoming_qty : 0) || 0;
        });
        return m;
      }catch(e){
        console.warn('sbFetchIncomingInventoryByItem failed', e);
        return {};
      }
    }
    async function ensureInventoryLoaded(){
      if(!state.items || !state.items.length){
        await sbLoadSnapshot();
      }
    }
    const MENU_ACTION_COUNTS_TTL_MS = 15000;
    const MENU_ACTION_COUNTS_DEBOUNCE_MS = 300;
    let _menuActionCounts = null;
    let _menuActionCountsCache = new Map();
    let _menuActionCountsTimer = null;
    let _menuActionCountsPendingForce = false;
    let _menuActionCountsInFlight = null;

    function createEmptyMenuActionCounts(){
      return {
        orders: { draft: 0, submitted: 0 },
        jobs: { draft: 0, ready: 0 },
        receiving: { receipts: 0, pending: 0 },
      };
    }
    function normalizeMenuCountValue(value){
      return Math.max(0, toInt(value, 0));
    }
    function mergeMenuActionCounts(base, patch){
      const current = base && typeof base === 'object' ? base : createEmptyMenuActionCounts();
      const next = createEmptyMenuActionCounts();
      next.orders.draft = normalizeMenuCountValue(current.orders && current.orders.draft);
      next.orders.submitted = normalizeMenuCountValue(current.orders && current.orders.submitted);
      next.jobs.draft = normalizeMenuCountValue(current.jobs && current.jobs.draft);
      next.jobs.ready = normalizeMenuCountValue(current.jobs && current.jobs.ready);
      next.receiving.receipts = normalizeMenuCountValue(current.receiving && current.receiving.receipts);
      next.receiving.pending = normalizeMenuCountValue(current.receiving && current.receiving.pending);
      const patchObj = patch && typeof patch === 'object' ? patch : {};
      if(patchObj.orders){
        if(patchObj.orders.draft !== null && typeof patchObj.orders.draft !== 'undefined'){
          next.orders.draft = normalizeMenuCountValue(patchObj.orders.draft);
        }
        if(patchObj.orders.submitted !== null && typeof patchObj.orders.submitted !== 'undefined'){
          next.orders.submitted = normalizeMenuCountValue(patchObj.orders.submitted);
        }
      }
      if(patchObj.jobs){
        if(patchObj.jobs.draft !== null && typeof patchObj.jobs.draft !== 'undefined'){
          next.jobs.draft = normalizeMenuCountValue(patchObj.jobs.draft);
        }
        if(patchObj.jobs.ready !== null && typeof patchObj.jobs.ready !== 'undefined'){
          next.jobs.ready = normalizeMenuCountValue(patchObj.jobs.ready);
        }
      }
      if(patchObj.receiving){
        if(patchObj.receiving.receipts !== null && typeof patchObj.receiving.receipts !== 'undefined'){
          next.receiving.receipts = normalizeMenuCountValue(patchObj.receiving.receipts);
        }
        if(patchObj.receiving.pending !== null && typeof patchObj.receiving.pending !== 'undefined'){
          next.receiving.pending = normalizeMenuCountValue(patchObj.receiving.pending);
        }
      }
      return next;
    }
    function setMenuBadgeValue(badge, count){
      if(!badge) return false;
      const valueEl = badge.querySelector('.menu-item-badge-value');
      const qty = normalizeMenuCountValue(count);
      if(valueEl) valueEl.textContent = String(qty);
      badge.style.display = qty > 0 ? 'inline-flex' : 'none';
      return qty > 0;
    }
    function setMenuOrderBadgeCounts(counts){
      const container = $('menuOrderBadges');
      const menuOrder = $('menuOrder');
      if(!container || !menuOrder) return;
      if(!canOrdersView()){
        container.style.display = 'none';
        menuOrder.setAttribute('aria-label', 'Orders');
        return;
      }
      const draftCount = normalizeMenuCountValue(counts && counts.draft);
      const submittedCount = normalizeMenuCountValue(counts && counts.submitted);
      const showDraft = setMenuBadgeValue($('menuOrderDraftBadge'), draftCount);
      const showSubmitted = setMenuBadgeValue($('menuOrderSubmittedBadge'), submittedCount);
      const show = showDraft || showSubmitted;
      container.style.display = show ? 'flex' : 'none';
      if(show){
        const parts = [];
        if(showDraft) parts.push(`Draft ${draftCount}`);
        if(showSubmitted) parts.push(`Submitted ${submittedCount}`);
        menuOrder.setAttribute('aria-label', `Orders (${parts.join(', ')})`);
      }else{
        menuOrder.setAttribute('aria-label', 'Orders');
      }
    }
    function setMenuJobsBadgeCounts(counts){
      const container = $('menuJobsBadges');
      const menuJobs = $('menuJobs');
      if(!container || !menuJobs) return;
      if(!canItemsView()){
        container.style.display = 'none';
        menuJobs.setAttribute('aria-label', 'Jobs');
        return;
      }
      const draftCount = normalizeMenuCountValue(counts && counts.draft);
      const readyCount = normalizeMenuCountValue(counts && counts.ready);
      const showDraft = setMenuBadgeValue($('menuJobsDraftBadge'), draftCount);
      const showReady = setMenuBadgeValue($('menuJobsReadyBadge'), readyCount);
      const show = showDraft || showReady;
      container.style.display = show ? 'flex' : 'none';
      if(show){
        const parts = [];
        if(showDraft) parts.push(`Draft ${draftCount}`);
        if(showReady) parts.push(`Ready ${readyCount}`);
        menuJobs.setAttribute('aria-label', `Jobs (${parts.join(', ')})`);
      }else{
        menuJobs.setAttribute('aria-label', 'Jobs');
      }
    }
    function setMenuReceiveBadgeCounts(counts){
      const container = $('menuReceiveBadges');
      const menuReceive = $('menuReceive');
      if(!container || !menuReceive) return;
      if(!canAccessReceivingInbox()){
        container.style.display = 'none';
        menuReceive.setAttribute('aria-label', 'Receive Inventory');
        return;
      }
      const receiptsCount = normalizeMenuCountValue(counts && counts.receipts);
      const pendingAllowed = canReceiveOrders();
      const pendingCount = pendingAllowed ? normalizeMenuCountValue(counts && counts.pending) : 0;
      const showReceipts = setMenuBadgeValue($('menuReceiveReceiptsBadge'), receiptsCount);
      const showPending = pendingAllowed ? setMenuBadgeValue($('menuReceivePendingBadge'), pendingCount) : false;
      if(!pendingAllowed){
        const pendingEl = $('menuReceivePendingBadge');
        if(pendingEl) pendingEl.style.display = 'none';
      }
      const show = showReceipts || showPending;
      container.style.display = show ? 'flex' : 'none';
      if(show){
        const parts = [];
        if(showReceipts) parts.push(`Receipts ${receiptsCount}`);
        if(showPending) parts.push(`Pending ${pendingCount}`);
        menuReceive.setAttribute('aria-label', `Receive Inventory (${parts.join(', ')})`);
      }else{
        menuReceive.setAttribute('aria-label', 'Receive Inventory');
      }
    }
    function applyMenuActionCounts(nextCounts, opts = {}){
      const useMerge = opts && opts.merge === true;
      const base = _menuActionCounts || createEmptyMenuActionCounts();
      const merged = useMerge
        ? mergeMenuActionCounts(base, nextCounts)
        : mergeMenuActionCounts(createEmptyMenuActionCounts(), nextCounts);
      _menuActionCounts = merged;
      setMenuOrderBadgeCounts(merged.orders);
      setMenuReceiveBadgeCounts(merged.receiving);
      setMenuJobsBadgeCounts(merged.jobs);
    }
    function cacheMenuActionCounts(companyId, counts){
      if(!companyId) return;
      _menuActionCountsCache.set(companyId, { ts: Date.now(), counts });
    }
    function getCachedMenuActionCounts(companyId){
      if(!companyId) return null;
      const entry = _menuActionCountsCache.get(companyId);
      if(!entry) return null;
      if(Date.now() - entry.ts > MENU_ACTION_COUNTS_TTL_MS) return null;
      return entry.counts;
    }
    function scheduleMenuActionBadgeRefresh(opts = {}){
      if(opts && opts.force) _menuActionCountsPendingForce = true;
      if(_menuActionCountsTimer) clearTimeout(_menuActionCountsTimer);
      _menuActionCountsTimer = setTimeout(() => {
        const force = _menuActionCountsPendingForce;
        _menuActionCountsPendingForce = false;
        void refreshMenuActionBadges({ force });
      }, MENU_ACTION_COUNTS_DEBOUNCE_MS);
    }
    function computeOrderActionableCountsFromState(){
      if(!Array.isArray(state._orderHistoryRows) || !state._orderHistoryRows.length) return null;
      const lineMap = state._orderHistoryLinesByPo;
      const counts = { draft: 0, submitted: 0, pending: 0 };
      state._orderHistoryRows.forEach(row => {
        const totals = (lineMap && typeof lineMap.get === 'function')
          ? getPurchaseOrderLineTotalsById(row && row.id, lineMap)
          : null;
        const status = totals ? getPurchaseOrderReceiveState(row, totals) : normalizePurchaseOrderStatus(row && row.status);
        if(status === 'draft') counts.draft += 1;
        if(status === 'submitted' || status === 'partially_received') counts.submitted += 1;
        if(status === 'submitted' || status === 'partially_received'){
          if(!totals || !totals.hasLines){
            counts.pending += 1;
          }else if(totals.remaining > 0){
            counts.pending += 1;
          }
        }
      });
      return counts;
    }
    function updateMenuOrderBadgesFromState(){
      if(!canOrdersView()) return;
      const counts = computeOrderActionableCountsFromState();
      if(!counts) return;
      applyMenuActionCounts({
        orders: { draft: counts.draft, submitted: counts.submitted },
        receiving: { pending: counts.pending }
      }, { merge: true });
    }
    function updateMenuJobsBadge(rows){
      const list = Array.isArray(rows) ? rows : (Array.isArray(state._jobs) ? state._jobs : []);
      let draft = 0;
      let ready = 0;
      list.forEach(row => {
        const status = String(row && row.status ? row.status : '').trim().toLowerCase();
        if(status === 'draft') draft += 1;
        if(status === 'ready') ready += 1;
      });
      applyMenuActionCounts({ jobs: { draft, ready } }, { merge: true });
    }
    async function fetchMenuActionCounts(companyId){
      const counts = {
        orders: { draft: null, submitted: null },
        jobs: { draft: null, ready: null },
        receiving: { receipts: null, pending: null },
      };
      if(!SB.ready || !SB.session || !companyId) return counts;
      const tasks = [];
      const keys = [];
      const canOrders = canOrdersView();
      const canReceipts = canAccessReceivingInbox();
      const canPending = canReceipts && canReceiveOrders();
      const orderDraftStatuses = ['draft'];
      const orderSubmittedStatuses = ['submitted', 'partially_received', 'partial', 'sent', 'approved', 'confirmed'];
      if(canOrders){
        tasks.push(
          SB.client
            .from('purchase_orders')
            .select('id', { count: 'exact', head: true })
            .eq('company_id', companyId)
            .in('status', orderDraftStatuses)
        );
        keys.push(['orders', 'draft']);
        tasks.push(
          SB.client
            .from('purchase_orders')
            .select('id', { count: 'exact', head: true })
            .eq('company_id', companyId)
            .in('status', orderSubmittedStatuses)
        );
        keys.push(['orders', 'submitted']);
      }else{
        counts.orders.draft = 0;
        counts.orders.submitted = 0;
      }
      if(canItemsView()){
        tasks.push(
          SB.client
            .from('jobs')
            .select('id', { count: 'exact', head: true })
            .eq('company_id', companyId)
            .eq('status', 'draft')
        );
        keys.push(['jobs', 'draft']);
        tasks.push(
          SB.client
            .from('jobs')
            .select('id', { count: 'exact', head: true })
            .eq('company_id', companyId)
            .eq('status', 'ready')
        );
        keys.push(['jobs', 'ready']);
      }else{
        counts.jobs.draft = 0;
        counts.jobs.ready = 0;
      }
      if(canReceipts){
        tasks.push(
          SB.client
            .from('receipts')
            .select('id', { count: 'exact', head: true })
            .eq('company_id', companyId)
            .in('status', ['draft', 'blocked_by_plan'])
        );
        keys.push(['receiving', 'receipts']);
      }else{
        counts.receiving.receipts = 0;
        counts.receiving.pending = 0;
      }
      if(canPending && !canOrders){
        tasks.push(
          SB.client
            .from('purchase_orders')
            .select('id', { count: 'exact', head: true })
            .eq('company_id', companyId)
            .in('status', orderSubmittedStatuses)
        );
        keys.push(['receiving', 'pending']);
      }
      const results = await Promise.allSettled(tasks);
      results.forEach((result, index) => {
        if(result.status !== 'fulfilled') return;
        const payload = result.value;
        if(payload && payload.error) return;
        const count = payload && Number.isFinite(payload.count) ? payload.count : 0;
        const key = keys[index];
        if(!key) return;
        const [group, field] = key;
        if(counts[group]) counts[group][field] = count;
      });
      if(canPending){
        const pendingFromState = canOrders ? computeOrderActionableCountsFromState() : null;
        if(pendingFromState && Number.isFinite(pendingFromState.pending)){
          counts.receiving.pending = pendingFromState.pending;
        }else if(canOrders && counts.orders.submitted !== null && counts.receiving.pending === null){
          counts.receiving.pending = counts.orders.submitted;
        }
      }else if(canReceipts){
        counts.receiving.pending = 0;
      }
      return counts;
    }
    async function refreshMenuActionBadges(opts = {}){
      const companyId = SB.companyId ? String(SB.companyId) : '';
      if(!SB.ready || !SB.session || !companyId){
        applyMenuActionCounts(createEmptyMenuActionCounts());
        return null;
      }
      const force = opts && opts.force === true;
      if(!force){
        const cached = getCachedMenuActionCounts(companyId);
        if(cached){
          applyMenuActionCounts(cached);
          return cached;
        }
      }
      if(_menuActionCountsInFlight) return _menuActionCountsInFlight;
      _menuActionCountsInFlight = (async () => {
        try{
          const counts = await fetchMenuActionCounts(companyId);
          if(String(SB.companyId || '') !== companyId) return null;
          applyMenuActionCounts(counts, { merge: true });
          const merged = _menuActionCounts;
          cacheMenuActionCounts(companyId, merged);
          return merged;
        }catch(e){
          return null;
        }finally{
          _menuActionCountsInFlight = null;
        }
      })();
      return _menuActionCountsInFlight;
    }
    async function refreshMenuJobsBadge(){
      return refreshMenuActionBadges({ force: true });
    }

    // UDWE Config for Jobs BOM Table
    const JOBS_BOM_CONFIG = {
      id: 'jobs_bom_table',
      columns: [
        {
          key: 'item',
          label: 'Item',
          type: 'text',
          minWidth: 180,
          maxWidth: 480,
          truncatable: false,
          align: 'left',
          priority: 1,
          locked: true,
          cellClass: 'col-item',
          render: (val, row) => {
            const name = escapeHtml(row.itemName || '');
            const sku = row.sku ? `<span class="item-sku">${escapeHtml(row.sku)}</span>` : '';
            return `<div class="item-cell"><span class="item-name" title="${escapeHtmlAttr(row.itemName || '')}">${name}</span>${sku}</div>`;
          }
        },
        {
          key: 'needed',
          label: 'Qty',
          mobileLabel: 'Qty',
          type: 'number',
          minWidth: 70,
          maxWidth: 90,
          truncatable: false,
          align: 'center',
          priority: 2,
          locked: true,
          cellClass: 'col-qty'
        },
        {
          key: 'onHand',
          label: 'On Hand',
          mobileLabel: 'On Hand',
          type: 'number',
          minWidth: 80,
          maxWidth: 110,
          truncatable: false,
          align: 'center',
          priority: 3,
          locked: true,
          cellClass: 'col-on-hand readonly-value'
        },
        {
          key: 'allocated',
          label: 'Allocated',
          mobileLabel: 'Allocated',
          type: 'number',
          minWidth: 90,
          maxWidth: 120,
          truncatable: false,
          align: 'center',
          priority: 4,
          locked: true,
          cellClass: 'col-allocated readonly-value'
        },
        {
          key: 'remaining',
          label: 'Remaining',
          mobileLabel: 'Remaining',
          type: 'number',
          minWidth: 90,
          maxWidth: 120,
          truncatable: false,
          align: 'center',
          priority: 5,
          locked: true,
          cellClass: 'col-remaining readonly-value'
        },
        {
          key: 'status',
          label: 'Status',
          type: 'status',
          minWidth: 120,
          maxWidth: 180,
          truncatable: false,
          align: 'left',
          priority: 6,
          locked: true,
          cellClass: 'col-status',
          render: (val, row) => {
            return `<span class="job-item-status ${escapeHtmlAttr(row.statusClass)}">${row.statusIcon}<span>${escapeHtml(row.statusText)}</span></span>`;
          }
        },
        {
          key: 'actions',
          label: 'Actions',
          type: 'actions',
          minWidth: 100,
          maxWidth: 120,
          truncatable: false,
          align: 'right',
          priority: 7,
          locked: true,
          cellClass: 'col-actions',
          render: (val, row) => {
            // Show incoming indicator if item has open PO
            if(row.hasOpenPO){
              const orderText = row.incomingOrderCount === 1 ? '1 order' : `${row.incomingOrderCount} orders`;
              return `<span class="job-bom-incoming" title="Incoming (Not Yet Received): +${row.incomingQty} (${orderText})">${ICONS.package}</span>`;
            }
            // Show cart button if item needs ordering
            if(!row.needsOrder) return '';
            return `<button class="icon-btn icon-btn--default icon-btn--sm job-bom-order-btn" data-item-id="${escapeHtmlAttr(row.itemId)}" data-shortage="${escapeHtmlAttr(String(row.shortage))}" data-job-id="${escapeHtmlAttr(String(row.jobId || ''))}" data-shortfall-id="${escapeHtmlAttr(String(row.shortfallId || ''))}" data-shortfall-qty="${escapeHtmlAttr(String(row.shortage || 0))}" aria-label="Add to purchase order" title="Order ${row.shortage} more">${ICONS.shoppingCart}</button>`;
          }
        }
      ],
      baselineWidth: 720,
      minWidth: 550,
      maxWidth: 980,
      mobileBreakpoint: 600,
      mobileLayout: 'scroll',
      mobilePrimaryKey: 'item',
      mobileSecondaryKeys: ['needed', 'onHand', 'allocated', 'remaining', 'status', 'actions']
    };

    function renderJobBomCards(bomData){
      if(!bomData || !bomData.length) return '<div class="muted">No items in this job.</div>';
      return `<div class="job-bom-cards">${bomData.map(row => {
        const onHandNum = parseFloat(String(row.onHand || '0').replace(/,/g, ''));
        const neededNum = parseFloat(String(row.needed || '0').replace(/,/g, ''));
        const onHandClass = onHandNum <= 0 ? 'on-hand-out' : (onHandNum < neededNum ? 'on-hand-low' : '');
        const cardClass = row.needsOrder || row.shortage > 0 ? 'shortage' : (onHandNum <= 0 ? 'out-of-stock' : '');
        const statusClass = row.needsOrder || row.shortage > 0 ? 'shortage' : (onHandNum <= 0 ? 'out-of-stock' : 'in-stock');
        const statusLabel = row.shortage > 0 ? 'Shortfall' : (onHandNum <= 0 ? 'Out of Stock' : 'In Stock');

        // Check if item is in cart
        const inCartQty = getOrderQtyForItem(row.itemId);
        const isInCart = inCartQty > 0;

        let cartBtn = '';
        if(isInCart){
          // Show "In Cart" badge instead of order button
          cartBtn = `<span class="job-bom-in-cart" data-item-id="${escapeHtmlAttr(row.itemId)}">${ICONS.shoppingCart} ${inCartQty} in cart</span>`;
        }else if(row.needsOrder){
          cartBtn = `<button class="icon-btn icon-btn--default icon-btn--sm job-bom-order-btn" data-item-id="${escapeHtmlAttr(row.itemId)}" data-shortage="${escapeHtmlAttr(String(row.shortage))}" data-job-id="${escapeHtmlAttr(String(row.jobId || ''))}" data-shortfall-id="${escapeHtmlAttr(String(row.shortfallId || ''))}" data-shortfall-qty="${escapeHtmlAttr(String(row.shortage || 0))}" aria-label="Add to purchase order" title="Order ${row.shortage} more">${ICONS.shoppingCart}</button>`;
        }else if(row.hasOpenPO){
          const orderText = row.incomingOrderCount === 1 ? '1 order' : `${row.incomingOrderCount} orders`;
          cartBtn = `<span class="job-bom-incoming" title="Incoming (Not Yet Received): +${row.incomingQty} (${orderText})">${ICONS.package}</span>`;
        }

        // Trash button for removing from job (only for draft/quoted jobs)
        const deleteBtn = row.canDelete
          ? `<button class="icon-btn icon-btn--danger icon-btn--sm job-bom-delete-btn" data-job-id="${escapeHtmlAttr(String(row.jobId || ''))}" data-item-id="${escapeHtmlAttr(row.itemId)}" aria-label="Remove from job" title="Remove from job">${ICONS.trash2}</button>`
          : '';

        return `<div class="job-bom-card ${cardClass}">
          <div class="job-bom-card-header">
            <div>
              <div class="job-bom-card-name" title="${escapeHtmlAttr(row.itemName || '')}">${escapeHtml(row.itemName || '')}</div>
              ${row.sku ? `<div class="job-bom-card-sku">${escapeHtml(row.sku)}</div>` : ''}
            </div>
            <span class="job-bom-card-status ${statusClass}">${row.statusIcon}<span>${escapeHtml(statusLabel)}</span></span>
          </div>
          <div class="job-bom-card-stats">
            <div class="job-bom-stat">
              <div class="job-bom-stat-value">${escapeHtml(row.needed)}</div>
              <div class="job-bom-stat-label">Qty</div>
            </div>
            <div class="job-bom-stat">
              <div class="job-bom-stat-value ${onHandClass}">${escapeHtml(row.onHand)}</div>
              <div class="job-bom-stat-label">On Hand</div>
            </div>
            <div class="job-bom-stat">
              <div class="job-bom-stat-value">${escapeHtml(row.allocated)}</div>
              <div class="job-bom-stat-label">Allocated</div>
            </div>
            <div class="job-bom-stat">
              <div class="job-bom-stat-value">${escapeHtml(row.remaining)}</div>
              <div class="job-bom-stat-label">Remaining</div>
            </div>
          </div>
          ${(cartBtn || deleteBtn) ? `<div class="job-bom-card-footer">${cartBtn}${deleteBtn}</div>` : ''}
        </div>`;
      }).join('')}</div>`;
    }

    function renderJobsList(){
      const list = $('jobsList');
      if(!list) return;
      const rows = Array.isArray(state._jobs) ? state._jobs : [];
      updateMenuJobsBadge(rows);
      if(!rows.length){
        list.innerHTML = `<div class="order-empty">No jobs yet.</div>`;
        updateApproveReadyCountBadge(0);
        return;
      }
      const canAdmin = canItemsDelete();
      const reservedMap = state._jobReservedMap || new Map();
      const inventoryMap = state._jobInventoryByItemId || new Map();
      const jobAllocationsByJobId = state._jobAllocationsByJobId || new Map();
      const jobShortfallsByJobId = state._jobShortfallsByJobId || new Map();
      const jobReadinessByJobId = state._jobReadinessByJobId || new Map();
      const expanded = state._jobsExpanded || new Set();
      let html = `<div class="jobs-list">`;
      for(const row of rows){
        const id = String(row.id || '').trim();
        if(!id) continue;
        const name = String(row.name || '').trim() || '(Untitled job)';
        const jobNumber = getJobNumberValue(row);
        const displayName = jobNumber ? `Job ${jobNumber} - ${name}` : name;
        const status = String(row.status || 'draft').trim();
        const isCompleted = status === 'completed';
        const created = row.created_at ? formatDateShort(row.created_at) : 'â€”';
        const completedDate = isCompleted ? getJobCompletionDate(row) : '';
        const metaDate = isCompleted ? (completedDate || 'â€”') : created;
        const bomLines = state._jobBomByJobId && state._jobBomByJobId.get ? (state._jobBomByJobId.get(id) || []) : [];
        const jobAllocations = jobAllocationsByJobId && jobAllocationsByJobId.get ? jobAllocationsByJobId.get(id) : null;
        const jobShortfalls = jobShortfallsByJobId && jobShortfallsByJobId.get ? jobShortfallsByJobId.get(id) : null;
        const usesPlannedShortfall = !isCompleted && ['draft', 'quoted'].includes(status);
        let totalNeeded = 0;
        let totalOnHand = 0;
        let totalShortage = 0;
        if(!isCompleted){
          bomLines.forEach(line=>{
            const itemId = String(line.item_id || '').trim();
            const qtyPlanned = Number(line.qty_planned || 0);
            const stats = computeJobLineStats(itemId, qtyPlanned, reservedMap, inventoryMap);
            const hasRecorded = jobShortfalls && typeof jobShortfalls.has === 'function' && jobShortfalls.has(itemId);
            const recordedShortfall = hasRecorded ? shortfallQtyFromEntry(jobShortfalls.get(itemId)) : null;
            const shortfallQty = Number.isFinite(recordedShortfall)
              ? recordedShortfall
              : (usesPlannedShortfall ? stats.shortfall : 0);
            totalNeeded += qtyPlanned;
            totalOnHand += stats.onHand;
            totalShortage += Math.max(0, shortfallQty);
          });
        }
        const readiness = (!isCompleted && jobReadinessByJobId && typeof jobReadinessByJobId.get === 'function')
          ? jobReadinessByJobId.get(id)
          : null;
        const readinessState = readiness ? (readiness.ready ? 'ready' : 'not-ready') : 'unknown';
        const readinessLabel = readiness ? jobReadinessLabel(readiness.ready) : 'Unknown';
        const readinessReasons = readiness ? formatJobReadinessReasons(readiness.reasons) : [];
        const readinessTitle = readiness
          ? (readinessReasons.length ? `${readinessLabel}: ${readinessReasons.join(', ')}` : readinessLabel)
          : 'Readiness unavailable';
        const itemCount = bomLines.length;
        const summary = `${itemCount} item${itemCount === 1 ? '' : 's'}`;
        const isExpanded = expanded.has(id);
        const toggleLabel = isExpanded ? 'Collapse job' : 'Expand job';
        const badgeTone = (status === 'approved' || status === 'completed')
          ? 'approved'
          : (status === 'draft' || status === 'voided')
            ? 'draft'
            : 'pending';
        const badgeLabel = (status === 'approved')
          ? 'Approved'
          : (status === 'completed')
            ? 'Completed'
            : (status === 'draft')
              ? 'Draft'
              : (status === 'voided')
                ? 'Voided'
                : 'Pending';
        const shortageLabel = totalShortage > 0 ? `${formatQty(totalShortage)} short` : '';
        const approveAllowed = canAdmin && canApproveJob(status);
        const approveReady = !!(readiness && readiness.ready);
        const approveDisabled = approveAllowed && !approveReady;
        const approveTitle = approveReady
          ? 'Approve job'
          : (readiness ? 'Approval blocked by missing inventory' : 'Approval readiness unavailable');
        const readinessHtml = !isCompleted
          ? `<span class="job-readiness-pill job-readiness-pill--${escapeHtmlAttr(readinessState)}" title="${escapeHtmlAttr(readinessTitle)}">${escapeHtml(readinessLabel)}</span>`
          : '';
        const summaryHtml = !isCompleted
          ? `<span class="job-summary">${escapeHtml(summary)}</span>`
          : '';
        const shortageHtml = (!isCompleted && totalShortage > 0)
          ? `<span class="job-shortage" title="${escapeHtmlAttr(shortageLabel)}">${ICONS.alertTriangle}<span>${escapeHtml(shortageLabel)}</span></span>`
          : '';
        html += (
          `<div class="job-row" data-job-row="${escapeHtmlAttr(id)}" aria-expanded="${isExpanded ? 'true' : 'false'}">`+
            `<div class="job-card-header" data-job-toggle-id="${escapeHtmlAttr(id)}">`+
              `<button class="job-chevron" data-job-toggle-id="${escapeHtmlAttr(id)}" aria-label="${escapeHtmlAttr(toggleLabel)}" title="${escapeHtmlAttr(toggleLabel)}">${ICONS.chevronRight}</button>`+
              `<div class="job-header-main">`+
                `<div class="job-name" title="${escapeHtmlAttr(displayName)}">${escapeHtml(displayName)}</div>`+
                `<div class="job-header-meta">`+
                  `<span class="job-status-pill job-status-pill--${escapeHtmlAttr(badgeTone)}">${escapeHtml(badgeLabel)}</span>`+
                  `${readinessHtml}`+
                  `<span class="job-meta">${escapeHtml(metaDate)}</span>`+
                  `${summaryHtml}`+
                  `${shortageHtml}`+
                `</div>`+
              `</div>`+
              `<div class="job-actions">`+
                `<button class="icon-btn icon-btn--default job-action--edit" data-job-edit-id="${escapeHtmlAttr(id)}" aria-label="Edit job" title="Edit job">${ICONS.pencil}</button>`+
                (approveAllowed ? `<button class="icon-btn icon-btn--success job-action--approve" data-job-approve-id="${escapeHtmlAttr(id)}" aria-label="Approve job" title="${escapeHtmlAttr(approveTitle)}"${approveDisabled ? ' disabled aria-disabled="true"' : ''}>${ICONS.checkCircle}</button>` : '')+
                (canAdmin && canCompleteJob(status) ? `<button class="icon-btn icon-btn--success job-action--complete" data-job-complete-id="${escapeHtmlAttr(id)}" aria-label="Complete job" title="Complete job">${ICONS.check}</button>` : '')+
                (canAdmin && canVoidJob(status) ? `<button class="icon-btn icon-btn--danger job-action--void" data-job-void-id="${escapeHtmlAttr(id)}" aria-label="Void job" title="Void job">${ICONS.xCircle}</button>` : '')+
              `</div>`+
            `</div>`+
          `</div>`
        );
        if(isExpanded){
          if(!bomLines.length){
            html += `<div class="job-detail"><div class="muted">No BOM items yet.</div></div>`;
          }else if(isCompleted){
            html += `<div class="job-detail"><div class="muted">Job completed. View this job to see actuals and completion details.</div></div>`;
          }else{
            // Transform bomLines to UDWE data format
            const incomingMap = buildInventoryIncomingMap();
            const bomData = bomLines.map(line => {
              const itemId = String(line.item_id || '').trim();
              const qtyPlanned = Number(line.qty_planned || 0);
              const item = getInventoryById(itemId);
              const itemName = item ? String(item.name || '') : itemId;
              const sku = item && item.sku ? String(item.sku || '').trim() : '';
              const stats = computeJobLineStats(itemId, qtyPlanned, reservedMap, inventoryMap);
              const allocatedForJob = jobAllocations && jobAllocations.has(itemId) ? Number(jobAllocations.get(itemId)) : 0;
              const remaining = Number.isFinite(stats.available) ? stats.available : 0;
              const hasRecorded = jobShortfalls && typeof jobShortfalls.has === 'function' && jobShortfalls.has(itemId);
              const shortfallEntry = hasRecorded ? jobShortfalls.get(itemId) : null;
              const recordedShortfall = hasRecorded ? shortfallQtyFromEntry(shortfallEntry) : null;
              const shortfallQty = Number.isFinite(recordedShortfall)
                ? recordedShortfall
                : (usesPlannedShortfall ? stats.shortfall : 0);
              const shortfallId = shortfallIdFromEntry(shortfallEntry);
              const orderLinkCount = (state._shortfallOrdersLoaded && shortfallId && state._shortfallOrdersById && typeof state._shortfallOrdersById.get === 'function')
                ? (state._shortfallOrdersById.get(shortfallId) || 0)
                : null;
              // Check for open POs
              const incoming = incomingMap.get(itemId);
              const hasOpenPO = incoming && incoming.qty > 0;
              const incomingQty = incoming ? incoming.qty : 0;
              const incomingOrderCount = incoming ? incoming.orders.size : 0;
              let statusText = 'In Stock';
              let statusClass = 'job-item-status--in-stock';
              let statusIcon = ICONS.check;
              if(shortfallQty > 0){
                statusText = (orderLinkCount !== null)
                  ? (orderLinkCount > 0 ? 'Shortfall â€¢ Order in progress' : 'Shortfall â€¢ No order yet')
                  : 'Shortfall';
                statusClass = 'job-item-status--shortage';
                statusIcon = ICONS.alertTriangle;
              }else if(remaining <= 0){
                statusText = 'Out of Stock';
                statusClass = 'job-item-status--out';
                statusIcon = ICONS.xCircle;
              }else if(remaining < qtyPlanned){
                statusText = 'Low Stock';
                statusClass = 'job-item-status--low-stock';
                statusIcon = ICONS.alertTriangle;
              }
              const shortage = Math.max(0, shortfallQty);
              const needsOrder = shortfallQty > 0 && !hasOpenPO;
              return {
                jobId: id,
                jobStatus: status,
                canDelete: ['draft', 'quoted'].includes(status),
                item: itemName,
                itemName,
                itemId,
                sku,
                needed: formatQty(qtyPlanned),
                onHand: formatQty(stats.onHand),
                allocated: formatQty(Number.isFinite(allocatedForJob) ? allocatedForJob : 0),
                remaining: formatQty(Number.isFinite(remaining) ? remaining : 0),
                status: statusText,
                statusText,
                statusClass,
                statusIcon,
                needsOrder,
                shortage,
                shortfallId,
                shortfallOrderCount: orderLinkCount,
                hasOpenPO,
                incomingQty,
                incomingOrderCount
              };
            });
            html += `<div class="job-detail">`;
            html += renderJobBomCards(bomData);
            html += (
              `<div class="job-items-summary">`+
                `<span><span>Total Needed</span><span>${escapeHtml(formatQty(totalNeeded))}</span></span>`+
                `<span><span>Total On Hand</span><span>${escapeHtml(formatQty(totalOnHand))}</span></span>`+
                `<span class="${totalShortage > 0 ? 'job-total-short' : ''}"><span>Total Shortage</span><span>${escapeHtml(formatQty(totalShortage))}</span></span>`+
              `</div>`
            );
            html += `</div>`;
          }
        }
      }
      html += `</div>`;
      list.innerHTML = html;
      try{ initButtonSystem.refresh(); }catch(e){}
      updateApproveReadyCountBadge();
    }
    function isApproveReadyStatus(status){
      const raw = String(status || '').trim().toLowerCase();
      return raw === 'draft' || raw === 'planned';
    }
    function computeApproveReadyCount(){
      const rows = Array.isArray(state._jobs) ? state._jobs : [];
      const readinessMap = state._jobReadinessByJobId || new Map();
      let count = 0;
      rows.forEach(job=>{
        const id = String(job && job.id ? job.id : '').trim();
        if(!id) return;
        if(!isApproveReadyStatus(job && job.status)) return;
        const readiness = readinessMap && typeof readinessMap.get === 'function' ? readinessMap.get(id) : null;
        if(readiness && readiness.ready) count += 1;
      });
      return count;
    }
    function updateApproveReadyCountBadge(count){
      const badge = $('btnJobsApproveReadyCount');
      if(!badge) return;
      const value = Number.isFinite(count) ? count : computeApproveReadyCount();
      if(value > 0){
        badge.textContent = String(value);
        badge.style.display = 'inline-flex';
      }else{
        badge.textContent = '0';
        badge.style.display = 'none';
      }
    }
    function renderApproveReadyModal(){
      const list = $('approveReadyList');
      const empty = $('approveReadyEmpty');
      const loading = $('approveReadyLoading');
      if(!list || !empty || !loading) return;
      const jobs = Array.isArray(state._approveReadyJobs) ? state._approveReadyJobs : [];
      const isLoading = !!state._approveReadyLoading;
      const error = String(state._approveReadyError || '').trim();
      list.innerHTML = '';
      if(isLoading){
        loading.style.display = 'block';
        empty.style.display = 'none';
        return;
      }
      loading.style.display = 'none';
      if(error){
        empty.textContent = error;
        empty.style.display = 'block';
        return;
      }
      if(!jobs.length){
        empty.textContent = 'No jobs are ready for approval right now.';
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      list.innerHTML = jobs.map(entry=>{
        const job = entry && entry.job ? entry.job : {};
        const id = String(job.id || '').trim();
        const nameWithNumber = formatJobNameWithNumber(job);
        const name = (nameWithNumber && nameWithNumber !== 'Job')
          ? nameWithNumber
          : (id ? `Job ${shortId(id)}` : 'Job');
        const created = job.created_at ? `Created ${formatDateShort(job.created_at)}` : '';
        const subtext = created || 'All required inventory is available.';
        return (
          `<div class="mini-card mini-card--committed approve-ready-card">`+
            `<div class="mini-card-main">`+
              `<div class="mini-card-title" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</div>`+
              `<div class="mini-card-subtext">${escapeHtml(subtext)}</div>`+
              `${created ? '<div class="mini-card-subtext">All required inventory is available.</div>' : ''}`+
            `</div>`+
            `<div class="mini-card-meta">`+
              `<span class="mini-card-badge mini-card-badge--committed">Approval ready</span>`+
              `<button class="btn-secondary btn-sm approve-ready-action" type="button" data-approve-ready-id="${escapeHtmlAttr(id)}">Review &amp; approve</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    async function loadApproveReadyJobs(){
      state._approveReadyLoading = true;
      state._approveReadyError = '';
      state._approveReadyJobs = [];
      renderApproveReadyModal();
      if(!SB.ready || !SB.session || !SB.companyId){
        state._approveReadyLoading = false;
        state._approveReadyError = 'Sign in required to view readiness.';
        renderApproveReadyModal();
        return;
      }
      try{
        const rows = await sbFetchJobs();
        state._jobs = rows;
        state._jobsById = new Map(rows.map(r => [String(r.id || ''), r]).filter(x => x[0]));
        const candidates = (rows || []).filter(job => isApproveReadyStatus(job && job.status));
        const results = await Promise.all(candidates.map(async job=>{
          try{
            const detail = await sbFetchJobReadinessDetails(job.id);
            if(detail && detail.ready_for_approval){
              return { job, detail };
            }
          }catch(e){}
          return null;
        }));
        const readyJobs = results.filter(Boolean);
        state._approveReadyJobs = readyJobs;
        updateApproveReadyCountBadge(readyJobs.length);
      }catch(e){
        state._approveReadyError = e && e.message ? e.message : 'Unable to load approve-ready jobs.';
      }finally{
        state._approveReadyLoading = false;
        renderApproveReadyModal();
      }
    }
    function openApproveReadyModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); return; }
      if(!requirePermission(PERMISSIONS.ITEMS_VIEW, 'Inventory access required')) return;
      show('approveReadyModal', true);
      void loadApproveReadyJobs();
    }
    function toggleJobExpanded(jobId){
      const id = String(jobId || '').trim();
      if(!id) return;
      if(!state._jobsExpanded || typeof state._jobsExpanded.has !== 'function'){
        state._jobsExpanded = new Set();
      }
      if(state._jobsExpanded.has(id)) state._jobsExpanded.delete(id);
      else state._jobsExpanded.add(id);
      renderJobsList();
    }
    async function refreshJobs(){
      const list = $('jobsList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setJobsMessage('');
      try{
        await ensureInventoryLoaded();
        const rows = await sbFetchJobs();
        state._jobs = rows;
        state._jobsById = new Map(rows.map(r => [String(r.id || ''), r]).filter(x => x[0]));
        const jobIds = rows.map(r => r && r.id).filter(Boolean);
        const readinessJobIds = rows
          .filter(r => String(r && r.status ? r.status : '').trim() !== 'completed')
          .map(r => r && r.id)
          .filter(Boolean);
        state._jobBomByJobId = await sbFetchJobBomForJobs(jobIds);
        state._jobReservedMap = await sbFetchReservedMap();
        state._jobAllocationsByJobId = await sbFetchAllocationsForJobs(jobIds);
        state._jobShortfallsByJobId = await sbFetchShortfallsForJobs(jobIds);
        if(canOrdersView()){
          const shortfallIds = collectShortfallIdsFromMap(state._jobShortfallsByJobId);
          try{
            state._shortfallOrdersById = shortfallIds.length
              ? await sbFetchOrderShortfallLinks(shortfallIds)
              : new Map();
            state._shortfallOrdersLoaded = true;
          }catch(e){
            state._shortfallOrdersById = new Map();
            state._shortfallOrdersLoaded = false;
          }
        }else{
          state._shortfallOrdersById = new Map();
          state._shortfallOrdersLoaded = false;
        }
        try{
          state._jobReadinessByJobId = readinessJobIds.length
            ? await sbFetchJobReadiness(readinessJobIds)
            : new Map();
        }catch(e){
          state._jobReadinessByJobId = new Map();
        }
        try{
          const allBomLines = [];
          state._jobBomByJobId.forEach(lines=>{
            if(Array.isArray(lines)) allBomLines.push(...lines);
          });
          const itemIds = getJobBomItemIds(allBomLines);
          state._jobInventoryByItemId = await sbFetchInventoryByItemIds(itemIds);
        }catch(e){
          state._jobInventoryByItemId = new Map();
        }
        renderJobsList();
      }catch(e){
        state._jobs = [];
        state._jobsById = new Map();
        state._jobBomByJobId = new Map();
        state._jobReservedMap = new Map();
        state._jobAllocationsByJobId = new Map();
        state._jobShortfallsByJobId = new Map();
        state._jobReadinessByJobId = new Map();
        state._shortfallOrdersById = new Map();
        state._shortfallOrdersLoaded = false;
        state._jobInventoryByItemId = new Map();
        const msg = e && e.message ? e.message : 'Failed to load jobs';
        if(list) list.innerHTML = `<div class="order-empty">${escapeHtml(msg)}</div>`;
        updateApproveReadyCountBadge(0);
      }
    }
    async function openJobsModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!requirePermission(PERMISSIONS.ITEMS_VIEW, 'Inventory access required')) return;
      show('jobsModal', true);
      await refreshJobs();
    }
    function closeJobsModal(){
      show('jobsModal', false);
    }
    function renderJobEditor(){
      const editor = state._jobEditor;
      const job = editor ? editor.job : null;
      const status = job ? String(job.status || 'draft') : 'draft';
      const isCompleted = status === 'completed';
      const editable = job ? isJobEditable(status) : true;
      const canAdmin = canItemsDelete();
      const statusLabel = jobStatusLabel(status);
      const lines = getJobEditorLines(editor);
      const totals = computeJobTotals(editor);
      const actualMap = getJobActualMap(editor);
      const nameOk = !!(job && String(job.name || '').trim());
      const hasShortfall = !isCompleted && totals.totalShortfall > 0;

      syncJobActualDraftFromDom();
      ensureJobEditorIcons();

      const statusName = $('jobStatusName');
      const statusBadge = $('jobStatusBadge');
      const statusPill = $('jobStatusPill');
      const materialsReadinessBanner = $('jobMaterialsReadinessBanner');
      const materialsReadinessIcon = $('jobMaterialsReadinessIcon');
      const materialsReadinessText = $('jobMaterialsReadinessText');
      const materialsReadinessSub = $('jobMaterialsReadinessSub');
      const nameInput = $('jobNameInput');
      const notesInput = $('jobNotesInput');
      const completionNotesInput = $('jobCompletionNotesInput');
      const createdMeta = $('jobCreatedMeta');
      const approveSection = $('jobApprovalSection');
      const completeSection = $('jobCompletionSection');
      const voidSection = $('jobVoidSection');
      const detailsCheck = $('jobTabDetailsCheck');
      const materialsBadge = $('jobTabMaterialsBadge');
      const executionBadge = $('jobTabExecutionBadge');
      const detailItems = $('jobDetailsStatItems');
      const detailItemsLabel = $('jobDetailsStatItemsLabel');
      const detailPlanned = $('jobDetailsStatPlanned');
      const detailPlannedLabel = $('jobDetailsStatPlannedLabel');
      const detailShortfall = $('jobDetailsStatShortfall');
      const detailShortfallLabel = $('jobDetailsStatShortfallLabel');
      const detailShortfallWrap = $('jobDetailsStatShortfallWrap');
      const completionTotalsNote = $('jobCompletionTotalsNote');
      const nextMaterials = $('btnJobNextMaterials');
      const nextExecution = $('btnJobNextExecution');
      const detailsHint = $('jobDetailsHint');
      const materialsHint = $('jobMaterialsHint');
      const shortfallBox = $('jobShortfallInfoBox');
      const shortfallTitle = $('jobShortfallInfoTitle');
      const jobCompletedState = $('jobCompletedState');
      const jobCompletionSummary = $('jobCompletionSummary');
      const jobCompletionSummaryContent = $('jobCompletionSummaryContent');
      const jobCompletionOrders = $('jobCompletionOrders');
      const jobCompletionOrdersContent = $('jobCompletionOrdersContent');
      const jobCompletionAudit = $('jobCompletionAudit');
      const jobCompletionAuditContent = $('jobCompletionAuditContent');
      const jobCompletionAuditHint = $('jobCompletionAuditHint');
      const jobReopenSection = $('jobReopenSection');
      const jobReopenBanner = $('jobReopenBanner');
      const btnJobReopen = $('btnJobReopen');
      const jobVoidedState = $('jobVoidedState');
      const completionPercent = $('jobCompletionPercent');
      const completionFill = $('jobCompletionProgressFill');
      const completionStats = $('jobCompletionStats');
      const completionProgressCard = $('jobCompletionProgressCard');
      const addItemBtn = $('btnJobAddItem');
      const jobEditorTitle = $('jobEditorTitle');

      const jobNameText = job && job.name ? String(job.name || '').trim() : 'Untitled Job';
      const jobNumber = job ? getJobNumberValue(job) : '';
      const jobTitle = jobNumber ? `Job ${jobNumber}` : 'Job';
      const jobDisplayName = jobNumber ? `Job ${jobNumber} - ${jobNameText}` : jobNameText;
      const completionDateText = isCompleted ? getJobCompletionDate(job) : '';
      const statusDisplayText = isCompleted
        ? (completionDateText ? `COMPLETED â€¢ ${completionDateText}` : 'COMPLETED')
        : statusLabel.toUpperCase();
      let itemsUsed = 0;
      let totalConsumed = 0;
      if(actualMap && actualMap.size){
        actualMap.forEach(qty=>{
          const val = Number(qty || 0);
          if(val > 0){
            itemsUsed += 1;
            totalConsumed += val;
          }
        });
      }

      if(jobEditorTitle) jobEditorTitle.textContent = jobTitle;
      if(statusName) statusName.textContent = jobDisplayName;
      if(statusBadge){
        statusBadge.textContent = statusDisplayText;
        statusBadge.className = `job-status-badge job-status-badge--${status}`;
      }
      if(statusPill){
        statusPill.textContent = statusDisplayText;
        statusPill.className = `job-status-display job-status-badge--${status}`;
      }
      // Update materials readiness banner (Materials tab only)
      if(materialsReadinessBanner && !isCompleted){
        let bannerState = 'empty';
        let bannerText = 'Add materials to determine job readiness.';
        let bannerSub = '';
        let bannerIcon = ICONS.info;
        if(lines.length === 0){
          bannerState = 'empty';
          bannerText = 'Add materials to determine job readiness.';
          bannerIcon = ICONS.info;
        }else if(hasShortfall){
          bannerState = 'shortage';
          bannerText = 'Materials incomplete â€” job not ready.';
          bannerSub = `Shortfall: ${formatQty(totals.totalShortfall)}`;
          bannerIcon = ICONS.alertTriangle;
        }else{
          bannerState = 'ready';
          bannerText = 'All required materials available â€” job ready.';
          bannerIcon = ICONS.checkCircle;
        }
        materialsReadinessBanner.className = `job-materials-readiness-banner job-materials-readiness-banner--${bannerState}`;
        if(materialsReadinessIcon) materialsReadinessIcon.innerHTML = bannerIcon;
        if(materialsReadinessText) materialsReadinessText.textContent = bannerText;
        if(materialsReadinessSub){
          materialsReadinessSub.textContent = bannerSub;
          materialsReadinessSub.style.display = bannerSub ? '' : 'none';
        }
      }else if(materialsReadinessBanner && isCompleted){
        materialsReadinessBanner.style.display = 'none';
      }
      if(createdMeta){
        const created = job && job.created_at ? formatDateShort(job.created_at) : '';
        createdMeta.textContent = created || '--';
      }
      if(nameInput) nameInput.value = job ? String(job.name || '') : '';
      if(notesInput) notesInput.value = job ? String(job.notes || '') : '';
      if(completionNotesInput) completionNotesInput.value = job ? String(job.notes || '') : '';

      if(nameInput) nameInput.disabled = !editable;
      if(notesInput) notesInput.disabled = !(editable || isCompleted);
      if(completionNotesInput) completionNotesInput.disabled = !(editable || isCompleted);
      if(addItemBtn) addItemBtn.disabled = state._jobEditorBusy || !editable;

      const hasJob = !!(job && job.id);
      if(!hasJob){
        setJobBomMessage('Use the Jobs wizard to create a new job.');
      }

      if(approveSection){
        approveSection.style.display = (!isCompleted && job && job.id && canApproveJob(status)) ? 'block' : 'none';
        const btn = $('btnJobApprove');
        if(btn){
          const hasShortfall = totals.totalShortfall > 0;
          btn.textContent = hasShortfall ? 'Approve Job & Reserve Stock' : 'Approve Job';
          btn.disabled = !(job && job.id && canApproveJob(status) && canAdmin) || hasShortfall;
          btn.title = hasShortfall ? 'Resolve all shortfalls before approving' : '';
        }
      }
      if(completeSection){
        const showSection = job && job.id && (canCompleteJob(status) || isCompleted);
        completeSection.style.display = showSection ? 'block' : 'none';
        if(completionProgressCard) completionProgressCard.style.display = isCompleted ? 'none' : '';
        const btn = $('btnJobComplete');
        if(btn){
          btn.disabled = !(job && job.id && canCompleteJob(status) && canAdmin && totals.completionPercent >= 100);
          btn.style.display = isCompleted ? 'none' : '';
        }
      }
      if(voidSection){
        voidSection.style.display = (job && job.id && canVoidJob(status)) ? 'block' : 'none';
        const btn = $('btnJobVoid');
        if(btn) btn.disabled = !(job && job.id && canVoidJob(status) && canAdmin);
      }

      if(detailsCheck){
        detailsCheck.style.display = nameOk ? 'inline-flex' : 'none';
        detailsCheck.innerHTML = nameOk ? ICONS.check : '';
      }
      if(materialsBadge){
        materialsBadge.textContent = String(lines.length);
        materialsBadge.classList.toggle('warning', !isCompleted && totals.totalShortfall > 0);
      }
      if(executionBadge){
        if(job && String(job.status || '') !== 'draft'){
          executionBadge.textContent = `${totals.completionPercent}%`;
          executionBadge.style.display = 'inline-flex';
        }else{
          executionBadge.style.display = 'none';
        }
      }
      if(isCompleted){
        if(detailItems) detailItems.textContent = formatQty(itemsUsed);
        if(detailItemsLabel) detailItemsLabel.textContent = 'Items used';
        if(detailPlanned) detailPlanned.textContent = formatQty(totalConsumed);
        if(detailPlannedLabel) detailPlannedLabel.textContent = 'Total consumed';
        if(detailShortfallWrap) detailShortfallWrap.style.display = 'none';
        if(detailShortfallLabel) detailShortfallLabel.textContent = '';
        if(completionTotalsNote){
          if(totalConsumed > 0){
            completionTotalsNote.textContent = '';
            completionTotalsNote.style.display = 'none';
          }else{
            completionTotalsNote.textContent = 'No inventory changes were recorded for this job.';
            completionTotalsNote.style.display = 'block';
          }
        }
      }else{
        if(detailItems) detailItems.textContent = String(lines.length);
        if(detailItemsLabel) detailItemsLabel.textContent = 'BOM Items';
        if(detailPlanned) detailPlanned.textContent = formatQty(totals.totalPlanned);
        if(detailPlannedLabel) detailPlannedLabel.textContent = 'Total Planned';
        if(detailShortfallWrap) detailShortfallWrap.style.display = '';
        if(detailShortfallLabel) detailShortfallLabel.textContent = 'Shortfall';
        if(detailShortfall){
          detailShortfall.textContent = formatQty(totals.totalShortfall);
          detailShortfall.classList.toggle('danger', totals.totalShortfall > 0);
          detailShortfall.classList.toggle('success', totals.totalShortfall === 0);
        }
        if(completionTotalsNote){
          completionTotalsNote.textContent = '';
          completionTotalsNote.style.display = 'none';
        }
      }
      if(nextMaterials){
        nextMaterials.disabled = !nameOk;
        nextMaterials.style.opacity = nameOk ? '1' : '0.5';
      }
      if(detailsHint) detailsHint.textContent = nameOk ? '' : 'Enter a job name to continue.';
      if(nextExecution){
        const showNext = lines.length > 0;
        nextExecution.style.display = showNext ? 'flex' : 'none';
        nextExecution.disabled = !showNext;
        nextExecution.style.opacity = showNext ? '1' : '0.5';
      }
      if(materialsHint){
        materialsHint.textContent = (!isCompleted && totals.totalShortfall > 0)
          ? `${formatQty(totals.totalShortfall)} items in shortfall. Approval is blocked until shortfalls are resolved.`
          : '';
      }
      if(shortfallBox){
        const hasApprovalShortages = Array.isArray(state._jobApprovalShortages) && state._jobApprovalShortages.length > 0;
        shortfallBox.style.display = (!isCompleted && (totals.totalShortfall > 0 || hasApprovalShortages)) ? 'block' : 'none';
      }
      if(shortfallTitle){
        shortfallTitle.textContent = (!isCompleted && totals.totalShortfall > 0)
          ? `${formatQty(totals.totalShortfall)} items in shortfall`
          : 'Items in shortfall';
      }
      if(jobCompletedState){
        jobCompletedState.style.display = (status === 'completed') ? 'block' : 'none';
      }
      if(jobCompletionSummary){
        const showSummary = (status === 'completed');
        jobCompletionSummary.style.display = showSummary ? 'block' : 'none';
        if(jobCompletionSummaryContent){
          jobCompletionSummaryContent.innerHTML = showSummary ? buildJobCompletionSummary(editor) : '';
        }
        if(completionNotesInput){
          completionNotesInput.style.display = showSummary ? 'block' : 'none';
        }
      }
      if(jobCompletionAudit){
        const showAudit = (status === 'completed');
        jobCompletionAudit.style.display = showAudit ? 'block' : 'none';
        if(jobCompletionAuditContent){
          jobCompletionAuditContent.innerHTML = showAudit ? buildJobCompletionAudit(editor) : '';
        }
        if(jobCompletionAuditHint) jobCompletionAuditHint.style.display = showAudit ? 'block' : 'none';
      }
      if(jobCompletionOrders){
        const showOrders = (status === 'completed');
        jobCompletionOrders.style.display = showOrders ? 'block' : 'none';
        if(jobCompletionOrdersContent){
          jobCompletionOrdersContent.innerHTML = showOrders ? buildJobCompletionOrders(editor) : '';
        }
      }
      if(jobReopenSection){
        jobReopenSection.style.display = (status === 'completed') ? 'flex' : 'none';
      }
      if(btnJobReopen){
        btnJobReopen.disabled = !(job && job.id && status === 'completed' && canAdmin) || !!state._jobEditorBusy;
      }
      if(jobReopenBanner){
        const showBanner = !!(job && job.id && status !== 'completed' && status !== 'voided' && state._jobReopenedById && state._jobReopenedById.has(String(job.id)));
        jobReopenBanner.style.display = showBanner ? 'block' : 'none';
      }
      if(jobVoidedState){
        jobVoidedState.style.display = (status === 'voided') ? 'block' : 'none';
      }
      if(completionPercent) completionPercent.textContent = `${totals.completionPercent}%`;
      if(completionFill) completionFill.style.width = `${Math.min(100, Math.max(0, totals.completionPercent))}%`;
      if(completionStats) completionStats.textContent = `${formatQty(totals.totalActual)} / ${formatQty(totals.totalPlanned)} items consumed`;

      updateJobProgressStepper(editor);
      applyJobEditorTabState();

      renderJobBomTable();
      renderJobActualsTable();
    }
    function computeJobLineStats(itemId, qtyPlanned, reservedMap, inventoryMap){
      const inv = (inventoryMap && typeof inventoryMap.get === 'function') ? inventoryMap.get(itemId) : null;
      const item = inv ? null : getInventoryById(itemId);
      const onHand = (inv && Number.isFinite(inv.onHand)) ? inv.onHand : (item ? toInt(item.qty, 0) : 0);
      const reserved = reservedMap && reservedMap.has(itemId) ? Number(reservedMap.get(itemId)) : 0;
      const available = onHand - reserved;
      const shortfall = Math.max(Number(qtyPlanned || 0) - available, 0);
      return { onHand, reserved, available, remaining: available, shortfall };
    }
    function updateBomIndicators(itemId, qtyPlanned){
      const editor = state._jobEditor;
      if(!editor) return;
      const stats = computeJobLineStats(itemId, qtyPlanned, editor.reservedMap, editor.inventoryMap);
      const status = editor && editor.job ? String(editor.job.status || '') : '';
      const usesPlannedShortfall = ['draft', 'quoted'].includes(status);
      const hasRecorded = editor.jobShortfalls && typeof editor.jobShortfalls.has === 'function' && editor.jobShortfalls.has(itemId);
      const recordedShortfall = hasRecorded ? shortfallQtyFromEntry(editor.jobShortfalls.get(itemId)) : null;
      const shortfallQty = Number.isFinite(recordedShortfall)
        ? recordedShortfall
        : (usesPlannedShortfall ? stats.shortfall : 0);
      const onHandEl = document.querySelector(`[data-bom-on-hand="${CSS.escape(itemId)}"]`);
      const reservedEl = document.querySelector(`[data-bom-reserved="${CSS.escape(itemId)}"]`);
      const shortfallEl = document.querySelector(`[data-bom-shortfall="${CSS.escape(itemId)}"]`);
      if(onHandEl) onHandEl.textContent = String(stats.onHand);
      if(reservedEl) reservedEl.textContent = String(stats.reserved);
      if(shortfallEl){
        shortfallEl.textContent = String(shortfallQty);
        shortfallEl.classList.toggle('job-bom-shortfall', shortfallQty > 0);
      }
    }
    function renderJobBomTable(){
      const wrap = $('jobBomTable');
      if(!wrap) return;
      const empty = $('jobBomEmpty');
      const editor = state._jobEditor;
      const job = editor ? editor.job : null;
      const status = job ? String(job.status || 'draft') : 'draft';
      const isCompleted = status === 'completed';
      const editable = job ? isJobEditable(status) : false;
      const lines = getJobEditorLines(editor);
      const reservedMap = editor ? editor.reservedMap : new Map();
      const inventoryMap = editor ? editor.inventoryMap : new Map();
      const jobAllocations = editor && editor.jobAllocations ? editor.jobAllocations : new Map();
      const jobShortfalls = editor && editor.jobShortfalls ? editor.jobShortfalls : new Map();
      const usesPlannedShortfall = ['draft', 'quoted'].includes(status);
      const incomingMap = (editor && editor.incomingMap && typeof editor.incomingMap.get === 'function')
        ? editor.incomingMap
        : buildInventoryIncomingMap();

      if(empty) empty.style.display = lines.length ? 'none' : 'block';
      if(!lines.length){
        wrap.innerHTML = '';
        return;
      }

      if(isCompleted){
        const actualMap = getJobActualMap(editor);
        let html = '';
        for(const line of lines){
          const itemId = String(line.item_id || '').trim();
          const item = getInventoryById(itemId);
          const name = item ? String(item.name || '') : 'Unknown item';
          const sku = item && item.sku ? String(item.sku || '') : '';
          const actualRaw = actualMap.has(itemId) ? Number(actualMap.get(itemId)) : 0;
          const actualVal = Number.isFinite(actualRaw) ? actualRaw : 0;
          const hasActual = actualVal > 0;
          const actualDisplay = hasActual ? formatQty(actualVal) : 'â€”';
          html += (
            `<div class="job-item-card completed" data-bom-item-id="${escapeHtmlAttr(itemId)}">`+
              `<div class="job-item-header">`+
                `<div class="job-item-info">`+
                  `<span class="job-item-name" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</span>`+
                  `<span class="job-item-sku">${escapeHtml(sku)}</span>`+
                `</div>`+
              `</div>`+
              `<div class="job-item-actuals">`+
                `<div class="job-item-actuals-label">Actual used</div>`+
                `<div class="job-item-actuals-value">${escapeHtml(actualDisplay)}</div>`+
              `</div>`+
              `${hasActual ? '' : '<div class="job-item-actuals-note">No actual usage recorded</div>'}`+
            `</div>`
          );
        }
        wrap.innerHTML = html;
        return;
      }

      let html = '';
      for(const line of lines){
        const itemId = String(line.item_id || '').trim();
        const item = getInventoryById(itemId);
        const name = item ? String(item.name || '') : 'Unknown item';
        const sku = item && item.sku ? String(item.sku || '') : '';
        const qtyPlanned = Math.max(1, Number(line.qty_planned || 1));
        const stats = computeJobLineStats(itemId, qtyPlanned, reservedMap, inventoryMap);
        const allocatedForJob = jobAllocations && jobAllocations.has(itemId) ? Number(jobAllocations.get(itemId)) : 0;
        const remaining = Number.isFinite(stats.available) ? stats.available : 0;
        const hasRecorded = jobShortfalls && typeof jobShortfalls.has === 'function' && jobShortfalls.has(itemId);
        const shortfallEntry = hasRecorded ? jobShortfalls.get(itemId) : null;
        const recordedShortfall = hasRecorded ? shortfallQtyFromEntry(shortfallEntry) : null;
        const shortfallQty = Number.isFinite(recordedShortfall)
          ? recordedShortfall
          : (usesPlannedShortfall ? stats.shortfall : 0);
        const shortfall = Math.max(0, shortfallQty);
        const shortfallId = shortfallIdFromEntry(shortfallEntry);
        const incoming = incomingMap.get(itemId);
        const onOrder = incoming ? Number(incoming.qty || 0) : 0;
        const orderLinkCount = (state._shortfallOrdersLoaded && shortfallId && state._shortfallOrdersById && typeof state._shortfallOrdersById.get === 'function')
          ? (state._shortfallOrdersById.get(shortfallId) || 0)
          : null;
        const statusClass = shortfall > 0
          ? (onOrder >= shortfall ? 'status-pending' : 'status-shortage')
          : 'status-good';
        const onHandClass = stats.onHand <= 0
          ? 'on-hand-out'
          : (stats.onHand < qtyPlanned ? 'on-hand-low' : 'on-hand-good');
        const expanded = state._jobEditorExpandedItemId === itemId;
        const disableControls = !editable || !!state._jobEditorBusy;
        const plannedDisplay = formatQty(qtyPlanned);
        const stillNeeded = Math.max(0, shortfall - onOrder);
        const inCartQty = getOrderQtyForItem(itemId);
        const orderBtnHtml =
          `<button class="job-add-to-po-btn" type="button" data-bom-order-id="${escapeHtmlAttr(itemId)}" data-bom-order-job-id="${escapeHtmlAttr(String(job && job.id ? job.id : ''))}" data-bom-order-shortfall-id="${escapeHtmlAttr(String(shortfallId || ''))}" data-bom-order-shortfall-qty="${escapeHtmlAttr(String(shortfall))}" data-bom-order-qty="${escapeHtmlAttr(String(stillNeeded > 0 ? stillNeeded : shortfall))}">`+
            `${ICONS.shoppingCart}`+
            `<span>${onOrder >= shortfall ? 'Add More' : '+' + escapeHtml(String(stillNeeded || shortfall))}</span>`+
          `</button>`;
        const orderActionHtml = inCartQty > 0
          ? `<div class="job-add-to-po-wrap">${orderBtnHtml}<span class="job-add-to-po-note">Qty ${escapeHtml(formatQty(inCartQty))} in cart</span></div>`
          : orderBtnHtml;

        html += (
          `<div class="job-item-card ${statusClass}${expanded ? ' expanded' : ''}" data-bom-card data-bom-item-id="${escapeHtmlAttr(itemId)}">`+
            `<div class="job-item-header">`+
              `<div class="job-item-info">`+
                `<span class="job-item-name" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</span>`+
                `<span class="job-item-sku">${escapeHtml(sku)}</span>`+
              `</div>`+
              `<div class="job-item-planned">`+
                `<span class="job-planned-label">Planned</span>`+
                `<div class="job-planned-stepper" data-bom-stepper>`+
                  `<button class="job-step-btn" type="button" data-bom-step="dec" data-bom-item-id="${escapeHtmlAttr(itemId)}"${disableControls || qtyPlanned <= 1 ? ' disabled' : ''}>-</button>`+
                  `<span class="job-planned-value" data-bom-planned-value="${escapeHtmlAttr(itemId)}">${escapeHtml(plannedDisplay)}</span>`+
                  `<button class="job-step-btn" type="button" data-bom-step="inc" data-bom-item-id="${escapeHtmlAttr(itemId)}"${disableControls ? ' disabled' : ''}>+</button>`+
                `</div>`+
                `<input type="hidden" class="job-planned-input" data-bom-qty-input="${escapeHtmlAttr(itemId)}" value="${escapeHtmlAttr(String(qtyPlanned))}">`+
              `</div>`+
            `</div>`+
            `<div class="job-stock-row">`+
              `<div class="job-stock-item">`+
                `<span class="job-stock-value readonly-value ${onHandClass}">${escapeHtml(formatQty(stats.onHand))}</span>`+
                `<span class="job-stock-label">On Hand</span>`+
              `</div>`+
              `<div class="job-stock-item">`+
                `<span class="job-stock-value readonly-value">${escapeHtml(formatQty(Number.isFinite(allocatedForJob) ? allocatedForJob : 0))}</span>`+
                `<span class="job-stock-label">Allocated (This Job)</span>`+
              `</div>`+
              `<div class="job-stock-item">`+
                `<span class="job-stock-value readonly-value">${escapeHtml(formatQty(Number.isFinite(remaining) ? remaining : 0))}</span>`+
                `<span class="job-stock-label">Remaining</span>`+
              `</div>`+
              `<div class="job-stock-item">`+
                `<span class="job-stock-value readonly-value">${escapeHtml(formatQty(onOrder))}</span>`+
                `<span class="job-stock-label">Incoming (Not Yet Received)</span>`+
              `</div>`+
            `</div>`+
            (shortfall > 0
              ? `<div class="job-shortfall-row">`+
                  `<div class="job-shortfall-info">`+
                    `<div class="job-shortfall-warning">`+
                      `${ICONS.alertTriangle}`+
                      `<span class="job-shortfall-text"><strong class="job-shortfall-value">${escapeHtml(formatQty(shortfall))}</strong> shortfall</span>`+
                    `</div>`+
                    (onOrder > 0
                      ? `<div class="job-on-order-note">`+
                          `${ICONS.package}`+
                          `<span>Incoming (Not Yet Received): ${escapeHtml(formatQty(onOrder))}</span>`+
                        `</div>`
                      : '')+
                    (orderLinkCount !== null && shortfallId
                      ? `<div class="job-shortfall-link${orderLinkCount > 0 ? ' has-order' : ''}">`+
                          `${ICONS.shoppingBag}`+
                          `<span>${orderLinkCount > 0 ? 'Order in progress' : 'No order yet'}</span>`+
                        `</div>`
                      : '')+
                  `</div>`+
                  `${orderActionHtml}`+
                `</div>`
              : '')+
            `<div class="job-expand-hint">${ICONS.chevronDown}</div>`+
            (expanded
              ? `<div class="job-item-expanded">`+
                  (canItemsEdit()
                    ? `<button class="job-item-action-btn" type="button" data-bom-edit-id="${escapeHtmlAttr(itemId)}">${ICONS.pencil}<span>Edit Item</span></button>`
                    : '')+
                  (editable
                    ? `<button class="job-item-action-btn danger" type="button" data-bom-remove-id="${escapeHtmlAttr(itemId)}">${ICONS.trash2}<span>Remove</span></button>`
                    : '')+
                `</div>`
              : '')+
          `</div>`
        );
      }
      wrap.innerHTML = html;
      try{ initButtonSystem.refresh(); }catch(e){}
    }
    function renderJobActualsTable(){
      const wrap = $('jobActualsTable');
      if(!wrap) return;
      const editor = state._jobEditor;
      const job = editor ? editor.job : null;
      const status = job ? String(job.status || 'draft') : 'draft';
      if(!job || !(canCompleteJob(status) || status === 'completed')){
        wrap.innerHTML = '';
        return;
      }
      const lines = getJobEditorLines(editor);
      const actualMap = getJobActualMap(editor);
      if(!lines.length){
        wrap.innerHTML = `<div class="muted" style="margin-top:8px;">No BOM lines found.</div>`;
        return;
      }
      let html = '';
      for(const line of lines){
        const itemId = String(line.item_id || '').trim();
        const item = getInventoryById(itemId);
        const name = item ? String(item.name || '') : 'Unknown item';
        const sku = item && item.sku ? String(item.sku || '') : '';
        const planned = Number(line.qty_planned || 0);
        const actual = actualMap.has(itemId) ? Number(actualMap.get(itemId)) : 0;
        const percent = planned > 0 ? Math.round((actual / planned) * 100) : 0;
        html += (
          `<div class="job-completion-card" data-actual-item-id="${escapeHtmlAttr(itemId)}">`+
            `<div class="job-completion-header">`+
              `<div class="job-item-info">`+
                `<span class="job-item-name" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</span>`+
                `<span class="job-item-sku">${escapeHtml(sku)}</span>`+
              `</div>`+
              `<span class="job-completion-percent${percent >= 100 ? ' complete' : ''}">${escapeHtml(String(percent))}%</span>`+
            `</div>`+
            `<div class="job-completion-row">`+
              `<div class="job-completion-planned">`+
                `<span class="job-completion-label">Planned</span>`+
                `<span class="job-completion-value">${escapeHtml(formatQty(planned))}</span>`+
              `</div>`+
              `<div class="job-completion-actual">`+
                `<span class="job-completion-label">Actual</span>`+
                `<div class="job-actual-stepper">`+
                  `<button class="job-step-btn" type="button" data-actual-step="dec" data-actual-item-id="${escapeHtmlAttr(itemId)}">-</button>`+
                  `<input class="job-actual-input" type="number" min="0" step="1" value="${escapeHtmlAttr(String(actual))}" data-actual-qty-input="${escapeHtmlAttr(itemId)}" />`+
                  `<button class="job-step-btn" type="button" data-actual-step="inc" data-actual-item-id="${escapeHtmlAttr(itemId)}">+</button>`+
                `</div>`+
              `</div>`+
            `</div>`+
            `<div class="job-mini-progress-bg">`+
              `<div class="job-mini-progress-fill${percent >= 100 ? ' complete' : ''}" style="width:${Math.min(100, Math.max(0, percent))}%"></div>`+
            `</div>`+
          `</div>`
        );
      }
      wrap.innerHTML = html;
    }
    function setPendingJobBomQty(itemId, qty){
      const editor = state._jobEditor;
      if(!editor) return;
      const id = String(itemId || '').trim();
      if(!id) return;
      const raw = Number(qty);
      const nextQty = Math.max(1, Number.isFinite(raw) ? raw : 1);
      if(!editor.pendingBomLines) editor.pendingBomLines = [];
      const list = editor.pendingBomLines.length ? editor.pendingBomLines : editor.bomLines;
      let existing = list.find(line => String(line && line.item_id ? line.item_id : '').trim() === id);
      if(existing){
        existing.qty_planned = nextQty;
      }else{
        list.push({ item_id: id, qty_planned: nextQty });
      }
      editor.bomLines = list;
      renderJobEditor();
    }
    function toggleJobEditorItemExpanded(itemId){
      const id = String(itemId || '').trim();
      if(!id) return;
      state._jobEditorExpandedItemId = (state._jobEditorExpandedItemId === id) ? '' : id;
      renderJobBomTable();
    }
    function updateJobCompletionMetricsFromDom(){
      const editor = state._jobEditor;
      if(!editor) return;
      syncJobActualDraftFromDom();
      const totals = computeJobTotals(editor);
      const completionPercent = $('jobCompletionPercent');
      const completionFill = $('jobCompletionProgressFill');
      const completionStats = $('jobCompletionStats');
      const executionBadge = $('jobTabExecutionBadge');
      const btnComplete = $('btnJobComplete');
      if(completionPercent) completionPercent.textContent = `${totals.completionPercent}%`;
      if(completionFill) completionFill.style.width = `${Math.min(100, Math.max(0, totals.completionPercent))}%`;
      if(completionStats) completionStats.textContent = `${formatQty(totals.totalActual)} / ${formatQty(totals.totalPlanned)} items consumed`;
      if(executionBadge){
        const status = editor && editor.job ? String(editor.job.status || '') : '';
        if(status && status !== 'draft'){
          executionBadge.textContent = `${totals.completionPercent}%`;
          executionBadge.style.display = 'inline-flex';
        }
      }
      if(btnComplete){
        const status = editor && editor.job ? String(editor.job.status || '') : '';
        const canComplete = canCompleteJob(status) && canItemsDelete();
        btnComplete.disabled = !(canComplete && totals.completionPercent >= 100);
      }
    }
    function collectJobActuals(){
      // Only select the card containers, not the buttons inside them
      const rows = Array.from(document.querySelectorAll('.job-completion-card[data-actual-item-id]'));
      return rows.map(row=>{
        const itemId = String(row.getAttribute('data-actual-item-id') || '').trim();
        const input = row.querySelector('[data-actual-qty-input]');
        const qty = input ? Number(input.value || 0) : 0;
        return { item_id: itemId, qty_used: qty };
      });
    }
    function parseShortageDetails(msg){
      const text = String(msg || '');
      const start = text.indexOf('[');
      const end = text.lastIndexOf(']');
      if(start === -1 || end === -1) return null;
      const raw = text.slice(start, end + 1);
      try{
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : null;
      }catch{
        return null;
      }
    }
    function renderApprovalShortages(list){
      const box = $('jobApprovalWarnings');
      if(!box) return;
      state._jobApprovalShortages = Array.isArray(list) ? list : [];
      if(!Array.isArray(list) || !list.length){
        box.style.display = 'none';
        box.innerHTML = '';
        return;
      }
      const shortfallBox = $('jobShortfallInfoBox');
      if(shortfallBox) shortfallBox.style.display = 'block';
      const rows = list.map(row=>{
        const itemId = String(row.item_id || '').trim();
        const item = getInventoryById(itemId);
        const name = item ? String(item.name || '') : itemId;
        const shortfall = Number(row.shortfall || 0);
        const required = Number(row.required || row.qty_planned || 0);
        return `<div>${escapeHtml(name)}: need ${escapeHtml(formatQty(required))}, short ${escapeHtml(formatQty(shortfall))}</div>`;
      });
      box.style.display = 'block';
      box.innerHTML = rows.join('');
    }
    const ADD_TO_JOB_NEW_VALUE = '__new__';
    function setAddToJobMessage(msg, isError = false){
      const el = $('atjMessage');
      if(!el) return;
      el.textContent = String(msg || '');
      el.className = 'atj-message' + (isError ? ' error' : '') + (msg ? ' visible' : '');
    }
    function getAddToJobJobs(){
      const rows = Array.isArray(state._jobs) ? state._jobs : [];
      return rows
        .filter(r => ['draft','quoted','approved','in_progress'].includes(String(r && r.status ? r.status : '').trim()))
        .sort((a,b)=>{
          const at = Date.parse(String(a && a.created_at ? a.created_at : '')) || 0;
          const bt = Date.parse(String(b && b.created_at ? b.created_at : '')) || 0;
          return bt - at;
        });
    }
    function renderAddToJobModal(){
      const data = state._addToJob;
      if(!data) return;
      const busy = !!state._addToJobBusy;
      const jobs = Array.isArray(data.jobs) ? data.jobs : [];
      const activeTab = data.activeTab || 'existing';

      // Item card
      const itemNameEl = $('atjItemName');
      const itemDescEl = $('atjItemDesc');
      const itemSkuEl = $('atjItemSku');
      const itemSkuWrap = $('atjItemSkuWrap');
      if(itemNameEl){
        const itemName = String(data.itemName || 'Loading...');
        itemNameEl.textContent = itemName;
        itemNameEl.title = itemName;
      }
      if(itemDescEl) itemDescEl.textContent = String(data.itemDesc || '');
      if(itemSkuEl) itemSkuEl.textContent = String(data.itemSku || '');
      if(itemSkuWrap) itemSkuWrap.style.display = data.itemSku ? 'block' : 'none';

      // Stats
      const onHand = toInt(data.onHand, 0);
      const reserved = toInt(data.reserved, 0);
      const statOnHand = $('atjStatOnHand');
      const statReserved = $('atjStatReserved');
      const qtyHelper = $('atjQtyHelper');
      if(statOnHand){
        statOnHand.textContent = onHand.toLocaleString();
        statOnHand.classList.remove('on-hand-good', 'on-hand-low', 'on-hand-out');
        statOnHand.classList.add(onHand <= 0 ? 'on-hand-out' : 'on-hand-good');
      }
      if(statReserved) statReserved.textContent = reserved.toLocaleString();
      if(qtyHelper) qtyHelper.textContent = `On Hand: ${onHand.toLocaleString()}`;

      // Tabs
      const tabExisting = $('atjTabExisting');
      const tabNew = $('atjTabNew');
      const panelExisting = $('atjPanelExisting');
      const panelNew = $('atjPanelNew');
      if(tabExisting) tabExisting.classList.toggle('active', activeTab === 'existing');
      if(tabNew) tabNew.classList.toggle('active', activeTab === 'new');
      if(panelExisting) panelExisting.classList.toggle('active', activeTab === 'existing');
      if(panelNew) panelNew.classList.toggle('active', activeTab === 'new');

      // Dropdown for existing job
      const dropdownMenu = $('atjDropdownMenu');
      const selectedText = $('atjSelectedText');
      const dropdownTrigger = $('atjDropdownTrigger');

      const jobIds = new Set(jobs.map(j => String(j && j.id ? j.id : '')).filter(Boolean));
      let selected = data.selectedJobId;
      if(selected && !jobIds.has(selected)) selected = '';
      if(!selected && jobs.length) selected = String(jobs[0].id || '');
      data.selectedJobId = selected;

      if(dropdownMenu){
        if(jobs.length){
          const items = jobs.map(job => {
            const id = String(job.id || '').trim();
            if(!id) return '';
            const name = String(job.name || '').trim() || '(Untitled job)';
            const status = jobStatusLabel(String(job.status || 'draft'));
            const isSelected = id === selected;
            return `<div class="atj-dropdown-item${isSelected ? ' selected' : ''}" data-job-id="${escapeHtmlAttr(id)}">
              <div class="atj-dropdown-item-name" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</div>
              <div class="atj-dropdown-item-status">${escapeHtml(status)}</div>
            </div>`;
          }).filter(Boolean);
          dropdownMenu.innerHTML = items.join('');
        }else{
          dropdownMenu.innerHTML = '<div class="atj-dropdown-empty">No jobs found</div>';
        }
      }

      // Update selected text
      if(selectedText){
        if(selected){
          const job = jobs.find(j => String(j.id || '') === selected);
          if(job){
            selectedText.textContent = String(job.name || '').trim() || '(Untitled job)';
            selectedText.title = selectedText.textContent;
            selectedText.classList.remove('placeholder');
          }else{
            selectedText.textContent = 'Choose a job...';
            selectedText.title = '';
            selectedText.classList.add('placeholder');
          }
        }else{
          selectedText.textContent = jobs.length ? 'Choose a job...' : 'No jobs found';
          selectedText.title = '';
          selectedText.classList.add('placeholder');
        }
      }

      if(dropdownTrigger) dropdownTrigger.disabled = busy || !jobs.length;

      // New job inputs
      const newNameInput = $('atjNewJobName');
      const newDescInput = $('atjNewJobDesc');
      if(newNameInput){
        if(!busy && newNameInput.value === '') newNameInput.value = String(data.newJobName || '');
        newNameInput.disabled = busy;
      }
      if(newDescInput){
        if(!busy && newDescInput.value === '') newDescInput.value = String(data.newJobDesc || '');
        newDescInput.disabled = busy;
      }

      // Quantity
      const qtyInput = $('atjQtyInput');
      const qtyMinus = $('atjQtyMinus');
      const qtyPlus = $('atjQtyPlus');
      if(qtyInput){
        const nextQty = Math.max(1, toInt(qtyInput.value || data.qty || 1, 1));
        qtyInput.value = String(nextQty);
        qtyInput.disabled = busy;
      }
      if(qtyMinus) qtyMinus.disabled = busy;
      if(qtyPlus) qtyPlus.disabled = busy;

      // Submit button
      const confirmBtn = $('btnAddToJobConfirm');
      if(confirmBtn){
        confirmBtn.disabled = busy;
        if(busy){
          confirmBtn.innerHTML = '<span class="spinner"></span> Adding...';
        }else{
          confirmBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Add to Job`;
        }
      }
    }
    async function openAddToJobModal(itemId){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_VIEW, 'Inventory access required')) return;
      const item = getInventoryById(itemId);
      if(!item){ toast('Item not found', 'error'); return; }

      // Get reserved quantity for this item
      const reservedMap = state._reservedByItemId || new Map();
      const reserved = toInt(reservedMap.get(String(item.id || '')), 0);

      state._addToJob = {
        itemId: String(item.id || '').trim(),
        itemName: String(item.name || '').trim(),
        itemDesc: String(item.description || '').trim(),
        itemSku: String(item.sku || '').trim(),
        onHand: toInt(item.on_hand, 0),
        reserved: reserved,
        jobs: [],
        selectedJobId: '',
        qty: 1,
        newJobName: '',
        newJobDesc: '',
        activeTab: 'existing'
      };
      state._addToJobBusy = false;
      setAddToJobMessage('');
      closeAtjDropdown();
      show('addToJobModal', true);
      renderAddToJobModal();
      try{
        await ensureInventoryLoaded();
        // Refresh reserved map for accurate availability
        const freshReserved = await sbFetchReservedMap();
        state._reservedByItemId = freshReserved;
        state._addToJob.reserved = toInt(freshReserved.get(String(item.id || '')), 0);

        const rows = await sbFetchJobs();
        state._jobs = rows;
        state._jobsById = new Map(rows.map(r => [String(r.id || ''), r]).filter(x => x[0]));
        state._addToJob.jobs = getAddToJobJobs();
        // Switch to "new" tab if no jobs found (keep user's selection if changed)
        const preferredTab = state._addToJob.activeTab || 'existing';
        if(!state._addToJob.jobs.length && preferredTab !== 'new'){
          state._addToJob.activeTab = 'new';
        }else{
          state._addToJob.activeTab = preferredTab;
        }
        renderAddToJobModal();
      }catch(e){
        setAddToJobMessage(e && e.message ? e.message : 'Failed to load jobs', true);
      }
    }
    async function confirmAddToJob(){
      const data = state._addToJob;
      if(!data) return;
      const activeTab = data.activeTab || 'existing';
      const isNewJob = activeTab === 'new';
      const qtyInput = $('atjQtyInput');
      const rawQty = qtyInput ? Number(qtyInput.value || 0) : 0;
      const qty = Number.isFinite(rawQty) ? rawQty : 0;
      if(qty <= 0){ setAddToJobMessage('Quantity must be greater than zero.', true); return; }

      if(isNewJob){
        // New job validation
        const newNameInput = $('atjNewJobName');
        const name = newNameInput ? String(newNameInput.value || '').trim() : '';
        if(!name){ setAddToJobMessage('Job name is required.', true); return; }
      }else{
        // Existing job validation
        if(!data.selectedJobId){ setAddToJobMessage('Select a job.', true); return; }
      }

      setAddToJobMessage('');
      state._addToJobBusy = true;
      renderAddToJobModal();
      try{
        let jobId = '';
        let jobName = '';

        if(isNewJob){
          const newNameInput = $('atjNewJobName');
          const newDescInput = $('atjNewJobDesc');
          const name = newNameInput ? String(newNameInput.value || '').trim() : '';
          const notes = newDescInput ? String(newDescInput.value || '').trim() : null;
          const { data: createdId, error } = await SB.client.rpc('create_job', {
            p_company_id: SB.companyId,
            p_name: name,
            p_notes: notes || null
          });
          if(error) throw error;
          jobId = createdId;
          jobName = name;
          await refreshJobs();
        }else{
          jobId = data.selectedJobId;
          const job = (data.jobs || []).find(j => String(j && j.id ? j.id : '') === String(jobId));
          jobName = job ? String(job.name || '').trim() : '';
        }

        const { error } = await SB.client.rpc('upsert_job_bom_line', {
          p_job_id: jobId,
          p_item_id: data.itemId,
          p_qty_planned: qty
        });
        if(error) throw error;
        if(state._jobEditor && state._jobEditor.job && String(state._jobEditor.job.id) === String(jobId)){
          state._jobEditor.bomLines = await sbFetchJobBom(jobId);
          renderJobEditor();
        }
        show('addToJobModal', false);
        toast(`Added to ${jobName || 'job'}`);
      }catch(e){
        setAddToJobMessage(e && e.message ? e.message : 'Failed to add item to job', true);
      }finally{
        state._addToJobBusy = false;
        renderAddToJobModal();
      }
    }

    // Add to Job modal dropdown helpers
    function isAtjDropdownOpen(){
      const menu = $('atjDropdownMenu');
      return menu && menu.classList.contains('open');
    }
    function closeAtjDropdown(){
      const menu = $('atjDropdownMenu');
      const trigger = $('atjDropdownTrigger');
      if(menu) menu.classList.remove('open');
      if(trigger) trigger.classList.remove('open');
    }
    function toggleAtjDropdown(){
      const menu = $('atjDropdownMenu');
      const trigger = $('atjDropdownTrigger');
      if(!menu || !trigger) return;
      const willOpen = !menu.classList.contains('open');
      if(willOpen){
        menu.classList.add('open');
        trigger.classList.add('open');
      }else{
        closeAtjDropdown();
      }
    }
    function selectAtjJob(jobId){
      if(!state._addToJob) return;
      state._addToJob.selectedJobId = String(jobId || '');
      closeAtjDropdown();
      renderAddToJobModal();
    }
    function switchAtjTab(tab){
      if(!state._addToJob) return;
      state._addToJob.activeTab = tab === 'new' ? 'new' : 'existing';
      setAddToJobMessage('');
      renderAddToJobModal();
    }
    function adjustAtjQty(delta){
      const input = $('atjQtyInput');
      if(!input) return;
      const current = Math.max(1, toInt(input.value, 1));
      const next = Math.max(1, current + delta);
      input.value = String(next);
      if(state._addToJob) state._addToJob.qty = next;
    }

    async function refreshJobEditorInventory(){
      const editor = state._jobEditor;
      if(!editor) return { inventoryMap: new Map(), reservedMap: new Map(), incomingMap: new Map(), jobAllocations: new Map(), jobShortfalls: new Map() };
      const isCompleted = editor.job && String(editor.job.status || '') === 'completed';
      const bomLines = Array.isArray(editor.bomLines) ? editor.bomLines : [];
      const pendingLines = Array.isArray(editor.pendingBomLines) ? editor.pendingBomLines : [];
      const itemIds = getJobBomItemIds(bomLines.concat(pendingLines));
      const reservedMap = await sbFetchReservedMap();
      const inventoryMap = await sbFetchInventoryByItemIds(itemIds);
      await ensureIncomingOrdersLoaded();
      const incomingMap = buildInventoryIncomingMap();
      let jobAllocations = new Map();
      let jobShortfalls = new Map();
      if(editor.job && editor.job.id){
        const allocationsByJob = await sbFetchAllocationsForJobs([editor.job.id]);
        jobAllocations = allocationsByJob.get(String(editor.job.id)) || new Map();
        const shortfallsByJob = await sbFetchShortfallsForJobs([editor.job.id]);
        jobShortfalls = shortfallsByJob.get(String(editor.job.id)) || new Map();
      }
      if(canOrdersView()){
        const shortfallIds = collectShortfallIdsFromMap(jobShortfalls);
        try{
          state._shortfallOrdersById = shortfallIds.length
            ? await sbFetchOrderShortfallLinks(shortfallIds)
            : new Map();
          state._shortfallOrdersLoaded = true;
        }catch(e){
          state._shortfallOrdersById = new Map();
          state._shortfallOrdersLoaded = false;
        }
      }else{
        state._shortfallOrdersById = new Map();
        state._shortfallOrdersLoaded = false;
      }
      let jobReadiness = editor.jobReadiness || null;
      let jobReadinessDetail = editor.jobReadinessDetail || null;
      if(editor.job && editor.job.id && !isCompleted){
        try{
          const readinessMap = await sbFetchJobReadiness([editor.job.id]);
          const readinessRow = readinessMap.get(String(editor.job.id)) || null;
          if(readinessRow){
            jobReadiness = readinessRow;
            if(!state._jobReadinessByJobId || typeof state._jobReadinessByJobId.set !== 'function'){
              state._jobReadinessByJobId = new Map();
            }
            state._jobReadinessByJobId.set(String(editor.job.id), readinessRow);
          }
        }catch(e){}
        try{
          jobReadinessDetail = await sbFetchJobReadinessDetails(editor.job.id);
        }catch(e){
          jobReadinessDetail = { ready_for_approval: false, blocking_items: [], error: e && e.message ? e.message : 'Readiness unavailable' };
        }
      }else{
        jobReadiness = null;
        jobReadinessDetail = null;
      }
      editor.reservedMap = reservedMap;
      editor.inventoryMap = inventoryMap;
      editor.incomingMap = incomingMap;
      editor.jobAllocations = jobAllocations;
      editor.jobShortfalls = jobShortfalls;
      editor.jobReadiness = jobReadiness;
      editor.jobReadinessDetail = jobReadinessDetail;
      state._incomingByItemId = incomingMap;
      if(editor.job){
        editor.job.ready_for_approval = jobReadinessDetail ? !!jobReadinessDetail.ready_for_approval : null;
        editor.job.blocking_items = jobReadinessDetail ? (jobReadinessDetail.blocking_items || []) : [];
        if(isCompleted){
          editor.job.ready_for_approval = null;
          editor.job.blocking_items = [];
        }
      }
      let wasFulfillable = true;
      const allLines = bomLines.concat(pendingLines);
      if(allLines.length && !isCompleted){
        for(const line of allLines){
          const itemId = String(line.item_id || '').trim();
          if(!itemId) continue;
          const qtyPlanned = Number(line.qty_planned || 0);
          const stats = computeJobLineStats(itemId, qtyPlanned, reservedMap, inventoryMap);
          if(stats.shortfall > 0){
            wasFulfillable = false;
            break;
          }
        }
      }
      editor.wasFulfillable = wasFulfillable;
      return { inventoryMap, reservedMap, incomingMap, jobAllocations, jobShortfalls };
    }
    async function openJobEditor(jobId, opts = {}){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!requirePermission(PERMISSIONS.ITEMS_VIEW, 'Inventory access required')) return;

      setJobEditorMessage('');
      setJobBomMessage('');
      setJobCompleteMessage('');
      renderApprovalShortages([]);
      const focusMode = opts && opts.focus ? String(opts.focus) : '';
      state._jobEditorTab = focusMode === 'complete' ? 'execution' : 'details';
      state._jobEditorExpandedItemId = '';
      state._jobEditorActualsDraft = new Map();
      state._jobApprovalShortages = [];
      show('jobEditorModal', true);
      state._jobEditorBusy = true;
      renderJobEditor();
      try{
        await ensureInventoryLoaded();
        if(!state._jobs || !state._jobs.length){
          const rows = await sbFetchJobs();
          state._jobs = rows;
          state._jobsById = new Map(rows.map(r => [String(r.id || ''), r]).filter(x => x[0]));
        }
        const reservedMap = await sbFetchReservedMap();
        await ensureIncomingOrdersLoaded();
        let job = null;
        let bomLines = [];
        let actuals = [];
        let inventoryMap = new Map();
        let incomingMap = buildInventoryIncomingMap();
        let jobAllocations = new Map();
        let jobShortfalls = new Map();
        let jobReadiness = null;
        let jobReadinessDetail = null;
        if(jobId){
          job = state._jobsById.get(String(jobId)) || null;
          if(!job){
            const rows = await sbFetchJobs();
            state._jobs = rows;
            state._jobsById = new Map(rows.map(r => [String(r.id || ''), r]).filter(x => x[0]));
            job = state._jobsById.get(String(jobId)) || null;
          }
          if(job){
            const jobIsCompleted = String(job.status || '') === 'completed';
            bomLines = await sbFetchJobBom(job.id);
            actuals = await sbFetchJobActuals(job.id);
            const allocationsByJob = await sbFetchAllocationsForJobs([job.id]);
            jobAllocations = allocationsByJob.get(String(job.id)) || new Map();
            const shortfallsByJob = await sbFetchShortfallsForJobs([job.id]);
            jobShortfalls = shortfallsByJob.get(String(job.id)) || new Map();
            if(canOrdersView()){
              const shortfallIds = collectShortfallIdsFromMap(jobShortfalls);
              try{
                state._shortfallOrdersById = shortfallIds.length
                  ? await sbFetchOrderShortfallLinks(shortfallIds)
                  : new Map();
                state._shortfallOrdersLoaded = true;
              }catch(e){
                state._shortfallOrdersById = new Map();
                state._shortfallOrdersLoaded = false;
              }
            }else{
              state._shortfallOrdersById = new Map();
              state._shortfallOrdersLoaded = false;
            }
            if(!jobIsCompleted){
              try{
                const readinessMap = await sbFetchJobReadiness([job.id]);
                const readinessRow = readinessMap.get(String(job.id)) || null;
                if(readinessRow){
                  jobReadiness = readinessRow;
                  if(!state._jobReadinessByJobId || typeof state._jobReadinessByJobId.set !== 'function'){
                    state._jobReadinessByJobId = new Map();
                  }
                  state._jobReadinessByJobId.set(String(job.id), readinessRow);
                }
              }catch(e){
                if(state._jobReadinessByJobId && typeof state._jobReadinessByJobId.get === 'function'){
                  jobReadiness = state._jobReadinessByJobId.get(String(job.id)) || jobReadiness;
                }
              }
              try{
                jobReadinessDetail = await sbFetchJobReadinessDetails(job.id);
              }catch(e){
                jobReadinessDetail = { ready_for_approval: false, blocking_items: [], error: e && e.message ? e.message : 'Readiness unavailable' };
              }
            }
          }
        }else{
          job = { id:null, name:'', status:'draft', notes:'' };
        }
        if(bomLines.length){
          try{
            const itemIds = getJobBomItemIds(bomLines);
            inventoryMap = await sbFetchInventoryByItemIds(itemIds);
          }catch(e){
            inventoryMap = new Map();
          }
        }
        // Calculate initial fulfillability at editor open time
        const isCompleted = job && String(job.status || '') === 'completed';
        let wasFulfillable = true;
        if(bomLines && bomLines.length && !isCompleted){
          for(const line of bomLines){
            const itemId = String(line.item_id || '').trim();
            if(!itemId) continue;
            const qtyPlanned = Number(line.qty_planned || 0);
            const stats = computeJobLineStats(itemId, qtyPlanned, reservedMap, inventoryMap);
            if(stats.shortfall > 0){
              wasFulfillable = false;
              break;
            }
          }
        }
        state._jobEditor = {
          job,
          bomLines,
          actuals,
          reservedMap,
          inventoryMap,
          incomingMap,
          jobAllocations,
          jobShortfalls,
          jobReadiness,
          jobReadinessDetail,
          wasFulfillable,
          lastSavedName: job ? String(job.name || '') : '',
          lastSavedNotes: job ? String(job.notes || '') : ''
        };
        if(job){
          job.ready_for_approval = jobReadinessDetail ? !!jobReadinessDetail.ready_for_approval : null;
          job.blocking_items = jobReadinessDetail ? (jobReadinessDetail.blocking_items || []) : [];
          if(isCompleted){
            job.ready_for_approval = null;
            job.blocking_items = [];
          }
        }
        state._incomingByItemId = incomingMap;
      }catch(e){
        state._jobEditor = {
          job: { id:null, name:'', status:'draft', notes:'' },
          bomLines:[],
          actuals:[],
          reservedMap:new Map(),
          inventoryMap:new Map(),
          incomingMap:new Map(),
          jobAllocations:new Map(),
          jobShortfalls:new Map(),
          jobReadiness: null,
          jobReadinessDetail: null,
          wasFulfillable: true,
          lastSavedName: '',
          lastSavedNotes: ''
        };
        setJobEditorMessage(e && e.message ? e.message : 'Failed to load job');
      }finally{
        state._jobEditorBusy = false;
        renderJobEditor();
        if(focusMode === 'complete'){
          setJobEditorTab('execution');
        }else if(focusMode === 'readiness'){
          setJobEditorTab('details');
          setTimeout(()=>{
            const section = document.querySelector('.job-readiness-section');
            if(section) section.scrollIntoView({ behavior:'smooth', block:'start' });
          }, 0);
        }
      }
    }
    async function saveJobDetails(){
      const editor = state._jobEditor;
      if(!editor || !editor.job) return;
      const job = editor.job;
      const nameInput = $('jobNameInput');
      const notesInput = $('jobNotesInput');
      const name = nameInput ? String(nameInput.value || '').trim() : '';
      const notes = notesInput ? String(notesInput.value || '').trim() : '';
      if(!name){ setJobEditorMessage('Job name is required.'); return; }
      setJobEditorMessage('');
      setJobAutosaveStatus('saving');
      try{
        try{
          await refreshJobEditorInventory();
        }catch(e){
          setJobEditorMessage('Inventory changed while editing this job.');
        }
        if(!job.id){
          const { data, error } = await SB.client.rpc('create_job', {
            p_company_id: SB.companyId,
            p_name: name,
            p_notes: notes || null
          });
          if(error) throw error;
          job.id = data;
          job.name = name;
          job.notes = notes;
          editor.lastSavedName = name;
          editor.lastSavedNotes = notes;
          job.status = 'draft';
          await refreshJobs();
          const refreshed = state._jobsById.get(String(job.id));
          if(refreshed) editor.job = refreshed;
          // Save any pending BOM items
          if(editor.pendingBomLines && editor.pendingBomLines.length){
            for(const line of editor.pendingBomLines){
              try{
                await SB.client.rpc('upsert_job_bom_line', {
                  p_job_id: job.id,
                  p_item_id: line.item_id,
                  p_qty_planned: line.qty_planned
                });
              }catch(bomError){
                console.warn('Failed to add BOM line:', bomError);
              }
            }
            editor.pendingBomLines = [];
            editor.bomLines = await sbFetchJobBom(job.id);
          }
          toast('Job created', 'success');
          setJobBomMessage('');
        }else{
          const { error } = await SB.client
            .from('jobs')
            .update({ name, notes: notes || null, updated_at: new Date().toISOString() })
            .eq('id', job.id)
            .eq('company_id', SB.companyId);
          if(error) throw error;
          job.name = name;
          job.notes = notes;
          editor.lastSavedName = name;
          editor.lastSavedNotes = notes;
          await refreshJobs();
          setJobAutosaveStatus('saved');
        }
      }catch(e){
        setJobEditorMessage(e && e.message ? e.message : 'Save failed');
        setJobAutosaveStatus('error', 'Save failed');
      }finally{
        renderJobEditor();
      }
    }

    // Job Autosave functionality
    let _jobAutosaveTimer = null;
    let _jobAutosaveClearTimer = null;
    const JOB_AUTOSAVE_DELAY = 1500; // 1.5 seconds after user stops typing

    function setJobAutosaveStatus(status, message){
      const el = $('jobAutosaveStatus');
      if(!el) return;
      el.className = 'job-autosave-status';
      if(status === 'saving'){
        el.classList.add('visible', 'saving');
        el.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></svg> Saving...`;
      }else if(status === 'saved'){
        el.classList.add('visible', 'saved');
        el.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Saved`;
        // Clear saved status after 3 seconds
        clearTimeout(_jobAutosaveClearTimer);
        _jobAutosaveClearTimer = setTimeout(()=>{
          el.classList.remove('visible', 'saved');
          el.innerHTML = '';
        }, 3000);
      }else if(status === 'error'){
        el.classList.add('visible', 'error');
        el.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg> ${message || 'Save failed'}`;
      }else{
        el.classList.remove('visible', 'saving', 'saved', 'error');
        el.innerHTML = '';
      }
    }

    async function autosaveJobDetails(){
      const editor = state._jobEditor;
      if(!editor || !editor.job) return;
      const job = editor.job;
      // Only autosave existing jobs (not new unsaved jobs)
      if(!job.id) return;
      const nameInput = $('jobNameInput');
      const notesInput = $('jobNotesInput');
      const name = nameInput ? String(nameInput.value || '').trim() : '';
      const notes = notesInput ? String(notesInput.value || '').trim() : '';
      const lastName = editor.lastSavedName != null ? String(editor.lastSavedName) : String(job.name || '');
      const lastNotes = editor.lastSavedNotes != null ? String(editor.lastSavedNotes) : String(job.notes || '');
      // Don't autosave if name is empty
      if(!name) return;
      // Don't autosave if nothing changed
      if(name === lastName && (notes || '') === (lastNotes || '')) return;

      setJobAutosaveStatus('saving');
      try{
        const { error } = await SB.client
          .from('jobs')
          .update({ name, notes: notes || null, updated_at: new Date().toISOString() })
          .eq('id', job.id)
          .eq('company_id', SB.companyId);
        if(error) throw error;
        job.name = name;
        job.notes = notes;
        editor.lastSavedName = name;
        editor.lastSavedNotes = notes;
        // Silently refresh jobs list in background
        refreshJobs().catch(()=>{});
        setJobAutosaveStatus('saved');
      }catch(e){
        console.error('Job autosave failed:', e);
        setJobAutosaveStatus('error', 'Save failed');
      }
    }

    function triggerJobAutosave(){
      clearTimeout(_jobAutosaveTimer);
      _jobAutosaveTimer = setTimeout(autosaveJobDetails, JOB_AUTOSAVE_DELAY);
    }

    // Job Item Picker for adding items to BOM
    let _jobItemPicker = null;
    function openJobItemPicker(){
      const editor = state._jobEditor;
      if(!editor){ toast('No job editor open'); return; }
      _jobItemPicker = { selectedItemId: null, qty: 1 };
      const search = $('jobItemPickerSearch');
      if(search) search.value = '';
      const qtyInput = $('jobItemPickerQty');
      if(qtyInput) qtyInput.value = '1';
      const qtySection = $('jobItemPickerQtySection');
      if(qtySection) qtySection.style.display = 'none';
      const addBtn = $('btnJobItemPickerAdd');
      if(addBtn) addBtn.disabled = true;
      renderJobItemPickerResults('');
      show('jobItemPickerModal', true);
      if(search) setTimeout(()=> search.focus(), 100);
    }
    function closeJobItemPicker(){
      show('jobItemPickerModal', false);
      _jobItemPicker = null;
    }
    function highlightMatch(text, query){
      if(!query) return escapeHtml(text);
      const escaped = escapeHtml(text);
      const q = query.toLowerCase();
      const idx = text.toLowerCase().indexOf(q);
      if(idx === -1) return escaped;
      // Find the position in the escaped string
      const before = escapeHtml(text.slice(0, idx));
      const match = escapeHtml(text.slice(idx, idx + query.length));
      const after = escapeHtml(text.slice(idx + query.length));
      return `${before}<mark>${match}</mark>${after}`;
    }
    function renderJobItemPickerResults(query){
      const wrap = $('jobItemPickerResults');
      if(!wrap) return;
      const items = Array.isArray(state.items) ? state.items : [];
      const q = String(query || '').trim().toLowerCase();

      // Search across name, SKU, and description
      const scored = items.map(it => {
        const name = String(it.name || '').toLowerCase();
        const sku = String(it.sku || '').toLowerCase();
        const desc = String(it.desc || it.description || '').toLowerCase();
        let score = 0;
        let matchedFields = { name: false, sku: false, desc: false };
        if(!q){
          score = 1; // Show all when no query
        }else{
          if(name.includes(q)){ score += 10; matchedFields.name = true; }
          if(sku.includes(q)){ score += 5; matchedFields.sku = true; }
          if(desc.includes(q)){ score += 3; matchedFields.desc = true; }
        }
        return { item: it, score, matchedFields };
      }).filter(x => x.score > 0);

      // Sort by score (best matches first), then by name
      scored.sort((a, b) => {
        if(b.score !== a.score) return b.score - a.score;
        const nameA = String(a.item.name || '').toLowerCase();
        const nameB = String(b.item.name || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });

      const limited = scored.slice(0, 50);
      if(!limited.length){
        wrap.innerHTML = `<div class="job-item-picker-empty">${q ? 'No matching items' : 'No inventory items'}</div>`;
        return;
      }
      const selectedId = _jobItemPicker ? _jobItemPicker.selectedItemId : null;
      let html = '';
      for(const { item: it, matchedFields } of limited){
        const id = String(it.id || '').trim();
        const name = String(it.name || '').trim() || '(Unnamed)';
        const sku = String(it.sku || '').trim();
        const desc = String(it.desc || it.description || '').trim();
        const qty = toInt(it.qty, 0);
        const isSelected = id === selectedId;

        // Highlight matches
        const nameHtml = q && matchedFields.name ? highlightMatch(name, query) : escapeHtml(name);
        const skuHtml = sku ? (q && matchedFields.sku ? highlightMatch(sku, query) : escapeHtml(sku)) : '';

        html += `<div class="job-item-picker-row${isSelected ? ' selected' : ''}" data-picker-item-id="${escapeHtmlAttr(id)}">`;
        html += `<div class="item-info">`;
        html += `<div class="item-name" title="${escapeHtmlAttr(name)}">${nameHtml}</div>`;
        if(skuHtml) html += `<div class="item-sku">SKU: ${skuHtml}</div>`;
        // Show description if it matched the search OR if no search query (always show for context)
        if(desc && (matchedFields.desc || !q)){
          const descHtml = q && matchedFields.desc ? highlightMatch(desc, query) : escapeHtml(desc);
          html += `<div class="item-desc">${descHtml}</div>`;
        }
        html += `</div>`;
        html += `<span class="item-qty">${qty} on hand</span>`;
        html += `</div>`;
      }
      if(scored.length > 50){
        html += `<div class="job-item-picker-empty" style="padding:10px;">Showing first 50 of ${scored.length} resultsâ€¦</div>`;
      }
      wrap.innerHTML = html;
    }
    function selectJobItemPickerItem(itemId){
      if(!_jobItemPicker) return;
      _jobItemPicker.selectedItemId = itemId;
      const item = getInventoryById(itemId);
      const name = item ? String(item.name || '').trim() : '';
      const selected = $('jobItemPickerSelected');
      if(selected) selected.textContent = name || 'Unknown item';
      const qtySection = $('jobItemPickerQtySection');
      if(qtySection) qtySection.style.display = 'block';
      const addBtn = $('btnJobItemPickerAdd');
      if(addBtn) addBtn.disabled = false;
      renderJobItemPickerResults($('jobItemPickerSearch')?.value || '');
    }
    async function confirmJobItemPicker(){
      if(!_jobItemPicker || !_jobItemPicker.selectedItemId) return;
      const editor = state._jobEditor;
      if(!editor) return;
      const job = editor.job;
      const itemId = _jobItemPicker.selectedItemId;
      const qtyInput = $('jobItemPickerQty');
      const qty = qtyInput ? Math.max(1, toInt(qtyInput.value, 1)) : 1;

      // If job doesn't have an ID yet, add to pending BOM lines
      if(!job || !job.id){
        if(!editor.pendingBomLines) editor.pendingBomLines = [];
        const existing = editor.pendingBomLines.find(l => l.item_id === itemId);
        if(existing){
          existing.qty_planned = qty;
        }else{
        editor.pendingBomLines.push({ item_id: itemId, qty_planned: qty });
      }
      // Merge pending into bomLines for display
      editor.bomLines = [...(editor.pendingBomLines || [])];
      closeJobItemPicker();
      renderJobEditor();
      setJobBomMessage('Items added. Save the job to persist.');
      return;
    }

      // Job exists, add via RPC
      const addBtn = $('btnJobItemPickerAdd');
      const prior = addBtn ? addBtn.textContent : '';
      if(addBtn){ addBtn.disabled = true; addBtn.textContent = 'Addingâ€¦'; }
      try{
      const { error } = await SB.client.rpc('upsert_job_bom_line', {
        p_job_id: job.id,
        p_item_id: itemId,
        p_qty_planned: qty
      });
      if(error) throw error;
      editor.bomLines = await sbFetchJobBom(job.id);
      closeJobItemPicker();
      renderJobEditor();
      toast('Item added to BOM', 'success');
      scheduleMenuActionBadgeRefresh({ force: true });
      }catch(e){
        toast(e && e.message ? e.message : 'Failed to add item');
      }finally{
        if(addBtn){ addBtn.disabled = false; addBtn.textContent = prior || 'Add to BOM'; }
      }
    }

    async function updateJobBomLine(itemId, qtyOverride){
      const editor = state._jobEditor;
      if(!editor || !editor.job || !editor.job.id) return;
      const input = document.querySelector(`[data-bom-qty-input="${CSS.escape(itemId)}"]`);
      const qtyValue = Number.isFinite(Number(qtyOverride)) ? Number(qtyOverride) : (input ? Number(input.value || 0) : 0);
      const qty = Number.isFinite(qtyValue) ? qtyValue : 0;
      if(!Number.isFinite(qty) || qty <= 0){ setJobBomMessage('Planned quantity must be greater than zero.'); return; }
      setJobBomMessage('');
      try{
        const { error } = await SB.client.rpc('upsert_job_bom_line', {
          p_job_id: editor.job.id,
          p_item_id: itemId,
          p_qty_planned: qty
        });
        if(error) throw error;
        editor.bomLines = await sbFetchJobBom(editor.job.id);
        renderJobEditor();
        toast('BOM updated', 'success');
        scheduleMenuActionBadgeRefresh({ force: true });
      }catch(e){
        setJobBomMessage(e && e.message ? e.message : 'Failed to update BOM');
      }
    }
    // Remove BOM line from jobs list (not job editor)
    async function removeJobBomLineFromList(jobId, itemId){
      if(!jobId || !itemId) return;
      if(!(await openConfirmModal('Remove from job?', 'Remove this material from the job?', { okText:'Remove', cancelText:'Cancel' }))) return;
      try{
        const { error } = await SB.client
          .from('job_bom')
          .delete()
          .eq('job_id', jobId)
          .eq('item_id', itemId);
        if(error) throw error;
        toast('Material removed from job');
        await refreshJobs();
        scheduleMenuActionBadgeRefresh({ force: true });
      }catch(e){
        toast(e && e.message ? e.message : 'Failed to remove material');
      }
    }
    async function removeJobBomLine(itemId){
      const editor = state._jobEditor;
      if(!editor || !editor.job || !editor.job.id) return;
      if(!(await openConfirmModal('Remove BOM line?', 'Remove this item from the planned BOM?', { okText:'Remove', cancelText:'Cancel' }))) return;
      setJobBomMessage('');
      try{
        const { error } = await SB.client
          .from('job_bom')
          .delete()
          .eq('job_id', editor.job.id)
          .eq('item_id', itemId);
        if(error) throw error;
        editor.bomLines = await sbFetchJobBom(editor.job.id);
        renderJobEditor();
        toast('BOM line removed');
        scheduleMenuActionBadgeRefresh({ force: true });
      }catch(e){
        setJobBomMessage(e && e.message ? e.message : 'Failed to remove BOM line');
      }
    }
    async function approveJob(jobId, opts = {}){
      const btn = opts.button || document.querySelector(`[data-job-approve-id="${CSS.escape(jobId)}"]`) || $('btnJobApprove');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Approvingâ€¦'; }
      renderApprovalShortages([]);
      let latestShortages = [];
      try{
        const liveLines = await sbFetchJobBom(jobId);
        const itemIds = getJobBomItemIds(liveLines);
        const liveReservedMap = await sbFetchReservedMap();
        const liveInventoryMap = await sbFetchInventoryByItemIds(itemIds);
        const shortages = [];
        liveLines.forEach(line=>{
          const itemId = String(line.item_id || '').trim();
          if(!itemId) return;
          const qtyPlanned = Number(line.qty_planned || 0);
          const stats = computeJobLineStats(itemId, qtyPlanned, liveReservedMap, liveInventoryMap);
          if(stats.shortfall > 0){
            shortages.push({
              item_id: itemId,
              qty_planned: qtyPlanned,
              required: qtyPlanned,
              available: stats.available,
              shortfall: stats.shortfall
            });
          }
        });
        latestShortages = shortages;
        // Update editor state with live data
        const isEditorJob = state._jobEditor && state._jobEditor.job && String(state._jobEditor.job.id) === String(jobId);
        if(isEditorJob){
          state._jobEditor.reservedMap = liveReservedMap;
          state._jobEditor.inventoryMap = liveInventoryMap;
          renderJobEditor();
        }

        const wasFulfillable = isEditorJob
          ? !!state._jobEditor.wasFulfillable
          : (shortages.length === 0);
        const { data, error } = await SB.client.rpc('approve_job', {
          p_job_id: jobId,
          p_was_fulfillable: wasFulfillable
        });
        if(error) throw error;
        if(data && data.blocked){
          const shortfallList = Array.isArray(data.shortfalls) ? data.shortfalls : latestShortages;
          renderApprovalShortages(shortfallList);
          const reason = String(data.reason || '');
          const blockedMsg = reason === 'inventory_changed'
            ? 'Inventory changed while this job was being reviewed, and it can no longer be fulfilled.'
            : 'Approval blocked due to shortfalls. Resolve missing quantities and try again.';
          if(isEditorJob){
            setJobEditorMessage(blockedMsg);
            const jobShortfalls = new Map();
            shortfallList.forEach(row=>{
              const itemId = String(row.item_id || '').trim();
              const qty = Number(row.shortfall || 0);
              if(itemId && Number.isFinite(qty) && qty > 0) jobShortfalls.set(itemId, qty);
            });
            state._jobEditor.jobShortfalls = jobShortfalls;
            renderJobEditor();
          }else{
            setJobsMessage(blockedMsg);
          }
          await refreshJobs();
          return data;
        }
        await refreshJobs();
        if(state._jobEditor && state._jobEditor.job && String(state._jobEditor.job.id) === String(jobId)){
          await openJobEditor(jobId);
        }
        toast('Job approved');
        return data;
      }catch(e){
        const msg = e && e.message ? e.message : 'Approval failed';
        if(msg.includes('Inventory changed during job approval')){
          renderApprovalShortages(latestShortages);
          const warningMsg = 'Inventory was reduced or allocated by another operation while you were editing this job, and it can no longer be fulfilled.';
          const isEditorJob = state._jobEditor && state._jobEditor.job && String(state._jobEditor.job.id) === String(jobId);
          if(isEditorJob){
            setJobEditorMessage(warningMsg);
          }else{
            setJobsMessage(warningMsg);
          }
          if(typeof DEV_MODE !== 'undefined' && DEV_MODE){
            console.warn('[DEV] Approval blocked - fulfillability regression:', latestShortages.map(s => ({
              item_id: s.item_id,
              previous_shortage: 0,
              current_shortage: s.shortfall
            })));
          }
        }
        const details = parseShortageDetails(msg);
        if(details){
          renderApprovalShortages(details);
          const summary = details.map(row=>{
            const itemId = String(row.item_id || '').trim();
            const item = getInventoryById(itemId);
            const name = item ? String(item.name || '') : itemId;
            const shortfall = Number(row.shortfall || 0);
            return `${name} short ${shortfall}`;
          }).join('; ');
          setJobsMessage(summary);
        }
        toast(msg);
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Approve'; }
      }
    }
    async function completeJob(jobId){
      const btn = $('btnJobComplete');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Completingâ€¦'; }
      setJobCompleteMessage('');
      try{
        const actuals = collectJobActuals();
        const { error } = await SB.client.rpc('complete_job', {
          p_job_id: jobId,
          p_actuals: actuals
        });
        if(error) throw error;
        await refreshJobs();
        try{ await sbLoadSnapshot(); }catch(e){}
        await openJobEditor(jobId);
        toast('Job completed');
      }catch(e){
        setJobCompleteMessage(e && e.message ? e.message : 'Completion failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Complete Job'; }
      }
    }
    async function reopenJob(jobId){
      const editor = state._jobEditor;
      const job = editor && editor.job ? editor.job : null;
      if(!job || String(job.status || '') !== 'completed') return;
      if(!canItemsDelete()) return;
      const jobNumberLabel = formatJobNumberLabel(job);
      const reopenTitle = (jobNumberLabel && jobNumberLabel !== 'Job')
        ? `Reopen completed ${jobNumberLabel}?`
        : 'Reopen completed job?';
      const reopenIntro = (jobNumberLabel && jobNumberLabel !== 'Job')
        ? `${jobNumberLabel} has already been marked as completed.`
        : 'This job has already been marked as completed.';
      const ok = await openConfirmModal(
        reopenTitle,
        `${reopenIntro}\nReopening it will return the job to the Execution phase.\nPreviously recorded execution data will be preserved.\n\nInventory changes are not automatically reversed.`,
        { okText:'Reopen job', cancelText:'Cancel', okClass:'btn-danger' }
      );
      if(!ok) return;
      const btn = $('btnJobReopen');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Reopeningâ€¦'; }
      try{
        const { error } = await SB.client
          .from('jobs')
          .update({ status:'in_progress', updated_at: new Date().toISOString() })
          .eq('id', jobId)
          .eq('company_id', SB.companyId);
        if(error) throw error;
        if(!state._jobReopenedById || typeof state._jobReopenedById.add !== 'function'){
          state._jobReopenedById = new Set();
        }
        state._jobReopenedById.add(String(jobId));
        await refreshJobs();
        await openJobEditor(jobId, { focus:'complete' });
        toast('Job reopened');
      }catch(e){
        toast(e && e.message ? e.message : 'Reopen failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Reopen job'; }
      }
    }
    async function voidJob(jobId){
      if(!(await openConfirmModal('Void job?', 'This will release reservations and reverse consumption if needed.', { okText:'Void Job', cancelText:'Cancel' }))) return;
      const btn = document.querySelector(`[data-job-void-id="${CSS.escape(jobId)}"]`) || $('btnJobVoid');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Voidingâ€¦'; }
      try{
        const { error } = await SB.client.rpc('void_job', { p_job_id: jobId });
        if(error) throw error;
        await refreshJobs();
        try{ await sbLoadSnapshot(); }catch(e){}
        if(state._jobEditor && state._jobEditor.job && String(state._jobEditor.job.id) === String(jobId)){
          await openJobEditor(jobId);
        }
        toast('Job voided');
      }catch(e){
        toast(e && e.message ? e.message : 'Void failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Void'; }
      }
    }
    function setTrashMessage(msg){
      const el = $('trashMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function trashSearchText(row){
      const r = row || {};
      const name = String(r.name || '').toLowerCase();
      const desc = String(r.description || '').toLowerCase();
      const qty = String(toInt(r.quantity, 0));
      const deletedBy = String(r.deleted_by_email || '').toLowerCase();
      const deletedAt = String(r.deleted_at || '').toLowerCase();
      return `${name} ${desc} ${qty} ${deletedBy} ${deletedAt}`.trim();
    }
    function renderTrashList(){
      const list = $('trashList');
      if(!list) return;
      const rows = Array.isArray(state._trashItems) ? state._trashItems : [];
      const filter = String(state._trashFilter || '').trim().toLowerCase();
      const filtered = filter ? rows.filter(r => trashSearchText(r).includes(filter)) : rows;
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">Trash is empty.</div>`;
        return;
      }
      if(!filtered.length){
        list.innerHTML = `<div class="trash-empty">No matches.</div>`;
        return;
      }
      list.innerHTML = filtered.map(row => {
        const id = String(row.id || '').trim();
        const name = String(row.name || '').trim() || '(Unnamed item)';
        const desc = String(row.description || '').trim();
        const qty = toInt(row.quantity, 0);
        const deletedAt = row.deleted_at ? formatEasternDateTime(row.deleted_at) : '';
        const deletedBy = String(row.deleted_by_email || '').trim();
        const metaParts = [];
        if(deletedAt) metaParts.push(`Deleted ${escapeHtml(deletedAt)}`);
        if(deletedBy) metaParts.push(`By ${escapeHtml(deletedBy)}`);
        metaParts.push(`Qty ${qty}`);
        const meta = metaParts.join(' â€¢ ');
        return (
          `<div class="trash-item">`+
            `<div>`+
              `<div class="trash-title">${escapeHtml(name)}</div>`+
              (desc ? `<div class="muted">${escapeHtml(desc)}</div>` : '')+
              `<div class="trash-meta">${meta}</div>`+
            `</div>`+
            `<div>`+
              `<button class="btn-secondary" data-restore-id="${escapeHtmlAttr(id)}">Restore</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    async function refreshTrash(){
      const list = $('trashList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setTrashMessage('');
      try{
        if(!SB.ready) throw new Error('Supabase not configured');
        if(!SB.session) throw new Error('Sign in required');
        if(!SB.companyId) throw new Error('No company selected');
        if(!canAccessTrash()) throw new Error('Trash access requires delete or restore permission');
        const { data, error } = await SB.client.rpc('get_deleted_items', { p_company_id: SB.companyId });
        if(error) throw error;
        state._trashItems = Array.isArray(data) ? data : [];
        renderTrashList();
      }catch(e){
        state._trashItems = [];
        const msg = e && e.message ? e.message : 'Failed to load trash';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openTrashModal(){
      if(!SB.ready){ toast('Supabase not configured', 'error'); return; }
      if(!SB.session){ toast('Sign in required', 'warning'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!canAccessTrash()){ toast('Trash access requires delete or restore permission'); return; }
      show('trashModal', true);
      const f = $('trashFilter'); if(f) f.value = state._trashFilter || '';
      await refreshTrash();
    }
    function closeTrashModal(){
      show('trashModal', false);
    }
    function renderOrderResults(){
      const ord = orderState();
      const list = $('orderResultsBody');
      if(!list) return;
      const qRaw = String(ord.search||'').trim();
      const q = toKey(qRaw);

      const items = (state.items||[]).slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      list.innerHTML = '';
      if(!items.length){
        list.innerHTML = '<div class="order-cart-empty">No inventory loaded yet.</div>';
        return;
      }
      if(!qRaw){
        return;
      }

      const hits = items.filter(it=>{
        if(!it) return false;
        const name = toKey(it.name);
        const desc = toKey(it.desc);
        return name.includes(q) || desc.includes(q) || String(toInt(it.qty,0)).includes(qRaw);
      }).slice(0, 12);

      if(!hits.length){
        list.innerHTML = '<div class="order-cart-empty">No matches.</div>';
        return;
      }

      const reservedMap = state._jobReservedMap || new Map();

      for(const it of hits){
        const el = document.createElement('div');
        el.className = 'order-cart-result';
        el.dataset.itemId = it.id;
        const orderQty = getOrderQtyForItem(it.id);

        // Calculate inventory stats
        const onHand = toInt(it.qty, 0);
        const reserved = reservedMap.has(it.id) ? Number(reservedMap.get(it.id)) : 0;
        const reorderPoint = getInventoryReorderPoint(it);
        const rec = getOrderRecommendationForItem(it.id);
        const recommended = rec.recommended || 0;

        // Determine on-hand status class
        let onHandClass = '';
        if(onHand <= 0) onHandClass = 'out';
        else if(reorderPoint !== null && onHand <= reorderPoint) onHandClass = 'low';
        else onHandClass = 'good';

        el.innerHTML =
          `<div class="order-cart-result-info">`+
            `<div class="order-cart-result-name" title="${escapeHtml(it.name||'')}">${escapeHtml(it.name||'')}</div>`+
            `<div class="order-cart-result-stats">`+
              `<span class="order-cart-result-stat">`+
                `<span class="order-cart-result-stat-label">On Hand</span>`+
                `<span class="order-cart-result-stat-value ${onHandClass}">${onHand}</span>`+
              `</span>`+
              `<span class="order-cart-result-stat">`+
                `<span class="order-cart-result-stat-label">Rsv</span>`+
                `<span class="order-cart-result-stat-value">${reserved}</span>`+
              `</span>`+
              (reorderPoint !== null ?
                `<span class="order-cart-result-stat">`+
                  `<span class="order-cart-result-stat-label">ROP</span>`+
                  `<span class="order-cart-result-stat-value">${reorderPoint}</span>`+
                `</span>` : '')+
              (recommended > 0 ?
                `<span class="order-cart-result-stat">`+
                  `<span class="order-cart-result-stat-label">Rec</span>`+
                  `<span class="order-cart-result-stat-value accent">${recommended}</span>`+
                `</span>` : '')+
            `</div>`+
          `</div>`+
          `<div class="qty-stepper" style="height:40px;">`+
            `<button class="qty-stepper-btn" style="width:40px;height:40px;" data-stepper-dec="${it.id}"${orderQty === 0 ? ' disabled style="opacity:0.3;width:40px;height:40px;"' : ''}>âˆ’</button>`+
            `<span class="qty-stepper-val" style="min-width:2.5rem;font-size:18px;">${orderQty}</span>`+
            `<button class="qty-stepper-btn" style="width:40px;height:40px;" data-stepper-inc="${it.id}">+</button>`+
          `</div>`;
        list.appendChild(el);
      }
    }
    function updateOrderBlockerBanner(){
      const banner = $('orderBlockerBanner');
      if(!banner) return;
      const text = $('orderBlockerBannerText');
      const meta = $('orderBlockerBannerMeta');
      const meta2 = $('orderBlockerBannerMeta2');
      const ord = orderState();
      const show = ord && ord.source === 'job_blockers' && !ord.blockerBannerDismissed;
      banner.style.display = show ? 'flex' : 'none';
      if(!show) return;
      if(text){
        text.textContent = 'This draft order was created from job blockers. Quantities account for on-hand and incoming inventory.';
      }
      if(meta){
        const msg = ord.blockerMultiSupplier
          ? 'Items were split into multiple draft orders based on supplier.'
          : '';
        meta.textContent = msg;
        meta.style.display = msg ? 'block' : 'none';
      }
      if(meta2){
        const msg = ord.blockerHasUnknownSupplier
          ? 'Some items do not have a supplier assigned yet.'
          : '';
        meta2.textContent = msg;
        meta2.style.display = msg ? 'block' : 'none';
      }
    }
    function renderOrderLines(){
      const ord = orderState();
      const list = $('orderLinesBody');
      const info = $('orderLinesInfo');
      if(!list) return;
      list.innerHTML = '';

      const lines = ord.lines.slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      pruneOrderLineSelection(lines);
      const lineItemIds = lines.map(l => String(l && l.id ? l.id : '').trim()).filter(Boolean);
      const commitmentKey = getOrderCommitmentKey(lineItemIds);
      if(lineItemIds.length){
        if(!state._orderCommitmentLoading && state._orderCommitmentKey !== commitmentKey){
          void loadOrderCommitmentsForCart(lineItemIds).then((updated)=>{
            if(updated) renderOrderLines();
          });
        }
      }else if(state._orderCommitmentKey){
        state._orderCommittedByItemId = new Map();
        state._orderJobCountByItemId = new Map();
        state._orderDraftJobCountByItemId = new Map();
        state._orderDraftJobAllocationsByItemId = new Map();
        state._orderIncomingByItemId = {};
        state._orderCommitmentKey = '';
      }

      if(!lines.length){
        list.innerHTML = `<div class="order-cart-empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="9" cy="21" r="1"></circle>
            <circle cx="20" cy="21" r="1"></circle>
            <path d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
          </svg>
          <div>Cart is empty</div>
          <div style="font-size:12px;margin-top:4px;">Search above to add items</div>
        </div>`;
        updateOrderImpactCard([]);
        updateOrderBlockerBanner();
        renderOrderPreview();
        // Update wizard cart summary and button states
        try{ updateOrderWizardCartSummary(); orderWizardUpdateUI(); }catch(e){}
        return;
      }

      for(const l of lines){
        const inv = getInventoryById(l.id);
        const onHand = inv ? toInt(inv.qty, 0) : null;
        const onHandValue = Number.isFinite(onHand) ? onHand : 0;
        const commitment = applyOrderCommitmentStats(l, onHandValue);
        const committed = Number(commitment.committed || 0);
        const jobCount = Number(commitment.jobCount || 0);
        const available = Number(commitment.available || 0);
        const incoming = Number(commitment.incoming || 0);
        const draftCountMap = state._orderDraftJobCountByItemId || new Map();
        const draftCount = Number(draftCountMap.get(l.id) || 0);
        const draftAllocMap = state._orderDraftJobAllocationsByItemId;
        const draftAllocEntry = (draftAllocMap && typeof draftAllocMap.get === 'function') ? draftAllocMap.get(l.id) : null;
        let draftRequiredQty = 0;
        let draftRequiredKnown = false;
        if(draftAllocEntry && draftAllocEntry.loaded && Array.isArray(draftAllocEntry.rows)){
          draftRequiredKnown = true;
          draftRequiredQty = draftAllocEntry.rows.reduce((sum, row)=>{
            const qty = toInt(row && row.qty_required != null ? row.qty_required : 0, 0);
            return sum + qty;
          }, 0);
        }
        let availabilityClass = 'is-positive';
        if(available < 0) availabilityClass = 'is-negative';
        else if(available === 0) availabilityClass = 'is-zero';
        const showCommitment = committed > 0 || draftCount > 0 || incoming > 0;
        const expanded = isOrderLineExpanded(l.id);
        const jobState = expanded ? getOrderJobAllocationsState(l.id) : null;
        if(expanded && jobState && !jobState.loaded && !jobState.loading){
          void loadOrderJobAllocationsForItem(l.id).then(()=> renderOrderLines());
        }
        const draftState = (expanded && draftCount > 0) ? getOrderDraftJobAllocationsState(l.id) : null;
        if(expanded && draftCount > 0 && draftState && !draftState.loaded && !draftState.loading){
          void loadOrderDraftJobAllocationsForItem(l.id).then(()=> renderOrderLines());
        }
        let jobsContent = '';
        if(expanded){
          let committedCards = '';
          if(jobState && jobState.loading){
            committedCards = renderOrderMiniCardPlaceholder('Loading committed jobs...');
          }else if(jobState && jobState.error){
            committedCards = renderOrderMiniCardPlaceholder(jobState.error || 'Unable to load committed jobs');
          }else if(jobState && Array.isArray(jobState.rows) && jobState.rows.length){
            committedCards = jobState.rows.map(row => {
              const jobId = String(row && row.job_id ? row.job_id : '').trim();
              const jobLabel = getOrderJobLabel(jobId);
              const qty = Number(row && row.qty_required != null ? row.qty_required : 0);
              return renderOrderMiniCard({
                title: jobLabel,
                qty,
                badgeLabel: 'Committed',
                badgeClass: 'mini-card-badge--committed',
                cardClass: 'mini-card--committed'
              });
            }).join('');
          }else{
            committedCards = renderOrderMiniCardPlaceholder('None');
          }
          const committedSection = (
            `<div class="order-cart-item-jobs-section order-cart-item-jobs-section--committed">`+
              `<div class="order-cart-item-jobs-section-title">Committed jobs</div>`+
              `<div class="order-cart-item-jobs-cards">${committedCards}</div>`+
            `</div>`
          );
          let draftSection = '';
          if(draftCount > 0){
            let draftCards = '';
            if(draftState && draftState.loading){
              draftCards = renderOrderMiniCardPlaceholder('Loading draft jobs...');
            }else if(draftState && draftState.error){
              draftCards = renderOrderMiniCardPlaceholder(draftState.error || 'Unable to load draft jobs');
            }else if(draftState && Array.isArray(draftState.rows) && draftState.rows.length){
              draftCards = draftState.rows.map(row => {
                const jobId = String(row && row.job_id ? row.job_id : '').trim();
                const jobLabel = getOrderJobLabel(jobId);
                const qty = Number(row && row.qty_required != null ? row.qty_required : 0);
                return renderOrderMiniCard({
                  title: jobLabel,
                  qty,
                  badgeLabel: 'Draft - blocked',
                  badgeClass: 'mini-card-badge--draft',
                  cardClass: 'mini-card--draft',
                  subtext: 'Awaiting inventory'
                });
              }).join('');
            }else{
              draftCards = renderOrderMiniCardPlaceholder('None');
            }
            draftSection = (
              `<div class="order-cart-item-jobs-section order-cart-item-jobs-section--draft">`+
                `<div class="order-cart-item-jobs-section-title">Draft jobs awaiting inventory</div>`+
                `<div class="order-cart-item-jobs-helper">Draft jobs are not included in committed quantities until approved.</div>`+
                `<div class="order-cart-item-jobs-cards">${draftCards}</div>`+
              `</div>`
            );
          }
          let draftSummaryCard = '';
          if(draftCount > 0 && draftState && Array.isArray(draftState.rows)){
            const draftRequiredQty = draftState.rows.reduce((sum, row)=>{
              const qty = toInt(row && row.qty_required != null ? row.qty_required : 0, 0);
              return sum + qty;
            }, 0);
            if(draftRequiredQty > 0){
              const cartQty = toInt(l.qty, 0);
              const draftRemaining = Math.max(0, draftRequiredQty - cartQty);
              draftSummaryCard = renderOrderDraftDemandSummaryCard({
                requiredQty: draftRequiredQty,
                remainingQty: draftRemaining
              });
            }
          }
          const incomingPill = incoming > 0
            ? `<div class="order-cart-item-incoming">Incoming: ${escapeHtml(formatQty(incoming))} (ordered/shipped)</div>`
            : '';
          jobsContent = incomingPill + committedSection + draftSection + draftSummaryCard;
        }

        const hasWarning = draftCount > 0;
        const card = document.createElement('div');
        card.className = `order-cart-item${expanded ? ' order-cart-item--expanded' : ''}${hasWarning ? ' order-cart-item--warning' : ''}`;
        card.dataset.orderLineId = l.id;
        const draftMetaLabel = draftCount > 0
          ? `${draftCount} ${draftCount === 1 ? 'job' : 'jobs'} waiting for this item`
          : '';
        const draftQtyMeta = (draftCount > 0 && draftRequiredKnown && draftRequiredQty > 0)
          ? `${formatQty(draftRequiredQty)} units needed`
          : '';
        const metaLine = showCommitment
          ? `<div class="order-cart-item-meta">`+
              `<span class="order-cart-item-availability ${availabilityClass}">Available: ${formatQty(available)}</span>`+
              (incoming > 0
                ? `<span class="order-cart-item-jobs-meta order-cart-item-jobs-meta--incoming">â€¢ Incoming: ${formatQty(incoming)}</span>`
                : '')+
              (committed > 0
                ? `<span class="order-cart-item-jobs-meta">â€¢ Used by ${jobCount} ${jobCount === 1 ? 'job' : 'jobs'}</span>`
                : '')+
              (draftCount > 0
                ? `<span class="order-cart-item-jobs-meta order-cart-item-jobs-meta--draft">â€¢ ${draftMetaLabel}</span>`
                : '')+
              (draftQtyMeta
                ? `<span class="order-cart-item-jobs-meta order-cart-item-jobs-meta--draft">â€¢ ${draftQtyMeta}</span>`
                : '')+
            `</div>`
          : '';
        card.innerHTML =
          `<div class="order-cart-item-main">`+
            `<button class="order-cart-item-toggle" type="button" data-order-line-toggle="${escapeHtmlAttr(l.id)}" aria-label="Toggle item details">${ICONS.chevronDown}</button>`+
            `<div class="order-cart-item-info" data-order-line-toggle="${escapeHtmlAttr(l.id)}">`+
              `<div class="order-cart-item-name" title="${escapeHtml(l.name||'')}">${escapeHtml(l.name||'')}</div>`+
              `${metaLine}`+
            `</div>`+
            `<div class="order-cart-item-stepper">`+
              `<div class="qty-stepper" data-qty-picker-trigger="${l.id}">`+
                `<button class="qty-stepper-btn" data-line-dec="${l.id}">âˆ’</button>`+
                `<input type="text" inputmode="numeric" pattern="[0-9]*" class="qty-stepper-input" data-line-qty-input="${l.id}" value="${toInt(l.qty,0)}" aria-label="Order quantity">`+
                `<button class="qty-stepper-btn" data-line-inc="${l.id}">+</button>`+
              `</div>`+
            `</div>`+
            `<button class="order-cart-item-remove" data-remove-order-id="${l.id}" title="Remove">`+
              `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>`+
            `</button>`+
          `</div>`+
          `<div class="order-cart-item-jobs">`+
            `${expanded ? jobsContent : ''}`+
          `</div>`;
        list.appendChild(card);
      }

      renderOrderPreview();
      updateOrderImpactCard(lines);
      updateOrderBlockerBanner();
      // Update wizard cart summary and button states
      try{ updateOrderWizardCartSummary(); orderWizardUpdateUI(); }catch(e){}
    }
    function renderOrderPreview(){
      const ord = orderState();
      const wrap = $('orderPreviewHtml');
      const subjectLine = composeOrderSubject(ord);
      ord.subject = subjectLine;
      const subjectInput = $('orderSubject'); if(subjectInput) subjectInput.value = subjectLine;
      const internalInput = $('orderInternalPoNumber'); if(internalInput) internalInput.value = String(ord.internalPoNumber || '').trim();
      if(wrap){
        const html = buildOrderHtml();
        wrap.innerHTML = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" sandbox="allow-same-origin"></iframe>`;
        const frame = wrap.querySelector('iframe');
        if(frame){
          const resize = ()=>{
            try{
              const doc = frame.contentDocument;
              if(doc && doc.body){
                frame.style.height = `${doc.body.scrollHeight}px`;
              }
            }catch(e){}
          };
          frame.addEventListener('load', resize);
          setTimeout(resize, 0);
        }
      }
      const shippingPreview = $('orderShippingPreview');
      if(shippingPreview){
        const shippingLines = formatShippingSnapshotLines(getOrderShippingSnapshot(ord));
        shippingPreview.innerHTML = shippingLines.length
          ? shippingLines.map(l => escapeHtml(l)).join('<br>')
          : '<span class="muted">No shipping location selected.</span>';
      }
      const replyEl = $('orderReplyToNote');
      if(replyEl){
        const e = getSignedInEmail();
        replyEl.textContent = e ? `Reply-To: ${e}` : 'Reply-To: (sign in to set)';
      }
      const histBtn = $('btnOrderHistory');
      if(histBtn){
        histBtn.disabled = !(SB.ready && SB.session && SB.authorized && canOrdersView());
      }
      const btn = $('btnOrderSubmit');
      if(btn){
        const okEmail = !!String(ord.email||'').trim();
        const okLines = ord.lines.some(l => toInt(l.qty, 0) > 0);
        const okCompany = !!getOrderCompanyName();
        btn.disabled = !(okEmail && okLines && okCompany);
      }
    }
    async function openOrderModal(opts = {}){
		      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		      const ord = orderState();
		      const addSelected = !isMobileUx() && !(opts && Object.prototype.hasOwnProperty.call(opts, 'addSelected') && opts.addSelected === false);
		      if(addSelected){
		        const selectedIds = Array.from(document.querySelectorAll('.rowChk:checked'))
		          .map(cb => cb.dataset.id)
		          .filter(Boolean);

	        let added = 0;
	        for(const id of selectedIds){
	          const it = getInventoryById(id);
	          if(it && upsertOrderLineFromItem(it, 1)) added++;
	        }
	        if(added) toast(`Added ${added} selected item(s)`);
	      }

	      ensureOrderIdentifiers(ord);
        ensureOrderDraftQueue();
        updateOrderDraftSelector();
	      ord.subject = composeOrderSubject(ord);

      const s = $('orderSearch'); if(s) s.value = ord.search || '';
      const e = $('orderEmail'); if(e) e.value = ord.email || '';
      const companyPo = $('orderCompanyPoNumber'); if(companyPo) companyPo.value = ord.companyPoNumber || '';
      const internalPo = $('orderInternalPoNumber'); if(internalPo) internalPo.value = ord.internalPoNumber || '';
      const sub = $('orderSubject'); if(sub) sub.value = ord.subject || '';
      const n = $('orderNotes'); if(n) n.value = ord.notes || '';

      try{ await ensureOrderRecommendationData(); }catch(e){}
      renderOrderResults();
      renderOrderLines();
      try{ await loadOrderShippingOptions(); }catch(e){}
      renderOrderPreview();
      try{ updateOrderSearchClearBtn(); }catch(e){}

      // Reset wizard to first step and update UI
      resetOrderWizard();

      show('orderModal', true);
    }

	    const menuOrder = $('menuOrder');
	    const menuQuickOrder = $('menuQuickOrder');
	    const openOrderFromMenu = () => {
	      toggleMenu(false);
	      if(!requirePermission(PERMISSIONS.ORDERS_CREATE, 'Order creation not allowed')) return;
	      openOrderModal();
	    };
	    if(menuOrder) menuOrder.addEventListener('click', openOrderFromMenu);
	    if(menuQuickOrder) menuQuickOrder.addEventListener('click', openOrderFromMenu);
    const menuJobs = $('menuJobs');
    if(menuJobs) menuJobs.addEventListener('click', ()=>{
      toggleMenu(false);
      openJobsModal();
    });
    const menuReceive = $('menuReceive');
    if(menuReceive) menuReceive.addEventListener('click', ()=>{ toggleMenu(false); openReceiveManualModal(); });
    const menuHistory = $('menuHistory');
    if(menuHistory) menuHistory.addEventListener('click', ()=>{ toggleMenu(false); openOrderHistoryModal({ returnToOrder: false }); });
    const menuTrash = $('menuTrash');
    if(menuTrash) menuTrash.addEventListener('click', ()=>{ toggleMenu(false); openTrashModal(); });
    const menuAudit = $('menuAudit');
    if(menuAudit) menuAudit.addEventListener('click', ()=>{ toggleMenu(false); openAuditModal(); });
    const menuSnapshots = $('menuSnapshots');
    if(menuSnapshots) menuSnapshots.addEventListener('click', ()=>{ toggleMenu(false); openSnapshotsModal(); });
    const menuMetrics = $('menuMetrics');
    if(menuMetrics) menuMetrics.addEventListener('click', ()=>{ toggleMenu(false); openMetricsModal(); });
    const btnTrashClose = $('btnTrashClose');
    if(btnTrashClose) btnTrashClose.addEventListener('click', closeTrashModal);
    const btnJobsClose = $('btnJobsClose');
    if(btnJobsClose) btnJobsClose.addEventListener('click', closeJobsModal);
    const btnJobsRefresh = $('btnJobsRefresh');
    if(btnJobsRefresh) btnJobsRefresh.addEventListener('click', refreshJobs);
    const btnJobsCreate = $('btnJobsCreate');
    if(btnJobsCreate) btnJobsCreate.addEventListener('click', ()=> openJobEditor(null));
    const btnJobsApproveReady = $('btnJobsApproveReady');
    if(btnJobsApproveReady) btnJobsApproveReady.addEventListener('click', openApproveReadyModal);

    const wireMenuBadgeAction = (id, handler) => {
      const el = $(id);
      if(!el || el._wired) return;
      el._wired = true;
      el.addEventListener('click', (e)=>{
        e.preventDefault();
        e.stopPropagation();
        handler();
      });
    };
    const openOrderHistoryWithStatus = (statuses) => {
      toggleMenu(false);
      void openOrderHistoryModal({
        returnToOrder: false,
        tab: 'orders',
        statusFilter: Array.isArray(statuses) ? statuses : [],
        searchFilter: ''
      });
    };

    wireMenuBadgeAction('menuOrderDraftBadge', ()=> openOrderHistoryWithStatus(['draft']));
    wireMenuBadgeAction('menuOrderSubmittedBadge', ()=> openOrderHistoryWithStatus(['submitted','partially_received']));
    wireMenuBadgeAction('menuReceiveReceiptsBadge', ()=>{
      toggleMenu(false);
      openReceiveInboxModal();
    });
    wireMenuBadgeAction('menuReceivePendingBadge', ()=>{
      toggleMenu(false);
      openReceivePendingModal();
    });
    wireMenuBadgeAction('menuJobsDraftBadge', ()=>{
      toggleMenu(false);
      openJobsModal();
    });
    wireMenuBadgeAction('menuJobsReadyBadge', ()=>{
      toggleMenu(false);
      openApproveReadyModal();
    });
    const jobsList = $('jobsList');
    if(jobsList) jobsList.addEventListener('click', async (e)=>{
      const viewBtn = e.target.closest('[data-job-view-id]');
      if(viewBtn){
        const id = String(viewBtn.getAttribute('data-job-view-id') || '').trim();
        if(id) toggleJobExpanded(id);
        return;
      }
      const toggleRow = e.target.closest('[data-job-toggle-id]');
      if(toggleRow && !e.target.closest('.job-actions')){
        const id = String(toggleRow.getAttribute('data-job-toggle-id') || '').trim();
        if(id) toggleJobExpanded(id);
        return;
      }
      const orderBtn = e.target.closest('.job-bom-order-btn');
      if(orderBtn){
        const itemId = String(orderBtn.getAttribute('data-item-id') || '').trim();
        const shortage = Number(orderBtn.getAttribute('data-shortage') || 0);
        const jobId = String(orderBtn.getAttribute('data-job-id') || '').trim();
        const shortfallId = String(orderBtn.getAttribute('data-shortfall-id') || '').trim();
        const shortfallQty = Number(orderBtn.getAttribute('data-shortfall-qty') || 0);
        if(itemId && shortage > 0){
          addToOrderFromBom(itemId, shortage, {
            jobId,
            shortfallId,
            shortfallQty
          });
          // Show cart feedback animation
          showCartAddedFeedback(orderBtn, shortage);
        }
        return;
      }
      const deleteBtn = e.target.closest('.job-bom-delete-btn');
      if(deleteBtn){
        const jobId = String(deleteBtn.getAttribute('data-job-id') || '').trim();
        const itemId = String(deleteBtn.getAttribute('data-item-id') || '').trim();
        if(jobId && itemId){
          await removeJobBomLineFromList(jobId, itemId);
        }
        return;
      }
      const editBtn = e.target.closest('[data-job-edit-id]');
      if(editBtn){
        const id = String(editBtn.getAttribute('data-job-edit-id') || '').trim();
        if(id) openJobEditor(id);
        return;
      }
      const approveBtn = e.target.closest('[data-job-approve-id]');
      if(approveBtn){
        const id = String(approveBtn.getAttribute('data-job-approve-id') || '').trim();
        if(!id) return;
        if(!(await openConfirmModal('Approve job?', 'This will reserve inventory for the planned BOM.', { okText:'Approve', cancelText:'Cancel' }))) return;
        await approveJob(id);
        return;
      }
      const completeBtn = e.target.closest('[data-job-complete-id]');
      if(completeBtn){
        const id = String(completeBtn.getAttribute('data-job-complete-id') || '').trim();
        if(id) openJobEditor(id, { focus:'complete' });
        return;
      }
      const voidBtn = e.target.closest('[data-job-void-id]');
      if(voidBtn){
        const id = String(voidBtn.getAttribute('data-job-void-id') || '').trim();
        if(id) await voidJob(id);
        return;
      }
    });
    const approveReadyList = $('approveReadyList');
    if(approveReadyList) approveReadyList.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-approve-ready-id]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-approve-ready-id') || '').trim();
      if(!id) return;
      show('approveReadyModal', false);
      openJobEditor(id, { focus:'readiness' });
    });
    const btnJobEditorClose = $('btnJobEditorClose');
    if(btnJobEditorClose) btnJobEditorClose.addEventListener('click', ()=> show('jobEditorModal', false));
    // Job Item Picker event listeners
    const btnJobAddItem = $('btnJobAddItem');
    if(btnJobAddItem) btnJobAddItem.addEventListener('click', openJobItemPicker);
    const jobItemPickerSearch = $('jobItemPickerSearch');
    if(jobItemPickerSearch){
      jobItemPickerSearch.addEventListener('input', (e)=> renderJobItemPickerResults(e.target.value));
      jobItemPickerSearch.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){ closeJobItemPicker(); }
      });
    }
    const jobItemPickerResults = $('jobItemPickerResults');
    if(jobItemPickerResults) jobItemPickerResults.addEventListener('click', (e)=>{
      const row = e.target.closest('[data-picker-item-id]');
      if(row){
        const itemId = String(row.getAttribute('data-picker-item-id') || '').trim();
        if(itemId) selectJobItemPickerItem(itemId);
      }
    });
    const jobItemPickerQtyMinus = $('jobItemPickerQtyMinus');
    if(jobItemPickerQtyMinus) jobItemPickerQtyMinus.addEventListener('click', ()=>{
      const inp = $('jobItemPickerQty');
      if(inp) inp.value = String(Math.max(1, toInt(inp.value, 1) - 1));
    });
    const jobItemPickerQtyPlus = $('jobItemPickerQtyPlus');
    if(jobItemPickerQtyPlus) jobItemPickerQtyPlus.addEventListener('click', ()=>{
      const inp = $('jobItemPickerQty');
      if(inp) inp.value = String(toInt(inp.value, 1) + 1);
    });
    const btnJobItemPickerCancel = $('btnJobItemPickerCancel');
    if(btnJobItemPickerCancel) btnJobItemPickerCancel.addEventListener('click', closeJobItemPicker);
    const btnJobItemPickerAdd = $('btnJobItemPickerAdd');
    if(btnJobItemPickerAdd) btnJobItemPickerAdd.addEventListener('click', confirmJobItemPicker);
    const jobBomTable = $('jobBomTable');
    if(jobBomTable) jobBomTable.addEventListener('click', (e)=>{
      const stepBtn = e.target.closest('[data-bom-step]');
      if(stepBtn){
        const itemId = String(stepBtn.getAttribute('data-bom-item-id') || '').trim();
        const dir = String(stepBtn.getAttribute('data-bom-step') || '').trim();
        const input = itemId ? document.querySelector(`[data-bom-qty-input="${CSS.escape(itemId)}"]`) : null;
        const current = input ? Number(input.value || 0) : 0;
        const delta = dir === 'inc' ? 1 : -1;
        const next = Math.max(1, current + delta);
        if(input) input.value = String(next);
        if(itemId){
          const editor = state._jobEditor;
          if(editor && editor.job && editor.job.id){
            updateJobBomLine(itemId, next);
          }else{
            setPendingJobBomQty(itemId, next);
          }
        }
        return;
      }
      const orderBtn = e.target.closest('[data-bom-order-id]');
      if(orderBtn){
        const itemId = String(orderBtn.getAttribute('data-bom-order-id') || '').trim();
        const qty = Number(orderBtn.getAttribute('data-bom-order-qty') || 0);
        const jobId = String(orderBtn.getAttribute('data-bom-order-job-id') || '').trim();
        const shortfallId = String(orderBtn.getAttribute('data-bom-order-shortfall-id') || '').trim();
        const shortfallQty = Number(orderBtn.getAttribute('data-bom-order-shortfall-qty') || 0);
        if(itemId){
          addToOrderFromBom(itemId, qty || 1, {
            jobId,
            shortfallId,
            shortfallQty
          });
        }
        return;
      }
      const editBtn = e.target.closest('[data-bom-edit-id]');
      if(editBtn){
        const itemId = String(editBtn.getAttribute('data-bom-edit-id') || '').trim();
        if(itemId) openEditItemModal(itemId);
        return;
      }
      const removeBtn = e.target.closest('[data-bom-remove-id]');
      if(removeBtn){
        const itemId = String(removeBtn.getAttribute('data-bom-remove-id') || '').trim();
        if(itemId) removeJobBomLine(itemId);
        return;
      }
      const card = e.target.closest('[data-bom-card]');
      if(card){
        const itemId = String(card.getAttribute('data-bom-item-id') || '').trim();
        if(itemId) toggleJobEditorItemExpanded(itemId);
      }
    });
    const jobActualsTable = $('jobActualsTable');
    if(jobActualsTable) jobActualsTable.addEventListener('click', (e)=>{
      const stepBtn = e.target.closest('[data-actual-step]');
      if(stepBtn){
        const itemId = String(stepBtn.getAttribute('data-actual-item-id') || '').trim();
        const dir = String(stepBtn.getAttribute('data-actual-step') || '').trim();
        const input = itemId ? document.querySelector(`[data-actual-qty-input="${CSS.escape(itemId)}"]`) : null;
        const current = input ? Number(input.value || 0) : 0;
        const delta = dir === 'inc' ? 1 : -1;
        const next = Math.max(0, current + delta);
        if(input) input.value = String(next);
        updateJobCompletionMetricsFromDom();
      }
    });
    if(jobActualsTable) jobActualsTable.addEventListener('input', (e)=>{
      const input = e.target;
      if(!input || !input.matches || !input.matches('[data-actual-qty-input]')) return;
      updateJobCompletionMetricsFromDom();
    });
    document.querySelectorAll('.job-tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tab = String(btn.dataset.jobTab || '').trim();
        if(tab) setJobEditorTab(tab);
      });
    });
    document.querySelectorAll('.job-step-item').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tab = String(btn.dataset.jobStep || '').trim();
        if(tab) setJobEditorTab(tab);
      });
    });
    const btnJobNextMaterials = $('btnJobNextMaterials');
    if(btnJobNextMaterials) btnJobNextMaterials.addEventListener('click', ()=>{
      if(btnJobNextMaterials.disabled) return;
      setJobEditorTab('materials');
    });
    const btnJobNextExecution = $('btnJobNextExecution');
    if(btnJobNextExecution) btnJobNextExecution.addEventListener('click', ()=>{
      if(btnJobNextExecution.disabled) return;
      setJobEditorTab('execution');
    });
    const jobNameInput = $('jobNameInput');
    if(jobNameInput) jobNameInput.addEventListener('input', ()=>{
      const val = String(jobNameInput.value || '').trim();
      const statusName = $('jobStatusName');
      if(statusName) statusName.textContent = val || 'Untitled Job';
      const nextMaterials = $('btnJobNextMaterials');
      if(nextMaterials){
        nextMaterials.disabled = !val;
        nextMaterials.style.opacity = val ? '1' : '0.5';
      }
      const detailsHint = $('jobDetailsHint');
      if(detailsHint) detailsHint.textContent = val ? '' : 'Enter a job name to continue.';
      const detailsCheck = $('jobTabDetailsCheck');
      if(detailsCheck){
        detailsCheck.style.display = val ? 'inline-flex' : 'none';
        detailsCheck.innerHTML = val ? ICONS.check : '';
      }
      if(state._jobEditor && state._jobEditor.job){
        state._jobEditor.job.name = val;
      }
      updateJobProgressStepper(state._jobEditor);
      // Trigger autosave for existing jobs
      if(state._jobEditor && state._jobEditor.job && state._jobEditor.job.id){
        triggerJobAutosave();
      }
    });
    // Job notes autosave
    const jobNotesInput = $('jobNotesInput');
    if(jobNotesInput) jobNotesInput.addEventListener('input', ()=>{
      const val = String(jobNotesInput.value || '').trim();
      if(state._jobEditor && state._jobEditor.job){
        state._jobEditor.job.notes = val;
      }
      const completionNotes = $('jobCompletionNotesInput');
      if(completionNotes && completionNotes !== document.activeElement){
        completionNotes.value = val;
      }
      // Trigger autosave for existing jobs
      if(state._jobEditor && state._jobEditor.job && state._jobEditor.job.id){
        triggerJobAutosave();
      }
    });
    const jobCompletionNotesInput = $('jobCompletionNotesInput');
    if(jobCompletionNotesInput) jobCompletionNotesInput.addEventListener('input', ()=>{
      const val = String(jobCompletionNotesInput.value || '').trim();
      if(state._jobEditor && state._jobEditor.job){
        state._jobEditor.job.notes = val;
      }
      const notesInput = $('jobNotesInput');
      if(notesInput && notesInput !== document.activeElement){
        notesInput.value = val;
      }
      if(state._jobEditor && state._jobEditor.job && state._jobEditor.job.id){
        triggerJobAutosave();
      }
    });
    const jobEditorModal = $('jobEditorModal');
    if(jobEditorModal){
      const autosaveHandler = (e)=>{
        const editor = state._jobEditor;
        if(!editor || !editor.job || !editor.job.id) return;
        const target = e && e.target;
        if(target && target.matches && target.matches('input, textarea, select')){
          triggerJobAutosave();
        }
      };
      jobEditorModal.addEventListener('input', autosaveHandler);
      jobEditorModal.addEventListener('change', autosaveHandler);
    }
    const btnJobApprove = $('btnJobApprove');
    if(btnJobApprove) btnJobApprove.addEventListener('click', async ()=>{
      const editor = state._jobEditor;
      const jobId = editor && editor.job ? editor.job.id : null;
      if(!jobId) return;
      if(!(await openConfirmModal('Approve job?', 'This will reserve inventory for the planned BOM.', { okText:'Approve', cancelText:'Cancel' }))) return;
      await approveJob(jobId, { button: btnJobApprove });
    });
    const btnJobComplete = $('btnJobComplete');
    if(btnJobComplete) btnJobComplete.addEventListener('click', ()=>{
      const editor = state._jobEditor;
      const jobId = editor && editor.job ? editor.job.id : null;
      if(jobId) completeJob(jobId);
    });
    const btnJobVoid = $('btnJobVoid');
    if(btnJobVoid) btnJobVoid.addEventListener('click', ()=>{
      const editor = state._jobEditor;
      const jobId = editor && editor.job ? editor.job.id : null;
      if(jobId) voidJob(jobId);
    });
    const btnJobReopen = $('btnJobReopen');
    if(btnJobReopen) btnJobReopen.addEventListener('click', ()=>{
      const editor = state._jobEditor;
      const jobId = editor && editor.job ? editor.job.id : null;
      if(jobId) reopenJob(jobId);
    });
    // Add to Job modal event listeners (use delegation for reliability)
    const addToJobModal = $('addToJobModal');
    if(addToJobModal){
      addToJobModal.addEventListener('click', (e)=>{
        // Confirm button
        if(e.target.closest('#btnAddToJobConfirm')){
          confirmAddToJob();
          return;
        }
        // Tab switching
        const tabBtn = e.target.closest('[data-atj-tab]');
        if(tabBtn){
          const tab = tabBtn.getAttribute('data-atj-tab');
          if(tab) switchAtjTab(tab);
          return;
        }
        // Dropdown trigger
        if(e.target.closest('#atjDropdownTrigger')){
          e.stopPropagation();
          toggleAtjDropdown();
          return;
        }
        // Dropdown item selection
        const dropdownItem = e.target.closest('[data-job-id]');
        if(dropdownItem){
          const jobId = dropdownItem.getAttribute('data-job-id');
          if(jobId) selectAtjJob(jobId);
          return;
        }
        // Quantity buttons
        if(e.target.closest('#atjQtyMinus')){
          adjustAtjQty(-1);
          return;
        }
        if(e.target.closest('#atjQtyPlus')){
          adjustAtjQty(1);
          return;
        }
      });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e)=>{
      if(!isAtjDropdownOpen()) return;
      const dropdown = $('atjDropdown');
      if(dropdown && !dropdown.contains(e.target)) closeAtjDropdown();
    });

    // New job inputs
    const atjNewJobName = $('atjNewJobName');
    if(atjNewJobName) atjNewJobName.addEventListener('input', ()=>{
      if(!state._addToJob) return;
      state._addToJob.newJobName = String(atjNewJobName.value || '');
    });
    const atjNewJobDesc = $('atjNewJobDesc');
    if(atjNewJobDesc) atjNewJobDesc.addEventListener('input', ()=>{
      if(!state._addToJob) return;
      state._addToJob.newJobDesc = String(atjNewJobDesc.value || '');
    });

    // Quantity input (typing)
    const atjQtyInput = $('atjQtyInput');
    if(atjQtyInput) atjQtyInput.addEventListener('input', ()=>{
      if(!state._addToJob) return;
      state._addToJob.qty = Math.max(1, toInt(atjQtyInput.value, 1));
    });
    const btnTrashReload = $('btnTrashReload');
    if(btnTrashReload) btnTrashReload.addEventListener('click', refreshTrash);
    const trashFilter = $('trashFilter');
    if(trashFilter) trashFilter.addEventListener('input', ()=>{
      state._trashFilter = trashFilter.value || '';
      renderTrashList();
    });
    const trashList = $('trashList');
    if(trashList) trashList.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-restore-id]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-restore-id') || '').trim();
      if(!id) return;
      if(!canItemsRestore()){ toast('Restore not allowed'); return; }
      const row = Array.isArray(state._trashItems) ? state._trashItems.find(r => String(r && r.id ? r.id : '') === id) : null;
      const name = row && row.name ? String(row.name) : 'item';
      if(!(await openConfirmModal('Restore item?', `Restore "${name}" from trash?`, { okText:'Restore', cancelText:'Cancel' }))) return;
      btn.disabled = true;
      btn.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('restore_item', { p_item_id: id });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Restore failed');
        }
        state._trashItems = (state._trashItems || []).filter(r => String(r && r.id ? r.id : '') !== id);
        renderTrashList();
        try{ await sbLoadSnapshot(); }catch(e){}
        toast('Item restored');
      }catch(err){
        toast(err && err.message ? err.message : 'Restore failed');
      }finally{
        btn.disabled = false;
        btn.setAttribute('aria-disabled', 'false');
      }
    });
    const btnAuditClose = $('btnAuditClose');
    if(btnAuditClose) btnAuditClose.addEventListener('click', closeAuditModal);
    const btnAuditRefresh = $('btnAuditRefresh');
    if(btnAuditRefresh) btnAuditRefresh.addEventListener('click', refreshAuditLog);
    const auditTableFilter = $('auditTableFilter');
    if(auditTableFilter) auditTableFilter.addEventListener('change', ()=>{
      state._auditTableFilter = auditTableFilter.value || '';
      refreshAuditLog();
    });
    const auditActionFilter = $('auditActionFilter');
    if(auditActionFilter) auditActionFilter.addEventListener('change', ()=>{
      state._auditActionFilter = auditActionFilter.value || '';
      refreshAuditLog();
    });
    const auditSearchFilter = $('auditSearchFilter');
    if(auditSearchFilter) auditSearchFilter.addEventListener('input', ()=>{
      state._auditSearch = auditSearchFilter.value || '';
      renderAuditList();
    });
    const btnAuditDownload = $('btnAuditDownload');
    if(btnAuditDownload) btnAuditDownload.addEventListener('click', downloadAuditCsv);
    const btnSnapshotsClose = $('btnSnapshotsClose');
    if(btnSnapshotsClose) btnSnapshotsClose.addEventListener('click', closeSnapshotsModal);
    const btnSnapshotBack = $('btnSnapshotBack');
    if(btnSnapshotBack) btnSnapshotBack.addEventListener('click', showSnapshotList);
    const snapshotsList = $('snapshotsList');
    if(snapshotsList) snapshotsList.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-snapshot-preview-id]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-snapshot-preview-id') || '').trim();
      if(!id) return;
      openSnapshotPreview(id);
    });
    const btnMetricsClose = $('btnMetricsClose');
    if(btnMetricsClose) btnMetricsClose.addEventListener('click', closeMetricsModal);
    const metricsRange = $('metricsRange');
    if(metricsRange) metricsRange.addEventListener('change', loadMetrics);
    const metricsView = $('metricsView');
    if(metricsView) metricsView.addEventListener('change', loadMetrics);
		    const menuReport = $('menuReport');
		    if(menuReport) menuReport.addEventListener('click', ()=>{
		      toggleMenu(false);
		      if(!canItemsView()){ toast('Report access requires view permission'); return; }
		      openReportModal();
		    });
		    const btnReportClose = $('btnReportClose');
		    if(btnReportClose) btnReportClose.addEventListener('click', closeReportModal);
				    const btnReportBatchOrder = $('btnReportBatchOrder');
				    if(btnReportBatchOrder) btnReportBatchOrder.addEventListener('click', (e)=>{
				      try{ e.preventDefault(); e.stopPropagation(); }catch(ex){}
				      batchAddLowStockToCart();
				    });
				    const btnReportDownload = $('btnReportDownload');
				    if(btnReportDownload) btnReportDownload.addEventListener('click', downloadInventoryReportCsv);
				    const btnReportShare = $('btnReportShare');
				    if(btnReportShare) btnReportShare.addEventListener('click', ()=>{ void shareInventoryReport(); });
				    const reportLowStockList = $('reportLowStockList');
				    const reportExemptList = $('reportExemptList');
				    const reportInventoryList = $('reportList');
				    function toggleOrderFromReportClick(e){
				      const row = e.target.closest('button[data-report-order-id]');
				      if(!row) return;
			      e.preventDefault();
			      e.stopPropagation();
			      const id = String(row.dataset.reportOrderId || '').trim();
			      if(!id) return;
			      const item = getInventoryById(id);
			      if(!item) return;
				      const ord = orderState();
				      const exists = Array.isArray(ord.lines) && ord.lines.some(l => String(l && l.id ? l.id : '').trim() === id);
				      if(exists) removeOrderLine(id);
				      else upsertOrderLineFromItem(item, 1);
					    }
				    if(reportLowStockList) reportLowStockList.addEventListener('click', toggleOrderFromReportClick);
				    if(reportExemptList) reportExemptList.addEventListener('click', toggleOrderFromReportClick);
				    if(reportInventoryList) reportInventoryList.addEventListener('click', toggleOrderFromReportClick);
				    const btnReportEmailClose = $('btnReportEmailClose');
				    if(btnReportEmailClose) btnReportEmailClose.addEventListener('click', closeReportEmailModal);
				    const btnReportEmailCopy = $('btnReportEmailCopy');
		    if(btnReportEmailCopy) btnReportEmailCopy.addEventListener('click', async ()=>{
		      try{
		        const html = String(_reportEmailHtml || '').trim();
		        if(!html){ toast('Nothing to copy'); return; }
		        await navigator.clipboard.writeText(html);
		        toast('Copied', 'success');
		      }catch(e){
		        toast('Copy failed', 'error');
		      }
		    });
		    const btnReportEmailSend = $('btnReportEmailSend');
		    if(btnReportEmailSend) btnReportEmailSend.addEventListener('click', async ()=>{
		      const to = String($('reportEmailTo')?.value || '').trim();
		      const subjectLine = String($('reportEmailSubject')?.value || '').trim() || defaultInventoryReportEmailSubject();
		      const html = String(_reportEmailHtml || '').trim();
		      setReportEmailMessage('');
		      if(!looksLikeEmailAddress(to)){ setReportEmailMessage('Enter a valid email.'); return; }
		      if(!html){ setReportEmailMessage('Nothing to send.'); return; }

		      const prior = btnReportEmailSend.textContent;
		      btnReportEmailSend.disabled = true;
		      btnReportEmailSend.textContent = 'Sendingâ€¦';
		      try{
		        await sendInventoryReportEmailViaApi({ toEmail: to, subjectLine, html });
		        toast('Report sent', 'success');
		        closeReportEmailModal();
		      }catch(e){
		        const msg = (e && e.message) ? String(e.message) : 'Send failed';
		        setReportEmailMessage(msg);
		        const fallback = await openConfirmModal('Send failed', `${msg}\n\nOpen your email app with a text report instead?`, { okText:'Open Email', cancelText:'Stay' });
		        if(fallback){
		          const data = reportDataSnapshot();
		          const text = buildInventoryReportText(data, { maxLines: 180 });
		          const stamp = new Date().toISOString().slice(0,10);
		          const subject = subjectLine || `Inventory Report (${stamp})`;
		          const mailto = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
		          window.location.href = mailto;
		        }
		      }finally{
		        btnReportEmailSend.disabled = false;
		        btnReportEmailSend.textContent = prior || 'Send';
		      }
		    });
	    const btnOrderHistory = $('btnOrderHistory');
	    if(btnOrderHistory) btnOrderHistory.addEventListener('click', ()=> openOrderHistoryModal({ returnToOrder: true }));
	    const btnOrderHistoryClose = $('btnOrderHistoryClose');
	    if(btnOrderHistoryClose) btnOrderHistoryClose.addEventListener('click', closeOrderHistoryModal);
	    const btnOrderHistoryDownload = $('btnOrderHistoryDownload');
	    if(btnOrderHistoryDownload) btnOrderHistoryDownload.addEventListener('click', downloadOrderHistoryCsv);
	    const btnOrderHistoryRefresh = $('btnOrderHistoryRefresh');
	    if(btnOrderHistoryRefresh) btnOrderHistoryRefresh.addEventListener('click', refreshOrderHistory);
	    const btnReceiveOrderClose = $('btnReceiveOrderClose');
	    if(btnReceiveOrderClose) btnReceiveOrderClose.addEventListener('click', closeReceiveOrderModal);
	    const btnReceiveOrderCancel = $('btnReceiveOrderCancel');
	    if(btnReceiveOrderCancel) btnReceiveOrderCancel.addEventListener('click', closeReceiveOrderModal);
	    const btnReceiveOrderSave = $('btnReceiveOrderSave');
	    if(btnReceiveOrderSave) btnReceiveOrderSave.addEventListener('click', handleSaveReceiptDraft);
	    const btnReceiveOrderComplete = $('btnReceiveOrderComplete');
	    if(btnReceiveOrderComplete) btnReceiveOrderComplete.addEventListener('click', handleCompleteReceipt);
    const receiveReceiptNotes = $('receiveReceiptNotes');
    if(receiveReceiptNotes) receiveReceiptNotes.addEventListener('input', ()=>{
      if(state._receiveOrder) state._receiveOrder.receiptNotes = String(receiveReceiptNotes.value || '');
    });
    const receiveScannedTitleMain = $('receiveScannedTitleMain');
    const receiveScannedTitleSub = $('receiveScannedTitleSub');
    const receiveScannedTotal = $('receiveScannedTotal');
    const receiveReceiptNotesToggle = $('receiveReceiptNotesToggle');
    const receiveReceiptNotesContent = $('receiveReceiptNotesContent');
    if(receiveReceiptNotesToggle && receiveReceiptNotesContent && !receiveReceiptNotesToggle._wired){
      receiveReceiptNotesToggle._wired = true;
      receiveReceiptNotesToggle.addEventListener('click', ()=>{
        const expanded = receiveReceiptNotesToggle.getAttribute('aria-expanded') === 'true';
        receiveReceiptNotesToggle.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        receiveReceiptNotesContent.classList.toggle('is-open', !expanded);
      });
    }
    const receiveReceiptVendor = $('receiveReceiptVendor');
    if(receiveReceiptVendor) receiveReceiptVendor.addEventListener('input', ()=>{
      if(state._receiveOrder) state._receiveOrder.receiptVendor = String(receiveReceiptVendor.value || '');
      if(receiveScannedTitleMain && state._receiveOrder && state._receiveOrder.tab === 'scanned' && state._receiveOrder.mode !== 'inbox'){
        receiveScannedTitleMain.textContent = String(receiveReceiptVendor.value || '').trim() || 'Receipt review';
      }
    });
    const receiveReceiptDate = $('receiveReceiptDate');
    if(receiveReceiptDate) receiveReceiptDate.addEventListener('input', ()=>{
      if(state._receiveOrder) state._receiveOrder.receiptDate = String(receiveReceiptDate.value || '');
      if(receiveScannedTitleSub && state._receiveOrder && state._receiveOrder.tab === 'scanned' && state._receiveOrder.mode !== 'inbox'){
        const dateVal = String(receiveReceiptDate.value || '').trim();
        receiveScannedTitleSub.textContent = dateVal ? formatDateShort(dateVal) : 'Review before inventory is updated.';
      }
    });
    const receiveReceiptTotal = $('receiveReceiptTotal');
    if(receiveReceiptTotal){
      receiveReceiptTotal.addEventListener('input', ()=>{
        if(state._receiveOrder) state._receiveOrder.receiptTotal = String(receiveReceiptTotal.value || '');
        if(receiveScannedTotal && state._receiveOrder && state._receiveOrder.tab === 'scanned' && state._receiveOrder.mode !== 'inbox'){
          const totalNum = parseReceiptNumber(receiveReceiptTotal.value);
          if(totalNum !== null && typeof totalNum !== 'undefined'){
            receiveScannedTotal.textContent = formatReceiptMoney(totalNum);
            receiveScannedTotal.style.display = '';
          }else{
            receiveScannedTotal.textContent = '';
            receiveScannedTotal.style.display = 'none';
          }
        }
      });
      receiveReceiptTotal.addEventListener('blur', ()=>{
        const val = receiveReceiptTotal.value;
        const num = parseReceiptNumber(val);
        if(num !== null && typeof num !== 'undefined'){
          receiveReceiptTotal.value = formatReceiptMoney(num);
          if(state._receiveOrder) state._receiveOrder.receiptTotal = receiveReceiptTotal.value;
        }
      });
    }
    const receiptParsedLines = $('receiptParsedLines');
    if(receiptParsedLines && !receiptParsedLines._wired){
      receiptParsedLines._wired = true;
      let searchDebounce = null;
      // Helper to update rejection row visibility and stepper styling
      function updateRejectionRowVisibility(idx){
        const lines = Array.isArray(state._receiveOrder?.parsedLineItems) ? state._receiveOrder.parsedLineItems : [];
        const line = lines[idx];
        if(!line) return;
        const qtyParsed = Number(line.qty || 0);
        const qtyReceived = Number(line.qty_received ?? qtyParsed);
        const hasMismatch = qtyReceived < qtyParsed;
        const rejectionRow = document.querySelector(`[data-rejection-row="${idx}"]`);
        const receivedStepper = document.querySelector(`[data-stepper-received="${idx}"]`);
        if(rejectionRow){
          rejectionRow.classList.toggle('is-visible', hasMismatch);
        }
        if(receivedStepper){
          receivedStepper.classList.remove('qty-stepper--received', 'qty-stepper--mismatch');
          receivedStepper.classList.add(hasMismatch ? 'qty-stepper--mismatch' : 'qty-stepper--received');
        }
      }
      receiptParsedLines.addEventListener('input', (e)=>{
        // Handle parsed line field inputs (description, sku, qty, unit_price)
        const inp = e.target.closest('[data-receipt-line-field]');
        if(inp && state._receiveOrder){
          const idx = toInt(inp.getAttribute('data-receipt-line-index'), -1);
          if(idx >= 0){
            const field = String(inp.getAttribute('data-receipt-line-field') || '').trim();
            const lines = Array.isArray(state._receiveOrder.parsedLineItems) ? state._receiveOrder.parsedLineItems : [];
            const line = lines[idx];
            if(line){
              if(field === 'description'){
                line.description = String(inp.value || '');
              }else if(field === 'sku'){
                line.sku = String(inp.value || '');
              }else if(field === 'qty' || field === 'unit_price'){
                line[field] = parseReceiptNumber(inp.value);
                line.line_total = getParsedLineTotal(line);
                // Update rejection visibility when parsed qty changes
                if(field === 'qty'){
                  updateRejectionRowVisibility(idx);
                }
              }
              const row = inp.closest('.receipt-parsed-line');
              const totalEl = row ? row.querySelector('.receipt-parsed-total-value') : null;
              if(totalEl){
                const lineTotal = getParsedLineTotal(line);
                totalEl.textContent = (lineTotal === null || typeof lineTotal === 'undefined') ? 'â€”' : formatReceiptMoney(lineTotal);
              }
            }
          }
        }
        // Handle actuals field inputs (qty_received, rejection_reason)
        const actualsInp = e.target.closest('[data-parsed-line-field]');
        if(actualsInp && state._receiveOrder){
          const idx = toInt(actualsInp.getAttribute('data-parsed-line-index'), -1);
          if(idx >= 0){
            const field = String(actualsInp.getAttribute('data-parsed-line-field') || '').trim();
            const lines = Array.isArray(state._receiveOrder.parsedLineItems) ? state._receiveOrder.parsedLineItems : [];
            const line = lines[idx];
            if(line){
              if(field === 'qty_received'){
                line[field] = toInt(actualsInp.value, 0);
                updateRejectionRowVisibility(idx);
              }else if(field === 'rejection_reason'){
                line[field] = String(actualsInp.value || '');
              }
              syncParsedLineToReceiveLines(idx);
            }
          }
        }
        // Handle inventory search input
        const searchInp = e.target.closest('[data-parsed-line-search-input]');
        if(searchInp && state._receiveOrder){
          const idx = toInt(searchInp.getAttribute('data-parsed-line-search-input'), -1);
          if(idx >= 0){
            clearTimeout(searchDebounce);
            searchDebounce = setTimeout(()=>{
              renderParsedLineSearchResults(idx, String(searchInp.value || '').trim());
            }, 150);
          }
        }
      });
      receiptParsedLines.addEventListener('click', (e)=>{
        // Stepper button clicks
        const stepperBtn = e.target.closest('[data-stepper-action]');
        if(stepperBtn && state._receiveOrder){
          const action = stepperBtn.getAttribute('data-stepper-action');
          const field = stepperBtn.getAttribute('data-stepper-field');
          const idx = toInt(stepperBtn.getAttribute('data-stepper-index'), -1);
          if(idx >= 0 && (action === 'inc' || action === 'dec')){
            const lines = Array.isArray(state._receiveOrder.parsedLineItems) ? state._receiveOrder.parsedLineItems : [];
            const line = lines[idx];
            if(line){
              // Determine if it's a parsed field or actuals field
              const isParsedField = field === 'qty' || field === 'unit_price';
              let currentVal = 0;
              if(isParsedField){
                currentVal = Number(line[field] || 0);
              }else if(field === 'qty_received'){
                const qtyParsed = Number(line.qty || 0);
                currentVal = Number(line.qty_received ?? qtyParsed);
              }
              const newVal = Math.max(0, action === 'inc' ? currentVal + 1 : currentVal - 1);
              if(isParsedField){
                line[field] = newVal;
                line.line_total = getParsedLineTotal(line);
                // Update display
                const row = document.querySelector(`[data-receipt-line-index="${idx}"]`)?.closest('.receipt-parsed-line');
                const totalEl = row ? row.querySelector('.receipt-parsed-total-value') : null;
                if(totalEl){
                  const lineTotal = getParsedLineTotal(line);
                  totalEl.textContent = (lineTotal === null || typeof lineTotal === 'undefined') ? 'â€”' : formatReceiptMoney(lineTotal);
                }
              }else{
                line[field] = newVal;
                syncParsedLineToReceiveLines(idx);
              }
              // Update input value
              const stepper = stepperBtn.closest('.qty-stepper');
              const input = stepper ? stepper.querySelector('input') : null;
              if(input) input.value = String(newVal);
              // Update rejection row visibility
              updateRejectionRowVisibility(idx);
            }
          }
          return;
        }
        // Add new line
        const addBtn = e.target.closest('[data-receipt-line-add]');
        if(addBtn && state._receiveOrder){
          if(!Array.isArray(state._receiveOrder.parsedLineItems)) state._receiveOrder.parsedLineItems = [];
          state._receiveOrder.parsedLineItems.push({
            description: '',
            sku: '',
            qty: 1,
            unit_price: null,
            line_total: null,
          });
          renderReceiveOrderModal();
          return;
        }
        // Match to inventory (click on search result)
        const resultBtn = e.target.closest('[data-parsed-line-match-item]');
        if(resultBtn && state._receiveOrder){
          const idx = toInt(resultBtn.getAttribute('data-parsed-line-idx'), -1);
          const itemId = String(resultBtn.getAttribute('data-parsed-line-match-item') || '').trim();
          if(idx >= 0 && itemId){
            matchParsedLineToInventory(idx, itemId);
          }
          return;
        }
        // Unmatch
        const unmatchBtn = e.target.closest('[data-parsed-line-unmatch]');
        if(unmatchBtn && state._receiveOrder){
          const idx = toInt(unmatchBtn.getAttribute('data-parsed-line-unmatch'), -1);
          if(idx >= 0){
            unmatchParsedLine(idx);
          }
          return;
        }
      });
      // Enter key handling - save and move to next field
      receiptParsedLines.addEventListener('keydown', (e)=>{
        if(e.key === 'Enter' && !e.shiftKey){
          const inp = e.target.closest('input, textarea');
          if(inp && !inp.matches('textarea')){
            e.preventDefault();
            // Find next focusable input in the same item or next item
            const allInputs = Array.from(receiptParsedLines.querySelectorAll('input:not([disabled]), textarea:not([disabled])'));
            const currentIdx = allInputs.indexOf(inp);
            if(currentIdx >= 0 && currentIdx < allInputs.length - 1){
              allInputs[currentIdx + 1].focus();
              allInputs[currentIdx + 1].select();
            }else{
              inp.blur();
            }
          }
        }
      });
      receiptParsedLines.addEventListener('focusin', (e)=>{
        const searchInp = e.target.closest('[data-parsed-line-search-input]');
        if(searchInp){
          const idx = toInt(searchInp.getAttribute('data-parsed-line-search-input'), -1);
          if(idx >= 0){
            renderParsedLineSearchResults(idx, String(searchInp.value || '').trim());
          }
        }
      });
      receiptParsedLines.addEventListener('focusout', (e)=>{
        const searchInp = e.target.closest('[data-parsed-line-search-input]');
        if(searchInp){
          const idx = toInt(searchInp.getAttribute('data-parsed-line-search-input'), -1);
          const resultsWrap = document.querySelector(`[data-parsed-line-results="${idx}"]`);
          // Delay hiding so click events can fire
          setTimeout(()=>{
            if(resultsWrap && !resultsWrap.contains(document.activeElement)){
              resultsWrap.style.display = 'none';
            }
          }, 200);
        }
      });
    }
    function renderParsedLineSearchResults(idx, term){
      const resultsWrap = document.querySelector(`[data-parsed-line-results="${idx}"]`);
      if(!resultsWrap) return;
      if(!term){
        resultsWrap.innerHTML = '';
        resultsWrap.style.display = 'none';
        return;
      }
      const items = Array.isArray(state.items) ? state.items : [];
      const termLower = term.toLowerCase();
      const matches = items.filter(it => {
        const name = String(it && it.name ? it.name : '').toLowerCase();
        const sku = String(it && it.sku ? it.sku : '').toLowerCase();
        const desc = String(it && it.desc ? it.desc : '').toLowerCase();
        return name.includes(termLower) || sku.includes(termLower) || desc.includes(termLower);
      }).slice(0, 8);
      if(!matches.length){
        resultsWrap.innerHTML = `<div class="parsed-item-search-result" style="color:var(--muted);cursor:default;">No matches</div>`;
        resultsWrap.style.display = '';
        return;
      }
      resultsWrap.innerHTML = matches.map(it => {
        const id = String(it.id || '');
        const name = String(it.name || '').trim() || '(Unnamed)';
        const sku = String(it.sku || '').trim();
        const onHand = formatQty(toInt(it.qty, 0));
        const meta = [sku ? `SKU: ${sku}` : '', `On Hand: ${onHand}`].filter(Boolean).join(' â€¢ ');
        return `<div class="parsed-item-search-result" data-parsed-line-match-item="${escapeHtmlAttr(id)}" data-parsed-line-idx="${idx}">`+
          `<div>`+
            `<div class="parsed-item-search-result-name">${escapeHtml(name)}</div>`+
            `<div class="parsed-item-search-result-meta">${escapeHtml(meta)}</div>`+
          `</div>`+
        `</div>`;
      }).join('');
      resultsWrap.style.display = '';
    }
    function getInventoryBySku(sku){
      const normalized = String(sku || '').trim().toLowerCase();
      if(!normalized) return null;
      return state.items.find(x => x && String(x.sku || '').trim().toLowerCase() === normalized) || null;
    }
    function autoMatchParsedLinesBySku(){
      if(!state._receiveOrder) return;
      const lines = Array.isArray(state._receiveOrder.parsedLineItems) ? state._receiveOrder.parsedLineItems : [];
      let matched = 0;
      lines.forEach((line, idx) => {
        // Skip if already matched
        if(line.item_id) return;
        // Try matching by SKU
        const sku = String(line.sku || '').trim();
        if(!sku) return;
        const item = getInventoryBySku(sku);
        if(item){
          line.item_id = item.id;
          if(typeof line.qty_received === 'undefined' || line.qty_received === null){
            line.qty_received = toInt(line.qty, 0);
          }
          syncParsedLineToReceiveLines(idx);
          matched++;
        }
      });
      return matched;
    }
    function matchParsedLineToInventory(idx, itemId){
      if(!state._receiveOrder) return;
      const lines = Array.isArray(state._receiveOrder.parsedLineItems) ? state._receiveOrder.parsedLineItems : [];
      const line = lines[idx];
      if(!line) return;
      const item = getInventoryById(itemId);
      if(!item) return;
      line.item_id = itemId;
      // Default qty_received to parsed qty if not set
      if(typeof line.qty_received === 'undefined'){
        line.qty_received = toInt(line.qty, 0);
      }
      if(typeof line.qty_rejected === 'undefined'){
        line.qty_rejected = 0;
      }
      syncParsedLineToReceiveLines(idx);
      renderReceiveOrderModal();
    }
    function unmatchParsedLine(idx){
      if(!state._receiveOrder) return;
      const lines = Array.isArray(state._receiveOrder.parsedLineItems) ? state._receiveOrder.parsedLineItems : [];
      const line = lines[idx];
      if(!line) return;
      const oldItemId = line.item_id;
      delete line.item_id;
      delete line.qty_received;
      delete line.qty_rejected;
      delete line.rejection_reason;
      // Remove from ro.lines if present
      if(oldItemId && Array.isArray(state._receiveOrder.lines)){
        state._receiveOrder.lines = state._receiveOrder.lines.filter(l =>
          !(l.key && l.key.startsWith(`parsed-${idx}-`))
        );
      }
      renderReceiveOrderModal();
    }
    function syncParsedLineToReceiveLines(idx){
      if(!state._receiveOrder) return;
      const parsedLines = Array.isArray(state._receiveOrder.parsedLineItems) ? state._receiveOrder.parsedLineItems : [];
      const parsedLine = parsedLines[idx];
      if(!parsedLine || !parsedLine.item_id) return;
      if(!Array.isArray(state._receiveOrder.lines)) state._receiveOrder.lines = [];
      const key = `parsed-${idx}-${parsedLine.item_id}`;
      let existing = state._receiveOrder.lines.find(l => l.key === key);
      const item = getInventoryById(parsedLine.item_id);
      if(!existing){
        existing = {
          key: key,
          item_id: parsedLine.item_id,
          item_name: item ? String(item.name || '').trim() : '',
          item_sku: item ? String(item.sku || '').trim() : '',
          ordered_qty: 0,
          expected_qty: toInt(parsedLine.qty, 0),
          prev_received: 0,
          remaining_qty: null,
          qty_received: toInt(parsedLine.qty_received, 0),
          qty_rejected: toInt(parsedLine.qty_rejected, 0),
          rejection_reason: String(parsedLine.rejection_reason || '').trim(),
          receipt_line_id: '',
          po_line_id: '',
          unit_cost: parsedLine.unit_price !== null ? parsedLine.unit_price : null,
          disabled: false
        };
        state._receiveOrder.lines.push(existing);
      }else{
        existing.qty_received = toInt(parsedLine.qty_received, 0);
        existing.qty_rejected = toInt(parsedLine.qty_rejected, 0);
        existing.rejection_reason = String(parsedLine.rejection_reason || '').trim();
        existing.unit_cost = parsedLine.unit_price !== null ? parsedLine.unit_price : null;
        existing.expected_qty = toInt(parsedLine.qty, 0);
      }
    }
    const receiptUpgradeBtn = document.querySelector('[data-receipt-upgrade]');
    if(receiptUpgradeBtn) receiptUpgradeBtn.addEventListener('click', ()=>{
      if(isEffectiveSuperUser()){
        openSubscriptionManagerModal();
      }else{
        toast('Contact an admin to upgrade.');
      }
    });
	    const receiveForwardingHint = $('receiveForwardingHint');
	    if(receiveForwardingHint && !receiveForwardingHint._wired){
	      receiveForwardingHint._wired = true;
	      receiveForwardingHint.addEventListener('click', (e)=>{
	        const btn = e.target.closest('[data-dismiss-receive-forward-hint]');
	        if(!btn) return;
	        dismissReceiveForwardingHint();
	        renderReceiveForwardingHint();
	      });
	    }
      const receiveTabs = $('receiveTabs');
      if(receiveTabs && !receiveTabs._wired){
        receiveTabs._wired = true;
        receiveTabs.addEventListener('click', (e)=>{
          const btn = e.target.closest('[data-receive-tab]');
          if(!btn) return;
          const tab = String(btn.dataset.receiveTab || '').trim();
          if(tab) void handleReceiveTabClick(tab);
        });
      }
      const btnReceiveScannedBack = $('btnReceiveScannedBack');
      if(btnReceiveScannedBack && !btnReceiveScannedBack._wired){
        btnReceiveScannedBack._wired = true;
        btnReceiveScannedBack.addEventListener('click', ()=>{
          openReceiveInboxModal();
        });
      }
      const receivePoLinkAction = $('receivePoLinkAction');
      if(receivePoLinkAction && !receivePoLinkAction._wired){
        receivePoLinkAction._wired = true;
        receivePoLinkAction.addEventListener('click', ()=>{
          if(receivePoLinkAction.disabled) return;
          void handleReceiveTabClick('po');
        });
      }
      const receivePoList = $('receivePoList');
      if(receivePoList && !receivePoList._wired){
        receivePoList._wired = true;
        receivePoList.addEventListener('click', (e)=>{
          const card = e.target.closest('[data-receive-po-id]');
          if(!card) return;
          const id = String(card.getAttribute('data-receive-po-id') || '').trim();
          if(!id) return;
          void openReceiveOrderModal(id);
        });
      }
	    const receiveOrderLines = $('receiveOrderLines');
	    if(receiveOrderLines){
	      receiveOrderLines.addEventListener('input', (e)=>{
	        const inp = e.target.closest('[data-receive-line-key]');
	        if(!inp) return;
	        updateReceiveLineFromInput(inp, { format:false });
	      });
	      receiveOrderLines.addEventListener('change', (e)=>{
	        const inp = e.target.closest('[data-receive-line-key]');
	        if(!inp) return;
	        updateReceiveLineFromInput(inp, { format:true, showError:true });
	      });
	      // Stepper button handlers
	      receiveOrderLines.addEventListener('click', (e)=>{
	        // Handle stepper inc/dec buttons
	        const stepperBtn = e.target.closest('[data-receive-stepper]');
	        if(stepperBtn && !stepperBtn.disabled){
	          const action = stepperBtn.dataset.receiveStepper;
	          const lineKey = stepperBtn.dataset.receiveLineKey;
	          const field = stepperBtn.dataset.receiveField;
	          if(!lineKey || !field) return;
	          const input = receiveOrderLines.querySelector(`input.qty-stepper-input[data-receive-line-key="${lineKey}"][data-receive-field="${field}"]`);
	          if(!input || input.disabled) return;
	          let currentVal = toInt(input.value, 0);
	          if(action === 'inc'){
	            currentVal++;
	          }else if(action === 'dec' && currentVal > 0){
	            currentVal--;
	          }
	          input.value = currentVal;
	          input.dispatchEvent(new Event('input', { bubbles:true }));
	          input.dispatchEvent(new Event('change', { bubbles:true }));
	          return;
	        }
	        // Handle "Receive All" button
	        const receiveAllBtn = e.target.closest('[data-receive-all]');
	        if(receiveAllBtn && !receiveAllBtn.disabled){
	          const lineKey = receiveAllBtn.dataset.receiveLineKey;
	          const remaining = toInt(receiveAllBtn.dataset.receiveAll, 0);
	          if(!lineKey) return;
	          const input = receiveOrderLines.querySelector(`input.qty-stepper-input[data-receive-line-key="${lineKey}"][data-receive-field="received"]`);
	          if(!input || input.disabled) return;
	          input.value = remaining;
	          input.dispatchEvent(new Event('input', { bubbles:true }));
	          input.dispatchEvent(new Event('change', { bubbles:true }));
	        }
	      });
	    }
	    const receiveManualSearch = $('receiveManualSearch');
	    if(receiveManualSearch){
	      updateReceiveManualClearBtn();
	      receiveManualSearch.addEventListener('input', ()=>{
	        if(state._receiveOrder) state._receiveOrder.manualSearch = receiveManualSearch.value || '';
	        renderReceiveManualResults();
	        updateReceiveManualClearBtn();
	      });
	      receiveManualSearch.addEventListener('keydown', (e)=>{
	        if(e.key === 'Escape' && receiveManualSearch.value){
	          e.preventDefault();
	          receiveManualSearch.value = '';
	          if(state._receiveOrder) state._receiveOrder.manualSearch = '';
	          renderReceiveManualResults();
	          updateReceiveManualClearBtn();
	        }
	      });
	    }
	    const btnReceiveManualClear = $('btnReceiveManualClear');
	    if(btnReceiveManualClear && receiveManualSearch){
	      btnReceiveManualClear.addEventListener('click', ()=>{
	        if(!receiveManualSearch.value) return;
	        receiveManualSearch.value = '';
	        if(state._receiveOrder) state._receiveOrder.manualSearch = '';
	        renderReceiveManualResults();
	        updateReceiveManualClearBtn();
	        try{ receiveManualSearch.focus(); }catch(e){}
	      });
	    }
	    const receiveManualResults = $('receiveManualResults');
	    if(receiveManualResults) receiveManualResults.addEventListener('click', (e)=>{
	      const btn = e.target.closest('button[data-receive-add-item-id]');
	      if(!btn) return;
	      const id = String(btn.dataset.receiveAddItemId || '').trim();
	      if(!id) return;
	      void addManualReceiveLine(id);
	    });
    const receiveDraftInbox = $('receiveDraftInbox');
    if(receiveDraftInbox){
      receiveDraftInbox.addEventListener('change', (e)=>{
        const selectAll = e.target && e.target.closest ? e.target.closest('#receiveDraftSelectAll') : null;
        if(selectAll){
          const rows = Array.isArray(state._draftEmailReceipts) ? state._draftEmailReceipts : [];
          const selected = state._receiveDraftSelected || new Set();
          if(selectAll.checked){
            rows.forEach(row => {
              const id = String((row && (row.id || row.receipt_id)) || '').trim();
              if(!id) return;
              if(canDeleteReceiptRow(row && row.status)) selected.add(id);
            });
          }else{
            rows.forEach(row => {
              const id = String((row && (row.id || row.receipt_id)) || '').trim();
              if(!id) return;
              selected.delete(id);
            });
          }
          state._receiveDraftSelected = selected;
          renderReceiveDraftInbox();
          return;
        }
        const input = e.target && e.target.closest ? e.target.closest('input[data-receipt-select]') : null;
        if(!input) return;
        const id = input.getAttribute('data-receipt-select');
        setReceiveDraftSelected(id, input.checked);
        renderReceiveDraftInbox();
      });
      receiveDraftInbox.addEventListener('click', (e)=>{
        const deleteBtn = e.target.closest('#btnReceiveDraftDelete');
        if(deleteBtn){
          void deleteSelectedDraftReceipts();
          return;
        }
        if(e.target.closest('.receive-draft-select') || e.target.closest('.receive-draft-select-all')) return;
        const target = e.target.closest('[data-receipt-review-id]');
        if(!target) return;
        const id = String(target.getAttribute('data-receipt-review-id') || '').trim();
        if(!id) return;
        const companyId = String(target.getAttribute('data-receipt-company-id') || '').trim()
          || String((target.closest('[data-receipt-company-id]') || {}).getAttribute?.('data-receipt-company-id') || '').trim();
        void openReceiveDraftReceipt(id, companyId);
      });
    }
	    const receiveOrderReceipts = $('receiveOrderReceipts');
	    if(receiveOrderReceipts) receiveOrderReceipts.addEventListener('click', (e)=>{
	      const btn = e.target.closest('button[data-void-receipt-id]');
	      if(!btn) return;
	      const id = String(btn.dataset.voidReceiptId || '').trim();
	      if(!id) return;
	      void handleVoidReceipt(id, btn);
	    });
    const receiveReceiptAttachmentsList = $('receiveReceiptAttachmentsList');
    if(receiveReceiptAttachmentsList) receiveReceiptAttachmentsList.addEventListener('click', (e)=>{
      const downloadBtn = e.target.closest('[data-receipt-attachment-download]');
      if(downloadBtn){
        const id = String(downloadBtn.getAttribute('data-receipt-attachment-download') || '').trim();
        if(id) void handleReceiptAttachmentDownload(id);
        return;
      }
      const deleteBtn = e.target.closest('[data-receipt-attachment-delete]');
      if(deleteBtn){
        const id = String(deleteBtn.getAttribute('data-receipt-attachment-delete') || '').trim();
        if(id) void handleReceiptAttachmentDelete(id);
      }
    });

    const btnShippingAddressClose = $('btnShippingAddressClose');
    if(btnShippingAddressClose) btnShippingAddressClose.addEventListener('click', closeShippingAddressModal);
    const btnShippingAddressNew = $('btnShippingAddressNew');
    if(btnShippingAddressNew) btnShippingAddressNew.addEventListener('click', clearShippingAddressForm);
    const btnShippingAddressSave = $('btnShippingAddressSave');
    if(btnShippingAddressSave) btnShippingAddressSave.addEventListener('click', async ()=>{
      setShippingAddressMessage('');
      try{
        await saveShippingAddress();
        toast('Shipping address saved', 'success');
      }catch(e){
        setShippingAddressMessage(e && e.message ? e.message : 'Save failed');
      }
    });
    const shippingAddressList = $('shippingAddressList');
    if(shippingAddressList) shippingAddressList.addEventListener('click', async (e)=>{
      const editBtn = e.target.closest('[data-shipping-edit]');
      const delBtn = e.target.closest('[data-shipping-delete]');
      if(editBtn){
        const id = String(editBtn.getAttribute('data-shipping-edit') || '').trim();
        const row = state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
          ? state._shippingAddressById.get(id)
          : null;
        if(!row) return;
        state._shippingAddressEditing = id;
        const label = $('shippingAddressLabel'); if(label) label.value = row.label || '';
        const address = $('shippingAddressValue'); if(address) address.value = row.address || '';
        const isDefault = $('shippingAddressDefault'); if(isDefault) isDefault.checked = !!row.is_default;
        const title = $('shippingAddressFormTitle'); if(title) title.textContent = 'Edit Shipping Address';
        return;
      }
      if(delBtn){
        const id = String(delBtn.getAttribute('data-shipping-delete') || '').trim();
        if(!id) return;
        const ok = await openConfirmModal('Delete address?', 'Delete this shipping address?', { okText:'Delete', cancelText:'Cancel' });
        if(!ok) return;
        try{
          await deleteShippingAddress(id);
          toast('Shipping address deleted', 'success');
        }catch(e){
          toast(e && e.message ? e.message : 'Delete failed');
        }
      }
    });
    const btnCompanyLocationsClose = $('btnCompanyLocationsClose');
    if(btnCompanyLocationsClose) btnCompanyLocationsClose.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      void closeCompanyLocationsModal();
    });
    const btnCompanyLocationNew = $('btnCompanyLocationNew');
    if(btnCompanyLocationNew) btnCompanyLocationNew.addEventListener('click', ()=>{
      if(!canManageCompanyLocations()){
        toast('Location permissions required');
        return;
      }
      clearCompanyLocationForm();
      openCompanyLocationEditor();
    });
    const btnCompanyLocationSave = $('btnCompanyLocationSave');
    if(btnCompanyLocationSave) btnCompanyLocationSave.addEventListener('click', saveCompanyLocation);
    const btnCompanyLocationCancel = $('btnCompanyLocationCancel');
    if(btnCompanyLocationCancel) btnCompanyLocationCancel.addEventListener('click', closeCompanyLocationEditor);
    function setLocationActionBusy(btn, isBusy, fallbackLabel){
      if(!btn) return;
      if(isBusy){
        btn.disabled = true;
        btn.setAttribute('data-loading', 'true');
        btn.setAttribute('aria-busy', 'true');
        if(!btn.querySelector('svg') && fallbackLabel){
          if(!btn.dataset.label) btn.dataset.label = btn.textContent;
          btn.textContent = fallbackLabel;
        }
        return;
      }
      btn.disabled = false;
      btn.removeAttribute('data-loading');
      btn.removeAttribute('aria-busy');
      if(btn.dataset.label){
        btn.textContent = btn.dataset.label;
        delete btn.dataset.label;
      }
    }
    async function handleLocationListClick(e){
      const editBtn = e.target.closest('[data-location-edit]');
      if(editBtn){
        const id = String(editBtn.getAttribute('data-location-edit') || '').trim();
        if(!id) return;
        openCompanyLocationEditor(id);
        return;
      }
      const defaultBtn = e.target.closest('[data-location-default]');
      if(defaultBtn){
        const id = String(defaultBtn.getAttribute('data-location-default') || '').trim();
        const type = String(defaultBtn.getAttribute('data-default-type') || '').trim();
        if(!id || !type) return;
        setLocationActionBusy(defaultBtn, true, 'Saving...');
        setCompanyLocationsMessage('');
        try{
          await setDefaultCompanyLocation(id, type);
          toast('Default updated', 'success');
        }catch(err){
          setCompanyLocationsMessage(err && err.message ? err.message : 'Default update failed');
        }finally{
          setLocationActionBusy(defaultBtn, false);
        }
        return;
      }
      const archiveBtn = e.target.closest('[data-location-archive]');
      if(archiveBtn){
        const id = String(archiveBtn.getAttribute('data-location-archive') || '').trim();
        if(!id) return;
        setLocationActionBusy(archiveBtn, true, 'Archiving...');
        setCompanyLocationsMessage('');
        try{
          await archiveCompanyLocation(id);
        }catch(err){
          setCompanyLocationsMessage(err && err.message ? err.message : 'Archive failed');
        }finally{
          setLocationActionBusy(archiveBtn, false);
        }
        return;
      }
      const restoreBtn = e.target.closest('[data-location-restore]');
      if(restoreBtn){
        const id = String(restoreBtn.getAttribute('data-location-restore') || '').trim();
        if(!id) return;
        setLocationActionBusy(restoreBtn, true, 'Restoring...');
        setCompanyLocationsMessage('');
        try{
          await restoreCompanyLocation(id);
        }catch(err){
          setCompanyLocationsMessage(err && err.message ? err.message : 'Restore failed');
        }finally{
          setLocationActionBusy(restoreBtn, false);
        }
      }
    }
    const companyLocationsList = $('companyLocationsList');
    if(companyLocationsList) companyLocationsList.addEventListener('click', handleLocationListClick);
    // Super user company selector event handlers
    const locationsCompanySearch = $('locationsCompanySearch');
    if(locationsCompanySearch){
      let searchTimeout;
      locationsCompanySearch.addEventListener('input', ()=>{
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(()=>{
          state._locationsCompanySearch = locationsCompanySearch.value;
          loadLocationsCompanies().catch(e => console.error('Company search error:', e));
        }, 300);
      });
    }
    const locationsCompanyList = $('locationsCompanyList');
    if(locationsCompanyList){
      locationsCompanyList.addEventListener('click', (e)=>{
        const item = e.target.closest('[data-locations-select-company]');
        if(!item) return;
        const companyId = item.getAttribute('data-locations-select-company');
        const name = item.querySelector('.locations-company-name')?.textContent || '';
        selectLocationsCompany(companyId, name);
      });
    }
    const btnLocationsClearCompany = $('btnLocationsClearCompany');
    if(btnLocationsClearCompany){
      btnLocationsClearCompany.addEventListener('click', ()=>{
        setCompanyLocationsContext(null);
        showLocationsCompanySelector(true);
        const searchInput = $('locationsCompanySearch');
        if(searchInput) searchInput.value = '';
        state._locationsCompanySearch = '';
        loadLocationsCompanies().catch(e => console.error('Failed to reload companies:', e));
      });
    }

	    const orderHistoryFilter = $('orderHistoryFilter');
	    if(orderHistoryFilter){
	      updateOrderHistoryFilterClearBtn();
	      orderHistoryFilter.addEventListener('input', ()=>{
	        state._orderHistoryFilter = orderHistoryFilter.value || '';
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	      });
	      orderHistoryFilter.addEventListener('keydown', (e)=>{
	        if(e.key==='Escape' && orderHistoryFilter.value){
	          e.preventDefault();
	          orderHistoryFilter.value = '';
	          state._orderHistoryFilter = '';
	          renderOrderHistoryFiltered();
	          updateOrderHistoryFilterClearBtn();
	        }
	      });
	    }
	    const orderHistoryTabs = $('orderHistoryTabs');
	    if(orderHistoryTabs) orderHistoryTabs.addEventListener('click', (e)=>{
	      const btn = e.target.closest('[data-order-history-tab]');
	      if(!btn) return;
	      const tab = btn.getAttribute('data-order-history-tab');
	      void handleOrderHistoryTabClick(tab);
	    });
	    const orderHistoryReceiptFilter = $('orderHistoryReceiptFilter');
	    if(orderHistoryReceiptFilter){
	      orderHistoryReceiptFilter.addEventListener('input', ()=>{
	        state._orderHistoryReceiptsFilter = orderHistoryReceiptFilter.value || '';
	        renderOrderHistoryReceiptsFiltered();
	      });
	      orderHistoryReceiptFilter.addEventListener('keydown', (e)=>{
	        if(e.key==='Escape' && orderHistoryReceiptFilter.value){
	          e.preventDefault();
	          orderHistoryReceiptFilter.value = '';
	          state._orderHistoryReceiptsFilter = '';
	          renderOrderHistoryReceiptsFiltered();
	        }
	      });
	    }
	    const btnClearOrderHistoryFilter = $('btnClearOrderHistoryFilter');
	    if(btnClearOrderHistoryFilter && orderHistoryFilter){
	      btnClearOrderHistoryFilter.addEventListener('click', ()=>{
	        const hasText = !!orderHistoryFilter.value;
	        const hasStatus = Array.isArray(state._orderHistoryStatusFilter) && state._orderHistoryStatusFilter.length > 0;
	        if(!hasText && !hasStatus) return;
	        orderHistoryFilter.value = '';
	        state._orderHistoryFilter = '';
	        state._orderHistoryStatusFilter = [];
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	        try{ orderHistoryFilter.focus(); }catch(e){}
	      });
	    }
	    const btnOrderCancel = $('btnOrderCancel');
	    if(btnOrderCancel) btnOrderCancel.addEventListener('click', ()=> show('orderModal', false));

    // Order Wizard navigation
    const btnOrderWizNext = $('btnOrderWizNext');
    if(btnOrderWizNext) btnOrderWizNext.addEventListener('click', orderWizardNext);

    const btnOrderWizPrev = $('btnOrderWizPrev');
    if(btnOrderWizPrev) btnOrderWizPrev.addEventListener('click', orderWizardPrev);

    // Allow clicking on stepper steps to navigate (only to completed or current step)
    const wizardSteps = document.querySelectorAll('.order-wizard-step[data-step]');
    wizardSteps.forEach(stepEl => {
      stepEl.addEventListener('click', ()=>{
        const targetStep = parseInt(stepEl.dataset.step, 10);
        if(isNaN(targetStep)) return;
        // Can only go back or stay, not skip ahead
        if(targetStep <= _orderWizardStep){
          orderWizardGoTo(targetStep);
        }
      });
    });

    const btnResetOrderList = $('btnResetOrderList');
    if(btnResetOrderList) btnResetOrderList.addEventListener('click', ()=> {
      clearAllOrderLines();
      renderOrderLines();
      toast('Order list cleared');
    });
    const orderBlockerBannerDismiss = $('orderBlockerBannerDismiss');
    if(orderBlockerBannerDismiss) orderBlockerBannerDismiss.addEventListener('click', ()=>{
      const ord = orderState();
      ord.blockerBannerDismissed = true;
      updateOrderBlockerBanner();
    });
    const orderDraftSelect = $('orderDraftSelect');
    if(orderDraftSelect) orderDraftSelect.addEventListener('change', ()=>{
      setActiveOrderDraft(orderDraftSelect.value);
    });
    const btnOrderCopy = $('btnOrderCopy');
    if(btnOrderCopy) btnOrderCopy.addEventListener('click', copyOrderToClipboard);
    const btnOrderSubmit = $('btnOrderSubmit');
    if(btnOrderSubmit) btnOrderSubmit.addEventListener('click', async ()=>{
      const url = buildMailtoUrl();
      if(!url){ toast('Add at least 1 item and an email'); return; }
      if(!requirePermission(PERMISSIONS.ORDERS_CREATE, 'Order creation not allowed')) return;

      const btn = $('btnOrderSubmit');
      const priorText = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Submittingâ€¦'; }

	      try{
	        const sendRes = await sendOrderViaApi();
	        let historySaved = false;
	        try{
	          const ord = orderState();
	          await sbRecordOrderRecipient(ord.email, ord.contactName);
	        }catch{}
	        try{
	          await sbInsertOrderHistory(sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes);
	          historySaved = true;
	        }catch(historyErr){
	          console.error('Order history save failed:', historyErr);
	        }
	        toast(historySaved ? 'Order sent' : 'Order sent (history not saved - check console)');
	        try{
	          clearAllOrderLines();
	          renderOrderResults();
	          renderOrderLines();
	          resetOrderIdentifiers();
	          const companyPo = $('orderCompanyPoNumber'); if(companyPo) companyPo.value = '';
	          const internalPo = $('orderInternalPoNumber'); if(internalPo) internalPo.value = orderState().internalPoNumber || '';
	        }catch(e){}
	        show('orderModal', false);
        scheduleMenuActionBadgeRefresh({ force: true });
	      }catch(e){
	        const msg = e && e.message ? e.message : 'Send failed';
	        const fallback = await openConfirmModal('Send failed', `${msg}\n\nOpen your email app instead?`, { okText:'Open Email', cancelText:'Cancel' });
	        if(fallback){ window.location.href = url; }
	        else { toast(msg); }
	      }finally{
	        if(btn){ btn.textContent = priorText || 'Submit Order'; }
        renderOrderPreview();
      }
    });

    const orderShortfallAttachToggle = $('orderShortfallAttachToggle');
    if(orderShortfallAttachToggle){
      orderShortfallAttachToggle.addEventListener('change', ()=>{
        const ord = orderState();
        ord.shortfallAttached = !!orderShortfallAttachToggle.checked;
        updateOrderWizardReviewSummary();
      });
    }

    const orderSearch = $('orderSearch');
    if(orderSearch){
      updateOrderSearchClearBtn();
      orderSearch.addEventListener('input', ()=>{
        const ord = orderState();
        ord.search = orderSearch.value || '';
        renderOrderResults();
        updateOrderSearchClearBtn();
      });
      orderSearch.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && orderSearch.value){
          e.preventDefault();
          orderSearch.value = '';
          const ord = orderState();
          ord.search = '';
          renderOrderResults();
          updateOrderSearchClearBtn();
        }
      });
    }
    const btnClearOrderSearch = $('btnClearOrderSearch');
    if(btnClearOrderSearch && orderSearch){
      btnClearOrderSearch.addEventListener('click', ()=>{
        if(!orderSearch.value) return;
        orderSearch.value = '';
        const ord = orderState();
        ord.search = '';
        renderOrderResults();
        updateOrderSearchClearBtn();
        try{ orderSearch.focus(); }catch(e){}
      });
    }
	    const orderEmail = $('orderEmail');
	    if(orderEmail) orderEmail.addEventListener('input', ()=>{
	      const ord = orderState();
	      ord.email = orderEmail.value || '';
	      renderOrderPreview();
	      requestOrderEmailSuggestions(ord.email);
	      try{ orderWizardUpdateUI(); }catch(e){}
	    });
	    if(orderEmail) orderEmail.addEventListener('focus', ()=> requestOrderEmailSuggestions(orderEmail.value || ''));
	    if(orderEmail) orderEmail.addEventListener('blur', ()=>{
	      // Defer so clicks on suggestions can still be handled.
	      setTimeout(()=>{
	        const wrap = $('orderEmailSuggest');
	        if(!wrap || !wrap.classList.contains('has-suggest')) return;
	        const ae = document.activeElement;
	        if(ae && wrap.contains(ae)) return;
	        hideOrderEmailSuggestions();
	      }, 0);
	    });
	    const orderCompanyPoNumber = $('orderCompanyPoNumber');
	    if(orderCompanyPoNumber) orderCompanyPoNumber.addEventListener('input', ()=>{
	      const ord = orderState();
	      ord.companyPoNumber = orderCompanyPoNumber.value || '';
	      ord.subject = composeOrderSubject(ord);
	      renderOrderPreview();
	    });
	    const orderShippingAddress = $('orderShippingAddress');
	    if(orderShippingAddress) orderShippingAddress.addEventListener('change', ()=>{
	      const ord = orderState();
	      const selected = String(orderShippingAddress.value || '').trim();
	      ord.shippingAddressId = selected;
	      const row = (state._orderShippingById && typeof state._orderShippingById.get === 'function'
	        ? state._orderShippingById.get(selected)
	        : null)
	        || (state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
	          ? state._shippingAddressById.get(selected)
	          : null);
	      ord.shippingAddressSnapshot = row ? { label: row.label, address: row.address } : null;
	      renderOrderPreview();
	      try{ updateOrderWizardShippingPreview(); }catch(e){}
	    });
      const orderShippingOptions = $('orderShippingOptions');
      if(orderShippingOptions) orderShippingOptions.addEventListener('click', (e)=>{
        const option = e.target.closest('[data-order-shipping-id]');
        if(!option) return;
        const id = String(option.getAttribute('data-order-shipping-id') || '').trim();
        if(!id) return;
        const select = $('orderShippingAddress');
        if(select){
          select.value = id;
          select.dispatchEvent(new Event('change', { bubbles:true }));
        }else{
          const ord = orderState();
          ord.shippingAddressId = id;
          const row = (state._orderShippingById && typeof state._orderShippingById.get === 'function')
            ? state._orderShippingById.get(id)
            : null;
          ord.shippingAddressSnapshot = row ? { label: row.label, address: row.address } : null;
          renderOrderPreview();
          renderOrderShippingOptionsList();
        }
      });
	    const btnOrderShippingManage = $('btnOrderShippingManage');
	    if(btnOrderShippingManage) btnOrderShippingManage.addEventListener('click', openCompanyLocationsModal);
    const orderNotes = $('orderNotes');
    if(orderNotes) orderNotes.addEventListener('input', ()=>{
      const ord = orderState();
      ord.notes = orderNotes.value || '';
      renderOrderPreview();
    });

	    const orderResultsBody = $('orderResultsBody');
	    if(orderResultsBody) orderResultsBody.addEventListener('click', async (e)=>{
	      const val = e.target.closest('.qty-stepper-val');
	      if(val){
	        const stepper = val.closest('.qty-stepper');
	        if(!stepper) return;
	        const id = String(
	          stepper.querySelector('button[data-stepper-inc]')?.getAttribute('data-stepper-inc')
	          || stepper.querySelector('button[data-stepper-dec]')?.getAttribute('data-stepper-dec')
	          || ''
	        ).trim();
	        if(!id) return;
	        const it = getInventoryById(id);
	        if(!it) return;
	        const currentQty = getOrderQtyForItem(id);
	        const name = String(it.name || '').trim();
	        const next = await openQtyEntryModal('Order Qty', name || 'Order Qty', currentQty, { min:0, okText:'Set', cancelText:'Cancel' });
	        if(next === null || typeof next === 'undefined') return;
	        const desiredQty = Math.max(0, toInt(next, currentQty));
	        if(desiredQty === currentQty) return;
	        if(desiredQty <= 0){
	          if(currentQty > 0) removeOrderLine(id);
	        }else{
	          if(currentQty === 0) upsertOrderLineFromItem(it, desiredQty);
	          else setOrderQty(id, desiredQty, { manual:true });
	        }
	        renderOrderResults();
	        renderOrderLines();
	        return;
	      }
	      const incBtn = e.target.closest('button[data-stepper-inc]');
	      const decBtn = e.target.closest('button[data-stepper-dec]');
	      if(incBtn){
	        const id = incBtn.getAttribute('data-stepper-inc');
	        const it = getInventoryById(id);
        if(!it) return;
        const currentQty = getOrderQtyForItem(id);
        if(currentQty === 0){
          upsertOrderLineFromItem(it, 1);
        } else {
          setOrderQty(id, currentQty + 1, { manual:true });
        }
        renderOrderResults();
        renderOrderLines();
      } else if(decBtn){
        const id = decBtn.getAttribute('data-stepper-dec');
        const currentQty = getOrderQtyForItem(id);
        if(currentQty <= 1){
          removeOrderLine(id);
        } else {
          setOrderQty(id, currentQty - 1, { manual:true });
        }
        renderOrderResults();
        renderOrderLines();
      }
    });

	    const orderEmailSuggest = $('orderEmailSuggest');
	    if(orderEmailSuggest) orderEmailSuggest.addEventListener('click', (e)=>{
	      const btn = e.target.closest('button[data-suggest-email]');
	      if(!btn) return;
	      const email = String(btn.dataset.suggestEmail || '').trim();
      if(!email) return;
      const ord = orderState();
      ord.email = email;
      const inp = $('orderEmail'); if(inp) inp.value = email;
	      renderOrderPreview();
	      hideOrderEmailSuggestions();
	    });
	    if(orderEmailSuggest) orderEmailSuggest.addEventListener('mouseleave', (e)=>{
	      // Only close when the mouse leaves below the last entry (not when moving back to the input).
	      try{
	        const rect = orderEmailSuggest.getBoundingClientRect();
	        if(e && typeof e.clientY === 'number' && e.clientY >= rect.bottom - 1){
	          hideOrderEmailSuggestions();
	        }
	      }catch(e){}
	    });
	    document.addEventListener('pointerdown', (e)=>{
	      const wrap = $('orderEmailSuggest');
	      if(!wrap || !wrap.classList.contains('has-suggest')) return;
	      const inp = $('orderEmail');
	      const t = e && e.target ? e.target : null;
	      if(t && wrap.contains(t)) return;
	      if(inp && (t === inp || (t && inp.contains(t)))) return;
	      hideOrderEmailSuggestions();
	    });

    const orderHistoryList = $('orderHistoryList');
    if(orderHistoryList) orderHistoryList.addEventListener('input', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      if(btn) btn.disabled = !looksLikeEmailAddress(inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('focusin', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('click', async (e)=>{
      const recvBtn = e.target.closest('button[data-receive-order-id]');
      if(recvBtn){
        e.preventDefault();
        e.stopPropagation();
        const id = String(recvBtn.dataset.receiveOrderId || '').trim();
        if(!id) return;
        void handleOrderReceiptButtonClick(id, recvBtn);
        return;
      }
      // Delete order button
      const delBtn = e.target.closest('button[data-delete-order-id]');
	      if(delBtn){
	        e.preventDefault();
		        e.stopPropagation();
		        const id = String(delBtn.dataset.deleteOrderId || '').trim();
		        if(!id) return;
		        await deleteOrderFromHistory(id, delBtn);
	        return;
	      }
      const sugBtn = e.target.closest('button[data-forward-suggest-email]');
      if(sugBtn){
        const email = String(sugBtn.dataset.forwardSuggestEmail || '').trim();
        const wrap = sugBtn.closest('[data-forward-suggest-id]');
        const id = wrap ? String(wrap.dataset.forwardSuggestId || '').trim() : '';
        if(id && email){
          const inp = document.querySelector(`input[data-forward-email-id="${id}"]`);
          if(inp) inp.value = email;
          const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
          if(btn) btn.disabled = false;
          renderForwardEmailSuggestions(id, []);
        }
        return;
      }
      const fwdBtn = e.target.closest('button[data-forward-send-id]');
      if(fwdBtn){
        const id = String(fwdBtn.dataset.forwardSendId || '').trim();
        if(!id) return;
        void forwardOrderFromHistory(id);
      }
      const toggle = e.target.closest('[data-order-history-toggle]');
      if(toggle){
        const id = String(toggle.getAttribute('data-order-history-toggle') || '').trim();
        if(!id) return;
        const expanded = state._orderHistoryExpanded || new Set();
        const isExpanded = expanded.has(id);
        if(isExpanded){
          expanded.delete(id);
        }else{
          expanded.add(id);
        }
        state._orderHistoryExpanded = expanded;
        const card = toggle.closest('.po-card');
        if(card) card.classList.toggle('is-expanded', !isExpanded);
        return;
      }
    });
    const orderHistoryReceiptsList = $('orderHistoryReceiptsList');
    if(orderHistoryReceiptsList){
      orderHistoryReceiptsList.addEventListener('click', (e)=>{
        const card = e.target.closest('[data-receipt-review-id]');
        if(!card) return;
        const id = String(card.getAttribute('data-receipt-review-id') || '').trim();
        if(!id) return;
        const companyId = String(card.getAttribute('data-receipt-company-id') || '').trim();
        void openReceiveDraftReceipt(id, companyId);
      });
    }

	    const orderLinesBody = $('orderLinesBody');
	    if(orderLinesBody) orderLinesBody.addEventListener('click', async (e)=>{
	      // Remove button
	      const removeBtn = e.target.closest('button[data-remove-order-id]');
	      if(removeBtn){
	        removeOrderLine(removeBtn.getAttribute('data-remove-order-id'));
	        renderOrderResults();
	        renderOrderLines();
	        return;
	      }

	      // Stepper increment
	      const incBtn = e.target.closest('button[data-line-inc]');
	      if(incBtn){
	        const id = incBtn.getAttribute('data-line-inc');
	        const ord = orderState();
	        const selectedIds = orderLineSelectedIds().filter(selId =>
	          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
	        );
	        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
	        if(isBatch){
	          for(const selId of selectedIds){
	            const currentQty = getOrderQtyForItem(selId);
	            setOrderQty(selId, currentQty + 1, { manual:true });
	          }
	        } else {
	          const currentQty = getOrderQtyForItem(id);
	          setOrderQty(id, currentQty + 1, { manual:true });
	        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
      // Stepper decrement
      const decBtn = e.target.closest('button[data-line-dec]');
      if(decBtn){
        const id = decBtn.getAttribute('data-line-dec');
        const ord = orderState();
        const selectedIds = orderLineSelectedIds().filter(selId =>
          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
        );
        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
        if(isBatch){
          for(const selId of selectedIds){
            const currentQty = getOrderQtyForItem(selId);
            if(currentQty <= 1){
              removeOrderLine(selId);
            } else {
	            setOrderQty(selId, currentQty - 1, { manual:true });
            }
          }
        } else {
          const currentQty = getOrderQtyForItem(id);
          if(currentQty <= 1){
            removeOrderLine(id);
          } else {
            setOrderQty(id, currentQty - 1, { manual:true });
          }
        }
        renderOrderResults();
        renderOrderLines();
        return;
      }

      const toggleEl = e.target.closest('[data-order-line-toggle]');
      if(toggleEl){
        if(e.target.closest('.order-cart-item-stepper') || e.target.closest('.qty-stepper-input')) return;
        const id = String(toggleEl.dataset.orderLineToggle || '').trim();
        if(!id) return;
        toggleOrderLineExpanded(id);
        return;
      }
    });
    if(orderLinesBody) orderLinesBody.addEventListener('change', (e)=>{
      const toggle = e.target.closest('[data-order-reorder-toggle]');
      if(toggle){
        const id = String(toggle.dataset.orderReorderToggle || '').trim();
        if(!id) return;
        const ord = orderState();
        const line = ord.lines.find(l => String(l && l.id ? l.id : '').trim() === id);
        if(!line) return;
        line.includeReorder = !!toggle.checked;
        line._manualQty = false;
        const rec = getOrderRecommendationForItem(id);
        const nextQty = line.includeReorder ? rec.recommended : rec.jobRequired;
        setOrderQty(id, nextQty, { auto:true });
        renderOrderResults();
        renderOrderLines();
        return;
      }
      const cb = e.target.closest('.order-line-select');
      if(cb){
        const id = String(cb.dataset.orderSelectId || '').trim();
        if(!id) return;
        setOrderLineSelected(id, cb.checked);
        return;
      }
      // Handle inline qty input change
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput){
        const id = String(qtyInput.dataset.lineQtyInput || '').trim();
        if(!id) return;
        const currentQty = getOrderQtyForItem(id);
        const newQty = Math.max(0, toInt(qtyInput.value, currentQty));
        if(newQty === currentQty) return;
        const ord = orderState();
        const selectedIds = orderLineSelectedIds().filter(selId =>
          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
        );
        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
        if(isBatch){
          for(const selId of selectedIds){
            if(newQty <= 0) removeOrderLine(selId);
            else setOrderQty(selId, newQty, { manual:true });
          }
        } else {
          if(newQty <= 0){
            removeOrderLine(id);
          } else {
            setOrderQty(id, newQty, { manual:true });
          }
        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
    });
    // Handle Enter key on qty input
    if(orderLinesBody) orderLinesBody.addEventListener('keydown', (e)=>{
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput && e.key === 'Enter'){
        e.preventDefault();
        qtyInput.blur();
      }
    });
    // Select all text on focus for easier editing
    if(orderLinesBody) orderLinesBody.addEventListener('focus', (e)=>{
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput){
        setTimeout(()=> qtyInput.select(), 0);
      }
    }, true);
    // Handle blur explicitly for mobile browsers
    if(orderLinesBody) orderLinesBody.addEventListener('blur', (e)=>{
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput){
        const id = String(qtyInput.dataset.lineQtyInput || '').trim();
        if(!id) return;
        const currentQty = getOrderQtyForItem(id);
        const newQty = Math.max(0, toInt(qtyInput.value, currentQty));
        if(newQty === currentQty) return;
        const ord = orderState();
        const selectedIds = orderLineSelectedIds().filter(selId =>
          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
        );
        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
        if(isBatch){
          for(const selId of selectedIds){
            if(newQty <= 0) removeOrderLine(selId);
            else setOrderQty(selId, newQty, { manual:true });
          }
        } else {
          if(newQty <= 0){
            removeOrderLine(id);
          } else {
            setOrderQty(id, newQty, { manual:true });
          }
        }
        renderOrderResults();
        renderOrderLines();
      }
    }, true);

    // Add-one modal
    $('menuAddOne').addEventListener('click', ()=>{
      toggleMenu(false);
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_CREATE, 'Create permission required')) return;
      show('addOneModal', true);
      $('addName').focus();
    });
    $('btnAddCancel').addEventListener('click', ()=> show('addOneModal', false));
    $('btnAddSave').addEventListener('click', saveAddOne);
    $('addQty').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); saveAddOne(); }});
    $('addQty').addEventListener('focus', e=>{ setTimeout(()=> e.target.select(), 0); });
    $('addQtyInc').addEventListener('click', ()=>{
      const inp = $('addQty');
      inp.value = Math.max(1, toInt(inp.value, 1) + 1);
    });
    $('addQtyDec').addEventListener('click', ()=>{
      const inp = $('addQty');
      inp.value = Math.max(1, toInt(inp.value, 1) - 1);
    });
    async function saveAddOne(){
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_CREATE, 'Create permission required')) return;
      const name = String(($('addName').value||'').trim());
      const desc = String(($('addDesc').value||'').trim());
      const qty  = toInt($('addQty').value,-1);
      if(!name){ toast('Item name required'); return; }
      if(qty<=0){ toast('Qty must be > 0'); return; }
      if(state.items.some(x=> toKey(x.name)===toKey(name))){ toast('Duplicate item'); return; }

      try{
        await sbAddItem(name, desc, qty);
        await sbLoadSnapshot();
        $('addName').value=''; $('addDesc').value=''; $('addQty').value='1';
        show('addOneModal', false);
        toast('Item added', 'success');
      }catch(e){
        toast(e.message || 'Cloud add failed');
      }
    }

        async function handleInventoryDeleteAction(id){
          if(!id) return;
          if(!requireOnline()) return;
          if(!requirePermission(PERMISSIONS.ITEMS_DELETE, 'Delete not allowed')) return;
          const selectedIds = getSelectedRowIds();
          const batchIds = (selectedIds.length > 1 && selectedIds.includes(id)) ? selectedIds : [id];
          const isBatch = batchIds.length > 1;
          const item = !isBatch ? state.items.find(it => it && it.id === id) : null;
          const itemName = item ? item.name : 'this item';
          const title = isBatch ? 'Delete items?' : 'Delete item?';
          const message = isBatch
            ? `Delete ${batchIds.length} selected items?`
            : `Delete "${itemName}"?`;
          const ok = await openConfirmModal(title, message, { okText:'Delete', cancelText:'Cancel' });
          if(!ok) return;
          try{
            await sbDeleteMany(batchIds);
            await sbLoadSnapshot();
            toast(isBatch ? `Deleted ${batchIds.length} items` : 'Item deleted', 'success');
          }catch(e){
            toast(e && e.message ? e.message : 'Delete failed', 'error');
          }
        }

			    // Row delete button handler (delegated)
			    document.addEventListener('click', (e)=>{
		      const btn = e.target.closest('.row-delete-btn');
		      if(!btn) return;
		      const id = String(btn.dataset.id || '').trim();
          handleInventoryDeleteAction(id);
    });

    // Row edit button handler (delegated)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.row-edit-btn');
      if(!btn) return;
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
      const id = String(btn.dataset.id || '').trim();
      if(!id) return;
      openEditItemModal(id);
    });

    // Row order button handler (delegated)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.row-order-btn');
      if(!btn) return;
      const id = String(btn.dataset.id || '').trim();
      if(!id) return;
      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      const selectedIds = getSelectedRowIds();
      if(selectedIds.length > 1 && selectedIds.includes(id)){
        let added = 0;
        for(const selId of selectedIds){
          const item = getInventoryById(selId);
          if(item && upsertOrderLineFromItem(item, 1)) added++;
        }
        if(added) toast(`Added ${added} selected item(s)`);
        else toast('Selected items already in cart');
        return;
      }
      toggleOrderLineForItemId(id);
    });

    // Row add-to-job button handler (delegated)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.row-job-btn');
      if(!btn) return;
      const id = String(btn.dataset.id || '').trim();
      if(!id) return;
      if(!canItemsView()){ toast('Job access requires view permission'); return; }
      openAddToJobModal(id);
    });

    // Master checkbox + indeterminate state
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.id==='chkAll'){
        const on = e.target.checked;
        document.querySelectorAll('.rowChk').forEach(cb=> cb.checked=on);
        try{ updateSelectionBar(); }catch(ex){}
      }
      if(e.target && e.target.classList && e.target.classList.contains('rowChk')){
        const all = document.querySelectorAll('.rowChk');
        const checked = document.querySelectorAll('.rowChk:checked');
        const m = $('chkAll');
        if(m){
          m.checked = (checked.length===all.length && all.length>0);
          m.indeterminate = (checked.length>0 && checked.length<all.length);
        }
        try{ updateSelectionBar(); }catch(ex){}
      }
    });

    // ========================
    // Parsing helpers
    // ========================
    const parseDelimitedSmart = IMUtils.parseDelimitedSmart || function parseDelimitedSmart(text){
      const firstLine=(text.split(/\r?\n/)[0]||'');
      let delim='\t';
      const tabScore=(firstLine.split('\t').length-1);
      const commaScore=(firstLine.split(',').length-1);
      const spaceScore=((firstLine.match(/\s{2,}/g)||[]).length);
      if(commaScore>tabScore && commaScore>=spaceScore) delim=','; else if(spaceScore>tabScore && spaceScore>commaScore) delim='  ';

      const rows=[]; let row=[]; let field=''; let inQ=false; let i=0; const N=text.length;
      const isDelim=(ch,pk)=> delim==='\t'? ch==='\t' : (delim===','? ch===',' : (ch===' ' && pk===' '));
      while(i<N){
        const ch=text[i], pk=text[i+1];
        if(ch==='"'){ if(inQ && pk==='"'){ field+='"'; i+=2; continue; } inQ=!inQ; i++; continue; }
        if(!inQ && (isDelim(ch,pk) || ch==='\n')){
          row.push(field); field='';
          if(delim==='  ' && ch===' ' && pk===' '){ while(text[i]===' ') i++; continue; }
          if(ch==='\n'){ rows.push(row); row=[]; }
          i++; continue;
        }
        if(ch==='\r'){ i++; continue; }
        field+=ch; i++;
      }
      if(field.length||row.length){ row.push(field); rows.push(row); }
      return rows.filter(r=> r.some(c=> String(c).trim().length));
    };
    const rowsToItems = IMUtils.rowsToItems || function rowsToItems(rows){
      if(!rows||!rows.length) return [];
      const canon=s=> toKey(String(s).replace(/[^A-Za-z0-9]+/g,'').trim());
      const hdrsRaw=rows[0]||[]; const hdrs=hdrsRaw.map(canon);
      const idxFromHdr=names=>{ for(const n of names){ const i=hdrs.indexOf(n); if(i>=0) return i; } return -1; };
      let iItem=idxFromHdr(['ITEM','NAME']);
      let iDesc=idxFromHdr(['DESCRIPTION','DESC']);
      let iQty = idxFromHdr(['QTY','QUANTITY','COUNT','QUANTITYONHAND']);
      const hasHeader=(iItem>=0);
      if(!hasHeader){ iItem=0; iDesc=1; iQty=2; }
      const start=hasHeader?1:0; const out=[];
      for(let r=start;r<rows.length;r++){
        const row=rows[r]||[];
        const name=String((row[iItem]!==undefined? row[iItem] : '')).trim(); if(!name) continue;
        const desc=String((iDesc>=0 && row[iDesc]!==undefined? row[iDesc] : '')).trim();
        const qtyV=(iQty>=0 && row[iQty]!==undefined)? row[iQty] : 0; const qty=toInt(qtyV,0);
        out.push({name, desc, qty});
      }
      return out;
    };
    if(!IMUtils.parseDelimitedSmart) IMUtils.parseDelimitedSmart = parseDelimitedSmart;
    if(!IMUtils.rowsToItems) IMUtils.rowsToItems = rowsToItems;
    async function ensureXlsx(){
      if(window.XLSX) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load XLSX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensureDocx(){
      if(window.mammoth) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load DOCX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensurePdf(){
      if(window.pdfjsLib) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load PDF parser'));
        document.head.appendChild(s);
      });
      // Configure worker
      if(window.pdfjsLib){
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
      }
    }
    async function parsePdf(file){
      await ensurePdf();
      const buf = await file.arrayBuffer();
      const doc = await window.pdfjsLib.getDocument({ data: buf }).promise;
      const allLines = [];
      for(let p=1; p<=doc.numPages; p++){
        const page = await doc.getPage(p);
        const tc = await page.getTextContent();
        const rows = new Map(); // y -> [{x,str}]
        for(const item of tc.items){
          const t = (item.str||'').trim(); if(!t) continue;
          const tr = item.transform || [0,0,0,0,0,0];
          const x = tr[4] || 0; const y = Math.round(tr[5] || 0);
          if(!rows.has(y)) rows.set(y, []);
          rows.get(y).push({ x, str:t });
        }
        // Sort by Y descending (PDF origin bottom-left), then by X asc
        const yKeys = Array.from(rows.keys()).sort((a,b)=> b-a);
        for(const y of yKeys){
          const cols = rows.get(y).sort((a,b)=> a.x-b.x).map(o=> o.str);
          const line = cols.join(' ').replace(/\s{2,}/g,'  ').trim();
          if(line) allLines.push(line);
        }
      }
      // Try to parse with existing delimited parser
      if(allLines.length){
        const text = allLines.join('\n');
        const items = rowsToItems(parseDelimitedSmart(text));
        if(items.length) return items;
        // Fallback: pairwise lines as name/desc with qty 0
        const rows=[]; for(let i=0;i<allLines.length;i+=2){ rows.push([allLines[i]||'', allLines[i+1]||'', '0']); }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseDocx(file){
      await ensureDocx();
      const buf = await file.arrayBuffer();
      const result = await window.mammoth.convertToHtml({arrayBuffer: buf});
      const html = result && result.value ? result.value : '';
      if(!html) return [];
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      const tables = tmp.querySelectorAll('table');
      const items = [];
      if(tables.length){
        tables.forEach(tbl=>{
          const rows = Array.from(tbl.querySelectorAll('tr'))
            .map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
          const parsed = rowsToItems(rows);
          parsed.forEach(r=> items.push(r));
        });
        if(items.length) return items;
      }
      const lines = Array.from(tmp.querySelectorAll('p'))
        .map(p=> p.textContent.replace(/\u00a0/g,' ').trim())
        .filter(s=> s.length);
      if(lines.length){
        if(lines.some(l=>/[\t,]/.test(l))){
          const text = lines.join('\n');
          return rowsToItems(parseDelimitedSmart(text));
        }
        const rows = [];
        for(let i=0;i<lines.length;i++){
          const a = lines[i];
          const b = (i+1 < lines.length) ? lines[++i] : '';
          rows.push([a, b, '0']);
        }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseAnyFile(file){
      const ext=(file.name.split('.').pop()||'').toLowerCase();
      if(ext==='json'){
        const t=await file.text();
        try{
          const p=JSON.parse(t);
          if(Array.isArray(p.items)) return p.items.map(it=>({name:String(it.name||'').trim(), desc:String(it.desc||''), qty:toInt(it.qty,0)}));
          if(Array.isArray(p)) return p.map(it=>({name:String(it.Item||it.name||'').trim(), desc:String(it.Description||it.desc||''), qty:toInt(it.Qty||it.qty,0)}));
        }catch{}
        return [];
      }
      if(ext==='pdf'){ try { return await parsePdf(file); } catch { return []; } }
      if(ext==='docx' || ext==='doc'){ try { return await parseDocx(file); } catch{ return []; } }
      if(ext==='csv'||ext==='tsv'||ext==='txt'){ const t=await file.text(); return rowsToItems(parseDelimitedSmart(t)); }
      if(ext==='xlsx'||ext==='xls'){
        await ensureXlsx();
        const buf=await file.arrayBuffer();
        const wb=XLSX.read(buf,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const aoa=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
        return rowsToItems(aoa);
      }
      return [];
    }

    // ========================
    // Merge semantics (local mode)
    // ========================
    function mergeSet(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      let added=0, updated=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        let it=index.get(k);
        if(!it){
          it={id:randomUUID(), name:r.name.trim(), desc:(r.desc||'').trim(), qty:toInt(r.qty,0)};
          state.items.push(it); index.set(k,it); added++;
        }else{
          if(r.desc && r.desc.trim()) it.desc=r.desc.trim();
          it.qty=toInt(r.qty,0);
          updated++;
        }
      }
      dedupe(); setUpdated(); save();
      return {added, updated, total:imported.length};
    }

    // ========================
    // Utilities
    // ========================
    const MODAL_FOCUSABLE = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    let _activeModal = null;
    let _lastFocused = null;
    function getOpenModals(){
      try{ return Array.from(document.querySelectorAll('.modal-backdrop[aria-hidden="false"]')); }catch(e){ return []; }
    }
    function getTopOpenModal(){
      const list = getOpenModals();
      return list.length ? list[list.length - 1] : null;
    }
    function lockBodyScroll(){
      const open = getOpenModals().length > 0;
      document.body.classList.toggle('modal-open', open);
    }
    function focusModal(backdrop){
      if(!backdrop) return;
      const modal = backdrop.querySelector('.modal') || backdrop;
      if(!modal) return;
      const focusables = Array.from(modal.querySelectorAll(MODAL_FOCUSABLE))
        .filter(el => !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true' && el.tabIndex !== -1);
      if(focusables.length){
        focusables[0].focus();
      }else{
        modal.setAttribute('tabindex','-1');
        modal.focus();
      }
    }
    function handleModalKeydown(e){
      if(!_activeModal) return;
      const modal = _activeModal.querySelector('.modal') || _activeModal;
      if(!modal) return;
      if(e.key === 'Tab'){
        const focusables = Array.from(modal.querySelectorAll(MODAL_FOCUSABLE))
          .filter(el => !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true' && el.tabIndex !== -1);
        if(!focusables.length){
          e.preventDefault();
          return;
        }
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if(e.shiftKey && document.activeElement === first){
          e.preventDefault();
          last.focus();
        }else if(!e.shiftKey && document.activeElement === last){
          e.preventDefault();
          first.focus();
        }
      }
      if(e.key === 'Escape'){
        const open = getTopOpenModal();
        if(!open) return;
        e.preventDefault();
        const id = open.id || '';
        if(id === 'confirmModal') closeConfirmModal(false);
        else if(id === 'msgModal') closeMsgModal();
        else if(id === 'qtyEntryModal') closeQtyEntryModal(null);
        else if(id === 'companyLocationsModal') void closeCompanyLocationsModal();
        else if(id === 'pasteModal') show('pasteModal', false);
        else if(id) show(id, false);
      }
    }
    document.addEventListener('keydown', handleModalKeydown);
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-modal-close]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-modal-close') || '').trim();
      if(!id) return;
      if(id === 'confirmModal') closeConfirmModal(false);
      else if(id === 'msgModal') closeMsgModal();
      else if(id === 'qtyEntryModal') closeQtyEntryModal(null);
      else if(id === 'companyLocationsModal') void closeCompanyLocationsModal();
      else show(id, false);
    });
    function show(id, on = true) {
  const el = document.getElementById(id);
  if (!el) return;
  if (!on) {
    if (el.contains(document.activeElement)) {
      document.activeElement.blur();
    }
    el.setAttribute('aria-hidden', 'true');
    el.style.display = 'none';
    if(_activeModal === el) _activeModal = null;
    lockBodyScroll();
    if(_lastFocused) try{ _lastFocused.focus(); }catch(e){}
    return;
  }
	  _lastFocused = document.activeElement;
	  el.style.display = 'flex';
	  el.setAttribute('aria-hidden', 'false');
	  _activeModal = el;
	  lockBodyScroll();

	  // Optional: auto-focus a sensible control
	  if (id === 'addOneModal') {
	    const inp = document.getElementById('addName');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'pasteModal') {
    const ta = document.getElementById('pasteArea');
    if (ta) setTimeout(() => ta.focus(), 0);
  } else if (id === 'orderModal') {
    const inp = document.getElementById('orderSearch');
    if (inp) setTimeout(() => inp.focus(), 0);
	  } else if (id === 'qtyEntryModal') {
	    const inp = document.getElementById('qtyEntryInput');
	    if (inp) setTimeout(() => inp.focus(), 0);
	  } else if (id === 'authModal') {
	    const inp = document.getElementById('authEmail');
	    if (inp) setTimeout(() => inp.focus(), 0);
	  } else if (id === 'msgModal') {
	    const btn = document.getElementById('btnMsgOk');
	    if (btn) setTimeout(() => btn.focus(), 0);
  } else if (id === 'confirmModal') {
    const btn = document.getElementById('btnConfirmCancel');
    if (btn) setTimeout(() => btn.focus(), 0);
  } else if (id === 'profileModal') {
    const inp = document.getElementById('profilePhone');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'companyLocationEditorModal') {
    const inp = document.getElementById('companyLocationName');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'advancedCompanyModal') {
    if(state._companySwitcherMode === 'basic'){
      const btn = document.querySelector('#advancedCompanyResults [data-basic-switch]:not([disabled])');
      if (btn) setTimeout(() => btn.focus(), 0);
    }else{
      const inp = document.getElementById('advancedCompanySearch');
      if (inp) setTimeout(() => inp.focus(), 0);
    }
  } else if (id === 'diagnosticsModal') {
    const inp = document.getElementById('diagRoleSelect');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'addToJobModal') {
    const sel = document.getElementById('addToJobSelect');
    if (sel) setTimeout(() => sel.focus(), 0);
  } else if (id === 'seedInventoryModal') {
    const sel = document.getElementById('seedInventorySource');
    if (sel) setTimeout(() => sel.focus(), 0);
  } else if (id === 'companyEnvironmentModal') {
    const sel = document.getElementById('companyEnvironmentSelect');
    if (sel) setTimeout(() => sel.focus(), 0);
  }
	  setTimeout(()=>{
	    if(el.contains(document.activeElement)) return;
	    focusModal(el);
	  }, 0);
}

    // App message modal (replaces browser alert/prompt where possible)
    let _msgCopyText = '';
    function openMsgModal(title, body, copyText){
      _msgCopyText = String(copyText || '');
      const t = $('msgTitle'); if(t) t.textContent = String(title || 'Message');
      const b = $('msgBody'); if(b) b.textContent = String(body || '');
      const btnCopy = $('btnMsgCopy');
      if(btnCopy){
        const has = !!_msgCopyText;
        btnCopy.style.display = has ? 'inline-flex' : 'none';
        btnCopy.disabled = !has;
      }
      show('msgModal', true);
    }
    function closeMsgModal(){
      _msgCopyText = '';
      show('msgModal', false);
    }
    const btnMsgOk = $('btnMsgOk');
    if(btnMsgOk) btnMsgOk.addEventListener('click', closeMsgModal);
    const btnMsgCopy = $('btnMsgCopy');
	    if(btnMsgCopy) btnMsgCopy.addEventListener('click', async ()=>{
	      if(!_msgCopyText) return;
	      try{
	        await navigator.clipboard.writeText(_msgCopyText);
	        toast('Copied', 'success');
	      }catch(e){
	        toast('Copy failed', 'error');
	      }
	    });

	    // App confirm modal (replaces browser confirm)
	    let _confirmResolve = null;
	    function openConfirmModal(title, body, opts = {}){
	      if(_confirmResolve){
	        try{ _confirmResolve(false); }catch(e){}
	        _confirmResolve = null;
	      }
	      const t = $('confirmTitle'); if(t) t.textContent = String(title || 'Confirm');
	      const b = $('confirmBody'); if(b) b.textContent = String(body || '');
	      const okText = opts && opts.okText ? String(opts.okText) : 'OK';
	      const cancelText = opts && opts.cancelText ? String(opts.cancelText) : 'Cancel';
	      const okBtn = $('btnConfirmOk');
	      if(okBtn){
	        if(!okBtn.dataset.baseClass) okBtn.dataset.baseClass = okBtn.className || 'btn-primary';
	        const baseClass = okBtn.dataset.baseClass || 'btn-primary';
	        const extraClass = opts && opts.okClass ? String(opts.okClass).trim() : '';
	        okBtn.className = extraClass ? `${baseClass} ${extraClass}` : baseClass;
	        okBtn.textContent = okText;
	      }
	      const cancelBtn = $('btnConfirmCancel'); if(cancelBtn) cancelBtn.textContent = cancelText;
	      show('confirmModal', true);
	      return new Promise(resolve => { _confirmResolve = resolve; });
	    }
	    function closeConfirmModal(result){
	      show('confirmModal', false);
	      const resolve = _confirmResolve;
	      _confirmResolve = null;
	      if(resolve) resolve(!!result);
	    }
	    const btnConfirmCancel = $('btnConfirmCancel');
	    if(btnConfirmCancel) btnConfirmCancel.addEventListener('click', ()=> closeConfirmModal(false));
	    const btnConfirmOk = $('btnConfirmOk');
	    if(btnConfirmOk) btnConfirmOk.addEventListener('click', ()=> closeConfirmModal(true));
		    document.addEventListener('keydown', (e)=>{
		      if(e.key !== 'Escape') return;
		      const modal = $('confirmModal');
		      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
		      e.preventDefault();
		      closeConfirmModal(false);
		    });

		    // Qty entry modal (number prompt)
		    let _qtyEntryResolve = null;
		    let _qtyEntryOpts = {};
		    function openQtyEntryModal(title, subtitle, initialValue, opts = {}){
		      if(_qtyEntryResolve){
		        try{ _qtyEntryResolve(null); }catch(e){}
		        _qtyEntryResolve = null;
		      }
		      _qtyEntryOpts = opts || {};
		      const t = $('qtyEntryTitle'); if(t) t.textContent = String(title || 'Set Qty');
		      const sub = $('qtyEntrySubtitle');
		      if(sub){
		        const txt = String(subtitle || '').trim();
		        sub.textContent = txt;
		        sub.style.display = txt ? 'block' : 'none';
		      }
		      const input = $('qtyEntryInput');
		      if(input){
		        const min = Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'min') ? toInt(_qtyEntryOpts.min, 0) : 0;
		        input.min = String(min);
		        const hasMax = Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'max') && _qtyEntryOpts.max !== null && typeof _qtyEntryOpts.max !== 'undefined';
		        if(hasMax){
		          const max = Number(_qtyEntryOpts.max);
		          if(Number.isFinite(max) && Math.trunc(max) >= min) input.max = String(Math.trunc(max));
		          else input.removeAttribute('max');
		        }else{
		          input.removeAttribute('max');
		        }
		        input.value = String(toInt(initialValue, 0));
		      }
		      const okBtn = $('btnQtyEntryOk');
		      if(okBtn) okBtn.textContent = (_qtyEntryOpts && _qtyEntryOpts.okText) ? String(_qtyEntryOpts.okText) : 'Save';
		      const cancelBtn = $('btnQtyEntryCancel');
		      if(cancelBtn) cancelBtn.textContent = (_qtyEntryOpts && _qtyEntryOpts.cancelText) ? String(_qtyEntryOpts.cancelText) : 'Cancel';
		      show('qtyEntryModal', true);
		      setTimeout(()=>{
		        const inp = $('qtyEntryInput');
		        if(!inp) return;
		        try{ inp.focus(); inp.select(); }catch(e){}
		      }, 0);
		      return new Promise(resolve => { _qtyEntryResolve = resolve; });
		    }
		    function closeQtyEntryModal(result){
		      show('qtyEntryModal', false);
		      const resolve = _qtyEntryResolve;
		      _qtyEntryResolve = null;
		      if(resolve) resolve(result);
		    }
		    function handleQtyEntryOk(){
		      const input = $('qtyEntryInput');
		      const raw = input ? input.value : '';
		      const min = (_qtyEntryOpts && Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'min')) ? toInt(_qtyEntryOpts.min, 0) : 0;
		      const max = (_qtyEntryOpts && Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'max')) ? Number(_qtyEntryOpts.max) : NaN;
		      const q = toInt(raw, -1);
		      if(q < min){
		        toast(`Qty must be â‰¥ ${min}`);
		        try{ if(input){ input.focus(); input.select(); } }catch(e){}
		        return;
		      }
		      if(Number.isFinite(max) && q > Math.trunc(max)){
		        toast(`Qty must be â‰¤ ${Math.trunc(max)}`);
		        try{ if(input){ input.focus(); input.select(); } }catch(e){}
		        return;
		      }
		      closeQtyEntryModal(q);
		    }
		    const btnQtyEntryCancel = $('btnQtyEntryCancel');
		    if(btnQtyEntryCancel) btnQtyEntryCancel.addEventListener('click', ()=> closeQtyEntryModal(null));
		    const btnQtyEntryOk = $('btnQtyEntryOk');
		    if(btnQtyEntryOk) btnQtyEntryOk.addEventListener('click', handleQtyEntryOk);
		    const qtyEntryInput = $('qtyEntryInput');
		    if(qtyEntryInput) qtyEntryInput.addEventListener('keydown', (e)=>{
		      if(e.key==='Escape'){ e.preventDefault(); closeQtyEntryModal(null); }
		      if(e.key==='Enter'){ e.preventDefault(); handleQtyEntryOk(); }
		    });
		    document.addEventListener('keydown', (e)=>{
		      if(e.key !== 'Escape') return;
		      const modal = $('qtyEntryModal');
		      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
		      e.preventDefault();
		      closeQtyEntryModal(null);
		    });
		    function syncToastZoneVisibility(){
		      const zone = $('headerToastZone');
		      if(!zone) return;
		      const toastEl = $('toast');
		      const pill = $('orderPillContainer');
		      const toastVisible = toastEl && toastEl.classList.contains('is-visible');
		      const pillVisible = pill && pill.style.display !== 'none';
		      const feedbackToast = zone.querySelector('.cart-feedback-toast');
		      if(toastVisible || pillVisible || feedbackToast){
		        zone.classList.add('is-visible');
		      }else{
		        zone.classList.remove('is-visible');
		      }
		    }
		    const TOAST_ICONS = {
		      success: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
		      error: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
		      warning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',
		      info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
		      default: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'
		    };
		    function toast(msg, type = 'default'){
		      const t=$('toast');
		      if(!t) return;
		      // Clear previous state
		      clearTimeout(t._tmr);
		      t.className = 'toast';
		      t.classList.add('toast--' + type, 'is-visible');
		      // Build toast content
		      const icon = TOAST_ICONS[type] || TOAST_ICONS.default;
		      t.innerHTML = `
		        <span class="toast-icon">${icon}</span>
		        <span class="toast-content"><span class="toast-message">${msg}</span></span>
		        <span class="toast-progress"></span>
		      `;
		      syncToastZoneVisibility();
		      t._tmr=setTimeout(()=> {
		        t.style.animation = 'toastSlideOut 0.25s ease forwards';
		        setTimeout(() => {
		          t.classList.remove('is-visible');
		          t.style.animation = '';
		          t.innerHTML = '';
		          syncToastZoneVisibility();
		        }, 250);
		      }, 2500);
		    }

    // iOS keyboard-safe scroll height
    document.addEventListener('focusin', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','60vh');
      }
    });
    document.addEventListener('focusout', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','70vh');
      }
    });

    // iOS-style qty picker
    const _qtyPicker = {
      itemId: null,
      itemName: '',
      currentQty: 0,
      selectedQty: 0,
      maxQty: 999,
      scrollY: 0,
      isDragging: false,
      startY: 0,
      startScrollY: 0
    };
    function openQtyPicker(itemId, itemName, currentQty){
      _qtyPicker.itemId = itemId;
      _qtyPicker.itemName = itemName;
      _qtyPicker.currentQty = currentQty;
      _qtyPicker.selectedQty = currentQty;
      _qtyPicker.scrollY = -currentQty * 36;
      const title = $('qtyPickerTitle');
      if(title) title.textContent = itemName || 'Order Qty';
      renderQtyPickerWheel();
      show('qtyPickerModal', true);
    }
    function closeQtyPicker(){
      show('qtyPickerModal', false);
      _qtyPicker.itemId = null;
    }
    function renderQtyPickerWheel(){
      const wheel = $('qtyPickerWheel');
      if(!wheel) return;
      let html = '';
      for(let i = 0; i <= _qtyPicker.maxQty; i++){
        const isSelected = i === _qtyPicker.selectedQty;
        html += `<div class="qty-picker-item${isSelected ? ' selected' : ''}" data-qty="${i}">${i}</div>`;
      }
      wheel.innerHTML = html;
      wheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
    }
    function updateQtyPickerSelection(){
      const wheel = $('qtyPickerWheel');
      if(!wheel) return;
      const idx = Math.round(-_qtyPicker.scrollY / 36);
      _qtyPicker.selectedQty = Math.max(0, Math.min(_qtyPicker.maxQty, idx));
      wheel.querySelectorAll('.qty-picker-item').forEach((el, i) => {
        el.classList.toggle('selected', i === _qtyPicker.selectedQty);
      });
    }
    function snapQtyPicker(){
      const idx = Math.round(-_qtyPicker.scrollY / 36);
      const clampedIdx = Math.max(0, Math.min(_qtyPicker.maxQty, idx));
      _qtyPicker.selectedQty = clampedIdx;
      _qtyPicker.scrollY = -clampedIdx * 36;
      const wheel = $('qtyPickerWheel');
      if(wheel){
        wheel.style.transition = 'transform 150ms ease-out';
        wheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
        setTimeout(()=>{ wheel.style.transition = ''; }, 150);
      }
      updateQtyPickerSelection();
    }
    function handleQtyPickerDone(){
      const id = _qtyPicker.itemId;
      const qty = _qtyPicker.selectedQty;
      if(id){
        const ord = orderState();
        const line = ord.lines.find(l => l.id === id);
        if(line){
          if(qty === 0){
            removeOrderLine(id);
          } else {
            line.qty = qty;
          }
          renderOrderLines();
        }
      }
      closeQtyPicker();
    }

    // ========================
    // Onboarding UI
    // ========================
    const ONBOARDING_INTENT_KEY = 'inv.onboarding.intent';
    const ONBOARDING_PLANS = ['starter','professional','business','enterprise'];
    const ONBOARDING_STATES = [
      'UNINITIALIZED',
      'SUBSCRIPTION_ACTIVE',
      'COMPANY_PROFILE_COMPLETE',
      'LOCATIONS_CONFIGURED',
      'USERS_INVITED',
      'ONBOARDING_COMPLETE'
    ];
    function isOnboardingRoute(){
      const path = String(window.location.pathname || '');
      return /\/onboarding\/?$/.test(path);
    }
    function getAppHomeUrl(){
      const path = String(window.location.pathname || '/');
      const base = path.replace(/\/onboarding\/?$/, '/') || '/';
      return `${window.location.origin}${base}`;
    }
    function redirectToAppHome(){
      _onboardingCompanyId = '';
      window.location.href = getAppHomeUrl();
    }
    function normalizeOnboardingPlan(value){
      const plan = String(value || '').trim().toLowerCase();
      return ONBOARDING_PLANS.includes(plan) ? plan : '';
    }
    function storeOnboardingIntentFromUrl(){
      if(!isOnboardingRoute()) return;
      try{
        const params = new URLSearchParams(window.location.search);
        const plan = normalizeOnboardingPlan(params.get('plan'));
        const source = String(params.get('source') || '').trim();
        if(!plan && !source) return;
        const payload = { plan, source, ts: Date.now() };
        sessionStorage.setItem(ONBOARDING_INTENT_KEY, JSON.stringify(payload));
      }catch(e){}
    }
    function readOnboardingIntent(){
      try{
        const raw = sessionStorage.getItem(ONBOARDING_INTENT_KEY);
        if(!raw) return { plan:'', source:'' };
        const data = JSON.parse(raw);
        return {
          plan: normalizeOnboardingPlan(data && data.plan ? data.plan : ''),
          source: String(data && data.source ? data.source : '').trim()
        };
      }catch(e){
        return { plan:'', source:'' };
      }
    }
    function loadOnboardingIntent(){
      const intent = readOnboardingIntent();
      state._onboardingPlan = intent.plan;
      state._onboardingSource = intent.source;
    }
    function renderOnboardingPlanSummary(){
      const el = $('onboardingPlanSummary');
      if(!el) return;
      const plan = normalizeOnboardingPlan(state._onboardingPlan);
      const source = String(state._onboardingSource || '').trim();
      if(!plan){
        el.textContent = '';
        el.style.display = 'none';
        return;
      }
      const label = formatTierLabel(plan);
      const sourceLabel = source ? ` Â· Source: ${source}` : '';
      el.textContent = `Plan: ${label}${sourceLabel}`;
      el.style.display = '';
    }
    function setOnboardingRouteActive(active){
      const main = $('onboardingMain');
      if(main) main.classList.toggle('active', active);
      document.body.classList.toggle('onboarding-route', active);
      if(!active) restorePendingInvitesToUserMgmt();
    }
    function setOnboardingGate(config){
      const gate = $('onboardingGate');
      const wizard = $('onboardingWizard');
      if(!gate) return;
      const showGate = !!(config && config.show !== false);
      gate.style.display = showGate ? '' : 'none';
      if(wizard) wizard.style.display = showGate ? 'none' : '';
      if(!showGate){
        state._onboardingGatePrimary = null;
        state._onboardingGateSecondary = null;
        return;
      }
      const title = $('onboardingGateTitle');
      const message = $('onboardingGateMessage');
      const primary = $('onboardingGatePrimary');
      const secondary = $('onboardingGateSecondary');
      if(title) title.textContent = String(config && config.title ? config.title : '');
      if(message) message.textContent = String(config && config.message ? config.message : '');
      if(primary){
        const label = config && config.primaryLabel ? String(config.primaryLabel) : 'Continue';
        primary.textContent = label;
        primary.style.display = '';
      }
      if(secondary){
        const label = config && config.secondaryLabel ? String(config.secondaryLabel) : '';
        secondary.textContent = label;
        secondary.style.display = label ? '' : 'none';
      }
      state._onboardingGatePrimary = config && typeof config.primaryAction === 'function' ? config.primaryAction : null;
      state._onboardingGateSecondary = config && typeof config.secondaryAction === 'function' ? config.secondaryAction : null;
    }
    function normalizeOnboardingState(value){
      const stateValue = String(value || '').trim().toUpperCase();
      return ONBOARDING_STATES.includes(stateValue) ? stateValue : 'UNINITIALIZED';
    }
    function getOnboardingStepFromState(value){
      const stateValue = normalizeOnboardingState(value);
      if(stateValue === 'COMPANY_PROFILE_COMPLETE') return 2;
      if(stateValue === 'LOCATIONS_CONFIGURED') return 3;
      if(stateValue === 'USERS_INVITED') return 4;
      if(stateValue === 'ONBOARDING_COMPLETE') return 5;
      return 1;
    }
    function renderOnboardingProgress(stepIndex){
      const fill = $('onboardingProgressFill');
      const total = 4;
      const safeStep = Math.min(Math.max(stepIndex, 1), total);
      if(fill){
        const pct = Math.round((safeStep / total) * 100);
        fill.style.width = `${pct}%`;
      }
      document.querySelectorAll('[data-onboarding-progress]').forEach(el=>{
        const idx = Number(el.getAttribute('data-onboarding-progress') || '0');
        el.classList.toggle('active', idx === safeStep);
        el.classList.toggle('complete', idx < safeStep);
      });
    }
    function renderOnboardingStep(stepId){
      document.querySelectorAll('.onboarding-step').forEach(el=>{
        const match = String(el.getAttribute('data-onboarding-step') || '') === stepId;
        el.classList.toggle('active', match);
      });
    }
    function setOnboardingMessage(id, msg){
      const el = $(id);
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function renderOnboardingTimezoneOptions(){
      const select = $('onboardingTimezone');
      if(!select || select._filled) return;

      // US timezones with friendly labels (prioritized)
      const usTimezones = [
        { value: 'America/New_York', label: 'Eastern (New York)' },
        { value: 'America/Chicago', label: 'Central (Chicago)' },
        { value: 'America/Denver', label: 'Mountain (Denver)' },
        { value: 'America/Phoenix', label: 'Mountain - Arizona (Phoenix)' },
        { value: 'America/Los_Angeles', label: 'Pacific (Los Angeles)' },
        { value: 'America/Anchorage', label: 'Alaska (Anchorage)' },
        { value: 'Pacific/Honolulu', label: 'Hawaii (Honolulu)' }
      ];

      // Get all IANA timezones
      let allZones = [];
      try {
        if(typeof Intl !== 'undefined' && typeof Intl.supportedValuesOf === 'function'){
          allZones = Intl.supportedValuesOf('timeZone');
        }
      } catch(e){}

      // Group timezones by region
      const usValues = new Set(usTimezones.map(t => t.value));
      const groups = {
        'Canada': [],
        'Mexico & Caribbean': [],
        'Central & South America': [],
        'Europe': [],
        'Africa': [],
        'Asia': [],
        'Australia & Pacific': [],
        'Other': []
      };

      allZones.forEach(zone => {
        if(usValues.has(zone)) return; // Skip US zones already listed

        if(zone.startsWith('America/') && (zone.includes('Toronto') || zone.includes('Vancouver') || zone.includes('Edmonton') || zone.includes('Winnipeg') || zone.includes('Halifax') || zone.includes('St_Johns') || zone.includes('Regina') || zone.includes('Whitehorse') || zone.includes('Yellowknife'))){
          groups['Canada'].push(zone);
        } else if(zone.startsWith('America/') && (zone.includes('Mexico') || zone.includes('Cancun') || zone.includes('Tijuana') || zone.includes('Merida') || zone.includes('Jamaica') || zone.includes('Puerto_Rico') || zone.includes('Havana') || zone.includes('Bahamas') || zone.includes('Santo_Domingo') || zone.includes('Barbados') || zone.includes('Martinique') || zone.includes('Nassau'))){
          groups['Mexico & Caribbean'].push(zone);
        } else if(zone.startsWith('America/') && !usValues.has(zone)){
          groups['Central & South America'].push(zone);
        } else if(zone.startsWith('Europe/')){
          groups['Europe'].push(zone);
        } else if(zone.startsWith('Africa/')){
          groups['Africa'].push(zone);
        } else if(zone.startsWith('Asia/') || zone.startsWith('Indian/')){
          groups['Asia'].push(zone);
        } else if(zone.startsWith('Australia/') || zone.startsWith('Pacific/')){
          if(!usValues.has(zone)) groups['Australia & Pacific'].push(zone);
        } else if(zone !== 'UTC' && !zone.startsWith('Etc/')){
          groups['Other'].push(zone);
        }
      });

      // Sort each group
      Object.keys(groups).forEach(key => groups[key].sort());

      // Build HTML
      let html = '<option value="">Select timezone...</option>';

      // US timezones first
      html += '<optgroup label="United States">';
      usTimezones.forEach(tz => {
        html += `<option value="${escapeHtmlAttr(tz.value)}">${escapeHtml(tz.label)}</option>`;
      });
      html += '</optgroup>';

      // Other groups
      const groupOrder = ['Canada', 'Mexico & Caribbean', 'Central & South America', 'Europe', 'Africa', 'Asia', 'Australia & Pacific', 'Other'];
      groupOrder.forEach(groupName => {
        const zones = groups[groupName];
        if(zones && zones.length > 0){
          html += `<optgroup label="${escapeHtmlAttr(groupName)}">`;
          zones.forEach(zone => {
            // Extract city name for display
            const parts = zone.split('/');
            const city = parts[parts.length - 1].replace(/_/g, ' ');
            html += `<option value="${escapeHtmlAttr(zone)}">${escapeHtml(city)}</option>`;
          });
          html += '</optgroup>';
        }
      });

      // Add UTC option at the end
      html += '<optgroup label="Universal"><option value="UTC">UTC</option></optgroup>';

      select.innerHTML = html;
      select._filled = true;
    }
    async function fetchOnboardingState(){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const { data, error } = await SB.client.rpc('get_onboarding_state', { p_company_id: SB.companyId });
      if(error) throw error;
      return normalizeOnboardingState(data);
    }
    async function loadOnboardingCompanyProfile(){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const { data, error } = await SB.client
        .from('companies')
        .select('name,settings')
        .eq('id', SB.companyId)
        .single();
      if(error) throw error;
      const settings =
        data && data.settings && typeof data.settings === 'object' && !Array.isArray(data.settings)
          ? data.settings
          : {};
      return { name: data && data.name ? data.name : '', settings };
    }
    function applyOnboardingProfileToForm(profile){
      const name = $('onboardingCompanyName');
      const email = $('onboardingContactEmail');
      const timezone = $('onboardingTimezone');
      if(name) name.value = profile && profile.name ? String(profile.name) : '';
      if(email) email.value = profile && profile.settings ? String(profile.settings.primary_contact_email || '') : '';
      // Populate timezone options first
      renderOnboardingTimezoneOptions();
      // Set timezone: use saved value, or auto-detect from system
      if(timezone){
        const savedTz = profile && profile.settings ? String(profile.settings.timezone || '') : '';
        timezone.value = savedTz || getSystemTimezone();
      }
    }
    function renderOnboardingReceiptForwarding(){
      const addressEl = $('onboardingReceiptAddress');
      if(addressEl) addressEl.textContent = getReceiptForwardingAddress();
      const gateEl = $('onboardingReceiptGate');
      if(gateEl){
        const allowed = hasTier('professional');
        gateEl.style.display = allowed ? 'none' : '';
        gateEl.textContent = allowed
          ? ''
          : 'Receipt ingestion is available on Pro plans. You can enable it later.';
      }
    }
    async function updateCompanySettings(patch, nameOverride){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const payload = {
        p_company_id: SB.companyId,
        p_settings_patch: patch || {}
      };
      if(typeof nameOverride === 'string' && nameOverride.trim()){
        payload.p_name = nameOverride.trim();
      }
      const { data, error } = await SB.client.rpc('update_company_settings', payload);
      if(error) throw error;
      const result = data && typeof data === 'object' ? data : {};
      return {
        settings: result.settings && typeof result.settings === 'object' ? result.settings : {},
        name: result.name || (typeof nameOverride === 'string' ? nameOverride.trim() : '')
      };
    }
    async function advanceOnboardingState(targetState){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const { data, error } = await SB.client.rpc('advance_onboarding_state', {
        p_company_id: SB.companyId,
        p_target_state: targetState
      });
      if(error) throw error;
      return normalizeOnboardingState(data);
    }
    async function fetchActiveLocationCount(){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const { count, error } = await SB.client
        .from('company_locations')
        .select('id', { count:'exact', head:true })
        .eq('company_id', SB.companyId)
        .eq('is_active', true);
      if(error) throw error;
      return Number.isFinite(count) ? count : 0;
    }
    function renderOnboardingLocationsStatus(rows){
      const status = $('onboardingLocationsStatus');
      const summary = $('onboardingLocationsSummary');
      if(!summary) return;
      const list = Array.isArray(rows) ? rows.filter(r => r && r.is_active) : [];
      if(!list.length){
        if(status) status.textContent = '';
        summary.innerHTML = '<div class="muted">No active locations yet.</div>';
        return;
      }
      if(status){
        status.textContent = `Active locations: ${list.length}`;
      }
      const primary = list[0];
      const addressLines = formatLocationAddress(primary).split('\n').filter(Boolean);
      const addressHtml = addressLines.map(line => `<div>${escapeHtml(line)}</div>`).join('');
      const extraCount = list.length - 1;
      const extra = extraCount > 0
        ? `<div class="onboarding-location-meta">+${extraCount} more active location${extraCount > 1 ? 's' : ''}</div>`
        : '';
      summary.innerHTML =
        `<div class="onboarding-location-card">`+
          `<div class="onboarding-location-name">${escapeHtml(primary.name || 'Location')}</div>`+
          `<div class="onboarding-location-address">${addressHtml}</div>`+
          `${extra}`+
        `</div>`;
    }
    function attachPendingInvitesToOnboarding(){
      const slot = $('onboardingPendingInvitesSlot');
      const section = $('pendingInvitesSection');
      if(!slot || !section) return;
      if(section.parentElement !== slot) slot.appendChild(section);
      renderPendingInvitesSection();
    }
    function restorePendingInvitesToUserMgmt(){
      const mount = $('pendingInvitesMount');
      const section = $('pendingInvitesSection');
      if(!mount || !section) return;
      if(section.parentElement !== mount) mount.appendChild(section);
    }
    function renderOnboardingInviteNotice(){
      const msg = $('onboardingInvitesMsg');
      if(!msg) return;
      if(!canAccessInvites()){
        msg.textContent = 'Invites require Business tier and invite permissions. You can skip for now.';
        return;
      }
      msg.textContent = '';
    }
    async function handleOnboardingProfileSubmit(){
      const btn = $('btnOnboardingProfileSave');
      const name = String($('onboardingCompanyName')?.value || '').trim();
      const email = String($('onboardingContactEmail')?.value || '').trim();
      const timezone = String($('onboardingTimezone')?.value || '').trim();
      setOnboardingMessage('onboardingProfileMsg', '');
      if(!name){
        setOnboardingMessage('onboardingProfileMsg', 'Company name is required.');
        return;
      }
      if(!email){
        setOnboardingMessage('onboardingProfileMsg', 'Primary contact email is required.');
        return;
      }
      if(!timezone){
        setOnboardingMessage('onboardingProfileMsg', 'Timezone is required.');
        return;
      }
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Saving...';
      }
      try{
        const result = await updateCompanySettings({
          primary_contact_email: email,
          timezone
        }, name);
        if(SB.company){
          SB.company.company_name = result.name;
        }
        if(Array.isArray(SB.companies)){
          const idx = SB.companies.findIndex(row => String(row.company_id) === String(SB.companyId));
          if(idx >= 0){
            SB.companies[idx] = { ...SB.companies[idx], company_name: result.name };
          }
        }
        renderCompanySwitcher();
      }catch(e){
        setOnboardingMessage('onboardingProfileMsg', e && e.message ? e.message : 'Failed to save profile.');
        return;
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Continue';
        }
      }
      try{
        await advanceOnboardingState('COMPANY_PROFILE_COMPLETE');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingProfileMsg', e && e.message ? e.message : 'Unable to advance onboarding.');
      }
    }
    async function handleOnboardingLocationsContinue(){
      const btn = $('btnOnboardingLocationsContinue');
      setOnboardingMessage('onboardingLocationsMsg', '');
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Checking...';
      }
      try{
        const rows = await sbFetchCompanyLocations();
        renderOnboardingLocationsStatus(rows);
        const activeCount = Array.isArray(rows) ? rows.filter(r => r && r.is_active).length : 0;
        if(activeCount < 1){
          setOnboardingMessage('onboardingLocationsMsg', 'Add at least one active location to continue.');
          return;
        }
        await advanceOnboardingState('LOCATIONS_CONFIGURED');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingLocationsMsg', e && e.message ? e.message : 'Unable to advance onboarding.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Continue';
        }
      }
    }
    async function handleOnboardingInvitesSkip(){
      const btn = $('btnOnboardingInvitesSkip');
      setOnboardingMessage('onboardingInvitesMsg', '');
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
      }
      try{
        await updateCompanySettings({ onboarding_skip_invites: true });
        await advanceOnboardingState('USERS_INVITED');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingInvitesMsg', e && e.message ? e.message : 'Unable to skip invites.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
        }
      }
    }
    async function handleOnboardingInvitesContinue(){
      const btn = $('btnOnboardingInvitesContinue');
      setOnboardingMessage('onboardingInvitesMsg', '');
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Saving...';
      }
      try{
        await advanceOnboardingState('USERS_INVITED');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingInvitesMsg', e && e.message ? e.message : 'Invite at least one user or skip for now.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Continue';
        }
      }
    }
    async function maybeAdvanceOnboardingAfterInvite(){
      if(!isOnboardingRoute()) return;
      if(getOnboardingStepFromState(state._onboardingState) !== 3) return;
      try{
        await advanceOnboardingState('USERS_INVITED');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingInvitesMsg', e && e.message ? e.message : 'Unable to advance onboarding.');
      }
    }
    async function handleOnboardingFinish(){
      const btn = $('btnOnboardingFinish');
      setOnboardingMessage('onboardingFinishMsg', '');
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Finalizing...';
      }
      try{
        await advanceOnboardingState('ONBOARDING_COMPLETE');
        redirectToAppHome();
      }catch(e){
        setOnboardingMessage('onboardingFinishMsg', e && e.message ? e.message : 'Unable to finish onboarding.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Go to Dashboard';
        }
      }
    }
    function wireOnboardingEvents(){
      const gatePrimary = $('onboardingGatePrimary');
      if(gatePrimary && !gatePrimary._wired){
        gatePrimary._wired = true;
        gatePrimary.addEventListener('click', ()=>{
          if(typeof state._onboardingGatePrimary === 'function') state._onboardingGatePrimary();
        });
      }
      const gateSecondary = $('onboardingGateSecondary');
      if(gateSecondary && !gateSecondary._wired){
        gateSecondary._wired = true;
        gateSecondary.addEventListener('click', ()=>{
          if(typeof state._onboardingGateSecondary === 'function') state._onboardingGateSecondary();
        });
      }
      // Signup form listeners
      const signupForm = $('onboardingAccountForm');
      if(signupForm && !signupForm._wired){
        signupForm._wired = true;
        signupForm.addEventListener('submit', (e)=>{
          e.preventDefault();
          void handleSignupSubmit(e);
        });
      }
      const signupHaveAccount = $('btnSignupHaveAccount');
      if(signupHaveAccount && !signupHaveAccount._wired){
        signupHaveAccount._wired = true;
        signupHaveAccount.addEventListener('click', ()=>{
          showSignInFromSignup();
        });
      }
      const companyForm = $('onboardingCompanyForm');
      if(companyForm && !companyForm._wired){
        companyForm._wired = true;
        companyForm.addEventListener('submit', (e)=>{
          e.preventDefault();
          void handleCompanyCreate(e);
        });
      }
      const profileForm = $('onboardingProfileForm');
      if(profileForm && !profileForm._wired){
        profileForm._wired = true;
        profileForm.addEventListener('submit', (e)=>{
          e.preventDefault();
          void handleOnboardingProfileSubmit();
        });
      }
      const locationsManage = $('btnOnboardingManageLocations');
      if(locationsManage && !locationsManage._wired){
        locationsManage._wired = true;
        locationsManage.addEventListener('click', ()=>{
          setOnboardingMessage('onboardingLocationsMsg', '');
          if(!canAccessCompanyLocations()){
            setOnboardingMessage('onboardingLocationsMsg', 'Ask an admin to manage locations for your company.');
            return;
          }
          void openCompanyLocationsModal();
        });
      }
      const locationsContinue = $('btnOnboardingLocationsContinue');
      if(locationsContinue && !locationsContinue._wired){
        locationsContinue._wired = true;
        locationsContinue.addEventListener('click', ()=>{
          void handleOnboardingLocationsContinue();
        });
      }
      const inviteOpen = $('btnOnboardingInviteOpen');
      if(inviteOpen && !inviteOpen._wired){
        inviteOpen._wired = true;
        inviteOpen.addEventListener('click', ()=>{
          if(!canAccessInvites()){
            setOnboardingMessage('onboardingInvitesMsg', 'Invites require Business tier and invite permissions. You can skip for now.');
            return;
          }
          show('inviteModal', true);
        });
      }
      const invitesRefresh = $('btnOnboardingInvitesRefresh');
      if(invitesRefresh && !invitesRefresh._wired){
        invitesRefresh._wired = true;
        invitesRefresh.addEventListener('click', ()=>{
          void refreshPendingInvites();
        });
      }
      const invitesSkip = $('btnOnboardingInvitesSkip');
      if(invitesSkip && !invitesSkip._wired){
        invitesSkip._wired = true;
        invitesSkip.addEventListener('click', ()=>{
          void handleOnboardingInvitesSkip();
        });
      }
      const invitesContinue = $('btnOnboardingInvitesContinue');
      if(invitesContinue && !invitesContinue._wired){
        invitesContinue._wired = true;
        invitesContinue.addEventListener('click', ()=>{
          void handleOnboardingInvitesContinue();
        });
      }
      const finishBtn = $('btnOnboardingFinish');
      if(finishBtn && !finishBtn._wired){
        finishBtn._wired = true;
        finishBtn.addEventListener('click', ()=>{
          void handleOnboardingFinish();
        });
      }
    }
    async function handleOnboardingRoute(){
      const active = isOnboardingRoute();
      setOnboardingRouteActive(active);
      if(!active) return false;
      loadOnboardingIntent();
      renderOnboardingPlanSummary();

      if(!SB.ready){
        setOnboardingGate({
          title:'Supabase not configured',
          message:'Connect Supabase to continue onboarding.',
          primaryLabel:'Close',
          primaryAction:()=>{ show('authModal', false); },
          secondaryLabel:''
        });
        return true;
      }

      if(!SB.session){
        // Self-service signup flow - show account creation step
        _signupMode = true;
        _signupPlan = state._onboardingIntent?.plan || '';
        setOnboardingGate({ show: false });
        renderOnboardingStep('account');
        renderSignupProgress(1);
        if(state._signupError){
          setSignupMessage(state._signupError, true);
          state._signupError = '';
        }
        return true;
      }

      if(isEffectiveSuperUser() && !state._onboardingAllowSuper){
        setOnboardingGate({
          title:'Super users can bypass onboarding',
          message:'You can skip onboarding and go straight to the dashboard.',
          primaryLabel:'Go to Dashboard',
          primaryAction:()=>{ redirectToAppHome(); },
          secondaryLabel:'Continue onboarding',
          secondaryAction:()=>{ state._onboardingAllowSuper = true; void handleOnboardingRoute(); }
        });
        return true;
      }

      if(!SB.companyId){
        // User has account but no company - show company creation step
        _signupMode = true;
        _signupPlan = state._onboardingIntent?.plan || '';
        setOnboardingGate({ show: false });
        renderOnboardingStep('company');
        renderSignupProgress(2);
        return true;
      }

      // Track onboarding company for invite dropdown
      _onboardingCompanyId = String(SB.companyId);

      setOnboardingGate({ show:false });
      setOnboardingMessage('onboardingProfileMsg', '');
      setOnboardingMessage('onboardingLocationsMsg', '');
      setOnboardingMessage('onboardingInvitesMsg', '');
      setOnboardingMessage('onboardingFinishMsg', '');

      try{
        state._onboardingState = await fetchOnboardingState();
      }catch(e){
        setOnboardingGate({
          title:'Unable to load onboarding',
          message:e && e.message ? e.message : 'Try again in a moment.',
          primaryLabel:'Retry',
          primaryAction:()=>{ void handleOnboardingRoute(); },
          secondaryLabel:''
        });
        return true;
      }

      if(state._onboardingState === 'ONBOARDING_COMPLETE'){
        redirectToAppHome();
        return true;
      }

      const stepIndex = getOnboardingStepFromState(state._onboardingState);
      const stepId = stepIndex === 1 ? 'profile' : stepIndex === 2 ? 'locations' : stepIndex === 3 ? 'invites' : 'finish';
      state._onboardingStep = stepId;
      renderOnboardingProgress(stepIndex);
      renderOnboardingStep(stepId);

      if(stepId === 'profile'){
        try{
          const profile = await loadOnboardingCompanyProfile();
          applyOnboardingProfileToForm(profile);
        }catch(e){
          setOnboardingMessage('onboardingProfileMsg', e && e.message ? e.message : 'Unable to load profile.');
        }
        renderOnboardingReceiptForwarding();
      }

      if(stepId === 'locations'){
        try{
          const rows = await sbFetchCompanyLocations();
          renderOnboardingLocationsStatus(rows);
          if(!canAccessCompanyLocations()){
            setOnboardingMessage('onboardingLocationsMsg', 'Ask an admin to manage locations for your company.');
          }
        }catch(e){
          setOnboardingMessage('onboardingLocationsMsg', e && e.message ? e.message : 'Unable to load locations.');
        }
      }

      if(stepId === 'invites'){
        attachPendingInvitesToOnboarding();
        _userMgmtCompanyId = SB.companyId ? String(SB.companyId) : '';
        renderOnboardingInviteNotice();
        try{
          await refreshPendingInvites();
        }catch(e){}
      }else{
        restorePendingInvitesToUserMgmt();
      }

      return true;
    }

    // Boot
      document.addEventListener('DOMContentLoaded', async ()=>{
      load();
      loadInventoryQuickFilter();
      render();
      updateInventoryStickyOffset();
      initColumnBuilder();
      initInventoryViews();
      initInventoryTabs();
      initButtonSystem();
      storeOnboardingIntentFromUrl();
      loadOnboardingIntent();
      renderOnboardingPlanSummary();
      setOnboardingRouteActive(isOnboardingRoute());
      wireOnboardingEvents();
      try{ setEditHint(); }catch(e){}
      try{
        adjustTitleSize();
        if(document.fonts && document.fonts.ready){
          document.fonts.ready.then(()=>{
            requestAnimationFrame(adjustTitleSize);
            updateInventoryStickyOffset();
          });
        }
      }catch(e){}
      const fb=$('filterBox'); if(fb){
        fb.value=state._filter||'';
        updateFilterClearBtn();
        fb.addEventListener('input', ()=>{ state._filter=fb.value; renderTable(); save(); updateFilterClearBtn(); try{ if(_invViewMode === 'cards') renderInventoryCards(); }catch(e){} });
        fb.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && fb.value){ e.preventDefault(); fb.value=''; state._filter=''; renderTable(); save(); updateFilterClearBtn(); try{ if(_invViewMode === 'cards') renderInventoryCards(); }catch(e){} }});
      }
	      const clr=$('btnClearFilter'); if(clr && fb){
	        clr.addEventListener('click', ()=>{
	          if(!fb.value) return;
	          fb.value='';
	          state._filter='';
          renderTable();
          save();
          updateFilterClearBtn();
          try{ if(_invViewMode === 'cards') renderInventoryCards(); }catch(e){}
          try{ fb.focus(); }catch(e){}
	        });
	      }
      const quickFilters = $('invQuickFilters');
      if(quickFilters && !quickFilters._wired){
        quickFilters._wired = true;
        quickFilters.addEventListener('click', (e)=>{
          const btn = e.target && e.target.closest ? e.target.closest('[data-filter]') : null;
          if(!btn) return;
          const key = btn.getAttribute('data-filter');
          setInventoryQuickFilter(key);
        });
      }
      updateQuickFilterPills();

	      // Order counter badge - delegated handler for all [data-order-reset] elements
	      document.addEventListener('click', (e)=>{
	        const badge = e.target.closest('[data-order-reset]');
	        if(!badge) return;
	        e.preventDefault();
	        clearAllOrderLines();
	        toast('Shopping cart cleared');
	        try{ syncReportOrderIndicators(); }catch(ex){}
	      });
	      // Order pill "Create Order" buttons (main + report modal)
	      const orderPillOpen = $('orderPillOpen');
	      if(orderPillOpen){
	        orderPillOpen.addEventListener('click', (e)=>{
	          e.preventDefault();
	          openOrderModal();
	        });
	      }
	      const reportOrderPillOpen = $('reportOrderPillOpen');
	      if(reportOrderPillOpen){
	        reportOrderPillOpen.addEventListener('click', (e)=>{
	          e.preventDefault();
	          show('reportModal', false);
	          openOrderModal();
	        });
	      }
	      try{ updateOrderCounterBadge(); }catch(e){}

	      // iOS-style qty picker - event handlers
	      const qtyPickerCancel = $('qtyPickerCancel');
	      const qtyPickerDone = $('qtyPickerDone');
	      const qtyPickerWheel = $('qtyPickerWheel');
	      if(qtyPickerCancel) qtyPickerCancel.addEventListener('click', closeQtyPicker);
	      if(qtyPickerDone) qtyPickerDone.addEventListener('click', handleQtyPickerDone);

	      // Wheel touch/mouse drag
	      if(qtyPickerWheel){
	        const getY = (e) => e.touches ? e.touches[0].clientY : e.clientY;
	        qtyPickerWheel.addEventListener('touchstart', (e)=>{
	          _qtyPicker.isDragging = true;
	          _qtyPicker.startY = getY(e);
	          _qtyPicker.startScrollY = _qtyPicker.scrollY;
	          qtyPickerWheel.style.transition = '';
	        }, { passive: true });
	        qtyPickerWheel.addEventListener('touchmove', (e)=>{
	          if(!_qtyPicker.isDragging) return;
	          const deltaY = getY(e) - _qtyPicker.startY;
	          _qtyPicker.scrollY = _qtyPicker.startScrollY + deltaY;
	          // Clamp scroll
	          const minScroll = -_qtyPicker.maxQty * 36;
	          _qtyPicker.scrollY = Math.max(minScroll, Math.min(0, _qtyPicker.scrollY));
	          qtyPickerWheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
	          updateQtyPickerSelection();
	        }, { passive: true });
	        qtyPickerWheel.addEventListener('touchend', ()=>{
	          _qtyPicker.isDragging = false;
	          snapQtyPicker();
	        });
	        // Click on item to select
	        qtyPickerWheel.addEventListener('click', (e)=>{
	          const item = e.target.closest('.qty-picker-item');
	          if(!item) return;
	          const qty = parseInt(item.dataset.qty, 10);
	          if(!isNaN(qty)){
	            _qtyPicker.selectedQty = qty;
	            _qtyPicker.scrollY = -qty * 36;
	            snapQtyPicker();
	          }
	        });
	      }

	      // Long-press on qty stepper in order modal to open picker
	      let _longPressTimer = null;
	      const orderLinesBody = $('orderLinesBody');
	      if(orderLinesBody){
	        orderLinesBody.addEventListener('touchstart', (e)=>{
	          const trigger = e.target.closest('[data-qty-picker-trigger]');
	          if(!trigger) return;
	          const id = trigger.dataset.qtyPickerTrigger;
	          _longPressTimer = setTimeout(()=>{
	            const ord = orderState();
	            const line = ord.lines.find(l => l.id === id);
	            if(line){
	              openQtyPicker(id, line.name, toInt(line.qty, 0));
	            }
	            _longPressTimer = null;
	          }, 500);
	        }, { passive: true });
	        orderLinesBody.addEventListener('touchend', ()=>{
	          if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer = null; }
	        });
	        orderLinesBody.addEventListener('touchmove', ()=>{
	          if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer = null; }
	        }, { passive: true });
	      }

      const mobileSort = $('mobileSort');
      if(mobileSort){
        mobileSort.addEventListener('change', ()=>{
          const raw = String(mobileSort.value || '');
          const parts = raw.split(':');
          const col = (parts[0] || '').trim();
          const dir = (parts[1] || '').trim() === 'desc' ? 'desc' : 'asc';
          if(!col){
            state._sort = null;
            renderTable();
            if(_invViewMode === 'cards') renderInventoryCards();
            save();
            return;
          }
          const visibleDefs = getInventorySortDefs();
          const visibleCols = new Set(visibleDefs.map(def => (def.dataCol || def.key)).filter(Boolean));
          if(!visibleCols.has(col)){
            state._sort = null;
          }else{
            state._sort = { col, dir };
          }
          renderTable();
          if(_invViewMode === 'cards') renderInventoryCards();
          save();
        });
      }

	      bindInventorySortHandlers();

	      // Supabase init and health check
	      try{
        sbInit();
        updateStatusBar();
        await sbAuthBoot();
      }catch(e){
        console.warn('Startup error', e);
        SB.connected = false;
        updateStatusBar();
      }

      // Keep the status fresh
      window.addEventListener('online', checkServerHealth);
      window.addEventListener('offline', checkServerHealth);
	      setInterval(checkServerHealth, 15000);
	
	      // Responsive: recompute inventory column layout on viewport change
	      window.addEventListener('resize', ()=> {
	        try{ scheduleInventoryLayoutRefresh(); }catch(e){}
	        try{ updateInventoryStickyOffset(); }catch(e){}
	      });
	
	      // Close modals when clicking outside (on backdrop)
	      document.addEventListener('click', (e)=>{
	        const modalBackdrop = e.target.closest('.modal-backdrop');
	        if(modalBackdrop && e.target === modalBackdrop){
	          if(modalBackdrop.id === 'editItemModal') return;
	          show(modalBackdrop.id, false);
        }
      });

      if('serviceWorker' in navigator){
        // Listen for SW activation and update flow
        let _swReloaded = false;
        navigator.serviceWorker.addEventListener('controllerchange', ()=>{
          if(_swReloaded) return; _swReloaded = true;
          try{ toast('App updated. Reloadingâ€¦'); }catch{}
          setTimeout(()=> location.reload(), 400);
        });
        navigator.serviceWorker.addEventListener('message', (e)=>{
          if(!e || !e.data) return;
          if(e.data.type === 'SW_ACTIVATED'){
            // No-op: controllerchange handler above will handle reload UX
          }
        });
        navigator.serviceWorker.register('./sw.js?v=14', { scope: './' }).catch(console.warn);
      }
    });
  </script>
</body>
</html>
