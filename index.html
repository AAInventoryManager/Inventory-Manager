<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="manifest" href="./manifest.webmanifest?v=11" />
  <link rel="icon" type="image/svg+xml" href="./assets/modulus/favicon/favicon-light.svg?v=2" media="(prefers-color-scheme: light)" />
  <link rel="icon" type="image/svg+xml" href="./assets/modulus/favicon/favicon-dark.svg?v=2" media="(prefers-color-scheme: dark)" />
  <link rel="icon" href="./assets/modulus/favicon/favicon.ico?v=2" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@600;700;800&display=swap" rel="stylesheet">
  <title>Inventory Manager by Modulus Software, LLC</title>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- Optional: set your Supabase URL and anon key here -->
  <script>
    // Supabase project credentials (safe to expose anon public key in client)
    window.SB_URL  = window.SB_URL || "https://entmbaxeylglposptsuy.supabase.co";
    window.SB_ANON = window.SB_ANON || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVudG1iYXhleWxnbHBvc3B0c3V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ2NjEsImV4cCI6MjA3MjQ5MDY2MX0.vDTzhL0Q-iDZShWu2hcaYOavPLltY31OThXj-ohBjAc";
  </script>

  <script>
  // Lightweight observability: log JS errors so users can screenshot
  window.addEventListener('error', e => console.log('JS Error:', e.message, e.error));
  window.addEventListener('unhandledrejection', e => console.log('Promise Rejection:', e.reason));
  </script>

  <style>
    :root{
      --bg:#24292d;--fg:#eaeff7;--muted:#a9b4c0;--accent:#5aa9ff;
      --card:#000000;--border:#1f2a36;--title-min:12px;--title-max:56px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);color:var(--fg);overflow-x:hidden
    }
    @media (pointer: fine){
      body{ min-width:390px; }
    }
    header{
      padding:calc(10px + env(safe-area-inset-top)) 16px 8px;
      border-bottom:1px solid var(--border);
      position:sticky;top:0;background:var(--bg);z-index:20;text-align:center;
    }
    .header-inner{ max-width:1100px; margin:0 auto; padding:0 24px; }
.status{margin-top:8px;display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#0d1420;color:#9fb3c8;appearance:none;-webkit-appearance:none;cursor:pointer;text-align:left}
.status.online{color:#ffffff;background:#0f2d18;border-color:#1b5432}
.status.offline{color:#ffffff;background:#2a1212;border-color:#5a1c1c}
    h1{margin:0;text-align:left;font-family:'Barlow',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; font-weight:800; font-size:clamp(var(--title-min), 6vw, var(--title-max)); letter-spacing:1px}
    main{padding:12px;max-width:1100px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .toolbar .spacer{flex:1}
    .btn{
      cursor:pointer;border:1px solid var(--border);background:#101826;color:#fff;
      padding: clamp(10px, 2.2vw, 12px) clamp(12px, 3vw, 14px);
      border-radius:10px;font-weight:600;
      font-size: clamp(14px, 2.8vw, 16px);
      line-height:1.1; white-space:nowrap; min-height:44px
    }
    .btn.small{
      padding:8px 10px;
      font-size:13px;
      min-height:36px;
    }
    .btn.btn-icon{
      padding:10px;
      min-height:44px;
      min-width:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn.primary{background:var(--accent);color:#06121f;border-color:transparent}
    .btn.danger{background:#2a1212;color:#fff;border-color:#5a1c1c}
    .btn.danger:hover{background:#351414}
    .edit-footer .btn.danger{ margin-right:auto }
    .btn:disabled{ opacity:.55; cursor:not-allowed }
    /* Modern toggle switch */
    .toggle-switch{
      position:relative;
      width:48px;
      height:26px;
      flex-shrink:0;
    }
    .toggle-switch input{
      opacity:0;
      width:0;
      height:0;
      position:absolute;
    }
    .toggle-slider{
      position:absolute;
      cursor:pointer;
      inset:0;
      background:#374151;
      border-radius:26px;
      transition:background 0.25s ease, box-shadow 0.25s ease;
    }
    .toggle-slider::before{
      content:'';
      position:absolute;
      width:20px;
      height:20px;
      left:3px;
      bottom:3px;
      background:#fff;
      border-radius:50%;
      transition:transform 0.25s ease;
      box-shadow:0 1px 3px rgba(0,0,0,0.3);
    }
    .toggle-switch input:checked + .toggle-slider{
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.4);
    }
    .toggle-switch input:checked + .toggle-slider::before{
      transform:translateX(22px);
    }
    .toggle-switch input:focus + .toggle-slider{
      box-shadow:0 0 0 2px rgba(34,197,94,0.3);
    }
    .muted{color:var(--muted);font-size:12px}
    .time{font-size:12px;color:var(--muted)}
    .scroll{overflow:auto;max-height:70vh;border-radius:10px;position:relative;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
    #tableWrap{ overflow-x:auto; position:relative; }
    table{width:100%;border-collapse:collapse;font-size:15px}
    #invTable{ min-width:760px; }
	    thead th{
	      text-align:center;color:#e2e8f0;font-weight:700;border-bottom:2px solid var(--border);
	      padding:14px 12px;position:sticky;top:0;background:#0d1117;z-index:7;
	      text-transform:uppercase;font-size:12px;letter-spacing:0.5px;
	      white-space:nowrap;
	    }
	    #invTable thead th::after{
	      content:'';
	      position:absolute;
	      right:0;
	      top:8px;
	      bottom:8px;
	      width:2px;
	      background:rgba(148,163,184,0.55);
	    }
	    #invTable thead th:last-child::after{ display:none; }
	    /* Table header alignment + contrast */
    #invTable thead th[data-col="name"],
    #invTable thead th[data-col="desc"]{
      text-align:left;
    }
	    #invTable thead th.col-resize-hot{
	      cursor:col-resize;
	    }
	    #invTable thead th.col-resize-hot::after{
	      width:2px;
	      background:rgba(226,232,240,0.75);
	    }
    #tableWrap .col-resize-guide{
      position:absolute;
      top:0;
      bottom:0;
      width:2px;
      background:rgba(148,163,184,0.8);
      box-shadow:0 0 0 1px rgba(15,23,42,0.6);
      pointer-events:none;
      display:none;
      z-index:8;
    }
    body.col-resize-active{
      cursor:col-resize;
      user-select:none;
    }
	    #invTable tbody td[data-col="name"] .cell-val{ font-weight:900; }
	    #invTable tbody td[data-col="desc"] .cell-val{ color:var(--muted); }
    th.sortable{ cursor:default; user-select:none }
    th.sortable .sort-ind{
      margin-left:6px;
      display:inline-block;
      cursor:pointer;
      padding:4px 6px;
      border-radius:4px;
      transition:background 0.15s, opacity 0.15s;
    }
    th.sortable .sort-ind:hover{ background:rgba(148,163,184,0.2) }
    th.sorted-asc .sort-ind::before{ content:'\25B2'; opacity:1 }
    th.sorted-desc .sort-ind::before{ content:'\25BC'; opacity:1 }
    tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
    td.actions{padding:8px 6px;text-align:right}
    .actions-wrap{display:inline-flex;gap:8px;align-items:center;justify-content:flex-end}
    .row-order-btn{
      background:none;
      border:none;
      cursor:pointer;
      padding:6px;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:6px;
      position:relative;
      transition:background 0.15s,color 0.15s;
      touch-action:manipulation;
      -webkit-appearance:none;
      appearance:none;
    }
    .row-order-btn svg{
      width:18px;
      height:18px;
      display:block;
    }
    .row-order-btn:hover{background:rgba(34,197,94,0.15);color:#34d399}
    .row-order-btn.row-order-btn--active{
      background:rgba(34,197,94,0.22);
      color:#34d399;
    }
    .row-order-btn:disabled{
      opacity:0.35;
      cursor:not-allowed;
    }
    .row-order-btn:disabled:hover{
      background:transparent;
      color:var(--muted);
    }
					    .row-delete-btn{
					      background:none;
					      border:none;
					      cursor:pointer;
					      padding:6px;
				      color:var(--muted);
				      display:inline-flex;
				      align-items:center;
				      justify-content:center;
				      border-radius:6px;
				      position:relative;
				      transition:background 0.15s,color 0.15s;
				      touch-action:manipulation;
				      -webkit-appearance:none;
				      appearance:none;
				    }
				    .row-delete-btn:disabled{
				      opacity:0.35;
				      cursor:not-allowed;
				    }
				    .row-delete-btn:disabled:hover{
				      background:transparent;
				      color:var(--muted);
				    }
				    .row-delete-btn svg{
				      width:18px;
				      height:18px;
				      display:block;
				    }
					    .row-delete-btn:hover{background:rgba(255,80,80,0.15);color:#ff6b6b}
					    /* Hidden by default (mobile-only UI elements) */
					    .card-leds,
					    .card-tray{
				      display:none;
				    }
				    @media (hover: hover) and (pointer: fine){
				      #invTable tbody tr[data-id]{
				        transition: filter 160ms ease;
				        transition-delay: 0ms;
				        filter:none;
				      }
				      #invTable tbody tr[data-id]:hover{
				        transition-delay: 200ms; /* avoids flicker while scrolling */
				        filter:
				          drop-shadow(0 0 16px rgba(135,245,255,0.24))
				          drop-shadow(0 0 46px rgba(135,245,255,0.08));
				      }
				      #invTable tbody tr.order-selected{
				        background:
				          radial-gradient(220px 120px at 40% 35%, rgba(34,197,94,0.20), rgba(34,197,94,0) 70%),
				          linear-gradient(145deg, rgba(34,197,94,0.12) 0%, #12161c 100%);
				      }
				      #invTable tbody tr.order-selected td{
				        background:transparent;
				        border-bottom-color: rgba(34,197,94,0.28);
				      }
				      #invTable tbody td[data-col="name"] .cell-val,
				      #invTable tbody td[data-col="desc"] .cell-val{
				        display:block;
				        white-space:nowrap;
				        overflow:hidden;
				        text-overflow:clip;
				      }
				    }
				    /* Mobile table layout: stack fields vertically per record */
					    @media (pointer: coarse){
					      /* Ensure last card can scroll above mobile browser UI controls */
					      #tableWrap{
					        box-sizing:border-box;
					        padding-bottom:env(safe-area-inset-bottom);
					        scroll-padding-bottom:env(safe-area-inset-bottom);
					      }
					      #invTable{ min-width:0; }
					      #invTable thead{ display:none; }
					      #invTable tbody tr[data-id]{
				        position:relative;
				        isolation:isolate;
			        display:block;
			        --swipe-x: 0px;
			        --tray-progress: 0;
			        --tray-outer: 0;
			        --tray-inner: 0;
			        --focus-y: 0px;
			        --spot-i: 0;
			        --spot-a0: 0;
			        --spot-a1: 0;
			        --spot-a2: 0;
			        --spot-x: 0px;
			        --spot-y: 0px;
			        --spot-rx: 120px;
			        --spot-ry: 74px;
			        padding:6px; /* tighter cards to reduce scrolling */
			        border-radius:14px;
			        border:none;
			        background:none;
			        box-shadow:none;
			        margin:0 0 6px 0;
			        touch-action: pan-y;
			        transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
			        will-change: transform, box-shadow;
			        transform: translateX(var(--swipe-x)) translateY(var(--focus-y));
				      }
				      /* Elastic snap-back animation when releasing from detent */
				      #invTable tbody tr[data-id].snap-elastic{
				        transition: transform 380ms cubic-bezier(0.175, 0.885, 0.32, 1.175) !important;
				      }
				      /* iMessage-style swipe layering: tray behind a card surface */
				      #invTable tbody tr[data-id]::after{
				        content:'';
				        position:absolute;
				        inset:0;
				        border:1px solid var(--border);
				        border-radius:14px;
				        background: linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
				        box-shadow:0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
				        transition: border-color 180ms ease, box-shadow 180ms ease;
				        z-index:2;
				        pointer-events:none;
				      }
				      #invTable tbody tr[data-id].order-selected::after{
				        background:
				          radial-gradient(200px 110px at 50% 40%, rgba(34,197,94,0.20), rgba(34,197,94,0) 70%),
				          linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%) !important;
				        box-shadow:
				          0 0 0 1px rgba(34,197,94,0.12),
				          0 0 16px rgba(34,197,94,0.10),
				          0 2px 8px rgba(0,0,0,0.3),
				          inset 0 1px 0 rgba(255,255,255,0.05) !important;
				      }
		      #invTable tbody tr[data-id] td{
		        display:block;
		        width:100%;
		        padding:0;
		        border-bottom:none;
		        position:relative;
		      }
		      #invTable tbody tr[data-id] td[data-col]::before,
		      #invTable tbody tr[data-id] td[data-col] .cell-val,
		      #invTable tbody tr[data-id] td[data-col="qty"] .qty-stepper{
		        position:relative;
		        z-index:3;
		      }
			      #invTable tbody tr[data-id] td[data-col]{
			        padding:2px 0;
			      }
				      #invTable tbody tr[data-id] td[data-col="name"]{
				        padding-left:0;
				        padding-right:0;
				        min-height:0;
				        position:static; /* Allow tray to position relative to tr, not td */
				      }
				      #invTable tbody tr[data-id] td[data-col="desc"]{ padding-left:0; }
				      #invTable tbody tr[data-id] td[data-col]::before{
				        display:block;
				        font-size:10px;
				        letter-spacing:.08em;
				        text-transform:uppercase;
				        color:var(--muted);
				        margin:0 0 4px 0;
				        text-align:left;
				      }
				      /* Mobile UX v2: remove Item/Description labels to reduce vertical height */
				      #invTable tbody tr[data-id] td[data-col="name"]::before{ content:''; display:none; }
				      #invTable tbody tr[data-id] td[data-col="desc"]::before{ content:''; display:none; }
				      #invTable tbody tr[data-id] td[data-col="qty"]::before{ content:''; display:none; }

				      #invTable tbody tr[data-id] td[data-col="name"] .cell-val{ font-weight:900; }
				      #invTable tbody tr[data-id] td[data-col="desc"] .cell-val{
				        color:var(--muted);
				        font-size:12px;
				        white-space:nowrap;
				        overflow:hidden;
				        text-overflow:ellipsis;
				        display:block;
		      }

						      #invTable tbody tr[data-id] td[data-col="qty"]{ text-align:center; }
						      /* Mobile: compact cards by default (tap card to expand qty stepper) */
						      #invTable tbody tr[data-id] td[data-col="qty"]{
						        max-height:0;
						        opacity:0;
						        overflow:hidden;
						        padding:0;
						        margin:0;
						        pointer-events:none;
						        transition: max-height 240ms ease, opacity 240ms ease, padding 240ms ease, margin-top 240ms ease;
						      }
						      #invTable tbody tr[data-id].card-expanded td[data-col="qty"]{
						        max-height:96px;
						        opacity:1;
						        padding:6px 0 2px;
						        margin-top:6px;
						        pointer-events:auto;
						      }
						      
						      /* Mobile UX v2: no checkbox selection + no inline action buttons */
						      #invTable tbody tr[data-id] td.sel{ display:none !important; }
						      #invTable tbody tr[data-id] td.actions{ display:none !important; }

			      /* Mobile UX v2: order/override LEDs */
			      #invTable tbody tr[data-id] .card-leds{
			        position:absolute;
			        top:8px;
			        right:8px;
			        display:flex;
			        gap:6px;
			        pointer-events:none;
			        z-index:4;
			      }
			      #invTable tbody tr[data-id] .card-led{
			        width:10px;
			        height:10px;
			        border-radius:50%;
			        background:rgba(148,163,184,0.55); /* muted/off */
			        border:1px solid rgba(0,0,0,0.65);
			        box-shadow:0 0 0 1px rgba(255,255,255,0.08);
			        transition: background 200ms ease, box-shadow 200ms ease, filter 200ms ease;
			      }
			      #invTable tbody tr[data-id] .card-led.card-led--on{ filter:saturate(1.15); }
			      #invTable tbody tr[data-id] .card-led.card-led--lowstock.card-led--on{
			        background:#f59e0b;
			        box-shadow: 0 0 10px rgba(245,158,11,0.45), 0 0 0 1px rgba(255,255,255,0.10);
			      }
			      #invTable tbody tr[data-id] .card-led.card-led--lowstock.card-led--outofstock{
			        background:#ef4444;
			        box-shadow: 0 0 10px rgba(239,68,68,0.5), 0 0 0 1px rgba(255,255,255,0.10);
			      }

				      /* Mobile UX v2: iMessage-style swipe tray (Edit / Order) */
				      #invTable tbody tr[data-id] .card-tray{
				        position:absolute;
				        inset:0;
				        transform:translateX(calc(0px - var(--swipe-x, 0px)));
				        display:flex;
				        flex-direction:row;
				        align-items:center;
				        justify-content:flex-end;
				        gap:8px;
				        opacity:1;
				        pointer-events:none;
				        z-index:1;
				      }
				      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray{
				        justify-content:flex-start;
				      }
				      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray{
				        justify-content:flex-end;
				      }
				      #invTable tbody tr[data-id].tray-open .card-tray{
				        pointer-events:auto;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn{
				        width:86px;
				        height:100%;
				        border:0;
				        border-radius:0;
				        background:transparent;
				        color:#e5e7eb;
				        display:flex;
				        align-items:center;
				        justify-content:center;
				        padding:4px;
				        cursor:pointer;
				        touch-action:manipulation;
				        -webkit-appearance:none;
				        appearance:none;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn:active{
				        filter:brightness(0.96);
				      }

				      #invTable tbody tr[data-id] .card-tray-btn svg{
				        width:55px;
				        height:55px;
				        display:block;
				        opacity:0;
				        transform:scale(0.4);
				        transition: opacity 160ms ease, transform 160ms ease;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn svg *{
				        stroke-width:2.4px;
				      }

					      /* High-contrast strokes (no action background colors) */
						      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="edit"]{
						        color:#22c55e;
						      }
						      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="order"]{
					        color:#22c55e;
					      }
					      /* Subtle green tint behind the order tray (swipe-right) */
					      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray{
					        background: linear-gradient(90deg, rgba(34,197,94,0.14) 0%, rgba(34,197,94,0.0) 72%);
					      }

				      /* Sequential icon reveal: outer icon first, then inner icon */
				      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray-btn:last-child svg{
				        opacity: var(--tray-outer, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
			      }
			      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray-btn:first-child svg{
			        opacity: var(--tray-inner, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-inner, 0))));
			      }
			      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray-btn:first-child svg{
			        opacity: var(--tray-outer, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
			      }
				      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray-btn:last-child svg{
				        opacity: var(--tray-inner, 0);
				        transform: scale(calc(0.4 + (0.6 * var(--tray-inner, 0))));
				      }
				      /* Single-icon tray (order): reveal uses outer progress */
				      #invTable tbody tr[data-id][data-tray-side] .card-tray-btn:only-child svg{
				        opacity: var(--tray-outer, 0);
				        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
				      }

				      /* Rounded outer corners to match the card */
				      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray-btn:last-child{
				        border-top-right-radius:14px;
			        border-bottom-right-radius:14px;
			      }
			      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray-btn:first-child{
			        border-top-left-radius:14px;
			        border-bottom-left-radius:14px;
			      }

				      /* Glow effect on edit icon - fades in based on --commit-progress variable */
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="edit"] svg{
				        filter: drop-shadow(0 0 calc(16px * var(--commit-progress, 0)) rgba(34,197,94, var(--commit-progress, 0)));
				      }
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="order"] svg{
				        filter: drop-shadow(0 0 calc(14px * var(--commit-progress, 0)) rgba(34,197,94, var(--commit-progress, 0)));
				      }
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="order"] .order-check{
				        opacity:0;
				        transition: opacity 160ms ease;
				      }
				      #invTable tbody tr[data-id].order-selected .card-tray-btn[data-tray-action="order"] .order-check{
				        opacity:1;
				      }
				      /* Elastic stretch effect on edit icon when approaching commit threshold */
				      #invTable tbody tr[data-id].commit-armed .card-tray-btn[data-tray-action="edit"] svg{
				        transform: scale(1.03) !important;
				      }

				      /* Mobile UX v2: ensure steppers meet 48×48 target */
				      .qty-step{ min-width:48px; min-height:48px; }
				      .qty-stepper--table .qty-step{ min-width:48px; }
				      #invTable tbody tr[data-id] .qty-stepper.qty-stepper--table{ gap:8px; }
				      #invTable tbody tr[data-id] .qty-stepper--table .qty-value{
				        min-width:3.25rem;
				        height:48px;
				        display:inline-flex;
				        align-items:center;
				        justify-content:center;
				        font-size:22px;
				        font-weight:900;
				      }
				      #invTable tbody tr[data-id].swiping .card-tray,
				      #invTable tbody tr[data-id].swiping .card-tray-btn,
				      #invTable tbody tr[data-id].swiping .card-tray-btn svg{ transition:none !important; }
				      #invTable tbody tr[data-id].swiping{ transition:none !important; }

				      /* Order History (mobile): swipe actions (Receive / Delete) */
				      #orderHistoryList .history-actions{ display:none; }
				      #orderHistoryList details.history-item{
				        position:relative;
				        isolation:isolate;
				        --swipe-x: 0px;
				        --tray-progress: 0;
				        --tray-outer: 0;
				        --tray-inner: 0;
				        --commit-progress: 0;
				        border:none;
				        background:none;
				        touch-action: pan-y;
				        transition: transform 180ms ease;
				        will-change: transform;
				        transform: translateX(var(--swipe-x));
				      }
				      #orderHistoryList details.history-item.snap-elastic{
				        transition: transform 380ms cubic-bezier(0.175, 0.885, 0.32, 1.175) !important;
				      }
				      #orderHistoryList details.history-item::after{
				        content:'';
				        position:absolute;
				        inset:0;
				        border:1px solid var(--border);
				        border-radius:12px;
				        background:#000;
				        box-shadow:0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
				        z-index:2;
				        pointer-events:none;
				      }
				      #orderHistoryList details.history-item .history-header,
				      #orderHistoryList details.history-item .history-meta,
				      #orderHistoryList details.history-item .history-body{
				        position:relative;
				        z-index:3;
				      }
				      #orderHistoryList details.history-item .history-address{
				        margin-top:4px;
				        white-space:pre-wrap;
				      }
				      #orderHistoryList details.history-item summary::after{
				        position:relative;
				        z-index:3;
				      }
				      #orderHistoryList details.history-item .history-tray{
				        position:absolute;
				        inset:0;
				        transform:translateX(calc(0px - var(--swipe-x, 0px)));
				        display:flex;
				        flex-direction:row;
				        align-items:center;
				        justify-content:space-between;
				        gap:8px;
				        opacity:1;
				        pointer-events:none;
				        z-index:1;
				      }
				      #orderHistoryList details.history-item.tray-open .history-tray{
				        pointer-events:auto;
				      }
				      #orderHistoryList details.history-item[data-tray-side="left"] .history-tray{
				        background: linear-gradient(90deg, rgba(239,68,68,0.18) 0%, rgba(239,68,68,0) 72%);
				      }
				      #orderHistoryList details.history-item[data-tray-side="right"] .history-tray{
				        background: linear-gradient(270deg, rgba(59,130,246,0.18) 0%, rgba(59,130,246,0) 72%);
				      }
				      #orderHistoryList details.history-item .history-tray-btn{
				        width:86px;
				        height:100%;
				        border:0;
				        border-radius:0;
				        background:transparent;
				        color:#e5e7eb;
				        display:flex;
				        align-items:center;
				        justify-content:center;
				        padding:4px;
				        cursor:pointer;
				        touch-action:manipulation;
				        -webkit-appearance:none;
				        appearance:none;
				      }
				      #orderHistoryList details.history-item .history-tray-btn--delete{ color:#ef4444; }
				      #orderHistoryList details.history-item .history-tray-btn--receive{ color:#3b82f6; }
				      #orderHistoryList details.history-item .history-tray-btn--delete{
				        border-top-left-radius:12px;
				        border-bottom-left-radius:12px;
				      }
				      #orderHistoryList details.history-item .history-tray-btn--receive{
				        border-top-right-radius:12px;
				        border-bottom-right-radius:12px;
				      }
				      #orderHistoryList details.history-item .history-tray-btn svg{
				        width:55px;
				        height:55px;
				        display:block;
				        opacity:0;
				        transform:scale(0.4);
				        transition: opacity 160ms ease, transform 160ms ease, filter 160ms ease;
				      }
				      #orderHistoryList details.history-item .history-tray-btn svg *{
				        stroke-width:2.4px;
				      }
				      #orderHistoryList details.history-item .history-tray-btn--receive .recv-check{
				        opacity:0;
				        transition: opacity 160ms ease;
				      }
				      #orderHistoryList details.history-item.order-received .history-tray-btn--receive .recv-check{
				        opacity:1;
				      }

				      /* Reveal: only the active-side icon animates in */
				      #orderHistoryList details.history-item[data-tray-side="left"] .history-tray-btn--delete svg{
				        opacity: var(--tray-outer, 0);
				        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
				        filter: drop-shadow(0 0 calc(14px * var(--commit-progress, 0)) rgba(239,68,68, var(--commit-progress, 0)));
				      }
				      #orderHistoryList details.history-item[data-tray-side="left"] .history-tray-btn--receive svg{
				        opacity:0;
				        transform:scale(0.4);
				        filter:none;
				      }
				      #orderHistoryList details.history-item[data-tray-side="right"] .history-tray-btn--receive svg{
				        opacity: var(--tray-outer, 0);
				        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
				        filter: drop-shadow(0 0 calc(14px * var(--commit-progress, 0)) rgba(59,130,246, var(--commit-progress, 0)));
				      }
				      #orderHistoryList details.history-item[data-tray-side="right"] .history-tray-btn--delete svg{
				        opacity:0;
				        transform:scale(0.4);
				        filter:none;
				      }

				      #orderHistoryList details.history-item.swiping,
				      #orderHistoryList details.history-item.swiping .history-tray,
				      #orderHistoryList details.history-item.swiping .history-tray-btn,
				      #orderHistoryList details.history-item.swiping .history-tray-btn svg{ transition:none !important; }
			    }
		    @media (prefers-reduced-motion: reduce){
		      #invTable tbody tr[data-id]{ transition:none !important; }
		      #invTable tbody tr[data-id]::before{ transition:none !important; }
		      #invTable tbody tr[data-id]::after{ transition:none !important; }
		      #invTable tbody tr[data-id] .card-tray{ transition:none !important; }
		    }

    /* Desktop description: keep on one line (dynamic width handles it) */
    @media (min-width: 769px){ td[data-col="desc"], th[data-col="desc"]{ white-space:nowrap; } }
	    td.qty{text-align:center;font-variant-numeric:tabular-nums}
    th.sel, td.sel{ width:42px; text-align:center }
    input[type=text],input[type=number],input[type=email],input[type=password],input[type=tel],textarea,select{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
      background:#0d131b;color:#fff;font-size:16px
    }
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .hero-logo{height:clamp(36px,8vw,56px); margin:10px auto 0 auto;}
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .brandrow{display:flex;align-items:center;justify-content:space-between;gap:14px}
    .title-logo{
      width:min(420px, 68vw);
      height:auto;
      display:block;
      margin:0 auto;
    }
	    .brandtext{display:flex;align-items:center;justify-content:center;flex:1;min-width:0;}
	    .site-footer{
	      max-width:1100px;
	      margin:16px auto 26px;
	      padding:0 16px 8px;
	      text-align:center;
	      color:var(--muted);
	      font-size:12px;
	    }
    .footer-logo{
      height:26px;
      width:auto;
      display:block;
      margin:0 auto 8px;
      opacity:.9;
    }
	    @media (max-width: 768px){
	      .footer-logo{ height:22px; }
	    }
	    .inv-controls{ display:flex; align-items:center; justify-content:center; gap:10px; width:100%; flex-wrap:nowrap; }
	    .input-wrap{ position:relative; width:100%; max-width:480px; }
	    .sort-wrap{ display:none; }
	    .clear-input-btn{
	      position:absolute;
	      right:8px;
	      top:50%;
      transform:translateY(-50%);
      width:40px;
      height:40px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      cursor:pointer;
      touch-action:manipulation;
      -webkit-appearance:none;
      appearance:none;
    }
    .clear-input-btn:hover{ background:#0e1621; }
	    .clear-input-btn:disabled{ opacity:.55; cursor:not-allowed; }
	    .input-wrap > input{ padding-right:52px; }
	    #filterBox{
	      width:100%; max-width:480px;
	      padding:12px 52px 12px 12px;border-radius:10px;border:1px solid var(--border);
	      background:#0d131b;color:#eaeff7;font-size:16px
	    }
	    @media (max-width: 768px){
	      .inv-controls{ gap:8px; }
	      .inv-controls .input-wrap{ flex:1 1 auto; max-width:none; }
	      .sort-wrap{ display:block; flex:0 0 auto; width:160px; }
	      #mobileSort{ padding:12px; border-radius:10px; }
	    }
    td.editing{padding:6px}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:calc(18px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,0.96);
      border:1px solid rgba(0,0,0,0.12);
      color:#0b1020;
      font-weight:800;
      padding:10px 14px;border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.55);
      z-index:300;
      display:none
    }
	    .modal{
	      display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;
	      overflow:auto;
	      padding:calc(12px + env(safe-area-inset-top)) 12px calc(12px + env(safe-area-inset-bottom));
	      -webkit-backdrop-filter: blur(8px);
	      backdrop-filter: blur(8px);
	    }
	    #reportEmailModal{ z-index:220; }
	    #msgModal{ z-index:240; }
	    #confirmModal{ z-index:250; }
	    #qtyPickerModal{ z-index:210; }
	    .modal .box{
	      max-width:580px;
	      width:100%;
	      margin:0 auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      max-height:calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
		    .modal .box.edit-box{
		      padding:0;
		      overflow:hidden; /* body scrolls */
		      display:flex;
	      flex-direction:column;
	    }
    .edit-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background:var(--card);
    }
    .edit-header h2{ margin:0; font-size:16px; }
    .edit-sub{ margin-top:6px; color:var(--muted); font-size:12px; }
    .modal-title{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .modal-title .modal-title-icon{
      width:20px;
      height:20px;
      flex:0 0 auto;
      display:block;
      opacity:0.95;
    }
	    .modal-title--edit .modal-title-icon{ color:#22c55e; }
	    .edit-body{
	      padding:12px 14px 14px;
	      overflow:auto;
      flex:1;
      -webkit-overflow-scrolling:touch;
    }
	    .edit-body textarea{
	      min-height:12vh;
	    }
	    .edit-steppers{
	      display:grid;
	      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
	      gap:8px 12px;
	      align-items:center;
	      justify-items:center;
	    }
	    .edit-steppers label.muted{
	      margin:0;
	      text-align:center;
	    }
	    .edit-label-meta{
	      display:block;
	      margin-top:2px;
	      font-weight:600;
	      opacity:0.85;
	      font-size:12px;
	    }
	    .edit-stepper-actions{
	      width:100%;
	      display:flex;
	      justify-content:center;
	    }
	    .edit-toggle-row{
	      display:flex;
	      align-items:center;
	      gap:12px;
	      margin-top:12px;
	      flex-wrap:wrap;
	    }
	    .edit-toggle-row label[for]{
	      cursor:pointer;
	      font-size:13px;
	      line-height:1.35;
	    }
    .qty-stepper.qty-stepper--modal,
    .qty-stepper.qty-stepper--table{
      display:inline-flex;
      align-items:center;
      flex-wrap:nowrap;
      justify-content:center;
      background:transparent;
      border:none;
      border-radius:0;
      overflow:visible;
      height:auto;
    }
		    .qty-stepper.qty-stepper--modal{ gap:8px; }
		    .qty-stepper.qty-stepper--table{ gap:6px; }
	    .qty-stepper--table .qty-step{ min-width:38px; }
	    .qty-stepper--table .qty-value{ min-width:36px; font-size:15px; }
	    .qty-step{
	      cursor:pointer;
	      border:1px solid var(--border);
	      background:#101826;
	      color:#fff;
      border-radius:10px;
      min-width:44px;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      line-height:1;
      user-select:none;
      -webkit-appearance:none;
      appearance:none;
      touch-action:manipulation;
    }
    .qty-step:disabled{ opacity:.55; cursor:not-allowed; }
    .qty-value{
      min-width:44px;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-variant-numeric:tabular-nums;
      font-weight:800;
      font-size:16px;
      line-height:1;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
    }
	    .qty-stepper.qty-stepper--modal input[type=number]{
	      width:3.25rem;
	      text-align:center;
	      font-variant-numeric:tabular-nums;
	      font-size:22px;
	      font-weight:900;
	    }
    .qty-stepper input[type=number]::-webkit-outer-spin-button,
	    .qty-stepper input[type=number]::-webkit-inner-spin-button{
	      -webkit-appearance:none;
	      margin:0;
	    }
	    .qty-stepper input[type=number]{ -moz-appearance:textfield; }
	    .edit-footer{
	      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
	      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#0b1017;
    }
    .section + .section{ margin-top:12px; }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .btn-icon-inline{
      background:transparent;
      border:none;
      padding:4px;
      margin-left:auto;
      cursor:pointer;
      color:var(--muted);
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:color 0.15s, background 0.15s;
    }
    .btn-icon-inline:hover{
      color:#fff;
      background:rgba(255,255,255,0.1);
    }
    .btn-icon-inline:active{
      background:rgba(255,255,255,0.15);
    }
    .order-box{
      padding:0;
      overflow:hidden; /* body scrolls */
      display:flex;
      flex-direction:column;
    }
    .order-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background:var(--card);
    }
    .order-header h2{ margin:0; font-size:16px; }
    .order-body{
      padding:12px 14px 14px;
      overflow:auto;
      flex:1;
      -webkit-overflow-scrolling:touch;
    }
    .order-footer{
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .order-recipient{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .order-recipient input[type=email]{ flex:1; min-width:200px; }
    .order-shipping-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .order-shipping-row select{ flex:1; min-width:220px; }
    .order-po-grid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; }
    .order-po-subject{ grid-column:1 / -1; }
    @media (max-width: 720px){
      .order-po-grid{ grid-template-columns:1fr; }
      .order-po-subject{ grid-column:auto; }
    }
    .order-suggest{
      display:none;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px;
      background:#000;
      max-height:190px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .order-suggest.has-suggest{ display:flex; }
    .suggest-chip{
      cursor:pointer;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      min-height:36px;
      max-width:100%;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .order-list{ display:flex; flex-direction:column; gap:10px; }
    .order-empty{
      padding:14px;
      border:1px dashed var(--border);
      border-radius:14px;
      background:transparent;
      color:var(--muted);
      font-size:13px;
      text-align:center;
    }
    .order-card{
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:14px;
      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
      box-shadow:0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
      transition: border-color 180ms ease, box-shadow 180ms ease;
    }
    .order-card.order-card--selected{
      background:
        radial-gradient(220px 120px at 40% 35%, rgba(34,197,94,0.20), rgba(34,197,94,0) 70%),
        linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%);
      box-shadow:0 0 0 1px rgba(34,197,94,0.12), 0 0 16px rgba(34,197,94,0.10), 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .order-card-header{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .order-batch-toggle{
      display:flex;
      align-items:center;
    }
    .order-line-select{
      width:16px;
      height:16px;
      accent-color:#22c55e;
      cursor:pointer;
    }
    @media (pointer: coarse){
      .order-batch-toggle{ display:none; }
    }
    .order-inline-kpi{
      margin-left:auto;
      display:flex;
      align-items:baseline;
      gap:6px;
      white-space:nowrap;
      font-size:12px;
      color:var(--muted);
      font-variant-numeric:tabular-nums;
    }
    .order-inline-kpi-val{
      color:var(--fg);
      font-weight:800;
      font-size:14px;
    }
    .order-card-top{ display:flex; gap:12px; align-items:flex-start; }
    .order-meta{ flex:1; min-width:0; }
    .order-title{ font-weight:700; font-size:15px; letter-spacing:-0.01em; }
    .order-sub{ margin-top:3px; color:var(--muted); font-size:12px; line-height:1.4; }
    .order-side{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
    .order-kpi{ text-align:right; }
    .order-kpi-label{ color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:0.04em; }
    .order-kpi-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:18px; }
    .order-controls{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;
      gap:12px;
      align-items:flex-end;
    }
	    .order-controls.order-controls--compact{
	      margin-top:10px;
	      padding-top:10px;
	      display:flex;
	      align-items:center;
	      gap:10px;
	    }
	    .order-controls.order-controls--compact .order-remove-btn{
	      margin-left:auto;
	    }
    .order-control{ flex-shrink:0; display:flex; flex-direction:column; }
    .order-control.qty{ width:64px; margin-left:auto; text-align:center; }
    .order-control.qty input{
      width:100%;
      text-align:center;
      font-weight:600;
      font-size:16px;
      font-variant-numeric:tabular-nums;
      height:42px;
      padding:0 8px;
      box-sizing:border-box;
    }
    .order-control-label{ color:var(--muted); font-size:11px; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.03em; }
    .order-control-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:17px; height:42px; display:flex; align-items:center; }
    .order-control-spacer{ height:17px; }
	    .order-remove-btn{
	      background:none; border:none; cursor:pointer; padding:8px;
	      color:var(--muted); display:flex; align-items:center; justify-content:center;
	      height:48px; width:48px; border-radius:10px; transition:background 0.15s, color 0.15s;
	    }
    .order-remove-btn:hover{ background:rgba(255,80,80,0.15); color:#ff6b6b; }
    .order-remove-btn svg{ width:20px; height:20px; }
	    .qty-stepper{
	      display:flex; align-items:center; gap:0; background:#0d131b; border:1px solid var(--border);
	      border-radius:10px; overflow:hidden; height:48px;
	    }
	    .qty-stepper-btn{
	      width:48px; height:48px; border:none; background:transparent; color:#fff;
	      font-size:20px; font-weight:500; cursor:pointer; display:flex; align-items:center; justify-content:center;
	      transition:background 0.15s;
	    }
    .qty-stepper-btn:hover{ background:rgba(255,255,255,0.08); }
    .qty-stepper-btn:active{ background:rgba(255,255,255,0.12); }
	    .qty-stepper-val{
	      min-width:3.25rem;
	      height:48px;
	      display:inline-flex;
	      align-items:center;
	      justify-content:center;
	      text-align:center;
	      font-weight:900;
	      font-size:22px;
	      font-variant-numeric:tabular-nums;
	      color:#fff;
	      cursor:pointer;
	      user-select:none;
	      touch-action:manipulation;
	    }
	    .qty-stepper-input{
	      min-width:3.25rem;
	      width:auto;
	      height:48px;
	      border:none;
	      background:transparent;
	      text-align:center;
	      font-weight:900;
	      font-size:22px;
	      font-variant-numeric:tabular-nums;
	      color:#fff;
	      outline:none;
	      padding:0 4px;
	      -moz-appearance:textfield;
	    }
	    .qty-stepper-input::-webkit-outer-spin-button,
	    .qty-stepper-input::-webkit-inner-spin-button{
	      -webkit-appearance:none;
	      margin:0;
	    }
	    .qty-stepper-input:focus{
	      background:rgba(255,255,255,0.1);
	    }
    .order-preview{
      border:1px solid var(--border);
      border-radius:12px;
      background:#000;
      padding:10px;
    }
    .order-preview summary{
      cursor:pointer;
      list-style:none;
      font-weight:700;
      user-select:none;
    }
    .order-preview summary::-webkit-details-marker{ display:none; }
    .order-preview summary::after{ content:'▾'; float:right; color:var(--muted); }
    .order-preview[open] summary::after{ content:'▴'; }
    .order-preview-html{
      margin-top:10px;
      border-radius:8px;
      overflow:hidden;
      background:#fff;
      max-height:320px;
      overflow-y:auto;
    }
    .order-preview-html iframe{
      width:100%;
      border:none;
      min-height:280px;
    }
    .history-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .history-item{
      border:1px solid var(--border);
      border-radius:12px;
      background:#000;
      padding:10px;
    }
    .history-item summary{
      cursor:pointer;
      list-style:none;
      font-weight:800;
      user-select:none;
    }
    .history-item summary::-webkit-details-marker{ display:none; }
    .history-item summary::after{ content:'▾'; float:right; color:var(--muted); }
    .history-item[open] summary::after{ content:'▴'; }
    .history-meta{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .history-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .history-title{ flex:1; }
    .history-actions{
      display:flex;
      align-items:center;
      gap:6px;
      flex-shrink:0;
    }
    .history-tray{ display:none; }
    .btn-icon-receive,
    .btn-icon-undo{
      background:transparent;
      border:none;
      color:#3b82f6;
      cursor:pointer;
      padding:4px;
      border-radius:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:color 0.15s, background 0.15s, opacity 0.15s;
    }
    .btn-icon-receive:hover{
      color:#60a5fa;
      background:rgba(59,130,246,0.12);
    }
    .btn-icon-undo:hover{
      color:#f59e0b;
      background:rgba(245,158,11,0.12);
    }
    .btn-icon-receive[aria-disabled="true"],
    .btn-icon-undo[aria-disabled="true"]{
      opacity:0.4;
      cursor:not-allowed;
    }
    .btn-icon-receive .recv-check{
      opacity:0;
      transition: opacity 160ms ease;
    }
    .history-item.order-received .btn-icon-receive .recv-check{
      opacity:1;
    }
    .btn-icon-danger{
      background:transparent;
      border:none;
      color:#ef4444;
      cursor:pointer;
      padding:4px;
      border-radius:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:color 0.15s, background 0.15s;
    }
	    .btn-icon-danger:hover{
	      color:#ff6b6b;
	      background:rgba(239,68,68,0.14);
	    }
	    /* iOS-style qty picker */
	    .qty-picker-modal{
	      display:flex !important;
	      align-items:flex-end;
	      justify-content:center;
	      padding:0;
	      opacity:0;
	      pointer-events:none;
	      transition:opacity 250ms ease;
	    }
	    .qty-picker-modal[aria-hidden="false"]{
	      opacity:1;
	      pointer-events:auto;
	    }
	    .qty-picker-modal .box{ display:none; }
	    .qty-picker-backdrop{
	      position:absolute;
	      inset:0;
	      background:rgba(0,0,0,0.5);
	    }
	    .qty-picker-sheet{
	      position:relative;
	      width:100%;
	      max-width:420px;
	      background:#1c1c1e;
	      border-radius:14px 14px 0 0;
	      padding-bottom:env(safe-area-inset-bottom, 20px);
	      transform:translateY(100%);
	      transition:transform 300ms cubic-bezier(0.32, 0.72, 0, 1);
	    }
	    .qty-picker-modal[aria-hidden="false"] .qty-picker-sheet{
	      transform:translateY(0);
	    }
	    .qty-picker-header{
	      display:flex;
	      align-items:center;
	      justify-content:space-between;
	      padding:12px 16px;
	      border-bottom:1px solid rgba(255,255,255,0.1);
	    }
	    .qty-picker-cancel,
	    .qty-picker-done{
	      background:none;
	      border:none;
	      font-size:17px;
	      font-weight:400;
	      cursor:pointer;
	      padding:8px 4px;
	      min-width:70px;
	    }
	    .qty-picker-cancel{ color:#ff453a; text-align:left; }
	    .qty-picker-done{ color:#30d158; text-align:right; font-weight:600; }
	    .qty-picker-title{
	      font-size:17px;
	      font-weight:600;
	      color:#fff;
	      text-align:center;
	    }
	    .qty-picker-wheel-wrap{
	      position:relative;
	      height:216px;
	      overflow:hidden;
	      -webkit-mask-image:linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
	      mask-image:linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
	    }
	    .qty-picker-highlight{
	      position:absolute;
	      top:50%;
	      left:16px;
	      right:16px;
	      height:36px;
	      transform:translateY(-50%);
	      background:rgba(120,120,128,0.24);
	      border-radius:8px;
	      pointer-events:none;
	    }
	    .qty-picker-wheel{
	      position:absolute;
	      top:0;
	      left:0;
	      right:0;
	      padding:90px 0;
	      display:flex;
	      flex-direction:column;
	      align-items:center;
	      transition:transform 150ms ease-out;
	    }
	    .qty-picker-item{
	      height:36px;
	      display:flex;
	      align-items:center;
	      justify-content:center;
	      font-size:22px;
	      font-weight:400;
	      color:rgba(255,255,255,0.85);
	      font-variant-numeric:tabular-nums;
	      transition:opacity 100ms ease, transform 100ms ease;
	    }
	    .qty-picker-item.selected{
	      font-weight:500;
	      color:#fff;
	    }
	    .report-metrics{
	      display:grid;
	      grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
	      gap:10px;
	      margin-top:12px;
	    }
	    .report-metric{
	      border:1px solid var(--border);
	      border-radius:12px;
	      padding:10px 12px;
	      background:#0d1420;
	    }
	    .report-metric .val{
	      margin-top:4px;
	      font-weight:900;
	      font-size:18px;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-metric--actionable{
	      position:relative;
	    }
	    .report-metric-action{
	      position:absolute;
	      top:8px;
	      right:8px;
	      background:rgba(255,255,255,0.08);
	      border:none;
	      border-radius:6px;
	      padding:6px;
	      cursor:pointer;
	      color:var(--muted);
	      display:flex;
	      align-items:center;
	      justify-content:center;
	      transition:color 0.15s, background 0.15s, transform 0.15s;
	    }
	    .report-metric-action:hover{
	      color:#22c55e;
	      background:rgba(34,197,94,0.15);
	      transform:scale(1.1);
	    }
	    .report-metric-action:active{
	      transform:scale(0.95);
	    }
	    .led-dot{
	      display:inline-block;
	      width:8px;
	      height:8px;
	      border-radius:50%;
	      margin-right:6px;
	      vertical-align:middle;
	      position:relative;
	      top:-1px;
	    }
	    .led-dot--red{
	      background:#ef4444;
	      box-shadow:0 0 6px rgba(239,68,68,0.5), 0 0 12px rgba(239,68,68,0.3);
	    }
	    .led-dot--amber{
	      background:#f59e0b;
	      box-shadow:0 0 6px rgba(245,158,11,0.5), 0 0 12px rgba(245,158,11,0.3);
	    }
	    .led-dot--green{
	      background:#22c55e;
	      box-shadow:0 0 6px rgba(34,197,94,0.5), 0 0 12px rgba(34,197,94,0.3);
	    }
	    .led-dot--cyan{
	      background:#06b6d4;
	      box-shadow:0 0 6px rgba(6,182,212,0.5), 0 0 12px rgba(6,182,212,0.3);
	    }
	    .led-dot--off{
	      background:rgba(148,163,184,0.55);
	      box-shadow:0 0 0 1px rgba(255,255,255,0.10);
	    }
	    .report-count{
	      color:var(--muted);
	      font-weight:900;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-progress{
	      margin-top:12px;
	      padding:10px 12px;
	      border:1px solid var(--border);
	      border-radius:14px;
	      background:#0d1420;
	    }
	    .report-progress-label{
	      display:flex;
	      align-items:center;
	      justify-content:space-between;
	      gap:10px;
	      color:var(--muted);
	      font-size:11px;
	      font-weight:900;
	      letter-spacing:0.08em;
	      text-transform:uppercase;
	    }
	    .report-progress-value{
	      flex:0 0 auto;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-progress-track{
	      margin-top:10px;
	      height:10px;
	      border-radius:999px;
	      background:rgba(255,255,255,0.10);
	      overflow:hidden;
	      border:1px solid rgba(255,255,255,0.10);
	    }
	    .report-progress-bar{
	      height:100%;
	      width:0%;
	      border-radius:999px;
	      background:linear-gradient(90deg, rgba(34,197,94,1), rgba(135,245,255,0.9));
	      box-shadow:0 0 16px rgba(34,197,94,0.35);
	      transition: width 120ms ease;
	    }
	    .report-pill-container{
	      position:static;
	      margin:12px 0 0;
	      padding:0;
	      background:none;
	    }
		    .report-section{
		      margin-top:14px;
		      border:1px solid var(--border);
		      border-radius:14px;
		      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
		      overflow:hidden;
		    }
		    .report-summary{
		      display:flex;
		      align-items:center;
		      justify-content:space-between;
		      gap:10px;
		      padding:10px 12px;
		      cursor:pointer;
		      user-select:none;
		      list-style:none;
		    }
		    .report-section summary::-webkit-details-marker{ display:none; }
		    .report-section summary::marker{ content:''; }
		    .report-summary-left h3{
		      margin:0;
		      font-size:13px;
		      letter-spacing:.08em;
		      text-transform:uppercase;
		    }
			    .report-summary-right{
			      display:flex;
			      align-items:center;
			      justify-content:flex-end;
			      gap:10px;
			      flex-shrink:0;
			    }
			    .report-batch-btn{
			      width:36px;
			      height:36px;
			      padding:0;
			      border-radius:10px;
			      border:1px solid rgba(34,197,94,0.28);
			      background:rgba(34,197,94,0.12);
			      color:#22c55e;
			      display:inline-flex;
			      align-items:center;
			      justify-content:center;
			      cursor:pointer;
			      -webkit-appearance:none;
			      appearance:none;
			      touch-action:manipulation;
			    }
			    .report-batch-btn:active{ filter:brightness(0.96); }
			    .report-batch-btn svg{
			      width:18px;
			      height:18px;
			      display:block;
			    }
			    .report-summary-right .muted{ font-size:12px; }
			    .report-chevron{
			      display:inline-block;
			      color:var(--muted);
			      font-size:14px;
		      line-height:1;
		      transform: rotate(0deg);
		      transition: transform 160ms ease;
		    }
		    .report-section[open] .report-chevron{ transform: rotate(180deg); }
		    .report-section[open] .report-summary{ border-bottom:1px solid rgba(255,255,255,0.08); }
		    .report-list{
		      display:flex;
		      flex-direction:column;
		      gap:8px;
		    }
		    .report-table{
		      width:100%;
		      border-collapse:collapse;
		      font-size:13px;
		    }
		    .report-table th{
		      text-align:left;
		      color:var(--muted);
		      font-weight:800;
		      border-bottom:1px solid rgba(255,255,255,0.10);
		      padding:10px 12px;
		      background:transparent;
		      position:static;
		      top:auto;
		      z-index:auto;
		      text-transform:uppercase;
		      font-size:11px;
		      letter-spacing:0.08em;
		      white-space:nowrap;
		    }
		    .report-table td{
		      padding:10px 12px;
		      border-bottom:1px solid rgba(255,255,255,0.08);
		      vertical-align:top;
		    }
		    .report-table td.item{
		      font-weight:900;
		      letter-spacing:0.02em;
		      white-space:nowrap;
		    }
		    .report-table td.desc{
		      color:var(--muted);
		      line-height:1.25;
		    }
		    .report-table th.qty,
		    .report-table td.qty,
		    .report-table th.thr,
		    .report-table td.thr{
		      text-align:right;
		      font-variant-numeric:tabular-nums;
		      font-weight:900;
		      white-space:nowrap;
		    }
		    .report-banner{
		      margin-top:12px;
		      padding:10px 12px;
		      border:1px solid rgba(135,245,255,0.22);
		      border-radius:12px;
		      background:rgba(135,245,255,0.06);
		      display:flex;
		      align-items:center;
		      justify-content:space-between;
		      gap:10px;
		    }
		    .report-banner-text{
		      min-width:0;
		      font-weight:700;
		      color:#c9f7ff;
		    }
		    .report-banner-actions{ display:flex; gap:8px; flex-shrink:0; }
		    .report-row{
		      display:flex;
		      align-items:flex-start;
		      justify-content:space-between;
		      gap:12px;
		      width:100%;
		      text-align:left;
		      cursor:pointer;
	      padding:10px 12px;
	      border:1px solid var(--border);
	      border-radius:12px;
	      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
	      color:inherit;
	      -webkit-appearance:none;
	      appearance:none;
	    }
	    .report-row:active{ transform:scale(0.99); }
	    .report-row:focus-visible{
	      outline:2px solid rgba(90,169,255,0.65);
	      outline-offset:2px;
	    }
		    .report-row[aria-pressed="true"]{
		      background:
		        radial-gradient(180px 90px at 50% 40%, rgba(34,197,94,0.20), rgba(34,197,94,0) 68%),
		        linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%);
		      box-shadow:0 0 0 1px rgba(34,197,94,0.12), 0 10px 24px rgba(0,0,0,0.35);
		    }
		    .report-separator{
		      display:flex;
		      align-items:center;
		      gap:10px;
		      margin:12px 0;
		      color:rgba(255,255,255,0.55);
		      font-size:11px;
		      text-transform:uppercase;
		      letter-spacing:0.08em;
		      user-select:none;
		    }
		    .report-separator::before,
		    .report-separator::after{
		      content:'';
		      flex:1;
		      height:1px;
		      background:rgba(255,255,255,0.10);
		    }
		    .report-separator span{ padding:0 2px; }
		    .report-row-main{ min-width:0; flex:1; }
	    .report-item{
	      display:flex;
	      align-items:center;
	      gap:8px;
	      min-width:0;
	      font-weight:800;
	      letter-spacing:.02em;
	    }
	    .report-item-name{
	      overflow:hidden;
	      text-overflow:ellipsis;
	      white-space:nowrap;
	      min-width:0;
	    }
	    .report-desc{
	      margin-top:4px;
	      color:var(--muted);
	      font-size:13px;
	      line-height:1.25;
	      overflow:hidden;
	      display:-webkit-box;
	      -webkit-box-orient:vertical;
	      -webkit-line-clamp:2;
	    }
	    .report-qty{
	      flex:0 0 auto;
	      min-width:56px;
	      text-align:right;
	      font-weight:900;
	      font-variant-numeric:tabular-nums;
	      display:flex;
	      flex-direction:column;
	      align-items:flex-end;
	      gap:4px;
	    }
	    .report-qty .muted{ font-size:10px; }
	    .history-kv{ margin-top:10px; font-size:13px; }
	    .history-kv div{ margin-top:4px; }
	    .history-table{
	      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
    }
    .history-table th,
    .history-table td{ padding:8px; border-bottom:1px solid var(--border); }
    .history-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
    }
    .history-table td.qty{
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:800;
    }
	    .drop{
	      border:1px dashed var(--border);border-radius:10px;padding:12px;text-align:center;color:var(--muted)
	    }
		    .totals{ display:flex; justify-content:center; align-items:center; gap:0; flex-wrap:wrap; margin:6px 0 4px; text-align:center; }
		    .totals > span{ white-space:nowrap; }
		    .totals > span + span::before{
		      content:'|';
		      display:inline-block;
		      margin:0 10px;
		      opacity:.65;
		    }
		    @media (max-width:520px){
		      .totals{ flex-wrap:nowrap; }
		      .totals > span{ font-size:11px; }
		      .totals > span + span::before{ margin:0 6px; }
		    }
		    @media (max-width:360px){
		      .totals > span{ font-size:10px; }
		      .totals > span + span::before{ margin:0 4px; }
		    }
	    @media (max-width:640px){
	      .toolbar{gap:6px}
	      .toolbar .btn{flex:1}
	      .scroll{max-height:calc(100vh - 240px); max-height:calc(100svh - 240px); max-height:calc(100dvh - 240px)}
	    }
    /* no right-side logo anymore */
    @media (max-width:360px){ .toolbar{gap:4px} }
  
    @media (max-width: 480px){
      header{ padding: calc(8px + env(safe-area-inset-top)) 12px 6px; }
      .header-inner{ padding: 0 12px; }
      .brandrow{ gap:8px }
      .title-logo{ width:min(300px, 76vw); height:auto; }
      .modal{ padding:calc(10px + env(safe-area-inset-top)) 10px calc(10px + env(safe-area-inset-bottom)); }
      .order-header{ padding:12px; }
      .order-body{ padding:10px 12px 12px; }
      .order-footer{ padding:10px 12px calc(10px + env(safe-area-inset-bottom)); }
      .order-footer{ display:grid; grid-template-columns:1fr 1fr; }
      .order-footer .order-send{ grid-column:1 / -1; }
      .order-recipient{ flex-direction:column; align-items:stretch; }
      .order-recipient input[type=email]{ min-width:0; }
    }

    /* Hamburger Menu Styles */
    .hamburger-menu{
      position:relative;
      z-index:25;
    }
    .hamburger-btn{
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      width:44px;
      height:44px;
      padding:8px;
      border:1px solid var(--border);
      background:#101826;
      border-radius:10px;
      cursor:pointer;
      gap:5px;
    }
    .hamburger-btn:hover{
      background:#1a2636;
    }
    .hamburger-btn span{
      display:block;
      width:22px;
      height:2px;
      background:var(--fg);
      border-radius:2px;
      transition:transform 0.2s, opacity 0.2s;
    }
    .hamburger-btn.open span:nth-child(1){
      transform:translateY(7px) rotate(45deg);
    }
    .hamburger-btn.open span:nth-child(2){
      opacity:0;
    }
    .hamburger-btn.open span:nth-child(3){
      transform:translateY(-7px) rotate(-45deg);
    }
    .menu-dropdown{
      display:none;
      position:absolute;
      top:calc(100% + 8px);
      right:0;
      min-width:200px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:8px;
      box-shadow:0 10px 40px rgba(0,0,0,.5);
      z-index:30;
    }
    .menu-dropdown.open{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .menu-dropdown .menu-item{
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
      padding:12px 14px;
      border:none;
      background:transparent;
      color:var(--fg);
      font-size:15px;
      font-weight:600;
      text-align:left;
      border-radius:10px;
      cursor:pointer;
      transition:background 0.15s;
    }
    .menu-dropdown .menu-item:hover{
      background:#1a2636;
    }
    .menu-dropdown .menu-item:disabled{
      opacity:0.45;
      cursor:not-allowed;
    }
    .menu-dropdown .menu-item:disabled:hover{
      background:transparent;
    }
    .menu-dropdown .menu-item .menu-icon-svg{
      flex-shrink:0;
      opacity:0.8;
    }
    .menu-divider{
      height:1px;
      background:var(--border);
      margin:4px 0;
    }
    .header-row{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
      gap:12px;
    }
    .header-right{
      grid-column:3;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      justify-self:end;
      gap:8px;
    }
    .header-left{
      grid-column:2;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      min-width:0;
      justify-self:center;
    }
    /* Main app order pill - positioned below totals, sticky */
    .order-pill-container{
      position:sticky;
      top:0;
      z-index:15;
      display:flex;
      justify-content:center;
      padding:10px 0;
      background:linear-gradient(to bottom, var(--bg) 60%, transparent 100%);
    }
    .order-pill{
      width:75%;
      max-width:400px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background:rgba(34,197,94,0.18);
      border:1px solid rgba(34,197,94,0.55);
      color:#fff;
      font-weight:600;
      padding:12px 20px;
      border-radius:14px;
      cursor:pointer;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.12), 0 10px 24px rgba(0,0,0,0.35);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      transition: transform 150ms ease, box-shadow 150ms ease;
      -webkit-tap-highlight-color: transparent;
      animation: orderPillIn 220ms ease;
    }
    @keyframes orderPillIn{
      from{ opacity:0; transform:translateY(-8px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .order-pill:active{
      transform: scale(0.97);
    }
    .order-pill-value{
      font-size:20px;
      font-weight:700;
    }
    .order-pill-label{
      font-size:15px;
      font-weight:600;
    }
    .order-pill-hint{
      font-size:11px;
      opacity:0.8;
      text-transform:uppercase;
      letter-spacing:0.3px;
      margin-left:auto;
    }
    .menu-backdrop{
      display:none;
      position:fixed;
      inset:0;
      z-index:22;
    }
    .menu-backdrop.open{
      display:block;
    }
    /* Profile dropdown */
    .profile-menu{
      position:relative;
    }
    .profile-btn{
      background:none;border:none;cursor:pointer;padding:8px;
      color:var(--muted);display:flex;align-items:center;gap:6px;
      border-radius:50%;transition:background 0.15s;position:relative;
    }
    .profile-btn:hover{background:rgba(255,255,255,0.08)}
    .profile-status{
      position:absolute;bottom:6px;right:6px;width:10px;height:10px;
      border-radius:50%;border:2px solid var(--bg);
      background:#6b7280;
    }
    .profile-status.online{background:#22c55e}
    .profile-status.offline{background:#ef4444}
    .profile-status.warning{background:#f59e0b}
    .profile-dropdown{
      position:absolute;top:100%;right:0;margin-top:8px;
      background:#1a1f26;border:1px solid var(--border);border-radius:12px;
      min-width:220px;padding:8px 0;z-index:30;
      box-shadow:0 10px 40px rgba(0,0,0,0.4);
      display:none;
    }
    .profile-dropdown.open{display:block}
    .profile-info{padding:12px 16px}
    .profile-email{font-weight:600;font-size:14px;color:var(--fg);margin-bottom:4px;word-break:break-all}
    .profile-connection{font-size:12px;color:var(--muted)}
    .env-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      border:1px solid transparent;
      color:#0c1220;
      background:#9fb3c8;
      white-space:nowrap;
    }
    .env-badge.env-production{background:#22c55e;color:#072215;border-color:#1a8b42}
    .env-badge.env-sandbox{background:#f59e0b;color:#2a1b00;border-color:#b27307}
    .env-badge.env-test{background:#ef4444;color:#2b0c0c;border-color:#b91c1c}
    .env-badge.env-system{background:#38bdf8;color:#04212c;border-color:#0ea5e9}
    .profile-env-badge{
      font-size:9px;
      padding:2px 6px;
      border-radius:999px;
    }
    .profile-env-badge.hidden{display:none}
    .advanced-switcher-controls{
      display:grid;
      grid-template-columns:2fr 1fr;
      gap:10px;
    }
    .advanced-switcher-controls .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .advanced-switcher-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-top:8px;
    }
    .advanced-switcher-results{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      max-height:320px;
      overflow:auto;
      background:#121820;
    }
    .advanced-switcher-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .advanced-switcher-table th,.advanced-switcher-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    .advanced-switcher-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .advanced-switcher-id{font-size:11px;color:var(--muted);word-break:break-all}
    .advanced-switcher-row-actions{display:flex;gap:6px}
    .advanced-switcher-hint{margin-top:6px;font-size:12px;color:var(--muted)}
    .diag-section{margin-top:10px}
    .diag-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px}
    .diag-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .diag-table th,.diag-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    .diag-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .diag-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .diag-badge.pass{background:#12361f;color:#9ff5bf;border-color:#1b5d35}
    .diag-badge.fail{background:#3a1515;color:#ffb4b4;border-color:#7a1f1f}
    .diag-output{
      margin-top:8px;
      background:#0f141b;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      font-size:12px;
      color:#dbe5f0;
      max-height:240px;
      overflow:auto;
      white-space:pre-wrap;
    }
    @media (max-width: 720px){
      .advanced-switcher-controls{
        grid-template-columns:1fr;
      }
      .advanced-switcher-actions{
        justify-content:flex-start;
      }
    }
    .profile-dropdown .menu-item{
      display:flex;align-items:center;gap:10px;width:100%;
      padding:12px 16px;border:none;background:transparent;
      color:var(--fg);font-size:14px;font-weight:500;
      text-align:left;cursor:pointer;transition:background 0.15s;
    }
    .profile-dropdown .menu-item:hover{background:rgba(255,255,255,0.06)}
    .profile-dropdown .menu-item:disabled{opacity:0.45;cursor:not-allowed}
    .profile-dropdown .menu-item:disabled:hover{background:transparent}
    .profile-meta{padding:10px 16px;border-top:1px solid var(--border);margin-top:8px}
    .profile-meta .time{font-size:11px;color:var(--muted)}
    .profile-company{
      padding:10px 16px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .profile-company-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .profile-company select{
      padding:8px 10px;
      font-size:13px;
      border-radius:8px;
      background:#0f141b;
      color:var(--fg);
      border:1px solid var(--border);
    }
    .profile-company select:disabled{opacity:0.6;cursor:not-allowed}
    .profile-company-hint{font-size:11px;color:var(--muted)}
    .invite-section{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .invite-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .invite-grid{display:grid;grid-template-columns:1fr;gap:8px}
    .invite-actions{display:flex;justify-content:flex-end}
    .invite-link-row{display:none;gap:8px;align-items:center}
    .invite-link-row input{font-size:12px}
    .trash-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .trash-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .trash-item{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--card);
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .trash-title{font-weight:700}
    .trash-meta{font-size:12px;color:var(--muted);margin-top:6px}
    .trash-empty{padding:14px;border:1px dashed var(--border);border-radius:12px;color:var(--muted);text-align:center}
    .auth-actions{display:flex;justify-content:flex-end;margin-top:6px}
    .auth-link{
      background:none;border:none;padding:0;
      color:var(--accent);font-size:13px;cursor:pointer;
    }
    .auth-link:hover{text-decoration:underline}
    .section-divider{height:1px;background:var(--border);margin:12px 0}
    .role-request-section{display:flex;flex-direction:column;gap:8px}
    .role-request-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:2px;
    }
    .role-request-meta{font-size:12px;color:var(--muted)}
    .role-request-actions{display:flex;justify-content:flex-end}
    .tier-admin-section{display:flex;flex-direction:column;gap:8px}
    .tier-admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    .tier-admin-card{border:1px solid var(--border);border-radius:10px;padding:10px;background:var(--card)}
    .tier-admin-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:4px}
    .tier-admin-value{font-size:13px;font-weight:600;color:var(--fg)}
    .tier-admin-actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .role-requests-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .role-request-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--card);
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .role-request-card h3{margin:0;font-size:14px}
    .role-request-actions-row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .audit-filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .audit-filters select,.audit-filters input{min-width:160px}
    .audit-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .audit-card{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card);
      padding:0;
    }
    .audit-card summary{
      cursor:pointer;
      list-style:none;
      padding:12px;
    }
    .audit-card summary::-webkit-details-marker{display:none}
    .audit-card summary::after{
      content:'▾';
      float:right;
      color:var(--muted);
    }
    .audit-card[open] summary::after{content:'▴'}
    .audit-body{
      padding:0 12px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .audit-title{font-weight:700}
    .audit-meta{font-size:12px;color:var(--muted)}
    .audit-json{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:11px;white-space:pre-wrap;color:var(--muted)}
    .shipping-address-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .shipping-address-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--card);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .shipping-address-meta{font-size:12px;color:var(--muted)}
    .shipping-address-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .shipping-address-form{display:flex;flex-direction:column;gap:8px}
    .shipping-address-default{display:flex;align-items:center;gap:12px}
    .user-mgmt-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .user-mgmt-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .user-mgmt-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--card);
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .user-mgmt-name{font-weight:700}
    .user-mgmt-meta{font-size:12px;color:var(--muted);margin-top:4px}
    .user-mgmt-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .user-mgmt-role{min-width:120px}
    .snapshots-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .snapshot-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--card);
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .snapshot-title{font-weight:700}
    .snapshot-meta{font-size:12px;color:var(--muted);margin-top:6px}
    .snapshot-preview{margin-top:12px}
    .snapshot-preview-header{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .snapshot-preview-title{font-weight:700}
    .snapshot-preview-meta{font-size:12px;color:var(--muted);margin-top:6px}
    .snapshot-preview-table{margin-top:10px}
    .metrics-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .metrics-content{margin-top:12px}
    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:10px;
      margin-top:8px;
    }
    .metric-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--card);
    }
    .metric-value{font-size:20px;font-weight:700}
    .metric-label{font-size:12px;color:var(--muted);margin-top:4px}
    .metrics-section{margin-top:14px}
    .metrics-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:8px;
    }
    .metrics-table th,.metrics-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
    }
    .metrics-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .metrics-note{font-size:12px;color:var(--muted);margin-top:6px}
    .role-manager-table-wrap{max-height:420px;overflow:auto;margin-top:10px}
    .role-manager-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .role-manager-table th,.role-manager-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
    }
    .role-manager-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .role-manager-category td{
      background:#0f141b;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:11px;
      color:var(--muted);
    }
    .menu-icon-svg{flex-shrink:0}
</style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-row">
        <div class="header-left">
          <div class="brandtext">
            <img class="title-logo" src="./assets/modulus/logo/inventory-manager-logo.svg" alt="Inventory Manager logo" />
          </div>
        </div>
        <div class="header-right">
        <div class="profile-menu">
          <button class="profile-btn" id="profileBtn" aria-label="Account menu" aria-expanded="false">
            <span class="profile-status" id="profileStatus"></span>
            <span class="env-badge profile-env-badge hidden" id="profileEnvBadge">Production</span>
            <svg class="profile-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          </button>
          <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-info" id="profileInfo">
              <div class="profile-email" id="profileEmail">Not signed in</div>
              <div class="profile-connection" id="profileConnection">Offline</div>
            </div>
            <div class="profile-company" id="profileCompanySection">
              <label class="profile-company-label" for="profileCompanySelect">Company</label>
              <select id="profileCompanySelect" aria-label="Switch company"></select>
              <div class="profile-company-hint" id="profileCompanyHint"></div>
            </div>
            <div class="profile-company" id="profileRoleTestingSection">
              <label class="profile-company-label" for="profileRoleTestingSelect">Role (Testing Mode)</label>
              <select id="profileRoleTestingSelect" aria-label="Select testing role"></select>
              <div class="profile-company-hint" id="profileRoleTestingHint"></div>
            </div>
            <div class="menu-divider" id="profileCompanyDivider"></div>
            <button class="menu-item" id="openAdvancedCompanySwitcher">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
              <span>Advanced Company Switcher</span>
            </button>
            <button class="menu-item" id="openDiagnostics">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>
              <span>Diagnostics</span>
            </button>
            <button class="menu-item" id="openProfileSettings">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
              <span>Profile Settings</span>
            </button>
            <button class="menu-item" id="openInviteModal">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
              <span>Invite User</span>
            </button>
            <button class="menu-item" id="openUserMgmt">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
              <span>Manage Users</span>
            </button>
            <button class="menu-item" id="openRoleManager">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
              <span>Role Manager</span>
            </button>
            <button class="menu-item" id="openRoleRequests">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16v4H4z"></path><path d="M4 10h16v10H4z"></path><path d="M9 14h6"></path><path d="M9 17h6"></path></svg>
              <span>Role Requests</span>
            </button>
            <button class="menu-item" id="profileSignIn">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
              <span id="profileSignInText">Sign Out</span>
            </button>
            <div class="profile-meta">
              <span class="time" id="lastUpdate" aria-live="polite"></span>
            </div>
          </div>
        </div>
        <div class="hamburger-menu">
          <button class="hamburger-btn" id="hamburgerBtn" aria-label="Open menu" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <nav class="menu-dropdown" id="menuDropdown" role="menu">
            <!-- Primary Actions -->
            <button class="menu-item" id="menuAddOne" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Add Item
            </button>
            <div class="menu-divider"></div>
            <!-- Data Import/Export -->
            <button class="menu-item" id="menuImport" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              Import File
            </button>
            <button class="menu-item" id="menuPaste" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
              Paste Data
            </button>
            <button class="menu-item" id="menuExport" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
              Export File
            </button>
            <button class="menu-item" id="menuReport" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
              Create Inventory Report
            </button>
            <div class="menu-divider"></div>
            <!-- Orders -->
            <button class="menu-item" id="menuOrder" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
              Create Order
            </button>
            <button class="menu-item" id="menuHistory" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              Order History
            </button>
            <div class="menu-divider"></div>
            <!-- Analytics -->
            <button class="menu-item" id="menuMetrics" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"></line><line x1="18" y1="20" x2="18" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
              Metrics
            </button>
            <button class="menu-item" id="menuSnapshots" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>
              Snapshots
            </button>
            <button class="menu-item" id="menuAudit" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>
              Audit Log
            </button>
            <div class="menu-divider"></div>
            <!-- Maintenance -->
            <button class="menu-item" id="menuTrash" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
              Trash
            </button>
          </nav>
        </div>
        </div>
      </div>
      <div id="menuBackdrop" class="menu-backdrop"></div>
    </div>
  </header>

  <main>
    <section class="card">
	      <div class="toolbar" role="toolbar" aria-label="Inventory actions" style="justify-content:center;">
	        <input type="file" id="fileImport" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" style="display:none" />
	        <div class="inv-controls">
	          <div class="input-wrap">
	            <input id="filterBox" type="text" placeholder="Filter items…" aria-label="Filter items" />
	            <button class="clear-input-btn" id="btnClearFilter" type="button" aria-label="Clear filter" title="Clear filter" style="display:none">
	              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	                <path d="M18 6L6 18"></path>
	                <path d="M6 6l12 12"></path>
	              </svg>
	            </button>
	          </div>
	          <div class="sort-wrap" id="mobileSortWrap">
	            <select id="mobileSort" aria-label="Sort items">
	              <option value="name:asc">Item (A–Z)</option>
	              <option value="name:desc">Item (Z–A)</option>
	              <option value="desc:asc">Description (A–Z)</option>
	              <option value="desc:desc">Description (Z–A)</option>
	              <option value="qty:asc">Qty (Low–High)</option>
	              <option value="qty:desc">Qty (High–Low)</option>
	              <option value="updatedAt:desc">Last Modified (Newest)</option>
	              <option value="updatedAt:asc">Last Modified (Oldest)</option>
	            </select>
	          </div>
	        </div>
	      </div>

	      <div class="totals" aria-live="polite">
	        <span id="totalItems" class="muted">Total Items: 0</span>
	        <span id="totalInStock" class="muted">In Stock: 0</span>
	        <span id="totalLowStock" class="muted">Low Stock: 0</span>
	        <span id="totalQty" class="muted">Total Qty: 0</span>
	      </div>

	      <div class="order-pill-container" id="orderPillContainer" style="display:none;">
	        <button class="order-pill" id="orderPill" data-order-reset aria-label="Shopping Cart (tap to clear selected items)">
	          <span class="order-pill-value" id="orderPillValue">0</span>
	          <span class="order-pill-label">Items in Cart</span>
	          <span class="order-pill-hint">tap to clear</span>
	        </button>
	      </div>

	      <div class="scroll" id="tableWrap">
	        <table id="invTable" role="grid" aria-label="Inventory table">
		          <colgroup>
		            <col style="width:42px">
		            <col id="col-name">
		            <col id="col-desc">
		            <col id="col-qty" style="width:130px">
		            <col id="col-actions" style="width:96px">
		          </colgroup>
          <thead>
            <tr>
              <th class="sel"><input type="checkbox" id="chkAll" aria-label="Select all"></th>
              <th scope="col" class="sortable" data-col="name" aria-sort="ascending">Item <span class="sort-ind"></span></th>
              <th scope="col" class="sortable" data-col="desc">Description <span class="sort-ind"></span></th>
              <th scope="col" class="qty sortable" data-col="qty">Qty <span class="sort-ind"></span></th>
              <th scope="col" class="actions"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">
        <span id="editHint">Tap any cell to edit inline; <kbd>Enter</kbd> saves, <kbd>Esc</kbd> cancels.</span>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <img class="footer-logo" src="./assets/modulus/logo/modulus-logo-horizontal.svg" alt="Modulus Software, LLC" />
  </footer>

  <!-- Paste/Import modal -->
  <div id="pasteModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Paste Data</h2>
      <div class="muted" style="margin-bottom:10px;">
        Provide columns <code>Item, Description, Qty</code>. Headers optional; Qty optional (defaults to 0).
        Tabs, commas, or multi-space columns are accepted. You may also drop or choose a file.
      </div>
      <div class="drop" id="dropZone">Drop a CSV/TSV/TXT/JSON/XLSX/XLS/DOCX/PDF file here, or choose below.</div>
      <input type="file" id="fileImportModal" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" style="display:block;margin:10px 0;" />
      <textarea id="pasteArea" rows="8" placeholder="Item, Description, Qty"></textarea>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <span id="pasteInfo" class="muted" style="margin-right:auto"></span>
        <button class="btn" id="btnPasteCancel">Cancel</button>
        <button class="btn primary" id="btnPasteApply">Import</button>
      </div>
    </div>
  </div>

  <!-- Add-one modal -->
  <div id="addOneModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Add Item</h2>
      <div style="display:grid; grid-template-columns:1fr; gap:8px;">
        <label class="muted">Item (unique)</label>
        <input id="addName" type="text" placeholder="Item" autocapitalize="off" autocomplete="off" spellcheck="false" />
        <label class="muted">Description (optional)</label>
        <input id="addDesc" type="text" placeholder="Description" />
        <label class="muted">Qty</label>
        <div class="qty-stepper" id="addQtyStepper" style="width:fit-content;">
          <button type="button" class="qty-stepper-btn" id="addQtyDec">−</button>
          <input type="text" inputmode="numeric" pattern="[0-9]*" class="qty-stepper-input" id="addQty" value="1" aria-label="Quantity">
          <button type="button" class="qty-stepper-btn" id="addQtyInc">+</button>
        </div>
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnAddCancel">Cancel</button>
        <button class="btn primary" id="btnAddSave">Add</button>
      </div>
    </div>
  </div>

  <!-- Mobile-friendly cell edit modal -->
		  <div id="editItemModal" class="modal" aria-hidden="true">
		    <div class="box edit-box">
		      <div class="edit-header">
		        <h2 id="editItemTitle" class="modal-title modal-title--edit">
		          <svg class="modal-title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false">
	            <path d="M12 20h9"></path>
	            <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
		          </svg>
		          <span>Edit Item</span>
		        </h2>
		      </div>
	      <div class="edit-body">
	        <div style="display:grid; grid-template-columns:1fr; gap:10px;">
	          <div>
            <label class="muted" for="editItemName">Item</label>
            <input id="editItemName" type="text" placeholder="Item" autocapitalize="off" autocomplete="off" spellcheck="false" />
          </div>
          <div>
	            <label class="muted" for="editItemDesc">Description</label>
		            <textarea id="editItemDesc" rows="3" placeholder="Description" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>
	          </div>
		          <div class="edit-steppers">
		            <label class="muted" for="editItemQty">Current Inventory</label>
		            <label class="muted" for="editLowStockQty">Low Stock Threshold</label>
		            <div class="qty-stepper qty-stepper--modal">
		              <button class="qty-step" id="editItemQtyMinus" type="button" aria-label="Decrease qty">−</button>
		              <input id="editItemQty" type="number" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" />
		              <button class="qty-step" id="editItemQtyPlus" type="button" aria-label="Increase qty">+</button>
		            </div>
		            <div class="qty-stepper qty-stepper--modal" aria-label="Low stock qty controls">
		              <button type="button" id="editLowStockMinus" class="qty-step" aria-label="Decrease low stock">−</button>
		              <input type="number" id="editLowStockQty" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done">
		              <button type="button" id="editLowStockPlus" class="qty-step" aria-label="Increase low stock">+</button>
		            </div>
		            <div class="edit-stepper-actions" aria-hidden="true"></div>
		            <div class="edit-stepper-actions">
		              <button type="button" id="btnEditUseGlobal" class="btn small">Use Global</button>
		            </div>
		          </div>
	          <div class="edit-toggle-row">
	            <label class="toggle-switch">
	              <input type="checkbox" id="editReorderEnabled" checked>
	              <span class="toggle-slider"></span>
	            </label>
	            <label for="editReorderEnabled" class="muted">Include this Part # in the batch Re-Order?</label>
	          </div>
	        </div>
	        <div id="editItemMsg" class="muted" style="margin-top:10px;"></div>
		      </div>
	      <div class="edit-footer">
	        <button class="btn danger" id="btnEditItemDelete">Delete</button>
	        <button class="btn" id="btnEditItemCancel">Close</button>
	      </div>
		    </div>
		  </div>

	  <!-- Message modal -->
	  <div id="msgModal" class="modal" aria-hidden="true">
	    <div class="box">
	      <h2 id="msgTitle" style="margin:0 0 10px;font-size:16px;">Message</h2>
      <div id="msgBody" class="muted" style="white-space:pre-wrap;"></div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnMsgCopy" type="button" style="display:none">Copy</button>
        <button class="btn primary" id="btnMsgOk" type="button">OK</button>
      </div>
    </div>
  </div>
	
  <!-- Confirm modal -->
  <div id="confirmModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 id="confirmTitle" style="margin:0 0 10px;font-size:16px;">Confirm</h2>
      <div id="confirmBody" class="muted" style="white-space:pre-wrap;"></div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnConfirmCancel" type="button">Cancel</button>
        <button class="btn primary" id="btnConfirmOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- Import preview -->
  <div id="previewModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Import Preview</h2>
      <div class="muted" id="previewInfo" style="margin-bottom:10px"></div>
      <div class="scroll" style="max-height:50vh">
        <table style="width:100%;border-collapse:collapse;font-size:14px">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Item</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Description</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">Old Qty</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">New Qty</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Action</th>
            </tr>
          </thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnPreviewCancel">Cancel</button>
        <button class="btn primary" id="btnPreviewApply">Apply Import</button>
      </div>
    </div>
  </div>

  <!-- Qty entry modal -->
  <div id="qtyEntryModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 id="qtyEntryTitle" style="margin:0 0 10px;font-size:16px;">Set Qty</h2>
      <div id="qtyEntrySubtitle" class="muted" style="margin-bottom:10px;display:none;"></div>
      <input id="qtyEntryInput" type="number" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" style="text-align:center;font-weight:900;font-size:22px;" />
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnQtyEntryCancel" type="button">Cancel</button>
        <button class="btn primary" id="btnQtyEntryOk" type="button">Save</button>
      </div>
    </div>
  </div>

  <!-- Order modal -->
  <div id="orderModal" class="modal" aria-hidden="true">
    <div class="box order-box">
      <div class="order-header">
        <h2>Create Order</h2>
      </div>

      <div class="order-body">
	        <div class="section">
	          <div class="section-title"><span>Materials</span></div>
	          <div class="input-wrap" style="max-width:100%;">
	            <input id="orderSearch" type="text" placeholder="Search inventory to add items…" autocomplete="off" />
	            <button class="clear-input-btn" id="btnClearOrderSearch" type="button" aria-label="Clear search" title="Clear search" style="display:none">
	              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	                <path d="M18 6L6 18"></path>
	                <path d="M6 6l12 12"></path>
	              </svg>
	            </button>
	          </div>
	          <div id="orderResultsBody" class="order-list" style="margin-top:10px;"></div>
	        </div>

        <div class="section">
          <div class="section-title">
            <span>Shopping Cart</span>
            <span id="orderLinesInfo"></span>
            <button type="button" id="btnResetOrderList" class="btn-icon-inline" aria-label="Reset order list" title="Reset order list">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
              </svg>
            </button>
          </div>
          <div id="orderLinesBody" class="order-list"></div>
        </div>

        <div class="section">
          <div class="section-title"><span>Order Fulfillment - Email Address</span></div>
          <input id="orderEmail" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />
          <div id="orderEmailSuggest" class="order-suggest" aria-label="Email suggestions"></div>
        </div>

        <div class="section">
          <div class="section-title"><span>Shipping Address</span></div>
          <div class="order-shipping-row">
            <select id="orderShippingAddress" aria-label="Shipping address"></select>
            <button class="btn" id="btnOrderShippingManage" type="button">Manage</button>
          </div>
          <div id="orderShippingPreview" class="muted" style="margin-top:6px;"></div>
        </div>

        <div class="section">
          <div class="section-title"><span>Message</span></div>
          <div style="display:grid; grid-template-columns:1fr; gap:10px;">
		            <div class="order-po-grid">
		              <div>
		                <div class="muted" style="margin-bottom:6px;">Company PO Number (optional)</div>
		                <input id="orderCompanyPoNumber" type="text" placeholder="Company PO #" />
		              </div>
		              <div>
		                <div class="muted" style="margin-bottom:6px;">Internal PO ID</div>
		                <input id="orderInternalPoNumber" type="text" readonly />
		              </div>
		              <div class="order-po-subject">
		                <div class="muted" style="margin-bottom:6px;">Subject</div>
		                <input id="orderSubject" type="text" readonly />
		              </div>
		            </div>
            <div>
              <div class="muted" style="margin-bottom:6px;">Notes (optional)</div>
              <textarea id="orderNotes" rows="3" placeholder="Any notes…"></textarea>
            </div>
            <div class="order-preview">
              <div class="muted" style="margin-bottom:6px;">Email Preview</div>
              <div id="orderPreviewHtml" class="order-preview-html"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="order-footer">
        <button class="btn" id="btnOrderCancel">Close</button>
        <button class="btn" id="btnOrderCopy">Copy</button>
        <button class="btn primary order-send" id="btnOrderSubmit">Submit Order</button>
      </div>
    </div>
  </div>

  <!-- Shipping addresses modal -->
  <div id="shippingAddressModal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;">Shipping Addresses</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" id="btnShippingAddressNew" type="button">Add New</button>
          <button class="btn" id="btnShippingAddressClose" type="button">Close</button>
        </div>
      </div>
      <div id="shippingAddressList" class="shipping-address-list" aria-live="polite"></div>
      <div class="section-divider"></div>
      <div id="shippingAddressFormTitle" class="muted" style="margin-bottom:8px;">Add Shipping Address</div>
      <div class="shipping-address-form">
        <label class="muted">Label</label>
        <input id="shippingAddressLabel" type="text" placeholder="Main Warehouse" />
        <label class="muted">Address</label>
        <textarea id="shippingAddressValue" rows="3" placeholder="123 Main St&#10;City, ST 12345"></textarea>
        <div class="shipping-address-default">
          <label class="toggle-switch">
            <input id="shippingAddressDefault" type="checkbox" />
            <span class="toggle-slider"></span>
          </label>
          <label for="shippingAddressDefault" class="muted" style="font-size:13px;cursor:pointer;">Set as default</label>
        </div>
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn primary" id="btnShippingAddressSave" type="button">Save</button>
      </div>
      <div id="shippingAddressMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- iOS-style qty picker -->
  <div id="qtyPickerModal" class="modal qty-picker-modal" aria-hidden="true">
    <div class="qty-picker-backdrop"></div>
    <div class="qty-picker-sheet">
      <div class="qty-picker-header">
        <button type="button" class="qty-picker-cancel" id="qtyPickerCancel">Cancel</button>
        <div class="qty-picker-title" id="qtyPickerTitle">Order Qty</div>
        <button type="button" class="qty-picker-done" id="qtyPickerDone">Done</button>
      </div>
      <div class="qty-picker-wheel-wrap">
        <div class="qty-picker-highlight"></div>
        <div class="qty-picker-wheel" id="qtyPickerWheel"></div>
      </div>
    </div>
  </div>

	  <!-- Order history -->
		  <div id="orderHistoryModal" class="modal" aria-hidden="true">
		    <div class="box">
	      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
	        <h2 style="margin:0;font-size:16px;">Order History</h2>
	        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
	          <button class="btn btn-icon" id="btnOrderHistoryDownload" type="button" title="Download CSV" aria-label="Download order history CSV">
	            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
	              <polyline points="7 10 12 15 17 10"></polyline>
	              <line x1="12" y1="15" x2="12" y2="3"></line>
	            </svg>
	          </button>
	          <button class="btn" id="btnOrderHistoryRefresh" type="button">Refresh</button>
	          <button class="btn" id="btnOrderHistoryClose" type="button">Close</button>
	        </div>
	      </div>
	      <div class="input-wrap" style="max-width:100%; margin-top:10px;">
	        <input id="orderHistoryFilter" type="text" placeholder="Filter history…" autocomplete="off" />
	        <button class="clear-input-btn" id="btnClearOrderHistoryFilter" type="button" aria-label="Clear history filter" title="Clear filter" style="display:none">
	          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	            <path d="M18 6L6 18"></path>
	            <path d="M6 6l12 12"></path>
	          </svg>
	        </button>
	      </div>
		      <div id="orderHistoryList" class="history-list" aria-live="polite"></div>
		    </div>
		  </div>

		  <!-- Trash -->
		  <div id="trashModal" class="modal" aria-hidden="true">
		    <div class="box">
		      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
		        <h2 style="margin:0;font-size:16px;">Trash</h2>
		        <button class="btn" id="btnTrashClose" type="button">Close</button>
		      </div>
		      <div class="trash-controls">
		        <input id="trashFilter" type="text" placeholder="Filter deleted items…" autocomplete="off" />
		        <button class="btn" id="btnTrashReload" type="button">Refresh</button>
		      </div>
		      <div id="trashList" class="trash-list" aria-live="polite"></div>
		      <div id="trashMsg" class="muted" style="margin-top:8px;"></div>
		    </div>
		  </div>

		  <!-- Inventory report -->
		  <div id="reportModal" class="modal" aria-hidden="true">
		    <div class="box">
		      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
		        <h2 style="margin:0;font-size:16px;">Inventory Report</h2>
	        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
	          <button class="btn btn-icon" id="btnReportShare" type="button" title="Share report" aria-label="Share report">
	            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	              <path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"></path>
	              <polyline points="16 6 12 2 8 6"></polyline>
	              <line x1="12" y1="2" x2="12" y2="15"></line>
	            </svg>
	          </button>
	          <button class="btn btn-icon" id="btnReportDownload" type="button" title="Download CSV" aria-label="Download report CSV">
	            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
	              <polyline points="7 10 12 15 17 10"></polyline>
	              <line x1="12" y1="15" x2="12" y2="3"></line>
	            </svg>
	          </button>
	          <button class="btn" id="btnReportClose" type="button">Close</button>
	        </div>
	      </div>

			      <div class="report-progress" id="reportProgress" style="display:none;" aria-live="polite">
			        <div class="report-progress-label">
			          <span id="reportProgressLabel">Analyzing Low Stock Items...</span>
			          <span class="report-progress-value" id="reportProgressValue">0%</span>
			        </div>
			        <div class="report-progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
			          <div class="report-progress-bar" id="reportProgressBar" style="width:0%"></div>
			        </div>
			      </div>

			      <div id="reportContent" style="display:none;">
				      <div class="report-metrics" aria-label="Report summary">
				        <div class="report-metric"><div class="muted">Total Items</div><div class="val" id="reportMetricTotalItems">0</div></div>
				        <div class="report-metric"><div class="muted">Total Qty</div><div class="val" id="reportMetricTotalQty">0</div></div>
				      </div>

				      <div class="order-pill-container report-pill-container" id="reportOrderPillContainer" style="display:none;">
				        <button class="order-pill" id="reportOrderBadge" data-order-reset role="status" aria-live="polite" aria-label="Clear shopping cart selections">
				          <span class="order-pill-value" id="reportOrderCount">0</span>
				          <span class="order-pill-label">Items in Cart</span>
				          <span class="order-pill-hint">tap to clear</span>
				        </button>
				      </div>
		
					      <details class="report-section" id="reportLowStockSection">
					        <summary class="report-summary">
					          <div class="report-summary-left">
					            <h3><span class="led-dot led-dot--amber"></span>Low Stock Items <span class="report-count" id="reportLowStockCount">(0)</span></h3>
					          </div>
					          <div class="report-summary-right">
					            <button type="button" class="report-batch-btn" id="btnReportBatchOrder" title="Add all low stock items to cart" aria-label="Add all low stock items to shopping cart">
					              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					                <circle cx="9" cy="21" r="1"></circle>
					                <circle cx="20" cy="21" r="1"></circle>
					                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
					                <path d="M16 3v6"></path>
					                <path d="M13 6h6"></path>
					              </svg>
					            </button>
					            <span class="report-chevron" aria-hidden="true">▾</span>
					          </div>
					        </summary>
					        <div class="report-list" id="reportLowStockList"></div>
				      </details>

				      <details class="report-section" id="reportExemptSection">
				        <summary class="report-summary">
				          <div class="report-summary-left">
				            <h3><span class="led-dot led-dot--cyan"></span>Exempt from Batch Re-order <span class="report-count" id="reportExemptCount">(0)</span></h3>
				          </div>
				          <div class="report-summary-right">
				            <span class="report-chevron" aria-hidden="true">▾</span>
				          </div>
				        </summary>
				        <div class="report-list" id="reportExemptList"></div>
				      </details>

				      <details class="report-section" id="reportInventorySection">
				        <summary class="report-summary">
				          <div class="report-summary-left">
				            <h3>Current Inventory <span class="report-count" id="reportInStockCount">(0)</span></h3>
				          </div>
				          <div class="report-summary-right">
				            <span class="report-chevron" aria-hidden="true">▾</span>
				          </div>
				        </summary>
				        <div class="report-list" id="reportList" aria-live="polite"></div>
				      </details>
			      </div>
			    </div>
			  </div>

		  <!-- Email inventory report -->
		  <div id="reportEmailModal" class="modal" aria-hidden="true">
		    <div class="box">
		      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
		        <h2 style="margin:0;font-size:16px;">Email Inventory Report</h2>
		        <button class="btn" id="btnReportEmailClose" type="button">Close</button>
		      </div>
		      <div style="display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px;">
		        <label class="muted">To</label>
		        <input id="reportEmailTo" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />
		        <label class="muted">Subject</label>
		        <input id="reportEmailSubject" type="text" placeholder="Inventory Report" />
		      </div>
		      <div class="order-preview" style="margin-top:12px;">
		        <div class="muted" style="margin-bottom:6px;">Email Preview</div>
		        <div id="reportEmailPreview" class="order-preview-html"></div>
		      </div>
		      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
		        <div id="reportEmailMsg" class="muted" style="margin-right:auto;"></div>
		        <button class="btn" id="btnReportEmailCopy" type="button">Copy</button>
		        <button class="btn primary" id="btnReportEmailSend" type="button">Send</button>
		      </div>
		    </div>
		  </div>

  <!-- Auth modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Sign In</h2>
      <div class="muted" style="margin-bottom:10px;">Invite-only access. Contact your admin for an account.</div>
      <div style="display:grid; grid-template-columns:1fr; gap:8px;">
        <label class="muted">Email</label>
        <input id="authEmail" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email" />
        <label class="muted" id="authPasswordLabel">Password</label>
        <input id="authPassword" type="password" placeholder="Password" autocomplete="current-password" />
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn primary" id="btnAuthSubmit">Sign In</button>
      </div>
      <div class="auth-actions">
        <button class="auth-link" id="btnAuthForgot" type="button">Forgot password?</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Password reset modal -->
  <div id="resetModal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;">Reset Password</h2>
        <button class="btn" id="btnResetClose" type="button">Close</button>
      </div>
      <div style="display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px;">
        <label class="muted">New Password</label>
        <input id="resetPassword" type="password" placeholder="New password" autocomplete="new-password" />
        <label class="muted">Confirm Password</label>
        <input id="resetPasswordConfirm" type="password" placeholder="Confirm password" autocomplete="new-password" />
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn primary" id="btnResetSubmit">Update Password</button>
      </div>
      <div id="resetMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Invite modal -->
  <div id="inviteModal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;">Invite User</h2>
        <button class="btn" id="btnInviteClose" type="button">Close</button>
      </div>
      <div class="invite-section" id="inviteSection" style="margin-top:10px;">
        <div class="invite-grid">
          <div id="inviteCompanyRow">
            <label class="muted">Company</label>
            <select id="inviteCompany" aria-label="Invite company"></select>
          </div>
          <div>
            <label class="muted">Email</label>
            <input id="inviteEmail" type="email" placeholder="newuser@example.com" autocomplete="email" inputmode="email" />
          </div>
          <div>
            <label class="muted">Role</label>
            <select id="inviteRole">
              <option value="member">Member</option>
              <option value="admin">Admin</option>
              <option value="viewer">Viewer</option>
            </select>
          </div>
        </div>
        <div class="invite-actions">
          <button class="btn primary" id="btnInviteSend" type="button">Send Invite</button>
        </div>
        <div class="invite-link-row" id="inviteLinkRow">
          <input id="inviteLink" type="text" readonly />
          <button class="btn" id="btnInviteCopy" type="button">Copy</button>
        </div>
        <div id="inviteMsg" class="muted" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- User management modal -->
  <div id="userMgmtModal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;">Manage Users</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" id="btnUserMgmtRefresh" type="button">Refresh</button>
          <button class="btn" id="btnUserMgmtClose" type="button">Close</button>
        </div>
      </div>
      <div class="user-mgmt-controls" id="userMgmtControls">
        <div>
          <label class="muted">Company</label>
          <select id="userMgmtCompany" aria-label="Manage users company"></select>
        </div>
      </div>
      <div id="userMgmtList" class="user-mgmt-list" aria-live="polite"></div>
      <div id="userMgmtMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Role manager modal -->
  <div id="roleManagerModal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;">Role Manager</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" id="btnRoleManagerClose" type="button">Close</button>
          <button class="btn primary" id="btnRoleManagerSave" type="button">Save</button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px;">Configure role permissions. Super user permissions are fixed.</div>
      <div class="role-manager-table-wrap">
        <table class="role-manager-table">
          <thead>
            <tr>
              <th>Permission</th>
              <th>Admin</th>
              <th>Member</th>
              <th>Viewer</th>
            </tr>
          </thead>
          <tbody id="roleManagerBody"></tbody>
        </table>
      </div>
      <div id="roleManagerMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Role requests modal -->
  <div id="roleRequestsModal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;">Role Requests</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" id="btnRoleRequestsRefresh" type="button">Refresh</button>
          <button class="btn" id="btnRoleRequestsClose" type="button">Close</button>
        </div>
      </div>
      <div id="roleRequestsList" class="role-requests-list" aria-live="polite"></div>
      <div id="roleRequestsMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Audit log modal -->
  <div id="auditModal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;">Audit Log</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn btn-icon" id="btnAuditDownload" type="button" title="Download audit log CSV" aria-label="Download audit log CSV">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
          </button>
          <button class="btn" id="btnAuditRefresh" type="button">Refresh</button>
          <button class="btn" id="btnAuditClose" type="button">Close</button>
        </div>
      </div>
      <div class="audit-filters">
        <input id="auditSearchFilter" type="text" placeholder="Filter audit log…" autocomplete="off" />
        <select id="auditTableFilter">
          <option value="">All tables</option>
          <option value="inventory_items">Inventory Items</option>
          <option value="orders">Orders</option>
          <option value="company_members">Company Members</option>
          <option value="invitations">Invitations</option>
          <option value="role_change_requests">Role Requests</option>
        </select>
        <select id="auditActionFilter">
          <option value="">All actions</option>
          <option value="INSERT">INSERT</option>
          <option value="UPDATE">UPDATE</option>
          <option value="DELETE">DELETE</option>
          <option value="RESTORE">RESTORE</option>
          <option value="BULK_DELETE">BULK_DELETE</option>
        </select>
      </div>
      <div id="auditList" class="audit-list" aria-live="polite"></div>
      <div id="auditMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Snapshots modal -->
  <div id="snapshotsModal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;">Inventory Snapshots</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" id="btnSnapshotsClose" type="button">Close</button>
        </div>
      </div>
      <div id="snapshotsList" class="snapshots-list" aria-live="polite"></div>
      <div id="snapshotPreview" class="snapshot-preview" style="display:none;">
        <div class="snapshot-preview-header">
          <button class="btn small" id="btnSnapshotBack" type="button">Back</button>
          <div class="snapshot-preview-title" id="snapshotPreviewTitle"></div>
        </div>
        <div class="snapshot-preview-meta" id="snapshotPreviewMeta"></div>
        <div class="snapshot-preview-table scroll">
          <table class="metrics-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>SKU</th>
                <th>Qty</th>
                <th>Category ID</th>
                <th>Location ID</th>
              </tr>
            </thead>
            <tbody id="snapshotPreviewBody"></tbody>
          </table>
        </div>
      </div>
      <div id="snapshotsMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Metrics modal -->
  <div id="metricsModal" class="modal" aria-hidden="true">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
        <h2 style="margin:0;font-size:16px;" id="metricsTitle">Metrics Dashboard</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
          <button class="btn" id="btnMetricsClose" type="button">Close</button>
        </div>
      </div>
      <div class="metrics-toolbar">
        <select id="metricsRange" aria-label="Metrics date range">
          <option value="7">Last 7 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="90">Last 90 days</option>
        </select>
        <select id="metricsView" aria-label="Metrics view" style="display:none;">
          <option value="company">Company View</option>
          <option value="platform">Platform View</option>
        </select>
      </div>
      <div id="metricsContent" class="metrics-content" aria-live="polite"></div>
      <div id="metricsMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Account</h2>
      <div class="muted" id="profileEmailDisplay" style="margin-bottom:10px;"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <div>
          <label class="muted">First Name</label>
          <input id="profileFirstName" type="text" placeholder="First" autocomplete="given-name" />
        </div>
        <div>
          <label class="muted">Last Name</label>
          <input id="profileLastName" type="text" placeholder="Last" autocomplete="family-name" />
        </div>
      </div>
	      <div style="display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px;">
	        <label class="muted">Phone</label>
	        <input id="profilePhone" type="tel" placeholder="(555) 555-5555" autocomplete="tel" inputmode="tel" />
	        <label class="muted">Global Low Stock Qty</label>
	        <input id="profileLowStockQtyGlobal" type="number" min="0" step="1" inputmode="numeric" placeholder="0" />
	        <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
	          <label class="toggle-switch">
	            <input id="profileSilenceLowStockAlerts" type="checkbox" />
	            <span class="toggle-slider"></span>
	          </label>
	          <label for="profileSilenceLowStockAlerts" class="muted" style="font-size:13px;cursor:pointer;">Hide low stock LED indicators</label>
	        </div>
	      </div>
	      <div class="section-divider"></div>
	      <div class="role-request-section" id="roleRequestSection">
	        <div class="role-request-title">Request Role Change</div>
	        <div class="role-request-meta" id="roleRequestCurrent"></div>
	        <label class="muted">New Role</label>
	        <select id="roleRequestRole"></select>
	        <label class="muted">Reason (optional)</label>
	        <textarea id="roleRequestReason" rows="2" placeholder="Why do you need this role?"></textarea>
	        <div class="role-request-actions">
	          <button class="btn" id="btnRoleRequest" type="button">Submit Request</button>
	        </div>
	        <div id="roleRequestMsg" class="muted" style="margin-top:4px;"></div>
	      </div>
      <div class="section-divider" id="tierOverrideDivider"></div>
      <div class="tier-admin-section" id="tierOverrideSection">
        <div class="role-request-title">Company Tier</div>
        <div class="role-request-meta" id="tierOverrideCompany"></div>
        <div class="tier-admin-grid">
          <div class="tier-admin-card">
            <div class="tier-admin-label">Billing Tier</div>
            <div class="tier-admin-value" id="tierBillingValue">—</div>
          </div>
          <div class="tier-admin-card">
            <div class="tier-admin-label">Manual Override</div>
            <div class="tier-admin-value" id="tierOverrideValue">—</div>
          </div>
          <div class="tier-admin-card">
            <div class="tier-admin-label">Effective Tier</div>
            <div class="tier-admin-value" id="tierEffectiveValue">—</div>
          </div>
          <div class="tier-admin-card">
            <div class="tier-admin-label">Billing State</div>
            <div class="tier-admin-value" id="tierBillingStateValue">—</div>
          </div>
        </div>
        <label class="muted" for="tierOverrideSelect">Set Manual Override</label>
        <select id="tierOverrideSelect" aria-label="Select manual tier override"></select>
        <label class="muted" for="tierOverrideReason">Reason</label>
        <textarea id="tierOverrideReason" rows="2" placeholder="Why is this override needed?"></textarea>
        <div class="tier-admin-actions">
          <button class="btn" id="btnTierOverrideSave" type="button">Save Override</button>
          <button class="btn" id="btnTierOverrideClear" type="button">Clear Override</button>
        </div>
        <div id="tierOverrideMsg" class="muted" style="margin-top:4px;"></div>
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnSignOut">Sign Out</button>
        <button class="btn" id="btnProfileClose">Close</button>
      </div>
      <div id="profileMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Advanced company switcher (super user only) -->
  <div id="advancedCompanyModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Advanced Company Switcher</h2>
      <div class="muted" style="margin-bottom:10px;">Super-user only. Switching here does not change your default company.</div>
      <div class="advanced-switcher-controls">
        <div class="field">
          <label class="muted" for="advancedCompanySearch">Search</label>
          <input id="advancedCompanySearch" type="text" placeholder="Company name or exact company ID" />
        </div>
        <div class="field">
          <label class="muted" for="advancedCompanyTypeFilter">Environment</label>
          <select id="advancedCompanyTypeFilter">
            <option value="production" selected>Production</option>
            <option value="sandbox">Sandbox</option>
            <option value="test">Test</option>
            <option value="system">System</option>
            <option value="">All</option>
          </select>
        </div>
      </div>
      <div class="advanced-switcher-actions">
        <button class="btn" id="advancedCompanySearchBtn" type="button">Search</button>
        <button class="btn" id="advancedCompanyReturnBtn" type="button">Return to Production</button>
      </div>
      <div id="advancedCompanyResults" class="advanced-switcher-results"></div>
      <div id="advancedCompanyMsg" class="advanced-switcher-hint"></div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="advancedCompanyClose" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Diagnostics modal (super user only) -->
  <div id="diagnosticsModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 6px;font-size:16px;">Diagnostics</h2>
      <div class="muted" style="margin-bottom:10px;">Simulation and inspection only. No data writes.</div>
      <div class="diag-section">
        <div class="role-request-title">Role & Tier Simulation</div>
        <div class="muted" style="margin-bottom:6px;">Session-scoped only. Does not affect backend authorization.</div>
        <label class="muted" for="diagRoleSelect">Simulated Role</label>
        <select id="diagRoleSelect">
          <option value="">Use current role</option>
          <option value="super_user">super_user</option>
          <option value="admin">admin</option>
          <option value="member">member</option>
          <option value="viewer">viewer</option>
        </select>
        <label class="muted" for="diagTierSelect" style="margin-top:8px;">Simulated Subscription Tier</label>
        <select id="diagTierSelect">
          <option value="">Use current tier</option>
          <option value="starter">Starter</option>
          <option value="professional">Professional</option>
          <option value="business">Business</option>
          <option value="enterprise">Enterprise</option>
        </select>
        <div class="diag-actions">
          <button class="btn" id="diagApply" type="button">Apply Simulation</button>
          <button class="btn" id="diagReset" type="button">Reset Simulation</button>
        </div>
        <div id="diagSimMsg" class="muted"></div>
      </div>
      <div class="section-divider"></div>
      <div class="diag-section">
        <div class="role-request-title">Enforcement Inspection</div>
        <div id="diagChecks"></div>
      </div>
      <div class="section-divider"></div>
      <div class="diag-section">
        <div class="role-request-title">Metric Preview (Read-Only)</div>
        <label class="muted" for="diagMetricId">Metric ID</label>
        <input id="diagMetricId" type="text" placeholder="INVENTORY_TURNOVER" />
        <label class="muted" for="diagMetricContext" style="margin-top:8px;">Time Context (JSON)</label>
        <textarea id="diagMetricContext" rows="3" placeholder='{"period_start":"2025-01-01","period_end":"2025-01-31"}'></textarea>
        <label class="muted" for="diagMetricInputs" style="margin-top:8px;">Inputs (JSON)</label>
        <textarea id="diagMetricInputs" rows="4" placeholder='{"COGS":100000,"AverageInventory":50000}'></textarea>
        <div class="diag-actions">
          <div class="muted" id="diagMetricTierHint"></div>
          <button class="btn" id="diagMetricRun" type="button">Run Preview</button>
        </div>
        <pre id="diagMetricOutput" class="diag-output"></pre>
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="diagClose" type="button">Close</button>
      </div>
    </div>
  </div>

	  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script type="module" src="./src/utils.js"></script>

		  <script>
		    // UUID helper (works on older mobile browsers and non-HTTPS dev hosts)
		    let _nativeRandomUUID = null;
		    try{
		      if(typeof crypto !== 'undefined' && crypto && typeof crypto.randomUUID === 'function'){
		        const candidate = crypto.randomUUID.bind(crypto);
		        candidate(); // ensure it works (some browsers expose but throw on insecure contexts)
		        _nativeRandomUUID = candidate;
		      }
		    }catch(e){
		      _nativeRandomUUID = null;
		    }
		    function randomUUID(){
		      if(_nativeRandomUUID){
		        try{ return _nativeRandomUUID(); }catch(e){}
		      }
		      const cryptoObj = (typeof crypto !== 'undefined') ? crypto : null;
		      const bytes = new Uint8Array(16);
		      if(cryptoObj && typeof cryptoObj.getRandomValues === 'function'){
		        try{
		          cryptoObj.getRandomValues(bytes);
		        }catch(e){
		          for(let i=0;i<bytes.length;i++) bytes[i] = Math.floor(Math.random()*256);
		        }
		      }else{
		        for(let i=0;i<bytes.length;i++) bytes[i] = Math.floor(Math.random()*256);
		      }
		      // RFC4122 v4
		      bytes[6] = (bytes[6] & 0x0f) | 0x40;
		      bytes[8] = (bytes[8] & 0x3f) | 0x80;
		      const hex = Array.from(bytes, b => b.toString(16).padStart(2,'0'));
		      return `${hex[0]}${hex[1]}${hex[2]}${hex[3]}-${hex[4]}${hex[5]}-${hex[6]}${hex[7]}-${hex[8]}${hex[9]}-${hex[10]}${hex[11]}${hex[12]}${hex[13]}${hex[14]}${hex[15]}`;
		    }
		    if(!_nativeRandomUUID){
		      try{
		        const cryptoObj = (typeof crypto !== 'undefined') ? crypto : null;
		        if(cryptoObj) cryptoObj.randomUUID = randomUUID;
		      }catch(e){}
		      try{
		        if(typeof Crypto !== 'undefined' && Crypto.prototype){
		          Object.defineProperty(Crypto.prototype, 'randomUUID', { value: randomUUID, configurable: true, writable: true });
		        }
		      }catch(e){}
		    }

	    // ========================
	    // State & persistence
	    // ========================
    const DB_KEY='inv.single.inline.mobile.v1';
	    const state={
	      items:[],
	      updatedAt:null,
	      _filter:'',
	      _sort:{col:'name', dir:'asc'},
	      _order:{
	        lines:[],
	        email:'',
	        companyPoNumber:'',
	        internalPoNumber:'',
	        subject:'',
	        notes:'',
	        contactName:'',
	        search:'',
	        shippingAddressId:'',
	        shippingAddressSnapshot:null
	      },
	      _shippingAddresses:[],
	      _shippingAddressById:new Map(),
	      _shippingAddressEditing:null,
	      _trashItems:[],
	      _trashFilter:'',
	      _roleRequestPending:null,
      _roleRequests:[],
      _auditRows:[],
      _auditTableFilter:'',
      _auditActionFilter:'',
      _auditSearch:'',
      _userMgmtRows:[],
      _snapshots:[],
      _snapshotPreview:null,
      _metrics:null,
      _roleConfigs:{},
      _roleChanges:{},
      _impersonationRole:'super_user',
      _impersonationPermissions:null,
      _tierDetails:null,
      _tierDetailsCompanyId:null,
      _advancedCompanies:[],
      _advancedSearch:'',
      _advancedType:'production',
      _defaultCompanyId:null,
      _diagRole:'',
      _diagTier:'',
      _diagPermissions:null
    };
    const APP_VERSION = '2.0.0';

    const $ = (id) => document.getElementById(String(id).replace(/^#/, ''));
    const IMUtils = window.IMUtils || {};
    const toKey = IMUtils.toKey || ((s) => (s || '').trim().toUpperCase());
    const toInt = IMUtils.toInt || ((v, f = 0) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return f;
      const i = Math.floor(n);
      return i < 0 ? f : i;
    });
    if (!IMUtils.toKey) IMUtils.toKey = toKey;
    if (!IMUtils.toInt) IMUtils.toInt = toInt;
    window.IMUtils = IMUtils;
    function setUpdated(){ state.updatedAt=new Date().toISOString(); }
    // Persist only UI prefs; never persist items
    function save(){ const prefs={updatedAt:state.updatedAt,_filter:state._filter,_sort:state._sort}; localStorage.setItem(DB_KEY, JSON.stringify(prefs)); render(); }
    function load(){
      const raw=localStorage.getItem(DB_KEY);
      if(raw){
        try{
          const p=JSON.parse(raw);
          if(p){
            if(typeof p._filter==='string') state._filter=p._filter;
            if(p._sort){
              // Handle array format (convert to single)
              if(Array.isArray(p._sort) && p._sort[0] && typeof p._sort[0].col === 'string'){
                state._sort = { col: p._sort[0].col, dir: p._sort[0].dir === 'desc' ? 'desc' : 'asc' };
              } else if(typeof p._sort.col === 'string'){
                state._sort = { col: p._sort.col, dir: p._sort.dir === 'desc' ? 'desc' : 'asc' };
              }
            }
            if(p.updatedAt) state.updatedAt=p.updatedAt;
          }
        } catch(e){}
      }
    }



    function dedupe(){
      const seen=new Set();
      state.items=state.items.filter(it=>{
        const k=toKey(it.name); if(!k) return false;
        if(seen.has(k)) return false;
        seen.add(k);
        if(!it.id) it.id=randomUUID();
        it.qty = toInt(it.qty,0);
        return true;
      });
    }

    // Shallow clone of items for optimistic-UI rollback
    function snapshotItems(){ return state.items.map(it => ({...it})); }

	    // ========================
	    // Supabase (cloud sync) — optional
	    // ========================
    const SB = { client:null, ready:false, connected:false, session:null, user:null, authorized:false, profile:null, companyId:null, company:null, companyTier:null, companies:[], permissions:null, itemsHasLowStockQty:null, itemsHasReorderEnabled:null, ordersHasReceipt:null, warnedLowStockSchema:false, warnedReorderSchema:false, warnedOrdersReceiptSchema:false, warnedTierMissing:false };
    const COMPANY_STORAGE_PREFIX = 'inv.company.v1';
    let _inviteCompanyId = '';
    let _userMgmtCompanyId = '';
    const PERMISSIONS = {
      ITEMS_VIEW: 'items:view',
      ITEMS_CREATE: 'items:create',
      ITEMS_EDIT: 'items:edit',
      ITEMS_DELETE: 'items:delete',
      ITEMS_RESTORE: 'items:restore',
      ITEMS_EXPORT: 'items:export',
      ITEMS_IMPORT: 'items:import',
      ORDERS_VIEW: 'orders:view',
      ORDERS_CREATE: 'orders:create',
      ORDERS_EDIT: 'orders:edit',
      ORDERS_DELETE: 'orders:delete',
      ORDERS_RESTORE: 'orders:restore',
      ORDERS_MANAGE_SHIPPING: 'orders:manage_shipping',
      MEMBERS_VIEW: 'members:view',
      MEMBERS_INVITE: 'members:invite',
      MEMBERS_REMOVE: 'members:remove',
      MEMBERS_CHANGE_ROLE: 'members:change_role',
      COMPANY_VIEW_SETTINGS: 'company:view_settings',
      COMPANY_EDIT_SETTINGS: 'company:edit_settings',
      AUDIT_LOG_VIEW: 'audit_log:view',
      METRICS_VIEW: 'metrics:view',
      SNAPSHOTS_VIEW: 'snapshots:view',
      PLATFORM_VIEW_ALL: 'platform:view_all_companies',
      PLATFORM_MANAGE_ROLES: 'platform:manage_roles',
      PLATFORM_VIEW_METRICS: 'platform:view_metrics',
    };
    const LEGACY_PERMISSION_MAP = {
      [PERMISSIONS.ITEMS_VIEW]: { any:['can_read'] },
      [PERMISSIONS.ITEMS_CREATE]: { any:['can_create'] },
      [PERMISSIONS.ITEMS_EDIT]: { any:['can_update'] },
      [PERMISSIONS.ITEMS_DELETE]: { any:['can_delete'] },
      [PERMISSIONS.ITEMS_RESTORE]: { any:['can_delete'] },
      [PERMISSIONS.ITEMS_EXPORT]: { any:['can_read'] },
      [PERMISSIONS.ITEMS_IMPORT]: { all:['can_create','can_update'] },
      [PERMISSIONS.ORDERS_VIEW]: { any:['can_read'] },
      [PERMISSIONS.ORDERS_CREATE]: { any:['can_create'] },
      [PERMISSIONS.ORDERS_EDIT]: { any:['can_update'] },
      [PERMISSIONS.ORDERS_DELETE]: { any:['can_delete'] },
      [PERMISSIONS.ORDERS_RESTORE]: { any:['can_delete'] },
      [PERMISSIONS.MEMBERS_VIEW]: { any:['can_manage_users','can_invite'] },
      [PERMISSIONS.MEMBERS_INVITE]: { any:['can_invite'] },
      [PERMISSIONS.MEMBERS_REMOVE]: { any:['can_manage_users'] },
      [PERMISSIONS.MEMBERS_CHANGE_ROLE]: { any:['can_manage_users'] },
      [PERMISSIONS.AUDIT_LOG_VIEW]: { any:['can_invite'] },
      [PERMISSIONS.METRICS_VIEW]: { any:['can_invite'] },
      [PERMISSIONS.SNAPSHOTS_VIEW]: { any:['can_delete'] },
      [PERMISSIONS.PLATFORM_VIEW_ALL]: { any:['is_super_user'] },
      [PERMISSIONS.PLATFORM_MANAGE_ROLES]: { any:['is_super_user'] },
      [PERMISSIONS.PLATFORM_VIEW_METRICS]: { any:['is_super_user'] },
    };
    const IMPERSONATION_ROLES = IMUtils.buildImpersonationRoleOptions
      ? IMUtils.buildImpersonationRoleOptions(['super_user','admin','member','viewer'])
      : ['super_user','admin','member','viewer'];
    const IMPERSONATION_LOG_LIMIT = 25;
    const TIER_ORDER = ['starter','professional','business','enterprise'];
    const TIER_LABELS = {
      starter: 'Starter',
      professional: 'Professional',
      business: 'Business',
      enterprise: 'Enterprise'
    };
    const TIER_FALLBACK = 'starter';
    function getCompanyStorageKey(){
      const uid = (SB && SB.user && SB.user.id) ? String(SB.user.id) : 'anon';
      return `${COMPANY_STORAGE_PREFIX}.${uid}`;
    }
    function readSavedCompanyId(){
      try{
        const raw = localStorage.getItem(getCompanyStorageKey());
        const id = String(raw || '').trim();
        return id || null;
      }catch(e){ return null; }
    }
    function saveCompanyId(companyId){
      try{
        const id = String(companyId || '').trim();
        if(!id) return;
        localStorage.setItem(getCompanyStorageKey(), id);
        state._defaultCompanyId = id;
      }catch(e){}
    }
    async function sbLoadCompanies(){
      SB.companies = [];
      SB.companyId = null;
      SB.company = null;
      if(!SB.ready || !SB.user) return null;
      const { data, error } = await SB.client.rpc('get_my_companies', { p_include_non_production: false });
      if(error) throw error;
      const rows = Array.isArray(data) ? data : [];
      SB.companies = rows;
      let selected = readSavedCompanyId();
      if(selected && !rows.some(r => String(r.company_id) === String(selected))) selected = null;
      if(!selected && rows.length) selected = rows[0].company_id;
      SB.companyId = selected ? String(selected) : null;
      state._defaultCompanyId = SB.companyId ? String(SB.companyId) : null;
      SB.company = SB.companyId ? rows.find(r => String(r.company_id) === String(SB.companyId)) || null : null;
      SB.companyTier = SB.company ? getCompanyTier() : null;
      if(SB.companyId) saveCompanyId(SB.companyId);
      return SB.companyId;
    }
    async function sbLoadPermissions(){
      SB.permissions = null;
      if(!SB.ready || !SB.user || !SB.companyId) return null;
      try{
        const { data, error } = await SB.client.rpc('get_user_permissions', { p_company_id: SB.companyId });
        if(error) throw error;
        let merged = (data && typeof data === 'object') ? data : null;
        try{
          const { data: meta } = await SB.client.rpc('get_my_permissions', { p_company_id: SB.companyId });
          if(meta && typeof meta === 'object'){
            merged = merged ? { ...meta, ...merged } : meta;
          }
        }catch(metaErr){}
        SB.permissions = merged;
        return SB.permissions;
      }catch(e){
        const { data, error } = await SB.client.rpc('get_my_permissions', { p_company_id: SB.companyId });
        if(error) throw error;
        SB.permissions = (data && typeof data === 'object') ? data : null;
        return SB.permissions;
      }
    }
    function sbInit(){
      const url = window.SB_URL, key = window.SB_ANON;
      if(!url || !key || SB.client){ return; }
      try{
        if(!window.supabase || typeof window.supabase.createClient !== 'function'){
          console.warn('Supabase library not loaded; running in offline mode');
          SB.ready = false;
          return;
        }
        SB.client = window.supabase.createClient(url, key);
        SB.ready = true;
      }catch(err){
        console.warn('Supabase init failed:', err);
        SB.ready = false;
      }
    }
    function updateStatusBar(){
      // Update profile dropdown UI
      const statusEl = $('profileStatus');
      const emailEl = $('profileEmail');
      const connEl = $('profileConnection');
      const signInText = $('profileSignInText');
      const signInBtn = $('profileSignIn');

      // Icon SVGs
      const signInIcon = '<svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>';
      const signOutIcon = '<svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>';

      function setSignInUI(text, icon){
        if(signInText) signInText.textContent = text;
        if(signInBtn){
          const svg = signInBtn.querySelector('svg');
          if(svg) svg.outerHTML = icon;
        }
      }

      if(statusEl) statusEl.classList.remove('online','offline','warning');
      renderCompanyEnvBadge();

      if(!SB.ready){
        if(emailEl) emailEl.textContent = 'Not configured';
        if(connEl) connEl.textContent = 'Supabase not set up';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Configure', signInIcon);
        return;
      }
      if(!SB.session){
        if(emailEl) emailEl.textContent = 'Not signed in';
        if(connEl) connEl.textContent = 'Sign in required';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Sign In', signInIcon);
        return;
      }

      // Show user email
      const userEmail = SB.session?.user?.email || 'Unknown user';
      if(emailEl) emailEl.textContent = userEmail;

      const testingLabel = isImpersonating() ? ` · Testing: ${getEffectiveRole()}` : '';
      if(!SB.authorized){
        const reason = (!SB.companyId) ? 'No company access' : ((!SB.permissions || !hasPermission(PERMISSIONS.ITEMS_VIEW)) ? 'Permission denied' : 'Not authorized');
        if(connEl) connEl.textContent = `${reason}${testingLabel}`;
        if(statusEl) statusEl.classList.add('warning');
        setSignInUI('Sign Out', signOutIcon);
        return;
      }
      const companyName = (SB.company && SB.company.company_name) ? ` · ${SB.company.company_name}` : '';
      if(SB.connected){
        if(connEl) connEl.textContent = `Connected${companyName}${testingLabel}`;
        if(statusEl) statusEl.classList.add('online');
      }else{
        if(connEl) connEl.textContent = `Offline${companyName}${testingLabel}`;
        if(statusEl) statusEl.classList.add('offline');
      }
      setSignInUI('Sign Out', signOutIcon);
    }
    function explainGate(){
      if(!SB.ready) return 'Supabase not configured';
      if(!SB.session) return 'Sign in required';
      if(!SB.companyId) return 'No company access';
      if(!SB.permissions || !hasPermission(PERMISSIONS.ITEMS_VIEW)) return 'Permission denied';
      if(!SB.authorized) return 'Not authorized';
      if(!SB.connected) return 'Offline – edits disabled';
      return '';
    }
    async function checkServerHealth(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId){ SB.connected=false; updateStatusBar(); return false; }
      try{
        const { error } = await SB.client
          .from('inventory_items')
          .select('id', { head:true, count:'exact' })
          .eq('company_id', SB.companyId)
          .is('deleted_at', null)
          .limit(1);
        if(error) throw error;
        SB.connected = true;
      }catch(e){ SB.connected=false; }
      updateStatusBar();
      return SB.connected;
    }
    function isOnline(){ return SB.ready && !!SB.session && SB.authorized && SB.connected; }
    function requireOnline(){
      if(isOnline()) return true;
      const msg = explainGate();
      if(msg) toast(msg);
      if(!SB.session) show('authModal', true);
      return false;
    }
    function normalizeTier(value){
      const tier = String(value || '').trim().toLowerCase();
      return TIER_ORDER.includes(tier) ? tier : '';
    }
    function getCompanyTier(){
      const fromCompany = SB.company ? (SB.company.effective_tier || SB.company.company_tier || SB.company.tier || '') : '';
      const tier = normalizeTier(fromCompany);
      if(tier) return tier;
      if(SB.companyId && !SB.warnedTierMissing){
        SB.warnedTierMissing = true;
        console.warn('Company tier missing; defaulting to', TIER_FALLBACK);
      }
      return TIER_FALLBACK;
    }
    function hasTier(minTier){
      if(isEffectiveSuperUser()) return true;
      const current = normalizeTier(getCompanyTier()) || TIER_FALLBACK;
      const target = normalizeTier(minTier);
      if(!target) return true;
      return TIER_ORDER.indexOf(current) >= TIER_ORDER.indexOf(target);
    }
    function normalizeRoleName(value){
      if(IMUtils.normalizeImpersonationRole){
        return IMUtils.normalizeImpersonationRole(value, IMPERSONATION_ROLES);
      }
      const role = String(value || '').trim().toLowerCase();
      return IMPERSONATION_ROLES.includes(role) ? role : '';
    }
    function ensureImpersonationRole(value){
      if(IMUtils.ensureImpersonationRole){
        return IMUtils.ensureImpersonationRole(value, IMPERSONATION_ROLES);
      }
      return normalizeRoleName(value) || 'super_user';
    }
    function getImpersonationRoleOptions(){
      if(IMUtils.buildImpersonationRoleOptions){
        return IMUtils.buildImpersonationRoleOptions(IMPERSONATION_ROLES);
      }
      return IMPERSONATION_ROLES.slice();
    }
    function getAuthorityRole(){
      const raw = String((SB.company && SB.company.my_role) || (SB.permissions && SB.permissions.role) || '').trim();
      const normalized = normalizeRoleName(raw);
      if(normalized) return normalized;
      return isSuperUser() ? 'super_user' : '';
    }
    function isImpersonating(){
      const role = normalizeRoleName(state._impersonationRole);
      return !!(isSuperUser() && role && role !== 'super_user');
    }
    function getEffectiveRole(){
      if(isImpersonating()){
        return normalizeRoleName(state._impersonationRole) || 'super_user';
      }
      return getAuthorityRole();
    }
    function isEffectiveSuperUser(){
      return isSuperUser() && !isImpersonating();
    }
    function getEffectivePermissions(){
      if(isImpersonating() && state._impersonationPermissions && typeof state._impersonationPermissions === 'object'){
        return state._impersonationPermissions;
      }
      return SB.permissions;
    }
    function getImpersonationLogKey(){
      const userId = SB.user && SB.user.id ? String(SB.user.id) : 'anonymous';
      return `inv.impersonation.log.${userId}`;
    }
    function logImpersonationEvent(fromRole, toRole, reason){
      if(!SB.user) return;
      const entry = {
        ts: new Date().toISOString(),
        user_id: SB.user.id,
        company_id: SB.companyId || null,
        company_name: (SB.company && SB.company.company_name) ? SB.company.company_name : null,
        from: fromRole,
        to: toRole,
        reason: reason || 'manual',
      };
      try{
        const key = getImpersonationLogKey();
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        const list = Array.isArray(existing) ? existing : [];
        list.unshift(entry);
        if(list.length > IMPERSONATION_LOG_LIMIT) list.length = IMPERSONATION_LOG_LIMIT;
        localStorage.setItem(key, JSON.stringify(list));
      }catch(e){}
      console.info('[impersonation]', entry);
    }
    function resetImpersonationState(reason){
      const prev = normalizeRoleName(state._impersonationRole) || 'super_user';
      state._impersonationRole = 'super_user';
      state._impersonationPermissions = null;
      if(prev && prev !== 'super_user'){
        logImpersonationEvent(prev, 'super_user', reason || 'reset');
      }
    }
    async function loadImpersonationPermissions(role){
      if(!role || role === 'super_user') return null;
      const cached = state._roleConfigs && state._roleConfigs[role];
      if(cached && typeof cached === 'object') return cached;
      if(!SB.ready || !SB.session || !SB.client) return null;
      try{
        const { data, error } = await SB.client
          .from('role_configurations')
          .select('permissions')
          .eq('role_name', role)
          .maybeSingle();
        if(error) throw error;
        if(data && typeof data.permissions === 'object') return data.permissions;
        return {};
      }catch(e){
        console.warn('Impersonation permissions load failed:', e);
        return null;
      }
    }
    function refreshImpersonationUi(){
      updateStatusBar();
      renderRoleTestingSwitcher();
      renderInviteUi();
      renderRoleRequestUi();
      renderAdvancedCompanySwitcherButton();
      renderDiagnosticsButton();
      renderRoleRequestsAdminButton();
      renderRoleManagerButton();
      renderUserMgmtButton();
      renderUserMgmtControls();
      renderUserMgmtList();
      renderTierAdminSection();
      applyPermissionUI();
      render();
    }
    async function setImpersonationRole(nextRole, reason){
      if(!isSuperUser()){
        resetImpersonationState('not_super_user');
        refreshImpersonationUi();
        return false;
      }
      const desired = ensureImpersonationRole(nextRole);
      const prev = normalizeRoleName(state._impersonationRole) || 'super_user';
      if(desired === 'super_user'){
        if(prev !== 'super_user'){
          resetImpersonationState(reason || 'manual');
          refreshImpersonationUi();
        }
        return true;
      }
      state._impersonationRole = desired;
      const permissions = await loadImpersonationPermissions(desired);
      state._impersonationPermissions = (permissions && typeof permissions === 'object') ? permissions : {};
      if(prev !== desired){
        logImpersonationEvent(prev, desired, reason || 'manual');
      }
      refreshImpersonationUi();
      return true;
    }
    function hasPermission(key){
      const permissions = getEffectivePermissions();
      if(!permissions || !key) return false;
      if(Object.prototype.hasOwnProperty.call(permissions, key)){
        return permissions[key] === true;
      }
      const legacy = LEGACY_PERMISSION_MAP[key];
      if(legacy && Array.isArray(legacy.any)){
        return legacy.any.some(k => permissions[k] === true);
      }
      if(legacy && Array.isArray(legacy.all)){
        return legacy.all.every(k => permissions[k] === true);
      }
      return false;
    }
    function requirePermission(key, message){
      if(hasPermission(key)) return true;
      toast(message || 'Permission denied');
      return false;
    }
    function isSuperUser(){
      if(SB.company && SB.company.is_super_user) return true;
      if(SB.permissions && SB.permissions.is_super_user === true) return true;
      const role = String((SB.company && SB.company.my_role) || (SB.permissions && SB.permissions.role) || '').trim();
      return role === 'super_user';
    }
    function canItemsView(){ return hasPermission(PERMISSIONS.ITEMS_VIEW); }
    function canItemsCreate(){ return hasPermission(PERMISSIONS.ITEMS_CREATE); }
    function canItemsEdit(){ return hasPermission(PERMISSIONS.ITEMS_EDIT); }
    function canItemsDelete(){ return hasPermission(PERMISSIONS.ITEMS_DELETE); }
    function canItemsRestore(){ return hasPermission(PERMISSIONS.ITEMS_RESTORE); }
    function canItemsExport(){ return hasTier('professional') && hasPermission(PERMISSIONS.ITEMS_EXPORT); }
    function canItemsImport(){ return hasTier('professional') && hasPermission(PERMISSIONS.ITEMS_IMPORT); }
    function canOrdersView(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_VIEW); }
    function canOrdersCreate(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_CREATE); }
    function canOrdersEdit(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_EDIT); }
    function canOrdersDelete(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_DELETE); }
    function canOrdersManageShipping(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_MANAGE_SHIPPING); }
    function canMembersView(){ return hasPermission(PERMISSIONS.MEMBERS_VIEW); }
    function canMembersInvite(){ return hasPermission(PERMISSIONS.MEMBERS_INVITE); }
    function canMembersRemove(){ return hasPermission(PERMISSIONS.MEMBERS_REMOVE); }
    function canMembersChangeRole(){ return hasPermission(PERMISSIONS.MEMBERS_CHANGE_ROLE); }
    function canAuditView(){ return hasPermission(PERMISSIONS.AUDIT_LOG_VIEW); }
    function canMetricsView(){ return hasPermission(PERMISSIONS.METRICS_VIEW); }
    function canSnapshotsView(){ return hasPermission(PERMISSIONS.SNAPSHOTS_VIEW); }
    function canPlatformMetricsView(){ return hasPermission(PERMISSIONS.PLATFORM_VIEW_METRICS); }
    function canManageRoles(){ return hasPermission(PERMISSIONS.PLATFORM_MANAGE_ROLES) || isEffectiveSuperUser(); }
    function canAccessTrash(){ return canItemsDelete() || canItemsRestore(); }
    function canAccessMembers(){ return canMembersView() && hasTier('business'); }
    function canAccessInvites(){ return canMembersInvite() && hasTier('business'); }
    function canAccessRoleRequestsAdmin(){ return canMembersChangeRole() && hasTier('business'); }
    function canAccessRoleRequestsSelf(){ return hasTier('business'); }
    function canAccessAuditLog(){
      return canAuditView() && hasTier('enterprise');
    }
    function canAccessSnapshots(){
      return canSnapshotsView() && hasTier('business');
    }
    function canAccessMetrics(){
      const allowCompany = canMetricsView() && hasTier('professional');
      const allowPlatform = canPlatformMetricsView() && isEffectiveSuperUser() && hasTier('professional');
      return allowCompany || allowPlatform;
    }
    function canAccessRoleManager(){
      return isEffectiveSuperUser() && canManageRoles() && hasTier('business');
    }
    function canCreate(){ return canItemsCreate(); }
    function canUpdate(){ return canItemsEdit(); }
    function canDelete(){ return canItemsDelete(); }
    function canInvite(){ return canMembersInvite(); }
    function canManageUsers(){ return canMembersChangeRole() || canMembersRemove(); }
    function applyPermissionUI(){
      const canRead = canItemsView();
      const allowSelect = canItemsCreate() || canItemsEdit() || canItemsDelete();
      const canBulk = canItemsImport();
      const setDisabled = (id, disabled) => {
        const el = $(id);
        if(!el) return;
        el.disabled = !!disabled;
        el.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      };
      setDisabled('menuImport', !canBulk);
      setDisabled('menuPaste', !canBulk);
      setDisabled('menuAddOne', !canItemsCreate());
      setDisabled('menuOrder', !canOrdersCreate());
      setDisabled('menuHistory', !canOrdersView());
      setDisabled('menuTrash', !canAccessTrash());
      setDisabled('menuAudit', !canAccessAuditLog());
      setDisabled('menuSnapshots', !canAccessSnapshots());
      setDisabled('menuMetrics', !canAccessMetrics());
      setDisabled('menuExport', !canItemsExport());
      setDisabled('menuReport', !canItemsView());
      setDisabled('btnOrderSubmit', !canOrdersCreate());
      setDisabled('btnOrderShippingManage', !canOrdersManageShipping());
      setDisabled('btnEditItemDelete', !canItemsDelete());
      setDisabled('btnReportBatchOrder', !canOrdersCreate());
      const chkAll = $('chkAll');
      if(chkAll) chkAll.disabled = !allowSelect;
      setEditHint();
    }

    // ---------- Auth + profile ----------
    function renderAuthUi(){
      const submit = $('btnAuthSubmit');
      const pw = $('authPassword');
      const pwLabel = $('authPasswordLabel');
      if(submit) submit.textContent = 'Sign In';
      if(pw) pw.autocomplete = 'current-password';
      if(pwLabel) pwLabel.textContent = 'Password';
    }
    function setAuthMessage(msg){
      const el = $('authMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setResetMessage(msg){
      const el = $('resetMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setRoleRequestMessage(msg){
      const el = $('roleRequestMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setRoleRequestsMessage(msg){
      const el = $('roleRequestsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setAuditMessage(msg){
      const el = $('auditMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function auditSearchText(row){
      const action = String(row.action || '').trim();
      const tableName = String(row.table_name || '').trim();
      const recordId = String(row.record_id || '').trim();
      const user = String(row.user_email || '').trim();
      const role = String(row.user_role || '').trim();
      const oldVals = row.old_values ? JSON.stringify(row.old_values) : '';
      const newVals = row.new_values ? JSON.stringify(row.new_values) : '';
      const changed = Array.isArray(row.changed_fields) ? row.changed_fields.join(' ') : '';
      return `${action} ${tableName} ${recordId} ${user} ${role} ${changed} ${oldVals} ${newVals}`.toLowerCase();
    }
    function filteredAuditRows(){
      const rows = Array.isArray(state._auditRows) ? state._auditRows : [];
      const raw = String(state._auditSearch || '').trim().toLowerCase();
      if(!raw) return rows;
      const tokens = raw.split(/\s+/g).filter(Boolean);
      return rows.filter(r => {
        const hay = auditSearchText(r);
        return tokens.every(t => hay.includes(t));
      });
    }
    function setUserMgmtMessage(msg){
      const el = $('userMgmtMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function renderAuditList(){
      const list = $('auditList');
      if(!list) return;
      const rows = filteredAuditRows();
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No audit entries.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const action = String(row.action || '').trim();
        const tableName = String(row.table_name || '').trim();
        const when = row.created_at ? formatEasternDateTime(row.created_at) : '';
        const user = String(row.user_email || '').trim();
        const role = String(row.user_role || '').trim();
        const summary = [action, tableName].filter(Boolean).join(' · ');
        const meta = [when, user, role].filter(Boolean).join(' · ');
        const oldVals = row.old_values ? JSON.stringify(row.old_values, null, 2) : '';
        const newVals = row.new_values ? JSON.stringify(row.new_values, null, 2) : '';
        const changed = Array.isArray(row.changed_fields) && row.changed_fields.length
          ? `Changed: ${row.changed_fields.join(', ')}`
          : '';
        return (
          `<details class="audit-card">`+
            `<summary>`+
              `<div class="audit-title">${escapeHtml(summary || 'Entry')}</div>`+
              `<div class="audit-meta">${escapeHtml(meta)}</div>`+
            `</summary>`+
            `<div class="audit-body">`+
              `${changed ? `<div class="audit-meta">${escapeHtml(changed)}</div>` : ''}`+
              `${oldVals ? `<div class="audit-json">Old: ${escapeHtml(oldVals)}</div>` : ''}`+
              `${newVals ? `<div class="audit-json">New: ${escapeHtml(newVals)}</div>` : ''}`+
            `</div>`+
          `</details>`
        );
      }).join('');
    }
    function buildAuditCsv(rows){
      const header = [
        'Audit ID',
        'Created At (UTC)',
        'Created (Eastern)',
        'Action',
        'Table',
        'Record ID',
        'User Email',
        'User Role',
        'Changed Fields',
        'Old Values',
        'New Values',
      ];
      const out = [header.map(csvEscape).join(',')];
      const list = Array.isArray(rows) ? rows : [];
      for(const row of list){
        const createdAt = String(row?.created_at || '').trim();
        const createdEastern = createdAt ? formatEasternDateTime(createdAt) : '';
        out.push([
          String(row?.id || '').trim(),
          createdAt,
          createdEastern,
          String(row?.action || '').trim(),
          String(row?.table_name || '').trim(),
          String(row?.record_id || '').trim(),
          String(row?.user_email || '').trim(),
          String(row?.user_role || '').trim(),
          Array.isArray(row?.changed_fields) ? row.changed_fields.join(' ') : '',
          row?.old_values ? JSON.stringify(row.old_values) : '',
          row?.new_values ? JSON.stringify(row.new_values) : '',
        ].map(csvEscape).join(','));
      }
      return '\ufeff' + out.join('\n');
    }
    async function downloadAuditCsv(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!hasTier('enterprise')){ toast('Audit log requires Enterprise tier'); return; }
      if(!canAuditView()){ toast('Permission denied'); return; }
      const btn = $('btnAuditDownload');
      const priorTitle = btn ? btn.getAttribute('title') : '';
      if(btn){ btn.disabled = true; btn.setAttribute('title', 'Downloading…'); }
      try{
        const rows = filteredAuditRows();
        if(!rows.length){ toast('No audit entries to download'); return; }
        const csv = buildAuditCsv(rows);
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.download = `audit-log-${stamp}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toast(`Downloaded ${rows.length} audit entries`);
      }catch(e){
        toast((e && e.message) ? e.message : 'Download failed');
      }finally{
        if(btn){ btn.disabled = false; btn.setAttribute('title', priorTitle || 'Download CSV'); }
      }
    }
    async function refreshAuditLog(){
      const list = $('auditList');
      if(list) list.innerHTML = `<div class="muted">Loading…</div>`;
      setAuditMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        if(!hasTier('enterprise')) throw new Error('Audit log requires Enterprise tier');
        if(!canAuditView()) throw new Error('Permission denied');
        const tableFilter = String(state._auditTableFilter || '').trim() || null;
        const actionFilter = String(state._auditActionFilter || '').trim() || null;
        const { data, error } = await SB.client.rpc('get_audit_log', {
          p_company_id: SB.companyId,
          p_limit: 50,
          p_offset: 0,
          p_table_name: tableFilter,
          p_action: actionFilter,
        });
        if(error) throw error;
        state._auditRows = Array.isArray(data) ? data : [];
        renderAuditList();
      }catch(e){
        state._auditRows = [];
        const msg = e && e.message ? e.message : 'Failed to load audit log';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openAuditModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!hasTier('enterprise')){ toast('Audit log requires Enterprise tier'); return; }
      if(!canAuditView()){ toast('Permission denied'); return; }
      show('auditModal', true);
      const tableFilter = $('auditTableFilter'); if(tableFilter) tableFilter.value = state._auditTableFilter || '';
      const actionFilter = $('auditActionFilter'); if(actionFilter) actionFilter.value = state._auditActionFilter || '';
      const searchFilter = $('auditSearchFilter'); if(searchFilter) searchFilter.value = state._auditSearch || '';
      await refreshAuditLog();
    }
    function closeAuditModal(){
      show('auditModal', false);
    }

    // Feature: inventory.snapshots.ui
    const SNAPSHOT_PREVIEW_LIMIT = 200;
    function setSnapshotsMessage(msg){
      const el = $('snapshotsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function showSnapshotList(){
      const list = $('snapshotsList');
      const preview = $('snapshotPreview');
      if(list) list.style.display = '';
      if(preview) preview.style.display = 'none';
      const body = $('snapshotPreviewBody'); if(body) body.innerHTML = '';
      setSnapshotsMessage('');
    }
    function renderSnapshotsList(){
      const list = $('snapshotsList');
      if(!list) return;
      const rows = Array.isArray(state._snapshots) ? state._snapshots : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No snapshots available.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const id = String(row && row.id ? row.id : '').trim();
        const name = String(row && row.name ? row.name : 'Snapshot').trim();
        const desc = String(row && row.description ? row.description : '').trim();
        const createdAt = row && row.created_at ? formatEasternDateTime(row.created_at) : '';
        const createdBy = String(row && row.created_by_email ? row.created_by_email : '').trim();
        const itemsCount = toInt(row && row.items_count ? row.items_count : 0, 0);
        const totalQty = toInt(row && row.total_quantity ? row.total_quantity : 0, 0);
        const type = String(row && row.snapshot_type ? row.snapshot_type : '').trim();
        const restoredAt = row && row.was_restored && row.restored_at ? formatEasternDateTime(row.restored_at) : '';
        const metaParts = [];
        if(createdAt) metaParts.push(`Created: ${createdAt}`);
        if(createdBy) metaParts.push(`By: ${createdBy}`);
        metaParts.push(`Items: ${itemsCount}`);
        metaParts.push(`Qty: ${totalQty}`);
        if(type) metaParts.push(`Type: ${type}`);
        if(restoredAt) metaParts.push(`Restored: ${restoredAt}`);
        const meta = metaParts.join(' | ');
        return (
          `<div class="snapshot-card">`+
            `<div>`+
              `<div class="snapshot-title">${escapeHtml(name)}</div>`+
              `${desc ? `<div class="muted">${escapeHtml(desc)}</div>` : ''}`+
              `<div class="snapshot-meta">${escapeHtml(meta)}</div>`+
            `</div>`+
            `<div>`+
              `<button class="btn small" data-snapshot-preview-id="${escapeHtmlAttr(id)}">Preview</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    async function loadSnapshots(){
      const list = $('snapshotsList');
      if(list) list.innerHTML = `<div class="muted">Loading…</div>`;
      setSnapshotsMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        if(!canAccessSnapshots()) throw new Error('Permission denied');
        const { data, error } = await SB.client.rpc('get_snapshots', { p_company_id: SB.companyId });
        if(error) throw error;
        state._snapshots = Array.isArray(data) ? data : [];
        renderSnapshotsList();
      }catch(e){
        state._snapshots = [];
        const msg = e && e.message ? e.message : 'Failed to load snapshots';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openSnapshotsModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.companyId){ toast('No company selected'); return; }
      if(!hasTier('business')){ toast('Snapshots require Business or Enterprise tier'); return; }
      if(!canSnapshotsView()){ toast('Permission denied'); return; }
      show('snapshotsModal', true);
      showSnapshotList();
      await loadSnapshots();
    }
    function closeSnapshotsModal(){
      show('snapshotsModal', false);
      showSnapshotList();
    }
    async function openSnapshotPreview(snapshotId){
      const list = $('snapshotsList');
      const preview = $('snapshotPreview');
      const body = $('snapshotPreviewBody');
      if(!snapshotId || !preview || !body) return;
      if(list) list.style.display = 'none';
      preview.style.display = '';
      body.innerHTML = `<tr><td colspan="5" class="muted">Loading…</td></tr>`;
      setSnapshotsMessage('');
      try{
        const { data, error } = await SB.client
          .from('inventory_snapshots')
          .select('id,name,description,snapshot_type,items_count,total_quantity,created_at,restored_at,items_data')
          .eq('id', snapshotId)
          .eq('company_id', SB.companyId)
          .maybeSingle();
        if(error) throw error;
        const items = Array.isArray(data && data.items_data) ? data.items_data : [];
        const limited = items.slice(0, SNAPSHOT_PREVIEW_LIMIT);
        const metaParts = [];
        const name = String(data && data.name ? data.name : 'Snapshot').trim();
        const desc = String(data && data.description ? data.description : '').trim();
        const createdAt = data && data.created_at ? formatEasternDateTime(data.created_at) : '';
        const restoredAt = data && data.restored_at ? formatEasternDateTime(data.restored_at) : '';
        const count = toInt(data && data.items_count ? data.items_count : items.length, 0);
        const totalQty = toInt(data && data.total_quantity ? data.total_quantity : 0, 0);
        if(createdAt) metaParts.push(`Created: ${createdAt}`);
        metaParts.push(`Items: ${count}`);
        metaParts.push(`Qty: ${totalQty}`);
        if(data && data.snapshot_type) metaParts.push(`Type: ${String(data.snapshot_type)}`);
        if(restoredAt) metaParts.push(`Restored: ${restoredAt}`);
        if(items.length > SNAPSHOT_PREVIEW_LIMIT){
          metaParts.push(`Showing: ${SNAPSHOT_PREVIEW_LIMIT} of ${items.length}`);
        }
        const titleEl = $('snapshotPreviewTitle');
        if(titleEl) titleEl.textContent = name || 'Snapshot';
        const metaEl = $('snapshotPreviewMeta');
        if(metaEl) metaEl.textContent = metaParts.join(' | ');
        if(desc){
          setSnapshotsMessage(desc);
        }
        if(!limited.length){
          body.innerHTML = `<tr><td colspan="5" class="muted">No items in snapshot.</td></tr>`;
          return;
        }
        body.innerHTML = limited.map(item => {
          const label = String(item && item.name ? item.name : '').trim();
          const sku = String(item && item.sku ? item.sku : '').trim();
          const qty = toInt(item && item.quantity !== undefined ? item.quantity : item && item.qty, 0);
          const categoryId = String(item && item.category_id ? item.category_id : '').trim();
          const locationId = String(item && item.location_id ? item.location_id : '').trim();
          return (
            `<tr>`+
              `<td>${escapeHtml(label)}</td>`+
              `<td>${escapeHtml(sku)}</td>`+
              `<td>${escapeHtml(String(qty))}</td>`+
              `<td>${escapeHtml(categoryId)}</td>`+
              `<td>${escapeHtml(locationId)}</td>`+
            `</tr>`
          );
        }).join('');
      }catch(e){
        const msg = e && e.message ? e.message : 'Snapshot preview failed';
        body.innerHTML = `<tr><td colspan="5" class="muted">${escapeHtml(msg)}</td></tr>`;
      }
    }

    // Feature: inventory.metrics.dashboard
    function setMetricsMessage(msg){
      const el = $('metricsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function renderMetricsControls(){
      const viewSelect = $('metricsView');
      if(!viewSelect) return;
      const allowPlatform = canPlatformMetricsView() && isEffectiveSuperUser() && hasTier('professional');
      viewSelect.style.display = allowPlatform ? '' : 'none';
      if(!allowPlatform) viewSelect.value = 'company';
    }
    function openMetricsModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.companyId){ toast('No company selected'); return; }
      if(!canAccessMetrics()){
        if(!hasTier('professional')){
          toast('Metrics require Professional tier or higher');
          return;
        }
        toast('Permission denied');
        return;
      }
      show('metricsModal', true);
      renderMetricsControls();
      loadMetrics();
    }
    function closeMetricsModal(){
      show('metricsModal', false);
      setMetricsMessage('');
    }
    function formatMetricValue(value){
      const num = Number(value);
      if(!Number.isFinite(num)) return '0';
      return Math.round(num).toLocaleString();
    }
    function buildDailySummary(rows){
      const map = new Map();
      (rows || []).forEach(row => {
        const date = String(row && (row.date || row.metric_date) ? row.date || row.metric_date : '').slice(0, 10);
        if(!date) return;
        const entry = map.get(date) || { date, updates:0, deletes:0, restores:0, rollbacks:0, records:0 };
        const action = String(row && row.action_type ? row.action_type : '').toLowerCase();
        const count = toInt(row && row.action_count ? row.action_count : 0, 0);
        if(action === 'update') entry.updates += count;
        else if(action === 'delete' || action === 'bulk_delete') entry.deletes += count;
        else if(action === 'restore') entry.restores += count;
        else if(action === 'rollback') entry.rollbacks += count;
        entry.records += toInt(row && row.records_affected ? row.records_affected : 0, 0);
        map.set(date, entry);
      });
      return Array.from(map.values()).sort((a,b)=> (a.date < b.date ? 1 : -1));
    }
    function renderCompanyMetrics(data, days){
      const container = $('metricsContent');
      if(!container) return;
      const current = data && data.current ? data.current : {};
      const activity = data && data.activity ? data.activity : {};
      const daily = buildDailySummary(data && data.daily ? data.daily : []);
      const topUsers = Array.isArray(data && data.top_users ? data.top_users : []) ? data.top_users : [];
      const dailyRows = daily.map(row => (
        `<tr>`+
          `<td>${escapeHtml(String(row.date || ''))}</td>`+
          `<td>${escapeHtml(String(row.updates))}</td>`+
          `<td>${escapeHtml(String(row.deletes))}</td>`+
          `<td>${escapeHtml(String(row.restores))}</td>`+
          `<td>${escapeHtml(String(row.rollbacks))}</td>`+
          `<td>${escapeHtml(String(row.records))}</td>`+
        `</tr>`
      )).join('');
      const topUserRows = topUsers.map(user => (
        `<tr>`+
          `<td>${escapeHtml(String(user && (user.email || user.user_id) ? (user.email || user.user_id) : 'User'))}</td>`+
          `<td>${escapeHtml(formatMetricValue(user && user.total_actions ? user.total_actions : 0))}</td>`+
        `</tr>`
      )).join('');
      container.innerHTML =
        `<div class="metrics-section">`+
          `<h3>Current State</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.total_items)}</div><div class="metric-label">Total Items</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.total_quantity)}</div><div class="metric-label">Total Qty</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.low_stock_count)}</div><div class="metric-label">Low Stock</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.active_members)}</div><div class="metric-label">Team Members</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.snapshot_count)}</div><div class="metric-label">Snapshots</div></div>`+
          `</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Activity (Last ${escapeHtml(String(days))} Days)</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_updates)}</div><div class="metric-label">Updates</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_deletes)}</div><div class="metric-label">Deletes</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_restores)}</div><div class="metric-label">Restores</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_rollbacks)}</div><div class="metric-label">Rollbacks</div></div>`+
          `</div>`+
          `<div class="metrics-note">${formatMetricValue(activity.records_affected)} records affected | -${formatMetricValue(activity.quantity_removed)} qty | +${formatMetricValue(activity.quantity_added)} qty</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Daily Summary</h3>`+
          `${dailyRows ? `<table class="metrics-table"><thead><tr><th>Date</th><th>Updates</th><th>Deletes</th><th>Restores</th><th>Rollbacks</th><th>Records</th></tr></thead><tbody>${dailyRows}</tbody></table>` : '<div class="trash-empty">No activity recorded.</div>'}`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Top Contributors</h3>`+
          `${topUserRows ? `<table class="metrics-table"><thead><tr><th>User</th><th>Actions</th></tr></thead><tbody>${topUserRows}</tbody></table>` : '<div class="trash-empty">No activity in this period.</div>'}`+
        `</div>`;
    }
    function renderPlatformMetrics(data, days){
      const container = $('metricsContent');
      if(!container) return;
      const platform = data && data.platform ? data.platform : {};
      const activity = data && data.activity ? data.activity : {};
      const companies = Array.isArray(data && data.companies ? data.companies : []) ? data.companies : [];
      const daily = Array.isArray(data && data.daily ? data.daily : []) ? data.daily : [];
      const companyRows = companies.map(row => (
        `<tr>`+
          `<td>${escapeHtml(String(row && row.name ? row.name : row && row.id ? row.id : 'Company'))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.member_count ? row.member_count : 0))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.item_count ? row.item_count : 0))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.recent_actions ? row.recent_actions : 0))}</td>`+
        `</tr>`
      )).join('');
      const dailyRows = daily.map(row => (
        `<tr>`+
          `<td>${escapeHtml(String(row && row.date ? row.date : ''))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.total_actions ? row.total_actions : 0))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.active_companies ? row.active_companies : 0))}</td>`+
        `</tr>`
      )).join('');
      container.innerHTML =
        `<div class="metrics-section">`+
          `<h3>Platform Totals</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_companies)}</div><div class="metric-label">Companies</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_users)}</div><div class="metric-label">Users</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_items)}</div><div class="metric-label">Items</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_orders)}</div><div class="metric-label">Orders</div></div>`+
          `</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Activity (Last ${escapeHtml(String(days))} Days)</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_actions)}</div><div class="metric-label">Total Actions</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.active_companies)}</div><div class="metric-label">Active Companies</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.active_users)}</div><div class="metric-label">Active Users</div></div>`+
          `</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Company Activity</h3>`+
          `${companyRows ? `<table class="metrics-table"><thead><tr><th>Company</th><th>Members</th><th>Items</th><th>Recent Actions</th></tr></thead><tbody>${companyRows}</tbody></table>` : '<div class="trash-empty">No company activity found.</div>'}`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Daily Activity</h3>`+
          `${dailyRows ? `<table class="metrics-table"><thead><tr><th>Date</th><th>Total Actions</th><th>Active Companies</th></tr></thead><tbody>${dailyRows}</tbody></table>` : '<div class="trash-empty">No activity recorded.</div>'}`+
        `</div>`;
    }
    async function loadMetrics(){
      const container = $('metricsContent');
      if(container) container.innerHTML = `<div class="muted">Loading…</div>`;
      setMetricsMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        const rangeEl = $('metricsRange');
        const viewEl = $('metricsView');
        const days = toInt(rangeEl ? rangeEl.value : 30, 30);
        const view = viewEl && viewEl.style.display !== 'none' ? String(viewEl.value || 'company') : 'company';
        if(view === 'platform' && canPlatformMetricsView() && isEffectiveSuperUser() && hasTier('professional')){
          const { data, error } = await SB.client.rpc('get_platform_dashboard_metrics', { p_days: days });
          if(error) throw error;
          const title = $('metricsTitle'); if(title) title.textContent = 'Platform Metrics';
          renderPlatformMetrics(data || {}, days);
          return;
        }
        const { data, error } = await SB.client.rpc('get_company_dashboard_metrics', { p_company_id: SB.companyId, p_days: days });
        if(error) throw error;
        const title = $('metricsTitle'); if(title) title.textContent = 'Metrics Dashboard';
        renderCompanyMetrics(data || {}, days);
      }catch(e){
        const msg = e && e.message ? e.message : 'Failed to load metrics';
        if(container) container.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function sbLoadMyRoleRequest(){
      if(!SB.ready || !SB.session || !SB.client) return null;
      if(!hasTier('business')) return null;
      const { data, error } = await SB.client
        .from('role_change_requests')
        .select('id, requested_role, current_role_name, reason, status, created_at')
        .eq('user_id', SB.user.id)
        .eq('status', 'pending')
        .order('created_at', { ascending:false })
        .limit(1);
      if(error) throw error;
      state._roleRequestPending = Array.isArray(data) && data.length ? data[0] : null;
      return state._roleRequestPending;
    }
    function renderRoleRequestUi(){
      const section = $('roleRequestSection');
      const current = $('roleRequestCurrent');
      const roleSelect = $('roleRequestRole');
      const reason = $('roleRequestReason');
      const btn = $('btnRoleRequest');
      if(!section || !roleSelect) return;
      if(!SB.session || !SB.permissions || !canAccessRoleRequestsSelf()){
        section.style.display = 'none';
        return;
      }
      const role = getEffectiveRole();
      if(role === 'super_user'){
        section.style.display = 'none';
        return;
      }
      section.style.display = '';
      const roleLabel = role ? (isImpersonating() ? `${role} (testing)` : role) : '';
      if(current) current.textContent = role ? `Current role: ${roleLabel}` : 'Current role: (unknown)';
      const pending = state._roleRequestPending;
      if(pending){
        roleSelect.innerHTML = `<option value="${escapeHtmlAttr(pending.requested_role || '')}" selected>${escapeHtml(pending.requested_role || 'pending')}</option>`;
        roleSelect.disabled = true;
        if(reason){ reason.value = pending.reason || ''; reason.disabled = true; }
        if(btn){ btn.disabled = true; btn.setAttribute('aria-disabled', 'true'); }
        setRoleRequestMessage('Pending request submitted.');
        return;
      }
      const roles = ['admin','member','viewer'];
      const available = role ? roles.filter(r => r !== role) : roles;
      roleSelect.innerHTML = available.map(r => `<option value="${escapeHtmlAttr(r)}">${escapeHtml(r)}</option>`).join('');
      roleSelect.disabled = !available.length;
      if(reason){ reason.disabled = false; if(!reason.value) reason.value = ''; }
      if(btn){
        const disabled = !available.length;
        btn.disabled = disabled;
        btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      }
      setRoleRequestMessage('');
    }
    function renderRoleRequestsAdminButton(){
      const btn = $('openRoleRequests');
      if(!btn) return;
      const allow = !!(SB.session && SB.companyId && canAccessRoleRequestsAdmin());
      btn.disabled = !allow;
      btn.setAttribute('aria-disabled', allow ? 'false' : 'true');
    }
    function renderRoleManagerButton(){
      const btn = $('openRoleManager');
      if(!btn) return;
      const allow = !!(SB.session && canAccessRoleManager());
      btn.disabled = !allow;
      btn.setAttribute('aria-disabled', allow ? 'false' : 'true');
    }
    function renderUserMgmtButton(){
      const btn = $('openUserMgmt');
      if(!btn) return;
      const allow = !!(SB.session && canAccessMembers());
      btn.disabled = !allow;
      btn.setAttribute('aria-disabled', allow ? 'false' : 'true');
    }
    function renderAdvancedCompanySwitcherButton(){
      const btn = $('openAdvancedCompanySwitcher');
      if(!btn) return;
      const allow = !!(SB.session && isEffectiveSuperUser());
      btn.style.display = allow ? '' : 'none';
      btn.disabled = !allow;
      btn.setAttribute('aria-disabled', allow ? 'false' : 'true');
    }
    function renderDiagnosticsButton(){
      const btn = $('openDiagnostics');
      if(!btn) return;
      const allow = !!(SB.session && isEffectiveSuperUser());
      btn.style.display = allow ? '' : 'none';
      btn.disabled = !allow;
      btn.setAttribute('aria-disabled', allow ? 'false' : 'true');
    }
    function renderUserMgmtControls(){
      const controls = $('userMgmtControls');
      const select = $('userMgmtCompany');
      if(!controls || !select) return;
      if(!SB.session || !isEffectiveSuperUser()){
        controls.style.display = 'none';
        return;
      }
      controls.style.display = '';
      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      select.innerHTML = '';
      if(!rows.length){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No companies available';
        select.appendChild(opt);
        select.disabled = true;
        _userMgmtCompanyId = '';
        return;
      }
      rows.forEach(row => {
        const id = String(row && row.company_id ? row.company_id : '').trim();
        if(!id) return;
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || id;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = name;
        select.appendChild(opt);
      });
      let desired = _userMgmtCompanyId;
      if(desired && !rows.some(r => String(r.company_id) === desired)) desired = '';
      if(!desired) desired = SB.companyId ? String(SB.companyId) : String(rows[0].company_id || '');
      _userMgmtCompanyId = desired || '';
      if(_userMgmtCompanyId) select.value = _userMgmtCompanyId;
      select.disabled = rows.length <= 1;
    }
    function getUserMgmtCompanyId(){
      if(isEffectiveSuperUser()){
        return String(_userMgmtCompanyId || SB.companyId || '').trim();
      }
      return SB.companyId ? String(SB.companyId).trim() : '';
    }
    function renderUserMgmtList(){
      const list = $('userMgmtList');
      if(!list) return;
      const rows = Array.isArray(state._userMgmtRows) ? state._userMgmtRows : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No users found.</div>`;
        return;
      }
      const currentUserId = SB.user && SB.user.id ? String(SB.user.id) : '';
      const roleOptions = ['admin','member','viewer'];
      list.innerHTML = rows.map(row => {
        const userId = String(row.user_id || '').trim();
        const profile = row.profile || {};
        const name = [profile.first_name, profile.last_name].filter(Boolean).join(' ').trim();
        const email = String(profile.email || row.email || '').trim();
        const displayName = name || email || 'User';
        const isSelf = currentUserId && userId === currentUserId;
        const isSuper = !!row.is_super_user;
        const currentRole = roleOptions.includes(String(row.role || '').trim()) ? String(row.role || '').trim() : 'member';
        const canEditRole = !!(canMembersChangeRole() && !isSuper && !isSelf);
        const canRemove = !!(canMembersRemove() && !isSuper && !isSelf);
        const joined = row.created_at ? formatEasternDateTime(row.created_at) : '';
        const metaParts = [];
        if(name && email) metaParts.push(email);
        if(joined) metaParts.push(`Joined ${joined}`);
        if(isSelf) metaParts.push('You');
        if(isSuper) metaParts.push('Super user');
        const roleSelect = isSuper
          ? `<select class="user-mgmt-role" disabled aria-disabled="true"><option selected>super_user</option></select>`
          : `<select class="user-mgmt-role" data-user-role-id="${escapeHtmlAttr(userId)}" data-current-role="${escapeHtmlAttr(currentRole)}" data-user-name="${escapeHtmlAttr(displayName)}" ${canEditRole ? '' : 'disabled aria-disabled="true"'}>`+
              roleOptions.map(r => `<option value="${escapeHtmlAttr(r)}"${r === currentRole ? ' selected' : ''}>${escapeHtml(r)}</option>`).join('')+
            `</select>`;
        return (
          `<div class="user-mgmt-card">`+
            `<div>`+
              `<div class="user-mgmt-name">${escapeHtml(displayName)}</div>`+
              `${metaParts.length ? `<div class="user-mgmt-meta">${escapeHtml(metaParts.join(' · '))}</div>` : ''}`+
            `</div>`+
            `<div class="user-mgmt-actions">`+
              roleSelect+
              `<button class="btn" data-user-remove-id="${escapeHtmlAttr(userId)}" data-user-name="${escapeHtmlAttr(displayName)}"${canRemove ? '' : ' disabled aria-disabled="true"'}>Remove</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    async function refreshUserMgmt(){
      const list = $('userMgmtList');
      if(list) list.innerHTML = `<div class="muted">Loading…</div>`;
      setUserMgmtMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!hasTier('business')) throw new Error('User management requires Business tier');
        if(!canMembersView()) throw new Error('Permission denied');
        const companyId = getUserMgmtCompanyId();
        if(!companyId) throw new Error('No company selected');
        const { data, error } = await SB.client
          .from('company_members')
          .select('user_id,role,is_super_user,invited_by,assigned_admin_id,created_at')
          .eq('company_id', companyId)
          .order('created_at', { ascending:true });
        if(error) throw error;
        const rows = Array.isArray(data) ? data : [];
        const userIds = rows.map(r => r.user_id).filter(Boolean);
        let profileMap = new Map();
        if(userIds.length){
          const { data: profiles, error: profErr } = await SB.client
            .from('profiles')
            .select('user_id,email,first_name,last_name')
            .in('user_id', userIds);
          if(profErr) throw profErr;
          profileMap = new Map((profiles || []).map(p => [String(p.user_id), p]));
        }
        state._userMgmtRows = rows.map(r => ({
          ...r,
          profile: profileMap.get(String(r.user_id)) || null,
        }));
        renderUserMgmtList();
      }catch(e){
        state._userMgmtRows = [];
        const msg = e && e.message ? e.message : 'Failed to load users';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openUserMgmtModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!hasTier('business')){ toast('User management requires Business tier'); return; }
      if(!canMembersView()){ toast('Permission denied'); return; }
      renderUserMgmtControls();
      show('userMgmtModal', true);
      await refreshUserMgmt();
    }
    function closeUserMgmtModal(){
      show('userMgmtModal', false);
    }
    // Feature: inventory.auth.roles
    const ROLE_PERMISSION_CATEGORIES = {
      'Inventory': [
        { key: PERMISSIONS.ITEMS_VIEW, label: 'View Items' },
        { key: PERMISSIONS.ITEMS_CREATE, label: 'Create Items' },
        { key: PERMISSIONS.ITEMS_EDIT, label: 'Edit Items' },
        { key: PERMISSIONS.ITEMS_DELETE, label: 'Delete Items' },
        { key: PERMISSIONS.ITEMS_RESTORE, label: 'Restore Items' },
        { key: PERMISSIONS.ITEMS_EXPORT, label: 'Export Items' },
        { key: PERMISSIONS.ITEMS_IMPORT, label: 'Import Items' },
      ],
      'Orders': [
        { key: PERMISSIONS.ORDERS_VIEW, label: 'View Orders' },
        { key: PERMISSIONS.ORDERS_CREATE, label: 'Create Orders' },
        { key: PERMISSIONS.ORDERS_EDIT, label: 'Edit Orders' },
        { key: PERMISSIONS.ORDERS_DELETE, label: 'Delete Orders' },
        { key: PERMISSIONS.ORDERS_RESTORE, label: 'Restore Orders' },
        { key: PERMISSIONS.ORDERS_MANAGE_SHIPPING, label: 'Manage Shipping Addresses' },
      ],
      'Members': [
        { key: PERMISSIONS.MEMBERS_VIEW, label: 'View Members' },
        { key: PERMISSIONS.MEMBERS_INVITE, label: 'Invite Members' },
        { key: PERMISSIONS.MEMBERS_REMOVE, label: 'Remove Members' },
        { key: PERMISSIONS.MEMBERS_CHANGE_ROLE, label: 'Change Roles' },
      ],
      'Company': [
        { key: PERMISSIONS.COMPANY_VIEW_SETTINGS, label: 'View Settings' },
        { key: PERMISSIONS.COMPANY_EDIT_SETTINGS, label: 'Edit Settings' },
      ],
      'Audit and Metrics': [
        { key: PERMISSIONS.AUDIT_LOG_VIEW, label: 'View Audit Log' },
        { key: PERMISSIONS.METRICS_VIEW, label: 'View Metrics' },
        { key: PERMISSIONS.SNAPSHOTS_VIEW, label: 'View Snapshots' },
      ],
    };
    function setRoleManagerMessage(msg){
      const el = $('roleManagerMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    async function openRoleManagerModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!canAccessRoleManager()){
        toast(hasTier('business') ? 'Super user access required' : 'Role Manager requires Business tier');
        return;
      }
      show('roleManagerModal', true);
      await loadRoleConfigurations();
    }
    function closeRoleManagerModal(){
      show('roleManagerModal', false);
      state._roleChanges = {};
      setRoleManagerMessage('');
    }
    async function loadRoleConfigurations(){
      setRoleManagerMessage('');
      try{
        const { data, error } = await SB.client
          .from('role_configurations')
          .select('role_name,permissions');
        if(error) throw error;
        state._roleConfigs = {};
        (data || []).forEach(row => {
          const role = String(row && row.role_name ? row.role_name : '').trim();
          if(!role) return;
          state._roleConfigs[role] = row.permissions || {};
        });
        state._roleChanges = {};
        renderRoleManagerTable();
      }catch(e){
        const msg = e && e.message ? e.message : 'Failed to load roles';
        setRoleManagerMessage(msg);
      }
    }
    function renderRoleManagerTable(){
      const body = $('roleManagerBody');
      if(!body) return;
      const roles = ['admin','member','viewer'];
      let html = '';
      for(const [category, perms] of Object.entries(ROLE_PERMISSION_CATEGORIES)){
        html += `<tr class="role-manager-category"><td colspan="4">${escapeHtml(category)}</td></tr>`;
        perms.forEach(perm => {
          const key = perm.key;
          const label = perm.label;
          const cells = roles.map(role => {
            const current = state._roleChanges[role] || state._roleConfigs[role] || {};
            const checked = current[key] === true;
            return `<td><input type="checkbox" data-role="${escapeHtmlAttr(role)}" data-permission="${escapeHtmlAttr(key)}"${checked ? ' checked' : ''} /></td>`;
          }).join('');
          html += `<tr><td>${escapeHtml(label)}</td>${cells}</tr>`;
        });
      }
      body.innerHTML = html;
    }
    function handleRoleManagerToggle(target){
      const box = target && target.matches ? (target.matches('input[type="checkbox"][data-role][data-permission]') ? target : null) : null;
      if(!box) return;
      const role = String(box.dataset.role || '').trim();
      const perm = String(box.dataset.permission || '').trim();
      if(!role || !perm) return;
      if(!state._roleChanges[role]){
        state._roleChanges[role] = { ...(state._roleConfigs[role] || {}) };
      }
      state._roleChanges[role][perm] = !!box.checked;
    }
    async function saveRoleManagerChanges(){
      if(!canAccessRoleManager()){
        toast('Permission denied');
        return;
      }
      const entries = Object.entries(state._roleChanges || {});
      if(!entries.length){
        setRoleManagerMessage('No changes to save.');
        return;
      }
      setRoleManagerMessage('');
      try{
        for(const [role, permissions] of entries){
          const { error } = await SB.client
            .from('role_configurations')
            .update({
              permissions,
              updated_at: new Date().toISOString(),
              updated_by: SB.user ? SB.user.id : null,
            })
            .eq('role_name', role);
          if(error) throw error;
        }
        state._roleChanges = {};
        await loadRoleConfigurations();
        await sbLoadPermissions();
        applyPermissionUI();
        setRoleManagerMessage('Role permissions saved.');
        toast('Role permissions saved');
      }catch(e){
        const msg = e && e.message ? e.message : 'Save failed';
        setRoleManagerMessage(msg);
      }
    }
    async function sbUpdateMemberRole(userId, role){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!hasTier('business')) throw Error('Role changes require Business tier');
      if(!canMembersChangeRole()) throw Error('Permission denied');
      const companyId = getUserMgmtCompanyId();
      if(!companyId) throw Error('Company not selected');
      const uid = String(userId || '').trim();
      const cleanRole = String(role || '').trim();
      if(!uid) throw Error('User required');
      if(!cleanRole) throw Error('Role required');
      const { error } = await SB.client
        .from('company_members')
        .update({ role: cleanRole })
        .eq('company_id', companyId)
        .eq('user_id', uid);
      if(error) throw error;
    }
    async function sbRemoveMember(userId){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!hasTier('business')) throw Error('User removal requires Business tier');
      if(!canMembersRemove()) throw Error('Permission denied');
      const uid = String(userId || '').trim();
      if(!uid) throw Error('User required');
      const { data, error } = await SB.client.rpc('remove_company_member', { p_user_id: uid });
      if(error) throw error;
      if(data && data.success === false) throw new Error(data.error || 'Remove failed');
      return data || null;
    }
    function renderRoleRequestsList(){
      const list = $('roleRequestsList');
      if(!list) return;
      const rows = Array.isArray(state._roleRequests) ? state._roleRequests : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No pending role requests.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const id = String(row.id || '').trim();
        const profile = row.profile || {};
        const name = [profile.first_name, profile.last_name].filter(Boolean).join(' ').trim();
        const email = profile.email || '';
        const who = name ? `${escapeHtml(name)}${email ? ` · ${escapeHtml(email)}` : ''}` : escapeHtml(email || 'User');
        const createdAt = row.created_at ? formatEasternDateTime(row.created_at) : '';
        const reason = String(row.reason || '').trim();
        return (
          `<div class="role-request-card">`+
            `<div>`+
              `<h3>${who}</h3>`+
              `<div class="role-request-meta">`+
                `Requested: ${escapeHtml(row.requested_role || '')} · Current: ${escapeHtml(row.current_role_name || '')}`+
                `${createdAt ? ` · ${escapeHtml(createdAt)}` : ''}`+
              `</div>`+
              `${reason ? `<div class="muted">${escapeHtml(reason)}</div>` : ''}`+
            `</div>`+
            `<div>`+
              `<label class="muted">Admin Notes</label>`+
              `<textarea rows="2" data-role-notes-id="${escapeHtmlAttr(id)}" placeholder="Optional notes"></textarea>`+
            `</div>`+
            `<div class="role-request-actions-row">`+
              `<button class="btn" data-role-approve-id="${escapeHtmlAttr(id)}">Approve</button>`+
              `<button class="btn" data-role-deny-id="${escapeHtmlAttr(id)}">Deny</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    async function refreshRoleRequests(){
      const list = $('roleRequestsList');
      if(list) list.innerHTML = `<div class="muted">Loading…</div>`;
      setRoleRequestsMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        if(!hasTier('business')) throw new Error('Role requests require Business tier');
        if(!canMembersChangeRole()) throw new Error('Permission denied');
        const { data, error } = await SB.client
          .from('role_change_requests')
          .select('id,user_id,current_role_name,requested_role,reason,status,created_at')
          .eq('company_id', SB.companyId)
          .eq('status', 'pending')
          .order('created_at', { ascending:false });
        if(error) throw error;
        const rows = Array.isArray(data) ? data : [];
        const userIds = rows.map(r => r.user_id).filter(Boolean);
        let profileMap = new Map();
        if(userIds.length){
          const { data: profiles, error: profErr } = await SB.client
            .from('profiles')
            .select('user_id,email,first_name,last_name')
            .in('user_id', userIds);
          if(profErr) throw profErr;
          profileMap = new Map((profiles||[]).map(p => [String(p.user_id), p]));
        }
        state._roleRequests = rows.map(r => ({
          ...r,
          profile: profileMap.get(String(r.user_id)) || null,
        }));
        renderRoleRequestsList();
      }catch(e){
        state._roleRequests = [];
        const msg = e && e.message ? e.message : 'Failed to load requests';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openRoleRequestsModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!hasTier('business')){ toast('Role requests require Business tier'); return; }
      if(!canMembersChangeRole()){ toast('Permission denied'); return; }
      show('roleRequestsModal', true);
      await refreshRoleRequests();
    }
    function closeRoleRequestsModal(){
      show('roleRequestsModal', false);
    }
    async function sbSendPasswordReset(email){
      if(!SB.ready || !SB.client) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      if(!e) throw Error('Email required');
      const redirectTo = window.location.origin + window.location.pathname;
      const { error } = await SB.client.auth.resetPasswordForEmail(e, { redirectTo });
      if(error) throw error;
    }
    async function sbUpdatePassword(newPassword){
      if(!SB.ready || !SB.client) throw Error('Supabase not configured');
      const pw = String(newPassword||'');
      if(pw.length < 8) throw Error('Use at least 8 characters');
      const { error } = await SB.client.auth.updateUser({ password: pw });
      if(error) throw error;
    }
    function setProfileMessage(msg){
      const el = $('profileMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
	    // Auto-format phone number as (XXX) XXX-XXXX
	    function formatPhoneNumber(value){
	      let digits = String(value || '').replace(/\D/g, '');
	      // iOS often pastes US numbers as 1XXXXXXXXXX — drop the leading country code
	      while(digits.length > 10 && digits.startsWith('1')) digits = digits.slice(1);
	      digits = digits.slice(0, 10);
	      if(digits.length === 0) return '';
	      if(digits.length <= 3) return `(${digits}`;
	      if(digits.length <= 6) return `(${digits.slice(0,3)}) ${digits.slice(3)}`;
	      return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
	    }

	    function renderProfileUi(){
	      const email = SB.user && SB.user.email ? String(SB.user.email) : '';
	      const elEmail = $('profileEmailDisplay'); if(elEmail) elEmail.textContent = email ? `Signed in: ${email}` : '';
	      const elFirstName = $('profileFirstName'); if(elFirstName) elFirstName.value = (SB.profile && SB.profile.first_name) ? String(SB.profile.first_name) : '';
	      const elLastName = $('profileLastName'); if(elLastName) elLastName.value = (SB.profile && SB.profile.last_name) ? String(SB.profile.last_name) : '';
	      const elPhone = $('profilePhone'); if(elPhone) elPhone.value = formatPhoneNumber((SB.profile && SB.profile.phone) ? String(SB.profile.phone) : '');
	      const elLowGlobal = $('profileLowStockQtyGlobal'); if(elLowGlobal) elLowGlobal.value = String(getGlobalLowStockQty());
	      const elSilence = $('profileSilenceLowStockAlerts'); if(elSilence) elSilence.checked = lowStockAlertsSilenced();
	      let note = '';
	      if(SB.session && !SB.authorized){
	        if(!SB.companyId) note = 'No company access yet. Ask an admin for an invite.';
        else if(!SB.permissions || !hasPermission(PERMISSIONS.ITEMS_VIEW)) note = 'Your role does not allow inventory access.';
	      }
	      if(note && SB.permissions && SB.permissions.assigned_admin_email){
	        note += ` Contact: ${SB.permissions.assigned_admin_email}`;
	      }
      setProfileMessage(note);
      renderCompanySwitcher();
      renderAdvancedCompanySwitcherButton();
      renderDiagnosticsButton();
      renderInviteUi();
      renderRoleRequestUi();
      renderRoleRequestsAdminButton();
      renderRoleManagerButton();
      renderUserMgmtButton();
      renderTierAdminSection();
    }
	    function renderCompanySwitcher(){
	      const section = $('profileCompanySection');
	      const select = $('profileCompanySelect');
	      const hint = $('profileCompanyHint');
	      const divider = $('profileCompanyDivider');
	      if(!section || !select) return;
	      if(!SB.session){
	        section.style.display = 'none';
	        if(divider) divider.style.display = 'none';
        renderRoleTestingSwitcher();
	        return;
	      }
	      const rows = Array.isArray(SB.companies) ? SB.companies : [];
	      section.style.display = '';
	      if(divider) divider.style.display = '';
	      select.innerHTML = '';
	      if(!rows.length){
	        const opt = document.createElement('option');
	        opt.value = '';
	        opt.textContent = 'No companies available';
	        select.appendChild(opt);
	        select.disabled = true;
	        if(hint) hint.textContent = 'No company access yet.';
        renderRoleTestingSwitcher();
	        return;
	      }
	      rows.forEach(row => {
	        const id = String(row && row.company_id ? row.company_id : '').trim();
	        if(!id) return;
	        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || id;
	        const roleRaw = String(row.my_role || (row.is_super_user ? 'super_user' : '')).trim();
	        const roleLabel = roleRaw ? (roleRaw === 'super_user' ? 'super' : roleRaw) : '';
	        const opt = document.createElement('option');
	        opt.value = id;
	        opt.textContent = roleLabel ? `${name} (${roleLabel})` : name;
	        select.appendChild(opt);
	      });
	      const current = SB.companyId ? String(SB.companyId) : '';
	      if(current && Array.from(select.options).some(opt => opt.value === current)){
	        select.value = current;
	      }else{
	        select.selectedIndex = 0;
	      }
	      select.disabled = rows.length <= 1;
      if(hint){
        const currentRow = rows.find(r => String(r.company_id) === String(SB.companyId || '')) || null;
        const role = currentRow ? String(currentRow.my_role || (currentRow.is_super_user ? 'super_user' : '')).trim() : '';
        const currentType = normalizeCompanyType(SB.company && SB.company.company_type);
        if(!currentRow && SB.companyId && currentType !== 'production'){
          hint.textContent = `Advanced switcher active · ${formatCompanyTypeLabel(currentType)}`;
        }else if(role && role !== 'super_user'){
          hint.textContent = `Role: ${role}`;
        }else if(rows.length <= 1){
          hint.textContent = 'Only one company assigned.';
        }else{
          hint.textContent = '';
        }
      }
      renderRoleTestingSwitcher();
	    }
    function setAdvancedCompanyMessage(msg){
      const el = $('advancedCompanyMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function getDefaultProductionCompanyId(){
      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      const preferred = state._defaultCompanyId ? String(state._defaultCompanyId) : '';
      if(preferred && rows.some(r => String(r.company_id) === preferred)){
        return preferred;
      }
      if(rows.length) return String(rows[0].company_id || '');
      return '';
    }
    function renderAdvancedCompanyActions(){
      const btn = $('advancedCompanyReturnBtn');
      if(!btn) return;
      const defaultId = getDefaultProductionCompanyId();
      const allow = !!(defaultId && String(SB.companyId || '') !== defaultId);
      btn.disabled = !allow;
      btn.setAttribute('aria-disabled', allow ? 'false' : 'true');
    }
    function renderAdvancedCompanyResults(){
      const container = $('advancedCompanyResults');
      if(!container) return;
      const rows = Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [];
      if(!rows.length){
        container.innerHTML = '<div class="trash-empty">No companies found.</div>';
        return;
      }
      const header = '<thead><tr><th>Company</th><th>Environment</th><th>Members</th><th>Action</th></tr></thead>';
      const body = rows.map(row => {
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || 'Company';
        const id = String(row.company_id || '').trim();
        const type = normalizeCompanyType(row.company_type);
        const badge = `<span class="env-badge env-${escapeHtmlAttr(type)}">${escapeHtml(formatCompanyTypeLabel(type))}</span>`;
        const members = Number.isFinite(Number(row.member_count)) ? String(row.member_count) : '0';
        return (
          `<tr>` +
            `<td>` +
              `<div>${escapeHtml(name)}</div>` +
              `<div class="advanced-switcher-id">${escapeHtml(id)}</div>` +
            `</td>` +
            `<td>${badge}</td>` +
            `<td>${escapeHtml(members)}</td>` +
            `<td><div class="advanced-switcher-row-actions">` +
              `<button class="btn small" type="button" data-advanced-switch="${escapeHtmlAttr(id)}">Switch</button>` +
            `</div></td>` +
          `</tr>`
        );
      }).join('');
      container.innerHTML = `<table class="advanced-switcher-table">${header}<tbody>${body}</tbody></table>`;
      if(!container._wired){
        container._wired = true;
        container.addEventListener('click', async (e)=>{
          const btn = e.target.closest('[data-advanced-switch]');
          if(!btn) return;
          const targetId = String(btn.getAttribute('data-advanced-switch') || '').trim();
          const row = (Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [])
            .find(r => String(r.company_id || '') === targetId);
          if(!row) return;
          await handleAdvancedCompanySwitch(row);
        });
      }
    }
    async function loadAdvancedCompanies(){
      if(!SB.ready || !SB.session || !SB.client) return;
      if(!isEffectiveSuperUser()){
        setAdvancedCompanyMessage('Super user access required.');
        return;
      }
      const searchInput = $('advancedCompanySearch');
      const typeSelect = $('advancedCompanyTypeFilter');
      const search = String(searchInput ? searchInput.value : '').trim();
      const type = String(typeSelect ? typeSelect.value : '').trim();
      state._advancedSearch = search;
      state._advancedType = type;
      setAdvancedCompanyMessage('Loading...');
      try{
        const { data, error } = await SB.client.rpc('get_company_switcher_companies', {
          p_search: search || null,
          p_company_type: type || null,
          p_limit: 50
        });
        if(error) throw error;
        state._advancedCompanies = Array.isArray(data) ? data : [];
        renderAdvancedCompanyResults();
        renderAdvancedCompanyActions();
        if(!state._advancedCompanies.length){
          setAdvancedCompanyMessage('No companies found.');
        }else{
          setAdvancedCompanyMessage('');
        }
      }catch(e){
        console.warn('Advanced company search failed:', e);
        setAdvancedCompanyMessage('Failed to load companies.');
        state._advancedCompanies = [];
        renderAdvancedCompanyResults();
      }
    }
    async function openAdvancedCompanySwitcher(){
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      const searchInput = $('advancedCompanySearch');
      const typeSelect = $('advancedCompanyTypeFilter');
      if(searchInput) searchInput.value = state._advancedSearch || '';
      if(typeSelect){
        const desiredType = Object.prototype.hasOwnProperty.call(state, '_advancedType')
          ? state._advancedType
          : 'production';
        typeSelect.value = desiredType === undefined ? 'production' : desiredType;
      }
      setAdvancedCompanyMessage('');
      show('advancedCompanyModal', true);
      renderAdvancedCompanyActions();
      await loadAdvancedCompanies();
    }
    async function handleAdvancedCompanySwitch(company){
      if(!company) return;
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      const type = normalizeCompanyType(company.company_type);
      if(type !== 'production'){
        const ok = await openConfirmModal(
          'Switch to non-production',
          `You are about to switch into ${formatCompanyTypeLabel(type)}. Continue?`,
          { okText: 'Switch', cancelText: 'Cancel' }
        );
        if(!ok) return;
      }
      const ok = await sbSwitchCompany(company.company_id, {
        persist: false,
        companyRow: company,
        audit: true,
        source: 'advanced_switcher'
      });
      if(ok){
        const name = String(company.company_name || company.company_slug || company.company_id || 'company');
        toast(`Switched to ${name}`);
        renderAdvancedCompanyActions();
        renderCompanyEnvBadge();
      }
    }
    function setDiagnosticsMessage(msg){
      const el = $('diagSimMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function setDiagnosticsMetricOutput(content){
      const el = $('diagMetricOutput');
      if(!el) return;
      el.textContent = content || '';
    }
    function getDiagnosticsRole(){
      const raw = state._diagRole ? String(state._diagRole) : '';
      const normalized = raw ? normalizeRoleName(raw) : '';
      if(normalized) return normalized;
      return getAuthorityRole() || 'super_user';
    }
    function getDiagnosticsTier(){
      const raw = state._diagTier ? String(state._diagTier) : '';
      const normalized = raw ? normalizeTier(raw) : '';
      if(normalized) return normalized;
      return normalizeTier(getCompanyTier()) || TIER_FALLBACK;
    }
    function isDiagnosticsTierSimulated(){
      return !!state._diagTier;
    }
    function isDiagnosticsRoleSimulated(){
      return !!state._diagRole;
    }
    function isTierAtLeast(current, required){
      const currentTier = normalizeTier(current);
      const requiredTier = normalizeTier(required);
      if(!requiredTier) return true;
      return TIER_ORDER.indexOf(currentTier) >= TIER_ORDER.indexOf(requiredTier);
    }
    function hasPermissionInSet(permissions, key){
      if(!permissions || !key) return false;
      if(Object.prototype.hasOwnProperty.call(permissions, key)){
        return permissions[key] === true;
      }
      const legacy = LEGACY_PERMISSION_MAP[key];
      if(legacy && Array.isArray(legacy.any)){
        return legacy.any.some(k => permissions[k] === true);
      }
      if(legacy && Array.isArray(legacy.all)){
        return legacy.all.every(k => permissions[k] === true);
      }
      return false;
    }
    async function applyDiagnosticsSimulation(){
      const roleSelect = $('diagRoleSelect');
      const tierSelect = $('diagTierSelect');
      const roleValue = roleSelect ? String(roleSelect.value || '').trim() : '';
      const tierValue = tierSelect ? String(tierSelect.value || '').trim() : '';
      state._diagRole = roleValue ? normalizeRoleName(roleValue) : '';
      state._diagTier = tierValue ? normalizeTier(tierValue) : '';
      state._diagPermissions = null;
      if(state._diagRole && state._diagRole !== 'super_user'){
        state._diagPermissions = await loadImpersonationPermissions(state._diagRole);
      }
      renderDiagnosticsChecks();
      updateDiagnosticsMetricTierHint();
      if(!state._diagRole && !state._diagTier){
        setDiagnosticsMessage('Simulation cleared.');
      }else{
        const roleLabel = state._diagRole ? state._diagRole : 'current';
        const tierLabel = state._diagTier ? formatTierLabel(state._diagTier) : 'current';
        setDiagnosticsMessage(`Simulation active: role=${roleLabel}, tier=${tierLabel}.`);
      }
    }
    function resetDiagnosticsSimulation(){
      state._diagRole = '';
      state._diagTier = '';
      state._diagPermissions = null;
      const roleSelect = $('diagRoleSelect');
      const tierSelect = $('diagTierSelect');
      if(roleSelect) roleSelect.value = '';
      if(tierSelect) tierSelect.value = '';
      renderDiagnosticsChecks();
      updateDiagnosticsMetricTierHint();
      setDiagnosticsMessage('Simulation cleared.');
    }
    function getDiagnosticsPermissions(){
      const role = getDiagnosticsRole();
      if(role === 'super_user') return null;
      if(state._diagPermissions && typeof state._diagPermissions === 'object') return state._diagPermissions;
      return getEffectivePermissions();
    }
    function getDiagnosticsTierLabel(){
      const tier = getDiagnosticsTier();
      const label = formatTierLabel(tier);
      return isDiagnosticsTierSimulated() ? `${label} (simulated)` : label;
    }
    const DIAGNOSTIC_CHECKS = [
      {
        id: 'items_view',
        label: 'Inventory Items: View',
        requiredTier: 'starter',
        requiredPermission: PERMISSIONS.ITEMS_VIEW,
        source: 'policy',
      },
      {
        id: 'items_export',
        label: 'Inventory: Export',
        requiredTier: 'professional',
        requiredPermission: PERMISSIONS.ITEMS_EXPORT,
        source: 'workflow',
      },
      {
        id: 'orders_view',
        label: 'Orders: View',
        requiredTier: 'business',
        requiredPermission: PERMISSIONS.ORDERS_VIEW,
        source: 'policy',
      },
      {
        id: 'orders_create',
        label: 'Orders: Create',
        requiredTier: 'business',
        requiredPermission: PERMISSIONS.ORDERS_CREATE,
        source: 'policy',
      },
      {
        id: 'snapshots_view',
        label: 'Snapshots: View',
        requiredTier: 'business',
        requiredPermission: PERMISSIONS.SNAPSHOTS_VIEW,
        source: 'workflow',
      },
      {
        id: 'metrics_dashboard',
        label: 'Metrics Dashboard',
        requiredTier: 'professional',
        requiredPermission: PERMISSIONS.METRICS_VIEW,
        source: 'workflow',
      },
      {
        id: 'audit_log_view',
        label: 'Audit Log: View',
        requiredTier: 'enterprise',
        requiredPermission: PERMISSIONS.AUDIT_LOG_VIEW,
        source: 'policy',
      },
      {
        id: 'platform_metrics',
        label: 'Platform Metrics',
        requiredTier: 'professional',
        requiredPermission: PERMISSIONS.PLATFORM_VIEW_METRICS,
        source: 'workflow',
      },
    ];
    function renderDiagnosticsChecks(){
      const container = $('diagChecks');
      if(!container) return;
      if(!SB.session || !isEffectiveSuperUser()){
        container.innerHTML = '<div class="trash-empty">Super user access required.</div>';
        return;
      }
      const role = getDiagnosticsRole();
      const tierLabel = getDiagnosticsTierLabel();
      const permissions = getDiagnosticsPermissions();
      const rows = DIAGNOSTIC_CHECKS.map(check => {
        const tierOk = role === 'super_user' ? true : isTierAtLeast(getDiagnosticsTier(), check.requiredTier);
        const permissionOk = role === 'super_user'
          ? true
          : (check.requiredPermission ? hasPermissionInSet(permissions, check.requiredPermission) : true);
        let rule = 'allowed';
        let allowed = true;
        if(role === 'super_user'){
          rule = 'super_user_bypass';
        }else if(!tierOk){
          rule = 'tier_gate';
          allowed = false;
        }else if(!permissionOk){
          rule = 'permission_gate';
          allowed = false;
        }
        const requiredPermission = check.requiredPermission || '—';
        const badge = `<span class="diag-badge ${allowed ? 'pass' : 'fail'}">${allowed ? 'ALLOW' : 'BLOCK'}</span>`;
        return (
          `<tr>` +
            `<td>${escapeHtml(check.label)}</td>` +
            `<td>${escapeHtml(check.source)}</td>` +
            `<td>${escapeHtml(formatTierLabel(check.requiredTier))}</td>` +
            `<td>${escapeHtml(requiredPermission)}</td>` +
            `<td>${escapeHtml(tierLabel)}</td>` +
            `<td>${escapeHtml(rule)}</td>` +
            `<td>${badge}</td>` +
          `</tr>`
        );
      }).join('');
      container.innerHTML =
        `<table class="diag-table">` +
          `<thead>` +
            `<tr>` +
              `<th>Action</th>` +
              `<th>Source</th>` +
              `<th>Required Tier</th>` +
              `<th>Required Permission</th>` +
              `<th>Current Tier</th>` +
              `<th>Rule Fired</th>` +
              `<th>Result</th>` +
            `</tr>` +
          `</thead>` +
          `<tbody>${rows}</tbody>` +
        `</table>`;
    }
    function mapSubscriptionTierToMetricTier(tier){
      const normalized = normalizeTier(tier);
      if(normalized === 'starter') return 'TIER_1';
      if(normalized === 'professional') return 'TIER_2';
      if(normalized === 'business') return 'TIER_2';
      if(normalized === 'enterprise') return 'TIER_3';
      return 'TIER_1';
    }
    function updateDiagnosticsMetricTierHint(){
      const hint = $('diagMetricTierHint');
      if(!hint) return;
      const tier = getDiagnosticsTier();
      const metricTier = mapSubscriptionTierToMetricTier(tier);
      const label = isDiagnosticsTierSimulated()
        ? `Metric tier preview uses ${metricTier} (from simulated ${formatTierLabel(tier)}).`
        : `Metric tier preview uses ${metricTier} (from ${formatTierLabel(tier)}).`;
      hint.textContent = label;
    }
    function getMetricsPreviewUrl(){
      const override = (typeof window.METRICS_PREVIEW_URL === 'string') ? window.METRICS_PREVIEW_URL.trim() : '';
      if(override) return override;
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/metrics-preview`;
      return '/functions/v1/metrics-preview';
    }
    function parseDiagnosticsJson(value){
      const raw = String(value || '').trim();
      if(!raw) return {};
      return JSON.parse(raw);
    }
    async function runDiagnosticsMetricPreview(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required');
        return;
      }
      const metricId = String($('diagMetricId')?.value || '').trim();
      if(!metricId){
        setDiagnosticsMetricOutput('Metric ID is required.');
        return;
      }
      let context = {};
      let inputs = {};
      try{
        context = parseDiagnosticsJson($('diagMetricContext')?.value || '');
      }catch(e){
        setDiagnosticsMetricOutput('Invalid JSON in Time Context.');
        return;
      }
      try{
        inputs = parseDiagnosticsJson($('diagMetricInputs')?.value || '');
      }catch(e){
        setDiagnosticsMetricOutput('Invalid JSON in Inputs.');
        return;
      }
      const metricTier = mapSubscriptionTierToMetricTier(getDiagnosticsTier());
      const payload = {
        metric_id: metricId,
        context,
        inputs,
        simulate_tier: metricTier
      };
      setDiagnosticsMetricOutput('Running preview...');
      try{
        const apiUrl = getMetricsPreviewUrl();
        const headers = { 'content-type': 'application/json' };
        const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
        const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
        if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
          headers['apikey'] = sbKey;
          if(SB.session && SB.session.access_token){
            headers['Authorization'] = `Bearer ${SB.session.access_token}`;
          }
        }
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if(!res.ok){
          const msg = data && data.error ? `${data.error.code || 'Error'}: ${data.error.message || ''}` : 'Preview failed';
          const tierEval = data && data.tier_evaluation ? data.tier_evaluation : null;
          const output = {
            ok: false,
            error: msg,
            tier_evaluation: tierEval,
          };
          setDiagnosticsMetricOutput(JSON.stringify(output, null, 2));
          return;
        }
        setDiagnosticsMetricOutput(JSON.stringify(data, null, 2));
      }catch(e){
        setDiagnosticsMetricOutput('Preview failed.');
      }
    }
    function openDiagnosticsModal(){
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      const roleSelect = $('diagRoleSelect');
      const tierSelect = $('diagTierSelect');
      if(roleSelect) roleSelect.value = state._diagRole ? state._diagRole : '';
      if(tierSelect) tierSelect.value = state._diagTier ? state._diagTier : '';
      renderDiagnosticsChecks();
      updateDiagnosticsMetricTierHint();
      setDiagnosticsMetricOutput('');
      if(state._diagRole || state._diagTier){
        const roleLabel = state._diagRole ? state._diagRole : 'current';
        const tierLabel = state._diagTier ? formatTierLabel(state._diagTier) : 'current';
        setDiagnosticsMessage(`Simulation active: role=${roleLabel}, tier=${tierLabel}.`);
      }else{
        setDiagnosticsMessage('');
      }
      show('diagnosticsModal', true);
    }
    function renderRoleTestingSwitcher(){
      const section = $('profileRoleTestingSection');
      const select = $('profileRoleTestingSelect');
      const hint = $('profileRoleTestingHint');
      if(!section || !select) return;
      if(!SB.session || !isSuperUser()){
        section.style.display = 'none';
        if(hint) hint.textContent = '';
        return;
      }
      section.style.display = '';
      const options = getImpersonationRoleOptions();
      const selected = ensureImpersonationRole(state._impersonationRole);
      select.innerHTML = options.map(role => (
        `<option value="${escapeHtmlAttr(role)}">${escapeHtml(role)}</option>`
      )).join('');
      select.value = options.includes(selected) ? selected : 'super_user';
      select.disabled = false;
      select.setAttribute('aria-disabled', 'false');
      if(hint){
        const effective = getEffectiveRole() || 'super_user';
        const label = isImpersonating() ? `Testing as ${effective}` : 'Testing mode';
        hint.textContent = `${label}. UI only; backend stays super_user.`;
      }
    }
    function formatTierLabel(value){
      const tier = normalizeTier(value);
      if(!tier) return '—';
      return TIER_LABELS[tier] || tier;
    }
    function formatBillingState(value){
      const state = String(value || '').trim().toLowerCase();
      if(!state) return '—';
      if(state === 'none') return 'None';
      return state.charAt(0).toUpperCase() + state.slice(1);
    }
    function normalizeCompanyType(value){
      const type = String(value || '').trim().toLowerCase();
      if(type === 'sandbox' || type === 'test' || type === 'system' || type === 'production') return type;
      return 'production';
    }
    function formatCompanyTypeLabel(value){
      const type = normalizeCompanyType(value);
      if(type === 'production') return 'Production';
      if(type === 'sandbox') return 'Sandbox';
      if(type === 'test') return 'Test';
      if(type === 'system') return 'System';
      return 'Production';
    }
    function renderCompanyEnvBadge(){
      const badge = $('profileEnvBadge');
      if(!badge) return;
      if(!SB.companyId){
        badge.textContent = '';
        badge.className = 'env-badge profile-env-badge hidden';
        return;
      }
      const type = normalizeCompanyType(SB.company && SB.company.company_type);
      badge.textContent = formatCompanyTypeLabel(type);
      badge.className = `env-badge profile-env-badge env-${type}`;
    }
    function setTierOverrideMessage(msg){
      const el = $('tierOverrideMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    async function loadTierDetails(companyId){
      if(!SB.ready || !SB.session || !SB.client) return null;
      try{
        const { data, error } = await SB.client.rpc('get_company_tier_details', {
          p_company_id: companyId
        });
        if(error) throw error;
        const row = Array.isArray(data) ? data[0] : data;
        return row && typeof row === 'object' ? row : null;
      }catch(e){
        console.warn('Tier details load failed:', e);
        return null;
      }
    }
    async function refreshTierAdminDetails(){
      if(!SB.companyId) return;
      state._tierDetailsCompanyId = String(SB.companyId);
      state._tierDetails = await loadTierDetails(SB.companyId);
      renderTierAdminSection();
    }
    function renderTierAdminSection(){
      const section = $('tierOverrideSection');
      const divider = $('tierOverrideDivider');
      if(!section) return;
      if(!SB.session || !isEffectiveSuperUser() || !SB.companyId){
        section.style.display = 'none';
        if(divider) divider.style.display = 'none';
        return;
      }
      section.style.display = '';
      if(divider) divider.style.display = '';
      const companyName = SB.company ? String(SB.company.company_name || SB.company.company_slug || SB.company.company_id || '') : '';
      const meta = $('tierOverrideCompany');
      if(meta) meta.textContent = companyName ? `Company: ${companyName}` : '';

      const select = $('tierOverrideSelect');
      if(select){
        const options = ['', ...TIER_ORDER];
        select.innerHTML = options.map(tier => {
          const label = tier ? formatTierLabel(tier) : 'None';
          return `<option value="${escapeHtmlAttr(tier)}">${escapeHtml(label)}</option>`;
        }).join('');
      }

      const details = (state._tierDetailsCompanyId === String(SB.companyId)) ? state._tierDetails : null;
      if(!details){
        if($('tierBillingValue')) $('tierBillingValue').textContent = 'Loading…';
        if($('tierOverrideValue')) $('tierOverrideValue').textContent = 'Loading…';
        if($('tierEffectiveValue')) $('tierEffectiveValue').textContent = 'Loading…';
        if($('tierBillingStateValue')) $('tierBillingStateValue').textContent = 'Loading…';
        if(select) select.value = '';
        setTierOverrideMessage('');
        void refreshTierAdminDetails();
        return;
      }

      if($('tierBillingValue')) $('tierBillingValue').textContent = formatTierLabel(details.subscription_tier);
      if($('tierOverrideValue')) $('tierOverrideValue').textContent = details.override_tier ? formatTierLabel(details.override_tier) : 'None';
      if($('tierEffectiveValue')) $('tierEffectiveValue').textContent = formatTierLabel(details.effective_tier);
      if($('tierBillingStateValue')) $('tierBillingStateValue').textContent = formatBillingState(details.billing_state);
      if(select) select.value = details.override_tier ? String(details.override_tier) : '';

      const reasonInput = $('tierOverrideReason');
      if(reasonInput && !reasonInput.value){
        reasonInput.value = details.override_reason ? String(details.override_reason) : '';
      }
      setTierOverrideMessage('');
    }
	    function setInviteMessage(msg){
	      const el = $('inviteMsg'); if(!el) return;
	      el.textContent = String(msg || '');
	    }
	    function showInviteLink(url){
	      const row = $('inviteLinkRow');
	      const input = $('inviteLink');
	      if(!row || !input) return;
	      const value = String(url || '').trim();
	      input.value = value;
	      row.style.display = value ? 'flex' : 'none';
	    }
    function renderInviteUi(){
      const section = $('inviteSection');
      const email = $('inviteEmail');
      const role = $('inviteRole');
      const btn = $('btnInviteSend');
      const companyRow = $('inviteCompanyRow');
      const companySelect = $('inviteCompany');
      if(!section) return;
      if(!SB.session){
        section.style.display = 'none';
        return;
      }
      section.style.display = '';
      const superUser = isEffectiveSuperUser();
      if(companyRow) companyRow.style.display = superUser ? '' : 'none';
      let selectedCompanyId = SB.companyId ? String(SB.companyId) : '';
      if(superUser && companySelect){
        const rows = Array.isArray(SB.companies) ? SB.companies : [];
        companySelect.innerHTML = '';
        if(!rows.length){
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No companies available';
          companySelect.appendChild(opt);
          companySelect.disabled = true;
          selectedCompanyId = '';
        }else{
          rows.forEach(row => {
            const id = String(row && row.company_id ? row.company_id : '').trim();
            if(!id) return;
            const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || id;
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = name;
            companySelect.appendChild(opt);
          });
          if(_inviteCompanyId && rows.some(r => String(r.company_id) === _inviteCompanyId)){
            selectedCompanyId = _inviteCompanyId;
          }else if(!selectedCompanyId || !rows.some(r => String(r.company_id) === selectedCompanyId)){
            selectedCompanyId = String(rows[0].company_id || '');
          }
          companySelect.value = selectedCompanyId || '';
          companySelect.disabled = rows.length <= 1;
        }
      }
      const currentCompanyId = superUser
        ? String(selectedCompanyId || '').trim()
        : (SB.companyId ? String(SB.companyId) : '');
      if(currentCompanyId !== _inviteCompanyId){
        _inviteCompanyId = currentCompanyId;
        showInviteLink('');
        setInviteMessage('');
      }
      const allow = !!(currentCompanyId && canAccessInvites());
      const disabled = !allow;
      if(email) email.disabled = disabled;
      if(role) role.disabled = disabled;
      if(btn){
	        btn.disabled = disabled;
	        btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
	      }
      if(disabled){
        showInviteLink('');
        if(!currentCompanyId){
          setInviteMessage('Select a company to invite users.');
        }else if(!hasTier('business')){
          setInviteMessage('Invites require Business tier.');
        }else if(!canInvite()){
          setInviteMessage('Invite permissions required.');
        }else{
	          setInviteMessage('');
	        }
	      }
	    }
	    function storeInviteTokenFromUrl(){
	      try{
	        const params = new URLSearchParams(window.location.search);
	        const token = params.get('invite');
	        if(!token) return;
	        localStorage.setItem('inv.pendingInvite', token);
	        window.history.replaceState({}, '', window.location.pathname);
	      }catch(e){}
	    }
	    async function sbCheckPendingInvite(){
	      storeInviteTokenFromUrl();
	      if(!SB.ready || !SB.session || !SB.client) return false;
	      const token = localStorage.getItem('inv.pendingInvite');
	      if(!token) return false;
	      try{
	        const { data, error } = await SB.client.rpc('accept_invitation', { invitation_token: token });
	        if(error) throw error;
	        if(data && data.success){
	          localStorage.removeItem('inv.pendingInvite');
	          const role = data.role ? String(data.role) : 'member';
	          toast(`Welcome! Joined as ${role}.`);
	          return true;
	        }
	        const msg = data && data.error ? String(data.error) : 'Failed to accept invitation';
	        if(!/different email/i.test(msg)){
	          localStorage.removeItem('inv.pendingInvite');
	        }
	        toast(msg);
	      }catch(e){
	        toast('Invitation error');
	      }
	      return false;
	    }
    async function sbInviteUser(email, role, companyId){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!hasTier('business')) throw Error('Invites require Business tier');
      const targetCompanyId = String(companyId || '').trim() || (SB.companyId ? String(SB.companyId) : '');
      if(!targetCompanyId) throw Error('Company not selected');
      if(!canInvite()) throw Error('Permission denied');
      const cleanEmail = String(email || '').trim();
      if(!cleanEmail) throw Error('Email required');
      const cleanRole = String(role || 'member').trim() || 'member';
      const { data, error } = await SB.client.rpc('invite_user', {
        p_company_id: targetCompanyId,
        p_email: cleanEmail,
        p_role: cleanRole,
      });
	      if(error) throw error;
	      return data || null;
	    }
	    function resetCompanyScopedState(){
	      state.items = [];
	      try{ applySelectedRowIds([]); }catch(e){}
	      try{ clearAllOrderLines(); }catch(e){}
	      state._orderHistoryRows = [];
	      state._orderHistoryById = new Map();
	      state._orderHistoryFilter = '';
	      const orderHistoryFilter = $('orderHistoryFilter');
	      if(orderHistoryFilter) orderHistoryFilter.value = '';
	      state._trashItems = [];
	      state._trashFilter = '';
	      const trashFilter = $('trashFilter');
	      if(trashFilter) trashFilter.value = '';
	      state._roleRequestPending = null;
      state._roleRequests = [];
      state._auditRows = [];
      state._auditTableFilter = '';
      state._auditActionFilter = '';
      state._auditSearch = '';
      const auditSearch = $('auditSearchFilter');
      if(auditSearch) auditSearch.value = '';
      state._shippingAddresses = [];
      state._shippingAddressById = new Map();
      state._shippingAddressEditing = null;
      state._userMgmtRows = [];
      state._snapshots = [];
      state._snapshotPreview = null;
      state._metrics = null;
      state._roleConfigs = {};
      state._roleChanges = {};
      _inviteCompanyId = '';
      _userMgmtCompanyId = '';
      updateOrderCounterBadge();
    }
	    async function sbSwitchCompany(nextCompanyId, opts = {}){
	      if(!SB.ready || !SB.session) return false;
      const options = (opts && typeof opts === 'object') ? opts : {};
      const persist = options.persist !== false;
      const audit = options.audit === true;
      const source = options.source ? String(options.source) : null;
      const rowOverride = options.companyRow && typeof options.companyRow === 'object' ? options.companyRow : null;
	      const nextId = String(nextCompanyId || '').trim();
	      if(!nextId || nextId === SB.companyId) return false;
	      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      let target = rowOverride ? { ...rowOverride } : (rows.find(r => String(r.company_id) === nextId) || null);
	      if(!target){
	        toast('Company not found');
	        renderCompanySwitcher();
	        return false;
	      }
      if(rowOverride && !isEffectiveSuperUser()){
        toast('Super user access required');
        return false;
      }
      const prev = {
        companyId: SB.companyId,
        company: SB.company,
        permissions: SB.permissions,
        authorized: SB.authorized,
        connected: SB.connected,
        companyType: normalizeCompanyType(SB.company && SB.company.company_type),
      };
      target.company_type = normalizeCompanyType(target.company_type);
      SB.companyId = nextId;
      SB.company = target;
      SB.companyTier = SB.company ? getCompanyTier() : null;
      state._tierDetails = null;
      state._tierDetailsCompanyId = null;
      if(persist) saveCompanyId(nextId);
      SB.permissions = null;
      SB.authorized = false;
      SB.connected = false;
      updateStatusBar();
      renderCompanySwitcher();
      renderTierAdminSection();
	      applyPermissionUI();
	      resetCompanyScopedState();
	      render();
	      if(_sbChannel && SB.client){ try{ SB.client.removeChannel(_sbChannel); }catch(e){} _sbChannel = null; }
	      try{
	        await sbLoadPermissions();
	      }catch(e){
	        console.warn('Permissions load failed:', e);
	        SB.companyId = prev.companyId;
	        SB.company = prev.company;
	        SB.permissions = prev.permissions;
	        SB.authorized = prev.authorized;
	        SB.connected = prev.connected;
	        updateStatusBar();
	        renderCompanySwitcher();
	        applyPermissionUI();
	        render();
	        toast('Company switch failed');
	        return false;
	      }
      resetImpersonationState('company_switch');
	      SB.authorized = !!(SB.permissions && hasPermission(PERMISSIONS.ITEMS_VIEW));
	      updateStatusBar();
	      renderProfileUi();
	      applyPermissionUI();
      if(audit && SB.client){
        try{
          await SB.client.rpc('log_company_switch', {
            p_company_id: nextId,
            p_from_company_id: prev.companyId ? String(prev.companyId) : null,
            p_from_company_type: prev.companyType || null,
            p_to_company_type: target.company_type || null,
            p_source: source || null
          });
        }catch(e){
          console.warn('Company switch audit failed:', e);
        }
      }
	      if(!SB.authorized) return true;
	      await checkServerHealth();
	      if(isOnline()){
	        await sbLoadSnapshot();
	        sbStartRealtime();
	      }
	      return true;
	    }
	    async function sbEnsureProfile(){
	      if(!SB.ready || !SB.user) return null;
	      try{
	        const { data, error } = await SB.client
	          .from('profiles')
	          .select('*')
	          .eq('user_id', SB.user.id)
	          .maybeSingle();
	        if(error) throw error;
	        if(data){
	          data.first_name = data.first_name || '';
	          data.last_name = data.last_name || '';
	          data.phone = data.phone || '';
	          if(typeof data.silence_low_stock_alerts === 'undefined'){
	            data.silence_low_stock_alerts = lowStockAlertsSilenced();
	          }else{
	            data.silence_low_stock_alerts = !!data.silence_low_stock_alerts;
	          }
	          if(typeof data.low_stock_qty_global === 'undefined' || data.low_stock_qty_global === null){
	            data.low_stock_qty_global = getGlobalLowStockQty();
	          }else{
	            data.low_stock_qty_global = toInt(data.low_stock_qty_global, 0);
	          }
	          try{ localStorage.setItem('inv.pref.silenceLowStockAlerts', data.silence_low_stock_alerts ? '1' : '0'); }catch(e){}
	          try{ localStorage.setItem('inv.pref.lowStockQtyGlobal', String(toInt(data.low_stock_qty_global,0))); }catch(e){}
	          SB.profile = data;
	          return data;
	        }

	        const desiredSilence = lowStockAlertsSilenced();
	        const desiredGlobal = getGlobalLowStockQty();
	        const base = {
	          user_id: SB.user.id,
	          email: String(SB.user.email||'').trim(),
	          first_name: '',
	          last_name: '',
	          phone: '',
	        };
	        const attempts = [
	          { silence:true, global:true },
	          { silence:true, global:false },
	          { silence:false, global:true },
	          { silence:false, global:false },
	        ];
	        let lastError = null;
	        for(const a of attempts){
	          const row = { ...base };
	          if(a.silence) row.silence_low_stock_alerts = desiredSilence;
	          if(a.global) row.low_stock_qty_global = desiredGlobal;
	          const res = await SB.client.from('profiles').insert([row]);
	          if(!res.error){
	            SB.profile = { ...row };
	            SB.profile.silence_low_stock_alerts = desiredSilence;
	            SB.profile.low_stock_qty_global = desiredGlobal;
	            return SB.profile;
	        }
	        lastError = res.error;
	        const msg = errToText(res.error);
	        if(!(msg.includes('silence_low_stock_alerts') || msg.includes('low_stock_qty_global'))){
	          break;
	        }
	        }
	        if(lastError) throw lastError;
	        throw Error('Profile create failed');
	      }catch(e){
	        console.warn('Profile ensure failed:', e);
	        SB.profile = {
	          user_id: SB.user.id,
	          email: String(SB.user.email||'').trim(),
	          first_name: '',
	          last_name: '',
	          phone: '',
	          silence_low_stock_alerts: lowStockAlertsSilenced(),
	          low_stock_qty_global: getGlobalLowStockQty(),
	        };
	        return SB.profile;
	      }
	    }
    async function sbSaveProfile(firstName, lastName, phone, silenceLowStockAlerts, lowStockQtyGlobal){
      if(!SB.ready || !SB.user) throw Error('Not signed in');
      const desiredSilence = !!silenceLowStockAlerts;
      const desiredGlobal = toInt(lowStockQtyGlobal, -1);
      if(desiredGlobal < 0) throw Error('Global low stock qty must be integer ≥ 0');
      try{ localStorage.setItem('inv.pref.silenceLowStockAlerts', desiredSilence ? '1' : '0'); }catch(e){}
      try{ localStorage.setItem('inv.pref.lowStockQtyGlobal', String(desiredGlobal)); }catch(e){}

      const base = {
        user_id: SB.user.id,
        email: String(SB.user.email||'').trim(),
        first_name: String(firstName||'').trim(),
        last_name: String(lastName||'').trim(),
        phone: String(phone||'').trim(),
      };

      const attempts = [
        { silence:true, global:true },
        { silence:true, global:false },
        { silence:false, global:true },
        { silence:false, global:false },
      ];
      let lastError = null;
      for(const a of attempts){
        const row = { ...base };
        if(a.silence) row.silence_low_stock_alerts = desiredSilence;
        if(a.global) row.low_stock_qty_global = desiredGlobal;
        const res = await SB.client.from('profiles').upsert([row], { onConflict: 'user_id' });
        if(!res.error){
          SB.profile = { ...row };
          SB.profile.silence_low_stock_alerts = desiredSilence;
          SB.profile.low_stock_qty_global = desiredGlobal;
          return SB.profile;
        }
        lastError = res.error;
        const msg = String(res.error && res.error.message ? res.error.message : '');
        if(!(msg.includes('silence_low_stock_alerts') || msg.includes('low_stock_qty_global'))){
          break;
        }
      }
      if(lastError) throw lastError;
      throw Error('Save failed');
    }
    async function sbRefreshAccess(){
      SB.authorized = false;
      SB.permissions = null;
      SB.companies = [];
      SB.companyId = null;
      SB.company = null;
      SB.companyTier = null;
      state._tierDetails = null;
      state._tierDetailsCompanyId = null;
      if(!SB.ready || !SB.user){ updateStatusBar(); return false; }
      try{
        await sbLoadCompanies();
      }catch(e){
        console.warn('Company load failed:', e);
        updateStatusBar();
        renderCompanySwitcher();
        renderAdvancedCompanySwitcherButton();
        renderDiagnosticsButton();
        renderInviteUi();
        renderRoleRequestUi();
        renderRoleRequestsAdminButton();
        renderRoleManagerButton();
        renderUserMgmtButton();
        return false;
      }
      if(!SB.companyId){
        updateStatusBar();
        renderCompanySwitcher();
        renderAdvancedCompanySwitcherButton();
        renderDiagnosticsButton();
        renderInviteUi();
        renderRoleRequestUi();
        renderRoleRequestsAdminButton();
        renderRoleManagerButton();
        renderUserMgmtButton();
        return false;
      }
      try{
        await sbLoadPermissions();
      }catch(e){
        console.warn('Permissions load failed:', e);
        updateStatusBar();
        renderCompanySwitcher();
        renderAdvancedCompanySwitcherButton();
        renderDiagnosticsButton();
        renderInviteUi();
        renderRoleRequestUi();
        renderRoleRequestsAdminButton();
        renderRoleManagerButton();
        renderUserMgmtButton();
        return false;
      }
      SB.authorized = !!(SB.permissions && hasPermission(PERMISSIONS.ITEMS_VIEW));
      updateStatusBar();
      renderCompanySwitcher();
      renderAdvancedCompanySwitcherButton();
      renderDiagnosticsButton();
      renderInviteUi();
      renderRoleRequestUi();
      renderRoleRequestsAdminButton();
      renderRoleManagerButton();
      renderUserMgmtButton();
      return SB.authorized;
    }
    async function sbHandleSession(session){
      SB.session = session || null;
      SB.user = session && session.user ? session.user : null;
      SB.connected = false;
      SB.authorized = false;
      SB.profile = null;
      SB.permissions = null;
      SB.companies = [];
      SB.companyId = null;
      SB.company = null;
      SB.companyTier = null;
      if(!session){
        state._diagRole = '';
        state._diagTier = '';
        state._diagPermissions = null;
      }
      updateStatusBar();
      applyPermissionUI();

      if(!SB.session){
        state.items = [];
        state._userMgmtRows = [];
        state._snapshots = [];
        state._snapshotPreview = null;
        state._metrics = null;
        state._roleConfigs = {};
        state._roleChanges = {};
        state._impersonationRole = 'super_user';
        state._impersonationPermissions = null;
        _inviteCompanyId = '';
        _userMgmtCompanyId = '';
        if(_sbChannel && SB.client){ try{ SB.client.removeChannel(_sbChannel); }catch{} _sbChannel=null; }
        render();
        show('authModal', true);
        applyPermissionUI();
        renderCompanySwitcher();
        renderInviteUi();
        renderRoleManagerButton();
        renderUserMgmtButton();
        return;
      }

      show('authModal', false);
      setAuthMessage('');

      await sbEnsureProfile();
      await sbCheckPendingInvite();
      await sbRefreshAccess();
      try{ await sbLoadMyRoleRequest(); }catch(e){}
      renderProfileUi();
      applyPermissionUI();

      if(!SB.authorized){
        state.items = [];
        render();
        updateStatusBar();
        return;
      }

      await checkServerHealth();
      if(isOnline()){
        await sbLoadSnapshot();
        sbStartRealtime();
      }
    }
    async function sbAuthBoot(){
      if(!SB.ready || !SB.client) return;

      renderAuthUi();

      // Profile dropdown handlers
      const profileBtn = $('profileBtn');
      const profileDropdown = $('profileDropdown');
      const profileSignIn = $('profileSignIn');
      const profileCompanySelect = $('profileCompanySelect');
      const profileRoleTestingSelect = $('profileRoleTestingSelect');
      const advancedCompanyBtn = $('openAdvancedCompanySwitcher');
      const diagnosticsBtn = $('openDiagnostics');

      function toggleProfileDropdown(open){
        if(profileDropdown){
          profileDropdown.style.display = '';
          profileDropdown.classList.toggle('open', open);
          profileDropdown.setAttribute('aria-hidden', open ? 'false' : 'true');
          if(profileBtn) profileBtn.setAttribute('aria-expanded', open);
        }
      }

      if(profileBtn && !profileBtn._wired){
        profileBtn._wired = true;
        profileBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          toggleProfileDropdown(!profileDropdown.classList.contains('open'));
        });
      }

      if(profileSignIn && !profileSignIn._wired){
        profileSignIn._wired = true;
        profileSignIn.addEventListener('click', ()=>{
          toggleProfileDropdown(false);
          if(!SB.session) {
            show('authModal', true);
          } else {
            // Sign out
            sbSignOut();
          }
        });
      }

      if(profileCompanySelect && !profileCompanySelect._wired){
        profileCompanySelect._wired = true;
        profileCompanySelect.addEventListener('change', async (e)=>{
          const nextId = e && e.target ? e.target.value : '';
          if(!nextId || nextId === SB.companyId) return;
          const ok = await sbSwitchCompany(nextId);
          if(ok){
            const name = SB.company && SB.company.company_name ? SB.company.company_name : 'company';
            toast(`Switched to ${name}`);
          }
        });
      }

      if(profileRoleTestingSelect && !profileRoleTestingSelect._wired){
        profileRoleTestingSelect._wired = true;
        profileRoleTestingSelect.addEventListener('change', async (e)=>{
          const nextRole = e && e.target ? e.target.value : '';
          await setImpersonationRole(nextRole, 'manual');
        });
      }
      if(advancedCompanyBtn && !advancedCompanyBtn._wired){
        advancedCompanyBtn._wired = true;
        advancedCompanyBtn.addEventListener('click', ()=>{
          toggleProfileDropdown(false);
          void openAdvancedCompanySwitcher();
        });
      }
      if(diagnosticsBtn && !diagnosticsBtn._wired){
        diagnosticsBtn._wired = true;
        diagnosticsBtn.addEventListener('click', ()=>{
          toggleProfileDropdown(false);
          openDiagnosticsModal();
        });
      }

      // Close profile dropdown when clicking outside
      document.addEventListener('click', (e)=>{
        if(profileDropdown && profileDropdown.classList.contains('open')){
          if(!e.target.closest('.profile-menu')){
            toggleProfileDropdown(false);
          }
        }
      });

      try{
        const { data } = await SB.client.auth.getSession();
        await sbHandleSession(data && data.session ? data.session : null);
      }catch(e){
        console.warn('Auth boot failed:', e);
        await sbHandleSession(null);
      }

      SB.client.auth.onAuthStateChange((event, session)=>{
        if(event === 'PASSWORD_RECOVERY'){
          show('authModal', false);
          show('resetModal', true);
          setResetMessage('');
        }
        void sbHandleSession(session);
      });
    }
    async function sbSignIn(email, password){
      if(!SB.ready) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      const p = String(password||'');
      if(!e) throw Error('Email required');
      if(!p) throw Error('Password required');
      const { error } = await SB.client.auth.signInWithPassword({ email: e, password: p });
      if(error) throw error;
    }
    async function sbSignOut(){
      if(!SB.ready || !SB.client) return;
      await SB.client.auth.signOut();
    }

    // ---------- Auth/Profile modal events ----------
    const btnAuthSubmit = $('btnAuthSubmit');
    if(btnAuthSubmit) btnAuthSubmit.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      const password = $('authPassword')?.value || '';
      setAuthMessage('');
      btnAuthSubmit.disabled = true;
      try{
        await sbSignIn(email, password);
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Authentication failed');
      }finally{
        btnAuthSubmit.disabled = false;
      }
    });

    const btnAuthForgot = $('btnAuthForgot');
    if(btnAuthForgot) btnAuthForgot.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      setAuthMessage('');
      btnAuthForgot.disabled = true;
      btnAuthForgot.setAttribute('aria-disabled', 'true');
      try{
        await sbSendPasswordReset(email);
        setAuthMessage('Password reset email sent.');
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Reset failed');
      }finally{
        btnAuthForgot.disabled = false;
        btnAuthForgot.setAttribute('aria-disabled', 'false');
      }
    });

    const authPassword = $('authPassword');
    if(authPassword) authPassword.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); $('btnAuthSubmit')?.click(); }
    });

    const btnResetSubmit = $('btnResetSubmit');
    if(btnResetSubmit) btnResetSubmit.addEventListener('click', async ()=>{
      const pw = $('resetPassword')?.value || '';
      const confirm = $('resetPasswordConfirm')?.value || '';
      setResetMessage('');
      if(!pw || !confirm){ setResetMessage('Enter and confirm your new password'); return; }
      if(pw !== confirm){ setResetMessage('Passwords do not match'); return; }
      btnResetSubmit.disabled = true;
      btnResetSubmit.setAttribute('aria-disabled', 'true');
      try{
        await sbUpdatePassword(pw);
        setResetMessage('Password updated. You can close this window.');
        toast('Password updated');
      }catch(e){
        setResetMessage(e && e.message ? e.message : 'Update failed');
      }finally{
        btnResetSubmit.disabled = false;
        btnResetSubmit.setAttribute('aria-disabled', 'false');
      }
    });

    const btnResetClose = $('btnResetClose');
    if(btnResetClose) btnResetClose.addEventListener('click', ()=> show('resetModal', false));

    const btnRoleRequest = $('btnRoleRequest');
    if(btnRoleRequest) btnRoleRequest.addEventListener('click', async ()=>{
      const role = $('roleRequestRole')?.value || '';
      const reason = $('roleRequestReason')?.value || '';
      setRoleRequestMessage('');
      if(!role){ setRoleRequestMessage('Select a role'); return; }
      btnRoleRequest.disabled = true;
      btnRoleRequest.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('request_role_change', {
          p_requested_role: role,
          p_reason: String(reason || '').trim() || null,
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Request failed');
        }
        await sbLoadMyRoleRequest();
        renderRoleRequestUi();
        setRoleRequestMessage('Request submitted.');
      }catch(e){
        setRoleRequestMessage(e && e.message ? e.message : 'Request failed');
      }finally{
        btnRoleRequest.disabled = false;
        btnRoleRequest.setAttribute('aria-disabled', 'false');
      }
    });

    const btnTierOverrideSave = $('btnTierOverrideSave');
    if(btnTierOverrideSave) btnTierOverrideSave.addEventListener('click', async ()=>{
      const reason = String($('tierOverrideReason')?.value || '').trim();
      const selected = String($('tierOverrideSelect')?.value || '').trim();
      setTierOverrideMessage('');
      if(!SB.session || !isEffectiveSuperUser()){
        setTierOverrideMessage('Super user access required.');
        return;
      }
      if(!SB.companyId){
        setTierOverrideMessage('Select a company first.');
        return;
      }
      if(!reason){
        setTierOverrideMessage('Reason required.');
        return;
      }
      btnTierOverrideSave.disabled = true;
      btnTierOverrideSave.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('set_company_tier_override', {
          p_company_id: SB.companyId,
          p_tier: selected || null,
          p_reason: reason
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Override failed');
        }
        await sbRefreshAccess();
        await refreshTierAdminDetails();
        setTierOverrideMessage(selected ? 'Override saved.' : 'Override cleared.');
        toast(selected ? 'Tier override saved' : 'Tier override cleared');
        const reasonInput = $('tierOverrideReason');
        if(reasonInput) reasonInput.value = '';
      }catch(e){
        setTierOverrideMessage(e && e.message ? e.message : 'Override failed');
      }finally{
        btnTierOverrideSave.disabled = false;
        btnTierOverrideSave.setAttribute('aria-disabled', 'false');
      }
    });

    const btnTierOverrideClear = $('btnTierOverrideClear');
    if(btnTierOverrideClear) btnTierOverrideClear.addEventListener('click', async ()=>{
      const reason = String($('tierOverrideReason')?.value || '').trim();
      setTierOverrideMessage('');
      if(!SB.session || !isEffectiveSuperUser()){
        setTierOverrideMessage('Super user access required.');
        return;
      }
      if(!SB.companyId){
        setTierOverrideMessage('Select a company first.');
        return;
      }
      if(!reason){
        setTierOverrideMessage('Reason required.');
        return;
      }
      btnTierOverrideClear.disabled = true;
      btnTierOverrideClear.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('set_company_tier_override', {
          p_company_id: SB.companyId,
          p_tier: null,
          p_reason: reason
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Override failed');
        }
        await sbRefreshAccess();
        await refreshTierAdminDetails();
        setTierOverrideMessage('Override cleared.');
        toast('Tier override cleared');
        const reasonInput = $('tierOverrideReason');
        if(reasonInput) reasonInput.value = '';
      }catch(e){
        setTierOverrideMessage(e && e.message ? e.message : 'Override failed');
      }finally{
        btnTierOverrideClear.disabled = false;
        btnTierOverrideClear.setAttribute('aria-disabled', 'false');
      }
    });

    const advancedCompanySearchBtn = $('advancedCompanySearchBtn');
    if(advancedCompanySearchBtn) advancedCompanySearchBtn.addEventListener('click', async ()=>{
      await loadAdvancedCompanies();
    });
    const advancedCompanyReturnBtn = $('advancedCompanyReturnBtn');
    if(advancedCompanyReturnBtn) advancedCompanyReturnBtn.addEventListener('click', async ()=>{
      if(!isEffectiveSuperUser()){
        toast('Super user access required');
        return;
      }
      const defaultId = getDefaultProductionCompanyId();
      if(!defaultId){
        toast('No production company available');
        return;
      }
      const ok = await sbSwitchCompany(defaultId, {
        persist: false,
        audit: true,
        source: 'advanced_switcher'
      });
      if(ok){
        toast('Returned to production');
        renderAdvancedCompanyActions();
      }
    });
    const advancedCompanyClose = $('advancedCompanyClose');
    if(advancedCompanyClose) advancedCompanyClose.addEventListener('click', ()=>{
      show('advancedCompanyModal', false);
    });
    const advancedCompanySearch = $('advancedCompanySearch');
    if(advancedCompanySearch) advancedCompanySearch.addEventListener('keydown', async (e)=>{
      if(e.key !== 'Enter') return;
      e.preventDefault();
      await loadAdvancedCompanies();
    });
    const advancedCompanyTypeFilter = $('advancedCompanyTypeFilter');
    if(advancedCompanyTypeFilter) advancedCompanyTypeFilter.addEventListener('change', async ()=>{
      await loadAdvancedCompanies();
    });

    const diagApply = $('diagApply');
    if(diagApply) diagApply.addEventListener('click', async ()=>{
      await applyDiagnosticsSimulation();
    });
    const diagReset = $('diagReset');
    if(diagReset) diagReset.addEventListener('click', ()=>{
      resetDiagnosticsSimulation();
    });
    const diagClose = $('diagClose');
    if(diagClose) diagClose.addEventListener('click', ()=>{
      show('diagnosticsModal', false);
    });
    const diagMetricRun = $('diagMetricRun');
    if(diagMetricRun) diagMetricRun.addEventListener('click', async ()=>{
      await runDiagnosticsMetricPreview();
    });
    const diagRoleSelect = $('diagRoleSelect');
    if(diagRoleSelect) diagRoleSelect.addEventListener('change', ()=>{
      setDiagnosticsMessage('Simulation changed. Apply to activate.');
    });
    const diagTierSelect = $('diagTierSelect');
    if(diagTierSelect) diagTierSelect.addEventListener('change', ()=>{
      setDiagnosticsMessage('Simulation changed. Apply to activate.');
      updateDiagnosticsMetricTierHint();
    });

    const btnProfileClose = $('btnProfileClose');
    if(btnProfileClose) btnProfileClose.addEventListener('click', ()=> {
      if(_profileAutoSaveTimer){ clearTimeout(_profileAutoSaveTimer); _profileAutoSaveTimer = null; }
      show('profileModal', false);
    });

    const btnInviteSend = $('btnInviteSend');
    if(btnInviteSend) btnInviteSend.addEventListener('click', async ()=>{
      if(!btnInviteSend) return;
      const email = $('inviteEmail')?.value || '';
      const role = $('inviteRole')?.value || 'member';
      const companyId = _inviteCompanyId || (SB.companyId ? String(SB.companyId) : '');
      setInviteMessage('');
      showInviteLink('');
      btnInviteSend.disabled = true;
      btnInviteSend.setAttribute('aria-disabled', 'true');
      try{
        const data = await sbInviteUser(email, role, companyId);
        if(data && data.success){
          const url = data.invite_url ? String(data.invite_url) : '';
          if(url){
            showInviteLink(url);
            try{ await copyText(url); }catch(e){}
            setInviteMessage('Invite created. Link copied.');
          }else{
            setInviteMessage('Invite created.');
          }
        }else{
          const msg = data && data.error ? String(data.error) : 'Invite failed';
          setInviteMessage(msg);
        }
      }catch(e){
        setInviteMessage(e && e.message ? e.message : 'Invite failed');
      }finally{
        btnInviteSend.disabled = false;
        btnInviteSend.setAttribute('aria-disabled', 'false');
        renderInviteUi();
      }
    });

    const btnInviteCopy = $('btnInviteCopy');
    if(btnInviteCopy) btnInviteCopy.addEventListener('click', async ()=>{
      const url = $('inviteLink')?.value || '';
      if(!url){ toast('No invite link'); return; }
      try{
        await copyText(String(url));
        toast('Invite link copied');
      }catch(e){
        toast('Copy failed');
      }
    });

    const inviteEmail = $('inviteEmail');
    if(inviteEmail) inviteEmail.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        $('btnInviteSend')?.click();
      }
    });
    const inviteCompany = $('inviteCompany');
    if(inviteCompany && !inviteCompany._wired){
      inviteCompany._wired = true;
      inviteCompany.addEventListener('change', ()=>{
        _inviteCompanyId = inviteCompany.value || '';
        showInviteLink('');
        setInviteMessage('');
        renderInviteUi();
      });
    }

    const openProfileSettings = $('openProfileSettings');
    if(openProfileSettings) openProfileSettings.addEventListener('click', ()=>{
      const profileDropdown = $('profileDropdown');
      if(profileDropdown){
        profileDropdown.classList.remove('open');
        profileDropdown.style.display = '';
        profileDropdown.setAttribute('aria-hidden', 'true');
      }
      $('profileBtn')?.setAttribute('aria-expanded', 'false');
      renderProfileUi();
      show('profileModal', true);
      if(SB.session){
        sbLoadMyRoleRequest()
          .then(() => renderRoleRequestUi())
          .catch(()=>{});
      }
    });

    const openInviteModal = $('openInviteModal');
    if(openInviteModal) openInviteModal.addEventListener('click', ()=>{
      const profileDropdown = $('profileDropdown');
      if(profileDropdown){
        profileDropdown.classList.remove('open');
        profileDropdown.style.display = '';
        profileDropdown.setAttribute('aria-hidden', 'true');
      }
      $('profileBtn')?.setAttribute('aria-expanded', 'false');
      if(!SB.session){
        show('authModal', true);
        return;
      }
      renderInviteUi();
      show('inviteModal', true);
    });

    const openUserMgmt = $('openUserMgmt');
    if(openUserMgmt) openUserMgmt.addEventListener('click', ()=>{
      const profileDropdown = $('profileDropdown');
      if(profileDropdown){
        profileDropdown.classList.remove('open');
        profileDropdown.style.display = '';
        profileDropdown.setAttribute('aria-hidden', 'true');
      }
      $('profileBtn')?.setAttribute('aria-expanded', 'false');
      openUserMgmtModal();
    });

    const openRoleManager = $('openRoleManager');
    if(openRoleManager) openRoleManager.addEventListener('click', ()=>{
      const profileDropdown = $('profileDropdown');
      if(profileDropdown){
        profileDropdown.classList.remove('open');
        profileDropdown.style.display = '';
        profileDropdown.setAttribute('aria-hidden', 'true');
      }
      $('profileBtn')?.setAttribute('aria-expanded', 'false');
      openRoleManagerModal();
    });

    const btnInviteClose = $('btnInviteClose');
    if(btnInviteClose) btnInviteClose.addEventListener('click', ()=>{
      show('inviteModal', false);
    });

    const openRoleRequests = $('openRoleRequests');
    if(openRoleRequests) openRoleRequests.addEventListener('click', ()=>{
      const profileDropdown = $('profileDropdown');
      if(profileDropdown){
        profileDropdown.classList.remove('open');
        profileDropdown.style.display = '';
        profileDropdown.setAttribute('aria-hidden', 'true');
      }
      $('profileBtn')?.setAttribute('aria-expanded', 'false');
      openRoleRequestsModal();
    });

    const btnRoleRequestsClose = $('btnRoleRequestsClose');
    if(btnRoleRequestsClose) btnRoleRequestsClose.addEventListener('click', closeRoleRequestsModal);
    const btnRoleRequestsRefresh = $('btnRoleRequestsRefresh');
    if(btnRoleRequestsRefresh) btnRoleRequestsRefresh.addEventListener('click', refreshRoleRequests);
    const btnRoleManagerClose = $('btnRoleManagerClose');
    if(btnRoleManagerClose) btnRoleManagerClose.addEventListener('click', closeRoleManagerModal);
    const btnRoleManagerSave = $('btnRoleManagerSave');
    if(btnRoleManagerSave) btnRoleManagerSave.addEventListener('click', saveRoleManagerChanges);
    const roleManagerBody = $('roleManagerBody');
    if(roleManagerBody) roleManagerBody.addEventListener('change', (e)=> handleRoleManagerToggle(e.target));
    const roleRequestsList = $('roleRequestsList');
    if(roleRequestsList) roleRequestsList.addEventListener('click', async (e)=>{
      const approveBtn = e.target.closest('[data-role-approve-id]');
      const denyBtn = e.target.closest('[data-role-deny-id]');
      if(!approveBtn && !denyBtn) return;
      const id = String((approveBtn || denyBtn).getAttribute(approveBtn ? 'data-role-approve-id' : 'data-role-deny-id') || '').trim();
      if(!id) return;
      const approved = !!approveBtn;
      let notesEl = null;
      if(window.CSS && CSS.escape){
        notesEl = roleRequestsList.querySelector(`[data-role-notes-id="${CSS.escape(id)}"]`);
      }else{
        const safeId = String(id).replace(/"/g, '\\"');
        notesEl = roleRequestsList.querySelector(`[data-role-notes-id="${safeId}"]`);
      }
      const notes = notesEl ? String(notesEl.value || '').trim() : '';
      const label = approved ? 'Approve request?' : 'Deny request?';
      const okText = approved ? 'Approve' : 'Deny';
      if(!(await openConfirmModal(label, 'This will update the user role.', { okText, cancelText:'Cancel' }))) return;
      try{
        const { data, error } = await SB.client.rpc('process_role_request', {
          p_request_id: id,
          p_approved: approved,
          p_admin_notes: notes || null,
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Request failed');
        }
        const row = state._roleRequests.find(r => String(r.id) === id);
        state._roleRequests = (state._roleRequests || []).filter(r => String(r.id) !== id);
        renderRoleRequestsList();
        if(row && SB.user && String(row.user_id) === String(SB.user.id) && approved){
          await sbRefreshAccess();
        }
        toast(approved ? 'Role updated' : 'Request denied');
      }catch(err){
        toast(err && err.message ? err.message : 'Update failed');
      }
    });

    const btnUserMgmtClose = $('btnUserMgmtClose');
    if(btnUserMgmtClose) btnUserMgmtClose.addEventListener('click', closeUserMgmtModal);
    const btnUserMgmtRefresh = $('btnUserMgmtRefresh');
    if(btnUserMgmtRefresh) btnUserMgmtRefresh.addEventListener('click', refreshUserMgmt);
    const userMgmtCompany = $('userMgmtCompany');
    if(userMgmtCompany && !userMgmtCompany._wired){
      userMgmtCompany._wired = true;
      userMgmtCompany.addEventListener('change', async (e)=>{
        _userMgmtCompanyId = e && e.target ? e.target.value : '';
        await refreshUserMgmt();
      });
    }
    const userMgmtList = $('userMgmtList');
    if(userMgmtList) userMgmtList.addEventListener('change', async (e)=>{
      const select = e.target.closest('[data-user-role-id]');
      if(!select) return;
      const userId = String(select.getAttribute('data-user-role-id') || '').trim();
      const currentRole = String(select.getAttribute('data-current-role') || '').trim();
      const nextRole = String(select.value || '').trim();
      if(!userId || !nextRole || nextRole === currentRole) return;
      const displayName = String(select.getAttribute('data-user-name') || 'user');
      const ok = await openConfirmModal(
        `Change role for ${displayName}?`,
        `This will set the role to ${nextRole}.`,
        { okText:'Update', cancelText:'Cancel' }
      );
      if(!ok){
        select.value = currentRole;
        return;
      }
      try{
        await sbUpdateMemberRole(userId, nextRole);
        toast('Role updated');
        await refreshUserMgmt();
      }catch(err){
        select.value = currentRole;
        toast(err && err.message ? err.message : 'Update failed');
      }
    });
    if(userMgmtList) userMgmtList.addEventListener('click', async (e)=>{
      const removeBtn = e.target.closest('[data-user-remove-id]');
      if(!removeBtn) return;
      if(removeBtn.disabled) return;
      const userId = String(removeBtn.getAttribute('data-user-remove-id') || '').trim();
      if(!userId) return;
      const displayName = String(removeBtn.getAttribute('data-user-name') || 'user');
      const ok = await openConfirmModal(
        `Remove ${displayName}?`,
        'This will revoke their access to the company.',
        { okText:'Remove', cancelText:'Cancel' }
      );
      if(!ok) return;
      try{
        await sbRemoveMember(userId);
        toast('User removed');
        await refreshUserMgmt();
      }catch(err){
        toast(err && err.message ? err.message : 'Remove failed');
      }
    });

    const profilePhoneInput = $('profilePhone');
    if(profilePhoneInput){
      profilePhoneInput.addEventListener('input', (e)=>{
        const cursorPos = e.target.selectionStart;
        const oldLen = e.target.value.length;
        e.target.value = formatPhoneNumber(e.target.value);
        const newLen = e.target.value.length;
        // Adjust cursor position after formatting
        const newPos = Math.max(0, cursorPos + (newLen - oldLen));
        e.target.setSelectionRange(newPos, newPos);
      });
    }

	    // Profile auto-save
    let _profileAutoSaveTimer = null;
    async function autoSaveProfile(){
      const modal = $('profileModal');
      if(!modal || modal.getAttribute('aria-hidden') === 'true') return;
      const firstName = $('profileFirstName')?.value || '';
      const lastName = $('profileLastName')?.value || '';
      const phone = $('profilePhone')?.value || '';
      const lowStockQtyGlobal = $('profileLowStockQtyGlobal')?.value || '';
      const silenceLowStockAlerts = !!($('profileSilenceLowStockAlerts')?.checked);
      setProfileMessage('');
      try{
        await sbSaveProfile(firstName, lastName, phone, silenceLowStockAlerts, lowStockQtyGlobal);
        renderProfileUi();
        try{ renderTable(); }catch(e){}
        toast('Auto-saved');
      }catch(e){
        setProfileMessage(e && e.message ? e.message : 'Save failed');
      }
    }
    function scheduleProfileAutoSave(){
      if(_profileAutoSaveTimer) clearTimeout(_profileAutoSaveTimer);
      _profileAutoSaveTimer = setTimeout(()=> autoSaveProfile(), 600);
    }
    // Attach auto-save listeners to profile inputs
    ['profileFirstName','profileLastName','profilePhone','profileLowStockQtyGlobal'].forEach(id=>{
      const el = $(id);
      if(el){
        el.addEventListener('blur', scheduleProfileAutoSave);
        el.addEventListener('change', scheduleProfileAutoSave);
      }
    });
    const profileSilenceToggle = $('profileSilenceLowStockAlerts');
    if(profileSilenceToggle) profileSilenceToggle.addEventListener('change', ()=> autoSaveProfile());

    const btnSignOut = $('btnSignOut');
    if(btnSignOut) btnSignOut.addEventListener('click', async ()=>{
      try{
        await sbSignOut();
        show('profileModal', false);
        toast('Signed out');
      }catch(e){
        toast(e && e.message ? e.message : 'Sign out failed');
      }
    });
		    async function sbLoadSnapshot(){
		      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
		      let data = null;
		      const baseSel = 'id,name,description,quantity,updated_at,deleted_at';
		
		      function buildSel(){
		        let sel = baseSel;
		        if(SB.itemsHasLowStockQty !== false) sel += ',low_stock_qty';
		        if(SB.itemsHasReorderEnabled !== false) sel += ',reorder_enabled';
		        return sel;
		      }
		
		      for(let attempt=0; attempt<3; attempt++){
		        const sel = buildSel();
		        const res = await SB.client
		          .from('inventory_items')
		          .select(sel)
		          .eq('company_id', SB.companyId)
		          .is('deleted_at', null)
		          .order('name', { ascending:true });
		        if(!res.error){
		          data = res.data;
		          if(sel.includes('low_stock_qty')) SB.itemsHasLowStockQty = true;
		          if(sel.includes('reorder_enabled')) SB.itemsHasReorderEnabled = true;
		          break;
		        }
		        const e = res.error;
		        const msg = errToText(e).toLowerCase();
		        let changed = false;
		
		        if(msg.includes('low_stock_qty')){
		          if(SB.itemsHasLowStockQty !== false) changed = true;
		          SB.itemsHasLowStockQty = false;
		          if(isSchemaCacheMissingColumnError(e, 'low_stock_qty') && !SB.warnedLowStockSchema){
		            SB.warnedLowStockSchema = true;
		            toast("Supabase needs schema reload for low stock (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing inventory_items.low_stock_qty. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		        if(msg.includes('reorder_enabled')){
		          if(SB.itemsHasReorderEnabled !== false) changed = true;
		          SB.itemsHasReorderEnabled = false;
		          if(isSchemaCacheMissingColumnError(e, 'reorder_enabled') && !SB.warnedReorderSchema){
		            SB.warnedReorderSchema = true;
		            toast("Supabase needs schema reload for reorder settings (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing inventory_items.reorder_enabled. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		
		        if(!changed){
		          console.warn('Supabase load error', e);
		          return;
		        }
		      }
		
		      if(data === null) return;
		      state.items = (data||[]).map(r => ({
		        id:r.id,
		        name:r.name||'',
		        desc:r.description||'',
		        qty:toInt(r.quantity,0),
		        lowStockQty: (r && Object.prototype.hasOwnProperty.call(r,'low_stock_qty') && r.low_stock_qty !== null) ? toInt(r.low_stock_qty,0) : null,
		        reorderEnabled: (r && Object.prototype.hasOwnProperty.call(r,'reorder_enabled')) ? !!r.reorder_enabled : true,
		        updatedAt:r.updated_at||null
		      }));
		      setUpdated(); render();
		    }
    let _sbChannel=null;
    function sbStartRealtime(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
      if(_sbChannel){ SB.client.removeChannel(_sbChannel); _sbChannel=null; }
      _sbChannel = SB.client.channel('inventory_items_all')
        .on('postgres_changes', {event:'*', schema:'public', table:'inventory_items', filter:`company_id=eq.${SB.companyId}`}, payload=>{
          const row = payload.new || payload.old;
          console.log('[realtime]', payload.eventType, row && row.id, row);
		          if(payload.eventType==='INSERT'){
		            if(row && row.deleted_at) return;
		            const i = state.items.findIndex(x=> x.id===row.id);
		            if(i===-1) state.items.push({
		              id:row.id,
		              name:row.name,
		              desc:row.description||'',
		              qty:toInt(row.quantity,0),
		              lowStockQty: (row && Object.prototype.hasOwnProperty.call(row,'low_stock_qty') && row.low_stock_qty !== null) ? toInt(row.low_stock_qty,0) : null,
		              reorderEnabled: (row && Object.prototype.hasOwnProperty.call(row,'reorder_enabled')) ? !!row.reorder_enabled : true,
		              updatedAt:row.updated_at
		            });
		          }else if(payload.eventType==='UPDATE'){
		            if(row && row.deleted_at){
		              state.items = state.items.filter(x=> x.id!==row.id);
		              setUpdated(); render();
		              return;
		            }
		            const it = state.items.find(x=> x.id===row.id);
		            if(it){
		              it.name=row.name;
		              it.desc=row.description||'';
		              it.qty=toInt(row.quantity,0);
		              if(Object.prototype.hasOwnProperty.call(row,'low_stock_qty')){
		                it.lowStockQty = (row.low_stock_qty === null) ? null : toInt(row.low_stock_qty,0);
		              }
		              if(Object.prototype.hasOwnProperty.call(row,'reorder_enabled')){
		                it.reorderEnabled = !!row.reorder_enabled;
		              }
		              it.updatedAt=row.updated_at;
		            }
		          }else if(payload.eventType==='DELETE'){
	            state.items = state.items.filter(x=> x.id!==row.id);
	          }
          setUpdated(); render();
        })
        .subscribe();
    }
    async function sbAddItem(name, desc, qty){
      if(!canCreate()) throw Error('Permission denied');
      if(!SB.companyId) throw Error('Company not selected');
      const id = randomUUID();
      const { error } = await SB.client.from('inventory_items').insert([{
        id,
        company_id: SB.companyId,
        name,
        description:desc||'',
        quantity: toInt(qty,0),
        reorder_enabled: true,
        created_by: SB.user ? SB.user.id : null,
      }]);
      if(error) throw error; return id;
    }
	    async function sbUpdateFields(id, fields){
	      if(!canUpdate()) throw Error('Permission denied');
	      if(!SB.companyId) throw Error('Company not selected');
	      const clean = {};
	      if('name' in fields) clean.name = String(fields.name||'');
	      if('desc' in fields) clean.description = String(fields.desc||'');
	      if('qty'  in fields) clean.quantity  = toInt(fields.qty,0);
	      if('reorderEnabled' in fields) clean.reorder_enabled = !!fields.reorderEnabled;
	      if('lowStockQty' in fields){
		        const raw = fields.lowStockQty;
		        if(raw === null || typeof raw === 'undefined' || String(raw).trim() === ''){
		          clean.low_stock_qty = null;
		        }else{
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Low stock qty must be integer ≥ 0');
	          clean.low_stock_qty = v;
	        }
	      }
	      const { error } = await SB.client
	        .from('inventory_items')
	        .update(clean)
	        .eq('id', id)
	        .eq('company_id', SB.companyId)
	        .is('deleted_at', null);
	      if(error) throw error;
	    }

	    async function sbFetchItemQtyMap(ids){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      const requested = Array.isArray(ids) ? ids.map(x=> String(x||'').trim()).filter(Boolean) : [];
	      const out = new Map();
	      if(!requested.length) return out;
	      const size = 200;
	      for(let i=0;i<requested.length;i+=size){
	        const chunk = requested.slice(i, i+size);
	        const { data, error } = await SB.client
	          .from('inventory_items')
	          .select('id,quantity')
	          .eq('company_id', SB.companyId)
	          .is('deleted_at', null)
	          .in('id', chunk);
	        if(error) throw error;
	        (Array.isArray(data) ? data : []).forEach(r=>{
	          if(r && r.id) out.set(String(r.id), toInt(r.quantity, 0));
	        });
	      }
	      return out;
	    }

	    async function sbUpdateItemQtyIfMatch(itemId, expectedQty, nextQty){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      if(!canUpdate()) throw new Error('Permission denied');
	      const id = String(itemId || '').trim();
	      if(!id) throw new Error('Invalid item ID');
	      const { data, error } = await SB.client
	        .from('inventory_items')
	        .update({ quantity: toInt(nextQty, 0) })
	        .eq('id', id)
	        .eq('company_id', SB.companyId)
	        .eq('quantity', toInt(expectedQty, 0))
	        .is('deleted_at', null)
	        .select('id');
	      if(error) throw error;
	      return Array.isArray(data) && data.length > 0;
	    }

	    function errToText(err){
	      if(!err) return '';
	      if(typeof err === 'string') return err;
	      const parts = [];
	      try{
	        if(err.message) parts.push(String(err.message));
	        if(err.details) parts.push(String(err.details));
	        if(err.hint) parts.push(String(err.hint));
	        if(err.code) parts.push(String(err.code));
	      }catch(e){}
	      return parts.join(' ');
	    }

	    function isSchemaCacheMissingColumnError(err, column){
	      const msg = errToText(err);
	      if(!msg) return false;
	      const lower = msg.toLowerCase();
	      if(!lower.includes('schema cache')) return false;
	      if(column && !lower.includes(String(column).toLowerCase())) return false;
	      return true;
	    }

	    function isPostgrestMissingColumnError(err, column){
	      const msg = errToText(err);
	      if(!msg) return false;
	      const lower = msg.toLowerCase();
	      if(column && !lower.includes(String(column).toLowerCase())) return false;
	      return lower.includes('schema cache') || (lower.includes('column') && lower.includes('does not exist'));
	    }

	    function isOrdersReceiptColumnsMissingError(err){
	      return [
	        'receiving_at','receiving_by','receiving_snapshot',
	        'received_at','received_by','received_snapshot',
	        'received_undone_at','received_undone_by',
	      ].some(c => isPostgrestMissingColumnError(err, c));
	    }
	
	    function showSchemaCacheReloadHelp(tableName, columnName){
	      const sql = "NOTIFY pgrst, 'reload schema';";
	      try{
	        if(navigator.clipboard && navigator.clipboard.writeText){
	          navigator.clipboard.writeText(sql)
	            .then(()=> toast('Copied schema reload SQL'))
	            .catch(()=>{});
	        }
	      }catch(e){}
	      openMsgModal(
	        'Supabase schema cache',
	        `Supabase is reporting “column not found in schema cache” for ${tableName}.${columnName}.\n\n`+
	          `This usually means PostgREST hasn’t reloaded its schema cache yet.\n\n`+
	          `Fix:\n`+
	          `1) Supabase Dashboard → SQL Editor\n`+
	          `2) Run:\n${sql}\n`+
	          `3) Refresh this page\n\n`+
	          `If it still fails, wait ~30 seconds and try again.`,
	        sql
	      );
	    }
	    async function sbDeleteMany(ids){
	      if(!canDelete()) throw Error('Permission denied');
	      if(!SB.companyId) throw Error('Company not selected');
	      const requested = Array.isArray(ids) ? ids.filter(Boolean) : [];
	      if(requested.length===0) return { deleted:0, requested:0 };
	      const { data, error } = await SB.client
	        .rpc('soft_delete_items', { p_item_ids: requested });
	      if (error) throw error;
	      if(data && data.success === false){
	        throw new Error(data.error || 'Delete failed');
	      }
      return { deleted: requested.length, requested: requested.length };
    }
    async function sbUpsertMany(rows){
      if(!canItemsImport()) throw Error('Permission denied');
      if(!SB.companyId) throw Error('Company not selected');
      const payload = (Array.isArray(rows) ? rows : [])
        .map(r => ({
          name: String(r && r.name ? r.name : '').trim(),
          desc: String(r && r.desc ? r.desc : '').trim(),
          qty: toInt(r && r.qty ? r.qty : 0, 0),
        }))
        .filter(r => r.name);
      if(!payload.length) throw Error('No valid rows to import');

      const { data, error } = await SB.client.rpc('bulk_upsert_inventory_items', {
        p_company_id: SB.companyId,
        p_items: payload,
      });
      if(error) throw error;
      if(data && data.success === false){
        throw new Error(data.error || 'Import failed');
      }
    }

    async function sbExportItems(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
      if(!canItemsExport()) throw new Error('Export permission required');
      const { data, error } = await SB.client.rpc('export_inventory_items', { p_company_id: SB.companyId });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }

    // ========================
    // Rendering & inline edit
    // ========================
    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function escapeHtmlAttr(s){
      return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function render(){
      renderTable();
      applySavedColumnWidths();
      renderKpis();
    }

function adjustTitleSize(){
  try{
    const h1=document.querySelector('header h1');
    if(!h1) return;
    const wrap=document.querySelector('.brandtext');
    if(!wrap) return;
    h1.style.whiteSpace='nowrap'; h1.style.maxWidth='100%';
    h1.style.fontSize='';
    const rootStyles = getComputedStyle(document.documentElement);
    let min = parseFloat(rootStyles.getPropertyValue('--title-min')) || 12;
    let max = parseFloat(rootStyles.getPropertyValue('--title-max')) || 56;
    let size=parseFloat(getComputedStyle(h1).fontSize)||32;
    const roomEl = stack || wrap;
    const room = Math.max(0, roomEl.getBoundingClientRect().width - 8);
    const fits = ()=> h1.scrollWidth <= room;
    if(!fits()){
      while(size>min && !fits()){ size-=1; h1.style.fontSize=size+'px'; }
    }else{
      while(size<max){ h1.style.fontSize=(size+1)+'px'; if(!fits()){ h1.style.fontSize=size+'px'; break; } size+=1; }
    }
  }catch(e){}
}

	function getSort(){
	  if(!state._sort) return {col:'name',dir:'asc'};
	  // Handle if array was saved (convert back to single)
	  if(Array.isArray(state._sort)) return state._sort[0] || {col:'name',dir:'asc'};
	  return {col:state._sort.col||'name', dir:state._sort.dir||'asc'};
	}
	function syncMobileSortSelect(){
	  const sel = $('mobileSort');
	  if(!sel) return;
	  const srt = getSort();
	  const key = `${srt.col}:${srt.dir}`;
	  const has = Array.from(sel.options || []).some(o => o.value === key);
	  if(has) sel.value = key;
	}
	function applySortIndicators(){
	  const srt = getSort();
	  document.querySelectorAll('#invTable thead th.sortable').forEach(th=>{
	    const col = th.getAttribute('data-col');
	    th.removeAttribute('aria-sort');
	    th.classList.remove('sorted-asc','sorted-desc');
	    if(col === srt.col){
	      const desc = (srt.dir === 'desc');
	      th.setAttribute('aria-sort', desc ? 'descending' : 'ascending');
	      th.classList.add(desc ? 'sorted-desc' : 'sorted-asc');
	    }
	  });
	  syncMobileSortSelect();
	}

	function toTime(v){
	  const t = Date.parse(String(v || ''));
	  return Number.isFinite(t) ? t : 0;
	}
	function sortItems(arr){
	  const srt = getSort();
	  const dir = srt.dir === 'desc' ? -1 : 1;
	  const col = srt.col || 'name';
	  return arr.sort((a,b)=>{
	    if(col === 'qty') return (toInt(a.qty,0) - toInt(b.qty,0)) * dir;
	    if(col === 'updatedAt') return (toTime(a.updatedAt) - toTime(b.updatedAt)) * dir;
	    const av = toKey(String((a && a[col])||''));
	    const bv = toKey(String((b && b[col])||''));
	    return av.localeCompare(bv) * dir;
	  });
	}

	const COL_WIDTH_MIN = 48;
	const COL_WIDTH_STORAGE_PREFIX = 'inv.colwidths.v1';

	function getColumnWidthStorageKey(){
	  const uid = (SB && SB.user && SB.user.id) ? String(SB.user.id) : 'anon';
	  return `${COL_WIDTH_STORAGE_PREFIX}.${uid}`;
	}
	function readSavedColumnWidths(){
	  try{
	    const raw = localStorage.getItem(getColumnWidthStorageKey());
	    if(!raw) return null;
	    const data = JSON.parse(raw);
	    if(!data || typeof data !== 'object') return null;
	    return data.widths ? data.widths : data;
	  }catch(e){ return null; }
	}
	function applySavedColumnWidths(){
	  try{
	    const table = document.getElementById('invTable');
	    if(!table) return;
	    const colgroup = table.querySelector('colgroup');
	    if(!colgroup) return;
	    const widths = readSavedColumnWidths();
	    if(!widths) return;
	    colgroup.querySelectorAll('col[id]').forEach(col=>{
	      const width = Math.round(parseFloat(widths[col.id]));
	      if(!Number.isFinite(width) || width < COL_WIDTH_MIN) return;
	      col.style.width = `${width}px`;
	      col.dataset.userWidth = '1';
	    });
	  }catch(e){}
	}
	function saveColumnWidths(){
	  try{
	    const table = document.getElementById('invTable');
	    if(!table) return;
	    const colgroup = table.querySelector('colgroup');
	    if(!colgroup) return;
	    const widths = {};
	    colgroup.querySelectorAll('col[id]').forEach(col=>{
	      if(col.dataset.userWidth !== '1') return;
	      const width = parseFloat(col.style.width);
	      if(Number.isFinite(width) && width > 0) widths[col.id] = Math.round(width);
	    });
	    if(!Object.keys(widths).length) return;
	    localStorage.setItem(getColumnWidthStorageKey(), JSON.stringify({
	      widths,
	      updatedAt: new Date().toISOString()
	    }));
	  }catch(e){}
	}


	function adjustDescColumnWidth(){
	  try{
	    const table = document.getElementById('invTable');
	    const colDesc = document.getElementById('col-desc');
	    if(!table || !colDesc) return;
	    const isMobile = isMobileUx();
	    if(isMobile){
	      colDesc.style.width = '';
	      table.querySelectorAll('td[data-col="desc"], th[data-col="desc"]').forEach(el=>{
	        el.style.whiteSpace='normal'; el.style.wordBreak='break-word'; el.style.hyphens='auto';
	      });
	      return;
	    }
    if(colDesc.dataset.userWidth === '1') return;
    const tb = table.querySelector('tbody');
    const cells = tb? Array.from(tb.querySelectorAll('td[data-col="desc"]')) : [];
    if(cells.length===0){ colDesc.style.width=''; return; }
    // Measure using hidden span with same font
    const sample = cells[0];
    const cs = window.getComputedStyle(sample);
    const meas = document.createElement('span');
    meas.style.position='absolute'; meas.style.visibility='hidden'; meas.style.whiteSpace='nowrap';
    meas.style.font = `${cs.fontWeight} ${cs.fontSize} ${cs.fontFamily}`;
    document.body.appendChild(meas);
    let max = 0;
    for(const td of cells){
      meas.textContent = td.textContent || '';
      const w = meas.getBoundingClientRect().width; if(w>max) max=w;
    }
    document.body.removeChild(meas);
	    const tableW = table.getBoundingClientRect().width;
	    const minW = 220; // ensure readable
	    const guard = 42 + 130 + 96 + 120; // sel + qty + actions + min name
	    const maxClamp = Math.max(160, tableW - guard);
	    const width = Math.min(Math.max(minW, Math.ceil(max+24)), Math.floor(tableW*0.7), maxClamp);
    colDesc.style.width = width + 'px';
    table.querySelectorAll('td[data-col="desc"], th[data-col="desc"]').forEach(el=>{
      el.style.whiteSpace='nowrap'; el.style.wordBreak='normal'; el.style.hyphens='manual';
    });
	  }catch(e){ /* no-op */ }
	}

	function autoFitColumnByIndex(index){
	  const table = document.getElementById('invTable');
	  if(!table) return;
	  const colgroup = table.querySelector('colgroup');
	  if(!colgroup) return;
	  const cols = Array.from(colgroup.children);
	  const col = cols[index];
	  if(!col) return;
	  const ths = Array.from(table.querySelectorAll('thead th'));
	  const th = ths[index];
	  let max = th ? th.scrollWidth : 0;
	  const cells = Array.from(table.querySelectorAll(`tbody tr td:nth-child(${index + 1})`));
	  for(const cell of cells){
	    max = Math.max(max, cell.scrollWidth);
	  }
	  const padding = 18;
	  const width = Math.max(COL_WIDTH_MIN, Math.ceil(max + padding));
	  col.style.width = `${width}px`;
	  col.dataset.userWidth = '1';
	  saveColumnWidths();
	}

	function getHeaderResizeTarget(e){
	  const th = e.target.closest('th');
	  if(!th) return null;
	  const thead = th.closest('thead');
	  if(!thead) return null;
	  const ths = Array.from(thead.querySelectorAll('th'));
	  const idx = ths.indexOf(th);
	  if(idx < 0) return null;
	  const rect = th.getBoundingClientRect();
	  const edge = 6;
	  const leftHit = e.clientX - rect.left;
	  const rightHit = rect.right - e.clientX;
	  let targetIdx = null;
	  if(rightHit >= 0 && rightHit <= edge) targetIdx = idx;
	  else if(leftHit >= 0 && leftHit <= edge) targetIdx = idx - 1;
	  if(targetIdx === null || targetIdx < 0) return null;
	  const targetTh = ths[targetIdx];
	  if(!targetTh || !targetTh.dataset.col) return null;
	  return { targetIdx, targetTh, ths, thead };
	}

	function handleHeaderAutoFit(e){
	  if(isMobileUx()) return;
	  const target = getHeaderResizeTarget(e);
	  if(!target) return;
	  autoFitColumnByIndex(target.targetIdx);
	}

	function updateHeaderResizeCursor(e){
	  if(_headerResize) return;
	  if(isMobileUx()) return;
	  const target = getHeaderResizeTarget(e);
	  const th = e.target.closest('th');
	  if(!th) return;
	  const thead = th.closest('thead');
	  if(!thead) return;
	  thead.querySelectorAll('th').forEach(t => t.classList.remove('col-resize-hot'));
	  if(!target) return;
	  target.targetTh.classList.add('col-resize-hot');
	}

	let _headerResize = null;
	function ensureResizeGuide(){
	  const tableWrap = document.getElementById('tableWrap');
	  if(!tableWrap) return null;
	  let guide = tableWrap.querySelector('.col-resize-guide');
	  if(!guide){
	    guide = document.createElement('div');
	    guide.className = 'col-resize-guide';
	    tableWrap.appendChild(guide);
	  }
	  return guide;
	}
	function startHeaderResize(e){
	  if(isMobileUx()) return;
	  if(e.button !== 0) return;
	  const target = getHeaderResizeTarget(e);
	  if(!target) return;
	  const table = document.getElementById('invTable');
	  const colgroup = table ? table.querySelector('colgroup') : null;
	  if(!table || !colgroup) return;
	  const cols = Array.from(colgroup.children);
	  const col = cols[target.targetIdx];
	  if(!col) return;
	  const tableWrap = document.getElementById('tableWrap');
	  if(!tableWrap) return;
	  const guide = ensureResizeGuide();
	  if(!guide) return;

	  const targetRect = target.targetTh.getBoundingClientRect();
	  const wrapRect = tableWrap.getBoundingClientRect();
	  const startX = targetRect.right;
	  const startWidth = target.targetTh.getBoundingClientRect().width;
	  const minWidth = COL_WIDTH_MIN;
	  const maxWidth = Math.max(minWidth, tableWrap.clientWidth * 2);

	  _headerResize = {
	    col,
	    startX,
	    startWidth,
	    minWidth,
	    maxWidth,
	    guide,
	    wrapRect,
	    tableWrap,
	    lastWidth: startWidth,
	  };

	  const left = (startX - wrapRect.left) + tableWrap.scrollLeft;
	  guide.style.left = `${Math.max(0, left)}px`;
	  guide.style.display = 'block';
	  document.body.classList.add('col-resize-active');
	  e.preventDefault();
	  e.stopPropagation();
	  window.addEventListener('mousemove', onHeaderResizeMove);
	  window.addEventListener('mouseup', onHeaderResizeUp);
	}
	function onHeaderResizeMove(e){
	  if(!_headerResize) return;
	  const st = _headerResize;
	  const delta = e.clientX - st.startX;
	  const width = Math.round(Math.min(st.maxWidth, Math.max(st.minWidth, st.startWidth + delta)));
	  st.lastWidth = width;
	  st.col.style.width = `${width}px`;
	  const left = (e.clientX - st.wrapRect.left) + st.tableWrap.scrollLeft;
	  st.guide.style.left = `${Math.max(0, left)}px`;
	}
	function onHeaderResizeUp(){
	  if(!_headerResize) return;
	  const st = _headerResize;
	  const width = Math.round(Math.min(st.maxWidth, Math.max(st.minWidth, st.lastWidth || st.startWidth)));
	  st.col.style.width = `${width}px`;
	  st.col.dataset.userWidth = '1';
	  st.guide.style.display = 'none';
	  document.body.classList.remove('col-resize-active');
	  window.removeEventListener('mousemove', onHeaderResizeMove);
	  window.removeEventListener('mouseup', onHeaderResizeUp);
	  _headerResize = null;
	  saveColumnWidths();
	}

		function isMobileUx(){
		  try{
		    if(!window.matchMedia) return false;
		    return window.matchMedia('(pointer: coarse)').matches;
		  }catch(e){ return false; }
		}
		function isMobileStacked(){ return isMobileUx(); }

	    function renderKpis(){
	      const el=$('lastUpdate');
	      if(!el) return;
	      el.textContent = state.updatedAt? `Last Update: ${new Date(state.updatedAt).toLocaleString(undefined,{hour12:true})}` : '';
      const fb=$('filterBox'); if(fb) fb.value = state._filter || '';
          }

    // -------- Partial-optimistic DOM helpers --------
	function tbodyEl(){ return document.querySelector('#invTable tbody'); }
	function rowElById(id){ return tbodyEl()?.querySelector(`tr[data-id="${id}"]`) || null; }
		function cellEl(tr, col){ return tr?.querySelector(`td[data-col="${col}"]`) || null; }
		function getSelectedRowIds(){
		  return Array.from(document.querySelectorAll('.rowChk:checked'))
		    .map(cb => String(cb.dataset.id || '').trim())
		    .filter(Boolean);
		}
		function applySelectedRowIds(ids){
		  const set = new Set((ids || []).map(id => String(id || '').trim()).filter(Boolean));
		  document.querySelectorAll('.rowChk').forEach(cb => {
		    const id = String(cb.dataset.id || '').trim();
		    cb.checked = set.has(id);
		  });
		  const all = document.querySelectorAll('.rowChk');
		  const checked = document.querySelectorAll('.rowChk:checked');
		  const m = $('chkAll');
		  if(m){
		    m.checked = (checked.length === all.length && all.length > 0);
		    m.indeterminate = (checked.length > 0 && checked.length < all.length);
		  }
		}
		function normalizeDescValue(value){
		  return String(value || '').replace(/[\r\n]+/g,' ').trim();
		}
		function truncateForConfirm(value, max = 60){
		  const txt = String(value || '');
		  if(!txt) return '(blank)';
		  return txt.length > max ? `${txt.slice(0, max - 1)}…` : txt;
		}
			let _openTrayId = '';
			let _expandedCardId = '';
			const REVEAL_PX = 48; // icons begin appearing
			const TRAY_BTN_W = 86; // keep in sync with .card-tray-btn width
			const TRAY_SNAP_PAD = 20; // extra reveal beyond icons
			const COMMIT_PX = 210; // auto-trigger action (edit/order)
			const MAX_PX = 336; // elastic clamp

			function traySideFromSwipeX(x){
			  return (Number(x) || 0) < 0 ? 'right' : 'left';
			}
				function trayIconCountForSide(side){
				  return 1;
				}
			function traySnapPxForSide(side){
			  const iconCount = trayIconCountForSide(side);
			  return (iconCount * TRAY_BTN_W) + TRAY_SNAP_PAD;
			}

		function collapseExpandedCard(){
		  if(!_expandedCardId) return;
		  const tr = rowElById(_expandedCardId);
		  if(tr) tr.classList.remove('card-expanded');
		  _expandedCardId = '';
		}
		function expandCard(id){
		  const nextId = String(id || '').trim();
		  if(!nextId) return;
		  if(_expandedCardId === nextId) return;
		  collapseExpandedCard();
		  const tr = rowElById(nextId);
		  if(!tr) return;
		  tr.classList.add('card-expanded');
		  _expandedCardId = nextId;
		}
		function toggleExpandedCard(id){
		  const nextId = String(id || '').trim();
		  if(!nextId) return;
		  if(_expandedCardId === nextId) collapseExpandedCard();
		  else expandCard(nextId);
		}
	function clampNum(v, min, max){
	  return Math.max(min, Math.min(max, v));
	}
		function trayProgressForSwipeX(x){
		  const ax = Math.abs(Number(x) || 0);
		  const side = traySideFromSwipeX(x);
		  const snapPx = traySnapPxForSide(side);
		  if(ax <= REVEAL_PX) return 0;
		  return clampNum((ax - REVEAL_PX) / Math.max(1, (snapPx - REVEAL_PX)), 0, 1);
		}
	function getRowSwipeX(tr){
	  if(!tr || !tr.style) return 0;
	  const raw = String(tr.style.getPropertyValue('--swipe-x') || '').trim();
	  const n = Number.parseFloat(raw);
	  return Number.isFinite(n) ? n : 0;
	}
		function setRowSwipeX(tr, x){
		  if(!tr || !tr.style) return;
		  const v = clampNum(Number(x) || 0, -MAX_PX, MAX_PX);
		  const ax = Math.abs(v);
		  const side = traySideFromSwipeX(v);
		  const snapPx = traySnapPxForSide(side);
		  const outer = trayProgressForSwipeX(v);
		  let inner = 0;
		  if(trayIconCountForSide(side) > 1){
		    const innerRevealPx = Math.round((REVEAL_PX + snapPx) / 2);
		    inner = (ax <= innerRevealPx) ? 0 : clampNum((ax - innerRevealPx) / Math.max(1, (snapPx - innerRevealPx)), 0, 1);
		  }
		  const commitDen = Math.max(1, (COMMIT_PX - snapPx));
		  const commitProgress = (ax <= snapPx) ? 0 : clampNum((ax - snapPx) / commitDen, 0, 1);
		  tr.style.setProperty('--swipe-x', `${v}px`);
		  tr.style.setProperty('--tray-progress', String(outer));
		  tr.style.setProperty('--tray-outer', String(outer));
			  tr.style.setProperty('--tray-inner', String(inner));
			  tr.style.setProperty('--commit-progress', String(commitProgress));
			  const traySide = (tr && tr.dataset) ? String(tr.dataset.traySide || '') : '';
			  const commitArmed = (!!traySide) && (Math.abs(v) >= COMMIT_PX);
			  tr.classList.toggle('commit-armed', commitArmed);
			}
		function traySideToSwipeX(side){
		  const s = (side === 'left') ? 'left' : 'right';
		  const snapPx = traySnapPxForSide(s);
		  return (s === 'left') ? snapPx : -snapPx;
		}
	function setMobileTrayA11y(tr, open){
	  const tray = tr ? tr.querySelector('.card-tray') : null;
	  if(!tray) return;
	  tray.setAttribute('aria-hidden', open ? 'false' : 'true');
	  tray.querySelectorAll('button.card-tray-btn').forEach(btn=>{
	    if(open) btn.removeAttribute('tabindex');
	    else btn.setAttribute('tabindex', '-1');
	  });
	}
	function closeMobileTray(){
	  if(!_openTrayId) return;
	  const tr = rowElById(_openTrayId);
	  if(tr){
	    tr.classList.remove('swiping');
	    tr.classList.remove('tray-peek');
	    tr.classList.remove('tray-open');
	    setRowSwipeX(tr, 0);
	    try{ delete tr.dataset.traySide; }catch(e){ tr.dataset.traySide = ''; }
	    setMobileTrayA11y(tr, false);
	  }
	  _openTrayId = '';
	}
		function closeMobileTrayElastic(targetTr){
		  const tr = targetTr || (_openTrayId ? rowElById(_openTrayId) : null);
		  if(tr){
		    tr.classList.remove('swiping');
		    tr.classList.remove('tray-peek');
		    tr.classList.remove('tray-open');
		    tr.classList.add('snap-elastic');
		    setRowSwipeX(tr, 0);
		    try{ delete tr.dataset.traySide; }catch(e){ tr.dataset.traySide = ''; }
		    setMobileTrayA11y(tr, false);
		    // Remove elastic class after animation completes
		    setTimeout(()=>{ try{ tr.classList.remove('snap-elastic'); }catch(e){} }, 400);
		  }
		  _openTrayId = '';
		}
			function trayActionsHTML(){
			  if(!canUpdate()) return '';
			  return ''+
			    '<button type="button" class="card-tray-btn" data-tray-action="edit" tabindex="-1" aria-label="Edit item" title="Edit item">'+
			      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
			        '<path d="M12 20h9"></path>'+
			        '<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>'+
			      '</svg>'+
			    '</button>';
			}
		function trayOrderHTML(){
		  if(!canOrdersCreate()) return '';
		  return ''+
		    '<button type="button" class="card-tray-btn" data-tray-action="order" tabindex="-1" aria-label="Add to order" title="Add to order">'+
		      '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
		        '<circle cx="9" cy="21" r="1"></circle>'+
		        '<circle cx="20" cy="21" r="1"></circle>'+
		        '<path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>'+
		        '<polyline class="order-check" points="9 11 12 14 16 10"></polyline>'+
		      '</svg>'+
		    '</button>';
		}
		function updateOrderTrayButtonLabel(tr){
		  const btn = tr ? tr.querySelector('button.card-tray-btn[data-tray-action="order"]') : null;
		  if(!btn) return;
		  const inOrder = !!(tr && tr.classList && tr.classList.contains('order-selected'));
		  const label = inOrder ? 'Remove from order' : 'Add to order';
		  btn.setAttribute('aria-label', label);
		  btn.setAttribute('title', label);
		}
		function ensureMobileTrayContent(tr, side){
		  const tray = tr ? tr.querySelector('.card-tray') : null;
		  if(!tray) return;
		  const kind = (side === 'left') ? 'order' : 'actions';
		  const prior = tray.dataset ? String(tray.dataset.kind || '') : '';
		  if(prior === kind) return;
		  if(tray.dataset) tray.dataset.kind = kind;
		  tray.innerHTML = (kind === 'order') ? trayOrderHTML() : trayActionsHTML();
		  try{
		    tray.querySelectorAll('button.card-tray-btn').forEach(btn=> btn.setAttribute('tabindex', '-1'));
		  }catch(e){}
		  updateOrderTrayButtonLabel(tr);
		}
		function prepareMobileTrayForRow(tr, side){
		  if(!tr) return;
		  const id = String(tr.dataset && tr.dataset.id ? tr.dataset.id : '').trim();
		  if(!id) return;
		  if(_openTrayId && _openTrayId !== id) closeMobileTray();
		  _openTrayId = id;
		  tr.dataset.traySide = (side === 'left') ? 'left' : 'right';
		  ensureMobileTrayContent(tr, tr.dataset.traySide);
		  tr.classList.remove('tray-open');
		  tr.classList.add('tray-peek');
		  setMobileTrayA11y(tr, false);
		}
		function openMobileTrayForRow(tr, side){
		  if(!tr) return;
		  const id = String(tr.dataset && tr.dataset.id ? tr.dataset.id : '').trim();
		  if(!id) return;
		  if(_openTrayId && _openTrayId !== id) closeMobileTray();
		  _openTrayId = id;
		  tr.dataset.traySide = (side === 'left') ? 'left' : 'right';
		  ensureMobileTrayContent(tr, tr.dataset.traySide);
		  tr.classList.remove('tray-peek');
		  tr.classList.add('tray-open');
		  setMobileTrayA11y(tr, true);
		  const targetX = traySideToSwipeX(tr.dataset.traySide);
		  try{ requestAnimationFrame(()=> setRowSwipeX(tr, targetX)); }catch(e){ setRowSwipeX(tr, targetX); }
		}
		function syncOrderIndicatorForRow(id){
		  const tr = rowElById(id);
		  if(!tr) return;
		  let inOrder = false;
		  try{
		    const ord = orderState();
		    inOrder = !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && l.id === id));
		  }catch(e){}
		  const orderBtn = tr.querySelector('.row-order-btn');
		  if(orderBtn){
		    orderBtn.classList.toggle('row-order-btn--active', inOrder);
		    orderBtn.setAttribute('aria-pressed', inOrder ? 'true' : 'false');
		    const label = inOrder ? 'Remove from order' : 'Add to order';
		    orderBtn.setAttribute('aria-label', label);
		    orderBtn.setAttribute('title', label);
		  }
		  tr.classList.toggle('order-selected', inOrder);
		  updateOrderTrayButtonLabel(tr);
		}
		function toggleOrderLineForItemId(id){
		  const itemId = String(id || '').trim();
		  if(!itemId) return;
		  if(!canOrdersCreate()) return;
		  const item = state.items.find(x => x && x.id === itemId);
		  if(!item) return;
		  let exists = false;
		  try{
		    const ord = orderState();
		    exists = !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && l.id === itemId));
		  }catch(e){ exists = false; }
		  if(exists) removeOrderLine(itemId);
		  else upsertOrderLineFromItem(item, 1);
		}
		function syncLowStockOverrideIndicatorForRow(id){
		  const tr = rowElById(id);
		  if(!tr) return;
		  const item = state.items.find(x => x && x.id === id);
	  if(!item) return;
	  const hasLowStockOverride = getItemLowStockQtyOverride(item) !== null;

	  const btn = tr.querySelector('.row-stock-btn');
	  if(btn){
	    btn.classList.toggle('has-override', hasLowStockOverride);
	    const lowStockBtnLabel = hasLowStockOverride ? 'Set low stock qty (override)' : 'Set low stock qty';
	    btn.setAttribute('aria-label', lowStockBtnLabel);
	    btn.setAttribute('title', lowStockBtnLabel);
	  }
	}
	function syncLowStockIndicatorForRowNow(id){
	  const tr = rowElById(id);
	  if(!tr) return;
	  const item = state.items.find(x => x && x.id === id);
	  if(!item) return;
	  const silenced = lowStockAlertsSilenced();
	  const qty = toInt(item.qty, 0);
	  const isLowStock = !silenced && isLowStockItem(item);
	  const isOutOfStock = isLowStock && qty === 0;
	  const isLowButInStock = isLowStock && qty > 0;
	  const led = tr.querySelector('.card-led--lowstock');
	  if(led){
	    led.classList.toggle('card-led--outofstock', isOutOfStock);
	    led.classList.toggle('card-led--on', isLowButInStock);
	  }
	}
	// Debounced version - waits for user to stop clicking before updating LED
	function syncLowStockIndicatorForRow(id){
	  const existing = _qtyLedSync.get(id);
	  if(existing) clearTimeout(existing);
	  _qtyLedSync.set(id, setTimeout(()=> {
	    _qtyLedSync.delete(id);
	    syncLowStockIndicatorForRowNow(id);
	  }, 300));
	}
		function qtyCellHTML(it){
		  const q = toInt(it.qty,0);
		  const id = escapeHtmlAttr(it.id || '');
		  if(!canUpdate()){
		    return (
		      '<div class="qty-stepper qty-stepper--table qty-stepper--readonly" aria-label="Qty">'+
		        '<span class="qty-value" aria-label="Qty">'+q+'</span>'+
		      '</div>'
		    );
		  }
		  return (
		    '<div class="qty-stepper qty-stepper--table" aria-label="Qty controls">'+
		      '<button type="button" class="qty-step qty-step-btn" data-id="'+id+'" data-delta="-1" aria-label="Decrease qty">−</button>'+
		      '<span class="qty-value" aria-label="Qty">'+q+'</span>'+
		      '<button type="button" class="qty-step qty-step-btn" data-id="'+id+'" data-delta="1" aria-label="Increase qty">+</button>'+
		    '</div>'
		  );
		}
				function buildRowHTML(it){
				  const rawId = String(it && it.id ? it.id : '');
				  const id = escapeHtmlAttr(rawId);
				  const allowSelect = canItemsCreate() || canItemsEdit() || canItemsDelete();
				  const canEdit = canItemsEdit();
				  const canRemove = canItemsDelete();
				  const canOrder = canOrdersCreate();
				  const isLowStock = isLowStockItem(it);
			  const inOrder = (()=> {
			    try{
			      const ord = orderState();
			      return !!(ord && Array.isArray(ord.lines) && rawId && ord.lines.some(l => l && l.id === rawId));
			    }catch(e){ return false; }
			  })();
			  const showLowStockLed = isLowStock && !lowStockAlertsSilenced();
			  const qty = toInt(it.qty, 0);
			  const isOutOfStock = showLowStockLed && qty === 0;
			  const isLowButInStock = showLowStockLed && qty > 0;
			  const lowstockLedClass = isOutOfStock ? 'card-led card-led--lowstock card-led--outofstock' : (isLowButInStock ? 'card-led card-led--lowstock card-led--on' : 'card-led card-led--lowstock');
			  const orderBtnClass = inOrder ? 'row-order-btn row-order-btn--active' : 'row-order-btn';
			  const orderBtnLabel = inOrder ? 'Remove from order' : 'Add to order';
			  const orderBtnDisabled = canOrder ? '' : ' disabled aria-disabled="true"';
			  const deleteBtnDisabled = canRemove ? '' : ' disabled aria-disabled="true"';
			  return (
			    '<td class="sel"><input type="checkbox" class="rowChk" data-id="'+id+'"'+(allowSelect ? '' : ' disabled')+'></td>'+
				    '<td data-col="name">'+
				      '<div class="card-leds" aria-hidden="true">'+
				        '<span class="'+lowstockLedClass+'"></span>'+
					      '</div>'+
					      '<div class="card-tray" aria-hidden="true" data-kind="actions">'+
				        (canEdit ? (
				          '<button type="button" class="card-tray-btn" data-tray-action="edit" tabindex="-1" aria-label="Edit item" title="Edit item">'+
				            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
				              '<path d="M12 20h9"></path>'+
				              '<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>'+
				            '</svg>'+
				          '</button>'
				        ) : '')+
			      '</div>'+
			      '<span class="cell-val">'+escapeHtml(it.name||'')+'</span>'+
			    '</td>'+
				    '<td data-col="desc"><span class="cell-val">'+escapeHtml(it.desc||'')+'</span></td>'+
					    '<td data-col="qty" class="qty">'+qtyCellHTML(it)+'</td>'+
					    '<td class="actions"><div class="actions-wrap">'+
				      '<button class="'+orderBtnClass+'" data-id="'+id+'" aria-label="'+orderBtnLabel+'" title="'+orderBtnLabel+'" aria-pressed="'+(inOrder ? 'true' : 'false')+'"'+orderBtnDisabled+'>'+
				        '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
				          '<circle cx="9" cy="20" r="1"></circle>'+
				          '<circle cx="18" cy="20" r="1"></circle>'+
				          '<path d="M3 4h2l2.4 12.4a2 2 0 0 0 2 1.6h7.2a2 2 0 0 0 2-1.6L21 8H7"></path>'+
				        '</svg>'+
				      '</button>'+
				      '<button class="row-delete-btn" data-id="'+id+'" aria-label="Delete item" title="Delete item"'+deleteBtnDisabled+'>'+
			        '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
			          '<polyline points="3 6 5 6 21 6"></polyline>'+
			          '<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>'+
		        '</svg>'+
			      '</button>'+
			    '</div></td>'
			  );
			}
// Insert a row into the table in sorted position by name
function insertRowSorted(it){
  const tb = tbodyEl(); if(!tb) return;
  const empty = tb.querySelector('tr[data-empty="1"]'); if(empty) empty.remove();
  const trs = Array.from(tb.querySelectorAll('tr[data-id]'));
  const k = toKey(it.name);
  let anchor = null;
  for(const tr of trs){
    const nm = tr.querySelector('td[data-col="name"]')?.textContent || '';
    if(toKey(nm) > k){ anchor = tr; break; }
  }
  const tr = document.createElement('tr');
  tr.dataset.id = it.id;
  tr.innerHTML = buildRowHTML(it);
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing(); // attach listeners to the new row
}
// Reposition existing row if its name changed
function repositionRowByName(id){
  const tb = tbodyEl(); if(!tb) return;
  const tr = rowElById(id); if(!tr) return;
  const it = state.items.find(x=> x.id===id); if(!it) return;
  tr.innerHTML = buildRowHTML(it); // refresh cells
  const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
  const k = toKey(it.name);
  let anchor = null;
  for(const r of others){
    const nm = r.querySelector('td[data-col="name"]')?.textContent || '';
    if(toKey(nm) > k){ anchor = r; break; }
  }
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing();
}
// Update just one cell
	function updateCellDisplay(id, col, value){
	  const tr = rowElById(id); if(!tr) return;
	  const td = cellEl(tr, col); if(!td) return;
		  if(col==='qty'){
		    const v = String(toInt(value,0));
		    const el = td.querySelector('.qty-value');
		    if(el) el.textContent = v;
		    else td.textContent = v;
		    return;
		  }
	  td.textContent = String(value||'');
	}

function updateFilterClearBtn(){
  const fb = $('filterBox');
  const btn = $('btnClearFilter');
  if(!fb || !btn) return;
  const has = String(fb.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderSearchClearBtn(){
  const inp = $('orderSearch');
  const btn = $('btnClearOrderSearch');
  if(!inp || !btn) return;
  const has = String(inp.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderHistoryFilterClearBtn(){
  const inp = $('orderHistoryFilter');
  const btn = $('btnClearOrderHistoryFilter');
  if(!inp || !btn) return;
  const has = String(inp.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}
// Ensure an empty-state row exists when there are no data rows
function emptyStateHtml(){
  const gate = explainGate();
  if(!gate){
    return 'No items yet. Use <b>Import File</b> or <b>Paste Data</b> above, or <b>Add Item</b> to create one.';
  }
  if(gate === 'Sign in required'){
    return 'Sign in to view your inventory. Tap the status bar above.';
  }
  if(gate === 'No company access'){
    return 'No company access yet. Tap the status bar above for account details.';
  }
  if(gate === 'Permission denied'){
    return 'Your role does not allow inventory access. Tap the status bar above for account details.';
  }
  if(gate === 'Not authorized'){
    return 'Not authorized for this inventory. Tap the status bar above for account details.';
  }
  if(gate.startsWith('Offline')){
    return 'Offline. Connect to load your inventory.';
  }
  return escapeHtml(gate);
}
	function ensureEmptyState(){
	  const tb = tbodyEl(); if(!tb) return;
	  const hasRows = tb.querySelector('tr[data-id]') !== null;
	  const existingEmpty = tb.querySelector('tr[data-empty="1"]');
	  if(!hasRows && !existingEmpty){
	    const tr=document.createElement('tr'); tr.setAttribute('data-empty','1');
	    tr.innerHTML = '<td colspan="4" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
	    tb.appendChild(tr);
	  } else if(hasRows && existingEmpty){
	    existingEmpty.remove();
	  }
	}

	function isCompactTotals(){
	  try{ return window.matchMedia && window.matchMedia('(max-width:520px)').matches; }catch(e){ return false; }
	}
	function totalsLabel(key){
	  const compact = isCompactTotals();
	  if(key === 'items') return compact ? 'Items' : 'Total Items';
	  if(key === 'inStock') return compact ? 'Stock' : 'In Stock';
	  if(key === 'lowStock') return compact ? 'Low' : 'Low Stock';
	  if(key === 'qty') return compact ? 'Qty' : 'Total Qty';
	  return String(key || '');
	}
	function getTotalsValue(elId){
	  const el = $(elId);
	  if(!el) return null;
	  const dv = el.dataset ? String(el.dataset.value || '').trim() : '';
	  if(dv){
	    const v = Number(dv);
	    if(Number.isFinite(v)) return Math.trunc(v);
	  }
	  const m = /:\s*(\d+)/.exec(el.textContent || '');
	  if(!m) return null;
	  return toInt(m[1], 0);
	}
	function setTotalsMetric(elId, key, value){
	  const el = $(elId);
	  if(!el) return;
	  const v = Math.max(0, toInt(value,0));
	  if(el.dataset) el.dataset.value = String(v);
	  el.textContent = `${totalsLabel(key)}: ${v}`;
	}
	function refreshTotalsLabels(){
	  const vItems = getTotalsValue('totalItems'); if(vItems !== null) setTotalsMetric('totalItems','items', vItems);
	  const vStock = getTotalsValue('totalInStock'); if(vStock !== null) setTotalsMetric('totalInStock','inStock', vStock);
	  const vLow = getTotalsValue('totalLowStock'); if(vLow !== null) setTotalsMetric('totalLowStock','lowStock', vLow);
	  const vQty = getTotalsValue('totalQty'); if(vQty !== null) setTotalsMetric('totalQty','qty', vQty);
	}
		    function renderTable(){
		      try{ closeMobileTray(); }catch(e){}
		      applySortIndicators();
		      const tbody=$('#invTable').querySelector('tbody'); tbody.innerHTML='';
		      const term=(state._filter||'').trim().toLowerCase();

      let items=sortItems([...state.items]);
      if(term){
        items = items.filter(it=>{
          const name=(it.name||'').toLowerCase();
          const desc=(it.desc||'').toLowerCase();
          const qty = String(toInt(it.qty,0));
          return name.includes(term) || desc.includes(term) || qty.includes(term);
        });
      }
		      const totalQty = items.reduce((sum, it) => sum + toInt(it.qty,0), 0);
		      const totalItems = items.length;
		      const inStock = items.reduce((count, it) => count + (toInt(it.qty,0) > 0 ? 1 : 0), 0);
		      const lowStock = items.reduce((count, it) => count + (isLowStockItem(it) ? 1 : 0), 0);
		      setTotalsMetric('totalQty', 'qty', totalQty);
		      setTotalsMetric('totalItems', 'items', totalItems);
		      setTotalsMetric('totalInStock', 'inStock', inStock);
		      setTotalsMetric('totalLowStock', 'lowStock', lowStock);
		      if(items.length===0){
	      const tr=document.createElement('tr');
	      tr.innerHTML = '<td colspan="5" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
	      tbody.appendChild(tr);
      return;
      }
				      for(const it of items){
				        const tr=document.createElement('tr'); tr.dataset.id=it.id;
				        const inOrder = (()=> { try{ const ord = orderState(); return !!(ord && Array.isArray(ord.lines) && it.id && ord.lines.some(l => l && l.id === it.id)); }catch(e){ return false; } })();
				        if(inOrder) tr.classList.add('order-selected');
				        if(_expandedCardId && String(it.id) === String(_expandedCardId)) tr.classList.add('card-expanded');
				        tr.innerHTML = buildRowHTML(it);
				        tbody.appendChild(tr);
				      }
	      enableInlineEditing();
	      try{ requestAnimationFrame(()=>{ adjustDescColumnWidth(); adjustTitleSize(); }); }catch(e){}
	    }

    function enableInlineEditing(){
      if(isMobileUx()) return;
      if(!canUpdate()) return;
      const tbody=$('#invTable').querySelector('tbody');
      tbody.querySelectorAll('td').forEach(td=>{
        if(td.classList.contains('sel')) return; // skip checkbox column
        td.addEventListener('click', (e)=> startCellEdit(td, e));
        td.addEventListener('dblclick', (e)=> startCellEdit(td, e));
      });
    }

    // Mobile-friendly modal editor (helps iOS cursor/precision issues)
    let _editItemCtx = null;
    let _lastEditHintPref = null;
    const _qtyCommit = new Map(); // id -> { timer, desiredQty, inFlight }
    const _qtyReposition = new Map(); // id -> timer for debounced row repositioning
    const _qtyLedSync = new Map(); // id -> timer for debounced low stock LED sync

    function isIOS(){
      try{
        const ua = navigator.userAgent || '';
        const platform = navigator.platform || '';
        return /iPad|iPhone|iPod/.test(ua) || (platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }catch(e){ return false; }
    }
    function prefersModalEditing(){
      try{
        if(isIOS()) return true;
        const hasTouch = ('ontouchstart' in window) || (navigator && navigator.maxTouchPoints > 0);
        if(!hasTouch) return false;
        return window.matchMedia && (
          window.matchMedia('(pointer: coarse)').matches ||
          window.matchMedia('(hover: none)').matches ||
          window.matchMedia('(max-width: 768px)').matches
        );
      }catch(e){ return false; }
    }
	    function setEditHint(){
	      const el = $('editHint');
	      if(!el) return;
	      if(SB.session && SB.authorized && !canUpdate()){
	        el.textContent = 'Read-only access.';
	        _lastEditHintPref = 'readonly';
	        return;
	      }
	      const mobileUx = isMobileUx();
	      const pref = prefersModalEditing();
	      const mode = mobileUx ? 'mobile' : (pref ? 'modal' : 'inline');
	      if(mode === 'mobile'){
	        el.innerHTML = '';
	      }else if(mode === 'modal'){
	        el.innerHTML = 'Tap any cell to edit. Changes auto-save.';
	      }else{
	        el.innerHTML = 'Tap any cell to edit inline; <kbd>Enter</kbd> confirms, <kbd>Esc</kbd> cancels.';
	      }
	      if(_lastEditHintPref !== null && mode !== _lastEditHintPref){
	        try{ renderTable(); }catch(e){}
	      }
	      _lastEditHintPref = mode;
	    }

    function setEditItemMessage(msg){
      const el = $('editItemMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function closeEditItemModal(){
      _editItemCtx = null;
      setEditItemMessage('');
      show('editItemModal', false);
    }
	    function openEditItemModal(id){
	      if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
	      const it = state.items.find(x=> x.id===id); if(!it) return;
	      _editItemCtx = { id };

	      const name = $('editItemName'); if(name) name.value = String(it.name||'');
	      const desc = $('editItemDesc'); if(desc) desc.value = String(it.desc||'');
		      const qty  = $('editItemQty');  if(qty)  qty.value  = String(toInt(it.qty,0));
		      const globalLowStock = getGlobalLowStockQty();
		      const lowStockOverride = getItemLowStockQtyOverride(it);
		      const lowStockQty = $('editLowStockQty');
		      if(lowStockQty) lowStockQty.value = (lowStockOverride === null) ? '' : String(lowStockOverride);
		      const btnUseGlobal = $('btnEditUseGlobal');
		      if(btnUseGlobal) btnUseGlobal.textContent = `Use Global (${globalLowStock})`;
		      const reorderEnabled = $('editReorderEnabled');
		      if(reorderEnabled) reorderEnabled.checked = getItemReorderEnabled(it);

	      setEditItemMessage('');
	      show('editItemModal', true);
	      setTimeout(()=>{
	        const inp = $('editItemName');
        if(!inp) return;
        inp.focus();
        try{ inp.select(); }catch(e){}
      }, 0);
    }
	    function bumpEditItemQty(delta){
	      const inp = $('editItemQty'); if(!inp) return;
	      const q = toInt(inp.value, 0);
	      const nv = Math.max(0, q + toSignedInt(delta, 0));
	      inp.value = String(nv);
	    }
	    function bumpEditItemLowStockQty(delta){
	      const inp = $('editLowStockQty'); if(!inp) return;
	      const global = getGlobalLowStockQty();
	      const curRaw = String(inp.value ?? '').trim();
	      const cur = (curRaw === '') ? global : toInt(curRaw, 0);
	      const step = toSignedInt(delta, 0);
	      const nv = Math.max(0, cur + step);
	      inp.value = String(nv);
	      try{ inp.focus(); }catch(e){}
	    }

    async function commitItemUpdate(id, updates){
      const it = state.items.find(x=> x.id===id);
      if(!it) throw Error('Item not found');

      const fields = {};
      if(updates && 'name' in updates){
        const nv = String(updates.name||'').trim();
        if(!nv) throw Error('Name required');
        const prev = String(it.name||'');
        if(nv !== prev){
          if(toKey(nv)!==toKey(prev) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))) throw Error('Duplicate name');
          fields.name = nv;
        }
      }
      if(updates && 'desc' in updates){
        const nv = String(updates.desc||'').replace(/[\r\n]+/g,' ').trim();
        const prev = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
        if(nv !== prev) fields.desc = nv;
      }
	      if(updates && 'qty' in updates){
	        const q = toInt(updates.qty, -1); if(q < 0) throw Error('Qty must be integer ≥ 0');
	        const prev = toInt(it.qty, 0);
	        if(q !== prev) fields.qty = q;
	      }
	      if(updates && 'reorderEnabled' in updates){
	        const nv = !!updates.reorderEnabled;
	        const prev = getItemReorderEnabled(it);
	        if(nv !== prev) fields.reorderEnabled = nv;
	      }
	      if(updates && 'lowStockQty' in updates){
	        const raw = updates.lowStockQty;
	        let next = null;
	        if(!(raw === null || typeof raw === 'undefined' || String(raw).trim() === '')){
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Low stock qty must be integer ≥ 0');
	          next = v;
	        }
	        const prev = getItemLowStockQtyOverride(it);
	        if(next !== prev) fields.lowStockQty = next;
	      }

	      if(Object.keys(fields).length === 0) return;
	      await sbUpdateFields(id, fields);
	      await sbLoadSnapshot();
	    }
    async function commitItemField(id, col, rawValue){
      if(col==='name') return commitItemUpdate(id, { name: rawValue });
      if(col==='desc') return commitItemUpdate(id, { desc: rawValue });
      if(col==='qty')  return commitItemUpdate(id, { qty: rawValue });
      throw Error('Unknown field');
    }

	    async function autoSaveEditItem(){
	      if(!_editItemCtx) return;
	      const modal = $('editItemModal');
	      if(!modal || modal.getAttribute('aria-hidden') === 'true') return;
	      if(!requireOnline()) return;

	      const id = _editItemCtx.id;
	      const name = $('editItemName') ? $('editItemName').value : '';
	      const desc = $('editItemDesc') ? $('editItemDesc').value : '';
	      const qty  = $('editItemQty')  ? $('editItemQty').value  : '';
	      const lowStockQty = $('editLowStockQty') ? $('editLowStockQty').value : '';
	      const reorderEnabled = $('editReorderEnabled') ? $('editReorderEnabled').checked : true;

	      const btnCancel = $('btnEditItemCancel');
	      if(btnCancel) btnCancel.disabled = true;
	      setEditItemMessage('');

	      try{
	        await commitItemUpdate(id, { name, desc, qty, lowStockQty, reorderEnabled });
	        try{ syncLowStockOverrideIndicatorForRow(id); }catch(e){}
	        try{ syncLowStockIndicatorForRow(id); }catch(e){}
	        toast('Auto-saved');
	      }catch(e){
	        const msg = (e && e.message) ? e.message : 'Update failed';
	        setEditItemMessage(msg);
	        toast(msg);
      }finally{
        if(btnCancel) btnCancel.disabled = false;
	      }
	    }
	    let _editItemAutoSaveTimer = null;
	    function scheduleEditItemAutoSave(){
	      if(_editItemAutoSaveTimer) clearTimeout(_editItemAutoSaveTimer);
	      _editItemAutoSaveTimer = setTimeout(()=> autoSaveEditItem(), 600);
	    }
	
	    async function deleteEditItemModal(){
	      if(!_editItemCtx) return;
	      if(!requireOnline()) return;
	      if(!requirePermission(PERMISSIONS.ITEMS_DELETE, 'Delete not allowed')) return;

	      const id = _editItemCtx.id;
	      const item = state.items.find(x=> x && x.id === id);
	      const itemName = item && item.name ? String(item.name) : 'this item';
	      if(!(await openConfirmModal('Delete item?', `Delete "${itemName}"?`, { okText:'Delete', cancelText:'Cancel' }))) return;

	      const btnDelete = $('btnEditItemDelete');
	      const btnCancel = $('btnEditItemCancel');
	      if(btnDelete) btnDelete.disabled = true;
	      if(btnCancel) btnCancel.disabled = true;
	      setEditItemMessage('');
	
	      try{
	        await sbDeleteMany([id]);
	        try{ removeOrderLine(id); }catch(e){}
	        await sbLoadSnapshot();
	        closeEditItemModal();
	        toast('Item deleted');
	      }catch(e){
	        const msg = (e && e.message) ? e.message : 'Delete failed';
	        setEditItemMessage(msg);
	        toast(msg);
	      }finally{
	        if(btnDelete) btnDelete.disabled = false;
	        if(btnCancel) btnCancel.disabled = false;
	      }
	    }

	    // Modal editor events
	    const btnEditItemDelete = $('btnEditItemDelete');
	    if(btnEditItemDelete) btnEditItemDelete.addEventListener('click', deleteEditItemModal);
	    const btnEditItemCancel = $('btnEditItemCancel');
	    if(btnEditItemCancel) btnEditItemCancel.addEventListener('click', closeEditItemModal);
	    // Auto-save listeners for edit item modal
		    ['editItemName','editItemDesc','editItemQty','editLowStockQty'].forEach(id=>{
		      const el = $(id);
		      if(el){
		        el.addEventListener('blur', scheduleEditItemAutoSave);
		        el.addEventListener('change', scheduleEditItemAutoSave);
		      }
		    });
	    const btnQtyMinus = $('editItemQtyMinus');
	    if(btnQtyMinus) btnQtyMinus.addEventListener('click', ()=> { bumpEditItemQty(-1); scheduleEditItemAutoSave(); });
	    const btnQtyPlus = $('editItemQtyPlus');
	    if(btnQtyPlus) btnQtyPlus.addEventListener('click', ()=> { bumpEditItemQty(1); scheduleEditItemAutoSave(); });
	    const btnLowStockMinus = $('editLowStockMinus');
	    if(btnLowStockMinus) btnLowStockMinus.addEventListener('click', ()=> { bumpEditItemLowStockQty(-1); scheduleEditItemAutoSave(); });
	    const btnLowStockPlus = $('editLowStockPlus');
	    if(btnLowStockPlus) btnLowStockPlus.addEventListener('click', ()=> { bumpEditItemLowStockQty(1); scheduleEditItemAutoSave(); });
	    const btnEditUseGlobal = $('btnEditUseGlobal');
	    if(btnEditUseGlobal) btnEditUseGlobal.addEventListener('click', ()=>{
	      const inp = $('editLowStockQty');
	      if(inp){
	        inp.value = '';
	        try{ inp.focus(); }catch(e){}
	      }
	      scheduleEditItemAutoSave();
	    });
	    const editReorderEnabled = $('editReorderEnabled');
	    if(editReorderEnabled) editReorderEnabled.addEventListener('change', scheduleEditItemAutoSave);

    const editItemName = $('editItemName');
    if(editItemName) editItemName.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
      if(e.key==='Enter'){
        // On mobile, Enter often means "Done" — move to description instead of saving.
        e.preventDefault();
        $('editItemDesc')?.focus();
      }
    });
	    const editItemQty = $('editItemQty');
	    if(editItemQty) editItemQty.addEventListener('keydown', e=>{
	      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
	      if(e.key==='Enter'){ e.preventDefault(); autoSaveEditItem().then(()=> closeEditItemModal()); }
	    });
	    if(editItemQty) editItemQty.addEventListener('click', async (e)=>{
	      if(!isMobileUx()) return;
	      if(!requireOnline()) return;
	      e.preventDefault();
	      e.stopPropagation();

	      const id = _editItemCtx && _editItemCtx.id ? String(_editItemCtx.id) : '';
	      const it = id ? state.items.find(x => x && x.id === id) : null;
	      const itemName = it ? String(it.name || '').trim() : '';
	      const oldQty = toInt(editItemQty.value, 0);
	      const next = await openQtyEntryModal('Set Qty', itemName || 'Inventory Qty', oldQty, { min:0, okText:'Save', cancelText:'Cancel' });
	      if(next === null || typeof next === 'undefined') return;
	      const newQty = Math.max(0, toInt(next, oldQty));
	      if(newQty === oldQty) return;
	      editItemQty.value = String(newQty);
	      scheduleEditItemAutoSave();
	    });
	    const editLowStockQty = $('editLowStockQty');
	    if(editLowStockQty) editLowStockQty.addEventListener('keydown', e=>{
	      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
	      if(e.key==='Enter'){ e.preventDefault(); autoSaveEditItem().then(()=> closeEditItemModal()); }
	    });
	    if(editLowStockQty) editLowStockQty.addEventListener('click', async (e)=>{
	      if(!isMobileUx()) return;
	      if(!requireOnline()) return;
	      e.preventDefault();
	      e.stopPropagation();

	      const id = _editItemCtx && _editItemCtx.id ? String(_editItemCtx.id) : '';
	      const it = id ? state.items.find(x => x && x.id === id) : null;
	      const itemName = it ? String(it.name || '').trim() : '';
	      const globalQty = getGlobalLowStockQty();
	      const curRaw = String(editLowStockQty.value ?? '').trim();
	      const oldQty = (curRaw === '') ? globalQty : toInt(curRaw, 0);
	      const next = await openQtyEntryModal('Low Stock Threshold', itemName || 'Low Stock Threshold', oldQty, { min:0, okText:'Save', cancelText:'Cancel' });
	      if(next === null || typeof next === 'undefined') return;
	      const newQty = Math.max(0, toInt(next, oldQty));
	      if(newQty === oldQty) return;
	      editLowStockQty.value = (newQty === globalQty) ? '' : String(newQty);
	      scheduleEditItemAutoSave();
	    });
		    const editItemDesc = $('editItemDesc');
		    if(editItemDesc) editItemDesc.addEventListener('keydown', e=>{
		      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
		      if((e.key==='Enter' || e.key==='NumpadEnter') && (e.metaKey || e.ctrlKey)){
		        e.preventDefault(); autoSaveEditItem().then(()=> closeEditItemModal());
		      }
		    });
	
	    // Table Qty +/- (mobile): optimistic UI + debounced commit
	    function toSignedInt(v, f=0){
	      const n = Number(v);
      if(!Number.isFinite(n)) return f;
      return Math.trunc(n);
    }
			    function adjustDisplayedTotalQty(delta){
			      const cur = getTotalsValue('totalQty');
			      if(cur === null) return;
			      setTotalsMetric('totalQty', 'qty', Math.max(0, cur + toSignedInt(delta,0)));
			    }
				    function adjustDisplayedInStock(prevQty, nextQty){
				      const cur = getTotalsValue('totalInStock');
				      if(cur === null) return;
				      const was = toInt(prevQty, 0) > 0;
				      const now = toInt(nextQty, 0) > 0;
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalInStock', 'inStock', Math.max(0, cur + delta));
				    }
				    function adjustDisplayedLowStock(item, prevQty, nextQty){
				      const cur = getTotalsValue('totalLowStock');
				      if(cur === null) return;
				      const thr = effectiveLowStockQty(item);
				      const was = toInt(prevQty, 0) <= thr;
				      const now = toInt(nextQty, 0) <= thr;
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalLowStock', 'lowStock', Math.max(0, cur + delta));
				    }
				    function adjustDisplayedLowStockThreshold(item, prevThr, nextThr){
				      const cur = getTotalsValue('totalLowStock');
				      if(cur === null) return;
				      const qty = toInt(item && item.qty, 0);
				      const was = qty <= toInt(prevThr, 0);
				      const now = qty <= toInt(nextThr, 0);
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalLowStock', 'lowStock', Math.max(0, cur + delta));
				    }
			    function updateQtyCellUIForRow(id, qty){
			      const tr = rowElById(id);
			      const nextVal = String(toInt(qty,0));
			      const val = tr ? tr.querySelector('td[data-col="qty"] .qty-value') : null;
			      if(val) val.textContent = nextVal;
			    }
    function repositionRowByQtyNow(id){
      const srt = getSort();
      if(!srt || srt.col !== 'qty') return;
      const tb = tbodyEl(); if(!tb) return;
      const tr = rowElById(id); if(!tr) return;
      const it = state.items.find(x=> x.id===id); if(!it) return;
      const myQty = toInt(it.qty,0);
      const myName = toKey(it.name||'');
      const desc = (srt.dir === 'desc');
      const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
      let anchor = null;
      for(const r of others){
        const rid = r.dataset.id;
        const o = state.items.find(x=> x.id===rid);
        if(!o) continue;
        const oq = toInt(o.qty,0);
        const on = toKey(o.name||'');
        if(desc){
          if(oq < myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }else{
          if(oq > myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }
      }
      if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
    }
    // Debounced version - waits for user to stop clicking before repositioning
    function repositionRowByQty(id){
      const existing = _qtyReposition.get(id);
      if(existing) clearTimeout(existing);
      _qtyReposition.set(id, setTimeout(()=> {
        _qtyReposition.delete(id);
        repositionRowByQtyNow(id);
      }, 350));
    }
    function queueQtyCommit(id, desiredQty){
      if(!id) return;
      const q = toInt(desiredQty, 0);
      let entry = _qtyCommit.get(id);
      if(!entry){
        entry = { timer:null, desiredQty:q, inFlight:false };
        _qtyCommit.set(id, entry);
      }
      entry.desiredQty = q;
      if(entry.timer) clearTimeout(entry.timer);
      entry.timer = setTimeout(()=> flushQtyCommit(id), 400);
    }
    async function flushQtyCommit(id){
      const entry = _qtyCommit.get(id);
      if(!entry) return;
      entry.timer = null;
      if(entry.inFlight) return;
      entry.inFlight = true;
      const qtyToSend = entry.desiredQty;
      try{
        await sbUpdateFields(id, { qty: qtyToSend });
      }catch(e){
        toast((e && e.message) ? e.message : 'Qty update failed');
        try{ await sbLoadSnapshot(); }catch{}
      }finally{
        entry.inFlight = false;
        if(entry.desiredQty !== qtyToSend){
          queueQtyCommit(id, entry.desiredQty);
        }
      }
    }

		    const invTable = $('invTable');
		    const tableWrap = $('tableWrap');
		    if(tableWrap){
		      tableWrap.addEventListener('scroll', ()=>{
		        if(!isMobileUx()) return;
		        collapseExpandedCard();
		      }, { passive:true });
		    }
		    if(invTable){
		      const thead = invTable.querySelector('thead');
		      if(thead){
		        thead.addEventListener('dblclick', handleHeaderAutoFit);
		        thead.addEventListener('mousemove', updateHeaderResizeCursor);
		        thead.addEventListener('mousedown', startHeaderResize);
		        thead.addEventListener('mouseleave', ()=> {
		          thead.querySelectorAll('th.col-resize-hot').forEach(th => th.classList.remove('col-resize-hot'));
		        });
		      }
		      invTable.addEventListener('click', (e)=>{
		        const btn = e.target.closest('button.qty-step-btn');
		        if(!btn) return;
	        const id = String(btn.dataset.id || '').trim();
	        const delta = toSignedInt(btn.dataset.delta, 0);
        if(!id || !delta) return;
        if(!requireOnline()) return;
        if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
        const it = state.items.find(x=> x.id===id); if(!it) return;
	        const oldQty = toInt(it.qty,0);
	        const newQty = Math.max(0, oldQty + delta);
	        if(newQty === oldQty) return;
		        it.qty = newQty;
		        updateQtyCellUIForRow(id, newQty);
		        adjustDisplayedTotalQty(newQty - oldQty);
		        adjustDisplayedInStock(oldQty, newQty);
		        adjustDisplayedLowStock(it, oldQty, newQty);
		        try{ syncLowStockIndicatorForRow(id); }catch(e){}
		        repositionRowByQty(id);
		        queueQtyCommit(id, newQty);
		      });

		      // Mobile: tap the qty value to enter a number directly (helps with large counts)
		      invTable.addEventListener('click', async (e)=>{
		        const val = e.target.closest('.qty-value');
		        if(!val) return;
		        if(!isMobileUx()) return;
		        const stepper = val.closest('.qty-stepper--table');
		        if(!stepper) return;
		        const id = String(stepper.querySelector('button.qty-step-btn')?.dataset?.id || '').trim();
		        if(!id) return;
		        if(!requireOnline()) return;
		        if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
		        const it = state.items.find(x=> x && x.id===id);
		        if(!it) return;

		        e.preventDefault();
		        e.stopPropagation();

		        const oldQty = toInt(it.qty, 0);
		        const itemName = String(it.name || '').trim();
		        const next = await openQtyEntryModal('Set Qty', itemName || 'Inventory Qty', oldQty, { min:0, okText:'Save', cancelText:'Cancel' });
		        if(next === null || typeof next === 'undefined') return;

		        const newQty = Math.max(0, toInt(next, oldQty));
		        if(newQty === oldQty) return;
		        it.qty = newQty;
		        updateQtyCellUIForRow(id, newQty);
		        adjustDisplayedTotalQty(newQty - oldQty);
		        adjustDisplayedInStock(oldQty, newQty);
		        adjustDisplayedLowStock(it, oldQty, newQty);
		        try{ syncLowStockIndicatorForRow(id); }catch(e){}
		        repositionRowByQty(id);
		        queueQtyCommit(id, newQty);
		      });

	      // Mobile UX v2: tray actions (Edit / Low Stock / Order)
		      invTable.addEventListener('click', (e)=>{
	        const trayBtn = e.target.closest('button.card-tray-btn');
	        if(!trayBtn) return;
	        const tr = trayBtn.closest('tr[data-id]');
	        const id = tr && tr.dataset ? String(tr.dataset.id || '').trim() : '';
	        const action = trayBtn.dataset ? String(trayBtn.dataset.trayAction || '').trim() : '';
	        if(!id || !action) return;
	        e.preventDefault();
	        e.stopPropagation();
	        closeMobileTray();
	        if(action === 'order'){
	          if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
	          toggleOrderLineForItemId(id);
	          return;
	        }
	        if(!requireOnline()) return;
	        if(action === 'edit'){
	          if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
	          openEditItemModal(id);
	          return;
	        }
		      });

	      // Mobile UX v2: tap to expand qty + swipe trays (edit/order)
	      let _mobGesture = null;
      function resetMobGesture(){ _mobGesture = null; }
      function isAnyModalOpen(){
        try{ return !!document.querySelector('.modal[aria-hidden="false"]'); }catch(e){ return false; }
      }
      function findTouchById(list, id){
        try{
          for(let i=0;i<list.length;i++){
            const t = list[i];
            if(t && t.identifier === id) return t;
          }
        }catch(e){}
        return null;
      }

      invTable.addEventListener('pointerdown', (e)=>{
        if(!isMobileUx()) return;
        if(e && e.pointerType === 'touch') return; // prefer touch events for broader mobile compatibility
        if(isAnyModalOpen()) return;

	        // If a tray is open, the first touch/pointer down on a different row just closes it.
		        if(_openTrayId){
		          const openTr = rowElById(_openTrayId);
		          if(openTr){
		            const sameRow = !!(e.target.closest('tr[data-id]') === openTr);
		            // Allow re-swiping/tapping the open row even though the tray overlay covers the card;
		            // only ignore direct presses on tray buttons so normal button clicks still work.
		            if(sameRow && e.target.closest('button.card-tray-btn')) return;
		            if(!sameRow){ closeMobileTray(); return; }
		          }
		          // Stale tray state (row re-rendered)
		          else closeMobileTray();
		        }

        const tr = e.target.closest('tr[data-id]');
        if(!tr) return;
        const id = String(tr.dataset.id || '').trim();
        if(!id) return;

        // Highest-priority interaction: qty steppers (disable swipe/tap-to-add)
        if(e.target.closest('.qty-stepper--table')) return;

        // Ignore gestures starting from any other interactive control.
        if(e.target.closest('button, input, textarea, select, a')) return;

        const now = performance.now();
        const startSwipeX = getRowSwipeX(tr);
        const startSide = (startSwipeX < 0) ? 'right' : ((startSwipeX > 0) ? 'left' : null);
        _mobGesture = {
          id,
          tr,
          kind: 'pointer',
          pointerId: e.pointerId,
          startX: e.clientX,
          startY: e.clientY,
          startTime: now,
          prevMoveTime: now,
          lastMoveTime: now,
          prevMoveClientX: e.clientX,
          lastMoveClientX: e.clientX,
          startSwipeX,
          swipeX: startSwipeX,
          moved: false,
          intent: null, // 'h' | 'v'
          side: startSide, // 'left' | 'right'
        };
        try{ tr.setPointerCapture(e.pointerId); }catch(e){}
      }, { passive:true });

      invTable.addEventListener('pointermove', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'pointer') return;
        if(e.pointerId !== _mobGesture.pointerId) return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }

        const dx = e.clientX - _mobGesture.startX;
        const dy = e.clientY - _mobGesture.startY;
        const ax = Math.abs(dx);
	        const ay = Math.abs(dy);

	        // Any meaningful movement cancels a "tap".
	        if(ax >= 10 || ay >= 10) _mobGesture.moved = true;

        if(!_mobGesture.intent){
          if(ax < 10 && ay < 10) return;
          _mobGesture.intent = (ax >= ay) ? 'h' : 'v';
          if(_mobGesture.intent === 'v'){ resetMobGesture(); return; }
        }
        if(_mobGesture.intent !== 'h') return;

        const now = performance.now();
        _mobGesture.prevMoveTime = _mobGesture.lastMoveTime;
        _mobGesture.prevMoveClientX = _mobGesture.lastMoveClientX;
        _mobGesture.lastMoveTime = now;
        _mobGesture.lastMoveClientX = e.clientX;

        const tr = _mobGesture.tr;
        if(!tr || !tr.isConnected){ resetMobGesture(); return; }

        // Elastic resistance when swiping back from detent toward origin
        const startAx = Math.abs(_mobGesture.startSwipeX);
        const startSide = traySideFromSwipeX(_mobGesture.startSwipeX);
        const startSnapPx = traySnapPxForSide(startSide);
        const isAtDetent = startAx >= startSnapPx - 10;
        const isSwipingBack = (_mobGesture.startSwipeX < 0 && dx > 0) || (_mobGesture.startSwipeX > 0 && dx < 0);

        let nextX;
        if(isAtDetent && isSwipingBack){
          // Apply damping for sticky/elastic feel (0.35x movement)
          const dampedDx = dx * 0.35;
          nextX = clampNum(_mobGesture.startSwipeX + dampedDx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = true;
        }else{
          nextX = clampNum(_mobGesture.startSwipeX + dx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = false;
        }
        _mobGesture.swipeX = nextX;

        let side = _mobGesture.side;
        if(Math.abs(nextX) > 6) side = (nextX < 0) ? 'right' : 'left';
        else if(!side) side = (dx < 0) ? 'right' : 'left';
        _mobGesture.side = side || 'left';

        prepareMobileTrayForRow(tr, _mobGesture.side);
        tr.classList.add('swiping');
        setRowSwipeX(tr, nextX);
      }, { passive:true });

      invTable.addEventListener('pointerup', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'pointer') return;
        if(e.pointerId !== _mobGesture.pointerId) return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }

        const { id, tr, moved, intent, swipeX, startTime, startX, prevMoveTime, lastMoveTime, prevMoveClientX, lastMoveClientX, closingFromDetent } = _mobGesture;
        resetMobGesture();
        if(!id || !tr) return;

	        if(!moved){
	          if(_openTrayId === id && tr.classList.contains('tray-open')){
	            closeMobileTrayElastic(tr);
	            return;
	          }
	          toggleExpandedCard(id);
	          return;
	        }

        if(intent === 'h'){
          tr.classList.remove('swiping');
          const finalX = Number.isFinite(swipeX) ? swipeX : getRowSwipeX(tr);
          const ax = Math.abs(finalX);
          const side = (finalX < 0) ? 'right' : 'left';

          // If user was swiping back from detent, always snap back with elastic animation
          if(closingFromDetent){
            closeMobileTrayElastic(tr);
            return;
          }

          let vx = 0;
          try{
            if(Number.isFinite(lastMoveTime) && Number.isFinite(prevMoveTime) && lastMoveTime > prevMoveTime){
              const dt = lastMoveTime - prevMoveTime;
              vx = dt > 0 ? (lastMoveClientX - prevMoveClientX) / dt : 0;
            }else{
              const tNow = performance.now();
              const dt = tNow - (Number(startTime) || tNow);
              vx = dt > 0 ? (e.clientX - startX) / dt : 0;
            }
          }catch(e){ vx = 0; }

		          const shouldCommitEdit = (side === 'right') && (ax >= COMMIT_PX);
		          if(shouldCommitEdit){
		            closeMobileTray();
		            if(!requireOnline()) return;
		            if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
		            openEditItemModal(id);
		            return;
		          }
		          const shouldCommitOrder = (side === 'left') && (ax >= COMMIT_PX);
		          if(shouldCommitOrder){
		            closeMobileTray();
		            if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		            toggleOrderLineForItemId(id);
		            return;
		          }

		          const fastOpen = (side === 'right') ? (vx <= -0.55) : (vx >= 0.55);
		          const fastClose = (side === 'right') ? (vx >= 0.55) : (vx <= -0.55);
		          const snapPx = traySnapPxForSide(side);
		          if(fastClose && ax < COMMIT_PX){
	            closeMobileTray();
	          }else if(ax >= snapPx || (ax >= REVEAL_PX && fastOpen)){
	            openMobileTrayForRow(tr, side);
	          }else{
	            closeMobileTray();
          }
        }
      }, { passive:true });

      invTable.addEventListener('pointercancel', ()=>{
        if(!isMobileUx()) return;
        try{ if(_mobGesture && _mobGesture.tr) _mobGesture.tr.classList.remove('swiping'); }catch(e){}
        try{ closeMobileTray(); }catch(e){}
        resetMobGesture();
      }, { passive:true });

      invTable.addEventListener('touchstart', (e)=>{
        if(!isMobileUx()) return;
        if(isAnyModalOpen()) return;
        if(!e || !e.target) return;

	        // If a tray is open, the first touch on a different row just closes it.
		        if(_openTrayId){
		          const openTr = rowElById(_openTrayId);
		          if(openTr){
		            const sameRow = !!(e.target.closest('tr[data-id]') === openTr);
		            // Allow re-swiping/tapping the open row even though the tray overlay covers the card;
		            // only ignore direct taps on tray buttons so normal button clicks still work.
		            if(sameRow && e.target.closest('button.card-tray-btn')) return;
		            if(!sameRow){ closeMobileTray(); return; }
		          }
		          else closeMobileTray();
		        }

        const tr = e.target.closest('tr[data-id]');
        if(!tr) return;
        const id = String(tr.dataset.id || '').trim();
        if(!id) return;

        // Highest-priority interaction: qty steppers (disable swipe/tap-to-add)
        if(e.target.closest('.qty-stepper--table')) return;

        // Ignore gestures starting from any other interactive control.
        if(e.target.closest('button, input, textarea, select, a')) return;

        const t = (e.touches && e.touches[0]) ? e.touches[0] : null;
        if(!t) return;
        const now = performance.now();
        const startSwipeX = getRowSwipeX(tr);
        const startSide = (startSwipeX < 0) ? 'right' : ((startSwipeX > 0) ? 'left' : null);
        _mobGesture = {
          id,
          tr,
          kind: 'touch',
          touchId: t.identifier,
          startX: t.clientX,
          startY: t.clientY,
          startTime: now,
          prevMoveTime: now,
          lastMoveTime: now,
          prevMoveClientX: t.clientX,
          lastMoveClientX: t.clientX,
          startSwipeX,
          swipeX: startSwipeX,
          moved: false,
          intent: null, // 'h' | 'v'
          side: startSide, // 'left' | 'right'
        };
      }, { passive:true });

      invTable.addEventListener('touchmove', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'touch') return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }

        const t = findTouchById(e.touches || [], _mobGesture.touchId);
        if(!t) return;

        const dx = t.clientX - _mobGesture.startX;
        const dy = t.clientY - _mobGesture.startY;
        const ax = Math.abs(dx);
	        const ay = Math.abs(dy);

	        // Any meaningful movement cancels a "tap".
	        if(ax >= 10 || ay >= 10) _mobGesture.moved = true;

        if(!_mobGesture.intent){
          if(ax < 10 && ay < 10) return;
          _mobGesture.intent = (ax >= ay) ? 'h' : 'v';
          if(_mobGesture.intent === 'v'){ resetMobGesture(); return; }
        }
        if(_mobGesture.intent !== 'h') return;

        // Horizontal swipe: prevent scroll once locked.
        try{ e.preventDefault(); }catch(e){}

        const now = performance.now();
        _mobGesture.prevMoveTime = _mobGesture.lastMoveTime;
        _mobGesture.prevMoveClientX = _mobGesture.lastMoveClientX;
        _mobGesture.lastMoveTime = now;
        _mobGesture.lastMoveClientX = t.clientX;

        const tr = _mobGesture.tr;
        if(!tr || !tr.isConnected){ resetMobGesture(); return; }

	        // Elastic resistance when swiping back from detent toward origin
	        const startAx = Math.abs(_mobGesture.startSwipeX);
	        const startSide = traySideFromSwipeX(_mobGesture.startSwipeX);
	        const startSnapPx = traySnapPxForSide(startSide);
	        const isAtDetent = startAx >= startSnapPx - 10;
	        const isSwipingBack = (_mobGesture.startSwipeX < 0 && dx > 0) || (_mobGesture.startSwipeX > 0 && dx < 0);

        let nextX;
        if(isAtDetent && isSwipingBack){
          // Apply damping for sticky/elastic feel (0.35x movement)
          const dampedDx = dx * 0.35;
          nextX = clampNum(_mobGesture.startSwipeX + dampedDx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = true;
        }else{
          nextX = clampNum(_mobGesture.startSwipeX + dx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = false;
        }
        _mobGesture.swipeX = nextX;

        let side = _mobGesture.side;
        if(Math.abs(nextX) > 6) side = (nextX < 0) ? 'right' : 'left';
        else if(!side) side = (dx < 0) ? 'right' : 'left';
        _mobGesture.side = side || 'left';

        prepareMobileTrayForRow(tr, _mobGesture.side);
        tr.classList.add('swiping');
        setRowSwipeX(tr, nextX);
      }, { passive:false });

      invTable.addEventListener('touchend', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'touch') return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }
        const ended = findTouchById(e.changedTouches || [], _mobGesture.touchId);
        if(!ended) return;
        try{ e.preventDefault(); }catch(e){}

        const { id, tr, moved, intent, swipeX, startTime, startX, prevMoveTime, lastMoveTime, prevMoveClientX, lastMoveClientX, closingFromDetent } = _mobGesture;
        resetMobGesture();
        if(!id || !tr) return;

	        if(!moved){
	          if(_openTrayId === id && tr.classList.contains('tray-open')){
	            closeMobileTrayElastic(tr);
	            return;
	          }
	          toggleExpandedCard(id);
	          return;
	        }

        if(intent === 'h'){
          tr.classList.remove('swiping');
          const finalX = Number.isFinite(swipeX) ? swipeX : getRowSwipeX(tr);
          const ax = Math.abs(finalX);
          const side = (finalX < 0) ? 'right' : 'left';

          // If user was swiping back from detent, always snap back with elastic animation
          if(closingFromDetent){
            closeMobileTrayElastic(tr);
            return;
          }

          let vx = 0;
          try{
            if(Number.isFinite(lastMoveTime) && Number.isFinite(prevMoveTime) && lastMoveTime > prevMoveTime){
              const dt = lastMoveTime - prevMoveTime;
              vx = dt > 0 ? (lastMoveClientX - prevMoveClientX) / dt : 0;
            }else{
              const tNow = performance.now();
              const dt = tNow - (Number(startTime) || tNow);
              vx = dt > 0 ? (ended.clientX - startX) / dt : 0;
            }
          }catch(e){ vx = 0; }

		          const shouldCommitEdit = (side === 'right') && (ax >= COMMIT_PX);
		          if(shouldCommitEdit){
		            closeMobileTray();
		            if(!requireOnline()) return;
		            if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
		            openEditItemModal(id);
		            return;
		          }
		          const shouldCommitOrder = (side === 'left') && (ax >= COMMIT_PX);
		          if(shouldCommitOrder){
		            closeMobileTray();
		            if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		            toggleOrderLineForItemId(id);
		            return;
		          }

		          const fastOpen = (side === 'right') ? (vx <= -0.55) : (vx >= 0.55);
		          const fastClose = (side === 'right') ? (vx >= 0.55) : (vx <= -0.55);
		          const snapPx = traySnapPxForSide(side);
		          if(fastClose && ax < COMMIT_PX){
	            closeMobileTray();
	          }else if(ax >= snapPx || (ax >= REVEAL_PX && fastOpen)){
	            openMobileTrayForRow(tr, side);
	          }else{
	            closeMobileTray();
	          }
        }
      }, { passive:false });

      invTable.addEventListener('touchcancel', ()=>{
        if(!isMobileUx()) return;
        try{ if(_mobGesture && _mobGesture.tr) _mobGesture.tr.classList.remove('swiping'); }catch(e){}
        try{ closeMobileTray(); }catch(e){}
        resetMobGesture();
      }, { passive:true });
		    }

	    function startCellEdit(td, ev){
	      // If the user tapped a control inside the cell, don't open an editor.
	      if(ev && ev.target && ev.target.closest('button, input, textarea, select, a')) return;
	      if(td.querySelector('input')) return;
	      if(isMobileUx()) return;
	      const col=td.getAttribute('data-col'); if(!col) return;
	      const tr=td.closest('tr'); const id=tr?.dataset?.id; if(!id) return;
	      const it=state.items.find(x=> x.id===id); if(!it) return;
	      const selectedIds = getSelectedRowIds();
	      const batchIds = (selectedIds.length > 1 && selectedIds.includes(id)) ? selectedIds : [];
	      const isBatch = batchIds.length > 1;
	      const prevBatch = isBatch ? new Map(
	        batchIds
	          .map(batchId => {
	            const item = getInventoryById(batchId);
	            if(!item) return null;
	            return [batchId, { name: String(item.name||''), desc: String(item.desc||''), qty: toInt(item.qty,0) }];
	          })
	          .filter(Boolean)
	      ) : null;

      if(prefersModalEditing()){
        if(!requireOnline()) return;
        if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
        openEditItemModal(id);
        return;
      }

      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
      const fb = $('filterBox'); if (fb) fb.value = '';
	      state._filter = '';
	      try{ updateFilterClearBtn(); }catch(e){}

	      const oldVal = (col==='qty'? String(toInt(it.qty,0)) : String(col==='name'?it.name:(it.desc||'')));
	      const prevName = String(it.name||'');
	      const prevDesc = String(it.desc||'');
	      const prevQty = toInt(it.qty,0);
	      const inp=document.createElement('input');
	      inp.type = (col==='qty')? 'number' : 'text';
	      if(col==='qty'){ inp.min='0'; inp.step='1'; inp.inputMode='numeric'; inp.pattern='[0-9]*'; inp.setAttribute('enterkeyhint','done'); }
	      inp.value = oldVal; inp.autocapitalize='off'; inp.autocomplete='off'; inp.spellcheck=false;
	      td.classList.add('editing'); td.innerHTML=''; td.appendChild(inp);
	      setTimeout(()=>{ inp.focus(); inp.select(); }, 0);

	      let _done = false;
	      const restore = ()=>{
	        if(_done) return;
	        _done = true;
	        td.classList.remove('editing');
	        if(col==='qty') td.innerHTML = qtyCellHTML(it);
	        else td.innerHTML = '<span class="cell-val">' + escapeHtml((col==='name') ? String(it.name||'') : String(it.desc||'')) + '</span>';
	      };
	      const cancel=()=>{
	        it.name = prevName;
	        it.desc = prevDesc;
	        it.qty = prevQty;
	        restore();
	      };

	      const commit = async () => {
	        if(_done) return;
	        const raw = inp.value;
	        try{
	          if(isBatch){
	            if(!requireOnline()) return;
	            const count = batchIds.length;
	            if(col === 'name'){
	              const nv = String(raw||'').trim();
	              if(!nv){ cancel(); toast('Name required'); return; }
	              const normNv = toKey(nv);
	              const dup = state.items.some(x => x && x.id && !batchIds.includes(x.id) && toKey(String(x.name||'')) === normNv);
	              if(dup){ cancel(); toast('Duplicate name'); return; }
	              const allSame = batchIds.every(batchId => {
	                const item = getInventoryById(batchId);
	                return item && toKey(String(item.name||'')) === normNv;
	              });
	              if(allSame){ cancel(); return; }
	              const ok = await openConfirmModal('Batch edit?', `Set Item to "${truncateForConfirm(nv)}" for ${count} selected items?`, { okText:'Apply', cancelText:'Cancel' });
	              if(!ok){ cancel(); return; }
	              batchIds.forEach(batchId => {
	                const item = getInventoryById(batchId);
	                if(item) item.name = nv;
	              });
	              restore();
	              renderTable();
	              applySelectedRowIds(batchIds);
	              try{
	                await Promise.all(batchIds.map(batchId => sbUpdateFields(batchId, { name: nv })));
	              }catch(e){
	                if(prevBatch){
	                  prevBatch.forEach((prev, batchId) => {
	                    const item = getInventoryById(batchId);
	                    if(item){
	                      item.name = prev.name;
	                      item.desc = prev.desc;
	                      item.qty = prev.qty;
	                    }
	                  });
	                  renderTable();
	                  applySelectedRowIds(batchIds);
	                }
	                toast((e && e.message) ? e.message : 'Batch update failed');
	                try{ await sbLoadSnapshot(); }catch{}
	              }
	              return;
	            }
	            if(col === 'desc'){
	              const nv = normalizeDescValue(raw);
	              const allSame = batchIds.every(batchId => {
	                const item = getInventoryById(batchId);
	                return item && normalizeDescValue(item.desc) === nv;
	              });
	              if(allSame){ cancel(); return; }
	              const ok = await openConfirmModal('Batch edit?', `Set Description to "${truncateForConfirm(nv)}" for ${count} selected items?`, { okText:'Apply', cancelText:'Cancel' });
	              if(!ok){ cancel(); return; }
	              batchIds.forEach(batchId => {
	                const item = getInventoryById(batchId);
	                if(item) item.desc = nv;
	              });
	              restore();
	              renderTable();
	              applySelectedRowIds(batchIds);
	              try{
	                await Promise.all(batchIds.map(batchId => sbUpdateFields(batchId, { desc: nv })));
	              }catch(e){
	                if(prevBatch){
	                  prevBatch.forEach((prev, batchId) => {
	                    const item = getInventoryById(batchId);
	                    if(item){
	                      item.name = prev.name;
	                      item.desc = prev.desc;
	                      item.qty = prev.qty;
	                    }
	                  });
	                  renderTable();
	                  applySelectedRowIds(batchIds);
	                }
	                toast((e && e.message) ? e.message : 'Batch update failed');
	                try{ await sbLoadSnapshot(); }catch{}
	              }
	              return;
	            }
	            if(col === 'qty'){
	              const q = toInt(raw, -1);
	              if(q < 0){ cancel(); toast('Qty must be integer ≥ 0'); return; }
	              const allSame = batchIds.every(batchId => {
	                const item = getInventoryById(batchId);
	                return item && toInt(item.qty, 0) === q;
	              });
	              if(allSame){ cancel(); return; }
	              const ok = await openConfirmModal('Batch edit?', `Set Qty to ${q} for ${count} selected items?`, { okText:'Apply', cancelText:'Cancel' });
	              if(!ok){ cancel(); return; }
	              batchIds.forEach(batchId => {
	                const item = getInventoryById(batchId);
	                if(item) item.qty = q;
	              });
	              restore();
	              renderTable();
	              applySelectedRowIds(batchIds);
	              batchIds.forEach(batchId => queueQtyCommit(batchId, q));
	              return;
	            }
	            cancel();
	            return;
	          }
	          if(col==='name'){
	            const nv = String(raw||'').trim();
	            if(!nv){ cancel(); toast('Name required'); return; }
	            if(nv === prevName){ cancel(); return; }
	            if(toKey(nv)!==toKey(prevName) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))){ cancel(); toast('Duplicate name'); return; }
	            it.name = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'name') renderTable();
	            await sbUpdateFields(id, { name: nv });
	            return;
	          }
	          if(col==='desc'){
	            const nv = normalizeDescValue(raw);
	            const pv = normalizeDescValue(prevDesc);
	            if(nv === pv){ cancel(); return; }
	            it.desc = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'desc') renderTable();
	            await sbUpdateFields(id, { desc: nv });
	            return;
	          }
			          if(col==='qty'){
			            const q = toInt(raw, -1);
			            if(q < 0){ cancel(); toast('Qty must be integer ≥ 0'); return; }
			            if(q === prevQty){ cancel(); return; }
			            it.qty = q;
			            restore();
			            adjustDisplayedTotalQty(q - prevQty);
			            adjustDisplayedInStock(prevQty, q);
			            adjustDisplayedLowStock(it, prevQty, q);
			            repositionRowByQty(id);
			            queueQtyCommit(id, q);
			            try{ syncLowStockIndicatorForRow(id); }catch(e){}
			            return;
			          }
	          cancel();
	        }catch(e){
	          it.name = prevName;
	          it.desc = prevDesc;
	          it.qty = prevQty;
	          try{ renderTable(); }catch(_){}
	          toast((e && e.message) ? e.message : 'Update failed');
	          try{ await sbLoadSnapshot(); }catch{}
	        }
	      };

	      inp.addEventListener('keydown', e=>{
	        if(e.key==='Enter'){ e.preventDefault(); commit(); }
	        if(e.key==='Escape'){ e.preventDefault(); cancel(); }
	      });
	      inp.addEventListener('blur', commit);
	    }

    // ========================
    // Hamburger Menu Toggle
    // ========================
    const hamburgerBtn = $('hamburgerBtn');
    const menuDropdown = $('menuDropdown');
    const menuBackdrop = $('menuBackdrop');

    function toggleMenu(open) {
      const isOpen = open !== undefined ? open : !menuDropdown.classList.contains('open');
      hamburgerBtn.classList.toggle('open', isOpen);
      menuDropdown.classList.toggle('open', isOpen);
      menuBackdrop.classList.toggle('open', isOpen);
      hamburgerBtn.setAttribute('aria-expanded', isOpen);
    }

    hamburgerBtn.addEventListener('click', () => toggleMenu());
    menuBackdrop.addEventListener('click', () => toggleMenu(false));

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && menuDropdown.classList.contains('open')) {
        toggleMenu(false);
      }
    });

    // ========================
    // Import / Paste / Export
    // ========================
    $('menuImport').addEventListener('click', ()=> {
      toggleMenu(false);
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk import requires import permission' : 'Bulk import requires Professional tier');
        return;
      }
      $('#fileImport').click();
    });
    $('#fileImport').addEventListener('change', async ev=>{
      if(!requireOnline()){ ev.target.value=''; return; }
      const f=ev.target.files[0]; if(!f) return; await handleFile(f); ev.target.value='';
    });

    $('menuPaste').addEventListener('click', ()=>{
      toggleMenu(false);
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk paste requires import permission' : 'Bulk paste requires Professional tier');
        return;
      }
      $('#pasteArea').value='';
      show('pasteModal', true);
    });
    $('btnPasteCancel').addEventListener('click', ()=> show('pasteModal', false));
    $('btnPasteApply').addEventListener('click', ()=>{
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk paste requires import permission' : 'Bulk paste requires Professional tier');
        return;
      }
      const text=$('#pasteArea').value||''; if(!text.trim()){ toast('Nothing to import'); return; }
      const rows=parseDelimitedSmart(text); const items=rowsToItems(rows);
      if(!items.length){ toast('Could not detect headers or rows'); return; }
      show('pasteModal', false);
      showPreview(items);
    });

    const drop=$('#dropZone');
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#0e1621'; });
    drop.addEventListener('dragleave', ()=>{ drop.style.background=''; });
    drop.addEventListener('drop', async e=>{
      e.preventDefault(); drop.style.background='';
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk import requires import permission' : 'Bulk import requires Professional tier');
        return;
      }
      const f=e.dataTransfer.files[0]; if(f) await handleFile(f);
    });

    $('#fileImportModal').addEventListener('change', async ev=>{ if(!requireOnline()){ ev.target.value=''; return; } const f=ev.target.files[0]; if(f) await handleFile(f); ev.target.value=''; });

    async function handleFile(f){
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk import requires import permission' : 'Bulk import requires Professional tier');
        return;
      }
      try{
        const items=await parseAnyFile(f);
        if(!items.length){ toast('No rows found in file'); return; }
        show('pasteModal', false);
        showPreview(items);
      }catch(err){ toast(err.message||'Import failed'); }
    }
    function buildPreview(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      const rows=[]; let add=0, upd=0, same=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        const it=index.get(k);
        if(!it){ rows.push({name:r.name, desc:r.desc||'', oldQty:'—', newQty:toInt(r.qty,0), action:'Add'}); add++; }
        else{
          const oldQ=toInt(it.qty,0), newQ=toInt(r.qty,0);
          const act = (oldQ===newQ && (r.desc||'').trim()===String(it.desc||'').trim())? 'No change' : 'Update';
          if(act==='Update') upd++; else same++;
          rows.push({name:it.name, desc:(r.desc||it.desc||''), oldQty:oldQ, newQty:newQ, action:act});
        }
      }
      return {rows, add, upd, same, total: imported.length};
    }
    function showPreview(imported){
      const pv=buildPreview(imported);
      const info=$('previewInfo'); if(info){ info.textContent = `${pv.total} row(s): ${pv.add} add, ${pv.upd} update, ${pv.same} unchanged`; }
      const tbody=$('previewBody'); if(tbody){
        tbody.innerHTML='';
        for(const r of pv.rows){
          const tr=document.createElement('tr');
          tr.innerHTML =
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.name)}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.desc||'')}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.oldQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.newQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${r.action}</td>`;
          tbody.appendChild(tr);
        }
      }
      state._pendingImport = imported;
      show('previewModal', true);
    }
    $('btnPreviewCancel').addEventListener('click', ()=>{ state._pendingImport=null; show('previewModal', false); });
    $('btnPreviewApply').addEventListener('click', async ()=>{
      if(!requireOnline()) return;
      const imp = state._pendingImport||[]; state._pendingImport=null; show('previewModal', false);
      if(!imp.length){ toast('Nothing to import'); return; }
      try{
        await sbUpsertMany(imp);
        await sbLoadSnapshot();
        toast('Import applied');
      }catch(e){ toast(e.message || 'Import failed'); }
    });

	    $('menuExport').addEventListener('click', ()=>{
	      toggleMenu(false);
	      if(!requireOnline()) return;
	      if(!canItemsExport()){
	        toast(hasTier('professional') ? 'Export permission required' : 'Export requires Professional tier');
	        return;
	      }
	      (async ()=>{
	        try{
	          const items = await sbExportItems();
	          if(!items.length){ toast('No items to export'); return; }
	          const rows=[["Item","Description","Qty"]];
	          for(const it of items){ rows.push([it.name||'', it.description||'', String(toInt(it.quantity,0))]); }
	          const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
	          const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
	          const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventory.csv'; a.click(); URL.revokeObjectURL(url);
	        }catch(e){
	          toast(e && e.message ? e.message : 'Export failed');
	        }
	      })();
	    });

			    // ========================
			    // Inventory report
			    // ========================
			    function getGlobalLowStockQty(){
		      try{
		        if(SB && SB.profile && typeof SB.profile.low_stock_qty_global !== 'undefined'){
		          const v = Number(SB.profile.low_stock_qty_global);
	          if(Number.isFinite(v) && v >= 0) return Math.trunc(v);
	        }
	      }catch(e){}
	      try{
	        const raw = localStorage.getItem('inv.pref.lowStockQtyGlobal');
	        const v = Number(raw);
	        if(Number.isFinite(v) && v >= 0) return Math.trunc(v);
	      }catch(e){}
	      return 0;
	    }
	    function getItemLowStockQtyOverride(item){
	      if(!item) return null;
	      const v = Object.prototype.hasOwnProperty.call(item, 'lowStockQty') ? item.lowStockQty : null;
	      if(v === null || typeof v === 'undefined') return null;
	      const n = Number(v);
	      if(!Number.isFinite(n)) return null;
	      const i = Math.trunc(n);
	      if(i < 0) return null;
	      return i;
	    }
	    function getItemReorderEnabled(item){
	      if(!item) return true;
	      if(!Object.prototype.hasOwnProperty.call(item, 'reorderEnabled')) return true;
	      return !!item.reorderEnabled;
	    }
	    function effectiveLowStockQty(item){
	      const override = getItemLowStockQtyOverride(item);
	      return override !== null ? override : getGlobalLowStockQty();
	    }
	    function isLowStockItem(item){
	      if(!getItemReorderEnabled(item)) return false;
	      const qty = toInt(item && item.qty, 0);
	      const thr = effectiveLowStockQty(item);
	      return qty <= thr;
	    }
	    function isExemptLowStockItem(item){
	      if(getItemReorderEnabled(item)) return false;
	      const qty = toInt(item && item.qty, 0);
	      const thr = effectiveLowStockQty(item);
	      return qty <= thr;
	    }
	    function reportDataSnapshot(){
	      const all = (Array.isArray(state.items) ? state.items : [])
	        .filter(Boolean)
		        .map(it => ({
		          id: it.id,
		          name: String(it.name||''),
		          desc: String(it.desc||''),
		          qty: toInt(it.qty,0),
		          lowStockQty: getItemLowStockQtyOverride(it),
		          reorderEnabled: getItemReorderEnabled(it),
		        }))
	        .sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
	      const totalItems = all.length;
	      const totalQty = all.reduce((sum, it) => sum + toInt(it.qty,0), 0);
	      const inStock = all.filter(it => toInt(it.qty,0) > 0);
	      const lowStock = all.filter(it => isLowStockItem(it));
	      const exemptLowStock = all.filter(it => isExemptLowStockItem(it));
	      return {
	        all,
	        inStock,
	        lowStock,
	        exemptLowStock,
	        totalItems,
	        totalQty,
	        inStockCount: inStock.length,
	        lowStockCount: lowStock.length,
	        exemptLowStockCount: exemptLowStock.length,
	      };
	    }
	    function reportCsvEscape(value){
	      const s = String(value ?? '');
	      return '"' + s.replace(/"/g, '""') + '"';
	    }
	    function buildInventoryReportCsv(data){
	      const d = data || reportDataSnapshot();
	      const out = [];
	      out.push(['Item','Description','Qty','In Stock'].map(reportCsvEscape).join(','));
	      for(const it of d.all){
	        out.push([
	          it.name || '',
	          String(it.desc||'').replace(/[\r\n]+/g,' ').trim(),
	          String(toInt(it.qty,0)),
	          toInt(it.qty,0) > 0 ? 'Yes' : 'No',
	        ].map(reportCsvEscape).join(','));
	      }
	      return out.join('\n');
	    }
	    function buildInventoryReportText(data, opts = {}){
	      const d = data || reportDataSnapshot();
	      const maxLines = Math.max(10, Math.min(500, toInt(opts.maxLines, 180)));
	      const out = [];
	      const when = formatEasternDateTime(new Date());
	      out.push(`Inventory Report`);
	      out.push(`Generated: ${when}`);
	      out.push('');
	      out.push(`Total Items: ${d.totalItems}`);
	      out.push(`In Stock: ${d.inStockCount}`);
	      out.push(`Low Stock: ${d.lowStockCount}`);
	      out.push(`Total Qty: ${d.totalQty}`);
	      out.push('');
	      out.push('Inventory:');
	      out.push('');
	      if(!d.all.length){
	        out.push('(none)');
	        return out.join('\n');
	      }
	      let linesUsed = out.length;
	      for(const it of d.all){
	        if(linesUsed >= maxLines){
	          out.push('');
	          out.push(`(trimmed; use CSV for full report)`);
	          break;
	        }
	        const qty = toInt(it.qty,0);
	        const desc = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
	        out.push(`${it.name}\t${qty}\t${desc}`);
	        linesUsed++;
	      }
	      return out.join('\n');
	    }
	
	    function reportTableHtml(items, opts = {}){
	      const rows = Array.isArray(items) ? items : [];
	      const showThreshold = !!opts.showThreshold;
	      let html = '<table class="report-table" role="table">';
	      html += '<thead><tr>';
	      html += '<th>Item</th>';
	      html += '<th>Description</th>';
	      html += '<th class="qty">Qty</th>';
	      if(showThreshold) html += '<th class="thr">Low</th>';
	      html += '</tr></thead><tbody>';
	      for(const it of rows){
	        const name = escapeHtml(it && it.name ? it.name : '');
	        const descRaw = String(it && it.desc ? it.desc : '').replace(/[\r\n]+/g,' ').trim();
	        const desc = escapeHtml(descRaw);
	        const qty = toInt(it && it.qty, 0);
	        html += '<tr>';
	        html += `<td class="item">${name}</td>`;
	        html += `<td class="desc">${desc}</td>`;
	        html += `<td class="qty">${qty}</td>`;
	        if(showThreshold){
	          const thr = effectiveLowStockQty(it);
	          html += `<td class="thr">${toInt(thr,0)}</td>`;
	        }
	        html += '</tr>';
	      }
	      html += '</tbody></table>';
	      return html;
	    }
	    function reportOrderHasItem(id){
	      const ord = orderState();
	      const key = String(id || '').trim();
	      return !!(key && ord && Array.isArray(ord.lines) && ord.lines.some(l => String(l && l.id ? l.id : '').trim() === key));
	    }
	    function reportRowButtonHtml(item, opts = {}){
	      const it = item || {};
	      const id = String(it.id || '').trim();
	      if(!id) return '';
	      const safeId = id.replace(/"/g, '&quot;');
	      const name = escapeHtml(String(it.name || '').trim());
	      const descRaw = String(it.desc || '').replace(/[\r\n]+/g,' ').trim();
	      const desc = escapeHtml(descRaw);
	      const qty = toInt(it.qty, 0);
	      const showThreshold = !!opts.showThreshold;
	      const thr = showThreshold ? toInt(effectiveLowStockQty(it), 0) : null;
	      const selected = reportOrderHasItem(id);
	      const dotClass = selected ? 'led-dot--green' : 'led-dot--off';
	      const pressed = selected ? 'true' : 'false';

	      return (
	        `<button type="button" class="report-row" data-report-order-id="${safeId}" aria-pressed="${pressed}">`+
	          `<div class="report-row-main">`+
	            `<div class="report-item">`+
	              `<span class="led-dot ${dotClass}" aria-hidden="true"></span>`+
	              `<span class="report-item-name">${name}</span>`+
	            `</div>`+
	            (desc ? `<div class="report-desc">${desc}</div>` : ``)+
	          `</div>`+
	          `<div class="report-qty">`+
	            `${qty}`+
	            (showThreshold ? `<div class="muted">Low: ${thr}</div>` : ``)+
	          `</div>`+
	        `</button>`
	      );
	    }
	    function reportRowsHtml(items, opts = {}){
	      const rows = Array.isArray(items) ? items : [];
	      if(!rows.length){
	        const emptyText = (opts && typeof opts.emptyText === 'string') ? opts.emptyText : 'No items.';
	        return `<div class="order-empty">${escapeHtml(emptyText)}</div>`;
	      }
	      const sepText = (opts && typeof opts.separatorText === 'string') ? opts.separatorText : 'Not in Cart';
	      const selected = [];
	      const rest = [];
	      for(const it of rows){
	        const id = String(it && it.id ? it.id : '').trim();
	        if(id && reportOrderHasItem(id)) selected.push(it);
	        else rest.push(it);
	      }
	      let html = '';
	      if(selected.length) html += selected.map(it => reportRowButtonHtml(it, opts)).join('');
	      if(selected.length && rest.length){
	        html += `<div class="report-separator" role="separator"><span>${escapeHtml(sepText)}</span></div>`;
	      }
	      if(rest.length) html += rest.map(it => reportRowButtonHtml(it, opts)).join('');
	      return html;
	    }
	    function updateReportOrderBadge(){
	      const modal = $('reportModal');
	      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
	      const pillContainer = $('reportOrderPillContainer');
	      const pill = $('reportOrderBadge');
	      const valueEl = $('reportOrderCount');
	      if(!pillContainer || !pill || !valueEl) return;
	      const ord = orderState();
	      const count = Array.isArray(ord.lines) ? ord.lines.length : 0;
	      if(count > 0){
	        pillContainer.style.display = 'flex';
	        valueEl.textContent = String(count);
	        const labelEl = pill.querySelector('.order-pill-label');
	        if(labelEl) labelEl.textContent = count === 1 ? 'Item in Cart' : 'Items in Cart';
	      }else{
	        pillContainer.style.display = 'none';
	        valueEl.textContent = '0';
	      }
	    }
		    function syncReportOrderIndicators(){
		      const modal = $('reportModal');
		      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
		      const ord = orderState();
		      const ids = new Set((Array.isArray(ord.lines) ? ord.lines : []).map(l => String(l && l.id ? l.id : '').trim()).filter(Boolean));
	      document.querySelectorAll('[data-report-order-id]').forEach(el=>{
	        const id = String(el.dataset && el.dataset.reportOrderId ? el.dataset.reportOrderId : '').trim();
	        if(!id) return;
	        const selected = ids.has(id);
	        el.setAttribute('aria-pressed', selected ? 'true' : 'false');
	        const dot = el.querySelector('.led-dot');
	        if(dot){
	          dot.classList.toggle('led-dot--green', selected);
	          dot.classList.toggle('led-dot--off', !selected);
	        }
	      });
		      updateReportOrderBadge();
		    }
		    function batchAddLowStockToCart(){
		      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		      const d = reportDataSnapshot();
		      const rows = Array.isArray(d.lowStock) ? d.lowStock : [];
		      if(!rows.length){ toast('No low stock items'); return; }
		      let added = 0;
		      for(const it of rows){
		        const need = Math.max(1, toInt(effectiveLowStockQty(it), 0) - toInt(it.qty, 0));
		        if(upsertOrderLineFromItem(it, need)) added++;
		      }
		      if(added){
		        toast(`Added ${added} low stock ${added === 1 ? 'item' : 'items'} to cart`);
		      }else{
		        toast('Low stock items already in cart');
		      }
		      try{ syncReportOrderIndicators(); }catch(e){}
		    }
			    function renderInventoryReport(){
			      const d = reportDataSnapshot();
			      const elTotal = $('reportMetricTotalItems'); if(elTotal) elTotal.textContent = String(d.totalItems);
			      const elQty = $('reportMetricTotalQty'); if(elQty) elQty.textContent = String(d.totalQty);
			      const elLowCount = $('reportLowStockCount'); if(elLowCount) elLowCount.textContent = `(${d.lowStockCount})`;
			      const elExemptCount = $('reportExemptCount'); if(elExemptCount) elExemptCount.textContent = `(${d.exemptLowStockCount})`;
			      const elInCount = $('reportInStockCount'); if(elInCount) elInCount.textContent = `(${d.inStockCount})`;

			      const lowSection = $('reportLowStockSection');
			      const lowList = $('reportLowStockList');
			      if(lowSection && lowList){
			        lowList.innerHTML = reportRowsHtml(d.lowStock, { showThreshold:true, emptyText:'No low stock items.' });
			      }

			      const exemptSection = $('reportExemptSection');
			      const exemptList = $('reportExemptList');
			      if(exemptSection && exemptList){
			        exemptList.innerHTML = reportRowsHtml(d.exemptLowStock, { showThreshold:true, emptyText:'No exempt low stock items.' });
			      }

		      const list = $('reportList');
		      if(list){
		        list.innerHTML = reportRowsHtml(d.inStock, { showThreshold:false, emptyText:'No in-stock items.' });
		      }
		      updateReportOrderBadge();
		    }
		    function downloadInventoryReportCsv(){
		      try{
		        const csv = buildInventoryReportCsv(reportDataSnapshot());
		        const stamp = new Date().toISOString().slice(0,10);
	        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
	        const url = URL.createObjectURL(blob);
	        const a = document.createElement('a');
	        a.href = url;
	        a.download = `inventory-report-${stamp}.csv`;
	        document.body.appendChild(a);
	        a.click();
	        document.body.removeChild(a);
	        URL.revokeObjectURL(url);
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Download failed');
		      }
		    }
		    const MODULUS_LOGO_HORIZONTAL_SVG = `<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2030.96 800">
  <g>
    <polygon points="103.57 382.69 103.76 312.57 161.49 343.09 265.73 288.14 298.02 272.49 298.42 341.25 197.12 395.72 161.56 414.15 103.57 382.69"/>
    <polygon points="87.48 516.09 23.36 481.08 23.4 271.54 87.22 304.49 87.48 516.09"/>
    <path d="M229.31,517.53l-.3-113.92c22.55-12.88,44.55-24.16,68.94-35.85l.13,113.06-68.77,36.71Z"/>
  </g>
  <g>
    <path d="M473.02,438.27l-8.31-31.8c-1.33-5.42-2.29-11.2-2.29-14.33-2.41,4.94-4.94,9.76-11.44,20.96l-9.64,16.5c-4.94,8.79-9.03,10.12-15.78,10.12s-11.08-1.21-16.14-10.12l-10.72-19.27c-6.14-10.84-8.07-14.46-9.88-18.19-.6,3.85-1.57,8.67-2.89,13.73l-8.07,32.4h-27.34l19.51-69.5c2.41-8.43,8.55-12.53,15.66-12.53s11.8,3.73,15.18,9.52l13.25,22.16c7.47,12.41,10,16.74,11.92,20.72,1.93-3.98,4.46-8.19,11.8-20.6l13.25-22.28c3.25-5.54,7.95-9.52,15.3-9.52,6.87,0,13.13,4.1,15.54,12.53,6.38,23.13,12.53,46.38,18.91,69.5h-27.82Z"/>
    <path d="M574.81,439.59c-39.99,0-60.11-12.89-60.11-41.68s20.12-41.56,60.11-41.56,60.23,12.77,60.23,41.56-20.24,41.68-60.23,41.68ZM574.81,379.85c-24.09,0-32.28,2.05-32.28,18.07s8.19,18.19,32.28,18.19,32.4-2.29,32.4-18.19-8.19-18.07-32.4-18.07Z"/>
    <path d="M659.85,438.27v-50.23h27.95v27.1h26.98c12.65,0,21.68-4.7,21.68-17.95,0-10.96-9.52-16.02-21.68-16.02h-54.93l17.71-23.49h37.22c28.67,0,49.39,16.26,49.39,39.51s-20.96,41.07-49.39,41.07h-54.93Z"/>
    <path d="M867.39,357.68h28.07v45.41c0,24.33-16.98,36.5-51.19,36.5-39.39,0-56.37-12.17-56.37-36.5v-45.41h27.82v45.41c0,10.48,3.49,13.37,28.55,13.37,16.98,0,23.13-3.73,23.13-13.37v-45.41Z"/>
    <path d="M921.84,438.27v-80.58h27.82v57.46h61.19l-17.95,23.13h-71.07Z"/>
    <path d="M1109.75,357.68h28.07v45.41c0,24.33-16.98,36.5-51.19,36.5-39.39,0-56.37-12.17-56.37-36.5v-45.41h27.82v45.41c0,10.48,3.49,13.37,28.55,13.37,16.98,0,23.13-3.73,23.13-13.37v-45.41Z"/>
    <path d="M1159.38,438.27l17.95-23.13h60.83c3.61,0,5.66-1.33,5.66-4.22s-2.05-4.21-5.9-4.21h-45.53c-20.84,0-30.35-9.76-30.35-23.37,0-16.26,10.12-25.66,35.29-25.66h71.07l-17.95,23.49h-55.77c-3.73,0-5.66.96-5.66,3.86s1.93,3.97,5.66,3.97h45.77c19.51,0,30.23,7.59,30.23,22.28,0,16.62-7.95,26.98-32.88,26.98h-78.42Z"/>
  </g>
  <g>
    <path d="M1359.68,388.44c-3.08-3.95-7.47-6.07-16.09-6.07-7.08,0-12.96,1.45-12.96,6.02,0,3.42,3.18,4.38,14.75,5.45,10.65.96,19.85,1.25,19.85,10.02,0,9.2-10.12,11.37-18.79,11.37-11.85,0-18.41-4.05-21.49-9.11l3.9-1.78c3.42,4.34,8.14,7.04,17.69,7.04,7.85,0,13.83-1.83,13.83-7.13,0-4.14-3.61-4.96-15.66-6.07-10.55-1.01-18.89-1.45-18.89-9.35,0-8.43,9.78-10.36,18.02-10.36,11.42,0,17.01,3.71,19.81,8.24l-3.95,1.74Z"/>
    <path d="M1381.45,396.87c0-10.12,7.47-18.41,22.7-18.41s22.79,8.29,22.79,18.41-7.57,18.36-22.79,18.36-22.7-8.24-22.7-18.36ZM1422.08,396.87c0-8.29-6.12-14.5-17.93-14.5s-17.83,6.22-17.83,14.5,6.02,14.46,17.83,14.46,17.93-6.22,17.93-14.46Z"/>
    <path d="M1446.26,414.12v-34.46h31.71v3.9h-27.13v11.9h17.01v3.9h-17.01v14.75h-4.58Z"/>
    <path d="M1507.02,414.12v-30.55h-16.58v-3.9h37.68v3.9h-16.53v30.55h-4.58Z"/>
    <path d="M1540.8,379.66h5.06l11.28,27.42,10.55-27.42h2.89l10.5,27.32,11.28-27.32h4.72l-14.65,34.46h-2.89l-10.65-27.52-10.55,27.52h-2.89l-14.65-34.46Z"/>
    <path d="M1611.82,414.12h-4.96l18.94-34.46h3.18l18.94,34.46h-5.54l-5.01-9.4h-20.53l-5.01,9.4ZM1618.95,400.82h16.29l-8.14-15.23-8.14,15.23Z"/>
    <path d="M1702.84,414.12c-1.49.53-2.79.87-4.72.87-13.3,0-7.13-16.48-18.84-16.48h-9.98v15.61h-4.58v-34.46h23.23c7.71,0,13.16,3.18,13.16,9.4s-5.59,9.35-13.16,9.35h-.29v.1c5.83,3.57,4.67,12.24,11.37,12.24,1.11,0,2.6-.24,3.81-.58v3.95ZM1669.3,383.57v11.04h19.13c4.05,0,7.85-1.4,7.85-5.54s-3.81-5.49-7.85-5.49h-19.13Z"/>
    <path d="M1721.53,414.12v-34.46h31.71v3.9h-27.13v10.94h17.01v3.9h-17.01v11.8h29.35v3.9h-33.92Z"/>
    <path d="M1781.13,413.15c0,5.01-3.52,9.98-8.38,9.98v-2.6c1.88-.38,4.82-2.36,4.82-6.41h-5.01v-5.06h8.58v4.1Z"/>
    <path d="M1829.65,379.66h4.58v30.55h25.64v3.9h-30.21v-34.46Z"/>
    <path d="M1877.11,379.66h4.58v30.55h25.64v3.9h-30.21v-34.46Z"/>
    <path d="M1962.83,406.89c-2.55,2.75-7.85,8.34-20.29,8.34-15.13,0-22.65-8.24-22.65-18.36s7.52-18.41,22.79-18.41c12.58,0,17.68,5.59,19.56,7.42l-3.42,2.65c-4.14-3.37-7.95-6.17-16.43-6.17-11.85,0-17.68,6.26-17.68,14.46s6.02,14.5,17.97,14.5c9.01,0,12.96-3.52,16.72-7.08l3.42,2.65Z"/>
  </g>
</svg>`;
		    function buildModulusLogoHtml({ width = 220, color = '#111', marginTop = 18 } = {}){
		      const svg = MODULUS_LOGO_HORIZONTAL_SVG.replace(
		        '<svg ',
		        `<svg role="img" aria-label="Modulus Software, LLC" fill="currentColor" style="width:${width}px;height:auto;display:block;" `
		      );
		      return `<div style="margin-top:${marginTop}px;display:flex;justify-content:center;color:${color};">${svg}</div>`;
		    }
		    function inventoryReportEmailTableHtml(items, opts = {}){
		      const rows = Array.isArray(items) ? items : [];
		      const showThreshold = !!opts.showThreshold;

		      const th = (label, alignRight) => (
		        `<th style="padding:10px;border:1px solid #d0d7de;${alignRight ? 'text-align:right;' : 'text-align:left;'}background:#f6f8fa;font-size:12px;text-transform:uppercase;letter-spacing:.06em;">${label}</th>`
		      );
		      const td = (value, alignRight, extra = '') => (
		        `<td style="padding:10px;border:1px solid #d0d7de;${alignRight ? 'text-align:right;font-variant-numeric:tabular-nums;font-weight:700;' : 'text-align:left;'}${extra}">${value}</td>`
		      );

		      let html = `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;">`;
		      html += `<thead><tr>`;
		      html += th('Item', false);
		      html += th('Description', false);
		      html += th('Qty', true);
		      if(showThreshold) html += th('Low', true);
		      html += `</tr></thead><tbody>`;

		      for(const it of rows){
		        const name = escapeHtml(it && it.name ? it.name : '');
		        const descRaw = String(it && it.desc ? it.desc : '').replace(/[\r\n]+/g,' ').trim();
		        const desc = escapeHtml(descRaw);
		        const qty = toInt(it && it.qty, 0);
		        html += `<tr>`;
		        html += td(`<strong>${name}</strong>`, false, 'word-break:break-word;overflow-wrap:anywhere;');
		        html += td(desc, false, 'word-break:break-word;overflow-wrap:anywhere;');
		        html += td(String(qty), true, '');
		        if(showThreshold){
		          const thr = effectiveLowStockQty(it);
		          html += td(String(toInt(thr,0)), true, '');
		        }
		        html += `</tr>`;
		      }

		      html += `</tbody></table>`;
		      return html;
		    }
		    function buildInventoryReportEmailHtml(data){
		      const d = data || reportDataSnapshot();
		      const when = formatEasternDateTime(new Date());
		      const global = getGlobalLowStockQty();

		      const metricsRow = (label, val) => (
		        `<tr>`+
		          `<td style="padding:8px 10px;border:1px solid #d0d7de;background:#f6f8fa;font-weight:700;">${label}</td>`+
		          `<td style="padding:8px 10px;border:1px solid #d0d7de;text-align:right;font-variant-numeric:tabular-nums;font-weight:800;">${val}</td>`+
		        `</tr>`
		      );

		      const metricsTable =
		        `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;margin:12px 0 18px;">`+
		          `<tbody>`+
		            metricsRow('Total Items', String(d.totalItems))+
		            metricsRow('In Stock', String(d.inStockCount))+
		            metricsRow('Low Stock', String(d.lowStockCount))+
		            metricsRow('Total Qty', String(d.totalQty))+
		          `</tbody>`+
		        `</table>`;

		      const lowStockBlock = d.lowStock && d.lowStock.length
		        ? (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Low Stock Items</div>`+
		            inventoryReportEmailTableHtml(d.lowStock, { showThreshold:true })+
		          `</div>`
		        )
		        : '';

		      const inventoryBlock = d.inStock && d.inStock.length
		        ? (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Current Inventory</div>`+
		            inventoryReportEmailTableHtml(d.inStock, { showThreshold:false })+
		          `</div>`
		        )
		        : (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Current Inventory</div>`+
		            `<div style="color:#57606a;">No in-stock items.</div>`+
		          `</div>`
		        );

		      const brandLogo = buildModulusLogoHtml({ width: 220, color: '#111', marginTop: 18 });
		      const brandLine = `<div style="margin-top:8px;font-size:12px;color:#6a737d;text-align:center;">contact@modulus-software.com</div>`;

		      return (
		        `<!doctype html>`+
		        `<html><body style="margin:0;padding:0;background:#ffffff;">`+
		          `<div style="max-width:760px;margin:0 auto;padding:18px 16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.35;">`+
		            `<h2 style="margin:0 0 10px;font-size:18px;">Inventory Report</h2>`+
		            `<div style="font-size:13px;color:#444;margin:0 0 6px;"><strong>Generated:</strong> ${escapeHtml(when)}</div>`+
		            `${metricsTable}`+
		            `${lowStockBlock}`+
		            `${inventoryBlock}`+
		            `${brandLogo}`+
		            `${brandLine}`+
		          `</div>`+
		        `</body></html>`
		      );
		    }

		    let _reportEmailHtml = '';
		    function setReportEmailMessage(msg){
		      const el = $('reportEmailMsg');
		      if(el) el.textContent = String(msg || '');
		    }
		    function renderReportEmailPreview(html){
		      const wrap = $('reportEmailPreview');
		      if(!wrap) return;
		      const safe = String(html || '').replace(/"/g, '&quot;');
		      wrap.innerHTML = `<iframe srcdoc="${safe}" sandbox="allow-same-origin"></iframe>`;
		    }
		    function defaultInventoryReportEmailSubject(){
		      const stamp = new Date().toISOString().slice(0,10);
		      return `Inventory Report (${stamp})`;
		    }
		    function openReportEmailModal(){
		      const data = reportDataSnapshot();
		      _reportEmailHtml = buildInventoryReportEmailHtml(data);
		      const to = $('reportEmailTo');
		      const subject = $('reportEmailSubject');
		      if(subject) subject.value = defaultInventoryReportEmailSubject();
		      if(to && !String(to.value || '').trim()){
		        const signed = getSignedInEmail();
		        if(signed) to.value = signed;
		      }
		      renderReportEmailPreview(_reportEmailHtml);
		      setReportEmailMessage('');
		      show('reportEmailModal', true);
		    }
		    function closeReportEmailModal(){
		      show('reportEmailModal', false);
		      setReportEmailMessage('');
		    }
		    async function sendInventoryReportEmailViaApi({ toEmail, subjectLine, html }){
		      const to = String(toEmail || '').trim();
		      const subject = String(subjectLine || '').trim() || defaultInventoryReportEmailSubject();
		      const replyTo = getSignedInEmail();
		      const apiUrl = getOrderApiUrl();

		      const headers = { 'content-type': 'application/json' };
		      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
		      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
		      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
		        headers['apikey'] = sbKey;
		        if(SB.session && SB.session.access_token){
		          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
		        }
		      }

		      const res = await fetch(apiUrl, {
		        method: 'POST',
		        headers,
		        body: JSON.stringify({ to, subject, html: String(html || ''), replyTo }),
		      });
		      let data = null;
		      try { data = await res.json(); } catch {}
		      if(!res.ok || !data || data.ok !== true){
		        const msg = (data && data.error) ? String(data.error) : `Send failed (${res.status})`;
		        throw Object.assign(new Error(msg), { status: res.status, data });
		      }
		      return data;
		    }

		    async function shareInventoryReport(){
		      openReportEmailModal();
		    }
		    function lowStockAlertsSilenced(){
		      try{
		        if(SB && SB.profile && typeof SB.profile.silence_low_stock_alerts !== 'undefined'){
		          return !!SB.profile.silence_low_stock_alerts;
		        }
	      }catch(e){}
	      try{
	        const raw = localStorage.getItem('inv.pref.silenceLowStockAlerts');
	        return raw === '1' || raw === 'true';
		      }catch(e){ return false; }
		    }
		    let _reportLoadToken = 0;
		    function setReportLoading(isLoading){
		      const prog = $('reportProgress');
		      const content = $('reportContent');
		      if(prog) prog.style.display = isLoading ? 'block' : 'none';
		      if(content) content.style.display = isLoading ? 'none' : 'block';
		    }
		    function setReportProgress(progress, label){
		      const p = Math.max(0, Math.min(100, Math.round(Number(progress) || 0)));
		      const labelEl = $('reportProgressLabel');
		      const valueEl = $('reportProgressValue');
		      const barEl = $('reportProgressBar');
		      const trackEl = $('reportProgress')?.querySelector('.report-progress-track');
		      if(labelEl && typeof label === 'string') labelEl.textContent = label;
		      if(valueEl) valueEl.textContent = `${p}%`;
		      if(barEl) barEl.style.width = `${p}%`;
		      if(trackEl) trackEl.setAttribute('aria-valuenow', String(p));
		    }
		    function simulateReportProgress(token){
		      let progress = 0;
		      const baseMs = 1000;
		      const phaseOneTarget = 40 + Math.random() * 10; // 40–50%
		      let phaseTwo = false;
		      let label = 'Analyzing Low Stock Items...';
		      const start = performance.now();
		      setReportProgress(0, label);

		      const tick = () => {
		        if(token !== _reportLoadToken) return;
		        const modal = $('reportModal');
		        if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;

		        const elapsed = performance.now() - start;
		        const timeCap = Math.min(100, (elapsed / baseMs) * 100 + 12);
		        const increment = (Math.random() * 9) + 3; // 3–12%
		        progress = Math.min(progress + increment, timeCap, 100);

		        if(!phaseTwo && progress >= phaseOneTarget){
		          phaseTwo = true;
		          label = 'Generating Current Inventory...';
		        }
		        setReportProgress(progress, label);

		        if(progress >= 100 || elapsed >= baseMs){
		          setReportProgress(100, label);
		          finishReportLoad(token);
		          return;
		        }

		        let delay = (Math.random() * 100) + 50; // 50–150ms
		        if(Math.random() < 0.14) delay += (Math.random() * 250) + 200; // occasional pause
		        setTimeout(tick, delay);
		      };
		      tick();
		    }
			    function finishReportLoad(token){
			      if(token !== _reportLoadToken) return;
			      setReportLoading(false);
			      renderInventoryReport();
			      const lowSection = $('reportLowStockSection'); if(lowSection) lowSection.open = false;
			      const exemptSection = $('reportExemptSection'); if(exemptSection) exemptSection.open = false;
			      const invSection = $('reportInventorySection'); if(invSection) invSection.open = false;
			      try{ syncReportOrderIndicators(); }catch(e){}
			    }
			    function startReportLoad(){
			      _reportLoadToken++;
			      const token = _reportLoadToken;
			      setReportLoading(true);
			      const lowSection = $('reportLowStockSection'); if(lowSection) lowSection.open = false;
			      const exemptSection = $('reportExemptSection'); if(exemptSection) exemptSection.open = false;
			      const invSection = $('reportInventorySection'); if(invSection) invSection.open = false;
			      simulateReportProgress(token);
			    }
				    function openReportModal(){
				      show('reportModal', true);
				      startReportLoad();
				    }
		    function closeReportModal(){
		      _reportLoadToken++;
		      show('reportModal', false);
		    }

	    // ========================
	    // Order engine (email-based)
	    // ========================
	    function getSignedInEmail(){
      return (SB && SB.user && SB.user.email) ? String(SB.user.email).trim() : '';
    }
    function userNameFromEmail(email){
      const e = String(email || '').trim();
      const local = e.includes('@') ? e.split('@')[0] : e;
      const cleaned = local
        .replace(/[._-]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      if(!cleaned) return '';
      return cleaned
        .split(' ')
        .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : '')
        .join(' ')
        .trim();
    }
    function formatStateToken(token){
      const t = String(token || '').trim().replace(/[.,]$/,'');
      if(!t) return '';
      if(t.length === 2) return t.toUpperCase();
      return t
        .split(/[\s_-]+/)
        .map(w => w ? (w[0].toUpperCase() + w.slice(1).toLowerCase()) : '')
        .join(' ')
        .trim();
    }
    function formatEasternDateTime(value){
      const d = (value instanceof Date) ? value : new Date(value);
      try{
        return new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/New_York',
          year: 'numeric',
          month: 'short',
          day: '2-digit',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true,
          timeZoneName: 'short',
        }).format(d);
      }catch{
        return d.toLocaleString(undefined, { hour12:true });
      }
    }
	    function getOrderCompanyName(){
	      const name = SB && SB.company && SB.company.company_name ? String(SB.company.company_name).trim() : '';
	      return name;
	    }
	    function generateInternalPoNumber(){
	      const seed = Math.random().toString(36).slice(2, 8).toUpperCase();
	      const stamp = new Date().toISOString().slice(2,10).replace(/-/g, '');
	      return `PO-${stamp}-${seed}`;
	    }
	    function ensureOrderIdentifiers(ord){
	      if(!ord) return;
	      if(!ord.internalPoNumber) ord.internalPoNumber = generateInternalPoNumber();
	    }
	    function getOrderIdentifier(ord){
	      if(!ord) return '';
	      const companyPo = String(ord.companyPoNumber || '').trim();
	      if(companyPo) return companyPo;
	      ensureOrderIdentifiers(ord);
	      return String(ord.internalPoNumber || '').trim();
	    }
	    function composeOrderSubject(ord){
	      const companyName = getOrderCompanyName();
	      if(!companyName) return '';
	      const po = getOrderIdentifier(ord);
	      return po ? `Purchase Order ${po} \u2013 ${companyName}` : `Purchase Order \u2013 ${companyName}`;
	    }
    function orderActiveLines(){
      const ord = orderState();
      return ord.lines
        .filter(l => toInt(l.qty, 0) > 0)
        .slice()
        .sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
    }
    function orderState(){
      if(!state._order){
        state._order = { lines:[], email:'', companyPoNumber:'', internalPoNumber:'', subject:'', notes:'', contactName:'', search:'', shippingAddressId:'', shippingAddressSnapshot:null };
      }
      ensureOrderIdentifiers(state._order);
      return state._order;
    }
    function resetOrderIdentifiers(){
      const ord = orderState();
      ord.companyPoNumber = '';
      ord.internalPoNumber = generateInternalPoNumber();
      ord.subject = composeOrderSubject(ord);
    }
    const orderLineSelection = new Set();
    function pruneOrderLineSelection(lines){
      const ids = new Set((lines || []).map(l => String(l && l.id ? l.id : '').trim()).filter(Boolean));
      for(const id of Array.from(orderLineSelection)){
        if(!ids.has(id)) orderLineSelection.delete(id);
      }
    }
    function orderLineSelectedIds(){
      return Array.from(orderLineSelection);
    }
    function setOrderLineSelected(id, selected){
      const key = String(id || '').trim();
      if(!key) return;
      if(selected) orderLineSelection.add(key);
      else orderLineSelection.delete(key);
    }
    function updateOrderCounterBadge(){
      const ord = orderState();
      const count = ord.lines.length;
      // Update new main pill (below totals)
      const pillContainer = $('orderPillContainer');
      const pillValue = $('orderPillValue');
      const pill = $('orderPill');
      if(pillContainer){
        if(count > 0){
          pillContainer.style.display = 'flex';
          if(pillValue) pillValue.textContent = String(count);
          const labelEl = pill && pill.querySelector('.order-pill-label');
          if(labelEl) labelEl.textContent = count === 1 ? 'Item in Cart' : 'Items in Cart';
        }else{
          pillContainer.style.display = 'none';
        }
      }
      try{
        const modal = $('reportModal');
        const content = $('reportContent');
        if(modal && modal.getAttribute('aria-hidden') === 'false' && content && content.style.display !== 'none'){
          renderInventoryReport();
        }else{
          syncReportOrderIndicators();
        }
      }catch(e){}
    }
    function clearAllOrderLines(){
      const ord = orderState();
      const ids = ord.lines.map(l => l.id);
      ord.lines = [];
      try{ orderLineSelection.clear(); }catch(e){}
      ids.forEach(id => { try{ syncOrderIndicatorForRow(String(id)); }catch(e){} });
      updateOrderCounterBadge();
    }
    function getInventoryById(id){
      return state.items.find(x => x && x.id === id) || null;
    }
    function getOrderQtyForItem(id){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      return line ? toInt(line.qty, 0) : 0;
    }
	    function upsertOrderLineFromItem(it, qty = 1){
	      const ord = orderState();
	      if(!it || !it.id) return false;
	      if(ord.lines.some(l => l.id === it.id)) return false;
	      ord.lines.push({ id: it.id, name: String(it.name||'').trim(), desc: String(it.desc||'').trim(), qty: toInt(qty, 1) });
	      ord.lines.sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
	      try{ syncOrderIndicatorForRow(String(it.id)); }catch(e){}
	      try{ updateOrderCounterBadge(); }catch(e){}
	      return true;
	    }
	    function removeOrderLine(id){
	      const ord = orderState();
	      ord.lines = ord.lines.filter(l => l.id !== id);
	      try{ orderLineSelection.delete(String(id || '').trim()); }catch(e){}
	      try{ syncOrderIndicatorForRow(String(id)); }catch(e){}
	      try{ updateOrderCounterBadge(); }catch(e){}
	    }
    function setOrderQty(id, qty){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      if(!line) return;
      line.qty = toInt(qty, 0);
    }
    function normalizeEmailLineItems(lineItems){
      const arr = Array.isArray(lineItems) ? lineItems : [];
      return arr
        .map((x) => {
          const item_id = String(x?.item_id || x?.itemId || x?.id || '').trim();
          const part = String(x?.part || x?.name || x?.item || '').trim();
          const desc = String(x?.desc || x?.description || '').trim();
          const qty = toInt(x?.qty, 0);
          return { item_id, part, desc, qty };
        })
        .filter((x) => x.part && x.qty > 0)
        .sort((a,b)=> toKey(a.part).localeCompare(toKey(b.part)));
    }
    function normalizeShippingSnapshot(value){
      if(!value || typeof value !== 'object') return null;
      const label = String(value.label || '').trim();
      const address = String(value.address || '').trim();
      if(!label && !address) return null;
      return { label, address };
    }
    function formatShippingSnapshotLines(value){
      const snap = normalizeShippingSnapshot(value);
      if(!snap) return [];
      const lines = [];
      if(snap.label) lines.push(snap.label);
      if(snap.address) lines.push(snap.address);
      return lines;
    }
    function buildOrderBodyFromData({ subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim();
      const out = [];

      out.push(subject);
      out.push(`Date: ${when}`);
      if(companyName) out.push(`Company: ${companyName}`);
      if(companyPoNumber) out.push(`Company PO: ${companyPoNumber}`);
      if(internalPoNumber) out.push(`Internal PO: ${internalPoNumber}`);
      out.push('');
      out.push('Items:');
      out.push('');

      const active = normalizeEmailLineItems(lineItems);
      if(!active.length){
        out.push('(none)');
      }else{
        const parts = active.map(l => String(l.part||'').trim());
        const descs = active.map(l => String(l.desc||'').trim());
        const partW = Math.min(25, Math.max(4, ...parts.map(p => p.length)));
        const descW = Math.min(35, Math.max(11, ...descs.map(d => d.length)));
        const qtyW = Math.min(6, Math.max(3, ...active.map(l => String(toInt(l.qty, 0)).length)));
        out.push(`${'Item'.padEnd(partW)} | ${'Description'.padEnd(descW)} | ${'Qty'.padStart(qtyW)}`);
        out.push(`${'-'.repeat(partW)}-+-${'-'.repeat(descW)}-+-${'-'.repeat(qtyW)}`);
        for(const l of active){
          const part = String(l.part||'').replace(/\t/g,' ').trim();
          const desc = String(l.desc||'').replace(/\t/g,' ').trim();
          const qty = String(toInt(l.qty, 0)).padStart(qtyW, ' ');
          out.push(`${part.padEnd(partW)} | ${desc.padEnd(descW)} | ${qty}`);
        }
      }

      const nt = String(notes||'').trim();
      if(nt){
        out.push('');
        out.push('Notes:');
        out.push(nt);
      }

      // Add sender info from profile
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const deliveryLines = [];
      if(fullName) deliveryLines.push(fullName);
      if(userPhone) deliveryLines.push(userPhone);
      if(userEmail) deliveryLines.push(userEmail);

      if(deliveryLines.length){
        out.push('');
        out.push('Contact:');
        for(const line of deliveryLines) out.push(line);
      }

      const shippingLines = formatShippingSnapshotLines(shippingAddress);
      if(shippingLines.length){
        out.push('');
        out.push('Shipping Address:');
        for(const line of shippingLines) out.push(line);
      }

      out.push('');
      out.push('contact@modulus-software.com');
      return out.join('\n');
    }
    function buildOrderHtmlFromData({ subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim();

      const active = normalizeEmailLineItems(lineItems);
      const rows = active.map(l=>{
        const part = escapeHtml(String(l.part||'').trim());
        const desc = escapeHtml(String(l.desc||'').trim());
        const qty = toInt(l.qty, 0);
        return (
          `<tr>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;font-weight:600;">${part}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;">${desc}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;text-align:right;font-variant-numeric:tabular-nums;font-weight:700;">${qty}</td>`+
          `</tr>`
        );
      }).join('');

      const notesRaw = String(notes||'').trim();
      const notesHtml = notesRaw ? escapeHtml(notesRaw).replace(/\n/g, '<br>') : '';

      // Build contact + shipping blocks
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const contactLines = [];
      if(fullName) contactLines.push(escapeHtml(fullName));
      if(userPhone) contactLines.push(escapeHtml(userPhone));
      if(userEmail) contactLines.push(`<a href="mailto:${escapeHtmlAttr(userEmail)}" style="color:#0969da;text-decoration:underline;">${escapeHtml(userEmail)}</a>`);

      const contactBlock = contactLines.length
        ? (
          `<div style="margin:16px 0 16px;padding:12px;background:#f6f8fa;border:1px solid #d0d7de;border-radius:6px;">`+
            `<div style="font-weight:700;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Contact</div>`+
            `<div style="font-size:14px;line-height:1.5;">${contactLines.join('<br>')}</div>`+
          `</div>`
        )
        : '';

      const shippingLines = formatShippingSnapshotLines(shippingAddress);
      const shippingBlock = shippingLines.length
        ? (
          `<div style="margin:16px 0 16px;padding:12px;background:#f6f8fa;border:1px solid #d0d7de;border-radius:6px;">`+
            `<div style="font-weight:700;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Shipping Address</div>`+
            `<div style="font-size:14px;line-height:1.5;">${shippingLines.map(l => escapeHtml(l).replace(/\\n/g, '<br>')).join('<br>')}</div>`+
          `</div>`
        )
        : '';

      const metaLines = [];
      if(companyName) metaLines.push(`<div><strong>Company:</strong> ${escapeHtml(companyName)}</div>`);
      if(companyPoNumber) metaLines.push(`<div><strong>Company PO:</strong> ${escapeHtml(companyPoNumber)}</div>`);
      if(internalPoNumber) metaLines.push(`<div><strong>Internal PO:</strong> ${escapeHtml(internalPoNumber)}</div>`);
      const metaBlock = metaLines.length
        ? `<div style="margin:12px 0 0;font-size:14px;line-height:1.5;">${metaLines.join('')}</div>`
        : '';

      const notesBlock = notesHtml
        ? (
          `<div style="margin-top:16px;">`+
            `<div style="font-weight:700;margin-bottom:6px;">Notes</div>`+
            `<div>${notesHtml}</div>`+
          `</div>`
        )
        : '';

      const itemsBlock = active.length
        ? (
          `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;table-layout:fixed;">`+
            `<colgroup>`+
              `<col style="width:35%;">`+
              `<col style="width:50%;">`+
              `<col style="width:15%;">`+
            `</colgroup>`+
            `<thead>`+
              `<tr>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Item</th>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Description</th>`+
                `<th align="right" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Qty</th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>${rows}</tbody>`+
          `</table>`
        )
        : `<div style="padding:12px;border:1px dashed #d0d7de;color:#444;">(No items)</div>`;

      const brandLogo = buildModulusLogoHtml({ width: 200, color: '#111', marginTop: 18 });
      const brandLine = `<div style="margin-top:8px;font-size:12px;color:#6a737d;text-align:center;">contact@modulus-software.com</div>`;

      return (
        `<!doctype html>`+
        `<html><body style="margin:0;padding:0;background:#ffffff;">`+
        `<div style="max-width:620px;margin:0 auto;padding:18px 16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.35;">`+
          `<h2 style="margin:0 0 10px;font-size:18px;">${escapeHtml(subject)}</h2>`+
          `<div style="font-size:13px;color:#444;margin:0 0 16px;">`+
            `<div style="margin:2px 0;"><strong>Date:</strong> ${escapeHtml(when)}</div>`+
            `${metaBlock}`+
          `</div>`+
          `<div style="margin:0 0 10px;">Please supply the following materials:</div>`+
          `${itemsBlock}`+
          `${notesBlock}`+
          `${contactBlock}`+
          `${shippingBlock}`+
          `${brandLogo}`+
          `${brandLine}`+
        `</div>`+
        `</body></html>`
      );
    }
    function looksLikeEmailAddress(email){
      const s = String(email || '').trim();
      if(!s) return false;
      if(s.length > 254) return false;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    }
    function getOrderShippingSnapshot(ord){
      if(!ord) return null;
      const direct = normalizeShippingSnapshot(ord.shippingAddressSnapshot);
      if(direct) return direct;
      const id = String(ord.shippingAddressId || '').trim();
      if(!id) return null;
      const row = state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
        ? state._shippingAddressById.get(id)
        : null;
      if(!row) return null;
      return normalizeShippingSnapshot({ label: row.label, address: row.address });
    }
    function buildOrderBody(){
      const ord = orderState();
      const subjectLine = composeOrderSubject(ord);
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shippingAddress = getOrderShippingSnapshot(ord);
      const companyName = getOrderCompanyName();
      const companyPoNumber = String(ord.companyPoNumber||'').trim();
      const internalPoNumber = String(ord.internalPoNumber||'').trim();
      return buildOrderBodyFromData({ subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
    }
    function buildOrderHtml(){
      const ord = orderState();
      const subjectLine = composeOrderSubject(ord);
      const notesRaw = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shippingAddress = getOrderShippingSnapshot(ord);
      const companyName = getOrderCompanyName();
      const companyPoNumber = String(ord.companyPoNumber||'').trim();
      const internalPoNumber = String(ord.internalPoNumber||'').trim();
      return buildOrderHtmlFromData({ subjectLine, notes: notesRaw, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
    }
    function buildMailtoUrl(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const subject = composeOrderSubject(ord);
      const body = buildOrderBody();
      if(!to) return '';
      return `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    function getOrderApiUrl(){
      // Allow explicit override via window.ORDER_API_URL
      const override = (typeof window.ORDER_API_URL === 'string') ? window.ORDER_API_URL.trim() : '';
      if(override) return override;
      // Use Supabase Edge Function if available
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/send-order`;
      // Fallback to local dev server
      return '/api/send-order';
    }
    async function sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber }){
      const toEmail = String(to||'').trim();
      const replyTo = getSignedInEmail();
      const subject = String(subjectLine||'').trim();
      const text = buildOrderBodyFromData({ subjectLine: subject, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
      const html = buildOrderHtmlFromData({ subjectLine: subject, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
      const apiUrl = getOrderApiUrl();

      // Build headers - include Supabase auth if using Edge Function
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        // Add auth token if user is signed in
        if(SB.session && SB.session.access_token){
          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
        }
      }

      const payload = {
        to: toEmail,
        subject,
        text,
        html,
        replyTo,
      };
      if(SB.companyId){
        payload.company_id = SB.companyId;
      }

      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload),
      });
      let data = null;
      try { data = await res.json(); } catch {}
      if(!res.ok || !data || data.ok !== true){
        const msg = (data && data.error) ? String(data.error) : `Send failed (${res.status})`;
        throw Object.assign(new Error(msg), { status: res.status, data });
      }
      return data;
    }
    async function sendOrderViaApi(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const companyName = getOrderCompanyName();
      if(!companyName) throw new Error('Company name is required to send orders');
      const subjectLine = composeOrderSubject(ord);
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shippingAddress = getOrderShippingSnapshot(ord);
      const companyPoNumber = String(ord.companyPoNumber||'').trim();
      const internalPoNumber = String(ord.internalPoNumber||'').trim();
      return sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
    }
    async function copyText(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return;
      }
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position='fixed';
      ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
    async function copyOrderToClipboard(){
      try{
        await copyText(buildOrderBody());
        toast('Copied order text');
      }catch{
        toast('Copy failed');
      }
    }

    function setShippingAddressMessage(msg){
      const el = $('shippingAddressMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function clearShippingAddressForm(){
      state._shippingAddressEditing = null;
      const label = $('shippingAddressLabel'); if(label) label.value = '';
      const address = $('shippingAddressValue'); if(address) address.value = '';
      const isDefault = $('shippingAddressDefault'); if(isDefault) isDefault.checked = false;
      const title = $('shippingAddressFormTitle'); if(title) title.textContent = 'Add Shipping Address';
      setShippingAddressMessage('');
    }
    function renderShippingAddressList(){
      const list = $('shippingAddressList');
      if(!list) return;
      const rows = Array.isArray(state._shippingAddresses) ? state._shippingAddresses : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No shipping addresses yet.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const id = String(row.id || '').trim();
        const label = String(row.label || '').trim();
        const address = String(row.address || '').trim();
        const isDefault = !!row.is_default;
        const meta = [isDefault ? 'Default' : '', id ? `ID: ${id.slice(0,8)}` : ''].filter(Boolean).join(' · ');
        return (
          `<div class="shipping-address-card" data-shipping-id="${escapeHtmlAttr(id)}">`+
            `<div>`+
              `<div style="font-weight:700;">${escapeHtml(label || 'Address')}</div>`+
              `<div class="shipping-address-meta">${escapeHtml(meta)}</div>`+
              `<div style="margin-top:6px;white-space:pre-wrap;">${escapeHtml(address)}</div>`+
            `</div>`+
            `<div class="shipping-address-actions">`+
              `<button class="btn small" type="button" data-shipping-edit="${escapeHtmlAttr(id)}">Edit</button>`+
              `<button class="btn small danger" type="button" data-shipping-delete="${escapeHtmlAttr(id)}">Delete</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    function renderShippingAddressSelect(){
      const select = $('orderShippingAddress');
      if(!select) return;
      const rows = Array.isArray(state._shippingAddresses) ? state._shippingAddresses : [];
      select.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = rows.length ? 'Select shipping address' : 'No shipping addresses';
      placeholder.disabled = !rows.length;
      select.appendChild(placeholder);
      rows.forEach(row => {
        const id = String(row && row.id ? row.id : '').trim();
        if(!id) return;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = String(row.label || row.address || id).trim();
        select.appendChild(opt);
      });
      const ord = orderState();
      if(ord.shippingAddressId && !rows.some(r => String(r.id) === String(ord.shippingAddressId))){
        ord.shippingAddressId = '';
        ord.shippingAddressSnapshot = null;
      }
      if(!ord.shippingAddressId && rows.length){
        const def = rows.find(r => r && r.is_default) || rows[0];
        ord.shippingAddressId = def ? String(def.id) : '';
        ord.shippingAddressSnapshot = def ? { label: def.label, address: def.address } : null;
      }
      select.value = ord.shippingAddressId || '';
      const manageBtn = $('btnOrderShippingManage');
      if(manageBtn){
        manageBtn.disabled = !canOrdersManageShipping();
        manageBtn.style.display = canOrdersManageShipping() ? '' : 'none';
      }
    }
    async function sbFetchShippingAddresses(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
      if(!canOrdersView()) return [];
      const { data, error } = await SB.client
        .from('company_shipping_addresses')
        .select('id,label,address,is_default,created_at,updated_at')
        .eq('company_id', SB.companyId)
        .order('is_default', { ascending:false })
        .order('label', { ascending:true });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function loadShippingAddresses(){
      const rows = await sbFetchShippingAddresses();
      state._shippingAddresses = rows;
      state._shippingAddressById = new Map(rows.map(r => [String(r.id || '').trim(), r]).filter(x => x[0]));
      renderShippingAddressSelect();
      renderShippingAddressList();
    }
    async function openShippingAddressModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!canOrdersManageShipping()){ toast('Shipping address permissions required'); return; }
      clearShippingAddressForm();
      show('shippingAddressModal', true);
      try{ await loadShippingAddresses(); }catch(e){ setShippingAddressMessage(e && e.message ? e.message : 'Failed to load addresses'); }
    }
    function closeShippingAddressModal(){
      show('shippingAddressModal', false);
    }
    async function saveShippingAddress(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
      if(!canOrdersManageShipping()) throw new Error('Permission denied');
      const label = String($('shippingAddressLabel')?.value || '').trim();
      const address = String($('shippingAddressValue')?.value || '').trim();
      const isDefault = !!($('shippingAddressDefault')?.checked);
      if(!label || !address) throw new Error('Label and address are required');
      if(isDefault){
        await SB.client
          .from('company_shipping_addresses')
          .update({ is_default: false })
          .eq('company_id', SB.companyId);
      }
      const payload = {
        company_id: SB.companyId,
        label,
        address,
        is_default: isDefault,
        updated_at: new Date().toISOString(),
        updated_by: SB.user ? SB.user.id : null,
      };
      if(state._shippingAddressEditing){
        payload.id = state._shippingAddressEditing;
      }else{
        payload.created_by = SB.user ? SB.user.id : null;
      }
      const { error } = await SB.client
        .from('company_shipping_addresses')
        .upsert([payload], { onConflict: 'id' });
      if(error) throw error;
      await loadShippingAddresses();
      clearShippingAddressForm();
      renderOrderPreview();
    }
    async function deleteShippingAddress(id){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
      if(!canOrdersManageShipping()) throw new Error('Permission denied');
      const addrId = String(id || '').trim();
      if(!addrId) return;
      const { error } = await SB.client
        .from('company_shipping_addresses')
        .delete()
        .eq('id', addrId)
        .eq('company_id', SB.companyId);
      if(error) throw error;
      await loadShippingAddresses();
      const ord = orderState();
      if(String(ord.shippingAddressId || '') === addrId){
        ord.shippingAddressId = '';
        ord.shippingAddressSnapshot = null;
        renderOrderPreview();
      }
    }

    async function sbFetchOrderRecipientSuggestions(prefix){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
      if(!canOrdersView()) return [];
      const q = String(prefix||'').trim();
      let req = SB.client
        .from('order_recipients')
        .select('email,name,last_used_at')
        .eq('company_id', SB.companyId)
        .order('last_used_at', { ascending:false })
        .limit(20);
      if(q) req = req.ilike('email', q + '%');
      const { data, error } = await req;
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbRecordOrderRecipient(email, name){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
      if(!canOrdersCreate()) throw new Error('Permission denied');
      const e = String(email||'').trim().toLowerCase();
      if(!e) return;
      const row = {
        company_id: SB.companyId,
        email: e,
        last_used_at: new Date().toISOString(),
        created_by: SB.user ? SB.user.id : null,
      };
      const nm = String(name||'').trim();
      if(nm) row.name = nm;
      const { error } = await SB.client
        .from('order_recipients')
        .upsert([row], { onConflict: 'email' });
      if(error) throw error;
    }
    function normalizeOrderLineItems(value){
      const arr = Array.isArray(value) ? value : [];
      return arr
        .map((x) => {
          const item_id = String(x?.item_id || x?.itemId || x?.id || '').trim();
          const part = String(x?.part || x?.name || x?.item || '').trim();
          let desc = String(x?.desc || x?.description || '').trim();
          // Fallback: look up description from inventory if not stored
          if(!desc && part){
            const inv = state.items.find(it => it.name === part);
            if(inv) desc = String(inv.desc || '').trim();
          }
          const qty = toInt(x?.qty, 0);
          return { item_id, part, desc, qty };
        })
        .filter((x) => x.part);
    }
    async function sbInsertOrderHistoryFromData({ toEmail, subjectLine, contactName, notes, lineItems, providerResult, companyPoNumber, internalPoNumber, shippingAddressId, shippingAddressSnapshot }){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.user || !SB.companyId) return;
      if(!canOrdersCreate()) throw new Error('Permission denied');
      const cleaned = normalizeEmailLineItems(lineItems).map(x => ({ item_id: x.item_id ? String(x.item_id).trim() : null, part: x.part, desc: x.desc, qty: x.qty }));
      const row = {
        company_id: SB.companyId,
        created_by: SB.user.id,
        to_email: String(toEmail||'').trim(),
        reply_to_email: String(getSignedInEmail()||'').trim(),
        subject: String(subjectLine||'').trim(),
        contact_name: String(contactName||'').trim(),
        notes: String(notes||'').trim(),
        line_items: cleaned,
        provider_result: providerResult || null,
        company_po_number: String(companyPoNumber||'').trim() || null,
        internal_po_number: String(internalPoNumber||'').trim() || null,
        shipping_address_id: shippingAddressId ? String(shippingAddressId).trim() : null,
        shipping_address_snapshot: shippingAddressSnapshot || null,
      };
      const { error } = await SB.client.from('orders').insert([row]);
      if(error) throw error;
    }
    async function sbInsertOrderHistory(providerResult){
      const ord = orderState();
      const lineItems = orderActiveLines().map(l => ({ item_id: String(l.id || '').trim() || null, part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return sbInsertOrderHistoryFromData({
        toEmail: String(ord.email||'').trim(),
        subjectLine: composeOrderSubject(ord),
        contactName: String(ord.contactName||'').trim(),
        notes: String(ord.notes||'').trim(),
        lineItems,
        providerResult,
        companyPoNumber: String(ord.companyPoNumber||'').trim(),
        internalPoNumber: String(ord.internalPoNumber||'').trim(),
        shippingAddressId: ord.shippingAddressId,
        shippingAddressSnapshot: getOrderShippingSnapshot(ord),
      });
    }
	    async function sbFetchOrders(limit = 50){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
	      if(!canOrdersView()) return [];
	      const lim = Math.max(1, Math.min(200, toInt(limit, 50)));
	      let sel = 'id,created_at,to_email,reply_to_email,subject,contact_name,notes,line_items,internal_po_number,company_po_number,shipping_address_snapshot,shipping_address_id';
	      if(SB.ordersHasReceipt !== false){
	        sel += ',receiving_at,receiving_by,receiving_snapshot,received_at,received_by,received_snapshot,received_undone_at,received_undone_by';
	      }
	      const { data, error } = await SB.client
	        .from('orders')
	        .select(sel)
	        .eq('company_id', SB.companyId)
	        .is('deleted_at', null)
	        .order('created_at', { ascending:false })
	        .limit(lim);
	      if(error){
	        if(SB.ordersHasReceipt !== false && isOrdersReceiptColumnsMissingError(error)){
	          SB.ordersHasReceipt = false;
	          const { data: data2, error: err2 } = await SB.client
	            .from('orders')
	            .select('id,created_at,to_email,reply_to_email,subject,contact_name,notes,line_items,internal_po_number,company_po_number,shipping_address_snapshot,shipping_address_id')
	            .eq('company_id', SB.companyId)
	            .is('deleted_at', null)
	            .order('created_at', { ascending:false })
	            .limit(lim);
	          if(err2) throw err2;
	          return Array.isArray(data2) ? data2 : [];
	        }
	        throw error;
	      }
	      if(sel.includes('received_at')) SB.ordersHasReceipt = true;
	      return Array.isArray(data) ? data : [];
	    }
	    async function sbFetchAllOrders(pageSize = 200){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
	      const size = Math.max(1, Math.min(200, toInt(pageSize, 200)));
	      let offset = 0;
	      const out = [];
	      for(let page=0; page<200; page++){
	        let sel = 'id,created_at,to_email,reply_to_email,subject,contact_name,notes,line_items,internal_po_number,company_po_number,shipping_address_snapshot,shipping_address_id';
	        if(SB.ordersHasReceipt !== false){
	          sel += ',receiving_at,receiving_by,receiving_snapshot,received_at,received_by,received_snapshot,received_undone_at,received_undone_by';
	        }
	        const { data, error } = await SB.client
	          .from('orders')
	          .select(sel)
	          .eq('company_id', SB.companyId)
	          .is('deleted_at', null)
	          .order('created_at', { ascending:false })
	          .range(offset, offset + size - 1);
	        if(error){
	          if(SB.ordersHasReceipt !== false && isOrdersReceiptColumnsMissingError(error)){
	            SB.ordersHasReceipt = false;
	            const { data: data2, error: err2 } = await SB.client
	              .from('orders')
	              .select('id,created_at,to_email,reply_to_email,subject,contact_name,notes,line_items,internal_po_number,company_po_number,shipping_address_snapshot,shipping_address_id')
	              .eq('company_id', SB.companyId)
	              .is('deleted_at', null)
	              .order('created_at', { ascending:false })
	              .range(offset, offset + size - 1);
	            if(err2) throw err2;
	            const rows2 = Array.isArray(data2) ? data2 : [];
	            out.push(...rows2);
	            if(rows2.length < size) break;
	            offset += size;
	            continue;
	          }
	          throw error;
	        }
	        const rows = Array.isArray(data) ? data : [];
	        out.push(...rows);
	        if(rows.length < size) break;
	        offset += size;
	      }
	      return out;
	    }
	    function csvEscape(value){
	      const s = String(value ?? '');
	      return '"' + s.replace(/"/g, '""') + '"';
	    }
	    function orderLineItemsToCsvCell(value){
	      const items = normalizeOrderLineItems(value);
	      if(!items.length) return '';
	      return items
	        .map(it => {
	          const part = String(it.part||'').trim();
	          const qty = String(toInt(it.qty,0));
	          const desc = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
	          return `${part} | ${qty} | ${desc}`;
	        })
	        .join(' ; ');
	    }
	    function buildOrderHistoryCsv(rows){
      const header = [
        'Order ID',
        'Created At (UTC)',
        'Created (Eastern)',
        'To',
        'Reply-To',
        'Subject',
        'Company PO Number',
        'Internal PO ID',
        'Shipping Address',
        'Contact Name',
        'Notes',
        'Item Count',
        'Items',
      ];
	      const out = [header.map(csvEscape).join(',')];
	      const list = Array.isArray(rows) ? rows : [];
	      for(const o of list){
	        const id = String(o?.id || '').trim();
	        const createdAt = String(o?.created_at || '').trim();
	        const createdEastern = formatEasternDateTime(createdAt || new Date());
	        const to = String(o?.to_email || '').trim();
	        const replyTo = String(o?.reply_to_email || '').trim();
        const subject = String(o?.subject || '').trim();
        const companyPo = String(o?.company_po_number || '').trim();
        const internalPo = String(o?.internal_po_number || '').trim();
        const shippingSnap = normalizeShippingSnapshot(o?.shipping_address_snapshot) || null;
        const shippingText = shippingSnap
          ? [shippingSnap.label, shippingSnap.address].filter(Boolean).join(' | ')
          : '';
        const contact = String(o?.contact_name || '').trim();
        const notes = String(o?.notes || '').trim();
        const items = normalizeOrderLineItems(o?.line_items);
        const itemsCell = orderLineItemsToCsvCell(o?.line_items);
        out.push([
          id,
          createdAt,
          createdEastern,
          to,
          replyTo,
          subject,
          companyPo,
          internalPo,
          shippingText,
          contact,
          notes,
          String(items.length),
          itemsCell,
        ].map(csvEscape).join(','));
      }
	      // Add BOM so Excel opens UTF-8 correctly
	      return '\ufeff' + out.join('\n');
	    }
	    async function downloadOrderHistoryCsv(){
	      if(!SB.ready){ toast('Supabase not configured'); return; }
	      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }

	      const btn = $('btnOrderHistoryDownload');
	      const priorTitle = btn ? btn.getAttribute('title') : '';
	      if(btn){ btn.disabled = true; btn.setAttribute('title', 'Downloading…'); }
	      try{
	        toast('Downloading order history…');
	        const rows = await sbFetchAllOrders(200);
	        if(!rows.length){ toast('No orders to download'); return; }
	        const csv = buildOrderHistoryCsv(rows);
	        const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
	        const url = URL.createObjectURL(blob);
	        const a = document.createElement('a');
	        a.href = url;
	        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
	        a.download = `order-history-${stamp}.csv`;
	        document.body.appendChild(a);
	        a.click();
	        document.body.removeChild(a);
	        URL.revokeObjectURL(url);
	        toast(`Downloaded ${rows.length} order(s)`);
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Download failed');
	      }finally{
	        if(btn){ btn.disabled = false; btn.setAttribute('title', priorTitle || 'Download CSV'); }
	      }
	    }
	    async function sbDeleteOrder(orderId){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      if(!canOrdersDelete()) throw new Error('Permission denied');
	      const id = String(orderId || '').trim();
	      if(!id) throw new Error('Invalid order ID');
	      const { data, error } = await SB.client
	        .rpc('soft_delete_order', { p_order_id: id });
	      if(error) throw error;
	      if(data && data.success === false){
	        throw new Error(data.error || 'Delete failed');
	      }
	    }

	    async function deleteOrderFromHistory(orderId, btnEl){
	      const id = String(orderId || '').trim();
	      if(!id) return false;
	      if(!canOrdersDelete()){ toast('Delete not allowed'); return false; }
	      if(!(await openConfirmModal('Delete order?', 'Delete this order from history?', { okText:'Delete', cancelText:'Cancel' }))) return false;
	      if(btnEl) btnEl.disabled = true;
	      try{
	        await sbDeleteOrder(id);
	        try{
	          if(state._orderHistoryById && typeof state._orderHistoryById.delete === 'function'){
	            state._orderHistoryById.delete(id);
	          }
	          if(Array.isArray(state._orderHistoryRows)){
	            state._orderHistoryRows = state._orderHistoryRows.filter(r => String(r && r.id ? r.id : '') !== id);
	          }
	        }catch(e){}
	        renderOrderHistoryFiltered();
	        toast('Order deleted');
	        return true;
	      }catch(err){
	        toast(err && err.message ? err.message : 'Delete failed');
	        if(btnEl) btnEl.disabled = false;
	        return false;
	      }
	    }

	    async function sbUpdateOrder(orderId, fields){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      if(!canOrdersEdit()) throw new Error('Permission denied');
	      const id = String(orderId || '').trim();
	      if(!id) throw new Error('Invalid order ID');
	      const { error } = await SB.client
	        .from('orders')
	        .update(fields || {})
	        .eq('id', id)
	        .eq('company_id', SB.companyId)
	        .is('deleted_at', null);
	      if(error) throw error;
	    }

	    // Order History (mobile): swipe tray state
	    let _openHistoryTrayId = '';
	    function orderHistoryItemElById(orderId){
	      const id = String(orderId || '').trim();
	      if(!id) return null;
	      const list = $('orderHistoryList');
	      if(!list) return null;
	      try{
	        if(window.CSS && CSS.escape){
	          return list.querySelector(`details.history-item[data-order-id="${CSS.escape(id)}"]`) || null;
	        }
	      }catch(e){}
	      const safe = id.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
	      return list.querySelector(`details.history-item[data-order-id="${safe}"]`) || null;
	    }
	    function orderSubjectFromRow(row){
	      const explicit = String(row && row.subject ? row.subject : '').trim();
	      if(explicit) return explicit;
	      const companyName = getOrderCompanyName();
	      const companyPo = String(row && row.company_po_number ? row.company_po_number : '').trim();
	      const internalPo = String(row && row.internal_po_number ? row.internal_po_number : '').trim();
	      const id = companyPo || internalPo || String(row && row.id ? row.id : '').trim();
	      if(companyName && id) return `Purchase Order ${id} \u2013 ${companyName}`;
	      if(companyName) return `Purchase Order \u2013 ${companyName}`;
	      return id ? `Purchase Order ${id}` : 'Purchase Order';
	    }
	    function setHistoryTrayA11y(det, open){
	      const tray = det ? det.querySelector('.history-tray') : null;
	      if(!tray) return;
	      tray.setAttribute('aria-hidden', open ? 'false' : 'true');
	      tray.querySelectorAll('button.history-tray-btn').forEach(btn=>{
	        if(open) btn.removeAttribute('tabindex');
	        else btn.setAttribute('tabindex', '-1');
	      });
	    }
	    function closeHistoryTray(){
	      if(!_openHistoryTrayId) return;
	      const det = orderHistoryItemElById(_openHistoryTrayId);
	      if(det){
	        det.classList.remove('swiping');
	        det.classList.remove('tray-peek');
	        det.classList.remove('tray-open');
	        setRowSwipeX(det, 0);
	        try{ delete det.dataset.traySide; }catch(e){ det.dataset.traySide = ''; }
	        setHistoryTrayA11y(det, false);
	      }
	      _openHistoryTrayId = '';
	    }
	    function closeHistoryTrayElastic(targetDet){
	      const det = targetDet || (_openHistoryTrayId ? orderHistoryItemElById(_openHistoryTrayId) : null);
	      if(det){
	        det.classList.remove('swiping');
	        det.classList.remove('tray-peek');
	        det.classList.remove('tray-open');
	        det.classList.add('snap-elastic');
	        setRowSwipeX(det, 0);
	        try{ delete det.dataset.traySide; }catch(e){ det.dataset.traySide = ''; }
	        setHistoryTrayA11y(det, false);
	        setTimeout(()=>{ try{ det.classList.remove('snap-elastic'); }catch(e){} }, 400);
	      }
	      _openHistoryTrayId = '';
	    }
	    function prepareHistoryTrayForItem(det, side){
	      if(!det) return;
	      const id = String(det.dataset && det.dataset.orderId ? det.dataset.orderId : '').trim();
	      if(!id) return;
	      if(_openHistoryTrayId && _openHistoryTrayId !== id) closeHistoryTray();
	      _openHistoryTrayId = id;
	      det.dataset.traySide = (side === 'left') ? 'left' : 'right';
	      det.classList.remove('tray-open');
	      det.classList.add('tray-peek');
	      setHistoryTrayA11y(det, false);
	    }
	    function openHistoryTrayForItem(det, side){
	      if(!det) return;
	      const id = String(det.dataset && det.dataset.orderId ? det.dataset.orderId : '').trim();
	      if(!id) return;
	      if(_openHistoryTrayId && _openHistoryTrayId !== id) closeHistoryTray();
	      _openHistoryTrayId = id;
	      det.dataset.traySide = (side === 'left') ? 'left' : 'right';
	      det.classList.remove('tray-peek');
	      det.classList.add('tray-open');
	      setHistoryTrayA11y(det, true);
	      const targetX = traySideToSwipeX(det.dataset.traySide);
	      try{ requestAnimationFrame(()=> setRowSwipeX(det, targetX)); }catch(e){ setRowSwipeX(det, targetX); }
	    }

	    function isOrderCurrentlyReceived(orderRow){
	      const rAt = String(orderRow && orderRow.received_at ? orderRow.received_at : '').trim();
	      if(!rAt) return false;
	      const uAt = String(orderRow && orderRow.received_undone_at ? orderRow.received_undone_at : '').trim();
	      if(!uAt) return true;
	      return new Date(uAt).getTime() < new Date(rAt).getTime();
	    }

	    function orderReceiptMetaText(orderRow){
	      if(SB.ordersHasReceipt === false) return '';
	      const o = orderRow || {};
	      const receivingAt = String(o.receiving_at || '').trim();
	      const receivedAt = String(o.received_at || '').trim();
	      if(receivingAt && !receivedAt) return 'Receiving…';
	      if(receivedAt){
	        const undoneAt = String(o.received_undone_at || '').trim();
	        if(undoneAt && new Date(undoneAt).getTime() >= new Date(receivedAt).getTime()) return 'Received (undone)';
	        return 'Received';
	      }
	      return '';
	    }

	    function getOrderHistoryRowById(orderId){
	      const id = String(orderId || '').trim();
	      if(!id) return null;
	      if(state._orderHistoryById && typeof state._orderHistoryById.get === 'function'){
	        const row = state._orderHistoryById.get(id) || null;
	        if(row) return row;
	      }
	      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
	      return rows.find(r => String(r && r.id ? r.id : '').trim() === id) || null;
	    }

	    function patchOrderHistoryRow(orderId, patch){
	      const id = String(orderId || '').trim();
	      if(!id || !patch || typeof patch !== 'object') return;
	      try{
	        const row = getOrderHistoryRowById(id);
	        if(row) Object.assign(row, patch);
	      }catch(e){}
	      try{
	        if(state._orderHistoryById && typeof state._orderHistoryById.get === 'function'){
	          const row2 = state._orderHistoryById.get(id) || null;
	          if(row2) Object.assign(row2, patch);
	        }
	      }catch(e){}
	      try{
	        if(Array.isArray(state._orderHistoryRows)){
	          const i = state._orderHistoryRows.findIndex(r => String(r && r.id ? r.id : '').trim() === id);
	          if(i >= 0 && state._orderHistoryRows[i]) Object.assign(state._orderHistoryRows[i], patch);
	        }
	      }catch(e){}
	    }

	    function setLocalItemQty(itemId, qty){
	      const id = String(itemId || '').trim();
	      if(!id) return;
	      const it = state.items.find(x => x && x.id === id);
	      if(!it) return;
	      it.qty = toInt(qty, 0);
	    }

	    function resolveInventoryItemForOrderLine(line){
	      const storedId = String(line && line.item_id ? line.item_id : '').trim();
	      if(storedId){
	        const byId = getInventoryById(storedId);
	        if(byId) return byId;
	      }
	      const part = String(line && line.part ? line.part : '').trim();
	      const k = toKey(part);
	      if(!k) return null;
	      return state.items.find(it => it && toKey(it.name) === k) || null;
	    }

	    function normalizeReceiptLines(value){
	      const arr = Array.isArray(value) ? value : [];
	      return arr
	        .map((x) => ({
	          item_id: String(x && x.item_id ? x.item_id : '').trim(),
	          part: String(x && x.part ? x.part : '').trim(),
	          delta_qty: toInt(x && x.delta_qty, 0),
	          prev_qty: toInt(x && x.prev_qty, 0),
	          next_qty: toInt(x && x.next_qty, 0),
	        }))
	        .filter((l) => l.item_id && l.part && l.delta_qty > 0);
	    }

	    function normalizeReceiptSkipped(value){
	      const arr = Array.isArray(value) ? value : [];
	      return arr
	        .map((x) => ({
	          part: String(x && (x.part || x.name || x.item) ? (x.part || x.name || x.item) : '').trim(),
	          reason: String(x && x.reason ? x.reason : '').trim() || 'not_found',
	        }))
	        .filter((s) => s.part);
	    }

	    function receiptSkipText(s){
	      const reason = String(s && s.reason ? s.reason : '').trim();
	      const part = String(s && s.part ? s.part : '').trim();
	      if(reason === 'conflict') return `${part} (qty changed)`;
	      if(reason === 'deleted') return `${part} (item deleted)`;
	      return `${part} (not found)`;
	    }

	    function receiptAppliedLineText(line, mode){
	      const l = line || {};
	      const part = String(l.part || '').trim();
	      const delta = toInt(l.delta_qty, 0);
	      const prev = toInt(l.prev_qty, 0);
	      const next = toInt(l.next_qty, 0);
	      if(mode === 'undo') return `${part}: -${delta} (${next} → ${prev})`;
	      return `${part}: +${delta} (${prev} → ${next})`;
	    }

	    function buildReceiptSummary({ subject, applied, skipped, mode }){
	      const title = (mode === 'undo') ? 'Receive undone' : 'Order received';
	      const lines = Array.isArray(applied) ? applied : [];
	      const skips = Array.isArray(skipped) ? skipped : [];
	      const body = [
	        subject ? `Order: ${subject}` : '',
	        '',
	        `Applied: ${lines.length}`,
	        `Skipped: ${skips.length}`,
	        '',
	        'Applied lines:',
	        lines.length ? lines.map(l => `- ${receiptAppliedLineText(l, mode)}`).join('\n') : '(none)',
	        '',
	        'Skipped lines:',
	        skips.length ? skips.map(s => `- ${receiptSkipText(s)}`).join('\n') : '(none)',
	      ].filter((x, i, arr) => !(x === '' && arr[i-1] === '')).join('\n');
	      const copy = JSON.stringify({ mode, subject, applied: lines, skipped: skips }, null, 2);
	      return { title, body, copy };
	    }

	    async function buildReceivingSnapshotForOrder(orderRow){
	      const items = normalizeOrderLineItems(orderRow && orderRow.line_items ? orderRow.line_items : []);
	      const skipped = [];
	      const agg = new Map(); // itemId -> { item_id, part, delta_qty }
	      for(const it of items){
	        const delta = toInt(it && it.qty, 0);
	        if(delta <= 0) continue;
	        const inv = resolveInventoryItemForOrderLine(it);
	        if(!inv){
	          const part = String(it && it.part ? it.part : '').trim();
	          if(part) skipped.push({ part, reason:'not_found' });
	          continue;
	        }
	        const key = String(inv.id || '').trim();
	        if(!key) continue;
	        const existing = agg.get(key);
	        const part = String(it && it.part ? it.part : (inv.name || '')).trim();
	        if(existing){
	          existing.delta_qty += delta;
	        }else{
	          agg.set(key, { item_id: key, part: part || String(inv.name||'').trim(), delta_qty: delta });
	        }
	      }

	      const ids = Array.from(agg.keys());
	      const qtyMap = await sbFetchItemQtyMap(ids);
	      const lines = [];
	      for(const [id, entry] of agg){
	        const prev = qtyMap.get(id);
	        if(typeof prev !== 'number'){
	          const part = String(entry && entry.part ? entry.part : '').trim();
	          if(part) skipped.push({ part, reason:'not_found' });
	          continue;
	        }
	        const delta = toInt(entry.delta_qty, 0);
	        if(delta <= 0) continue;
	        lines.push({
	          item_id: id,
	          part: String(entry.part || '').trim() || id,
	          delta_qty: delta,
	          prev_qty: prev,
	          next_qty: prev + delta,
	        });
	      }

	      return {
	        planned_at: new Date().toISOString(),
	        planned_by: SB.user ? SB.user.id : null,
	        lines,
	        skipped,
	      };
	    }

	    async function applyReceivingSnapshot(orderId, snapshot){
	      const planned = (snapshot && typeof snapshot === 'object') ? snapshot : {};
	      const lines = normalizeReceiptLines(planned.lines);
	      const baseSkipped = normalizeReceiptSkipped(planned.skipped).map(s => ({ part: s.part, reason: 'not_found' }));
	      const ids = lines.map(l => l.item_id);
	      const qtyMap = await sbFetchItemQtyMap(ids);
	      const applied = [];
	      const skipped = baseSkipped.slice();

	      for(const l of lines){
	        const current = qtyMap.get(l.item_id);
	        if(typeof current !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        if(current === l.next_qty){
	          applied.push(l);
	          setLocalItemQty(l.item_id, l.next_qty);
	          continue;
	        }
	        if(current !== l.prev_qty){
	          skipped.push({ part: l.part, reason:'conflict' });
	          continue;
	        }
	        const ok = await sbUpdateItemQtyIfMatch(l.item_id, l.prev_qty, l.next_qty);
	        if(ok){
	          qtyMap.set(l.item_id, l.next_qty);
	          applied.push(l);
	          setLocalItemQty(l.item_id, l.next_qty);
	          continue;
	        }
	        const refreshed = await sbFetchItemQtyMap([l.item_id]);
	        const current2 = refreshed.get(l.item_id);
	        if(typeof current2 !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        qtyMap.set(l.item_id, current2);
	        if(current2 === l.next_qty){
	          applied.push(l);
	          setLocalItemQty(l.item_id, l.next_qty);
	          continue;
	        }
	        skipped.push({ part: l.part, reason:'conflict' });
	      }

	      const appliedAt = new Date().toISOString();
	      const receivedSnapshot = {
	        applied_at: appliedAt,
	        applied_by: SB.user ? SB.user.id : null,
	        lines: applied,
	        skipped,
	      };
	      const patch = {
	        receiving_at: null,
	        receiving_by: null,
	        receiving_snapshot: null,
	        received_at: appliedAt,
	        received_by: SB.user ? SB.user.id : null,
	        received_snapshot: receivedSnapshot,
	        received_undone_at: null,
	        received_undone_by: null,
	      };
	      await sbUpdateOrder(orderId, patch);
	      patchOrderHistoryRow(orderId, patch);
	      try{ setUpdated(); render(); }catch(e){}
	      try{ renderOrderHistoryFiltered(); }catch(e){}
	      return { receivedSnapshot, applied, skipped };
	    }

	    async function undoReceivedSnapshot(orderId, receivedSnapshot){
	      const snap = (receivedSnapshot && typeof receivedSnapshot === 'object') ? receivedSnapshot : {};
	      const lines = normalizeReceiptLines(snap.lines);
	      if(!lines.length) return { undone: [], skipped: [] };

	      const ids = lines.map(l => l.item_id);
	      const qtyMap = await sbFetchItemQtyMap(ids);
	      const undone = [];
	      const skipped = [];

	      for(const l of lines){
	        const current = qtyMap.get(l.item_id);
	        if(typeof current !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        if(current === l.prev_qty){
	          undone.push(l);
	          setLocalItemQty(l.item_id, l.prev_qty);
	          continue;
	        }
	        if(current !== l.next_qty){
	          skipped.push({ part: l.part, reason:'conflict' });
	          continue;
	        }
	        const ok = await sbUpdateItemQtyIfMatch(l.item_id, l.next_qty, l.prev_qty);
	        if(ok){
	          qtyMap.set(l.item_id, l.prev_qty);
	          undone.push(l);
	          setLocalItemQty(l.item_id, l.prev_qty);
	          continue;
	        }
	        const refreshed = await sbFetchItemQtyMap([l.item_id]);
	        const current2 = refreshed.get(l.item_id);
	        if(typeof current2 !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        qtyMap.set(l.item_id, current2);
	        if(current2 === l.prev_qty){
	          undone.push(l);
	          setLocalItemQty(l.item_id, l.prev_qty);
	          continue;
	        }
	        skipped.push({ part: l.part, reason:'conflict' });
	      }

	      const undoneAt = new Date().toISOString();
	      const patch = {
	        receiving_at: null,
	        receiving_by: null,
	        receiving_snapshot: null,
	        received_undone_at: undoneAt,
	        received_undone_by: SB.user ? SB.user.id : null,
	      };
	      await sbUpdateOrder(orderId, patch);
	      patchOrderHistoryRow(orderId, patch);
	      try{ setUpdated(); render(); }catch(e){}
	      try{ renderOrderHistoryFiltered(); }catch(e){}
	      return { undone, skipped };
	    }

	    function showOrderReceivingSetupHelp(){
	      const sql = "NOTIFY pgrst, 'reload schema';";
	      openMsgModal(
	        'Enable order receiving',
	        `Order receiving requires a Supabase schema update.\n\n`+
	          `Run the latest SUPABASE_SECURE_SETUP.sql in Supabase SQL Editor, then run:\n${sql}\n\n`+
	          `After that, refresh this page and tap Receive again.`,
	        sql
	      );
	    }

	    async function handleOrderReceiptButtonClick(orderId, btnEl){
	      const id = String(orderId || '').trim();
	      if(!id) return;
	      if(!SB.ready){ toast('Supabase not configured'); return; }
	      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
	      if(!canOrdersEdit()){ toast('Receive not allowed'); return; }
	      if(SB.ordersHasReceipt === false){
	        showOrderReceivingSetupHelp();
	        return;
	      }

	      const row = getOrderHistoryRowById(id);
	      if(!row){ toast('Order not found'); return; }

	      const isUndo = isOrderCurrentlyReceived(row);
	      const subject = orderSubjectFromRow(row);
	      const receivingAt = String(row.receiving_at || '').trim();
	      const receivedAt = String(row.received_at || '').trim();
	      const resumable = !isUndo && !!receivingAt && !receivedAt && row.receiving_snapshot;

	      const ok = isUndo
	        ? (await openConfirmModal('Undo receive?', 'Revert inventory changes from this received order when safe (skips conflicts).', { okText:'Undo', cancelText:'Cancel' }))
	        : (await openConfirmModal(resumable ? 'Resume receiving?' : 'Receive order?', 'Add this order’s quantities to inventory (skips conflicts).', { okText: resumable ? 'Resume' : 'Receive', cancelText:'Cancel' }));
	      if(!ok) return;

	      const priorTitle = btnEl ? btnEl.getAttribute('title') : '';
	      if(btnEl){
	        btnEl.disabled = true;
	        btnEl.setAttribute('title', isUndo ? 'Undoing…' : 'Receiving…');
	      }

	      try{
	        if(isUndo){
	          const receivedSnapshot = (row && typeof row.received_snapshot === 'object' && row.received_snapshot) ? row.received_snapshot : null;
	          if(!receivedSnapshot){ toast('Nothing to undo'); return; }
	          toast('Undoing receive…');
	          const { undone, skipped } = await undoReceivedSnapshot(id, receivedSnapshot);
	          const { title, body, copy } = buildReceiptSummary({ subject, applied: undone, skipped, mode:'undo' });
	          openMsgModal(title, body, copy);
	          toast('Undo complete');
	        }else{
	          toast(resumable ? 'Resuming receive…' : 'Receiving…');
	          let planned = (resumable && typeof row.receiving_snapshot === 'object') ? row.receiving_snapshot : null;
	          if(!planned){
	            planned = await buildReceivingSnapshotForOrder(row);
	            if(!planned.lines.length && !(planned.skipped && planned.skipped.length)){
	              toast('No line items to receive');
	              return;
	            }
	            const patch = {
	              receiving_at: planned.planned_at,
	              receiving_by: planned.planned_by,
	              receiving_snapshot: planned,
	            };
	            await sbUpdateOrder(id, patch);
	            patchOrderHistoryRow(id, patch);
	          }
	          const { applied, skipped } = await applyReceivingSnapshot(id, planned);
	          const { title, body, copy } = buildReceiptSummary({ subject, applied, skipped, mode:'receive' });
	          openMsgModal(title, body, copy);
	          toast('Receive complete');
	        }
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Receive failed');
	      }finally{
	        if(btnEl){
	          btnEl.disabled = false;
	          btnEl.setAttribute('title', priorTitle || '');
	        }
	      }
	    }

	    function renderOrderHistoryList(list, opts = {}){
	      const wrap = $('orderHistoryList');
	      if(!wrap) return;
	      wrap.innerHTML = '';
	      const rows = Array.isArray(list) ? list : [];
	      if(!rows.length){
	        const empty = document.createElement('div');
	        empty.className = 'order-empty';
	        empty.textContent = (opts && typeof opts.emptyText === 'string' && opts.emptyText.trim())
	          ? opts.emptyText
	          : 'No orders yet.';
	        wrap.appendChild(empty);
	        return;
	      }
      for(const o of rows){
        const det = document.createElement('details');
        det.className = 'history-item';
        det.dataset.orderId = String(o.id || '');

	        const subject = escapeHtml(orderSubjectFromRow(o));
        const created = escapeHtml(formatEasternDateTime(o.created_at || ''));
        const to = escapeHtml(String(o.to_email||''));
        const replyTo = String(o.reply_to_email||'').trim();
        const contact = String(o.contact_name||'').trim();
        const notes = String(o.notes||'').trim();
        const companyPo = String(o.company_po_number || '').trim();
        const internalPo = String(o.internal_po_number || '').trim();
        const shippingSnap = normalizeShippingSnapshot(o.shipping_address_snapshot) || null;
        const shippingLines = shippingSnap ? [shippingSnap.label, shippingSnap.address].filter(Boolean) : [];
        const items = normalizeOrderLineItems(o.line_items);

        const orderId = String(o.id || '');
        const receiptMeta = orderNonEmpty(orderReceiptMetaText(o));
        const canReceipt = (SB.ordersHasReceipt !== false) && canOrdersEdit();
        const canRemove = canOrdersDelete();
        const isReceived = isOrderCurrentlyReceived(o);
        const isReceiving = canReceipt && !!String(o.receiving_at || '').trim() && !String(o.received_at || '').trim();
        det.classList.toggle('order-received', isReceived);
        const receiveBtnTitle = !canReceipt
          ? 'Enable order receiving (run Supabase SQL setup)'
          : (isReceived ? 'Undo receive' : (isReceiving ? 'Resume receiving' : 'Receive into inventory'));
        const receiveBtnClass = 'btn-icon-receive';
        const receiveBtnIcon =
          `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
            `<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>`+
            `<path d="M3.27 6.96 12 12.01l8.73-5.05"></path>`+
            `<path d="M12 22.08V12"></path>`+
            `<polyline class="recv-check" points="9 11 12 14 16 10"></polyline>`+
          `</svg>`;
        const receiptBtn =
          `<button class="${receiveBtnClass}" data-receive-order-id="${escapeHtml(orderId)}" aria-disabled="${canReceipt ? 'false' : 'true'}" aria-label="${escapeHtml(receiveBtnTitle)}" title="${escapeHtml(receiveBtnTitle)}"${canReceipt ? '' : ' disabled'}>`+
            receiveBtnIcon+
          `</button>`;
        const trayDeleteBtn =
          `<button type="button" class="history-tray-btn history-tray-btn--delete" data-delete-order-id="${escapeHtml(orderId)}" tabindex="-1" aria-label="Delete order" title="Delete order"${canRemove ? '' : ' disabled aria-disabled="true"'}>`+
            `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
              `<polyline points="3 6 5 6 21 6"></polyline>`+
              `<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>`+
              `<line x1="10" y1="11" x2="10" y2="17"></line>`+
              `<line x1="14" y1="11" x2="14" y2="17"></line>`+
            `</svg>`+
          `</button>`;
        const trayReceiveBtn =
          `<button type="button" class="history-tray-btn history-tray-btn--receive" data-receive-order-id="${escapeHtml(orderId)}" tabindex="-1" aria-disabled="${canReceipt ? 'false' : 'true'}" aria-label="${escapeHtml(receiveBtnTitle)}" title="${escapeHtml(receiveBtnTitle)}"${canReceipt ? '' : ' disabled'}>`+
            `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
              `<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>`+
              `<path d="M3.27 6.96 12 12.01l8.73-5.05"></path>`+
              `<path d="M12 22.08V12"></path>`+
              `<polyline class="recv-check" points="9 11 12 14 16 10"></polyline>`+
            `</svg>`+
          `</button>`;

        const itemsTable = items.length ? (
          `<table class="history-table">`+
            `<thead>`+
              `<tr>`+
                `<th>Part #</th>`+
                `<th>Description</th>`+
                `<th style="text-align:right">Qty</th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>`+
              items.map(it =>
                `<tr>`+
                  `<td>${escapeHtml(it.part)}</td>`+
                  `<td>${escapeHtml(it.desc)}</td>`+
                  `<td class="qty">${it.qty}</td>`+
                `</tr>`
              ).join('')+
            `</tbody>`+
          `</table>`
        ) : `<div class="order-empty" style="margin-top:10px;">(No line items)</div>`;

        const forwardBlock =
          `<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">`+
            `<div class="muted" style="margin-bottom:8px;letter-spacing:.08em;text-transform:uppercase;font-weight:800;">Forward</div>`+
            `<div class="order-recipient">`+
              `<input data-forward-email-id="${orderId}" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />`+
              `<button class="btn small" type="button" data-forward-send-id="${orderId}" disabled>Forward</button>`+
            `</div>`+
            `<div class="order-suggest" data-forward-suggest-id="${orderId}" aria-label="Email suggestions"></div>`+
          `</div>`;

        det.innerHTML =
          `<summary>`+
            `<div class="history-tray" aria-hidden="true">`+
              trayDeleteBtn+
              trayReceiveBtn+
            `</div>`+
            `<div class="history-header">`+
              `<div class="history-title">${subject}</div>`+
              `<div class="history-actions">`+
                receiptBtn+
                `<button class="btn-icon-danger" data-delete-order-id="${orderId}" aria-label="Delete order" title="Delete order"${canRemove ? '' : ' disabled aria-disabled="true"'}>`+
                  `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`+
                `</button>`+
              `</div>`+
            `</div>`+
            `<div class="history-meta">${created}${to ? ` • To: ${to}` : ''}${receiptMeta ? ` • ${escapeHtml(receiptMeta)}` : ''}</div>`+
          `</summary>`+
          `<div class="history-body">`+
            `<div class="history-kv">`+
              (replyTo ? `<div><span class="muted">Reply-To:</span> ${escapeHtml(replyTo)}</div>` : '')+
              (contact ? `<div><span class="muted">Contact:</span> ${escapeHtml(contact)}</div>` : '')+
              (companyPo ? `<div><span class="muted">Company PO:</span> ${escapeHtml(companyPo)}</div>` : '')+
              (internalPo ? `<div><span class="muted">Internal PO:</span> ${escapeHtml(internalPo)}</div>` : '')+
              (shippingLines.length ? `<div><span class="muted">Shipping Address:</span><div class="history-address">${shippingLines.map(l => escapeHtml(l)).join('<br>')}</div></div>` : '')+
              (notes ? `<div><span class="muted">Notes:</span> ${escapeHtml(notes)}</div>` : '')+
            `</div>`+
            itemsTable +
            forwardBlock+
          `</div>`;

	        wrap.appendChild(det);
	      }
	    }
	    function orderHistorySearchText(orderRow){
	      const o = orderRow || {};
	      const createdAt = String(o.created_at || '').trim();
	      const createdEastern = String(formatEasternDateTime(createdAt || '') || '').trim();
	      const subject = orderSubjectFromRow(o);
	      const to = String(o.to_email || '').trim();
	      const replyTo = String(o.reply_to_email || '').trim();
	      const contact = String(o.contact_name || '').trim();
	      const notes = String(o.notes || '').trim();
	      const id = String(o.id || '').trim();
	      const companyPo = String(o.company_po_number || '').trim();
	      const internalPo = String(o.internal_po_number || '').trim();
	      const shippingSnap = normalizeShippingSnapshot(o.shipping_address_snapshot) || null;
	      const shippingText = shippingSnap ? [shippingSnap.label, shippingSnap.address].filter(Boolean).join(' ') : '';
	      const items = normalizeOrderLineItems(o.line_items);
	      const itemText = items.map(it => `${it.part} ${it.desc} ${toInt(it.qty,0)}`).join(' ');
	      return `${id} ${createdAt} ${createdEastern} ${to} ${replyTo} ${subject} ${contact} ${notes} ${companyPo} ${internalPo} ${shippingText} ${itemText}`.toLowerCase();
	    }
	    function renderOrderHistoryFiltered(){
	      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
	      const raw = String(state._orderHistoryFilter || '').trim().toLowerCase();
	      if(!raw){
	        renderOrderHistoryList(rows, { emptyText: 'No orders yet.' });
	        return;
	      }
	      const tokens = raw.split(/\s+/g).filter(Boolean);
	      const out = rows.filter(r => {
	        const hay = orderHistorySearchText(r);
	        return tokens.every(t => hay.includes(t));
	      });
	      renderOrderHistoryList(out, { emptyText: 'No matching orders.' });
	    }
		    let _orderSuggestTimer = null;
		    function renderOrderEmailSuggestions(list){
		      const wrap = $('orderEmailSuggest');
		      if(!wrap) return;
	      wrap.innerHTML = '';
	      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
	      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
	      wrap.classList.add('has-suggest');
	      rows.forEach(r=>{
	        const btn = document.createElement('button');
	        btn.type = 'button';
	        btn.className = 'suggest-chip';
	        btn.dataset.suggestEmail = String(r.email);
	        btn.textContent = String(r.email);
	        wrap.appendChild(btn);
	      });
	    }
	    function hideOrderEmailSuggestions(){
	      if(_orderSuggestTimer){ clearTimeout(_orderSuggestTimer); _orderSuggestTimer = null; }
	      renderOrderEmailSuggestions([]);
	    }
    function orderNonEmpty(value){
      const s = String(value || '').trim();
      return s ? s : '';
    }
	    function requestOrderEmailSuggestions(prefix){
	      if(_orderSuggestTimer) clearTimeout(_orderSuggestTimer);
	      const q = String(prefix||'');
	      _orderSuggestTimer = setTimeout(async ()=>{
	        const wrap = $('orderEmailSuggest');
	        const inp = $('orderEmail');
	        const ae = document.activeElement;
	        const allow = (inp && ae === inp) || (wrap && ae && wrap.contains(ae));
	        if(!allow){ hideOrderEmailSuggestions(); return; }
	        try{
	          const data = await sbFetchOrderRecipientSuggestions(q);
	          // If focus moved away while we awaited, don't reopen the list.
	          const wrap2 = $('orderEmailSuggest');
	          const inp2 = $('orderEmail');
	          const ae2 = document.activeElement;
	          const allow2 = (inp2 && ae2 === inp2) || (wrap2 && ae2 && wrap2.contains(ae2));
	          if(!allow2){ hideOrderEmailSuggestions(); return; }
	          renderOrderEmailSuggestions(data);
	        }catch{
	          renderOrderEmailSuggestions([]);
	        }
	      }, 160);
	    }

    const _forwardSuggestTimers = new Map();
    function renderForwardEmailSuggestions(orderId, list){
      const id = String(orderId || '').trim();
      if(!id) return;
      const wrap = document.querySelector(`[data-forward-suggest-id="${id}"]`);
      if(!wrap) return;
      wrap.innerHTML = '';
      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
      wrap.classList.add('has-suggest');
      rows.forEach(r=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggest-chip';
        btn.dataset.forwardSuggestEmail = String(r.email);
        btn.textContent = String(r.email);
        wrap.appendChild(btn);
      });
    }
    function requestForwardEmailSuggestions(orderId, prefix){
      const id = String(orderId || '').trim();
      if(!id) return;
      const prev = _forwardSuggestTimers.get(id);
      if(prev) clearTimeout(prev);
      const q = String(prefix||'');
      const t = setTimeout(async ()=>{
        try{
          const data = await sbFetchOrderRecipientSuggestions(q);
          renderForwardEmailSuggestions(id, data);
        }catch{
          renderForwardEmailSuggestions(id, []);
        }
      }, 160);
      _forwardSuggestTimers.set(id, t);
    }
    async function forwardOrderFromHistory(orderId){
      const id = String(orderId || '').trim();
      if(!id) return;
      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }

      const row = state._orderHistoryById && typeof state._orderHistoryById.get === 'function'
        ? (state._orderHistoryById.get(id) || null)
        : null;
      if(!row){ toast('Order not found'); return; }

      const input = document.querySelector(`[data-forward-email-id="${id}"]`);
      const to = String(input && input.value ? input.value : '').trim();
      if(!looksLikeEmailAddress(to)){ toast('Enter a valid email'); return; }

      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Sending…'; }

      try{
        const subjectLine = orderSubjectFromRow(row);
        const notes = String(row.notes||'').trim();
        const lineItems = Array.isArray(row.line_items) ? row.line_items : [];
        const companyName = getOrderCompanyName();
        if(!companyName) throw new Error('Company name is required to send orders');
        const shippingAddress = normalizeShippingSnapshot(row.shipping_address_snapshot);
        const companyPoNumber = String(row.company_po_number || '').trim();
        const internalPoNumber = String(row.internal_po_number || '').trim();

        const sendRes = await sendOrderPayloadViaApi({
          to,
          subjectLine,
          notes,
          lineItems,
          shippingAddress,
          companyName,
          companyPoNumber,
          internalPoNumber,
        });
        try{ await sbRecordOrderRecipient(to, ''); }catch{}
        try{
          await sbInsertOrderHistoryFromData({
            toEmail: to,
            subjectLine,
            contactName: '',
            notes,
            lineItems,
            providerResult: sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes,
            companyPoNumber,
            internalPoNumber,
            shippingAddressId: row.shipping_address_id,
            shippingAddressSnapshot: shippingAddress,
          });
        }catch{}

        toast('Forwarded');
        if(input) input.value = '';
        renderForwardEmailSuggestions(id, []);
      }catch(e){
        toast((e && e.message) ? e.message : 'Forward failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Forward'; }
      }
    }
    let _orderHistoryReturnToOrder = false;
	    async function refreshOrderHistory(){
	      const wrap = $('orderHistoryList');
	      if(wrap) wrap.innerHTML = `<div class="muted">Loading…</div>`;
	      const btn = $('btnOrderHistoryRefresh');
	      const prior = btn ? btn.textContent : '';
	      if(btn){ btn.disabled = true; btn.textContent = 'Loading…'; }
	      try{
	        const rows = await sbFetchOrders(60);
	        state._orderHistoryRows = Array.isArray(rows) ? rows : [];
	        state._orderHistoryById = new Map((rows||[]).map(r => [String(r && r.id ? r.id : ''), r]).filter(x=>x[0]));
	        renderOrderHistoryFiltered();
	      }catch(e){
	        state._orderHistoryById = new Map();
	        state._orderHistoryRows = [];
	        const msg = e && e.message ? e.message : 'Failed to load history';
	        if(wrap) wrap.innerHTML = `<div class="order-empty">${escapeHtml(msg)}</div>`;
	      }finally{
	        if(btn){ btn.disabled = false; btn.textContent = prior || 'Refresh'; }
	      }
	    }
    async function openOrderHistoryModal(opts = {}){
      const returnToOrder = !!opts.returnToOrder;
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!canOrdersView()){ toast('Order history access required'); return; }
      _orderHistoryReturnToOrder = returnToOrder;
	      if(returnToOrder) show('orderModal', false);
	      show('orderHistoryModal', true);
	      const f = $('orderHistoryFilter'); if(f) f.value = state._orderHistoryFilter || '';
	      try{ updateOrderHistoryFilterClearBtn(); }catch(e){}
	      await refreshOrderHistory();
	    }
    function closeOrderHistoryModal(){
      try{ closeHistoryTray(); }catch(e){}
      show('orderHistoryModal', false);
      if(_orderHistoryReturnToOrder){
        _orderHistoryReturnToOrder = false;
        show('orderModal', true);
        renderOrderPreview();
      }
    }
    function setTrashMessage(msg){
      const el = $('trashMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function trashSearchText(row){
      const r = row || {};
      const name = String(r.name || '').toLowerCase();
      const desc = String(r.description || '').toLowerCase();
      const qty = String(toInt(r.quantity, 0));
      const deletedBy = String(r.deleted_by_email || '').toLowerCase();
      const deletedAt = String(r.deleted_at || '').toLowerCase();
      return `${name} ${desc} ${qty} ${deletedBy} ${deletedAt}`.trim();
    }
    function renderTrashList(){
      const list = $('trashList');
      if(!list) return;
      const rows = Array.isArray(state._trashItems) ? state._trashItems : [];
      const filter = String(state._trashFilter || '').trim().toLowerCase();
      const filtered = filter ? rows.filter(r => trashSearchText(r).includes(filter)) : rows;
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">Trash is empty.</div>`;
        return;
      }
      if(!filtered.length){
        list.innerHTML = `<div class="trash-empty">No matches.</div>`;
        return;
      }
      list.innerHTML = filtered.map(row => {
        const id = String(row.id || '').trim();
        const name = String(row.name || '').trim() || '(Unnamed item)';
        const desc = String(row.description || '').trim();
        const qty = toInt(row.quantity, 0);
        const deletedAt = row.deleted_at ? formatEasternDateTime(row.deleted_at) : '';
        const deletedBy = String(row.deleted_by_email || '').trim();
        const metaParts = [];
        if(deletedAt) metaParts.push(`Deleted ${escapeHtml(deletedAt)}`);
        if(deletedBy) metaParts.push(`By ${escapeHtml(deletedBy)}`);
        metaParts.push(`Qty ${qty}`);
        const meta = metaParts.join(' • ');
        return (
          `<div class="trash-item">`+
            `<div>`+
              `<div class="trash-title">${escapeHtml(name)}</div>`+
              (desc ? `<div class="muted">${escapeHtml(desc)}</div>` : '')+
              `<div class="trash-meta">${meta}</div>`+
            `</div>`+
            `<div>`+
              `<button class="btn" data-restore-id="${escapeHtmlAttr(id)}">Restore</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    async function refreshTrash(){
      const list = $('trashList');
      if(list) list.innerHTML = `<div class="muted">Loading…</div>`;
      setTrashMessage('');
      try{
        if(!SB.ready) throw new Error('Supabase not configured');
        if(!SB.session) throw new Error('Sign in required');
        if(!SB.companyId) throw new Error('No company selected');
        if(!canAccessTrash()) throw new Error('Trash access requires delete or restore permission');
        const { data, error } = await SB.client.rpc('get_deleted_items', { p_company_id: SB.companyId });
        if(error) throw error;
        state._trashItems = Array.isArray(data) ? data : [];
        renderTrashList();
      }catch(e){
        state._trashItems = [];
        const msg = e && e.message ? e.message : 'Failed to load trash';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openTrashModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!canAccessTrash()){ toast('Trash access requires delete or restore permission'); return; }
      show('trashModal', true);
      const f = $('trashFilter'); if(f) f.value = state._trashFilter || '';
      await refreshTrash();
    }
    function closeTrashModal(){
      show('trashModal', false);
    }
    function renderOrderResults(){
      const ord = orderState();
      const list = $('orderResultsBody');
      if(!list) return;
      const qRaw = String(ord.search||'').trim();
      const q = toKey(qRaw);

      const items = (state.items||[]).slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      list.innerHTML = '';
      if(!items.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No inventory loaded yet.';
        list.appendChild(empty);
        return;
      }
      if(!qRaw){
        return;
      }

      const hits = items.filter(it=>{
        if(!it) return false;
        const name = toKey(it.name);
        const desc = toKey(it.desc);
        return name.includes(q) || desc.includes(q) || String(toInt(it.qty,0)).includes(qRaw);
      }).slice(0, 20);

      if(!hits.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No matches.';
        list.appendChild(empty);
        return;
      }

      for(const it of hits){
        const card = document.createElement('div');
        card.className = 'order-card';
        const desc = String(it.desc||'').trim();
        const orderQty = getOrderQtyForItem(it.id);
        card.innerHTML =
          `<div class="order-card-top">`+
            `<div class="order-meta">`+
              `<div class="order-title">${escapeHtml(it.name||'')}</div>`+
              (desc ? `<div class="order-sub">${escapeHtml(desc)}</div>` : ``)+
            `</div>`+
            `<div class="order-side">`+
              `<div class="order-kpi">`+
                `<div class="order-kpi-label">On Hand</div>`+
                `<div class="order-kpi-value">${toInt(it.qty,0)}</div>`+
              `</div>`+
              `<div class="qty-stepper">`+
                `<button class="qty-stepper-btn" data-stepper-dec="${it.id}"${orderQty === 0 ? ' disabled style="opacity:0.3"' : ''}>−</button>`+
                `<span class="qty-stepper-val">${orderQty}</span>`+
                `<button class="qty-stepper-btn" data-stepper-inc="${it.id}">+</button>`+
              `</div>`+
            `</div>`+
          `</div>`;
        list.appendChild(card);
      }
    }
    function renderOrderLines(){
      const ord = orderState();
      const list = $('orderLinesBody');
      const info = $('orderLinesInfo');
      if(!list) return;
      list.innerHTML = '';

      const lines = ord.lines.slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      pruneOrderLineSelection(lines);
      if(info){
        info.textContent = lines.length ? (lines.length === 1 ? '1 item' : `${lines.length} items`) : '';
      }

      if(!lines.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No items in the order yet. Add from inventory above, or pre-select items in the main table before opening Create Order.';
        list.appendChild(empty);
        renderOrderPreview();
        return;
      }

      for(const l of lines){
        const inv = getInventoryById(l.id);
        const onHand = inv ? toInt(inv.qty, 0) : null;
        const card = document.createElement('div');
        card.className = 'order-card order-card--selected';
        card.dataset.orderLineId = l.id;
        const isSelected = orderLineSelection.has(String(l.id || '').trim());
        const selectLabel = `Select ${String(l.name || '').trim() || 'item'} for batch qty edit`;
        const desc = String(l.desc||'').trim();
        card.innerHTML =
          `<div class="order-card-header">`+
            `<div class="order-title">${escapeHtml(l.name||'')}</div>`+
            `<div class="order-inline-kpi"><span class="muted">On Hand</span><span class="order-inline-kpi-val">${onHand===null ? '—' : onHand}</span></div>`+
          `</div>`+
          (desc ? `<div class="order-sub">${escapeHtml(desc)}</div>` : ``)+
          `<div class="order-controls order-controls--compact">`+
            `<label class="order-batch-toggle" title="Select for batch qty edit">`+
              `<input type="checkbox" class="order-line-select" data-order-select-id="${escapeHtmlAttr(l.id)}" aria-label="${escapeHtmlAttr(selectLabel)}"${isSelected ? ' checked' : ''}>`+
            `</label>`+
            `<div class="qty-stepper" data-qty-picker-trigger="${l.id}">`+
              `<button class="qty-stepper-btn" data-line-dec="${l.id}">−</button>`+
              `<input type="text" inputmode="numeric" pattern="[0-9]*" class="qty-stepper-input" data-line-qty-input="${l.id}" value="${toInt(l.qty,0)}" aria-label="Order quantity">`+
              `<button class="qty-stepper-btn" data-line-inc="${l.id}">+</button>`+
            `</div>`+
            `<button class="order-remove-btn" data-remove-order-id="${l.id}" title="Remove">`+
              `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`+
            `</button>`+
          `</div>`;
        list.appendChild(card);
      }

      renderOrderPreview();
    }
    function renderOrderPreview(){
      const ord = orderState();
      const wrap = $('orderPreviewHtml');
      const subjectLine = composeOrderSubject(ord);
      ord.subject = subjectLine;
      const subjectInput = $('orderSubject'); if(subjectInput) subjectInput.value = subjectLine;
      const internalInput = $('orderInternalPoNumber'); if(internalInput) internalInput.value = String(ord.internalPoNumber || '').trim();
      if(wrap){
        const html = buildOrderHtml();
        wrap.innerHTML = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" sandbox="allow-same-origin"></iframe>`;
      }
      const shippingPreview = $('orderShippingPreview');
      if(shippingPreview){
        const shippingLines = formatShippingSnapshotLines(getOrderShippingSnapshot(ord));
        shippingPreview.innerHTML = shippingLines.length
          ? shippingLines.map(l => escapeHtml(l)).join('<br>')
          : '<span class="muted">No shipping address selected.</span>';
      }
      const replyEl = $('orderReplyToNote');
      if(replyEl){
        const e = getSignedInEmail();
        replyEl.textContent = e ? `Reply-To: ${e}` : 'Reply-To: (sign in to set)';
      }
      const histBtn = $('btnOrderHistory');
      if(histBtn){
        histBtn.disabled = !(SB.ready && SB.session && SB.authorized && canOrdersView());
      }
      const btn = $('btnOrderSubmit');
      if(btn){
        const okEmail = !!String(ord.email||'').trim();
        const okLines = ord.lines.some(l => toInt(l.qty, 0) > 0);
        const okCompany = !!getOrderCompanyName();
        btn.disabled = !(okEmail && okLines && okCompany);
      }
    }
    async function openOrderModal(opts = {}){
		      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		      const ord = orderState();
		      const addSelected = !isMobileUx() && !(opts && Object.prototype.hasOwnProperty.call(opts, 'addSelected') && opts.addSelected === false);
		      if(addSelected){
		        const selectedIds = Array.from(document.querySelectorAll('.rowChk:checked'))
		          .map(cb => cb.dataset.id)
		          .filter(Boolean);

	        let added = 0;
	        for(const id of selectedIds){
	          const it = getInventoryById(id);
	          if(it && upsertOrderLineFromItem(it, 1)) added++;
	        }
	        if(added) toast(`Added ${added} selected item(s)`);
	      }

	      ensureOrderIdentifiers(ord);
	      ord.subject = composeOrderSubject(ord);

      const s = $('orderSearch'); if(s) s.value = ord.search || '';
      const e = $('orderEmail'); if(e) e.value = ord.email || '';
      const companyPo = $('orderCompanyPoNumber'); if(companyPo) companyPo.value = ord.companyPoNumber || '';
      const internalPo = $('orderInternalPoNumber'); if(internalPo) internalPo.value = ord.internalPoNumber || '';
      const sub = $('orderSubject'); if(sub) sub.value = ord.subject || '';
      const n = $('orderNotes'); if(n) n.value = ord.notes || '';

      renderOrderResults();
      renderOrderLines();
      try{ await loadShippingAddresses(); }catch(e){}
      renderOrderPreview();
      try{ updateOrderSearchClearBtn(); }catch(e){}

      show('orderModal', true);
    }

	    const menuOrder = $('menuOrder');
	    if(menuOrder) menuOrder.addEventListener('click', ()=>{
	      toggleMenu(false);
	      if(!requirePermission(PERMISSIONS.ORDERS_CREATE, 'Order creation not allowed')) return;
	      openOrderModal();
	    });
    const menuHistory = $('menuHistory');
    if(menuHistory) menuHistory.addEventListener('click', ()=>{ toggleMenu(false); openOrderHistoryModal({ returnToOrder: false }); });
    const menuTrash = $('menuTrash');
    if(menuTrash) menuTrash.addEventListener('click', ()=>{ toggleMenu(false); openTrashModal(); });
    const menuAudit = $('menuAudit');
    if(menuAudit) menuAudit.addEventListener('click', ()=>{ toggleMenu(false); openAuditModal(); });
    const menuSnapshots = $('menuSnapshots');
    if(menuSnapshots) menuSnapshots.addEventListener('click', ()=>{ toggleMenu(false); openSnapshotsModal(); });
    const menuMetrics = $('menuMetrics');
    if(menuMetrics) menuMetrics.addEventListener('click', ()=>{ toggleMenu(false); openMetricsModal(); });
    const btnTrashClose = $('btnTrashClose');
    if(btnTrashClose) btnTrashClose.addEventListener('click', closeTrashModal);
    const btnTrashReload = $('btnTrashReload');
    if(btnTrashReload) btnTrashReload.addEventListener('click', refreshTrash);
    const trashFilter = $('trashFilter');
    if(trashFilter) trashFilter.addEventListener('input', ()=>{
      state._trashFilter = trashFilter.value || '';
      renderTrashList();
    });
    const trashList = $('trashList');
    if(trashList) trashList.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-restore-id]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-restore-id') || '').trim();
      if(!id) return;
      if(!canItemsRestore()){ toast('Restore not allowed'); return; }
      const row = Array.isArray(state._trashItems) ? state._trashItems.find(r => String(r && r.id ? r.id : '') === id) : null;
      const name = row && row.name ? String(row.name) : 'item';
      if(!(await openConfirmModal('Restore item?', `Restore "${name}" from trash?`, { okText:'Restore', cancelText:'Cancel' }))) return;
      btn.disabled = true;
      btn.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('restore_item', { p_item_id: id });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Restore failed');
        }
        state._trashItems = (state._trashItems || []).filter(r => String(r && r.id ? r.id : '') !== id);
        renderTrashList();
        try{ await sbLoadSnapshot(); }catch(e){}
        toast('Item restored');
      }catch(err){
        toast(err && err.message ? err.message : 'Restore failed');
      }finally{
        btn.disabled = false;
        btn.setAttribute('aria-disabled', 'false');
      }
    });
    const btnAuditClose = $('btnAuditClose');
    if(btnAuditClose) btnAuditClose.addEventListener('click', closeAuditModal);
    const btnAuditRefresh = $('btnAuditRefresh');
    if(btnAuditRefresh) btnAuditRefresh.addEventListener('click', refreshAuditLog);
    const auditTableFilter = $('auditTableFilter');
    if(auditTableFilter) auditTableFilter.addEventListener('change', ()=>{
      state._auditTableFilter = auditTableFilter.value || '';
      refreshAuditLog();
    });
    const auditActionFilter = $('auditActionFilter');
    if(auditActionFilter) auditActionFilter.addEventListener('change', ()=>{
      state._auditActionFilter = auditActionFilter.value || '';
      refreshAuditLog();
    });
    const auditSearchFilter = $('auditSearchFilter');
    if(auditSearchFilter) auditSearchFilter.addEventListener('input', ()=>{
      state._auditSearch = auditSearchFilter.value || '';
      renderAuditList();
    });
    const btnAuditDownload = $('btnAuditDownload');
    if(btnAuditDownload) btnAuditDownload.addEventListener('click', downloadAuditCsv);
    const btnSnapshotsClose = $('btnSnapshotsClose');
    if(btnSnapshotsClose) btnSnapshotsClose.addEventListener('click', closeSnapshotsModal);
    const btnSnapshotBack = $('btnSnapshotBack');
    if(btnSnapshotBack) btnSnapshotBack.addEventListener('click', showSnapshotList);
    const snapshotsList = $('snapshotsList');
    if(snapshotsList) snapshotsList.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-snapshot-preview-id]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-snapshot-preview-id') || '').trim();
      if(!id) return;
      openSnapshotPreview(id);
    });
    const btnMetricsClose = $('btnMetricsClose');
    if(btnMetricsClose) btnMetricsClose.addEventListener('click', closeMetricsModal);
    const metricsRange = $('metricsRange');
    if(metricsRange) metricsRange.addEventListener('change', loadMetrics);
    const metricsView = $('metricsView');
    if(metricsView) metricsView.addEventListener('change', loadMetrics);
		    const menuReport = $('menuReport');
		    if(menuReport) menuReport.addEventListener('click', ()=>{
		      toggleMenu(false);
		      if(!canItemsView()){ toast('Report access requires view permission'); return; }
		      openReportModal();
		    });
		    const btnReportClose = $('btnReportClose');
		    if(btnReportClose) btnReportClose.addEventListener('click', closeReportModal);
				    const btnReportBatchOrder = $('btnReportBatchOrder');
				    if(btnReportBatchOrder) btnReportBatchOrder.addEventListener('click', (e)=>{
				      try{ e.preventDefault(); e.stopPropagation(); }catch(ex){}
				      batchAddLowStockToCart();
				    });
				    const btnReportDownload = $('btnReportDownload');
				    if(btnReportDownload) btnReportDownload.addEventListener('click', downloadInventoryReportCsv);
				    const btnReportShare = $('btnReportShare');
				    if(btnReportShare) btnReportShare.addEventListener('click', ()=>{ void shareInventoryReport(); });
				    const reportLowStockList = $('reportLowStockList');
				    const reportExemptList = $('reportExemptList');
				    const reportInventoryList = $('reportList');
				    function toggleOrderFromReportClick(e){
				      const row = e.target.closest('button[data-report-order-id]');
				      if(!row) return;
			      e.preventDefault();
			      e.stopPropagation();
			      const id = String(row.dataset.reportOrderId || '').trim();
			      if(!id) return;
			      const item = getInventoryById(id);
			      if(!item) return;
				      const ord = orderState();
				      const exists = Array.isArray(ord.lines) && ord.lines.some(l => String(l && l.id ? l.id : '').trim() === id);
				      if(exists) removeOrderLine(id);
				      else upsertOrderLineFromItem(item, 1);
					    }
				    if(reportLowStockList) reportLowStockList.addEventListener('click', toggleOrderFromReportClick);
				    if(reportExemptList) reportExemptList.addEventListener('click', toggleOrderFromReportClick);
				    if(reportInventoryList) reportInventoryList.addEventListener('click', toggleOrderFromReportClick);
				    const btnReportEmailClose = $('btnReportEmailClose');
				    if(btnReportEmailClose) btnReportEmailClose.addEventListener('click', closeReportEmailModal);
				    const btnReportEmailCopy = $('btnReportEmailCopy');
		    if(btnReportEmailCopy) btnReportEmailCopy.addEventListener('click', async ()=>{
		      try{
		        const html = String(_reportEmailHtml || '').trim();
		        if(!html){ toast('Nothing to copy'); return; }
		        await navigator.clipboard.writeText(html);
		        toast('Copied');
		      }catch(e){
		        toast('Copy failed');
		      }
		    });
		    const btnReportEmailSend = $('btnReportEmailSend');
		    if(btnReportEmailSend) btnReportEmailSend.addEventListener('click', async ()=>{
		      const to = String($('reportEmailTo')?.value || '').trim();
		      const subjectLine = String($('reportEmailSubject')?.value || '').trim() || defaultInventoryReportEmailSubject();
		      const html = String(_reportEmailHtml || '').trim();
		      setReportEmailMessage('');
		      if(!looksLikeEmailAddress(to)){ setReportEmailMessage('Enter a valid email.'); return; }
		      if(!html){ setReportEmailMessage('Nothing to send.'); return; }

		      const prior = btnReportEmailSend.textContent;
		      btnReportEmailSend.disabled = true;
		      btnReportEmailSend.textContent = 'Sending…';
		      try{
		        await sendInventoryReportEmailViaApi({ toEmail: to, subjectLine, html });
		        toast('Report sent');
		        closeReportEmailModal();
		      }catch(e){
		        const msg = (e && e.message) ? String(e.message) : 'Send failed';
		        setReportEmailMessage(msg);
		        const fallback = await openConfirmModal('Send failed', `${msg}\n\nOpen your email app with a text report instead?`, { okText:'Open Email', cancelText:'Stay' });
		        if(fallback){
		          const data = reportDataSnapshot();
		          const text = buildInventoryReportText(data, { maxLines: 180 });
		          const stamp = new Date().toISOString().slice(0,10);
		          const subject = subjectLine || `Inventory Report (${stamp})`;
		          const mailto = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
		          window.location.href = mailto;
		        }
		      }finally{
		        btnReportEmailSend.disabled = false;
		        btnReportEmailSend.textContent = prior || 'Send';
		      }
		    });
	    const btnOrderHistory = $('btnOrderHistory');
	    if(btnOrderHistory) btnOrderHistory.addEventListener('click', ()=> openOrderHistoryModal({ returnToOrder: true }));
	    const btnOrderHistoryClose = $('btnOrderHistoryClose');
	    if(btnOrderHistoryClose) btnOrderHistoryClose.addEventListener('click', closeOrderHistoryModal);
	    const btnOrderHistoryDownload = $('btnOrderHistoryDownload');
	    if(btnOrderHistoryDownload) btnOrderHistoryDownload.addEventListener('click', downloadOrderHistoryCsv);
	    const btnOrderHistoryRefresh = $('btnOrderHistoryRefresh');
	    if(btnOrderHistoryRefresh) btnOrderHistoryRefresh.addEventListener('click', refreshOrderHistory);

    const btnShippingAddressClose = $('btnShippingAddressClose');
    if(btnShippingAddressClose) btnShippingAddressClose.addEventListener('click', closeShippingAddressModal);
    const btnShippingAddressNew = $('btnShippingAddressNew');
    if(btnShippingAddressNew) btnShippingAddressNew.addEventListener('click', clearShippingAddressForm);
    const btnShippingAddressSave = $('btnShippingAddressSave');
    if(btnShippingAddressSave) btnShippingAddressSave.addEventListener('click', async ()=>{
      setShippingAddressMessage('');
      try{
        await saveShippingAddress();
        toast('Shipping address saved');
      }catch(e){
        setShippingAddressMessage(e && e.message ? e.message : 'Save failed');
      }
    });
    const shippingAddressList = $('shippingAddressList');
    if(shippingAddressList) shippingAddressList.addEventListener('click', async (e)=>{
      const editBtn = e.target.closest('[data-shipping-edit]');
      const delBtn = e.target.closest('[data-shipping-delete]');
      if(editBtn){
        const id = String(editBtn.getAttribute('data-shipping-edit') || '').trim();
        const row = state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
          ? state._shippingAddressById.get(id)
          : null;
        if(!row) return;
        state._shippingAddressEditing = id;
        const label = $('shippingAddressLabel'); if(label) label.value = row.label || '';
        const address = $('shippingAddressValue'); if(address) address.value = row.address || '';
        const isDefault = $('shippingAddressDefault'); if(isDefault) isDefault.checked = !!row.is_default;
        const title = $('shippingAddressFormTitle'); if(title) title.textContent = 'Edit Shipping Address';
        return;
      }
      if(delBtn){
        const id = String(delBtn.getAttribute('data-shipping-delete') || '').trim();
        if(!id) return;
        const ok = await openConfirmModal('Delete address?', 'Delete this shipping address?', { okText:'Delete', cancelText:'Cancel' });
        if(!ok) return;
        try{
          await deleteShippingAddress(id);
          toast('Shipping address deleted');
        }catch(e){
          toast(e && e.message ? e.message : 'Delete failed');
        }
      }
    });

	    const orderHistoryFilter = $('orderHistoryFilter');
	    if(orderHistoryFilter){
	      updateOrderHistoryFilterClearBtn();
	      orderHistoryFilter.addEventListener('input', ()=>{
	        state._orderHistoryFilter = orderHistoryFilter.value || '';
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	      });
	      orderHistoryFilter.addEventListener('keydown', (e)=>{
	        if(e.key==='Escape' && orderHistoryFilter.value){
	          e.preventDefault();
	          orderHistoryFilter.value = '';
	          state._orderHistoryFilter = '';
	          renderOrderHistoryFiltered();
	          updateOrderHistoryFilterClearBtn();
	        }
	      });
	    }
	    const btnClearOrderHistoryFilter = $('btnClearOrderHistoryFilter');
	    if(btnClearOrderHistoryFilter && orderHistoryFilter){
	      btnClearOrderHistoryFilter.addEventListener('click', ()=>{
	        if(!orderHistoryFilter.value) return;
	        orderHistoryFilter.value = '';
	        state._orderHistoryFilter = '';
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	        try{ orderHistoryFilter.focus(); }catch(e){}
	      });
	    }
	    const btnOrderCancel = $('btnOrderCancel');
	    if(btnOrderCancel) btnOrderCancel.addEventListener('click', ()=> show('orderModal', false));
    const btnResetOrderList = $('btnResetOrderList');
    if(btnResetOrderList) btnResetOrderList.addEventListener('click', ()=> {
      clearAllOrderLines();
      renderOrderLines();
      toast('Order list cleared');
    });
    const btnOrderCopy = $('btnOrderCopy');
    if(btnOrderCopy) btnOrderCopy.addEventListener('click', copyOrderToClipboard);
    const btnOrderSubmit = $('btnOrderSubmit');
    if(btnOrderSubmit) btnOrderSubmit.addEventListener('click', async ()=>{
      const url = buildMailtoUrl();
      if(!url){ toast('Add at least 1 item and an email'); return; }
      if(!requirePermission(PERMISSIONS.ORDERS_CREATE, 'Order creation not allowed')) return;

      const btn = $('btnOrderSubmit');
      const priorText = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Submitting…'; }

	      try{
	        const sendRes = await sendOrderViaApi();
	        let historySaved = false;
	        try{
	          const ord = orderState();
	          await sbRecordOrderRecipient(ord.email, ord.contactName);
	        }catch{}
	        try{
	          await sbInsertOrderHistory(sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes);
	          historySaved = true;
	        }catch{}
	        toast(historySaved ? 'Order sent' : 'Order sent (history not saved)');
	        try{
	          clearAllOrderLines();
	          renderOrderResults();
	          renderOrderLines();
	          resetOrderIdentifiers();
	          const companyPo = $('orderCompanyPoNumber'); if(companyPo) companyPo.value = '';
	          const internalPo = $('orderInternalPoNumber'); if(internalPo) internalPo.value = orderState().internalPoNumber || '';
	        }catch(e){}
	        show('orderModal', false);
	      }catch(e){
	        const msg = e && e.message ? e.message : 'Send failed';
	        const fallback = await openConfirmModal('Send failed', `${msg}\n\nOpen your email app instead?`, { okText:'Open Email', cancelText:'Cancel' });
	        if(fallback){ window.location.href = url; }
	        else { toast(msg); }
	      }finally{
	        if(btn){ btn.textContent = priorText || 'Submit Order'; }
	        renderOrderPreview();
	      }
    });

    const orderSearch = $('orderSearch');
    if(orderSearch){
      updateOrderSearchClearBtn();
      orderSearch.addEventListener('input', ()=>{
        const ord = orderState();
        ord.search = orderSearch.value || '';
        renderOrderResults();
        updateOrderSearchClearBtn();
      });
      orderSearch.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && orderSearch.value){
          e.preventDefault();
          orderSearch.value = '';
          const ord = orderState();
          ord.search = '';
          renderOrderResults();
          updateOrderSearchClearBtn();
        }
      });
    }
    const btnClearOrderSearch = $('btnClearOrderSearch');
    if(btnClearOrderSearch && orderSearch){
      btnClearOrderSearch.addEventListener('click', ()=>{
        if(!orderSearch.value) return;
        orderSearch.value = '';
        const ord = orderState();
        ord.search = '';
        renderOrderResults();
        updateOrderSearchClearBtn();
        try{ orderSearch.focus(); }catch(e){}
      });
    }
	    const orderEmail = $('orderEmail');
	    if(orderEmail) orderEmail.addEventListener('input', ()=>{
	      const ord = orderState();
	      ord.email = orderEmail.value || '';
	      renderOrderPreview();
	      requestOrderEmailSuggestions(ord.email);
	    });
	    if(orderEmail) orderEmail.addEventListener('focus', ()=> requestOrderEmailSuggestions(orderEmail.value || ''));
	    if(orderEmail) orderEmail.addEventListener('blur', ()=>{
	      // Defer so clicks on suggestions can still be handled.
	      setTimeout(()=>{
	        const wrap = $('orderEmailSuggest');
	        if(!wrap || !wrap.classList.contains('has-suggest')) return;
	        const ae = document.activeElement;
	        if(ae && wrap.contains(ae)) return;
	        hideOrderEmailSuggestions();
	      }, 0);
	    });
	    const orderCompanyPoNumber = $('orderCompanyPoNumber');
	    if(orderCompanyPoNumber) orderCompanyPoNumber.addEventListener('input', ()=>{
	      const ord = orderState();
	      ord.companyPoNumber = orderCompanyPoNumber.value || '';
	      ord.subject = composeOrderSubject(ord);
	      renderOrderPreview();
	    });
	    const orderShippingAddress = $('orderShippingAddress');
	    if(orderShippingAddress) orderShippingAddress.addEventListener('change', ()=>{
	      const ord = orderState();
	      const selected = String(orderShippingAddress.value || '').trim();
	      ord.shippingAddressId = selected;
	      const row = state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
	        ? state._shippingAddressById.get(selected)
	        : null;
	      ord.shippingAddressSnapshot = row ? { label: row.label, address: row.address } : null;
	      renderOrderPreview();
	    });
	    const btnOrderShippingManage = $('btnOrderShippingManage');
	    if(btnOrderShippingManage) btnOrderShippingManage.addEventListener('click', openShippingAddressModal);
    const orderNotes = $('orderNotes');
    if(orderNotes) orderNotes.addEventListener('input', ()=>{
      const ord = orderState();
      ord.notes = orderNotes.value || '';
      renderOrderPreview();
    });

	    const orderResultsBody = $('orderResultsBody');
	    if(orderResultsBody) orderResultsBody.addEventListener('click', async (e)=>{
	      const val = e.target.closest('.qty-stepper-val');
	      if(val){
	        const stepper = val.closest('.qty-stepper');
	        if(!stepper) return;
	        const id = String(
	          stepper.querySelector('button[data-stepper-inc]')?.getAttribute('data-stepper-inc')
	          || stepper.querySelector('button[data-stepper-dec]')?.getAttribute('data-stepper-dec')
	          || ''
	        ).trim();
	        if(!id) return;
	        const it = getInventoryById(id);
	        if(!it) return;
	        const currentQty = getOrderQtyForItem(id);
	        const name = String(it.name || '').trim();
	        const next = await openQtyEntryModal('Order Qty', name || 'Order Qty', currentQty, { min:0, okText:'Set', cancelText:'Cancel' });
	        if(next === null || typeof next === 'undefined') return;
	        const desiredQty = Math.max(0, toInt(next, currentQty));
	        if(desiredQty === currentQty) return;
	        if(desiredQty <= 0){
	          if(currentQty > 0) removeOrderLine(id);
	        }else{
	          if(currentQty === 0) upsertOrderLineFromItem(it, desiredQty);
	          else setOrderQty(id, desiredQty);
	        }
	        renderOrderResults();
	        renderOrderLines();
	        return;
	      }
	      const incBtn = e.target.closest('button[data-stepper-inc]');
	      const decBtn = e.target.closest('button[data-stepper-dec]');
	      if(incBtn){
	        const id = incBtn.getAttribute('data-stepper-inc');
	        const it = getInventoryById(id);
        if(!it) return;
        const currentQty = getOrderQtyForItem(id);
        if(currentQty === 0){
          upsertOrderLineFromItem(it, 1);
        } else {
          setOrderQty(id, currentQty + 1);
        }
        renderOrderResults();
        renderOrderLines();
      } else if(decBtn){
        const id = decBtn.getAttribute('data-stepper-dec');
        const currentQty = getOrderQtyForItem(id);
        if(currentQty <= 1){
          removeOrderLine(id);
        } else {
          setOrderQty(id, currentQty - 1);
        }
        renderOrderResults();
        renderOrderLines();
      }
    });

	    const orderEmailSuggest = $('orderEmailSuggest');
	    if(orderEmailSuggest) orderEmailSuggest.addEventListener('click', (e)=>{
	      const btn = e.target.closest('button[data-suggest-email]');
	      if(!btn) return;
	      const email = String(btn.dataset.suggestEmail || '').trim();
      if(!email) return;
      const ord = orderState();
      ord.email = email;
      const inp = $('orderEmail'); if(inp) inp.value = email;
	      renderOrderPreview();
	      hideOrderEmailSuggestions();
	    });
	    if(orderEmailSuggest) orderEmailSuggest.addEventListener('mouseleave', (e)=>{
	      // Only close when the mouse leaves below the last entry (not when moving back to the input).
	      try{
	        const rect = orderEmailSuggest.getBoundingClientRect();
	        if(e && typeof e.clientY === 'number' && e.clientY >= rect.bottom - 1){
	          hideOrderEmailSuggestions();
	        }
	      }catch(e){}
	    });
	    document.addEventListener('pointerdown', (e)=>{
	      const wrap = $('orderEmailSuggest');
	      if(!wrap || !wrap.classList.contains('has-suggest')) return;
	      const inp = $('orderEmail');
	      const t = e && e.target ? e.target : null;
	      if(t && wrap.contains(t)) return;
	      if(inp && (t === inp || (t && inp.contains(t)))) return;
	      hideOrderEmailSuggestions();
	    });

    const orderHistoryList = $('orderHistoryList');
    if(orderHistoryList) orderHistoryList.addEventListener('input', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      if(btn) btn.disabled = !looksLikeEmailAddress(inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('focusin', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('click', async (e)=>{
      if(isMobileUx() && _openHistoryTrayId){
        const openDet = orderHistoryItemElById(_openHistoryTrayId);
        const trayBtn = e.target.closest('button.history-tray-btn');
        if(openDet && !trayBtn){
          e.preventDefault();
          e.stopPropagation();
          closeHistoryTrayElastic(openDet);
          return;
        }
        if(!openDet) _openHistoryTrayId = '';
      }
      const recvBtn = e.target.closest('button[data-receive-order-id]');
      if(recvBtn){
        e.preventDefault();
        e.stopPropagation();
        const id = String(recvBtn.dataset.receiveOrderId || '').trim();
        if(!id) return;
        closeHistoryTray();
        void handleOrderReceiptButtonClick(id, recvBtn);
        return;
      }
      // Delete order button
      const delBtn = e.target.closest('button[data-delete-order-id]');
	      if(delBtn){
	        e.preventDefault();
		        e.stopPropagation();
		        const id = String(delBtn.dataset.deleteOrderId || '').trim();
		        if(!id) return;
		        closeHistoryTray();
		        await deleteOrderFromHistory(id, delBtn);
	        return;
	      }
      const sugBtn = e.target.closest('button[data-forward-suggest-email]');
      if(sugBtn){
        const email = String(sugBtn.dataset.forwardSuggestEmail || '').trim();
        const wrap = sugBtn.closest('[data-forward-suggest-id]');
        const id = wrap ? String(wrap.dataset.forwardSuggestId || '').trim() : '';
        if(id && email){
          const inp = document.querySelector(`input[data-forward-email-id="${id}"]`);
          if(inp) inp.value = email;
          const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
          if(btn) btn.disabled = false;
          renderForwardEmailSuggestions(id, []);
        }
        return;
      }
      const fwdBtn = e.target.closest('button[data-forward-send-id]');
      if(fwdBtn){
        const id = String(fwdBtn.dataset.forwardSendId || '').trim();
        if(!id) return;
        void forwardOrderFromHistory(id);
      }
    });

	    // Order History (mobile): swipe to reveal Receive/Delete
	    if(orderHistoryList){
	      let _histGesture = null;
	      function resetHistGesture(){ _histGesture = null; }
	      function isOrderHistoryModalOpen(){
	        const m = $('orderHistoryModal');
	        return !!(m && m.getAttribute('aria-hidden') === 'false');
	      }
	      function isBlockingModalOpenForHistory(){
	        try{
	          const open = Array.from(document.querySelectorAll('.modal[aria-hidden="false"]'));
	          return open.some(el => el && el.id !== 'orderHistoryModal');
	        }catch(e){ return false; }
	      }
	      function findTouchById(list, id){
	        try{
	          for(let i=0;i<list.length;i++){
	            const t = list[i];
	            if(t && t.identifier === id) return t;
	          }
	        }catch(e){}
	        return null;
	      }

	      orderHistoryList.addEventListener('touchstart', (e)=>{
	        if(!isMobileUx()) return;
	        if(!isOrderHistoryModalOpen()) return;
	        if(isBlockingModalOpenForHistory()) return;
	        if(!e || !e.target) return;

	        const det = e.target.closest('details.history-item[data-order-id]');
	        if(!det) return;
	        const id = String(det.dataset.orderId || '').trim();
	        if(!id) return;

		        // Allow re-swiping the open item even though the tray overlay covers it.
		        // Only ignore direct taps on tray buttons so normal button clicks still work.
		        if(e.target.closest('button.history-tray-btn')) return;
		        if(e.target.closest('button, input, textarea, select, a')) return;

	        const t = (e.touches && e.touches[0]) ? e.touches[0] : null;
	        if(!t) return;

	        const now = performance.now();
	        const startSwipeX = getRowSwipeX(det);
	        const startSide = (startSwipeX < 0) ? 'right' : ((startSwipeX > 0) ? 'left' : null);
	        _histGesture = {
	          id,
	          det,
	          kind: 'touch',
	          touchId: t.identifier,
	          startX: t.clientX,
	          startY: t.clientY,
	          startTime: now,
	          prevMoveTime: now,
	          lastMoveTime: now,
	          prevMoveClientX: t.clientX,
	          lastMoveClientX: t.clientX,
	          startSwipeX,
	          swipeX: startSwipeX,
	          moved: false,
	          intent: null, // 'h' | 'v'
	          side: startSide, // 'left' | 'right'
	          closingFromDetent: false,
	        };
	      }, { passive:true });

	      orderHistoryList.addEventListener('touchmove', (e)=>{
	        if(!isMobileUx()) return;
	        if(!_histGesture || _histGesture.kind !== 'touch') return;
	        if(!isOrderHistoryModalOpen()) return;
	        if(isBlockingModalOpenForHistory()){ resetHistGesture(); return; }

	        const t = findTouchById(e.touches || [], _histGesture.touchId);
	        if(!t) return;

	        const dx = t.clientX - _histGesture.startX;
	        const dy = t.clientY - _histGesture.startY;
	        const ax = Math.abs(dx);
	        const ay = Math.abs(dy);

	        if(ax >= 10 || ay >= 10) _histGesture.moved = true;

	        if(!_histGesture.intent){
	          if(ax < 10 && ay < 10) return;
	          _histGesture.intent = (ax >= ay) ? 'h' : 'v';
	          if(_histGesture.intent === 'v'){ resetHistGesture(); return; }
	        }
	        if(_histGesture.intent !== 'h') return;

	        try{ e.preventDefault(); }catch(e){}

	        const now = performance.now();
	        _histGesture.prevMoveTime = _histGesture.lastMoveTime;
	        _histGesture.prevMoveClientX = _histGesture.lastMoveClientX;
	        _histGesture.lastMoveTime = now;
	        _histGesture.lastMoveClientX = t.clientX;

	        const det = _histGesture.det;
	        if(!det || !det.isConnected){ resetHistGesture(); return; }

	        const startAx = Math.abs(_histGesture.startSwipeX);
	        const startSide = traySideFromSwipeX(_histGesture.startSwipeX);
	        const startSnapPx = traySnapPxForSide(startSide);
	        const isAtDetent = startAx >= startSnapPx - 10;
	        const isSwipingBack = (_histGesture.startSwipeX < 0 && dx > 0) || (_histGesture.startSwipeX > 0 && dx < 0);

	        let nextX;
	        if(isAtDetent && isSwipingBack){
	          const dampedDx = dx * 0.35;
	          nextX = clampNum(_histGesture.startSwipeX + dampedDx, -MAX_PX, MAX_PX);
	          _histGesture.closingFromDetent = true;
	        }else{
	          nextX = clampNum(_histGesture.startSwipeX + dx, -MAX_PX, MAX_PX);
	          _histGesture.closingFromDetent = false;
	        }
	        _histGesture.swipeX = nextX;

	        let side = _histGesture.side;
	        if(Math.abs(nextX) > 6) side = (nextX < 0) ? 'right' : 'left';
	        else if(!side) side = (dx < 0) ? 'right' : 'left';
	        _histGesture.side = side || 'left';

	        prepareHistoryTrayForItem(det, _histGesture.side);
	        det.classList.add('swiping');
	        setRowSwipeX(det, nextX);
	      }, { passive:false });

	      orderHistoryList.addEventListener('touchend', (e)=>{
	        if(!isMobileUx()) return;
	        if(!_histGesture || _histGesture.kind !== 'touch') return;
	        if(!isOrderHistoryModalOpen()) return;
	        if(isBlockingModalOpenForHistory()){ resetHistGesture(); return; }

	        const ended = findTouchById(e.changedTouches || [], _histGesture.touchId);
	        if(!ended) return;

	        const { id, det, moved, intent, swipeX, startTime, startX, prevMoveTime, lastMoveTime, prevMoveClientX, lastMoveClientX, closingFromDetent } = _histGesture;
	        resetHistGesture();
	        if(!id || !det) return;

	        if(!moved){
	          // Let the native <summary> click toggle work.
	          return;
	        }

	        if(intent === 'h'){
	          try{ e.preventDefault(); }catch(e){}
	          det.classList.remove('swiping');
	          const finalX = Number.isFinite(swipeX) ? swipeX : getRowSwipeX(det);
	          const ax = Math.abs(finalX);
	          const side = (finalX < 0) ? 'right' : 'left'; // tray side

	          if(closingFromDetent){
	            closeHistoryTrayElastic(det);
	            return;
	          }

	          let vx = 0;
	          try{
	            if(Number.isFinite(lastMoveTime) && Number.isFinite(prevMoveTime) && lastMoveTime > prevMoveTime){
	              const dt = lastMoveTime - prevMoveTime;
	              vx = dt > 0 ? (lastMoveClientX - prevMoveClientX) / dt : 0;
	            }else{
	              const tNow = performance.now();
	              const dt = tNow - (Number(startTime) || tNow);
	              vx = dt > 0 ? (ended.clientX - startX) / dt : 0;
	            }
	          }catch(e){ vx = 0; }

	          const shouldCommitReceive = (side === 'right') && (ax >= COMMIT_PX);
	          if(shouldCommitReceive){
	            closeHistoryTray();
	            void handleOrderReceiptButtonClick(id, null);
	            return;
	          }
	          const shouldCommitDelete = (side === 'left') && (ax >= COMMIT_PX);
	          if(shouldCommitDelete){
	            closeHistoryTray();
	            void deleteOrderFromHistory(id, null);
	            return;
	          }

	          const fastOpen = (side === 'right') ? (vx <= -0.55) : (vx >= 0.55);
	          const fastClose = (side === 'right') ? (vx >= 0.55) : (vx <= -0.55);
	          const snapPx = traySnapPxForSide(side);
	          if(fastClose && ax < COMMIT_PX){
	            closeHistoryTray();
	          }else if(ax >= snapPx || (ax >= REVEAL_PX && fastOpen)){
	            openHistoryTrayForItem(det, side);
	          }else{
	            closeHistoryTray();
	          }
	        }
	      }, { passive:false });

	      orderHistoryList.addEventListener('touchcancel', ()=>{
	        if(!_histGesture) return;
	        try{ if(_histGesture.det) _histGesture.det.classList.remove('swiping'); }catch(e){}
	        try{ closeHistoryTray(); }catch(e){}
	        resetHistGesture();
	      }, { passive:true });
	    }
	    const orderLinesBody = $('orderLinesBody');
	    if(orderLinesBody) orderLinesBody.addEventListener('click', async (e)=>{
	      // Remove button
	      const removeBtn = e.target.closest('button[data-remove-order-id]');
	      if(removeBtn){
	        removeOrderLine(removeBtn.getAttribute('data-remove-order-id'));
	        renderOrderResults();
	        renderOrderLines();
	        return;
	      }

	      // Stepper increment
	      const incBtn = e.target.closest('button[data-line-inc]');
	      if(incBtn){
	        const id = incBtn.getAttribute('data-line-inc');
	        const ord = orderState();
	        const selectedIds = orderLineSelectedIds().filter(selId =>
	          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
	        );
	        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
	        if(isBatch){
	          for(const selId of selectedIds){
	            const currentQty = getOrderQtyForItem(selId);
	            setOrderQty(selId, currentQty + 1);
	          }
	        } else {
	          const currentQty = getOrderQtyForItem(id);
	          setOrderQty(id, currentQty + 1);
	        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
      // Stepper decrement
      const decBtn = e.target.closest('button[data-line-dec]');
      if(decBtn){
        const id = decBtn.getAttribute('data-line-dec');
        const ord = orderState();
        const selectedIds = orderLineSelectedIds().filter(selId =>
          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
        );
        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
        if(isBatch){
          for(const selId of selectedIds){
            const currentQty = getOrderQtyForItem(selId);
            if(currentQty <= 1){
              removeOrderLine(selId);
            } else {
              setOrderQty(selId, currentQty - 1);
            }
          }
        } else {
          const currentQty = getOrderQtyForItem(id);
          if(currentQty <= 1){
            removeOrderLine(id);
          } else {
            setOrderQty(id, currentQty - 1);
          }
        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
    });
    if(orderLinesBody) orderLinesBody.addEventListener('change', (e)=>{
      const cb = e.target.closest('.order-line-select');
      if(cb){
        const id = String(cb.dataset.orderSelectId || '').trim();
        if(!id) return;
        setOrderLineSelected(id, cb.checked);
        return;
      }
      // Handle inline qty input change
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput){
        const id = String(qtyInput.dataset.lineQtyInput || '').trim();
        if(!id) return;
        const currentQty = getOrderQtyForItem(id);
        const newQty = Math.max(0, toInt(qtyInput.value, currentQty));
        if(newQty === currentQty) return;
        const ord = orderState();
        const selectedIds = orderLineSelectedIds().filter(selId =>
          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
        );
        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
        if(isBatch){
          for(const selId of selectedIds){
            if(newQty <= 0) removeOrderLine(selId);
            else setOrderQty(selId, newQty);
          }
        } else {
          if(newQty <= 0){
            removeOrderLine(id);
          } else {
            setOrderQty(id, newQty);
          }
        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
    });
    // Handle Enter key on qty input
    if(orderLinesBody) orderLinesBody.addEventListener('keydown', (e)=>{
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput && e.key === 'Enter'){
        e.preventDefault();
        qtyInput.blur();
      }
    });
    // Select all text on focus for easier editing
    if(orderLinesBody) orderLinesBody.addEventListener('focus', (e)=>{
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput){
        setTimeout(()=> qtyInput.select(), 0);
      }
    }, true);
    // Handle blur explicitly for mobile browsers
    if(orderLinesBody) orderLinesBody.addEventListener('blur', (e)=>{
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput){
        const id = String(qtyInput.dataset.lineQtyInput || '').trim();
        if(!id) return;
        const currentQty = getOrderQtyForItem(id);
        const newQty = Math.max(0, toInt(qtyInput.value, currentQty));
        if(newQty === currentQty) return;
        const ord = orderState();
        const selectedIds = orderLineSelectedIds().filter(selId =>
          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
        );
        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
        if(isBatch){
          for(const selId of selectedIds){
            if(newQty <= 0) removeOrderLine(selId);
            else setOrderQty(selId, newQty);
          }
        } else {
          if(newQty <= 0){
            removeOrderLine(id);
          } else {
            setOrderQty(id, newQty);
          }
        }
        renderOrderResults();
        renderOrderLines();
      }
    }, true);

    // Add-one modal
    $('menuAddOne').addEventListener('click', ()=>{
      toggleMenu(false);
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_CREATE, 'Create permission required')) return;
      show('addOneModal', true);
      $('addName').focus();
    });
    $('btnAddCancel').addEventListener('click', ()=> show('addOneModal', false));
    $('btnAddSave').addEventListener('click', saveAddOne);
    $('addQty').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); saveAddOne(); }});
    $('addQty').addEventListener('focus', e=>{ setTimeout(()=> e.target.select(), 0); });
    $('addQtyInc').addEventListener('click', ()=>{
      const inp = $('addQty');
      inp.value = Math.max(1, toInt(inp.value, 1) + 1);
    });
    $('addQtyDec').addEventListener('click', ()=>{
      const inp = $('addQty');
      inp.value = Math.max(1, toInt(inp.value, 1) - 1);
    });
    async function saveAddOne(){
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_CREATE, 'Create permission required')) return;
      const name = String(($('addName').value||'').trim());
      const desc = String(($('addDesc').value||'').trim());
      const qty  = toInt($('addQty').value,-1);
      if(!name){ toast('Item name required'); return; }
      if(qty<=0){ toast('Qty must be > 0'); return; }
      if(state.items.some(x=> toKey(x.name)===toKey(name))){ toast('Duplicate item'); return; }

      try{
        await sbAddItem(name, desc, qty);
        await sbLoadSnapshot();
        $('addName').value=''; $('addDesc').value=''; $('addQty').value='1';
        show('addOneModal', false);
        toast('Item added');
      }catch(e){
        toast(e.message || 'Cloud add failed');
      }
    }

			    // Row delete button handler (delegated)
			    document.addEventListener('click', async (e)=>{
		      const btn = e.target.closest('.row-delete-btn');
		      if(!btn) return;
		      if(!requireOnline()) return;
		      if(!requirePermission(PERMISSIONS.ITEMS_DELETE, 'Delete not allowed')) return;
		      const id = btn.dataset.id;
      if(!id) return;
      const item = state.items.find(it => it.id === id);
      const itemName = item ? item.name : 'this item';
      if(!(await openConfirmModal('Delete item?', `Delete "${itemName}"?`, { okText:'Delete', cancelText:'Cancel' }))) return;
      try {
        const res = await sbDeleteMany([id]);
        await sbLoadSnapshot();
        toast('Item deleted', 'success');
      } catch (e) {
        toast(e.message || 'Delete failed', 'error');
      }
    });

    // Row order button handler (delegated)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.row-order-btn');
      if(!btn) return;
      const id = String(btn.dataset.id || '').trim();
      if(!id) return;
      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      const selectedIds = getSelectedRowIds();
      if(selectedIds.length > 1 && selectedIds.includes(id)){
        let added = 0;
        for(const selId of selectedIds){
          const item = getInventoryById(selId);
          if(item && upsertOrderLineFromItem(item, 1)) added++;
        }
        if(added) toast(`Added ${added} selected item(s)`);
        else toast('Selected items already in cart');
        return;
      }
      toggleOrderLineForItemId(id);
    });

    // Master checkbox + indeterminate state
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.id==='chkAll'){
        const on = e.target.checked;
        document.querySelectorAll('.rowChk').forEach(cb=> cb.checked=on);
      }
      if(e.target && e.target.classList && e.target.classList.contains('rowChk')){
        const all = document.querySelectorAll('.rowChk');
        const checked = document.querySelectorAll('.rowChk:checked');
        const m = $('chkAll');
        if(m){
          m.checked = (checked.length===all.length && all.length>0);
          m.indeterminate = (checked.length>0 && checked.length<all.length);
        }
      }
    });

    // ========================
    // Parsing helpers
    // ========================
    const parseDelimitedSmart = IMUtils.parseDelimitedSmart || function parseDelimitedSmart(text){
      const firstLine=(text.split(/\r?\n/)[0]||'');
      let delim='\t';
      const tabScore=(firstLine.split('\t').length-1);
      const commaScore=(firstLine.split(',').length-1);
      const spaceScore=((firstLine.match(/\s{2,}/g)||[]).length);
      if(commaScore>tabScore && commaScore>=spaceScore) delim=','; else if(spaceScore>tabScore && spaceScore>commaScore) delim='  ';

      const rows=[]; let row=[]; let field=''; let inQ=false; let i=0; const N=text.length;
      const isDelim=(ch,pk)=> delim==='\t'? ch==='\t' : (delim===','? ch===',' : (ch===' ' && pk===' '));
      while(i<N){
        const ch=text[i], pk=text[i+1];
        if(ch==='"'){ if(inQ && pk==='"'){ field+='"'; i+=2; continue; } inQ=!inQ; i++; continue; }
        if(!inQ && (isDelim(ch,pk) || ch==='\n')){
          row.push(field); field='';
          if(delim==='  ' && ch===' ' && pk===' '){ while(text[i]===' ') i++; continue; }
          if(ch==='\n'){ rows.push(row); row=[]; }
          i++; continue;
        }
        if(ch==='\r'){ i++; continue; }
        field+=ch; i++;
      }
      if(field.length||row.length){ row.push(field); rows.push(row); }
      return rows.filter(r=> r.some(c=> String(c).trim().length));
    };
    const rowsToItems = IMUtils.rowsToItems || function rowsToItems(rows){
      if(!rows||!rows.length) return [];
      const canon=s=> toKey(String(s).replace(/[^A-Za-z0-9]+/g,'').trim());
      const hdrsRaw=rows[0]||[]; const hdrs=hdrsRaw.map(canon);
      const idxFromHdr=names=>{ for(const n of names){ const i=hdrs.indexOf(n); if(i>=0) return i; } return -1; };
      let iItem=idxFromHdr(['ITEM','NAME']);
      let iDesc=idxFromHdr(['DESCRIPTION','DESC']);
      let iQty = idxFromHdr(['QTY','QUANTITY','COUNT','QUANTITYONHAND']);
      const hasHeader=(iItem>=0);
      if(!hasHeader){ iItem=0; iDesc=1; iQty=2; }
      const start=hasHeader?1:0; const out=[];
      for(let r=start;r<rows.length;r++){
        const row=rows[r]||[];
        const name=String((row[iItem]!==undefined? row[iItem] : '')).trim(); if(!name) continue;
        const desc=String((iDesc>=0 && row[iDesc]!==undefined? row[iDesc] : '')).trim();
        const qtyV=(iQty>=0 && row[iQty]!==undefined)? row[iQty] : 0; const qty=toInt(qtyV,0);
        out.push({name, desc, qty});
      }
      return out;
    };
    if(!IMUtils.parseDelimitedSmart) IMUtils.parseDelimitedSmart = parseDelimitedSmart;
    if(!IMUtils.rowsToItems) IMUtils.rowsToItems = rowsToItems;
    async function ensureXlsx(){
      if(window.XLSX) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load XLSX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensureDocx(){
      if(window.mammoth) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load DOCX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensurePdf(){
      if(window.pdfjsLib) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load PDF parser'));
        document.head.appendChild(s);
      });
      // Configure worker
      if(window.pdfjsLib){
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
      }
    }
    async function parsePdf(file){
      await ensurePdf();
      const buf = await file.arrayBuffer();
      const doc = await window.pdfjsLib.getDocument({ data: buf }).promise;
      const allLines = [];
      for(let p=1; p<=doc.numPages; p++){
        const page = await doc.getPage(p);
        const tc = await page.getTextContent();
        const rows = new Map(); // y -> [{x,str}]
        for(const item of tc.items){
          const t = (item.str||'').trim(); if(!t) continue;
          const tr = item.transform || [0,0,0,0,0,0];
          const x = tr[4] || 0; const y = Math.round(tr[5] || 0);
          if(!rows.has(y)) rows.set(y, []);
          rows.get(y).push({ x, str:t });
        }
        // Sort by Y descending (PDF origin bottom-left), then by X asc
        const yKeys = Array.from(rows.keys()).sort((a,b)=> b-a);
        for(const y of yKeys){
          const cols = rows.get(y).sort((a,b)=> a.x-b.x).map(o=> o.str);
          const line = cols.join(' ').replace(/\s{2,}/g,'  ').trim();
          if(line) allLines.push(line);
        }
      }
      // Try to parse with existing delimited parser
      if(allLines.length){
        const text = allLines.join('\n');
        const items = rowsToItems(parseDelimitedSmart(text));
        if(items.length) return items;
        // Fallback: pairwise lines as name/desc with qty 0
        const rows=[]; for(let i=0;i<allLines.length;i+=2){ rows.push([allLines[i]||'', allLines[i+1]||'', '0']); }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseDocx(file){
      await ensureDocx();
      const buf = await file.arrayBuffer();
      const result = await window.mammoth.convertToHtml({arrayBuffer: buf});
      const html = result && result.value ? result.value : '';
      if(!html) return [];
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      const tables = tmp.querySelectorAll('table');
      const items = [];
      if(tables.length){
        tables.forEach(tbl=>{
          const rows = Array.from(tbl.querySelectorAll('tr'))
            .map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
          const parsed = rowsToItems(rows);
          parsed.forEach(r=> items.push(r));
        });
        if(items.length) return items;
      }
      const lines = Array.from(tmp.querySelectorAll('p'))
        .map(p=> p.textContent.replace(/\u00a0/g,' ').trim())
        .filter(s=> s.length);
      if(lines.length){
        if(lines.some(l=>/[\t,]/.test(l))){
          const text = lines.join('\n');
          return rowsToItems(parseDelimitedSmart(text));
        }
        const rows = [];
        for(let i=0;i<lines.length;i++){
          const a = lines[i];
          const b = (i+1 < lines.length) ? lines[++i] : '';
          rows.push([a, b, '0']);
        }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseAnyFile(file){
      const ext=(file.name.split('.').pop()||'').toLowerCase();
      if(ext==='json'){
        const t=await file.text();
        try{
          const p=JSON.parse(t);
          if(Array.isArray(p.items)) return p.items.map(it=>({name:String(it.name||'').trim(), desc:String(it.desc||''), qty:toInt(it.qty,0)}));
          if(Array.isArray(p)) return p.map(it=>({name:String(it.Item||it.name||'').trim(), desc:String(it.Description||it.desc||''), qty:toInt(it.Qty||it.qty,0)}));
        }catch{}
        return [];
      }
      if(ext==='pdf'){ try { return await parsePdf(file); } catch { return []; } }
      if(ext==='docx' || ext==='doc'){ try { return await parseDocx(file); } catch{ return []; } }
      if(ext==='csv'||ext==='tsv'||ext==='txt'){ const t=await file.text(); return rowsToItems(parseDelimitedSmart(t)); }
      if(ext==='xlsx'||ext==='xls'){
        await ensureXlsx();
        const buf=await file.arrayBuffer();
        const wb=XLSX.read(buf,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const aoa=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
        return rowsToItems(aoa);
      }
      return [];
    }

    // ========================
    // Merge semantics (local mode)
    // ========================
    function mergeSet(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      let added=0, updated=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        let it=index.get(k);
        if(!it){
          it={id:randomUUID(), name:r.name.trim(), desc:(r.desc||'').trim(), qty:toInt(r.qty,0)};
          state.items.push(it); index.set(k,it); added++;
        }else{
          if(r.desc && r.desc.trim()) it.desc=r.desc.trim();
          it.qty=toInt(r.qty,0);
          updated++;
        }
      }
      dedupe(); setUpdated(); save();
      return {added, updated, total:imported.length};
    }

    // ========================
    // Utilities
    // ========================
    function show(id, on = true) {
  const el = document.getElementById(id);
  if (!el) return;
  if (!on) {
    // If we're hiding, and focus is inside the modal, blur it first
    if (el.contains(document.activeElement)) {
      document.activeElement.blur();
    }
    el.setAttribute('aria-hidden', 'true');
    el.style.display = 'none';
    return;
  }
	  // Show and make it accessible
	  el.style.display = 'block';
	  el.setAttribute('aria-hidden', 'false');
	  try{ closeMobileTray(); }catch(e){}
	
	  // Optional: auto-focus a sensible control
	  if (id === 'addOneModal') {
	    const inp = document.getElementById('addName');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'pasteModal') {
    const ta = document.getElementById('pasteArea');
    if (ta) setTimeout(() => ta.focus(), 0);
  } else if (id === 'orderModal') {
    const inp = document.getElementById('orderSearch');
    if (inp) setTimeout(() => inp.focus(), 0);
	  } else if (id === 'qtyEntryModal') {
	    const inp = document.getElementById('qtyEntryInput');
	    if (inp) setTimeout(() => inp.focus(), 0);
	  } else if (id === 'authModal') {
	    const inp = document.getElementById('authEmail');
	    if (inp) setTimeout(() => inp.focus(), 0);
	  } else if (id === 'msgModal') {
	    const btn = document.getElementById('btnMsgOk');
	    if (btn) setTimeout(() => btn.focus(), 0);
	  } else if (id === 'confirmModal') {
    const btn = document.getElementById('btnConfirmCancel');
    if (btn) setTimeout(() => btn.focus(), 0);
  } else if (id === 'profileModal') {
    const inp = document.getElementById('profilePhone');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'advancedCompanyModal') {
    const inp = document.getElementById('advancedCompanySearch');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'diagnosticsModal') {
    const inp = document.getElementById('diagRoleSelect');
    if (inp) setTimeout(() => inp.focus(), 0);
  }
}

    // App message modal (replaces browser alert/prompt where possible)
    let _msgCopyText = '';
    function openMsgModal(title, body, copyText){
      _msgCopyText = String(copyText || '');
      const t = $('msgTitle'); if(t) t.textContent = String(title || 'Message');
      const b = $('msgBody'); if(b) b.textContent = String(body || '');
      const btnCopy = $('btnMsgCopy');
      if(btnCopy){
        const has = !!_msgCopyText;
        btnCopy.style.display = has ? 'inline-flex' : 'none';
        btnCopy.disabled = !has;
      }
      show('msgModal', true);
    }
    function closeMsgModal(){
      _msgCopyText = '';
      show('msgModal', false);
    }
    const btnMsgOk = $('btnMsgOk');
    if(btnMsgOk) btnMsgOk.addEventListener('click', closeMsgModal);
    const btnMsgCopy = $('btnMsgCopy');
	    if(btnMsgCopy) btnMsgCopy.addEventListener('click', async ()=>{
	      if(!_msgCopyText) return;
	      try{
	        await navigator.clipboard.writeText(_msgCopyText);
	        toast('Copied');
	      }catch(e){
	        toast('Copy failed');
	      }
	    });

	    // App confirm modal (replaces browser confirm)
	    let _confirmResolve = null;
	    function openConfirmModal(title, body, opts = {}){
	      if(_confirmResolve){
	        try{ _confirmResolve(false); }catch(e){}
	        _confirmResolve = null;
	      }
	      const t = $('confirmTitle'); if(t) t.textContent = String(title || 'Confirm');
	      const b = $('confirmBody'); if(b) b.textContent = String(body || '');
	      const okText = opts && opts.okText ? String(opts.okText) : 'OK';
	      const cancelText = opts && opts.cancelText ? String(opts.cancelText) : 'Cancel';
	      const okBtn = $('btnConfirmOk'); if(okBtn) okBtn.textContent = okText;
	      const cancelBtn = $('btnConfirmCancel'); if(cancelBtn) cancelBtn.textContent = cancelText;
	      show('confirmModal', true);
	      return new Promise(resolve => { _confirmResolve = resolve; });
	    }
	    function closeConfirmModal(result){
	      show('confirmModal', false);
	      const resolve = _confirmResolve;
	      _confirmResolve = null;
	      if(resolve) resolve(!!result);
	    }
	    const btnConfirmCancel = $('btnConfirmCancel');
	    if(btnConfirmCancel) btnConfirmCancel.addEventListener('click', ()=> closeConfirmModal(false));
	    const btnConfirmOk = $('btnConfirmOk');
	    if(btnConfirmOk) btnConfirmOk.addEventListener('click', ()=> closeConfirmModal(true));
		    document.addEventListener('keydown', (e)=>{
		      if(e.key !== 'Escape') return;
		      const modal = $('confirmModal');
		      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
		      e.preventDefault();
		      closeConfirmModal(false);
		    });

		    // Qty entry modal (number prompt)
		    let _qtyEntryResolve = null;
		    let _qtyEntryOpts = {};
		    function openQtyEntryModal(title, subtitle, initialValue, opts = {}){
		      if(_qtyEntryResolve){
		        try{ _qtyEntryResolve(null); }catch(e){}
		        _qtyEntryResolve = null;
		      }
		      _qtyEntryOpts = opts || {};
		      const t = $('qtyEntryTitle'); if(t) t.textContent = String(title || 'Set Qty');
		      const sub = $('qtyEntrySubtitle');
		      if(sub){
		        const txt = String(subtitle || '').trim();
		        sub.textContent = txt;
		        sub.style.display = txt ? 'block' : 'none';
		      }
		      const input = $('qtyEntryInput');
		      if(input){
		        const min = Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'min') ? toInt(_qtyEntryOpts.min, 0) : 0;
		        input.min = String(min);
		        const hasMax = Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'max') && _qtyEntryOpts.max !== null && typeof _qtyEntryOpts.max !== 'undefined';
		        if(hasMax){
		          const max = Number(_qtyEntryOpts.max);
		          if(Number.isFinite(max) && Math.trunc(max) >= min) input.max = String(Math.trunc(max));
		          else input.removeAttribute('max');
		        }else{
		          input.removeAttribute('max');
		        }
		        input.value = String(toInt(initialValue, 0));
		      }
		      const okBtn = $('btnQtyEntryOk');
		      if(okBtn) okBtn.textContent = (_qtyEntryOpts && _qtyEntryOpts.okText) ? String(_qtyEntryOpts.okText) : 'Save';
		      const cancelBtn = $('btnQtyEntryCancel');
		      if(cancelBtn) cancelBtn.textContent = (_qtyEntryOpts && _qtyEntryOpts.cancelText) ? String(_qtyEntryOpts.cancelText) : 'Cancel';
		      show('qtyEntryModal', true);
		      setTimeout(()=>{
		        const inp = $('qtyEntryInput');
		        if(!inp) return;
		        try{ inp.focus(); inp.select(); }catch(e){}
		      }, 0);
		      return new Promise(resolve => { _qtyEntryResolve = resolve; });
		    }
		    function closeQtyEntryModal(result){
		      show('qtyEntryModal', false);
		      const resolve = _qtyEntryResolve;
		      _qtyEntryResolve = null;
		      if(resolve) resolve(result);
		    }
		    function handleQtyEntryOk(){
		      const input = $('qtyEntryInput');
		      const raw = input ? input.value : '';
		      const min = (_qtyEntryOpts && Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'min')) ? toInt(_qtyEntryOpts.min, 0) : 0;
		      const max = (_qtyEntryOpts && Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'max')) ? Number(_qtyEntryOpts.max) : NaN;
		      const q = toInt(raw, -1);
		      if(q < min){
		        toast(`Qty must be ≥ ${min}`);
		        try{ if(input){ input.focus(); input.select(); } }catch(e){}
		        return;
		      }
		      if(Number.isFinite(max) && q > Math.trunc(max)){
		        toast(`Qty must be ≤ ${Math.trunc(max)}`);
		        try{ if(input){ input.focus(); input.select(); } }catch(e){}
		        return;
		      }
		      closeQtyEntryModal(q);
		    }
		    const btnQtyEntryCancel = $('btnQtyEntryCancel');
		    if(btnQtyEntryCancel) btnQtyEntryCancel.addEventListener('click', ()=> closeQtyEntryModal(null));
		    const btnQtyEntryOk = $('btnQtyEntryOk');
		    if(btnQtyEntryOk) btnQtyEntryOk.addEventListener('click', handleQtyEntryOk);
		    const qtyEntryInput = $('qtyEntryInput');
		    if(qtyEntryInput) qtyEntryInput.addEventListener('keydown', (e)=>{
		      if(e.key==='Escape'){ e.preventDefault(); closeQtyEntryModal(null); }
		      if(e.key==='Enter'){ e.preventDefault(); handleQtyEntryOk(); }
		    });
		    document.addEventListener('keydown', (e)=>{
		      if(e.key !== 'Escape') return;
		      const modal = $('qtyEntryModal');
		      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
		      e.preventDefault();
		      closeQtyEntryModal(null);
		    });
		    function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._tmr); t._tmr=setTimeout(()=> t.style.display='none', 2000); }

    // iOS keyboard-safe scroll height
    document.addEventListener('focusin', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','60vh');
      }
    });
    document.addEventListener('focusout', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','70vh');
      }
    });

    // iOS-style qty picker
    const _qtyPicker = {
      itemId: null,
      itemName: '',
      currentQty: 0,
      selectedQty: 0,
      maxQty: 999,
      scrollY: 0,
      isDragging: false,
      startY: 0,
      startScrollY: 0
    };
    function openQtyPicker(itemId, itemName, currentQty){
      _qtyPicker.itemId = itemId;
      _qtyPicker.itemName = itemName;
      _qtyPicker.currentQty = currentQty;
      _qtyPicker.selectedQty = currentQty;
      _qtyPicker.scrollY = -currentQty * 36;
      const title = $('qtyPickerTitle');
      if(title) title.textContent = itemName || 'Order Qty';
      renderQtyPickerWheel();
      show('qtyPickerModal', true);
    }
    function closeQtyPicker(){
      show('qtyPickerModal', false);
      _qtyPicker.itemId = null;
    }
    function renderQtyPickerWheel(){
      const wheel = $('qtyPickerWheel');
      if(!wheel) return;
      let html = '';
      for(let i = 0; i <= _qtyPicker.maxQty; i++){
        const isSelected = i === _qtyPicker.selectedQty;
        html += `<div class="qty-picker-item${isSelected ? ' selected' : ''}" data-qty="${i}">${i}</div>`;
      }
      wheel.innerHTML = html;
      wheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
    }
    function updateQtyPickerSelection(){
      const wheel = $('qtyPickerWheel');
      if(!wheel) return;
      const idx = Math.round(-_qtyPicker.scrollY / 36);
      _qtyPicker.selectedQty = Math.max(0, Math.min(_qtyPicker.maxQty, idx));
      wheel.querySelectorAll('.qty-picker-item').forEach((el, i) => {
        el.classList.toggle('selected', i === _qtyPicker.selectedQty);
      });
    }
    function snapQtyPicker(){
      const idx = Math.round(-_qtyPicker.scrollY / 36);
      const clampedIdx = Math.max(0, Math.min(_qtyPicker.maxQty, idx));
      _qtyPicker.selectedQty = clampedIdx;
      _qtyPicker.scrollY = -clampedIdx * 36;
      const wheel = $('qtyPickerWheel');
      if(wheel){
        wheel.style.transition = 'transform 150ms ease-out';
        wheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
        setTimeout(()=>{ wheel.style.transition = ''; }, 150);
      }
      updateQtyPickerSelection();
    }
    function handleQtyPickerDone(){
      const id = _qtyPicker.itemId;
      const qty = _qtyPicker.selectedQty;
      if(id){
        const ord = orderState();
        const line = ord.lines.find(l => l.id === id);
        if(line){
          if(qty === 0){
            removeOrderLine(id);
          } else {
            line.qty = qty;
          }
          renderOrderLines();
        }
      }
      closeQtyPicker();
    }

    // Boot
      document.addEventListener('DOMContentLoaded', async ()=>{
      load(); render();
      try{ setEditHint(); }catch(e){}
      try{ adjustTitleSize(); if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=> requestAnimationFrame(adjustTitleSize)); } }catch(e){}
      const fb=$('filterBox'); if(fb){
        fb.value=state._filter||'';
        updateFilterClearBtn();
        fb.addEventListener('input', ()=>{ state._filter=fb.value; renderTable(); save(); updateFilterClearBtn(); });
        fb.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && fb.value){ e.preventDefault(); fb.value=''; state._filter=''; renderTable(); save(); updateFilterClearBtn(); }});
      }
	      const clr=$('btnClearFilter'); if(clr && fb){
	        clr.addEventListener('click', ()=>{
	          if(!fb.value) return;
	          fb.value='';
	          state._filter='';
          renderTable();
          save();
          updateFilterClearBtn();
          try{ fb.focus(); }catch(e){}
	        });
	      }

	      // Order counter badge - delegated handler for all [data-order-reset] elements
	      document.addEventListener('click', (e)=>{
	        const badge = e.target.closest('[data-order-reset]');
	        if(!badge) return;
	        e.preventDefault();
	        clearAllOrderLines();
	        toast('Shopping cart cleared');
	        try{ syncReportOrderIndicators(); }catch(ex){}
	      });
	      try{ updateOrderCounterBadge(); }catch(e){}

	      // iOS-style qty picker - event handlers
	      const qtyPickerCancel = $('qtyPickerCancel');
	      const qtyPickerDone = $('qtyPickerDone');
	      const qtyPickerBackdrop = document.querySelector('.qty-picker-backdrop');
	      const qtyPickerWheel = $('qtyPickerWheel');
	      if(qtyPickerCancel) qtyPickerCancel.addEventListener('click', closeQtyPicker);
	      if(qtyPickerDone) qtyPickerDone.addEventListener('click', handleQtyPickerDone);
	      if(qtyPickerBackdrop) qtyPickerBackdrop.addEventListener('click', closeQtyPicker);

	      // Wheel touch/mouse drag
	      if(qtyPickerWheel){
	        const getY = (e) => e.touches ? e.touches[0].clientY : e.clientY;
	        qtyPickerWheel.addEventListener('touchstart', (e)=>{
	          _qtyPicker.isDragging = true;
	          _qtyPicker.startY = getY(e);
	          _qtyPicker.startScrollY = _qtyPicker.scrollY;
	          qtyPickerWheel.style.transition = '';
	        }, { passive: true });
	        qtyPickerWheel.addEventListener('touchmove', (e)=>{
	          if(!_qtyPicker.isDragging) return;
	          const deltaY = getY(e) - _qtyPicker.startY;
	          _qtyPicker.scrollY = _qtyPicker.startScrollY + deltaY;
	          // Clamp scroll
	          const minScroll = -_qtyPicker.maxQty * 36;
	          _qtyPicker.scrollY = Math.max(minScroll, Math.min(0, _qtyPicker.scrollY));
	          qtyPickerWheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
	          updateQtyPickerSelection();
	        }, { passive: true });
	        qtyPickerWheel.addEventListener('touchend', ()=>{
	          _qtyPicker.isDragging = false;
	          snapQtyPicker();
	        });
	        // Click on item to select
	        qtyPickerWheel.addEventListener('click', (e)=>{
	          const item = e.target.closest('.qty-picker-item');
	          if(!item) return;
	          const qty = parseInt(item.dataset.qty, 10);
	          if(!isNaN(qty)){
	            _qtyPicker.selectedQty = qty;
	            _qtyPicker.scrollY = -qty * 36;
	            snapQtyPicker();
	          }
	        });
	      }

	      // Long-press on qty stepper in order modal to open picker
	      let _longPressTimer = null;
	      const orderLinesBody = $('orderLinesBody');
	      if(orderLinesBody){
	        orderLinesBody.addEventListener('touchstart', (e)=>{
	          const trigger = e.target.closest('[data-qty-picker-trigger]');
	          if(!trigger) return;
	          const id = trigger.dataset.qtyPickerTrigger;
	          _longPressTimer = setTimeout(()=>{
	            const ord = orderState();
	            const line = ord.lines.find(l => l.id === id);
	            if(line){
	              openQtyPicker(id, line.name, toInt(line.qty, 0));
	            }
	            _longPressTimer = null;
	          }, 500);
	        }, { passive: true });
	        orderLinesBody.addEventListener('touchend', ()=>{
	          if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer = null; }
	        });
	        orderLinesBody.addEventListener('touchmove', ()=>{
	          if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer = null; }
	        }, { passive: true });
	      }

	      const mobileSort = $('mobileSort');
	      if(mobileSort){
	        syncMobileSortSelect();
	        mobileSort.addEventListener('change', ()=>{
	          const raw = String(mobileSort.value || '');
	          const parts = raw.split(':');
	          const col = (parts[0] || '').trim();
	          const dir = (parts[1] || '').trim() === 'desc' ? 'desc' : 'asc';
	          if(!col) return;
	          state._sort = { col, dir };
	          renderTable();
	          save();
	        });
	      }

	      document.querySelectorAll('#invTable thead th.sortable .sort-ind').forEach(ind=>{
	        ind.addEventListener('click', (e)=>{
	          e.stopPropagation();
	          const th = ind.closest('th');
	          if(!th) return;
	          const col = th.getAttribute('data-col'); if(!col) return;
	          const srt = getSort();
	          if(srt.col === col){
	            state._sort = { col, dir: srt.dir === 'asc' ? 'desc' : 'asc' };
	          } else {
	            state._sort = { col, dir: 'asc' };
	          }
	          renderTable();
	          save();
	        });
	      });

	      // Supabase init and health check
	      try{
        sbInit();
        updateStatusBar();
        await sbAuthBoot();
      }catch(e){
        console.warn('Startup error', e);
        SB.connected = false;
        updateStatusBar();
      }

      // Keep the status fresh
      window.addEventListener('online', checkServerHealth);
      window.addEventListener('offline', checkServerHealth);
	      setInterval(checkServerHealth, 15000);
	
	      // Responsive: adjust desc column width on viewport change
		      window.addEventListener('resize', ()=> { try{ requestAnimationFrame(()=>{ closeMobileTray(); adjustDescColumnWidth(); adjustTitleSize(); setEditHint(); refreshTotalsLabels(); }); }catch(e){} });
	
	      // Close modals when clicking outside (on backdrop)
	      document.addEventListener('click', (e)=>{
	        try{
	          if(isMobileUx() && _openTrayId){
	            const inTray = !!e.target.closest('.card-tray');
	            const inTable = !!e.target.closest('#invTable');
	            if(!inTray && !inTable) closeMobileTray();
	          }
	        }catch(e){}
	        const modal = e.target.closest('.modal');
	        if(modal && e.target === modal){
	          if(modal.id === 'editItemModal') return;
	          show(modal.id, false);
        }
      });

      if('serviceWorker' in navigator){
        // Listen for SW activation and update flow
        let _swReloaded = false;
        navigator.serviceWorker.addEventListener('controllerchange', ()=>{
          if(_swReloaded) return; _swReloaded = true;
          try{ toast('App updated. Reloading…'); }catch{}
          setTimeout(()=> location.reload(), 400);
        });
        navigator.serviceWorker.addEventListener('message', (e)=>{
          if(!e || !e.data) return;
          if(e.data.type === 'SW_ACTIVATED'){
            // No-op: controllerchange handler above will handle reload UX
          }
        });
        navigator.serviceWorker.register('./sw.js?v=14', { scope: './' }).catch(console.warn);
      }
    });
  </script>
</body>
</html>
