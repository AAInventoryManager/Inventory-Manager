<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="manifest" href="./manifest.webmanifest?v=11" />
  <link rel="icon" type="image/svg+xml" href="./assets/modulus/favicon/favicon-light.svg?v=2" media="(prefers-color-scheme: light)" />
  <link rel="icon" type="image/svg+xml" href="./assets/modulus/favicon/favicon-dark.svg?v=2" media="(prefers-color-scheme: dark)" />
  <link rel="icon" href="./assets/modulus/favicon/favicon.ico?v=2" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@500;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@600;700;800&display=swap" rel="stylesheet">
  <title>Inventory Manager by Modulus Software, LLC</title>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- Google Places Autocomplete -->
  <script data-google-places="true" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC5LXJ43CBBfA5d-zAl03NBXwMVML2FMA8&libraries=places&callback=initGooglePlaces&v=weekly&loading=async" defer></script>

  <!-- Optional: set your Supabase URL and anon key here -->
  <script>
    // Supabase project credentials (safe to expose anon public key in client)
    const readLocalConfig = (key) => {
      try{
        return String(localStorage.getItem(key) || '').trim();
      }catch(e){
        return '';
      }
    };
    const overrideUrl = readLocalConfig('inv.sb_url');
    const overrideAnon = readLocalConfig('inv.sb_anon');
    const defaultUrl = 'https://entmbaxeylglposptsuy.supabase.co';
    const defaultAnon = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVudG1iYXhleWxnbHBvc3B0c3V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ2NjEsImV4cCI6MjA3MjQ5MDY2MX0.vDTzhL0Q-iDZShWu2hcaYOavPLltY31OThXj-ohBjAc';
    window.SB_URL  = overrideUrl || window.SB_URL || defaultUrl;
    window.SB_ANON = overrideAnon || window.SB_ANON || defaultAnon;
  </script>

  <script>
  // Lightweight observability: log JS errors so users can screenshot
  window.addEventListener('error', e => console.log('JS Error:', e.message, e.error));
  window.addEventListener('unhandledrejection', e => console.log('Promise Rejection:', e.reason));
  </script>

  <style>
    :root{
      --bg:#24292d;--fg:#eaeff7;--muted:#a9b4c0;--accent:#5aa9ff;
      --card:#000000;--border:#1f2a36;--title-min:12px;--title-max:56px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);color:var(--fg);overflow-x:hidden
    }
    body.modal-open{ overflow:hidden; }
    @media (pointer: fine){
      body{ min-width:390px; }
    }
    header{
      padding:calc(10px + env(safe-area-inset-top)) 16px 8px;
      border-bottom:1px solid var(--border);
      position:sticky;top:0;background:var(--bg);z-index:20;text-align:center;
    }
    .header-inner{ max-width:1100px; margin:0 auto; padding:0 24px; }
.status{margin-top:8px;display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#0d1420;color:#9fb3c8;appearance:none;-webkit-appearance:none;cursor:pointer;text-align:left}
.status.online{color:#ffffff;background:#0f2d18;border-color:#1b5432}
.status.offline{color:#ffffff;background:#2a1212;border-color:#5a1c1c}
    h1{margin:0;text-align:left;font-family:'Barlow',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; font-weight:800; font-size:clamp(var(--title-min), 6vw, var(--title-max)); letter-spacing:1px}
    main{padding:12px;max-width:1100px;margin:0 auto}
    #appMain{max-width:none;width:100%;margin:0}
    #appMain > .card{width:100%}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .toolbar .spacer{flex:1}
    :root{
      --glass-btn-blur: 14px;
      --glass-btn-radius: 14px;
      --glass-btn-shadow: 0 12px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.18);
      --glass-btn-shadow-hover: 0 16px 34px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.24);
      --btn-primary-bg: linear-gradient(135deg, rgba(90,169,255,0.35), rgba(90,169,255,0.12));
      --btn-primary-border: rgba(140,200,255,0.5);
      --btn-primary-color: #eaf2ff;
      --btn-secondary-bg: linear-gradient(135deg, rgba(255,255,255,0.12), rgba(255,255,255,0.04));
      --btn-secondary-border: rgba(255,255,255,0.18);
      --btn-secondary-color: #eaf2ff;
      --btn-tertiary-bg: rgba(255,255,255,0.04);
      --btn-tertiary-border: rgba(255,255,255,0.12);
      --btn-tertiary-color: #dbe4f3;
      --btn-danger-bg: linear-gradient(135deg, rgba(248,113,113,0.3), rgba(248,113,113,0.12));
      --btn-danger-border: rgba(248,113,113,0.5);
      --btn-danger-color: #ffecec;
    }
    .btn-primary,
    .btn-secondary,
    .btn-tertiary{
      position:relative;
      cursor:pointer;
      border:1px solid transparent;
      padding: clamp(10px, 2.2vw, 12px) clamp(12px, 3vw, 16px);
      border-radius:var(--glass-btn-radius);
      font-weight:700;
      font-size: clamp(14px, 2.8vw, 16px);
      line-height:1.1;
      white-space:nowrap;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      backdrop-filter: blur(var(--glass-btn-blur));
      -webkit-backdrop-filter: blur(var(--glass-btn-blur));
      box-shadow: var(--glass-btn-shadow);
      transition: transform 160ms ease, box-shadow 200ms ease, border-color 200ms ease, background 200ms ease, color 200ms ease;
      overflow:hidden;
      text-decoration:none;
      font-family:inherit;
    }
    .btn-primary{ background:var(--btn-primary-bg); border-color:var(--btn-primary-border); color:var(--btn-primary-color); }
    .btn-secondary{ background:var(--btn-secondary-bg); border-color:var(--btn-secondary-border); color:var(--btn-secondary-color); }
    .btn-tertiary{ background:var(--btn-tertiary-bg); border-color:var(--btn-tertiary-border); color:var(--btn-tertiary-color); }
    .btn-danger{ background:var(--btn-danger-bg); border-color:var(--btn-danger-border); color:var(--btn-danger-color); }
    .btn-primary:hover,
    .btn-secondary:hover,
    .btn-tertiary:hover{
      transform: translateY(-1px);
      box-shadow: var(--glass-btn-shadow-hover);
      border-color: rgba(255,255,255,0.45);
    }
    .btn-primary:active,
    .btn-secondary:active,
    .btn-tertiary:active{
      transform: translateY(1px) scale(0.98);
    }
    .btn-primary:focus-visible,
    .btn-secondary:focus-visible,
    .btn-tertiary:focus-visible,
    .icon-btn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 2px rgba(125,211,252,0.6), var(--glass-btn-shadow);
    }
    .btn-with-icon svg{
      width:16px;
      height:16px;
    }
    .btn-sm{
      padding:8px 12px;
      min-height:36px;
      font-size:13px;
    }
    .btn-primary[disabled],
    .btn-secondary[disabled],
    .btn-tertiary[disabled],
    .btn-primary[aria-disabled="true"],
    .btn-secondary[aria-disabled="true"],
    .btn-tertiary[aria-disabled="true"]{
      opacity:0.4;
      cursor:not-allowed;
      pointer-events:none;
      transform:none;
    }
    .btn-spinner{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
    }
    .btn-spinner svg{
      width:18px;
      height:18px;
      animation:btn-spin 1s linear infinite;
    }
    button[data-loading="true"]{
      pointer-events:none;
    }
    button[data-loading="true"] > *:not(.btn-spinner){
      opacity:0;
    }
    button[data-loading="true"] .btn-spinner{
      opacity:1;
    }
    @keyframes btn-spin{
      from{ transform:rotate(0deg); }
      to{ transform:rotate(360deg); }
    }
    .btn-ripple{
      position:absolute;
      border-radius:50%;
      transform:scale(0);
      background:rgba(255,255,255,0.3);
      animation:btn-ripple 500ms ease-out;
      pointer-events:none;
      width:20px;
      height:20px;
      left:0;
      top:0;
    }
    @keyframes btn-ripple{
      from{ transform:scale(0); opacity:0.5; }
      to{ transform:scale(4); opacity:0; }
    }
    /* Modern toggle switch */
    .toggle-switch{
      position:relative;
      width:48px;
      height:26px;
      flex-shrink:0;
    }
    .toggle-switch input{
      opacity:0;
      width:0;
      height:0;
      position:absolute;
    }
    .toggle-slider{
      position:absolute;
      cursor:pointer;
      inset:0;
      background:#374151;
      border-radius:26px;
      transition:background 0.25s ease, box-shadow 0.25s ease;
    }
    .toggle-slider::before{
      content:'';
      position:absolute;
      width:20px;
      height:20px;
      left:3px;
      bottom:3px;
      background:#fff;
      border-radius:50%;
      transition:transform 0.25s ease;
      box-shadow:0 1px 3px rgba(0,0,0,0.3);
    }
    .toggle-switch input:checked + .toggle-slider{
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.4);
    }
    .toggle-switch input:checked + .toggle-slider::before{
      transform:translateX(22px);
    }
    .toggle-switch input:focus + .toggle-slider{
      box-shadow:0 0 0 2px rgba(34,197,94,0.3);
    }
    .muted{color:var(--muted);font-size:12px}
    .time{font-size:12px;color:var(--muted)}
    .scroll{overflow:auto;max-height:70vh;border-radius:10px;position:relative;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
    #tableWrap{ overflow-x:hidden; position:relative; width:100%; max-width:100%; min-width:0; }
    table{width:100%;border-collapse:collapse;font-size:15px}
    #invTable{ width:100%; table-layout:fixed; min-width:0; }
    #invTable th,
    #invTable td{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
	    thead th{
	      text-align:center;color:#e2e8f0;font-weight:700;border-bottom:2px solid var(--border);
	      padding:14px 12px;position:sticky;top:0;background:#0d1117;z-index:7;
	      text-transform:uppercase;font-size:12px;letter-spacing:0.5px;
	      white-space:nowrap;
	    }
	    #invTable thead th::after{
	      content:'';
	      position:absolute;
	      right:0;
	      top:8px;
	      bottom:8px;
	      width:2px;
	      background:rgba(148,163,184,0.55);
	    }
	    #invTable thead th:last-child::after{ display:none; }
	    /* Table header alignment + contrast */
    #invTable thead th[data-col="name"]{
      text-align:left;
    }
    #invTable thead th.actions{
      text-align:right;
      padding-right:14px;
    }
    #invTable thead th.align-left,
    #invTable tbody td.align-left{
      text-align:left;
    }
    #invTable thead th.num,
    #invTable tbody td.num{
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    #invTable tbody td[data-col="name"]{ padding:10px 12px; }
    th.sortable{ cursor:pointer; user-select:none }
    th.sortable .sort-ind{
      margin-left:6px;
      display:inline-block;
      padding:4px 6px;
      border-radius:4px;
      transition:background 0.15s, opacity 0.15s;
    }
    th.sortable .sort-ind:hover{ background:rgba(148,163,184,0.2) }
    th.sorted-asc .sort-ind::before{ content:'\25B2'; opacity:1 }
    th.sorted-desc .sort-ind::before{ content:'\25BC'; opacity:1 }
    tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
    td.actions{padding:8px 14px 8px 6px;text-align:right}
    .actions-wrap{display:inline-flex;gap:8px;align-items:center;justify-content:flex-end}
    .inv-item-main{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      width:100%;
    }
    .inv-row-check{
      width:22px;
      height:22px;
      flex:0 0 auto;
      touch-action:manipulation;
    }
    .inv-item-line{
      display:flex;
      align-items:baseline;
      gap:12px;
      min-width:0;
      flex:1 1 auto;
      overflow:hidden;
      white-space:nowrap;
    }
    .inv-item-name{
      font-weight:800;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    #invTable tbody tr.card-expanded td{
      border-bottom-color: transparent;
    }
    .inv-detail-row td{
      padding:0 12px 14px;
      border-bottom:1px solid var(--border);
    }
    .inv-detail-panel{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.18);
      background:linear-gradient(145deg, rgba(15,20,30,0.85), rgba(12,16,24,0.9));
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .inv-detail-section{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .inv-detail-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      font-weight:600;
    }
    .inv-detail-metrics{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:10px;
    }
    .inv-detail-metric{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .inv-detail-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .inv-detail-value{
      font-weight:600;
      color:var(--fg);
      min-width:0;
    }
    .inv-detail-incoming{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(99,102,241,0.35);
      background:rgba(99,102,241,0.12);
      color:#c4b5fd;
      font-size:11px;
      font-weight:600;
      line-height:1;
      max-width:100%;
    }
    .inv-detail-incoming .icon{
      width:14px;
      height:14px;
    }
    .inv-detail-incoming-text{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .inv-detail-desc{
      color:var(--muted);
      line-height:1.3;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
    .inv-detail-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    #invTable tbody td[data-col="desc"] .cell-val{
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
      white-space:normal;
      overflow:hidden;
      line-height:1.25;
    }
    .inv-item-signals{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      overflow:hidden;
    }
    .inv-item-signals:empty{ display:none; }
    .inv-signal{
      display:inline-flex;
      align-items:baseline;
      gap:6px;
      min-width:0;
      max-width:220px;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .inv-signal-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      flex:0 0 auto;
    }
    .inv-signal-value{
      color:var(--fg);
      font-weight:600;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .inv-item-qty{
      margin-top:6px;
      display:none;
    }
    .inv-item-qty-label{
      display:block;
      margin-bottom:6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .inv-select-all{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .inv-select-all input{
      width:16px;
      height:16px;
    }
    @media (max-width: 520px){
      .inv-item-signals{ gap:6px; }
      .inv-signal{ max-width:140px; font-size:11px; }
    }
    @media (max-width: 720px){
      .inv-detail-metrics{
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .icon{
      width:18px;
      height:18px;
      display:block;
    }
    .icon-sm{
      width:16px;
      height:16px;
    }
    .icon-btn{
      position:relative;
      width:36px;
      height:36px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.06);
      color:#e2e8f0;
      cursor:pointer;
      transition: transform 160ms ease, box-shadow 200ms ease, border-color 200ms ease, background 200ms ease, color 200ms ease;
      backdrop-filter: blur(var(--glass-btn-blur));
      -webkit-backdrop-filter: blur(var(--glass-btn-blur));
      box-shadow: var(--glass-btn-shadow);
      overflow:hidden;
      padding:0;
      touch-action:manipulation;
      -webkit-appearance:none;
      appearance:none;
    }
    .icon-btn svg{ width:18px; height:18px; }
    .icon-btn--default{ color:#e2e8f0; }
    .icon-btn--success{
      color:#34d399;
      border-color:rgba(52,211,153,0.4);
      background:rgba(52,211,153,0.12);
    }
    .icon-btn--danger{
      color:#f87171;
      border-color:rgba(248,113,113,0.4);
      background:rgba(248,113,113,0.12);
    }
    .icon-btn:hover{
      transform: translateY(-1px);
      box-shadow: var(--glass-btn-shadow-hover);
      border-color: rgba(255,255,255,0.45);
    }
    .icon-btn:active{
      transform: translateY(1px) scale(0.98);
    }
    .icon-btn:disabled,
    .icon-btn[aria-disabled="true"]{
      opacity:0.4;
      cursor:not-allowed;
      pointer-events:none;
      transform:none;
    }
    .row-order-btn .order-check{ opacity:0; transition:opacity 0.15s; }
    .row-order-btn.row-order-btn--active .order-check{ opacity:1; }
    .row-order-btn.row-order-btn--active{
      background:rgba(52,211,153,0.18);
      border-color:rgba(52,211,153,0.45);
      color:#34d399;
    }
					    /* Hidden by default (mobile-only UI elements) */
					    .card-leds,
					    .card-tray{
				      display:none;
				    }
				    @media (hover: hover) and (pointer: fine){
				      #invTable tbody tr[data-id]{
				        transition: filter 160ms ease, background 160ms ease;
				        transition-delay: 0ms;
				        filter:none;
				      }
				      #invTable tbody tr[data-id]:hover{
				        transition-delay: 200ms; /* avoids flicker while scrolling */
				        filter:
				          drop-shadow(0 0 8px rgba(59,130,246,0.40))
				          drop-shadow(0 0 20px rgba(59,130,246,0.22));
				        background: linear-gradient(90deg, rgba(59,130,246,0.08) 0%, rgba(59,130,246,0.04) 50%, transparent 100%);
				      }
				      #invTable tbody tr.order-selected{
				        background:
				          radial-gradient(220px 120px at 40% 35%, rgba(34,197,94,0.20), rgba(34,197,94,0) 70%),
				          linear-gradient(145deg, rgba(34,197,94,0.12) 0%, #12161c 100%);
				      }
				      #invTable tbody tr.order-selected td{
				        background:transparent;
				        border-bottom-color: rgba(34,197,94,0.28);
				      }
				      .inv-item-name,
				      .inv-signal-value{
				        display:block;
				        white-space:nowrap;
				        overflow:hidden;
				        text-overflow:ellipsis;
				      }
				    }
				    /* Mobile table layout: unified columns + swipe tray */
					    @media (pointer: coarse){
					      /* Ensure last row can scroll above mobile browser UI controls */
				      #tableWrap{
				        box-sizing:border-box;
				        width:100%;
				        max-width:100%;
				        padding-bottom:env(safe-area-inset-bottom);
				        scroll-padding-bottom:env(safe-area-inset-bottom);
				      }
				      #invTable{
                width:100%;
                min-width:0;
                table-layout:fixed;
              }
				      #invTable thead{ display:table-header-group; }
				      #invTable tbody{ display:table-row-group; width:100%; }
				      #invTable tbody tr[data-id]{
				        position:relative;
				        isolation:isolate;
				        min-height:68px;
				        --swipe-x: 0px;
			        --tray-progress: 0;
			        --tray-outer: 0;
			        --tray-inner: 0;
			        --focus-y: 0px;
			        --spot-i: 0;
			        --spot-a0: 0;
			        --spot-a1: 0;
			        --spot-a2: 0;
			        --spot-x: 0px;
			        --spot-y: 0px;
			        --spot-rx: 120px;
			        --spot-ry: 74px;
			        touch-action: pan-y;
			        transition: transform 180ms ease;
			        will-change: transform;
			        transform: translateX(var(--swipe-x)) translateY(var(--focus-y));
				      }
				      /* Elastic snap-back animation when releasing from detent */
				      #invTable tbody tr[data-id].snap-elastic{
				        transition: transform 380ms cubic-bezier(0.175, 0.885, 0.32, 1.175) !important;
				      }
		      #invTable tbody tr[data-id] td{
		        padding:14px 12px;
		        min-height:68px;
		        height:auto;
		        vertical-align:middle;
		        border-bottom:1px solid rgba(255,255,255,0.08);
		        position:static;
		        overflow:visible;
		        background:rgba(10,12,18,0.82);
		      }
		      #invTable tbody tr[data-id]:nth-child(even) td{
		        background:rgba(12,15,22,0.88);
		      }
		      #invTable tbody tr[data-id] td .cell-val{
		        display:block;
		        overflow:hidden;
		        text-overflow:ellipsis;
		        white-space:nowrap;
		      }
		      #invTable tbody tr[data-id] td[data-col="desc"] .cell-val{
		        display:-webkit-box;
		        -webkit-line-clamp:2;
		        -webkit-box-orient:vertical;
		        white-space:normal;
		      }
		      #invTable tbody tr[data-id] td[data-col="name"]{
		        position:static; /* Allow tray to position relative to tr, not td */
		      }
		      #invTable tbody tr[data-id] td[data-col]::before{ display:none !important; }
		      /* Mobile UX v2: no inline action buttons (swipe tray only) */
		      #invTable thead th.actions,
		      #invTable tbody td.actions,
		      #invTable tbody td.actions .actions-wrap{ display:none !important; }

			      /* Mobile UX v2: order/override LEDs */
			      #invTable tbody tr[data-id] .card-leds{
			        position:absolute;
			        top:50%;
			        right:10px;
              transform:translateY(-50%);
			        display:flex;
			        gap:6px;
			        pointer-events:none;
			        z-index:4;
			      }
			      #invTable tbody tr[data-id] .card-led{
			        width:10px;
			        height:10px;
			        border-radius:50%;
			        background:rgba(255,255,255,0.26);
			        border:1px solid rgba(255,255,255,0.45);
			        box-shadow:0 6px 12px rgba(0,0,0,0.35), inset 0 1px 2px rgba(255,255,255,0.35);
			        backdrop-filter: blur(8px);
			        transition: background 200ms ease, box-shadow 200ms ease, filter 200ms ease;
			      }
			      #invTable tbody tr[data-id] .card-led.card-led--on{ filter:saturate(1.15); }
			      #invTable tbody tr[data-id] .card-led.card-led--lowstock.card-led--on{
			        background:rgba(245,158,11,0.7);
			        box-shadow: 0 0 10px rgba(245,158,11,0.45), inset 0 1px 2px rgba(255,255,255,0.25);
			      }
			      #invTable tbody tr[data-id] .card-led.card-led--lowstock.card-led--outofstock{
			        background:rgba(239,68,68,0.75);
			        box-shadow: 0 0 10px rgba(239,68,68,0.5), inset 0 1px 2px rgba(255,255,255,0.25);
			      }

				      /* Mobile UX v2: iMessage-style swipe tray (Edit / Add to Job / Order) */
				      #invTable tbody tr[data-id] .card-tray{
				        position:absolute;
				        inset:0;
				        transform:translateX(calc(0px - var(--swipe-x, 0px)));
				        display:flex;
				        flex-direction:row;
				        align-items:center;
				        justify-content:flex-end;
				        gap:6px;
				        opacity:1;
				        pointer-events:none;
				        z-index:1;
				      }
				      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray{
				        justify-content:flex-start;
				      }
				      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray{
				        justify-content:flex-end;
				      }
				      #invTable tbody tr[data-id].tray-open .card-tray{
				        pointer-events:auto;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn{
				        width:72px;
				        min-width:72px;
				        height:100%;
				        border:0;
				        border-radius:0;
				        background:transparent;
				        color:#e5e7eb;
				        display:flex;
				        align-items:center;
				        justify-content:center;
				        padding:4px;
				        cursor:pointer;
				        touch-action:manipulation;
				        -webkit-appearance:none;
				        appearance:none;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn:active{
				        filter:brightness(0.96);
				      }

				      #invTable tbody tr[data-id] .card-tray-btn svg{
				        width:28px;
				        height:28px;
				        display:block;
				        opacity:0;
				        transform:scale(0.4);
				        transition: opacity 160ms ease, transform 160ms ease;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn .order-check{ opacity:0; transition:opacity 0.15s; }
				      #invTable tbody tr[data-id].order-selected .card-tray-btn .order-check{ opacity:1; }
				      #invTable tbody tr[data-id] .card-tray-btn svg *{
				        stroke-width:2.4px;
				      }

					      /* High-contrast strokes (no action background colors) */
						      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="edit"]{
						        color:#60a5fa;
						      }
						      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="delete"]{
						        color:#f87171;
						      }
						      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="job"]{
						        color:#7dd3fc;
						      }
						      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="order"]{
					        color:#22c55e;
					      }
					      /* Subtle tint behind swipe trays */
					      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray{
					        background: linear-gradient(90deg, rgba(34,197,94,0.14) 0%, rgba(34,197,94,0.0) 72%);
					      }
					      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray{
					        background: linear-gradient(270deg, rgba(248,113,113,0.14) 0%, rgba(248,113,113,0.0) 72%);
					      }

				      /* Sequential icon reveal: outer icon first, then inner icon */
				      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray-btn:last-child svg{
				        opacity: var(--tray-outer, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
			      }
			      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray-btn:first-child svg{
			        opacity: var(--tray-inner, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-inner, 0))));
			      }
			      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray-btn:first-child svg{
			        opacity: var(--tray-outer, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
			      }
				      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray-btn:last-child svg{
				        opacity: var(--tray-inner, 0);
				        transform: scale(calc(0.4 + (0.6 * var(--tray-inner, 0))));
				      }
				      /* Single-icon tray (order): reveal uses outer progress */
				      #invTable tbody tr[data-id][data-tray-side] .card-tray-btn:only-child svg{
				        opacity: var(--tray-outer, 0);
				        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
				      }

				      /* Rounded outer corners to match the card */
				      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray-btn:last-child{
				        border-top-right-radius:14px;
			        border-bottom-right-radius:14px;
			      }
			      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray-btn:first-child{
			        border-top-left-radius:14px;
			        border-bottom-left-radius:14px;
			      }

				      /* Glow effect on edit icon - fades in based on --commit-progress variable */
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="edit"] svg{
				        filter: drop-shadow(0 0 calc(16px * var(--commit-progress, 0)) rgba(96,165,250, var(--commit-progress, 0)));
				      }
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="delete"] svg{
				        filter: drop-shadow(0 0 calc(14px * var(--commit-progress, 0)) rgba(248,113,113, var(--commit-progress, 0)));
				      }
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="job"] svg{
				        filter: drop-shadow(0 0 calc(14px * var(--commit-progress, 0)) rgba(125,211,252, var(--commit-progress, 0)));
				      }
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="order"] svg{
				        filter: drop-shadow(0 0 calc(14px * var(--commit-progress, 0)) rgba(34,197,94, var(--commit-progress, 0)));
				      }
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="order"] .order-check{
				        opacity:0;
				        transition: opacity 160ms ease;
				      }
				      #invTable tbody tr[data-id].order-selected .card-tray-btn[data-tray-action="order"] .order-check{
				        opacity:1;
				      }
				      /* Elastic stretch effect on edit icon when approaching commit threshold */
				      #invTable tbody tr[data-id].commit-armed .card-tray-btn[data-tray-action="edit"] svg{
				        transform: scale(1.03) !important;
				      }

				      /* Mobile UX v2: ensure steppers meet 48Ã—48 target */
				      .qty-step{ min-width:48px; min-height:48px; }
				      .qty-stepper--table .qty-step{ min-width:48px; }
				      #invTable tbody tr[data-id] .qty-stepper.qty-stepper--table{ gap:8px; }
				      #invTable tbody tr[data-id] .qty-stepper--table .qty-value{
				        min-width:3.25rem;
				        height:48px;
				        display:inline-flex;
				        align-items:center;
				        justify-content:center;
				        font-size:22px;
				        font-weight:900;
				      }
				      #invTable tbody tr[data-id].swiping .card-tray,
				      #invTable tbody tr[data-id].swiping .card-tray-btn,
				      #invTable tbody tr[data-id].swiping .card-tray-btn svg{ transition:none !important; }
				      #invTable tbody tr[data-id].swiping{ transition:none !important; }

				      /* Order History (mobile): swipe actions (Receive / Delete) */
				      #orderHistoryList .history-actions{ display:none; }
				      #orderHistoryList details.history-item{
				        position:relative;
				        isolation:isolate;
				        --swipe-x: 0px;
				        --tray-progress: 0;
				        --tray-outer: 0;
				        --tray-inner: 0;
				        --commit-progress: 0;
				        border:none;
				        background:none;
				        touch-action: pan-y;
				        transition: transform 180ms ease;
				        will-change: transform;
				        transform: translateX(var(--swipe-x));
				      }
				      #orderHistoryList details.history-item.snap-elastic{
				        transition: transform 380ms cubic-bezier(0.175, 0.885, 0.32, 1.175) !important;
				      }
				      #orderHistoryList details.history-item::after{
				        content:'';
				        position:absolute;
				        inset:0;
				        border:1px solid var(--border);
				        border-radius:12px;
				        background:transparent;
				        box-shadow:none;
				        z-index:2;
				        pointer-events:none;
				      }
				      #orderHistoryList details.history-item .history-header,
				      #orderHistoryList details.history-item .history-meta,
				      #orderHistoryList details.history-item .history-body{
				        position:relative;
				        z-index:3;
				      }
				      #orderHistoryList details.history-item .history-address{
				        margin-top:4px;
				        white-space:pre-wrap;
				      }
				      #orderHistoryList details.history-item .history-caret{
				        z-index:3;
				      }
				      #orderHistoryList details.history-item .history-tray{
				        position:absolute;
				        inset:0;
				        transform:translateX(calc(0px - var(--swipe-x, 0px)));
				        display:flex;
				        flex-direction:row;
				        align-items:center;
				        justify-content:flex-end;
				        gap:8px;
				        opacity:1;
				        pointer-events:none;
				        z-index:1;
				      }
				      #orderHistoryList details.history-item.tray-open .history-tray{
				        pointer-events:auto;
				      }
				      #orderHistoryList details.history-item[data-tray-side="left"] .history-tray{
				        background: linear-gradient(90deg, rgba(239,68,68,0.18) 0%, rgba(239,68,68,0) 72%);
				      }
				      #orderHistoryList details.history-item[data-tray-side="right"] .history-tray{
				        background: linear-gradient(270deg, rgba(59,130,246,0.18) 0%, rgba(59,130,246,0) 72%);
				      }
				      #orderHistoryList details.history-item .history-tray-btn{
				        width:86px;
				        height:100%;
				        border:0;
				        border-radius:0;
				        background:transparent;
				        color:#e5e7eb;
				        display:flex;
				        align-items:center;
				        justify-content:center;
				        padding:4px;
				        cursor:pointer;
				        touch-action:manipulation;
				        -webkit-appearance:none;
				        appearance:none;
				      }
				      #orderHistoryList details.history-item .history-tray-btn--delete{ color:#ef4444; }
				      #orderHistoryList details.history-item .history-tray-btn--receive{ color:#3b82f6; }
				      #orderHistoryList details.history-item .history-tray-btn--delete{
				        border-top-left-radius:12px;
				        border-bottom-left-radius:12px;
				      }
				      #orderHistoryList details.history-item .history-tray-btn--receive{
				        border-top-right-radius:12px;
				        border-bottom-right-radius:12px;
				        border-top-left-radius:12px;
				        border-bottom-left-radius:12px;
				      }
				      #orderHistoryList details.history-item .history-tray-btn svg{
				        width:55px;
				        height:55px;
				        display:block;
				        opacity:0;
				        transform:scale(0.4);
				        transition: opacity 160ms ease, transform 160ms ease, filter 160ms ease;
				      }
				      #orderHistoryList details.history-item .history-tray-btn svg *{
				        stroke-width:2.4px;
				      }
				      #orderHistoryList details.history-item .history-tray-btn--receive .recv-check{
				        opacity:0;
				        transition: opacity 160ms ease;
				      }
				      #orderHistoryList details.history-item.order-received .history-tray-btn--receive .recv-check{
				        opacity:1;
				      }

				      /* Reveal: only the active-side icon animates in */
				      #orderHistoryList details.history-item[data-tray-side="left"] .history-tray-btn--delete svg{
				        opacity: var(--tray-outer, 0);
				        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
				        filter: drop-shadow(0 0 calc(14px * var(--commit-progress, 0)) rgba(239,68,68, var(--commit-progress, 0)));
				      }
				      #orderHistoryList details.history-item[data-tray-side="left"] .history-tray-btn--receive svg{
				        opacity:0;
				        transform:scale(0.4);
				        filter:none;
				      }
				      #orderHistoryList details.history-item[data-tray-side="right"] .history-tray-btn--receive svg{
				        opacity: var(--tray-outer, 0);
				        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
				        filter: drop-shadow(0 0 calc(14px * var(--commit-progress, 0)) rgba(59,130,246, var(--commit-progress, 0)));
				      }
				      #orderHistoryList details.history-item[data-tray-side="right"] .history-tray-btn--delete svg{
				        opacity:0;
				        transform:scale(0.4);
				        filter:none;
				      }

				      #orderHistoryList details.history-item.swiping,
				      #orderHistoryList details.history-item.swiping .history-tray,
				      #orderHistoryList details.history-item.swiping .history-tray-btn,
				      #orderHistoryList details.history-item.swiping .history-tray-btn svg{ transition:none !important; }
			    }
		    @media (prefers-reduced-motion: reduce){
		      #invTable tbody tr[data-id]{ transition:none !important; }
		      #invTable tbody tr[data-id]::before{ transition:none !important; }
		      #invTable tbody tr[data-id]::after{ transition:none !important; }
		      #invTable tbody tr[data-id] .card-tray{ transition:none !important; }
		    }

    /* Desktop description: keep on one line (dynamic width handles it) */
    @media (min-width: 769px){ td[data-col="desc"], th[data-col="desc"]{ white-space:nowrap; } }
	    td.qty{text-align:center;font-variant-numeric:tabular-nums}
    th.sel, td.sel{ width:42px; text-align:center }
    input[type=text],input[type=number],input[type=email],input[type=password],input[type=tel],textarea,select{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
      background:#0d131b;color:#fff;font-size:16px
    }
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .hero-logo{height:clamp(36px,8vw,56px); margin:10px auto 0 auto;}
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .brandrow{display:flex;align-items:center;justify-content:space-between;gap:14px}
    .title-logo{
      width:min(420px, 68vw);
      height:auto;
      display:block;
      margin:0 auto;
    }
	    .brandtext{display:flex;align-items:center;justify-content:center;flex:1;min-width:0;}
	    .site-footer{
	      max-width:1100px;
	      margin:16px auto 26px;
	      padding:0 16px 8px;
	      text-align:center;
	      color:var(--muted);
	      font-size:12px;
	    }
    .footer-logo{
      height:26px;
      width:auto;
      display:block;
      margin:0 auto 8px;
      opacity:.9;
    }
	    @media (max-width: 768px){
	      .footer-logo{ height:22px; }
	    }
      @media (max-width: 768px){
        #tableWrap{ width:100%; max-width:100%; min-width:0; }
      }
	    .inv-controls{ display:flex; align-items:center; justify-content:center; gap:10px; width:100%; flex-wrap:wrap; }
	    .inv-filter-group{ display:flex; align-items:center; gap:10px; flex:1 1 520px; flex-wrap:wrap; justify-content:flex-start; }
	    .input-wrap{ position:relative; width:100%; max-width:480px; }
	    .inv-filter-pills{
	      display:flex;
	      align-items:center;
	      gap:8px;
	      flex-wrap:wrap;
	    }
	    .inv-filter-pill{
	      min-height:36px;
	      padding:6px 14px;
	      border-radius:999px;
	      border:1px solid rgba(148,163,184,0.2);
	      background:rgba(12,16,22,0.5);
	      color:#cbd5f5;
	      font-size:12px;
	      font-weight:600;
	      letter-spacing:0.01em;
	      transition:background 160ms ease, border-color 160ms ease, color 160ms ease, transform 160ms ease, box-shadow 160ms ease;
	      backdrop-filter: blur(10px);
	      -webkit-backdrop-filter: blur(10px);
	    }
	    .inv-filter-pill:hover{ background:rgba(15,23,42,0.65); }
	    .inv-filter-pill:focus-visible{
	      outline:2px solid rgba(96,165,250,0.7);
	      outline-offset:2px;
	    }
	    .inv-filter-pill.is-active{
	      color:#f8fafc;
	      box-shadow:0 8px 18px rgba(0,0,0,0.28);
	    }
	    .inv-filter-pill.is-active[data-filter="all"]{
	      background:rgba(148,163,184,0.18);
	      border-color:rgba(148,163,184,0.55);
	      color:#e2e8f0;
	    }
	    .inv-filter-pill.is-active[data-filter="in_stock"]{
	      background:rgba(34,197,94,0.18);
	      border-color:rgba(34,197,94,0.6);
	      color:#bbf7d0;
	    }
	    .inv-filter-pill.is-active[data-filter="low_stock"]{
	      background:rgba(245,158,11,0.2);
	      border-color:rgba(245,158,11,0.65);
	      color:#fde68a;
	    }
	    .inv-filter-pill.is-active[data-filter="out_of_stock"]{
	      background:rgba(239,68,68,0.2);
	      border-color:rgba(239,68,68,0.65);
	      color:#fecaca;
	    }
	    .sort-wrap{ display:flex; align-items:center; flex:0 0 auto; min-width:180px; }
	    .columns-wrap{ position:relative; flex:0 0 auto; }
	    .column-builder{
	      position:absolute;
	      right:0;
	      top:calc(100% + 10px);
	      min-width:240px;
	      max-width:340px;
	      background:rgba(13,20,29,0.92);
	      border:1px solid var(--border);
	      border-radius:14px;
	      padding:12px;
	      box-shadow:0 18px 40px rgba(0,0,0,0.4);
	      backdrop-filter: blur(18px);
	      -webkit-backdrop-filter: blur(18px);
	      z-index:140;
	      display:none;
	    }
	    .column-builder.open{ display:block; }
	    .column-builder.dragging-panel{ opacity:0.96; }
	    .column-builder--centered{
	      position:fixed;
	      left:50%;
	      top:50%;
	      right:auto;
	      transform:translate(-50%, -50%);
	      max-width:min(360px, 92vw);
	      width:min(360px, 92vw);
	    }
	    .column-builder-header{
	      display:flex;
	      align-items:flex-start;
	      justify-content:space-between;
	      gap:12px;
	    }
	    .column-builder-title{ font-weight:800; font-size:13px; letter-spacing:0.02em; }
	    .column-builder-subtitle{ color:var(--muted); font-size:12px; margin-top:4px; }
	    .column-builder-drag{
	      flex:0 0 auto;
	      width:28px;
	      height:28px;
	      border-radius:8px;
	      border:1px solid var(--border);
	      background:#0d131b;
	      cursor:grab;
	      display:inline-flex;
	      align-items:center;
	      justify-content:center;
	      color:#7c8aa0;
	      padding:0;
	      touch-action:none;
	    }
	    .column-builder-drag:active{ cursor:grabbing; }
	    .column-builder-drag::before{
	      content:'';
	      width:14px;
	      height:10px;
	      background:
	        linear-gradient(#7c8aa0,#7c8aa0) 0 0 / 14px 2px,
	        linear-gradient(#7c8aa0,#7c8aa0) 0 4px / 14px 2px,
	        linear-gradient(#7c8aa0,#7c8aa0) 0 8px / 14px 2px;
	      background-repeat:no-repeat;
	    }
	    .column-builder-list{
	      display:flex;
	      flex-direction:column;
	      gap:6px;
	      margin-top:10px;
	      max-height:300px;
	      overflow:auto;
	      padding-right:4px;
	    }
	    .column-option{
	      display:flex;
	      align-items:center;
	      gap:12px;
	      font-size:13px;
	      color:#e2e8f0;
	      padding:12px;
	      min-height:52px;
	      border-radius:12px;
	      border:1px solid rgba(148,163,184,0.18);
	      background:rgba(12,16,22,0.6);
	      transition:background 0.16s ease, border-color 0.16s ease, transform 0.22s ease;
	      will-change:transform;
	    }
	    .column-option input{ width:18px; height:18px; }
	    .column-option .column-option-label{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
	    .column-option--limited{ opacity:0.45; }
	    .column-option.drag-over{
	      border-color:#1f3c57;
	      background:#0e1824;
	    }
	    .column-option.is-draggable{ cursor:grab; }
	    .column-option.is-draggable:active{ cursor:grabbing; }
	    .column-option.dragging{
	      opacity:0.85;
	      background:#0b1420;
	      border-color:#1f3c57;
	      box-shadow:0 12px 28px rgba(0,0,0,0.35);
	    }
	    .drag-handle{
	      width:20px;
	      height:20px;
	      display:inline-flex;
	      align-items:center;
	      justify-content:center;
	      font-size:14px;
	      color:#7c8aa0;
	      border-radius:6px;
	      border:1px solid var(--border);
	      background:#0d131b;
	      cursor:grab;
	      user-select:none;
	      touch-action:none;
	      margin-left:auto;
	      pointer-events:none;
	    }
	    .drag-handle:active{ cursor:grabbing; }
	    .drag-handle.disabled{
	      opacity:0.4;
	      cursor:not-allowed;
	    }
	    .drag-handle::before{
	      content:'';
	      width:12px;
	      height:10px;
	      background:
	        linear-gradient(#7c8aa0,#7c8aa0) 0 0 / 12px 2px,
	        linear-gradient(#7c8aa0,#7c8aa0) 0 4px / 12px 2px,
	        linear-gradient(#7c8aa0,#7c8aa0) 0 8px / 12px 2px;
	      background-repeat:no-repeat;
	    }
	    .column-builder-actions{
	      display:flex;
	      gap:8px;
	      justify-content:flex-end;
	      margin-top:12px;
	    }
	    .column-builder-section{
	      margin-top:12px;
	      padding-top:10px;
	      border-top:1px solid rgba(148,163,184,0.16);
	    }
	    .column-builder-section-title{
	      font-size:11px;
	      text-transform:uppercase;
	      letter-spacing:0.08em;
	      color:var(--muted);
	      font-weight:700;
	    }
	    .column-builder-tap{
	      display:flex;
	      flex-direction:column;
	      gap:8px;
	      margin-top:8px;
	    }
	    .column-builder-tap label{
	      display:flex;
	      align-items:center;
	      gap:10px;
	      font-size:13px;
	      cursor:pointer;
	    }
	    .clear-input-btn{
	      position:absolute;
	      right:8px;
	      top:50%;
      transform:translateY(-50%);
      width:32px;
      height:32px;
      padding:0;
	    }
	    .clear-input-btn:disabled{ opacity:.55; }
	    .input-wrap > input{ padding-right:52px; }
	    #filterBox{
	      width:100%; max-width:480px;
	      padding:12px 52px 12px 12px;border-radius:10px;border:1px solid var(--border);
	      background:#0d131b;color:#eaeff7;font-size:16px
	    }
	    @media (max-width: 768px){
	      .inv-controls{ gap:8px; flex-wrap:wrap; justify-content:space-between; }
	      .inv-filter-group{ width:100%; }
	      .inv-controls .input-wrap{ flex:1 1 auto; max-width:none; }
	      .inv-filter-pills{ width:100%; }
	      .sort-wrap{ display:block; flex:0 0 auto; width:160px; min-width:0; }
	      .columns-wrap{ flex:0 0 auto; }
	      .column-builder{ width:min(360px, 92vw); }
	      .column-builder-drag{ display:none; }
	      #mobileSort{ padding:12px; border-radius:10px; }
	    }
    td.editing{padding:6px}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:calc(18px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,0.96);
      border:1px solid rgba(0,0,0,0.12);
      color:#0b1020;
      font-weight:800;
      padding:10px 14px;border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.55);
      z-index:300;
      display:none
    }
	    .modal-backdrop{
	      display:none;
	      position:fixed;
	      inset:0;
	      background:rgba(0,0,0,.65);
	      z-index:200;
	      padding:calc(12px + env(safe-area-inset-top)) 12px calc(12px + env(safe-area-inset-bottom));
	      -webkit-backdrop-filter: blur(8px);
	      backdrop-filter: blur(8px);
	      align-items:center;
	      justify-content:center;
	      overflow:hidden;
	    }
	    .modal-backdrop[aria-hidden="false"]{ display:flex; }
	    #reportEmailModal{ z-index:220; }
	    #msgModal{ z-index:240; }
	    #confirmModal{ z-index:250; }
	    #qtyPickerModal{ z-index:210; }
	    .modal{
	      width:100%;
	      max-width:480px;
	      background:var(--card);
	      border:1px solid var(--border);
	      border-radius:16px;
	      display:flex;
	      flex-direction:column;
	      max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
	      max-height:calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
	      overflow:hidden;
	    }
	    .modal--sm{ max-width:min(360px, 92vw); }
	    .modal--md{ max-width:min(480px, 94vw); }
	    .modal--lg{ max-width:min(1100px, 96vw); }
    .modal-header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:rgba(12,16,22,0.85);
    }
    .modal-title-wrap{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width:0;
    }
    .modal-icon{
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(255,255,255,0.08);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#7dd3fc;
      flex:0 0 auto;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.18);
    }
    .modal-icon svg{ width:18px; height:18px; }
    .modal-title-text{ min-width:0; }
    .modal-title{
      margin:0;
      font-size:15px;
      font-weight:800;
      letter-spacing:0.01em;
    }
    .modal-subtitle{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      line-height:1.3;
    }
    .modal-close{
      width:32px;
      height:32px;
      flex:0 0 auto;
    }
    .modal-body{
      padding:14px 16px 16px;
      overflow:auto;
      flex:1 1 auto;
      -webkit-overflow-scrolling:touch;
    }
    .modal-footer{
      padding:12px 16px calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid var(--border);
      display:flex;
      align-items:center;
      gap:10px;
      background:rgba(12,16,22,0.9);
    }
    .modal-footer .footer-left,
    .modal-footer .footer-right{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .modal-footer .footer-right{ margin-left:auto; }
    .form-section{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .form-section + .form-section{ margin-top:16px; }
    .section-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:11px;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .section-label svg{ width:14px; height:14px; }
    .modal-body label{
      font-size:12px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }
    .modal-body input[type=text],
    .modal-body input[type=number],
    .modal-body input[type=email],
    .modal-body input[type=password],
    .modal-body input[type=tel],
    .modal-body textarea,
    .modal-body select{
      background:rgba(15,20,28,0.7);
      border:1px solid rgba(255,255,255,0.14);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
      min-height:44px;
    }
    .modal-body input:focus,
    .modal-body textarea:focus,
    .modal-body select:focus{
      outline:none;
      border-color:rgba(125,211,252,0.7);
      box-shadow:0 0 0 2px rgba(125,211,252,0.3);
    }
    .modal-body textarea{ min-height:120px; }
    .modal-body .edit-readonly{ opacity:0.8; }
    .modal-body .edit-readonly[disabled]{ cursor:not-allowed; }
    .modal-body .qty-stepper,
    .modal-body .qty-stepper *{ user-select:none; }
	    .edit-steppers{
	      display:grid;
	      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
	      gap:8px 12px;
	      align-items:center;
	      justify-items:center;
	    }
    .edit-grid-2{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:10px 12px;
      align-items:end;
    }
    .edit-grid-3{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:10px 12px;
      align-items:end;
    }
    .edit-field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .edit-readonly{
      opacity:0.8;
    }
	    .edit-steppers label.muted{
	      margin:0;
	      text-align:center;
	    }
	    .edit-label-meta{
	      display:block;
	      margin-top:2px;
	      font-weight:600;
	      opacity:0.85;
	      font-size:12px;
	    }
	    .edit-stepper-actions{
	      width:100%;
	      display:flex;
	      justify-content:center;
	    }
	    .edit-toggle-row{
	      display:flex;
	      align-items:center;
	      gap:12px;
	      margin-top:12px;
	      flex-wrap:wrap;
	    }
	    .edit-toggle-row label[for]{
	      cursor:pointer;
	      font-size:13px;
	      line-height:1.35;
	    }
    .qty-stepper.qty-stepper--modal,
    .qty-stepper.qty-stepper--table{
      display:inline-flex;
      align-items:center;
      flex-wrap:nowrap;
      justify-content:center;
      background:transparent;
      border:none;
      border-radius:0;
      overflow:visible;
      height:auto;
    }
		    .qty-stepper.qty-stepper--modal{ gap:8px; }
		    .qty-stepper.qty-stepper--table{ gap:6px; }
	    .qty-stepper--table .qty-step{ min-width:38px; }
	    .qty-stepper--table .qty-value{ min-width:36px; font-size:15px; }
	    .qty-step{
	      cursor:pointer;
	      border:1px solid var(--border);
	      background:#101826;
	      color:#fff;
      border-radius:10px;
      min-width:44px;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      line-height:1;
      user-select:none;
      -webkit-appearance:none;
      appearance:none;
      touch-action:manipulation;
    }
    .qty-step:disabled{ opacity:.55; cursor:not-allowed; }
    .qty-value{
      min-width:44px;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      font-variant-numeric:tabular-nums;
      font-weight:800;
      font-size:16px;
      line-height:1;
      cursor:pointer;
      user-select:none;
      touch-action:manipulation;
    }
	    .qty-stepper.qty-stepper--modal input[type=number]{
	      width:3.25rem;
	      text-align:center;
	      font-variant-numeric:tabular-nums;
	      font-size:22px;
	      font-weight:900;
	    }
    .qty-stepper input[type=number]::-webkit-outer-spin-button,
	    .qty-stepper input[type=number]::-webkit-inner-spin-button{
	      -webkit-appearance:none;
	      margin:0;
	    }
	    .qty-stepper input[type=number]{ -moz-appearance:textfield; }
	    .edit-footer{
	      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
	      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#0b1017;
    }
    .section + .section{ margin-top:12px; }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .order-box{
      padding:0;
      overflow:hidden; /* body scrolls */
      display:flex;
      flex-direction:column;
    }
    .order-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background:var(--card);
    }
    .order-header h2{ margin:0; font-size:16px; }
    .order-body{
      padding:12px 14px 14px;
      overflow:auto;
      flex:1;
      -webkit-overflow-scrolling:touch;
    }
    .order-footer{
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .order-recipient{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .order-recipient input[type=email]{ flex:1; min-width:200px; }
    .order-shipping-row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .order-shipping-row select{ flex:1; min-width:220px; }
    .order-po-grid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:10px; }
    .order-po-subject{ grid-column:1 / -1; }
    @media (max-width: 720px){
      .order-po-grid{ grid-template-columns:1fr; }
      .order-po-subject{ grid-column:auto; }
    }
    .order-suggest{
      display:none;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px;
      background:#000;
      max-height:190px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .order-suggest.has-suggest{ display:flex; }
    .suggest-chip{
      cursor:pointer;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      min-height:36px;
      max-width:100%;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .order-list{ display:flex; flex-direction:column; gap:10px; }
    .order-empty{
      padding:14px;
      border:1px dashed var(--border);
      border-radius:14px;
      background:transparent;
      color:var(--muted);
      font-size:13px;
      text-align:center;
    }
    .order-card{
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:14px;
      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
      box-shadow:0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
      transition: border-color 180ms ease, box-shadow 180ms ease;
    }
    .order-card.order-card--selected{
      background:
        radial-gradient(220px 120px at 40% 35%, rgba(34,197,94,0.20), rgba(34,197,94,0) 70%),
        linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%);
      box-shadow:0 0 0 1px rgba(34,197,94,0.12), 0 0 16px rgba(34,197,94,0.10), 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .order-card-header{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .order-batch-toggle{
      display:flex;
      align-items:center;
    }
    .order-line-select{
      width:16px;
      height:16px;
      accent-color:#22c55e;
      cursor:pointer;
    }
    @media (pointer: coarse){
      .order-batch-toggle{ display:none; }
    }
    .order-inline-kpi{
      margin-left:auto;
      display:flex;
      align-items:baseline;
      gap:6px;
      white-space:nowrap;
      font-size:12px;
      color:var(--muted);
      font-variant-numeric:tabular-nums;
    }
    .order-inline-kpi-val{
      color:var(--fg);
      font-weight:800;
      font-size:14px;
    }
    .order-card-top{ display:flex; gap:12px; align-items:flex-start; }
    .order-meta{ flex:1; min-width:0; }
    .order-title{ font-weight:700; font-size:15px; letter-spacing:-0.01em; }
    .order-sub{ margin-top:3px; color:var(--muted); font-size:12px; line-height:1.4; }
    .order-side{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
    .order-kpi{ text-align:right; }
    .order-kpi-label{ color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:0.04em; }
    .order-kpi-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:18px; }
    .order-controls{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;
      gap:12px;
      align-items:flex-end;
    }
	    .order-controls.order-controls--compact{
	      margin-top:10px;
	      padding-top:10px;
	      display:flex;
	      align-items:center;
	      gap:10px;
	    }
	    .order-controls.order-controls--compact .order-remove-btn{
	      margin-left:auto;
	    }
    .order-control{ flex-shrink:0; display:flex; flex-direction:column; }
    .order-control.qty{ width:64px; margin-left:auto; text-align:center; }
    .order-control.qty input{
      width:100%;
      text-align:center;
      font-weight:600;
      font-size:16px;
      font-variant-numeric:tabular-nums;
      height:42px;
      padding:0 8px;
      box-sizing:border-box;
    }
    .order-control-label{ color:var(--muted); font-size:11px; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.03em; }
    .order-control-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:17px; height:42px; display:flex; align-items:center; }
    .order-control-spacer{ height:17px; }
	    .qty-stepper{
	      display:flex; align-items:center; gap:0; background:#0d131b; border:1px solid var(--border);
	      border-radius:10px; overflow:hidden; height:48px;
	    }
	    .qty-stepper-btn{
	      width:48px; height:48px; border:none; background:transparent; color:#fff;
	      font-size:20px; font-weight:500; cursor:pointer; display:flex; align-items:center; justify-content:center;
	      transition:background 0.15s;
	    }
    .qty-stepper-btn:hover{ background:rgba(255,255,255,0.08); }
    .qty-stepper-btn:active{ background:rgba(255,255,255,0.12); }
	    .qty-stepper-val{
	      min-width:3.25rem;
	      height:48px;
	      display:inline-flex;
	      align-items:center;
	      justify-content:center;
	      text-align:center;
	      font-weight:900;
	      font-size:22px;
	      font-variant-numeric:tabular-nums;
	      color:#fff;
	      cursor:pointer;
	      user-select:none;
	      touch-action:manipulation;
	    }
	    .qty-stepper-input{
	      min-width:3.25rem;
	      width:auto;
	      height:48px;
	      border:none;
	      background:transparent;
	      text-align:center;
	      font-weight:900;
	      font-size:22px;
	      font-variant-numeric:tabular-nums;
	      color:#fff;
	      outline:none;
	      padding:0 4px;
	      -moz-appearance:textfield;
	    }
	    .qty-stepper-input::-webkit-outer-spin-button,
	    .qty-stepper-input::-webkit-inner-spin-button{
	      -webkit-appearance:none;
	      margin:0;
	    }
	    .qty-stepper-input:focus{
	      background:rgba(255,255,255,0.1);
	    }
    .order-preview{
      border:1px solid var(--border);
      border-radius:12px;
      background:#000;
      padding:10px;
    }
    .order-preview summary{
      cursor:pointer;
      list-style:none;
      font-weight:700;
      user-select:none;
    }
    .order-preview summary::-webkit-details-marker{ display:none; }
    .order-preview-html{
      margin-top:10px;
      border-radius:8px;
      overflow:hidden;
      background:#fff;
      max-height:320px;
      overflow-y:auto;
    }
    .order-preview-html iframe{
      width:100%;
      border:none;
      min-height:280px;
    }
    .history-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .history-item{
      border:1px solid var(--border);
      border-radius:12px;
      background:transparent;
      padding:10px;
    }
    .history-item summary{
      cursor:pointer;
      list-style:none;
      font-weight:800;
      user-select:none;
      position:relative;
      padding-right:32px;
    }
    .history-item summary::-webkit-details-marker{ display:none; }
    .history-caret{
      position:absolute;
      right:10px;
      top:12px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      pointer-events:none;
    }
    .history-caret svg{
      width:16px;
      height:16px;
      transition:transform 160ms ease;
    }
    .history-item[open] .history-caret svg{ transform:rotate(180deg); }
    .history-meta{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .history-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .history-title{ flex:1; }
    .history-actions{
      display:flex;
      align-items:center;
      gap:6px;
      flex-shrink:0;
    }
    .history-tray{ display:none; }
    /* Receive Order modal */
    #receiveOrderModal .box{
      max-width:1100px;
      width:min(1100px, 95vw);
    }
    .receive-order-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .receive-order-meta{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .receive-order-card{
      border:1px solid var(--border);
      background:#0d1420;
      border-radius:10px;
      padding:8px 10px;
    }
    .receive-order-card .label{
      color:var(--muted);
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-weight:800;
    }
    .receive-order-card .value{
      font-size:14px;
      font-weight:800;
      margin-top:4px;
    }
    .receive-summary{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .receive-order-note{
      margin-top:10px;
      padding:8px 10px;
      border:1px dashed var(--border);
      border-radius:10px;
      color:var(--muted);
      font-size:12px;
    }
    .receive-lines{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .receive-line{
      border:1px solid var(--border);
      background:#0b0f14;
      border-radius:12px;
      padding:10px;
    }
    .receive-line.disabled{
      opacity:.6;
    }
    .receive-line-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .receive-line-title{
      font-weight:800;
      font-size:14px;
    }
    .receive-line-sku{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
    }
    .receive-line-stats{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--muted);
    }
    .receive-line-inputs{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
      gap:8px;
      margin-top:8px;
    }
    .receive-line-inputs label{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .receive-line-warning{
      display:none;
      margin-top:6px;
      font-size:12px;
      color:#f59e0b;
      font-weight:700;
    }
    .receive-line.over{
      border-color:rgba(245,158,11,0.5);
      box-shadow:0 0 0 1px rgba(245,158,11,0.25);
    }
    .receive-line.over .receive-line-warning{
      display:block;
    }
    .receive-line-note{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
    }
    .receive-order-warning{
      margin-top:8px;
      color:#f59e0b;
      font-size:12px;
      font-weight:700;
    }
    .receive-receipts{
      margin-top:16px;
    }
    .receive-receipt{
      border:1px solid var(--border);
      background:#0b0f14;
      border-radius:12px;
      padding:10px;
      margin-top:10px;
    }
    .receive-receipt-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .receive-receipt-title{
      font-weight:800;
      font-size:13px;
    }
    .receive-receipt-meta{
      color:var(--muted);
      font-size:12px;
    }
    .receive-receipt-lines{
      margin-top:8px;
      display:grid;
      gap:6px;
    }
    .receive-receipt-line{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:12px;
      color:var(--muted);
    }
    .receive-receipt-line span{
      white-space:nowrap;
    }
	    /* Qty picker wheel */
	    .qty-picker-wheel-wrap{
	      position:relative;
	      height:216px;
	      overflow:hidden;
	      -webkit-mask-image:linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
	      mask-image:linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
	    }
	    .qty-picker-highlight{
	      position:absolute;
	      top:50%;
	      left:16px;
	      right:16px;
	      height:36px;
	      transform:translateY(-50%);
	      background:rgba(120,120,128,0.24);
	      border-radius:8px;
	      pointer-events:none;
	    }
	    .qty-picker-wheel{
	      position:absolute;
	      top:0;
	      left:0;
	      right:0;
	      padding:90px 0;
	      display:flex;
	      flex-direction:column;
	      align-items:center;
	      transition:transform 150ms ease-out;
	    }
	    .qty-picker-item{
	      height:36px;
	      display:flex;
	      align-items:center;
	      justify-content:center;
	      font-size:22px;
	      font-weight:400;
	      color:rgba(255,255,255,0.85);
	      font-variant-numeric:tabular-nums;
	      transition:opacity 100ms ease, transform 100ms ease;
	    }
	    .qty-picker-item.selected{
	      font-weight:500;
	      color:#fff;
	    }
	    .report-metrics{
	      display:grid;
	      grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
	      gap:10px;
	      margin-top:12px;
	    }
	    .report-metric{
	      border:1px solid var(--border);
	      border-radius:12px;
	      padding:10px 12px;
	      background:#0d1420;
	    }
	    .report-metric .val{
	      margin-top:4px;
	      font-weight:900;
	      font-size:18px;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-metric--actionable{
	      position:relative;
	    }
	    .report-metric-action{
	      position:absolute;
	      top:8px;
	      right:8px;
	      background:rgba(255,255,255,0.08);
	      border:none;
	      border-radius:6px;
	      padding:6px;
	      cursor:pointer;
	      color:var(--muted);
	      display:flex;
	      align-items:center;
	      justify-content:center;
	      transition:color 0.15s, background 0.15s, transform 0.15s;
	    }
	    .report-metric-action:hover{
	      color:#22c55e;
	      background:rgba(34,197,94,0.15);
	      transform:scale(1.1);
	    }
	    .report-metric-action:active{
	      transform:scale(0.95);
	    }
	    .led-dot{
	      display:inline-block;
	      width:8px;
	      height:8px;
	      border-radius:50%;
	      margin-right:6px;
	      vertical-align:middle;
	      position:relative;
	      top:-1px;
	    }
	    .led-dot--red{
	      background:#ef4444;
	      box-shadow:0 0 6px rgba(239,68,68,0.5), 0 0 12px rgba(239,68,68,0.3);
	    }
	    .led-dot--amber{
	      background:#f59e0b;
	      box-shadow:0 0 6px rgba(245,158,11,0.5), 0 0 12px rgba(245,158,11,0.3);
	    }
	    .led-dot--green{
	      background:#22c55e;
	      box-shadow:0 0 6px rgba(34,197,94,0.5), 0 0 12px rgba(34,197,94,0.3);
	    }
	    .led-dot--cyan{
	      background:#06b6d4;
	      box-shadow:0 0 6px rgba(6,182,212,0.5), 0 0 12px rgba(6,182,212,0.3);
	    }
	    .led-dot--off{
	      background:rgba(148,163,184,0.55);
	      box-shadow:0 0 0 1px rgba(255,255,255,0.10);
	    }
	    .report-count{
	      color:var(--muted);
	      font-weight:900;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-progress{
	      margin-top:12px;
	      padding:10px 12px;
	      border:1px solid var(--border);
	      border-radius:14px;
	      background:#0d1420;
	    }
	    .report-progress-label{
	      display:flex;
	      align-items:center;
	      justify-content:space-between;
	      gap:10px;
	      color:var(--muted);
	      font-size:11px;
	      font-weight:900;
	      letter-spacing:0.08em;
	      text-transform:uppercase;
	    }
	    .report-progress-value{
	      flex:0 0 auto;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-progress-track{
	      margin-top:10px;
	      height:10px;
	      border-radius:999px;
	      background:rgba(255,255,255,0.10);
	      overflow:hidden;
	      border:1px solid rgba(255,255,255,0.10);
	    }
	    .report-progress-bar{
	      height:100%;
	      width:0%;
	      border-radius:999px;
	      background:linear-gradient(90deg, rgba(34,197,94,1), rgba(135,245,255,0.9));
	      box-shadow:0 0 16px rgba(34,197,94,0.35);
	      transition: width 120ms ease;
	    }
	    .report-pill-container{
	      position:static;
	      margin:12px 0 0;
	      padding:0;
	      background:none;
	    }
		    .report-section{
		      margin-top:14px;
		      border:1px solid var(--border);
		      border-radius:14px;
		      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
		      overflow:hidden;
		    }
		    .report-summary{
		      display:flex;
		      align-items:center;
		      justify-content:space-between;
		      gap:10px;
		      padding:10px 12px;
		      cursor:pointer;
		      user-select:none;
		      list-style:none;
		    }
		    .report-section summary::-webkit-details-marker{ display:none; }
		    .report-section summary::marker{ content:''; }
		    .report-summary-left h3{
		      margin:0;
		      font-size:13px;
		      letter-spacing:.08em;
		      text-transform:uppercase;
		    }
			    .report-summary-right{
			      display:flex;
			      align-items:center;
			      justify-content:flex-end;
			      gap:10px;
			      flex-shrink:0;
			    }
			    .report-summary-right .muted{ font-size:12px; }
			    .report-chevron{
			      display:inline-flex;
			      align-items:center;
			      justify-content:center;
			      color:var(--muted);
			      transform: rotate(0deg);
			      transition: transform 160ms ease;
		    }
		    .report-chevron svg{ width:16px; height:16px; }
		    .report-section[open] .report-chevron{ transform: rotate(180deg); }
		    .report-section[open] .report-summary{ border-bottom:1px solid rgba(255,255,255,0.08); }
		    .report-list{
		      display:flex;
		      flex-direction:column;
		      gap:8px;
		    }
		    .report-table{
		      width:100%;
		      border-collapse:collapse;
		      font-size:13px;
		    }
		    .report-table th{
		      text-align:left;
		      color:var(--muted);
		      font-weight:800;
		      border-bottom:1px solid rgba(255,255,255,0.10);
		      padding:10px 12px;
		      background:transparent;
		      position:static;
		      top:auto;
		      z-index:auto;
		      text-transform:uppercase;
		      font-size:11px;
		      letter-spacing:0.08em;
		      white-space:nowrap;
		    }
		    .report-table td{
		      padding:10px 12px;
		      border-bottom:1px solid rgba(255,255,255,0.08);
		      vertical-align:top;
		    }
		    .report-table td.item{
		      font-weight:900;
		      letter-spacing:0.02em;
		      white-space:nowrap;
		    }
		    .report-table td.desc{
		      color:var(--muted);
		      line-height:1.25;
		    }
		    .report-table th.qty,
		    .report-table td.qty,
		    .report-table th.thr,
		    .report-table td.thr{
		      text-align:right;
		      font-variant-numeric:tabular-nums;
		      font-weight:900;
		      white-space:nowrap;
		    }
		    .report-banner{
		      margin-top:12px;
		      padding:10px 12px;
		      border:1px solid rgba(135,245,255,0.22);
		      border-radius:12px;
		      background:rgba(135,245,255,0.06);
		      display:flex;
		      align-items:center;
		      justify-content:space-between;
		      gap:10px;
		    }
		    .report-banner-text{
		      min-width:0;
		      font-weight:700;
		      color:#c9f7ff;
		    }
		    .report-banner-actions{ display:flex; gap:8px; flex-shrink:0; }
		    .report-row{
		      display:flex;
		      align-items:flex-start;
		      justify-content:space-between;
		      gap:12px;
		      width:100%;
		      text-align:left;
		      cursor:pointer;
	      padding:10px 12px;
	      border:1px solid var(--border);
	      border-radius:12px;
	      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
	      color:inherit;
	      -webkit-appearance:none;
	      appearance:none;
	    }
	    .report-row:active{ transform:scale(0.99); }
	    .report-row:focus-visible{
	      outline:2px solid rgba(90,169,255,0.65);
	      outline-offset:2px;
	    }
		    .report-row[aria-pressed="true"]{
		      background:
		        radial-gradient(180px 90px at 50% 40%, rgba(34,197,94,0.20), rgba(34,197,94,0) 68%),
		        linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%);
		      box-shadow:0 0 0 1px rgba(34,197,94,0.12), 0 10px 24px rgba(0,0,0,0.35);
		    }
		    .report-separator{
		      display:flex;
		      align-items:center;
		      gap:10px;
		      margin:12px 0;
		      color:rgba(255,255,255,0.55);
		      font-size:11px;
		      text-transform:uppercase;
		      letter-spacing:0.08em;
		      user-select:none;
		    }
		    .report-separator::before,
		    .report-separator::after{
		      content:'';
		      flex:1;
		      height:1px;
		      background:rgba(255,255,255,0.10);
		    }
		    .report-separator span{ padding:0 2px; }
		    .report-row-main{ min-width:0; flex:1; }
	    .report-item{
	      display:flex;
	      align-items:center;
	      gap:8px;
	      min-width:0;
	      font-weight:800;
	      letter-spacing:.02em;
	    }
	    .report-item-name{
	      overflow:hidden;
	      text-overflow:ellipsis;
	      white-space:nowrap;
	      min-width:0;
	    }
	    .report-desc{
	      margin-top:4px;
	      color:var(--muted);
	      font-size:13px;
	      line-height:1.25;
	      overflow:hidden;
	      display:-webkit-box;
	      -webkit-box-orient:vertical;
	      -webkit-line-clamp:2;
	    }
	    .report-qty{
	      flex:0 0 auto;
	      min-width:56px;
	      text-align:right;
	      font-weight:900;
	      font-variant-numeric:tabular-nums;
	      display:flex;
	      flex-direction:column;
	      align-items:flex-end;
	      gap:4px;
	    }
	    .report-qty .muted{ font-size:10px; }
	    .history-kv{ margin-top:10px; font-size:13px; }
	    .history-kv div{ margin-top:4px; }
	    .history-table{
	      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
    }
    .history-table th,
    .history-table td{ padding:8px; border-bottom:1px solid var(--border); }
    .history-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
    }
    .history-table td.qty{
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:800;
    }
    .jobs-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
    }
    .jobs-table th,
    .jobs-table td{ padding:8px; border-bottom:1px solid var(--border); }
    .jobs-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:11px;
    }
    .job-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      letter-spacing:.04em;
      text-transform:uppercase;
      background:#0f172a;
      color:#93c5fd;
      border:1px solid rgba(148,163,184,0.3);
      white-space:nowrap;
    }
    .job-status--draft{ color:#93c5fd; background:#0b1220; border-color:#1f2a44; }
    .job-status--quoted{ color:#fbbf24; background:#1a1406; border-color:#3a2b0b; }
    .job-status--approved{ color:#34d399; background:#0b1a15; border-color:#1f3a2f; }
    .job-status--in_progress{ color:#60a5fa; background:#0b1623; border-color:#1d2f46; }
    .job-status--completed{ color:#a78bfa; background:#141022; border-color:#2b1e46; }
    .job-status--voided{ color:#f87171; background:#1a0d0d; border-color:#3a1515; }
    .job-meta{ color:var(--muted); font-size:12px; }
    .job-form-grid{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px; }
    .job-field{ display:flex; flex-direction:column; gap:6px; }
    .job-bom-add{ display:grid; grid-template-columns:minmax(0,1fr) 140px auto; gap:10px; align-items:end; }
    .jobs-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow-x:hidden;
      width:100%;
    }
    .job-row{
      display:flex;
      flex-direction:column;
      gap:0;
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(13,18,24,0.65);
      width:100%;
      max-width:100%;
      min-width:0;
      box-sizing:border-box;
    }
    .job-card-header{
      display:grid;
      grid-template-columns:18px minmax(0,1fr) auto;
      align-items:center;
      gap:12px;
      padding:10px 12px;
      cursor:pointer;
    }
    .job-chevron{
      color:var(--muted);
      display:flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border:none;
      background:none;
      padding:0;
      cursor:pointer;
      flex:0 0 auto;
    }
    .job-chevron svg{ transition:transform 0.15s ease; }
    .job-row[aria-expanded="true"] .job-chevron svg{ transform:rotate(90deg); }
    .job-header-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .job-name{
      font-weight:800;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .job-header-meta{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      min-width:0;
      color:var(--muted);
      font-size:12px;
    }
    .job-status-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      font-weight:600;
      letter-spacing:0.04em;
      text-transform:uppercase;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .job-status-pill--approved{
      color:var(--status-approved, #238636);
      background:rgba(35,134,54,0.15);
      border-color:rgba(35,134,54,0.3);
    }
    .job-status-pill--pending{
      color:var(--status-pending, #9e6a03);
      background:rgba(158,106,3,0.15);
      border-color:rgba(158,106,3,0.3);
    }
    .job-status-pill--draft{
      color:var(--status-draft, #6e7681);
      background:rgba(110,118,129,0.15);
      border-color:rgba(110,118,129,0.3);
    }
    .job-summary{
      display:inline-flex;
      align-items:center;
      gap:6px;
      min-width:0;
      white-space:nowrap;
    }
    .job-shortage{
      display:inline-flex;
      align-items:center;
      gap:6px;
      color:var(--alert-warning, #d29922);
      font-weight:600;
    }
    .job-actions{
      display:flex;
      align-items:center;
      gap:4px;
      flex-wrap:nowrap;
      justify-content:flex-end;
      flex:0 0 auto;
      justify-self:end;
    }
    .job-actions .icon-btn{ padding:2px; width:32px; height:32px; }
    .job-action--approve{ color:#34d399; }
    .job-action--complete{ color:#60a5fa; }
    .job-action--void{ color:#f87171; }
    .job-action--edit{ color:#93c5fd; }
    .job-action--view{ color:#e2e8f0; }
    @media (hover: hover) and (pointer: fine){
      #invTable tbody tr[data-id] .actions-wrap,
      .job-row .job-actions{
        opacity:0;
        pointer-events:none;
        transform:translateX(4px);
        transition:opacity 140ms ease, transform 140ms ease;
      }
      #invTable tbody tr[data-id]:hover .actions-wrap,
      #invTable tbody tr[data-id]:focus-within .actions-wrap,
      .job-row:hover .job-actions,
      .job-row:focus-within .job-actions{
        opacity:1;
        pointer-events:auto;
        transform:translateX(0);
      }
    }
    @media (max-width: 720px){
      .job-row{ gap:8px; }
      .job-status{ padding:3px 8px; font-size:10px; }
      .job-summary{ font-size:11px; }
      .job-actions .icon-btn{ width:30px; height:30px; }
    }
    .job-detail{
      margin:0;
      padding:8px 12px 12px 12px;
      border-top:1px solid rgba(148,163,184,0.2);
      overflow:hidden;
      width:100%;
      max-width:100%;
      box-sizing:border-box;
    }
    .job-items-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .job-items-table th,
    .job-items-table td{
      padding:8px 6px;
      border-bottom:1px solid rgba(148,163,184,0.2);
      vertical-align:top;
    }
    .job-items-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.05em;
      font-size:11px;
    }
    .job-items-table td.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:700;
    }
    .job-item-name{
      font-weight:700;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .job-item-sku{
      font-size:11px;
      color:var(--muted);
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .job-item-status{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      font-weight:600;
      white-space:nowrap;
    }
    .job-item-status--fulfilled{ color:var(--alert-success, #3fb950); }
    .job-item-status--shortage{ color:var(--alert-warning, #d29922); }
    .job-item-status--out{ color:var(--alert-danger, #f85149); }
    .job-items-summary{
      display:flex;
      justify-content:flex-end;
      gap:16px;
      padding-top:10px;
      font-size:12px;
      font-weight:700;
      color:var(--muted);
    }
    .job-items-summary span{
      display:inline-flex;
      gap:6px;
      align-items:center;
    }
    .job-items-summary .job-total-short{
      color:var(--alert-warning, #d29922);
    }
    @media (max-width: 640px){
      .job-items-table thead{ display:none; }
      .job-items-table tr{
        display:block;
        padding:8px 0;
      }
      .job-items-table td{
        display:flex;
        justify-content:space-between;
        gap:12px;
        padding:4px 0;
        border-bottom:none;
      }
      .job-items-table td::before{
        content:attr(data-label);
        color:var(--muted);
        text-transform:uppercase;
        letter-spacing:0.05em;
        font-size:10px;
        font-weight:600;
      }
      .job-items-table td.item-cell{
        display:block;
      }
      .job-items-table td.item-cell::before{ display:none; }
    }
    .job-bom-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:13px;
    }
    .job-bom-table th,
    .job-bom-table td{ padding:8px; border-bottom:1px solid var(--border); }
    .job-bom-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:11px;
    }
    .job-bom-table td.num{
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:700;
    }
    .job-bom-shortfall{ color:#f97316; font-weight:800; }
    .job-bom-available{ color:#34d399; font-weight:800; }
    .job-warning{
      margin-top:8px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid rgba(251,146,60,0.45);
      background:rgba(251,146,60,0.12);
      color:#fbbf24;
      font-size:12px;
    }
    .job-actions-bar{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .add-job-modal .box{
      max-width:520px;
    }
    .add-job-modal{
      align-items:center;
      justify-content:center;
    }
    .add-job-grid{
      display:grid;
      gap:12px;
    }
    .add-job-item{
      font-weight:700;
      font-size:15px;
    }
    .add-job-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
      margin-top:4px;
    }
    .add-job-inline{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .add-job-inline .qty-stepper{
      max-width:180px;
      width:100%;
    }
    @media (max-width: 640px){
      .job-form-grid{ grid-template-columns:1fr; }
      .job-bom-add{ grid-template-columns:1fr; }
      .jobs-table th:nth-child(3),
      .jobs-table td:nth-child(3){ display:none; }
      #addToJobModal{
        align-items:flex-end;
        padding:0;
      }
      #addToJobModal .box{
        width:100%;
        max-width:100%;
        margin:0;
        border-radius:16px 16px 0 0;
        max-height:calc(100vh - env(safe-area-inset-top));
        max-height:calc(100dvh - env(safe-area-inset-top));
      }
    }
	    .drop{
	      border:1px dashed var(--border);border-radius:10px;padding:12px;text-align:center;color:var(--muted)
	    }
		    .totals{ display:flex; justify-content:center; align-items:center; gap:0; flex-wrap:wrap; margin:6px 0 4px; text-align:center; }
		    .totals > span{ white-space:nowrap; }
		    .totals > span + span::before{
		      content:'|';
		      display:inline-block;
		      margin:0 10px;
		      opacity:.65;
		    }
		    @media (max-width:520px){
		      .totals{ flex-wrap:nowrap; }
		      .totals > span{ font-size:11px; }
		      .totals > span + span::before{ margin:0 6px; }
		    }
		    @media (max-width:360px){
		      .totals > span{ font-size:10px; }
		      .totals > span + span::before{ margin:0 4px; }
		    }
	    @media (max-width:640px){
	      .toolbar{gap:6px}
	      .toolbar .btn-primary,
	      .toolbar .btn-secondary,
	      .toolbar .btn-tertiary{flex:1}
	      .scroll{max-height:calc(100vh - 240px); max-height:calc(100svh - 240px); max-height:calc(100dvh - 240px)}
	    }
    /* no right-side logo anymore */
    @media (max-width:360px){ .toolbar{gap:4px} }
  
    @media (max-width: 480px){
      header{ padding: calc(8px + env(safe-area-inset-top)) 12px 6px; }
      .header-inner{ padding: 0 12px; }
      .brandrow{ gap:8px }
      .title-logo{ width:min(300px, 76vw); height:auto; }
      .modal-backdrop{ padding:calc(10px + env(safe-area-inset-top)) 10px calc(10px + env(safe-area-inset-bottom)); }
      .order-header{ padding:12px; }
      .order-body{ padding:10px 12px 12px; }
      .order-footer{ padding:10px 12px calc(10px + env(safe-area-inset-bottom)); }
      .order-footer{ display:grid; grid-template-columns:1fr 1fr; }
      .order-footer .order-send{ grid-column:1 / -1; }
      .order-recipient{ flex-direction:column; align-items:stretch; }
      .order-recipient input[type=email]{ min-width:0; }
    }

    /* Hamburger Menu Styles */
    .hamburger-menu{
      position:relative;
      z-index:25;
    }
    .hamburger-btn{
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      width:40px;
      height:40px;
      padding:6px;
      gap:5px;
    }
    .hamburger-btn span{
      display:block;
      width:22px;
      height:2px;
      background:currentColor;
      border-radius:2px;
      transition:transform 0.2s, opacity 0.2s;
    }
    .hamburger-btn.open span:nth-child(1){
      transform:translateY(7px) rotate(45deg);
    }
    .hamburger-btn.open span:nth-child(2){
      opacity:0;
    }
    .hamburger-btn.open span:nth-child(3){
      transform:translateY(-7px) rotate(-45deg);
    }
    .menu-panel{
      width:min(360px, calc(100vw - 24px));
      background:rgba(15,20,28,0.92);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,0.55);
      -webkit-backdrop-filter: blur(18px);
      backdrop-filter: blur(18px);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      max-height:calc(100vh - 120px);
    }
    .menu-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .menu-title{
      font-size:16px;
      font-weight:600;
      color:#ffffff;
    }
    .menu-close{
      width:32px;
      height:32px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.05);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#666;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .menu-close svg{ width:16px; height:16px; }
    .menu-close:hover{ background:rgba(255,255,255,0.1); color:#999; }
    .menu-quick-actions{
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:8px;
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .menu-quick-btn{
      display:flex;
      align-items:center;
      gap:10px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(99,179,237,0.2);
      background:linear-gradient(135deg, rgba(99,179,237,0.15), rgba(99,179,237,0.05));
      color:#7dd3fc;
      font-size:13px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .menu-quick-btn .menu-icon-svg{
      width:18px;
      height:18px;
      flex-shrink:0;
    }
    .menu-quick-btn:hover{
      background:rgba(99,179,237,0.25);
      border-color:rgba(99,179,237,0.3);
    }
    .menu-tabs{
      display:flex;
      gap:4px;
      padding:0 12px;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .menu-tab{
      flex:1;
      padding:12px 8px;
      font-size:12px;
      font-weight:500;
      color:#666;
      background:transparent;
      border:0;
      border-bottom:2px solid transparent;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .menu-tab:hover{ color:#999; }
    .menu-tab.is-active{
      color:#7dd3fc;
      border-bottom-color:#7dd3fc;
    }
    .menu-tab-panels{
      padding:6px 0 10px;
      overflow:auto;
      flex:1;
    }
    .menu-tab-panel{
      display:none;
      padding:4px 6px;
      opacity:0;
      transform:translateY(4px);
      transition:opacity 0.15s ease, transform 0.15s ease;
    }
    .menu-tab-panel.is-active{
      display:block;
      opacity:1;
      transform:translateY(0);
    }
    .menu-tab-panel.is-leaving{
      opacity:0;
      transform:translateY(4px);
    }
    .menu-section-label{
      padding:10px 14px 6px;
      font-size:10px;
      font-weight:600;
      letter-spacing:1px;
      text-transform:uppercase;
      color:#555;
    }
    .menu-item{
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      background:transparent;
      border:0;
      font-size:14px;
      color:#bbb;
      text-align:left;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .menu-item:hover{
      background:rgba(255,255,255,0.06);
      color:#fff;
    }
    .menu-item:disabled,
    .menu-quick-btn:disabled{
      opacity:0.45;
      cursor:not-allowed;
      pointer-events:none;
    }
    .menu-item .menu-icon-svg{
      width:18px;
      height:18px;
      color:#666;
      flex-shrink:0;
    }
    .menu-item:hover .menu-icon-svg{ color:#888; }
    .menu-item--danger{
      color:#ef4444;
    }
    .menu-item--danger .menu-icon-svg{ color:#ef4444; }
    .menu-item--danger:hover{ background:rgba(239,68,68,0.1); }
    .menu-item-badge{
      margin-left:auto;
      padding:2px 7px;
      border-radius:10px;
      font-size:11px;
      font-weight:600;
      color:#7dd3fc;
      background:rgba(99,179,237,0.2);
    }
    .menu-divider{
      height:1px;
      background:rgba(255,255,255,0.06);
      margin:6px 12px;
    }
    .header-row{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      align-items:center;
      gap:12px;
    }
    .header-right{
      grid-column:3;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      justify-self:end;
      gap:8px;
    }
    .header-left{
      grid-column:2;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:12px;
      min-width:0;
      justify-self:center;
    }
    /* Main app order pill - positioned below totals, sticky */
    .order-pill-container{
      position:sticky;
      top:0;
      z-index:15;
      display:flex;
      justify-content:center;
      padding:10px 0;
      background:linear-gradient(to bottom, var(--bg) 60%, transparent 100%);
    }
    .order-pill{
      width:75%;
      max-width:400px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background:rgba(34,197,94,0.18);
      border:1px solid rgba(34,197,94,0.55);
      color:#fff;
      font-weight:600;
      padding:12px 20px;
      border-radius:14px;
      cursor:pointer;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.12), 0 10px 24px rgba(0,0,0,0.35);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      transition: transform 150ms ease, box-shadow 150ms ease;
      -webkit-tap-highlight-color: transparent;
      animation: orderPillIn 220ms ease;
    }
    @keyframes orderPillIn{
      from{ opacity:0; transform:translateY(-8px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .order-pill:active{
      transform: scale(0.97);
    }
    .order-pill-value{
      font-size:20px;
      font-weight:700;
    }
    .order-pill-label{
      font-size:15px;
      font-weight:600;
    }
    .order-pill-hint{
      font-size:11px;
      opacity:0.8;
      text-transform:uppercase;
      letter-spacing:0.3px;
      margin-left:auto;
    }
    .menu-backdrop{
      display:none;
      position:fixed;
      inset:0;
      z-index:40;
      align-items:flex-start;
      justify-content:flex-end;
      padding:calc(56px + env(safe-area-inset-top)) 16px 16px;
      background:rgba(3,8,15,0.35);
    }
    .menu-backdrop.open{
      display:flex;
    }
    @media (max-width: 520px){
      .menu-backdrop{
        padding:calc(24px + env(safe-area-inset-top)) 10px 14px;
      }
      .menu-panel{
        width:100%;
        max-height:calc(100vh - 80px);
      }
    }
    /* Profile dropdown */
    .profile-menu{
      position:relative;
    }
    .profile-btn{
      border-radius:999px;
      position:relative;
    }
    .profile-status{
      position:absolute;bottom:6px;right:6px;width:10px;height:10px;
      border-radius:50%;border:2px solid var(--bg);
      background:#6b7280;
    }
    .profile-status.online{background:#22c55e}
    .profile-status.offline{background:#ef4444}
    .profile-status.warning{background:#f59e0b}
    .profile-dropdown{
      position:absolute;top:100%;right:0;margin-top:8px;
      background:rgba(15,18,24,0.92);
      border:1px solid var(--border);
      border-radius:14px;
      min-width:280px;
      width:min(360px, 92vw);
      padding:0;
      z-index:30;
      box-shadow:0 18px 40px rgba(0,0,0,0.45);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      display:none;
    }
    .profile-dropdown.open{display:block}
    .profile-panel-header{
      padding:14px 16px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .profile-email{font-weight:600;font-size:14px;color:var(--fg);word-break:break-all}
    .profile-company-name{font-size:12px;color:var(--muted)}
    .profile-badges{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .env-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      border:1px solid transparent;
      color:#0c1220;
      background:#9fb3c8;
      white-space:nowrap;
    }
    .env-badge.env-production{background:#22c55e;color:#072215;border-color:#1a8b42}
    .env-badge.env-sandbox{background:#38bdf8;color:#04212c;border-color:#0ea5e9}
    .env-badge.env-test{background:#a78bfa;color:#1f1245;border-color:#8b5cf6}
    .env-badge.env-system{background:#64748b;color:#0f172a;border-color:#475569}
    .profile-env-badge{
      padding:3px 8px;
      border-radius:4px;
      font-size:10px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      background:rgba(52,211,153,0.2);
      border:1px solid rgba(52,211,153,0.3);
      color:#34d399;
    }
    .profile-env-badge.hidden{display:none}
    .profile-role-badge{
      padding:4px 10px;
      border-radius:6px;
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      background:rgba(139,92,246,0.2);
      border:1px solid rgba(139,92,246,0.3);
      color:#a78bfa;
      letter-spacing:0.08em;
    }
    .profile-tabbar{
      display:flex;
      border-bottom:1px solid rgba(255,255,255,0.06);
    }
    .profile-tab{
      flex:1 1 0;
      padding:10px 12px;
      font-size:12px;
      font-weight:500;
      color:#666;
      background:transparent;
      border:0;
      border-bottom:2px solid transparent;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .profile-tab:hover{ color:#999; }
    .profile-tab.is-active{
      color:#7dd3fc;
      border-bottom-color:#7dd3fc;
    }
    .profile-panels{
      position:relative;
    }
    .profile-panel{
      display:none;
      padding:6px;
      opacity:0;
      transform:translateY(6px);
      transition:opacity 0.15s ease, transform 0.15s ease;
    }
    .profile-panel.is-active{
      display:block;
      opacity:1;
      transform:translateY(0);
    }
    .profile-panel.is-leaving{
      opacity:0;
      transform:translateY(6px);
    }
    .profile-item{
      width:100%;
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 14px;
      border-radius:10px;
      background:transparent;
      border:0;
      cursor:pointer;
      color:#bbb;
      font-size:14px;
      text-align:left;
      transition:all 0.15s ease;
    }
    .profile-item:hover{
      background:rgba(255,255,255,0.06);
      color:#fff;
    }
    .profile-item-icon{
      width:18px;
      height:18px;
      color:#666;
      flex-shrink:0;
      transition:color 0.15s ease;
    }
    .profile-item:hover .profile-item-icon{ color:#888; }
    .profile-item--danger{
      color:#ef4444;
    }
    .profile-item--danger .profile-item-icon{ color:#ef4444; }
    .profile-item--danger:hover{
      background:rgba(239,68,68,0.1);
      color:#ef4444;
    }
    .profile-divider{
      height:1px;
      background:rgba(255,255,255,0.06);
      margin:8px 12px;
    }
    .profile-item-badge{
      margin-left:auto;
      padding:2px 7px;
      border-radius:10px;
      font-size:11px;
      font-weight:600;
      color:#7dd3fc;
      background:rgba(99,179,237,0.2);
    }
    .profile-empty{
      padding:8px 12px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .manage-companies-modal .modal-header{
      padding:16px 24px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background:rgba(18,24,32,0.7);
      backdrop-filter: blur(10px);
    }
    .manage-companies-header-meta{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:4px;
      font-size:12px;
      color:var(--muted);
    }
    .manage-companies-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      background:rgba(99,102,241,0.2);
      color:#c7d2fe;
      border:1px solid rgba(99,102,241,0.4);
    }
    .manage-companies-filters{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:flex-end;
    }
    .manage-companies-filters .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      flex:1 1 220px;
    }
    .manage-companies-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-top:10px;
    }
    .btn-outline-success{
      background:transparent;
      border:1px solid rgba(34,197,94,0.45);
      color:#6ee7b7;
      box-shadow:0 0 0 1px rgba(34,197,94,0.08) inset;
    }
    .btn-outline-success:hover{
      background:rgba(34,197,94,0.12);
      border-color:rgba(34,197,94,0.6);
      color:#34d399;
    }
    .manage-companies-modal{
      width:96vw;
      max-width:min(1200px, 96vw);
    }
    @media (min-width: 1400px){
      .manage-companies-modal{
        max-width:1400px;
      }
    }
    .manage-companies-results{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      max-height:340px;
      overflow-y:auto;
      overflow-x:hidden;
      background:#121820;
    }
    .manage-companies-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      table-layout:fixed;
    }
    .manage-companies-table th,.manage-companies-table td{
      text-align:left;
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
      word-break:break-word;
    }
    .manage-companies-table th{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:var(--muted);
    }
    .manage-companies-table .col-members,
    .manage-companies-table .col-inventory{
      text-align:center;
    }
    .manage-companies-table .inv-positive{
      color:var(--action-primary);
    }
    .manage-companies-table tr.is-current{
      background:rgba(88,166,255,0.05);
    }
    .manage-companies-table tr.is-current td:first-child{
      border-left:3px solid var(--action-primary);
    }
    .manage-companies-name{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      font-weight:600;
      min-width:0;
    }
    .manage-companies-name span{
      min-width:0;
    }
    .manage-companies-current{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      border-radius:8px;
      font-size:10px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      background:rgba(88,166,255,0.2);
      color:#93c5fd;
    }
    .company-id-copy{
      margin-top:4px;
      font-size:11px;
      color:var(--muted);
      background:transparent;
      border:none;
      padding:0;
      cursor:pointer;
    }
    .company-id-copy:hover{ color:#cbd5f5; }
    .manage-companies-row-actions{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
    }
    .company-active-label{
      font-size:12px;
      color:var(--muted);
    }
    .company-overflow{
      position:relative;
    }
    .company-overflow-btn{
      width:32px;
      height:32px;
    }
    .company-overflow-menu{
      position:absolute;
      right:0;
      top:36px;
      min-width:190px;
      background:#121820;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:8px;
      box-shadow:0 12px 30px rgba(0,0,0,0.35);
      display:none;
      z-index:20;
    }
    .company-overflow.open .company-overflow-menu{ display:block; }
    .company-overflow-section{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
      padding:6px 8px 4px;
    }
    .company-overflow-item{
      width:100%;
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:10px;
      background:transparent;
      border:1px solid transparent;
      color:#d1d5db;
      font-size:13px;
      cursor:pointer;
      text-align:left;
    }
    .company-overflow-item:hover{
      background:rgba(255,255,255,0.06);
      color:#fff;
    }
    .company-overflow-item.danger{
      color:var(--action-danger);
    }
    .company-overflow-item.danger:hover{
      background:rgba(248,81,73,0.1);
      color:var(--action-danger);
    }
    .manage-companies-hint{margin-top:6px;font-size:12px;color:var(--muted)}
    @media (max-width: 768px){
      .manage-companies-filters{flex-direction:column;align-items:stretch;}
      .manage-companies-actions{justify-content:stretch;}
      .manage-companies-actions .btn-primary,
      .manage-companies-actions .btn-secondary,
      .manage-companies-actions .btn-outline-success{
        width:100%;
      }
      .manage-companies-table .col-members{display:none;}
      .manage-companies-table th.col-members{display:none;}
    }
    .advanced-switcher-controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .advanced-switcher-controls .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .advanced-switcher-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      margin-top:8px;
    }
    .advanced-switcher-results{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      max-height:320px;
      overflow:auto;
      background:#121820;
    }
    .advanced-switcher-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .advanced-switcher-table th,.advanced-switcher-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    .advanced-switcher-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .advanced-switcher-id{font-size:11px;color:var(--muted);word-break:break-all}
    .advanced-switcher-row-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .advanced-switcher-row-actions .btn-tertiary{white-space:nowrap;}
    .advanced-switcher-hint{margin-top:6px;font-size:12px;color:var(--muted)}
    #advancedCompanyModal.company-switcher-basic .advanced-switcher-controls,
    #advancedCompanyModal.company-switcher-basic .advanced-switcher-actions{
      display:none;
    }
    .diag-section{margin-top:10px}
    .diag-actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:8px}
    .diag-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .diag-table th,.diag-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
      vertical-align:middle;
    }
    .diag-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .diag-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:700;
      letter-spacing:0.08em;
      text-transform:uppercase;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .diag-badge.pass{background:#12361f;color:#9ff5bf;border-color:#1b5d35}
    .diag-badge.fail{background:#3a1515;color:#ffb4b4;border-color:#7a1f1f}
    .diag-output{
      margin-top:8px;
      background:#0f141b;
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px;
      font-size:12px;
      color:#dbe5f0;
      max-height:240px;
      overflow:auto;
      white-space:pre-wrap;
    }
    @media (max-width: 720px){
      .advanced-switcher-controls{
        grid-template-columns:1fr;
      }
      .advanced-switcher-actions{
        justify-content:flex-start;
      }
    }
    .profile-dropdown .menu-item{
      display:flex;align-items:center;gap:10px;width:100%;
      padding:12px 16px;border:none;background:transparent;
      color:var(--fg);font-size:14px;font-weight:500;
      text-align:left;cursor:pointer;transition:background 0.15s;
    }
    .profile-dropdown .menu-item:hover{background:rgba(255,255,255,0.06)}
    .profile-dropdown .menu-item:disabled{opacity:0.45;cursor:not-allowed}
    .profile-dropdown .menu-item:disabled:hover{background:transparent}
    .profile-meta{padding:10px 16px;border-top:1px solid var(--border);margin-top:8px}
    .profile-meta .time{font-size:11px;color:var(--muted)}
    .profile-company{
      padding:10px 16px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .profile-company-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .profile-company select{
      padding:8px 10px;
      font-size:13px;
      border-radius:8px;
      background:#0f141b;
      color:var(--fg);
      border:1px solid var(--border);
    }
    .profile-company select:disabled{opacity:0.6;cursor:not-allowed}
    .profile-company-hint{font-size:11px;color:var(--muted)}
    .invite-section{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .invite-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .invite-grid{display:grid;grid-template-columns:1fr;gap:8px}
    .invite-actions{display:flex;justify-content:flex-end}
    .invite-link-row{display:none;gap:8px;align-items:center}
    .invite-link-row input{font-size:12px}
    .trash-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .trash-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .trash-item{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
    }
    .trash-title{font-weight:700}
    .trash-meta{font-size:12px;color:var(--muted);margin-top:6px}
    .trash-empty{padding:14px;border:1px dashed var(--border);border-radius:12px;color:var(--muted);text-align:center}
    .auth-actions{display:flex;justify-content:flex-end;margin-top:6px}
    .auth-link{
      background:none;border:none;padding:0;
      color:var(--accent);font-size:13px;cursor:pointer;
    }
    .auth-link:hover{text-decoration:underline}
    .section-divider{height:1px;background:var(--border);margin:12px 0}
    .role-request-section{display:flex;flex-direction:column;gap:8px}
    .role-request-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
      margin-bottom:2px;
    }
    .role-request-meta{font-size:12px;color:var(--muted)}
    .role-request-actions{display:flex;justify-content:flex-end}
    .tier-admin-section{display:flex;flex-direction:column;gap:8px}
    .tier-admin-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
    .tier-admin-card,
    .tier-admin-stat{border:1px solid var(--border);border-radius:10px;padding:10px;background:transparent;box-shadow:none}
    .tier-admin-label{font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);margin-bottom:4px}
    .tier-admin-value{font-size:13px;font-weight:600;color:var(--fg)}
    .tier-admin-actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .role-requests-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .role-request-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .role-request-card h3{margin:0;font-size:14px}
    .role-request-actions-row{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .audit-filters{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .audit-filters select,.audit-filters input{min-width:160px}
    .audit-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .audit-card{
      border:1px solid var(--border);
      border-radius:12px;
      background:transparent;
      padding:0;
    }
    .audit-card summary{
      cursor:pointer;
      list-style:none;
      padding:12px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .audit-card summary::-webkit-details-marker{display:none}
    .audit-caret{
      margin-left:auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
    }
    .audit-caret svg{
      width:16px;
      height:16px;
      transition:transform 160ms ease;
    }
    .audit-card[open] .audit-caret svg{ transform:rotate(90deg); }
    .audit-body{
      padding:0 12px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .audit-title{font-weight:700}
    .audit-meta{font-size:12px;color:var(--muted)}
    .audit-summary{display:flex;flex-direction:column;gap:4px;min-width:0;flex:1 1 auto}
    .audit-json{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:11px;white-space:pre-wrap;color:var(--muted)}
    .shipping-address-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .shipping-address-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .shipping-address-meta{font-size:12px;color:var(--muted)}
    .shipping-address-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .shipping-address-form{display:flex;flex-direction:column;gap:8px}
    .shipping-address-default{display:flex;align-items:center;gap:12px}
    .company-locations-list{margin-top:12px}
    .company-locations-table{min-width:860px}
    .company-location-name-row{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .company-location-name{font-weight:700;flex:1;min-width:0}
    .company-location-address{white-space:pre-line;color:var(--muted)}
    .company-location-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .company-location-status{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:700;
      color:#86efac;
    }
    .company-location-status.archived{color:#fca5a5}
    .company-location-badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
    .company-location-badge{
      display:inline-flex;
      align-items:center;
      padding:2px 6px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:700;
      background:var(--card);
      color:var(--muted);
    }
    .company-location-badge.ship{border-color:#1d4ed8;color:#93c5fd;background:#0f263a}
    .company-location-badge.receive{border-color:#16a34a;color:#86efac;background:#0f2f26}
    .company-location-form{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:10px;
      margin-top:10px;
    }
    .company-location-form .field{display:flex;flex-direction:column;gap:6px}
    .company-location-form .field.full{grid-column:1 / -1}
    .company-location-defaults{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px}

    /* Google Places Autocomplete Styling */
    .pac-container{background:var(--card);border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.4);font-family:inherit;z-index:10001;margin-top:4px}
    .pac-item{padding:10px 14px;color:var(--fg);cursor:pointer;border-top:1px solid var(--border);font-size:13px}
    .pac-item:first-child{border-top:none}
    .pac-item:hover,.pac-item-selected{background:var(--border)}
    .pac-icon{display:none}
    .pac-item-query{color:var(--accent);font-weight:600}
    .pac-matched{font-weight:700}
    gmp-place-autocomplete{display:block}
    gmp-place-autocomplete input{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
      background:#0d131b;color:#fff;font-size:16px
    }
    gmp-place-autocomplete::part(prediction-list){
      background:var(--card);
      border:1px solid var(--border);
      border-radius:8px;
      box-shadow:0 4px 20px rgba(0,0,0,0.4);
      margin-top:4px
    }
    gmp-place-autocomplete::part(prediction-item){
      padding:10px 14px;
      color:var(--fg);
      cursor:pointer;
      border-top:1px solid var(--border);
      font-size:13px
    }
    gmp-place-autocomplete::part(prediction-item):first-child{border-top:none}
    gmp-place-autocomplete::part(prediction-item-selected){background:var(--border)}
    gmp-place-autocomplete::part(prediction-item-icon){display:none}
    gmp-place-autocomplete::part(prediction-item-main-text){color:var(--accent);font-weight:600}
    gmp-place-autocomplete::part(prediction-item-match){font-weight:700}

    .user-mgmt-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .user-mgmt-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .user-mgmt-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .user-mgmt-name{font-weight:700}
    .user-mgmt-meta{font-size:12px;color:var(--muted);margin-top:4px}
    .user-mgmt-actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .user-mgmt-role{min-width:120px}
    .user-mgmt-action{display:flex;align-items:center;gap:6px}
    .user-mgmt-action-btn{display:inline-flex;align-items:center;gap:6px}
    .user-mgmt-icon{width:16px;height:16px;flex-shrink:0}
    .pending-invites-section{margin-top:14px}
    .pending-invites-header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .pending-invites-header h3{margin:0;font-size:14px}
    .pending-invites-table-wrap{margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px}
    .pending-invites-table{min-width:860px;margin:0}
    .pending-invites-table th,.pending-invites-table td{white-space:nowrap}
    .pending-invites-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    .invite-status{display:inline-flex;align-items:center;gap:6px;font-weight:700;text-transform:uppercase;font-size:11px;letter-spacing:0.08em}
    .invite-status.pending{color:#34d399}
    .invite-status.expired{color:#fca5a5}
    .invite-row-expired{opacity:0.7}
    .provisioning-section{margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .provisioning-card{border:1px solid var(--border);border-radius:12px;padding:12px;background:transparent}
    .provisioning-card h3{margin:0;font-size:14px}
    .provisioning-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:8px}
    .provisioning-header{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .provisioning-table-wrap{margin-top:8px;overflow:auto;border:1px solid var(--border);border-radius:10px}
    .provisioning-table{min-width:720px;margin:0}
    .provisioning-note{font-size:12px;color:var(--muted);margin-top:6px}
    .provisioning-warning{margin-top:8px;padding:8px 10px;border:1px solid #b45309;border-radius:10px;background:rgba(245,158,11,0.08);color:#fbbf24;font-size:12px}
    .provisioning-summary{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .provisioning-summary-item{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .provisioning-summary-label{font-weight:600}
    .provisioning-status{font-size:11px;text-transform:uppercase;letter-spacing:0.08em}
    .provisioning-status.ok{color:#34d399}
    .provisioning-status.warn{color:#fbbf24}
    .provisioning-status.fail{color:#fca5a5}
    .provisioning-users-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .provisioning-field-toggle{display:flex;align-items:center;gap:8px}
    .snapshots-list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
    .snapshot-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .snapshot-title{font-weight:700}
    .snapshot-meta{font-size:12px;color:var(--muted);margin-top:6px}
    .snapshot-preview{margin-top:12px}
    .snapshot-preview-header{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .snapshot-preview-title{font-weight:700}
    .snapshot-preview-meta{font-size:12px;color:var(--muted);margin-top:6px}
    .snapshot-preview-table{margin-top:10px}
    .metrics-toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .metrics-content{margin-top:12px}
    .metrics-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:10px;
      margin-top:8px;
    }
    .metric-card{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:transparent;
    }
    .metric-value{font-size:20px;font-weight:700}
    .metric-label{font-size:12px;color:var(--muted);margin-top:4px}
    .metrics-section{margin-top:14px}
    .metrics-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
      margin-top:8px;
    }
    .metrics-table th,.metrics-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
    }
    .metrics-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .metrics-note{font-size:12px;color:var(--muted);margin-top:6px}
    .role-manager-table-wrap{max-height:420px;overflow:auto;margin-top:10px}
    .role-manager-table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .role-manager-table th,.role-manager-table td{
      text-align:left;
      padding:8px 10px;
      border-bottom:1px solid var(--border);
    }
    .role-manager-table th{font-size:11px;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted)}
    .role-manager-category td{
      background:#0f141b;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:11px;
      color:var(--muted);
    }
    .menu-icon-svg{flex-shrink:0}

    /* ========== Modernized Onboarding Wizard Theme ========== */
    :root {
      --wiz-bg: #09090b;
      --wiz-bg-elevated: #18181b;
      --wiz-accent: #00e5ff;
      --wiz-secondary: #a855f7;
      --wiz-text: #fafafa;
      --wiz-muted: #71717a;
      --wiz-border: #27272a;
      --wiz-gradient: linear-gradient(135deg, #00e5ff 0%, #a855f7 100%);
    }

    body.onboarding-route {
      background: var(--wiz-bg);
      min-height: 100vh;
    }
    body.onboarding-route::before {
      content: '';
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 800px;
      height: 600px;
      background: radial-gradient(ellipse at center, rgba(0,229,255,0.08) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }
    body.onboarding-route #appMain{display:none}
    body.onboarding-route .site-footer{display:none}
    body.onboarding-route header{display:none}

    .onboarding-view{
      display:none;
      max-width:720px;
      margin:0 auto;
      padding:40px 20px;
      position:relative;
      z-index:1;
      font-family:'Outfit',ui-sans-serif,system-ui,-apple-system,sans-serif;
    }
    .onboarding-view.active{display:block;animation:wizFadeIn 0.4s ease}

    @keyframes wizFadeIn {
      from{opacity:0;transform:translateY(12px)}
      to{opacity:1;transform:translateY(0)}
    }

    .onboarding-card{
      background: var(--wiz-bg-elevated);
      border-radius:20px;
      padding:32px;
      position:relative;
      border:1px solid transparent;
      background-clip:padding-box;
    }
    .onboarding-card::before {
      content:'';
      position:absolute;
      inset:0;
      border-radius:20px;
      padding:1px;
      background:var(--wiz-gradient);
      -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
    }

    .onboarding-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:24px;
      flex-wrap:wrap;
      margin-bottom:8px;
    }
    .onboarding-eyebrow{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--wiz-accent);
      font-weight:600;
    }
    .onboarding-title{
      margin:8px 0 4px;
      font-size:28px;
      font-weight:700;
      color:var(--wiz-text);
      letter-spacing:-0.02em;
    }
    .onboarding-plan{
      font-size:13px;
      color:var(--wiz-muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .onboarding-plan::before {
      content:'';
      display:inline-block;
      width:6px;
      height:6px;
      border-radius:50%;
      background:var(--wiz-secondary);
    }

    .onboarding-progress{min-width:220px;flex:1}
    .onboarding-progress-bar{
      height:8px;
      border-radius:999px;
      background:var(--wiz-border);
      overflow:hidden;
      box-shadow:inset 0 1px 2px rgba(0,0,0,0.3);
    }
    .onboarding-progress-fill{
      height:100%;
      width:0;
      background:var(--wiz-gradient);
      transition:width 0.4s cubic-bezier(0.4,0,0.2,1);
      box-shadow:0 0 12px rgba(0,229,255,0.5);
    }
    .onboarding-progress-steps{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .onboarding-progress-step{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.1em;
      font-weight:600;
      color:var(--wiz-muted);
      border:1px solid var(--wiz-border);
      border-radius:999px;
      padding:6px 12px;
      transition:all 0.2s ease;
    }
    .onboarding-progress-step.active{
      color:var(--wiz-accent);
      border-color:var(--wiz-accent);
      background:rgba(0,229,255,0.1);
      box-shadow:0 0 8px rgba(0,229,255,0.3);
    }
    .onboarding-progress-step.complete{
      color:#34d399;
      border-color:#34d399;
      background:rgba(52,211,153,0.1);
    }

    .onboarding-step{display:none;margin-top:24px}
    .onboarding-step.active{display:block;animation:wizFadeIn 0.3s ease}

    .onboarding-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;
      margin-top:16px;
    }

    /* Form styling for onboarding */
    #onboardingMain label{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--wiz-muted);
      font-weight:600;
      margin-bottom:6px;
      display:block;
    }
    #onboardingMain input,
    #onboardingMain select,
    #onboardingMain textarea{
      width:100%;
      padding:12px 14px;
      background:var(--wiz-bg);
      border:1px solid var(--wiz-border);
      border-radius:10px;
      color:var(--wiz-text);
      font-size:15px;
      font-family:inherit;
      transition:border-color 0.2s, box-shadow 0.2s;
    }
    #onboardingMain input:focus,
    #onboardingMain select:focus,
    #onboardingMain textarea:focus{
      outline:none;
      border-color:var(--wiz-accent);
      box-shadow:0 0 0 3px rgba(0,229,255,0.15);
    }
    #onboardingMain input::placeholder{color:var(--wiz-muted)}

    .onboarding-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:24px;
    }
    .onboarding-inline-actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:16px;
    }
    .onboarding-locations-summary{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .onboarding-location-card{
      border:1px solid var(--wiz-border);
      background:var(--wiz-bg);
      border-radius:12px;
      padding:12px;
    }
    .onboarding-location-name{font-weight:700;color:var(--wiz-text)}
    .onboarding-location-address{
      margin-top:6px;
      color:var(--wiz-muted);
      font-size:12px;
      line-height:1.4;
    }
    .onboarding-location-meta{
      margin-top:6px;
      color:var(--wiz-muted);
      font-size:12px;
    }

    .onboarding-message{
      font-size:13px;
      color:var(--wiz-muted);
      margin-top:8px;
    }

    .onboarding-gate{
      border:1px dashed var(--wiz-border);
      border-radius:16px;
      padding:20px;
      margin-top:20px;
      background:rgba(0,0,0,0.2);
    }
    .onboarding-gate-title{
      font-weight:700;
      margin-bottom:8px;
      color:var(--wiz-text);
    }
    .onboarding-note{
      font-size:13px;
      color:var(--wiz-muted);
      margin-top:8px;
    }

    /* Wizard brand logo */
    .onboarding-brand{
      text-align:center;
      margin-bottom:32px;
    }
    .onboarding-brand-logo{
      font-family:'Outfit',sans-serif;
      font-size:32px;
      font-weight:800;
      letter-spacing:-0.03em;
      background:var(--wiz-gradient);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .onboarding-brand-tagline{
      font-size:13px;
      color:var(--wiz-muted);
      margin-top:4px;
    }
</style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-row">
        <div class="header-left">
          <div class="brandtext">
            <img class="title-logo" src="./assets/modulus/logo/inventory-manager-logo.svg" alt="Inventory Manager logo" />
          </div>
        </div>
        <div class="header-right">
          <div class="profile-menu">
            <button class="icon-btn icon-btn--default profile-btn" id="profileBtn" aria-label="Account menu" aria-expanded="false">
              <span class="profile-status" id="profileStatus"></span>
              <svg class="profile-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </button>
            <div class="profile-dropdown profile-tabs" id="profileDropdown" role="dialog" aria-label="Profile menu" aria-hidden="true">
            <div class="profile-panel-header">
              <div class="profile-email" id="profileEmail">Not signed in</div>
              <div class="profile-company-name" id="profileCompanyName">No company selected</div>
              <div class="profile-badges">
                <span class="env-badge profile-env-badge hidden" id="profileEnvBadge">Production</span>
                <span class="profile-role-badge" id="profileRoleBadge">USER</span>
              </div>
            </div>
            <div class="profile-tabbar" id="profileTabList" role="tablist" aria-label="Profile sections">
              <button class="profile-tab is-active" role="tab" id="profileTabAccount" data-tab="account" aria-selected="true" aria-controls="profilePanelAccount" tabindex="0">Account</button>
              <button class="profile-tab" role="tab" id="profileTabCompany" data-tab="company" aria-selected="false" aria-controls="profilePanelCompany" tabindex="-1">Company</button>
              <button class="profile-tab" role="tab" id="profileTabTeam" data-tab="team" aria-selected="false" aria-controls="profilePanelTeam" tabindex="-1">Team</button>
            </div>
            <div class="profile-panels" id="profileTabPanels">
              <div class="profile-panel is-active" role="tabpanel" id="profilePanelAccount" data-panel="account" aria-labelledby="profileTabAccount" tabindex="0">
                <button class="profile-item" id="openProfileSettings" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                  <span>Profile Settings</span>
                </button>
                <div class="profile-divider"></div>
                <button class="profile-item profile-item--danger" id="profileSignIn" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                  <span id="profileSignInText">Sign Out</span>
                </button>
              </div>
              <div class="profile-panel" role="tabpanel" id="profilePanelCompany" data-panel="company" aria-labelledby="profileTabCompany" tabindex="0">
                <button class="profile-item" id="openCompanySwitcher" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                  <span>Change User Company</span>
                </button>
                <button class="profile-item" id="openCompanyLocations" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 10c0 5-9 11-9 11S3 15 3 10a9 9 0 1 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                  <span>Locations</span>
                </button>
                <button class="profile-item" id="openSubscriptionManager" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
                  <span>Subscription</span>
                </button>
              </div>
              <div class="profile-panel" role="tabpanel" id="profilePanelTeam" data-panel="team" aria-labelledby="profileTabTeam" tabindex="0">
                <button class="profile-item" id="openInviteModal" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
                  <span>Invite User</span>
                </button>
                <button class="profile-item" id="openUserMgmt" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                  <span>Manage Users</span>
                </button>
                <button class="profile-item" id="openRoleManager" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                  <span>Roles &amp; Permissions</span>
                </button>
                <button class="profile-item" id="openRoleRequests" type="button">
                  <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                  <span>Role Requests</span>
                  <span class="profile-item-badge" id="roleRequestsBadge" style="display:none;">0</span>
                </button>
                <div class="profile-empty" id="profileTeamEmpty" style="display:none;">No team actions available.</div>
              </div>
            </div>
            </div>
          </div>
          <div class="hamburger-menu">
            <button class="icon-btn icon-btn--default hamburger-btn" id="hamburgerBtn" aria-label="Open menu" aria-expanded="false">
              <span></span>
              <span></span>
              <span></span>
            </button>
          </div>
        </div>
      </div>
      <div id="menuBackdrop" class="menu-backdrop" aria-hidden="true">
        <div class="menu-panel" id="menuPanel" role="dialog" aria-modal="true" aria-labelledby="menuTitle">
          <div class="menu-header">
            <div class="menu-title" id="menuTitle">Menu</div>
            <button class="menu-close" id="menuCloseBtn" type="button" aria-label="Close menu">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="menu-quick-actions">
            <button class="menu-quick-btn" id="menuAddOne" type="button">
              <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <span>Add Item</span>
            </button>
            <button class="menu-quick-btn" id="menuOrder" type="button">
              <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
              </svg>
              <span>New Order</span>
            </button>
          </div>
          <div class="menu-tabs" id="menuTabList" role="tablist" aria-label="Menu sections">
            <button class="menu-tab is-active" role="tab" id="menuTabInventory" data-tab="inventory" aria-selected="true" aria-controls="menuPanelInventory" tabindex="0">Inventory</button>
            <button class="menu-tab" role="tab" id="menuTabOrders" data-tab="orders" aria-selected="false" aria-controls="menuPanelOrders" tabindex="-1">Orders</button>
            <button class="menu-tab" role="tab" id="menuTabReports" data-tab="reports" aria-selected="false" aria-controls="menuPanelReports" tabindex="-1">Reports</button>
          </div>
          <div class="menu-tab-panels" id="menuTabPanels">
            <div class="menu-tab-panel is-active" role="tabpanel" id="menuPanelInventory" data-panel="inventory" aria-labelledby="menuTabInventory" tabindex="0">
              <div class="menu-section-label">Data</div>
              <button class="menu-item" id="menuImport" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Import File</span>
              </button>
              <button class="menu-item" id="menuPaste" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                  <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
                <span>Paste Data</span>
              </button>
              <button class="menu-item" id="menuExport" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span>Export File</span>
              </button>
              <!--
              // Inventory Report retired.
              // Inventory List + quick filters cover low-stock use cases.
              // Future replacement: Report Builder.
              -->
              <div class="menu-divider"></div>
              <button class="menu-item menu-item--danger" id="menuTrash" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                  <line x1="10" y1="11" x2="10" y2="17"></line>
                  <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
                <span>Trash</span>
              </button>
            </div>
            <div class="menu-tab-panel" role="tabpanel" id="menuPanelOrders" data-panel="orders" aria-labelledby="menuTabOrders" tabindex="0">
              <button class="menu-item" id="menuJobs" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                  <path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>
                </svg>
                <span>Jobs</span>
                <span class="menu-item-badge" id="menuJobsBadge" style="display:none;">0</span>
              </button>
              <button class="menu-item" id="menuReceive" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                  <path d="M3.27 6.96 12 12.01l8.73-5.05"></path>
                  <path d="M12 22.08V12"></path>
                  <polyline points="9 11 12 14 16 10"></polyline>
                </svg>
                <span>Receive Inventory</span>
              </button>
              <button class="menu-item" id="menuHistory" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                <span>Order History</span>
              </button>
            </div>
            <div class="menu-tab-panel" role="tabpanel" id="menuPanelReports" data-panel="reports" aria-labelledby="menuTabReports" tabindex="0">
              <button class="menu-item" id="menuMetrics" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <line x1="12" y1="20" x2="12" y2="10"></line>
                  <line x1="18" y1="20" x2="18" y2="4"></line>
                  <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                <span>Metrics</span>
              </button>
              <button class="menu-item" id="menuSnapshots" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"></path>
                  <circle cx="12" cy="13" r="4"></circle>
                </svg>
                <span>Snapshots</span>
              </button>
              <button class="menu-item" id="menuAudit" type="button">
                <svg class="menu-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M8 21h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H8"></path>
                  <path d="M6 17H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h2"></path>
                  <path d="M8 5v16"></path>
                  <path d="M10 9h8"></path>
                  <path d="M10 13h8"></path>
                  <path d="M10 17h8"></path>
                </svg>
                <span>Audit Log</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main id="onboardingMain" class="onboarding-view" aria-live="polite">
    <div class="onboarding-brand">
      <div class="onboarding-brand-logo">modulus</div>
      <div class="onboarding-brand-tagline">Inventory Manager</div>
    </div>
    <section class="card onboarding-card">
      <div class="onboarding-header">
        <div>
          <div class="onboarding-eyebrow" id="onboardingEyebrow">Company Onboarding</div>
          <div class="onboarding-title" id="onboardingTitle">Set up your workspace</div>
          <div class="onboarding-plan" id="onboardingPlanSummary" style="display:none;"></div>
          <div class="onboarding-note" id="onboardingNote">You can complete setup later.</div>
        </div>
        <div class="onboarding-progress" aria-label="Onboarding progress">
          <div class="onboarding-progress-bar">
            <div class="onboarding-progress-fill" id="onboardingProgressFill"></div>
          </div>
          <div class="onboarding-progress-steps" id="onboardingProgressSteps">
            <div class="onboarding-progress-step" data-onboarding-progress="1">Company Profile</div>
            <div class="onboarding-progress-step" data-onboarding-progress="2">Locations</div>
            <div class="onboarding-progress-step" data-onboarding-progress="3">Invite Users</div>
            <div class="onboarding-progress-step" data-onboarding-progress="4">Finish</div>
          </div>
        </div>
      </div>

      <div id="onboardingGate" class="onboarding-gate" style="display:none;">
        <div class="onboarding-gate-title" id="onboardingGateTitle"></div>
        <div class="muted" id="onboardingGateMessage"></div>
        <div class="onboarding-actions">
          <button class="btn-primary" id="onboardingGatePrimary" type="button">Continue</button>
          <button class="btn-secondary" id="onboardingGateSecondary" type="button" style="display:none;">Continue</button>
        </div>
      </div>

      <div id="onboardingWizard">
        <!-- Step 0: Create Account (for new signups) -->
        <div class="onboarding-step" id="onboardingStepAccount" data-onboarding-step="account">
          <h2 style="margin:0;font-size:16px;">Create Your Account</h2>
          <div class="muted" style="margin-top:6px;">Get started with your free account.</div>
          <form id="onboardingAccountForm">
            <div class="onboarding-grid">
              <div>
                <label class="muted" for="signupEmail">Email address</label>
                <input id="signupEmail" type="email" placeholder="you@company.com" autocomplete="email" inputmode="email" required />
              </div>
              <div>
                <label class="muted" for="signupPassword">Password</label>
                <input id="signupPassword" type="password" placeholder="At least 8 characters" autocomplete="new-password" required />
              </div>
              <div>
                <label class="muted" for="signupPasswordConfirm">Confirm password</label>
                <input id="signupPasswordConfirm" type="password" placeholder="Confirm password" autocomplete="new-password" required />
              </div>
            </div>
            <div class="onboarding-terms" style="margin-top:12px;">
              <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:var(--wiz-muted);">
                <input type="checkbox" id="signupTerms" required style="width:auto;" />
                I agree to the <a href="/terms" target="_blank" style="color:var(--wiz-accent);">Terms of Service</a>
              </label>
            </div>
            <div class="onboarding-actions">
              <div id="signupAccountMsg" class="onboarding-message" style="margin-right:auto;"></div>
              <button class="btn-secondary" id="btnSignupHaveAccount" type="button">Already have an account?</button>
              <button class="btn-primary" id="btnSignupSubmit" type="submit">Create Account</button>
            </div>
          </form>
        </div>

        <!-- Step 1: Name Your Company (for new signups) -->
        <div class="onboarding-step" id="onboardingStepCompany" data-onboarding-step="company">
          <h2 style="margin:0;font-size:16px;">Name Your Company</h2>
          <div class="muted" style="margin-top:6px;">This will be your workspace in the Inventory Manager.</div>
          <form id="onboardingCompanyForm">
            <div class="onboarding-grid">
              <div style="grid-column: 1 / -1;">
                <label class="muted" for="signupCompanyName">Company name</label>
                <input id="signupCompanyName" type="text" placeholder="Acme Corporation" autocomplete="organization" required />
              </div>
            </div>
            <div class="onboarding-actions">
              <div id="signupCompanyMsg" class="onboarding-message" style="margin-right:auto;"></div>
              <button class="btn-primary" id="btnCompanySubmit" type="submit">Continue</button>
            </div>
          </form>
        </div>

        <div class="onboarding-step" id="onboardingStepProfile" data-onboarding-step="profile">
          <h2 style="margin:0;font-size:16px;">Company Profile</h2>
          <div class="muted" style="margin-top:6px;">Tell us the basics so we can personalize your setup.</div>
          <form id="onboardingProfileForm">
            <div class="onboarding-grid">
              <div>
                <label class="muted" for="onboardingCompanyName">Company name</label>
                <input id="onboardingCompanyName" type="text" placeholder="Acme Co." autocomplete="organization" />
              </div>
              <div>
                <label class="muted" for="onboardingContactEmail">Primary contact email</label>
                <input id="onboardingContactEmail" type="email" placeholder="ops@acme.co" autocomplete="email" inputmode="email" />
              </div>
              <div>
                <label class="muted" for="onboardingTimezone">Timezone</label>
                <select id="onboardingTimezone">
                  <option value="">Select timezone...</option>
                </select>
              </div>
            </div>
            <div class="onboarding-actions">
              <div id="onboardingProfileMsg" class="onboarding-message" style="margin-right:auto;"></div>
              <button class="btn-primary" id="btnOnboardingProfileSave" type="submit">Continue</button>
            </div>
          </form>
        </div>

        <div class="onboarding-step" id="onboardingStepLocations" data-onboarding-step="locations">
          <h2 style="margin:0;font-size:16px;">Locations</h2>
          <div class="muted" style="margin-top:6px;">Add at least one active location to receive inventory.</div>
          <div class="onboarding-inline-actions">
            <button class="btn-secondary" id="btnOnboardingManageLocations" type="button">Manage Locations</button>
            <button class="btn-primary" id="btnOnboardingLocationsContinue" type="button">Continue</button>
          </div>
          <div id="onboardingLocationsStatus" class="onboarding-message"></div>
          <div id="onboardingLocationsSummary" class="onboarding-locations-summary"></div>
          <div id="onboardingLocationsMsg" class="onboarding-message"></div>
        </div>

        <div class="onboarding-step" id="onboardingStepInvites" data-onboarding-step="invites">
          <h2 style="margin:0;font-size:16px;">Invite Users</h2>
          <div class="muted" style="margin-top:6px;">Invite teammates now, or skip and return later.</div>
          <div class="onboarding-inline-actions">
            <button class="btn-secondary" id="btnOnboardingInviteOpen" type="button">Send Invite</button>
            <button class="btn-secondary" id="btnOnboardingInvitesRefresh" type="button">Refresh Invites</button>
            <button class="btn-secondary" id="btnOnboardingInvitesSkip" type="button">Skip for now</button>
            <button class="btn-primary" id="btnOnboardingInvitesContinue" type="button">Continue</button>
          </div>
          <div id="onboardingInvitesMsg" class="onboarding-message"></div>
          <div id="onboardingPendingInvitesSlot"></div>
        </div>

        <div class="onboarding-step" id="onboardingStepFinish" data-onboarding-step="finish">
          <h2 style="margin:0;font-size:16px;">Finish</h2>
          <div class="muted" style="margin-top:6px;">Your company is ready. You can adjust settings anytime.</div>
          <div class="onboarding-inline-actions">
            <button class="btn-primary" id="btnOnboardingFinish" type="button">Go to Dashboard</button>
          </div>
          <div id="onboardingFinishMsg" class="onboarding-message"></div>
        </div>
      </div>
    </section>
  </main>

  <main id="appMain">
    <section class="card">
	      <div class="toolbar" role="toolbar" aria-label="Inventory actions" style="justify-content:center;">
	        <input type="file" id="fileImport" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" style="display:none" />
	        <div class="inv-controls">
	          <div class="inv-filter-group">
	            <div class="input-wrap">
	              <input id="filterBox" type="text" placeholder="Filter itemsâ€¦" aria-label="Filter items" />
	              <button class="icon-btn icon-btn--default clear-input-btn" id="btnClearFilter" type="button" aria-label="Clear filter" title="Clear filter" style="display:none">
	                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	                  <path d="M18 6L6 18"></path>
	                  <path d="M6 6l12 12"></path>
	                </svg>
	              </button>
	            </div>
	            <div class="inv-filter-pills" id="invQuickFilters" role="group" aria-label="Quick filters">
	              <button class="inv-filter-pill is-active" type="button" data-filter="all" aria-pressed="true">All</button>
	              <button class="inv-filter-pill" type="button" data-filter="in_stock" aria-pressed="false">In Stock</button>
	              <button class="inv-filter-pill" type="button" data-filter="low_stock" aria-pressed="false">Low Stock</button>
	              <button class="inv-filter-pill" type="button" data-filter="out_of_stock" aria-pressed="false">Out of Stock</button>
	            </div>
	          </div>
	          <div class="sort-wrap" id="mobileSortWrap">
	            <select id="mobileSort" aria-label="Sort items">
	              <option value="name:asc">Item (Aâ€“Z)</option>
	              <option value="name:desc">Item (Zâ€“A)</option>
	              <option value="desc:asc">Description (Aâ€“Z)</option>
	              <option value="desc:desc">Description (Zâ€“A)</option>
	              <option value="qty:asc">Qty (Lowâ€“High)</option>
	              <option value="qty:desc">Qty (Highâ€“Low)</option>
	              <option value="updatedAt:desc">Last Modified (Newest)</option>
	              <option value="updatedAt:asc">Last Modified (Oldest)</option>
	            </select>
	          </div>
	          <div class="columns-wrap">
	            <button class="btn-secondary btn-with-icon" id="btnColumnBuilder" type="button" aria-haspopup="dialog" aria-expanded="false">
	              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	                <rect x="3" y="3" width="7" height="18"></rect>
	                <rect x="14" y="3" width="7" height="18"></rect>
	              </svg>
	              <span>Columns</span>
	            </button>
	            <div class="column-builder" id="columnBuilder" role="dialog" aria-label="Column chooser" aria-hidden="true">
	              <div class="column-builder-header">
	                <div>
	                  <div class="column-builder-title">Columns</div>
	                  <div class="column-builder-subtitle">Choose columns</div>
	                </div>
	                <button class="column-builder-drag" id="columnBuilderDrag" type="button" aria-label="Move column builder" title="Drag to move"></button>
	              </div>
	              <div class="column-builder-list" id="columnBuilderList"></div>
	              <div class="column-builder-section">
                <div class="column-builder-section-title">Row Tap</div>
                <div class="column-builder-tap" id="columnBuilderTap">
                  <label for="rowTapExpandDetails" data-tap-option="expand_details">
                    <input type="radio" id="rowTapExpandDetails" name="rowTapPref" value="expand_details">
                    Expand details
                  </label>
                  <label for="rowTapOrder" data-tap-option="add_to_order">
                    <input type="radio" id="rowTapOrder" name="rowTapPref" value="add_to_order">
                    Add to order
                  </label>
                  <label for="rowTapJob" data-tap-option="add_to_job">
                    <input type="radio" id="rowTapJob" name="rowTapPref" value="add_to_job">
                    Add to job
                  </label>
                  <label for="rowTapEdit" data-tap-option="edit_item">
                    <input type="radio" id="rowTapEdit" name="rowTapPref" value="edit_item">
                    Edit item
                  </label>
                </div>
              </div>
	              <div class="column-builder-actions">
	                <button class="btn-tertiary btn-sm" id="btnColumnsReset" type="button">Reset to defaults</button>
	                <button class="btn-secondary" id="btnColumnsClose" type="button">Close</button>
	              </div>
	            </div>
	          </div>
	        </div>
	      </div>

	      <div class="totals" aria-live="polite">
	        <span id="totalItems" class="muted">Total Items: 0</span>
	        <span id="totalInStock" class="muted">In Stock: 0</span>
	        <span id="totalLowStock" class="muted">Low Stock: 0</span>
	        <span id="totalQty" class="muted">Total Qty: 0</span>
	      </div>

	      <div class="order-pill-container" id="orderPillContainer" style="display:none;">
	        <button class="order-pill" id="orderPill" data-order-reset aria-label="Shopping Cart (tap to clear selected items)">
	          <span class="order-pill-value" id="orderPillValue">0</span>
	          <span class="order-pill-label">Items in Cart</span>
	          <span class="order-pill-hint">tap to clear</span>
	        </button>
	      </div>

	      <div class="scroll" id="tableWrap">
	        <table id="invTable" role="grid" aria-label="Inventory table">
	          <colgroup id="invTableColgroup"></colgroup>
	          <thead id="invTableHead"></thead>
	          <tbody></tbody>
	        </table>
	      </div>
      <div class="muted" style="margin-top:8px">
        <span id="editHint">Use the pencil icon to edit item details.</span>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <img class="footer-logo" src="./assets/modulus/logo/modulus-logo-horizontal.svg" alt="Modulus Software, LLC" />
  </footer>

  <!-- Paste/Import modal -->
  <div id="pasteModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="pasteModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="9" y="2" width="6" height="4"></rect>
              <path d="M5 6h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 class="modal-title" id="pasteModalTitle">Paste Data</h2>
            <div class="modal-subtitle">Import items from clipboard or file.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="pasteModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Import</div>
          <div class="muted">
            Provide columns <code>Item, Description, Qty</code>. Headers optional; Qty optional (defaults to 0).
            Tabs, commas, or multi-space columns are accepted.
          </div>
          <div class="drop" id="dropZone">Drop a CSV/TSV/TXT/JSON/XLSX/XLS/DOCX/PDF file here, or choose below.</div>
          <label for="fileImportModal">Choose file</label>
          <input type="file" id="fileImportModal" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" />
          <label for="pasteArea">Paste data</label>
          <textarea id="pasteArea" rows="8" placeholder="Item, Description, Qty"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <span id="pasteInfo" class="muted"></span>
        </div>
        <div class="footer-right">
          <button class="btn-secondary" id="btnPasteCancel" type="button" data-modal-close="pasteModal">Cancel</button>
          <button class="btn-primary" id="btnPasteApply" type="button">Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add-one modal -->
  <div id="addOneModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="addOneModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 class="modal-title" id="addOneModalTitle">Add Item</h2>
            <div class="modal-subtitle">Create a single inventory item.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="addOneModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Details</div>
          <label for="addName">Item (unique)</label>
          <input id="addName" type="text" placeholder="Item" autocapitalize="off" autocomplete="off" spellcheck="false" />
          <label for="addDesc">Description (optional)</label>
          <input id="addDesc" type="text" placeholder="Description" />
          <label for="addQty">Quantity</label>
          <div class="qty-stepper" id="addQtyStepper">
            <button type="button" class="qty-stepper-btn" id="addQtyDec" aria-label="Decrease quantity">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <input type="text" inputmode="numeric" pattern="[0-9]*" class="qty-stepper-input" id="addQty" value="1" aria-label="Quantity">
            <button type="button" class="qty-stepper-btn" id="addQtyInc" aria-label="Increase quantity">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnAddCancel" type="button" data-modal-close="addOneModal">Cancel</button>
          <button class="btn-primary" id="btnAddSave" type="button">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Item modal (canonical) -->
  <div id="editItemModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="editItemTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 20h9"></path>
              <path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="editItemTitle" class="modal-title">Edit Item</h2>
            <div class="modal-subtitle">Update details, inventory, and reorder settings.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="editItemModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Details</div>
          <div class="edit-grid-2">
            <div class="edit-field">
              <label for="editItemName">Item</label>
              <input id="editItemName" type="text" placeholder="Item" autocapitalize="off" autocomplete="off" spellcheck="false" />
            </div>
            <div class="edit-field">
              <label for="editItemSku">SKU</label>
              <input id="editItemSku" type="text" placeholder="SKU" autocapitalize="off" autocomplete="off" spellcheck="false" />
            </div>
          </div>
          <div class="edit-field">
            <label for="editItemDesc">Description</label>
            <textarea id="editItemDesc" rows="3" placeholder="Description" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Inventory</div>
          <div class="edit-grid-3">
            <div class="edit-field">
              <label for="editItemQty">On Hand</label>
              <div class="qty-stepper qty-stepper--modal">
                <button class="qty-step" id="editItemQtyMinus" type="button" aria-label="Decrease qty">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
                <input id="editItemQty" type="number" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" />
                <button class="qty-step" id="editItemQtyPlus" type="button" aria-label="Increase qty">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              </div>
            </div>
            <div class="edit-field">
              <label for="editItemReserved">Reserved</label>
              <input id="editItemReserved" class="edit-readonly" type="text" disabled />
            </div>
            <div class="edit-field">
              <label for="editItemAvailable">Available</label>
              <input id="editItemAvailable" class="edit-readonly" type="text" disabled />
            </div>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Reorder Settings</div>
          <div class="edit-grid-2">
            <div class="edit-field">
              <label for="editLowStockQty">Reorder Point</label>
              <div class="qty-stepper qty-stepper--modal" aria-label="Reorder point controls">
                <button type="button" id="editLowStockMinus" class="qty-step" aria-label="Decrease reorder point">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
                <input type="number" id="editLowStockQty" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done">
                <button type="button" id="editLowStockPlus" class="qty-step" aria-label="Increase reorder point">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              </div>
              <div class="edit-stepper-actions" style="justify-content:flex-start;">
                <button type="button" id="btnEditUseGlobal" class="btn-tertiary btn-sm">Use Global</button>
              </div>
            </div>
            <div class="edit-field">
              <label for="editItemReorderQty">Reorder Qty</label>
              <div class="qty-stepper qty-stepper--modal">
                <button class="qty-step" id="editItemReorderQtyMinus" type="button" aria-label="Decrease reorder qty">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
                <input id="editItemReorderQty" type="number" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" />
                <button class="qty-step" id="editItemReorderQtyPlus" type="button" aria-label="Increase reorder qty">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <div class="edit-toggle-row" style="margin-top:6px;">
            <label class="toggle-switch">
              <input type="checkbox" id="editReorderEnabled" checked>
              <span class="toggle-slider"></span>
            </label>
            <label for="editReorderEnabled" class="muted">Include this Part # in the batch Re-Order?</label>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Classification</div>
          <div class="edit-grid-3">
            <div class="edit-field">
              <label for="editItemUom">Unit of Measure</label>
              <select id="editItemUom"></select>
            </div>
            <div class="edit-field">
              <label for="editItemLocation">Location</label>
              <select id="editItemLocation"></select>
            </div>
            <div class="edit-field">
              <label for="editItemCategory">Category</label>
              <input id="editItemCategory" type="text" list="editItemCategoryList" placeholder="Category" />
              <datalist id="editItemCategoryList"></datalist>
            </div>
          </div>
        </div>
        <div id="editItemMsg" class="muted" style="margin-top:10px;"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <button class="btn-secondary btn-danger" id="btnEditItemDelete" type="button">Delete</button>
        </div>
        <div class="footer-right">
          <button class="btn-secondary" id="btnEditItemCancel" type="button" data-modal-close="editItemModal">Cancel</button>
          <button class="btn-primary" id="btnEditItemDone" type="button">Done</button>
        </div>
      </div>
    </div>
  </div>

	  <!-- Message modal -->
	  <div id="msgModal" class="modal-backdrop" aria-hidden="true">
	    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="msgTitle">
        <div class="modal-header">
          <div class="modal-title-wrap">
            <span class="modal-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
            </span>
            <div class="modal-title-text">
              <h2 id="msgTitle" class="modal-title">Message</h2>
            </div>
          </div>
          <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="msgModal" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-section">
            <div id="msgBody" class="muted" style="white-space:pre-wrap;"></div>
          </div>
        </div>
        <div class="modal-footer">
          <div class="footer-left">
            <button class="btn-secondary" id="btnMsgCopy" type="button" style="display:none">Copy</button>
          </div>
          <div class="footer-right">
            <button class="btn-secondary" id="btnMsgCancel" type="button" data-modal-close="msgModal">Cancel</button>
            <button class="btn-primary" id="btnMsgOk" type="button">OK</button>
          </div>
        </div>
	    </div>
	  </div>
	
  <!-- Confirm modal -->
  <div id="confirmModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 2 2 20h20L12 2z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="confirmTitle" class="modal-title">Confirm</h2>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="confirmModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div id="confirmBody" class="muted" style="white-space:pre-wrap;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnConfirmCancel" type="button">Cancel</button>
          <button class="btn-primary" id="btnConfirmOk" type="button">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import preview -->
  <div id="previewModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="previewModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="previewModalTitle" class="modal-title">Import Preview</h2>
            <div class="modal-subtitle">Review changes before applying.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="previewModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div id="previewInfo" class="muted"></div>
          <div class="scroll" style="max-height:50vh">
            <table style="width:100%;border-collapse:collapse;font-size:14px">
              <thead>
                <tr>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Item</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Description</th>
                  <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">Old Qty</th>
                  <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">New Qty</th>
                  <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Action</th>
                </tr>
              </thead>
              <tbody id="previewBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnPreviewCancel" type="button" data-modal-close="previewModal">Cancel</button>
          <button class="btn-primary" id="btnPreviewApply" type="button">Apply Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Qty entry modal -->
  <div id="qtyEntryModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="qtyEntryTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M4 7h16"></path>
              <path d="M4 12h16"></path>
              <path d="M4 17h16"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="qtyEntryTitle" class="modal-title">Set Qty</h2>
            <div id="qtyEntrySubtitle" class="modal-subtitle" style="display:none;"></div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="qtyEntryModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label for="qtyEntryInput">Quantity</label>
          <input id="qtyEntryInput" type="number" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" style="text-align:center;font-weight:900;font-size:22px;" />
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnQtyEntryCancel" type="button">Cancel</button>
          <button class="btn-primary" id="btnQtyEntryOk" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Order modal -->
  <div id="orderModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="orderModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="9" cy="21" r="1"></circle>
              <circle cx="20" cy="21" r="1"></circle>
              <path d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="orderModalTitle" class="modal-title">Create Order</h2>
            <div class="modal-subtitle">Build a cart and send the order email.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="orderModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Materials</div>
          <div class="input-wrap" style="max-width:100%;">
            <input id="orderSearch" type="text" placeholder="Search inventory to add itemsâ€¦" autocomplete="off" />
            <button class="icon-btn icon-btn--default clear-input-btn" id="btnClearOrderSearch" type="button" aria-label="Clear search" title="Clear search" style="display:none">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M18 6L6 18"></path>
                <path d="M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          <div id="orderResultsBody" class="order-list" style="margin-top:10px;"></div>
        </div>
        <div class="form-section">
          <div class="section-label">
            <span>Shopping Cart</span>
            <span id="orderLinesInfo"></span>
            <button type="button" id="btnResetOrderList" class="icon-btn icon-btn--default" aria-label="Reset order list" title="Reset order list">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
              </svg>
            </button>
          </div>
          <div id="orderLinesBody" class="order-list"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Order Fulfillment Email</div>
          <label for="orderEmail">Recipient email</label>
          <input id="orderEmail" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />
          <div id="orderEmailSuggest" class="order-suggest" aria-label="Email suggestions"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Shipping Address</div>
          <div class="order-shipping-row">
            <select id="orderShippingAddress" aria-label="Shipping address"></select>
            <button class="btn-secondary" id="btnOrderShippingManage" type="button">Locations</button>
          </div>
          <div id="orderShippingPreview" class="muted" style="margin-top:6px;"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Message</div>
          <div style="display:grid; grid-template-columns:1fr; gap:10px;">
            <div class="order-po-grid">
              <div>
                <label for="orderCompanyPoNumber">Company PO Number (optional)</label>
                <input id="orderCompanyPoNumber" type="text" placeholder="Company PO #" />
              </div>
              <div>
                <label for="orderInternalPoNumber">Internal PO ID</label>
                <input id="orderInternalPoNumber" type="text" readonly />
              </div>
              <div class="order-po-subject">
                <label for="orderSubject">Subject</label>
                <input id="orderSubject" type="text" readonly />
              </div>
            </div>
            <div>
              <label for="orderNotes">Notes (optional)</label>
              <textarea id="orderNotes" rows="3" placeholder="Any notesâ€¦"></textarea>
            </div>
            <div class="order-preview">
              <div class="section-label">Email Preview</div>
              <div id="orderPreviewHtml" class="order-preview-html"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <button class="btn-secondary" id="btnOrderCopy" type="button">Copy</button>
        </div>
        <div class="footer-right">
          <button class="btn-secondary" id="btnOrderCancel" type="button" data-modal-close="orderModal">Cancel</button>
          <button class="btn-primary order-send" id="btnOrderSubmit" type="button">Submit Order</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Shipping addresses modal -->
  <div id="shippingAddressModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="shippingAddressTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 17.5V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v10.5"></path>
              <path d="M12 3v18"></path>
              <path d="M12 16l4-4"></path>
              <path d="M12 16l-4-4"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="shippingAddressTitle" class="modal-title">Shipping Addresses</h2>
            <div class="modal-subtitle">Manage saved shipping addresses for orders.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="shippingAddressModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Saved Addresses</div>
          <div style="display:flex;justify-content:flex-end;">
            <button class="btn-secondary" id="btnShippingAddressNew" type="button">Add New</button>
          </div>
          <div id="shippingAddressList" class="shipping-address-list" aria-live="polite"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Address Details</div>
          <div id="shippingAddressFormTitle" class="muted">Add Shipping Address</div>
          <div class="shipping-address-form">
            <label for="shippingAddressLabel">Label</label>
            <input id="shippingAddressLabel" type="text" placeholder="Main Warehouse" />
            <label for="shippingAddressValue">Address</label>
            <textarea id="shippingAddressValue" rows="3" placeholder="123 Main St&#10;City, ST 12345"></textarea>
            <div class="shipping-address-default">
              <label class="toggle-switch">
                <input id="shippingAddressDefault" type="checkbox" />
                <span class="toggle-slider"></span>
              </label>
              <label for="shippingAddressDefault" class="muted" style="font-size:13px;cursor:pointer;">Set as default</label>
            </div>
          </div>
          <div id="shippingAddressMsg" class="muted"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnShippingAddressClose" type="button" data-modal-close="shippingAddressModal">Cancel</button>
          <button class="btn-primary" id="btnShippingAddressSave" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Company locations modal -->
  <div id="companyLocationsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="companyLocationsTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 21h18"></path>
              <path d="M5 21V7l8-4 8 4v14"></path>
              <path d="M9 21v-8h6v8"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="companyLocationsTitle" class="modal-title">Company Locations</h2>
            <div class="modal-subtitle">Manage locations used for shipping and receiving.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="companyLocationsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Locations</div>
          <div style="display:flex;justify-content:flex-end;">
            <button class="btn-secondary" id="btnCompanyLocationNew" type="button">Add Location</button>
          </div>
          <div id="companyLocationsList" class="company-locations-list" aria-live="polite"></div>
          <div id="companyLocationsMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnCompanyLocationsClose" type="button" data-modal-close="companyLocationsModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="companyLocationsModal">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Company location editor modal -->
  <div id="companyLocationEditorModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="companyLocationEditorTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="companyLocationEditorTitle" class="modal-title">Add Location</h2>
            <div class="modal-subtitle">Keep locations current for receiving and shipping.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="companyLocationEditorModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Location Details</div>
          <div class="company-location-form">
            <div class="field">
              <label for="companyLocationName">Name</label>
              <input id="companyLocationName" type="text" placeholder="Main Warehouse" />
            </div>
            <div class="field">
              <label for="companyLocationType">Location Type</label>
              <select id="companyLocationType">
                <option value="warehouse">Warehouse</option>
                <option value="yard">Yard</option>
                <option value="office">Office</option>
                <option value="job_site">Job Site</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="field full">
              <label for="companyLocationAddress1">Address Line 1</label>
              <input id="companyLocationAddress1" type="text" placeholder="123 Main St" autocomplete="off" />
            </div>
            <div class="field full">
              <label for="companyLocationAddress2">Address Line 2</label>
              <input id="companyLocationAddress2" type="text" placeholder="Suite 200" />
            </div>
            <div class="field">
              <label for="companyLocationCity">City</label>
              <input id="companyLocationCity" type="text" placeholder="Austin" />
            </div>
            <div class="field">
              <label for="companyLocationState">State/Region</label>
              <input id="companyLocationState" type="text" placeholder="TX" />
            </div>
            <div class="field">
              <label for="companyLocationPostal">Postal Code</label>
              <input id="companyLocationPostal" type="text" placeholder="78701" />
            </div>
            <div class="field">
              <label for="companyLocationCountry">Country</label>
              <select id="companyLocationCountry"></select>
            </div>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Defaults</div>
          <div class="company-location-defaults">
            <label class="toggle-switch">
              <input id="companyLocationDefaultShipTo" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
            <label for="companyLocationDefaultShipTo" class="muted" style="font-size:13px;cursor:pointer;">Set as Default Ship-To</label>
            <label class="toggle-switch">
              <input id="companyLocationDefaultReceiveAt" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
            <label for="companyLocationDefaultReceiveAt" class="muted" style="font-size:13px;cursor:pointer;">Set as Default Receive-At</label>
          </div>
          <div id="companyLocationEditorMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnCompanyLocationCancel" type="button" data-modal-close="companyLocationEditorModal">Cancel</button>
          <button class="btn-primary" id="btnCompanyLocationSave" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Qty picker modal -->
  <div id="qtyPickerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="qtyPickerTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 12h18"></path>
              <path d="M3 6h18"></path>
              <path d="M3 18h18"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="qtyPickerTitle" class="modal-title">Order Qty</h2>
            <div class="modal-subtitle">Choose a quantity.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="qtyPickerModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="qty-picker-wheel-wrap">
            <div class="qty-picker-highlight"></div>
            <div class="qty-picker-wheel" id="qtyPickerWheel"></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button type="button" class="btn-secondary" id="qtyPickerCancel">Cancel</button>
          <button type="button" class="btn-primary" id="qtyPickerDone">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Jobs list -->
  <div id="jobsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="jobsModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M16 6V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>
              <rect x="2" y="6" width="20" height="14" rx="2"></rect>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="jobsModalTitle" class="modal-title">Jobs</h2>
            <div class="modal-subtitle">Track commitments and inventory reservations.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="jobsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Job List</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn-primary btn-with-icon" id="btnJobsCreate" type="button">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
              <span>New Job</span>
            </button>
            <button class="btn-secondary" id="btnJobsRefresh" type="button">Refresh</button>
          </div>
          <div id="jobsList" aria-live="polite"></div>
          <div id="jobsMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnJobsClose" type="button" data-modal-close="jobsModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="jobsModal">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Job editor -->
  <div id="jobEditorModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="jobEditorTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="4" width="18" height="18" rx="2"></rect>
              <path d="M9 2h6v4H9z"></path>
              <line x1="8" y1="11" x2="16" y2="11"></line>
              <line x1="8" y1="15" x2="16" y2="15"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="jobEditorTitle" class="modal-title">Job</h2>
            <div class="modal-subtitle" id="jobEditorSub">Review and manage your bill of materials.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="jobEditorModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Job Details</div>
          <div class="job-form-grid">
            <div class="job-field">
              <label for="jobNameInput">Name</label>
              <input id="jobNameInput" type="text" placeholder="Job name" />
            </div>
            <div class="job-field">
              <label>Status</label>
              <div id="jobStatusPill" class="job-status job-status--draft">Draft</div>
              <div id="jobCreatedMeta" class="job-meta"></div>
            </div>
          </div>
          <div class="job-field" style="margin-top:10px;">
            <label for="jobNotesInput">Notes</label>
            <textarea id="jobNotesInput" placeholder="Optional notes"></textarea>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px;">
            <button class="btn-secondary" id="btnJobSave" type="button">Save</button>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Planned BOM</div>
          <div class="muted">Add items from the Inventory list using â€œAdd to Jobâ€.</div>
          <div id="jobBomTable"></div>
          <div id="jobBomMsg" class="muted" style="margin-top:8px;"></div>
        </div>
        <div class="form-section" id="jobApprovalSection">
          <div class="section-label">Approval</div>
          <div class="muted">Approving a job reserves inventory.</div>
          <div id="jobApprovalWarnings" class="job-warning" style="display:none;"></div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px;">
            <button class="btn-secondary" id="btnJobApprove" type="button">Approve Job</button>
          </div>
        </div>
        <div class="form-section" id="jobCompletionSection">
          <div class="section-label">Completion</div>
          <div class="muted">Actuals consume inventory and release reservations.</div>
          <div id="jobActualsTable"></div>
          <div id="jobCompleteMsg" class="muted" style="margin-top:8px;"></div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px;">
            <button class="btn-secondary" id="btnJobComplete" type="button">Complete Job</button>
          </div>
        </div>
        <div class="form-section" id="jobVoidSection">
          <div class="section-label">Void</div>
          <div class="muted">Voiding releases reservations and reverses consumption if needed.</div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px;">
            <button class="btn-secondary btn-danger" id="btnJobVoid" type="button">Void Job</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <div id="jobEditorMsg" class="muted"></div>
        </div>
        <div class="footer-right">
          <button class="btn-secondary" id="btnJobEditorClose" type="button" data-modal-close="jobEditorModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="jobEditorModal">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add to Job modal -->
  <div id="addToJobModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="addToJobTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="2" y="7" width="20" height="14" rx="2"></rect>
              <path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>
              <line x1="12" y1="12" x2="12" y2="16"></line>
              <line x1="10" y1="14" x2="14" y2="14"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="addToJobTitle" class="modal-title">Add to Job</h2>
            <div class="modal-subtitle">Choose a job and planned quantity.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="addToJobModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Details</div>
          <label>Item</label>
          <div id="addToJobItemName" class="add-job-item"></div>
          <label for="addToJobSelect">Job</label>
          <select id="addToJobSelect"></select>
          <div id="addToJobNewWrap" style="display:none;">
            <label for="addToJobNewName">Job name</label>
            <input id="addToJobNewName" type="text" placeholder="New job name" />
          </div>
          <label for="addToJobQty">Quantity</label>
          <div class="qty-stepper qty-stepper--modal">
            <button class="qty-step" id="addToJobQtyMinus" type="button" aria-label="Decrease qty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
            <input id="addToJobQty" type="number" min="1" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" />
            <button class="qty-step" id="addToJobQtyPlus" type="button" aria-label="Increase qty">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
              </svg>
            </button>
          </div>
          <div id="addToJobMsg" class="muted"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnAddToJobCancel" type="button" data-modal-close="addToJobModal">Cancel</button>
          <button class="btn-primary" id="btnAddToJobConfirm" type="button">Add to Job</button>
        </div>
      </div>
    </div>
  </div>

		  <!-- Order history -->
		  <div id="orderHistoryModal" class="modal-backdrop" aria-hidden="true">
		    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="orderHistoryTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M3 3v5h5"></path>
                  <path d="M3 8a9 9 0 1 0 3-6.7L3 3"></path>
                  <path d="M12 7v5l3 3"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="orderHistoryTitle" class="modal-title">Purchase Orders</h2>
                <div class="modal-subtitle">View submitted orders and receipts.</div>
              </div>
            </div>
            <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="orderHistoryModal" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-section">
              <div class="section-label">Purchase Orders</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                <button class="icon-btn icon-btn--default" id="btnOrderHistoryDownload" type="button" title="Download CSV" aria-label="Download order history CSV">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                </button>
                <button class="btn-secondary" id="btnOrderHistoryRefresh" type="button">Refresh</button>
              </div>
              <label for="orderHistoryFilter" style="margin-top:10px;">Filter orders</label>
              <div class="input-wrap" style="max-width:100%;">
                <input id="orderHistoryFilter" type="text" placeholder="Filter purchase ordersâ€¦" autocomplete="off" />
                <button class="icon-btn icon-btn--default clear-input-btn" id="btnClearOrderHistoryFilter" type="button" aria-label="Clear history filter" title="Clear filter" style="display:none">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M18 6L6 18"></path>
                    <path d="M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
              <div id="orderHistoryList" class="history-list" aria-live="polite"></div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="footer-right">
              <button class="btn-secondary" id="btnOrderHistoryClose" type="button" data-modal-close="orderHistoryModal">Cancel</button>
              <button class="btn-primary" type="button" data-modal-close="orderHistoryModal">Done</button>
            </div>
          </div>
		    </div>
		  </div>

      <!-- Receive order -->
      <div id="receiveOrderModal" class="modal-backdrop" aria-hidden="true">
        <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="receiveOrderTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M21 16V8a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v8"></path>
                  <path d="M3 10h18"></path>
                  <path d="M8 14h8"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="receiveOrderTitle" class="modal-title">Receive Order</h2>
                <div class="modal-subtitle">Inventory is updated only when the receipt is completed.</div>
              </div>
            </div>
            <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="receiveOrderModal" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-section">
              <div class="section-label">Summary</div>
              <div id="receiveOrderMeta" class="receive-order-meta"></div>
              <div id="receiveOrderSummary" class="receive-summary"></div>
            </div>
            <div class="form-section">
              <div class="section-label">Lines</div>
              <div id="receiveOrderLines" class="receive-lines" aria-live="polite"></div>
              <div id="receiveOrderWarning" class="receive-order-warning" role="status"></div>
            </div>
            <div class="form-section">
              <div class="section-label">Receipts</div>
              <div id="receiveOrderReceipts" class="receive-receipts"></div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="footer-left">
              <div id="receiveOrderMsg" class="muted"></div>
              <button class="btn-secondary" id="btnReceiveOrderSave" type="button">Save Draft</button>
            </div>
            <div class="footer-right">
              <button class="btn-secondary" id="btnReceiveOrderCancel" type="button" data-modal-close="receiveOrderModal">Cancel</button>
              <button class="btn-primary" id="btnReceiveOrderComplete" type="button">Complete Receipt</button>
            </div>
          </div>
        </div>
      </div>

		  <!-- Trash -->
		  <div id="trashModal" class="modal-backdrop" aria-hidden="true">
		    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="trashModalTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>
                  <path d="M10 11v6"></path>
                  <path d="M14 11v6"></path>
                  <path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="trashModalTitle" class="modal-title">Trash</h2>
                <div class="modal-subtitle">Restore or permanently remove deleted items.</div>
              </div>
            </div>
            <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="trashModal" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-section">
              <div class="section-label">Deleted Items</div>
              <div class="trash-controls">
                <input id="trashFilter" type="text" placeholder="Filter deleted itemsâ€¦" autocomplete="off" />
                <button class="btn-secondary" id="btnTrashReload" type="button">Refresh</button>
              </div>
              <div id="trashList" class="trash-list" aria-live="polite"></div>
              <div id="trashMsg" class="muted" style="margin-top:8px;"></div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="footer-right">
              <button class="btn-secondary" id="btnTrashClose" type="button" data-modal-close="trashModal">Cancel</button>
              <button class="btn-primary" type="button" data-modal-close="trashModal">Done</button>
            </div>
          </div>
		    </div>
		  </div>

		  <!-- Inventory report -->
		  <div id="reportModal" class="modal-backdrop" aria-hidden="true">
		    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="reportModalTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <path d="M3 3v18h18"></path>
                  <path d="M18 17V9"></path>
                  <path d="M13 17V5"></path>
                  <path d="M8 17v-3"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="reportModalTitle" class="modal-title">Inventory Report</h2>
                <div class="modal-subtitle">Review low stock and inventory status.</div>
              </div>
            </div>
            <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="reportModal" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-section">
              <div class="section-label">Report</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
                <button class="icon-btn icon-btn--default" id="btnReportShare" type="button" title="Share report" aria-label="Share report">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"></path>
                    <polyline points="16 6 12 2 8 6"></polyline>
                    <line x1="12" y1="2" x2="12" y2="15"></line>
                  </svg>
                </button>
                <button class="icon-btn icon-btn--default" id="btnReportDownload" type="button" title="Download CSV" aria-label="Download report CSV">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                </button>
              </div>

			      <div class="report-progress" id="reportProgress" style="display:none;" aria-live="polite">
			        <div class="report-progress-label">
			          <span id="reportProgressLabel">Analyzing Low Stock Items...</span>
			          <span class="report-progress-value" id="reportProgressValue">0%</span>
			        </div>
			        <div class="report-progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
			          <div class="report-progress-bar" id="reportProgressBar" style="width:0%"></div>
			        </div>
			      </div>

			      <div id="reportContent" style="display:none;">
				      <div class="report-metrics" aria-label="Report summary">
				        <div class="report-metric"><div class="muted">Total Items</div><div class="val" id="reportMetricTotalItems">0</div></div>
				        <div class="report-metric"><div class="muted">Total Qty</div><div class="val" id="reportMetricTotalQty">0</div></div>
				      </div>

				      <div class="order-pill-container report-pill-container" id="reportOrderPillContainer" style="display:none;">
				        <button class="order-pill" id="reportOrderBadge" data-order-reset role="status" aria-live="polite" aria-label="Clear shopping cart selections">
				          <span class="order-pill-value" id="reportOrderCount">0</span>
				          <span class="order-pill-label">Items in Cart</span>
				          <span class="order-pill-hint">tap to clear</span>
				        </button>
				      </div>
		
					      <details class="report-section" id="reportLowStockSection">
					        <summary class="report-summary">
					          <div class="report-summary-left">
					            <h3><span class="led-dot led-dot--amber"></span>Low Stock Items <span class="report-count" id="reportLowStockCount">(0)</span></h3>
					          </div>
					          <div class="report-summary-right">
					            <button type="button" class="icon-btn icon-btn--success" id="btnReportBatchOrder" title="Add all low stock items to cart" aria-label="Add all low stock items to shopping cart">
					              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.4" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					                <circle cx="9" cy="21" r="1"></circle>
					                <circle cx="20" cy="21" r="1"></circle>
					                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
					                <path d="M16 3v6"></path>
					                <path d="M13 6h6"></path>
					              </svg>
					            </button>
					            <span class="report-chevron" aria-hidden="true">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                          <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                      </span>
					          </div>
					        </summary>
					        <div class="report-list" id="reportLowStockList"></div>
				      </details>

				      <details class="report-section" id="reportExemptSection">
				        <summary class="report-summary">
				          <div class="report-summary-left">
				            <h3><span class="led-dot led-dot--cyan"></span>Exempt from Batch Re-order <span class="report-count" id="reportExemptCount">(0)</span></h3>
				          </div>
				          <div class="report-summary-right">
				            <span class="report-chevron" aria-hidden="true">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                      </svg>
                    </span>
				          </div>
				        </summary>
				        <div class="report-list" id="reportExemptList"></div>
				      </details>

				      <details class="report-section" id="reportInventorySection">
				        <summary class="report-summary">
				          <div class="report-summary-left">
				            <h3>Current Inventory <span class="report-count" id="reportInStockCount">(0)</span></h3>
				          </div>
				          <div class="report-summary-right">
				            <span class="report-chevron" aria-hidden="true">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                      </svg>
                    </span>
				          </div>
				        </summary>
				        <div class="report-list" id="reportList" aria-live="polite"></div>
				      </details>
			      </div>
			    </div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnReportClose" type="button" data-modal-close="reportModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="reportModal">Done</button>
        </div>
      </div>
    </div>
  </div>

		  <!-- Email inventory report -->
		  <div id="reportEmailModal" class="modal-backdrop" aria-hidden="true">
		    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="reportEmailTitle">
          <div class="modal-header">
            <div class="modal-title-wrap">
              <span class="modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                  <path d="m22 7-8.97 5.7a1 1 0 0 1-1.06 0L2 7"></path>
                </svg>
              </span>
              <div class="modal-title-text">
                <h2 id="reportEmailTitle" class="modal-title">Email Inventory Report</h2>
                <div class="modal-subtitle">Send the report to a recipient.</div>
              </div>
            </div>
            <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="reportEmailModal" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-section">
              <div class="section-label">Message</div>
              <label for="reportEmailTo">To</label>
              <input id="reportEmailTo" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />
              <label for="reportEmailSubject">Subject</label>
              <input id="reportEmailSubject" type="text" placeholder="Inventory Report" />
            </div>
            <div class="form-section">
              <div class="section-label">Preview</div>
              <div class="order-preview">
                <div id="reportEmailPreview" class="order-preview-html"></div>
              </div>
              <div id="reportEmailMsg" class="muted"></div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="footer-left">
              <button class="btn-secondary" id="btnReportEmailCopy" type="button">Copy</button>
            </div>
            <div class="footer-right">
              <button class="btn-secondary" id="btnReportEmailClose" type="button" data-modal-close="reportEmailModal">Cancel</button>
              <button class="btn-primary" id="btnReportEmailSend" type="button">Send</button>
            </div>
          </div>
		    </div>
		  </div>

  <!-- Auth modal -->
  <div id="authModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="authModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="11" width="18" height="11" rx="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="authModalTitle" class="modal-title">Sign In</h2>
            <div class="modal-subtitle">Invite-only access. Contact your admin for an account.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="authModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label for="authEmail">Email</label>
          <input id="authEmail" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email" />
          <label for="authPassword" id="authPasswordLabel">Password</label>
          <input id="authPassword" type="password" placeholder="Password" autocomplete="current-password" />
          <div class="auth-actions">
            <button class="auth-link" id="btnAuthForgot" type="button">Forgot password?</button>
          </div>
          <div id="authMsg" class="muted"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" type="button" data-modal-close="authModal">Cancel</button>
          <button class="btn-primary" id="btnAuthSubmit" type="button">Sign In</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite accept modal -->
  <div id="inviteAcceptModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="inviteAcceptTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 17v-6"></path>
              <path d="M9 14h6"></path>
              <circle cx="12" cy="12" r="10"></circle>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="inviteAcceptTitle" class="modal-title">Set Your Password</h2>
            <div class="modal-subtitle">Create a password to activate your invited account.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="inviteAcceptModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label for="inviteAcceptPassword">New Password</label>
          <input id="inviteAcceptPassword" type="password" placeholder="New password" autocomplete="new-password" />
          <label for="inviteAcceptPasswordConfirm">Confirm Password</label>
          <input id="inviteAcceptPasswordConfirm" type="password" placeholder="Confirm password" autocomplete="new-password" />
          <div class="auth-actions">
            <button class="auth-link" id="btnInviteAcceptSignIn" type="button">Already have an account? Sign in</button>
          </div>
          <div id="inviteAcceptMsg" class="muted"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnInviteAcceptClose" type="button" data-modal-close="inviteAcceptModal">Cancel</button>
          <button class="btn-primary" id="btnInviteAcceptSubmit" type="button">Create Account</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Password reset modal -->
  <div id="resetModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="resetModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 12a9 9 0 1 0 9-9"></path>
              <path d="M3 4v4h4"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="resetModalTitle" class="modal-title">Reset Password</h2>
            <div class="modal-subtitle">Create a new password for your account.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="resetModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <label for="resetPassword">New Password</label>
          <input id="resetPassword" type="password" placeholder="New password" autocomplete="new-password" />
          <label for="resetPasswordConfirm">Confirm Password</label>
          <input id="resetPasswordConfirm" type="password" placeholder="Confirm password" autocomplete="new-password" />
          <div id="resetMsg" class="muted"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnResetClose" type="button" data-modal-close="resetModal">Cancel</button>
          <button class="btn-primary" id="btnResetSubmit" type="button">Update Password</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Invite modal -->
  <div id="inviteModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="inviteModalTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="8.5" cy="7" r="4"></circle>
              <line x1="20" y1="8" x2="20" y2="14"></line>
              <line x1="17" y1="11" x2="23" y2="11"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="inviteModalTitle" class="modal-title">Invite User</h2>
            <div class="modal-subtitle">Send an invite to a new team member.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="inviteModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section" id="inviteSection">
          <div class="section-label">Invite Details</div>
          <div class="invite-grid">
            <div id="inviteCompanyRow">
              <label for="inviteCompany">Company</label>
              <select id="inviteCompany" aria-label="Invite company"></select>
            </div>
            <div>
              <label for="inviteEmail">Email</label>
              <input id="inviteEmail" type="email" placeholder="newuser@example.com" autocomplete="email" inputmode="email" />
            </div>
            <div>
              <label for="inviteRole">Role</label>
              <select id="inviteRole">
                <option value="member">Member</option>
                <option value="admin">Admin</option>
                <option value="viewer">Viewer</option>
              </select>
            </div>
          </div>
          <div class="invite-link-row" id="inviteLinkRow">
            <input id="inviteLink" type="text" readonly />
            <button class="btn-secondary" id="btnInviteCopy" type="button">Copy</button>
          </div>
          <div id="inviteMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnInviteClose" type="button" data-modal-close="inviteModal">Cancel</button>
          <button class="btn-primary" id="btnInviteSend" type="button">Send Invite</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User management modal -->
  <div id="userMgmtModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="userMgmtTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="8.5" cy="7" r="4"></circle>
              <line x1="20" y1="8" x2="20" y2="14"></line>
              <line x1="17" y1="11" x2="23" y2="11"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="userMgmtTitle" class="modal-title">Manage Users</h2>
            <div class="modal-subtitle">Invite and manage access across companies.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="userMgmtModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Users</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn-secondary" id="btnUserMgmtAdd" type="button">
              <svg class="user-mgmt-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>
              Add User
            </button>
            <button class="btn-secondary" id="btnUserMgmtRefresh" type="button">Refresh</button>
          </div>
          <div class="user-mgmt-controls" id="userMgmtControls">
            <div>
              <label for="userMgmtCompany">Company</label>
              <select id="userMgmtCompany" aria-label="Manage users company"></select>
            </div>
          </div>
          <div id="userMgmtList" class="user-mgmt-list" aria-live="polite"></div>
          <div id="pendingInvitesMount">
            <div id="pendingInvitesSection" class="pending-invites-section">
              <div class="section-divider"></div>
              <div class="pending-invites-header">
                <h3>Pending Invites</h3>
                <button class="btn-tertiary btn-sm" id="btnPendingInvitesRefresh" type="button">Refresh Invites</button>
              </div>
              <div id="pendingInvitesList" class="pending-invites-list" aria-live="polite"></div>
              <div id="pendingInvitesMsg" class="muted" style="margin-top:8px;"></div>
            </div>
          </div>
          <div id="userMgmtMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnUserMgmtClose" type="button" data-modal-close="userMgmtModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="userMgmtModal">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Role manager modal -->
  <div id="roleManagerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="roleManagerTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 2l7 4v6c0 5-3.5 9.7-7 10-3.5-.3-7-5-7-10V6l7-4z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="roleManagerTitle" class="modal-title">Role Manager</h2>
            <div class="modal-subtitle">Configure role permissions. Super user permissions are fixed.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="roleManagerModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Permissions</div>
          <div class="role-manager-table-wrap">
            <table class="role-manager-table">
              <thead>
                <tr>
                  <th>Permission</th>
                  <th>Admin</th>
                  <th>Member</th>
                  <th>Viewer</th>
                </tr>
              </thead>
              <tbody id="roleManagerBody"></tbody>
            </table>
          </div>
          <div id="roleManagerMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnRoleManagerClose" type="button" data-modal-close="roleManagerModal">Cancel</button>
          <button class="btn-primary" id="btnRoleManagerSave" type="button">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Role requests modal -->
  <div id="roleRequestsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="roleRequestsTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 2l7 4v6c0 5-3.5 9.7-7 10-3.5-.3-7-5-7-10V6l7-4z"></path>
              <path d="M9 12l2 2 4-4"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="roleRequestsTitle" class="modal-title">Role Requests</h2>
            <div class="modal-subtitle">Review and approve role change requests.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="roleRequestsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Requests</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
            <button class="btn-secondary" id="btnRoleRequestsRefresh" type="button">Refresh</button>
          </div>
          <div id="roleRequestsList" class="role-requests-list" aria-live="polite"></div>
          <div id="roleRequestsMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnRoleRequestsClose" type="button" data-modal-close="roleRequestsModal">Cancel</button>
          <button class="btn-primary" type="button" data-modal-close="roleRequestsModal">Done</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Audit log modal -->
  <div id="auditModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="auditTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="auditTitle" class="modal-title">Audit Log</h2>
            <div class="modal-subtitle">Review recent system activity and data changes.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="auditModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Filters</div>
          <div class="audit-filters">
            <input id="auditSearchFilter" type="text" placeholder="Filter audit logâ€¦" autocomplete="off" />
            <select id="auditTableFilter">
              <option value="">All tables</option>
              <option value="inventory_items">Inventory Items</option>
              <option value="orders">Orders</option>
              <option value="company_members">Company Members</option>
              <option value="invitations">Invitations</option>
              <option value="role_change_requests">Role Requests</option>
            </select>
            <select id="auditActionFilter">
              <option value="">All actions</option>
              <option value="INSERT">INSERT</option>
              <option value="UPDATE">UPDATE</option>
              <option value="DELETE">DELETE</option>
              <option value="RESTORE">RESTORE</option>
              <option value="BULK_DELETE">BULK_DELETE</option>
            </select>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Entries</div>
          <div id="auditList" class="audit-list" aria-live="polite"></div>
          <div id="auditMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <button class="btn-tertiary" id="btnAuditDownload" type="button" title="Download audit log CSV">Download CSV</button>
        </div>
        <div class="footer-right">
          <button class="btn-secondary" id="btnAuditRefresh" type="button">Refresh</button>
          <button class="btn-secondary" id="btnAuditClose" type="button" data-modal-close="auditModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Snapshots modal -->
  <div id="snapshotsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="snapshotsTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
              <path d="M3 5v14c0 1.7 4 3 9 3s9-1.3 9-3V5"></path>
              <path d="M3 12c0 1.7 4 3 9 3s9-1.3 9-3"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="snapshotsTitle" class="modal-title">Inventory Snapshots</h2>
            <div class="modal-subtitle">Browse point-in-time inventory captures.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="snapshotsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Snapshots</div>
          <div id="snapshotsList" class="snapshots-list" aria-live="polite"></div>
          <div id="snapshotPreview" class="snapshot-preview" style="display:none;">
            <div class="snapshot-preview-header">
              <button class="btn-tertiary btn-sm" id="btnSnapshotBack" type="button">Back</button>
              <div class="snapshot-preview-title" id="snapshotPreviewTitle"></div>
            </div>
            <div class="snapshot-preview-meta" id="snapshotPreviewMeta"></div>
            <div class="snapshot-preview-table scroll">
              <table class="metrics-table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>SKU</th>
                    <th>Qty</th>
                    <th>Category ID</th>
                    <th>Location ID</th>
                  </tr>
                </thead>
                <tbody id="snapshotPreviewBody"></tbody>
              </table>
            </div>
          </div>
          <div id="snapshotsMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnSnapshotsClose" type="button" data-modal-close="snapshotsModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Metrics modal -->
  <div id="metricsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="metricsTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="metricsTitle" class="modal-title">Metrics Dashboard</h2>
            <div class="modal-subtitle">Track inventory activity and operational trends.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="metricsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Filters</div>
          <div class="metrics-toolbar">
            <select id="metricsRange" aria-label="Metrics date range">
              <option value="7">Last 7 days</option>
              <option value="30" selected>Last 30 days</option>
              <option value="90">Last 90 days</option>
            </select>
            <select id="metricsView" aria-label="Metrics view" style="display:none;">
              <option value="company">Company View</option>
              <option value="platform">Platform View</option>
            </select>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Dashboard</div>
          <div id="metricsContent" class="metrics-content" aria-live="polite"></div>
          <div id="metricsMsg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnMetricsClose" type="button" data-modal-close="metricsModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="profileTitle" class="modal-title">Account</h2>
            <div class="modal-subtitle">Update your profile and notification preferences.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="profileModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Profile</div>
          <div class="muted" id="profileEmailDisplay"></div>
          <div class="edit-grid-2">
            <div>
              <label for="profileFirstName">First Name</label>
              <input id="profileFirstName" type="text" placeholder="First" autocomplete="given-name" />
            </div>
            <div>
              <label for="profileLastName">Last Name</label>
              <input id="profileLastName" type="text" placeholder="Last" autocomplete="family-name" />
            </div>
          </div>
          <div>
            <label for="profilePhone">Phone</label>
            <input id="profilePhone" type="tel" placeholder="(555) 555-5555" autocomplete="tel" inputmode="tel" />
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Preferences</div>
          <div>
            <label for="profileLowStockQtyGlobal">Global Low Stock Qty</label>
            <input id="profileLowStockQtyGlobal" type="number" min="0" step="1" inputmode="numeric" placeholder="0" />
          </div>
          <div style="display:flex;align-items:center;gap:12px;margin-top:6px;">
            <label class="toggle-switch">
              <input id="profileSilenceLowStockAlerts" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
            <label for="profileSilenceLowStockAlerts" class="muted" style="font-size:13px;cursor:pointer;">Hide low stock LED indicators</label>
          </div>
        </div>
        <div class="form-section" id="roleRequestSection">
          <div class="section-label">Role Change</div>
          <div class="role-request-meta" id="roleRequestCurrent"></div>
          <label for="roleRequestRole">New Role</label>
          <select id="roleRequestRole"></select>
          <label for="roleRequestReason">Reason (optional)</label>
          <textarea id="roleRequestReason" rows="2" placeholder="Why do you need this role?"></textarea>
          <div class="role-request-actions">
            <button class="btn-secondary" id="btnRoleRequest" type="button">Submit Request</button>
          </div>
          <div id="roleRequestMsg" class="muted" style="margin-top:4px;"></div>
        </div>
        <div id="profileMsg" class="muted" style="margin-top:10px;"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-left">
          <button class="btn-secondary" id="btnSignOut" type="button">Sign Out</button>
        </div>
        <div class="footer-right">
          <button class="btn-secondary" id="btnProfileClose" type="button" data-modal-close="profileModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Subscription Manager modal -->
  <div id="subscriptionManagerModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md" role="dialog" aria-modal="true" aria-labelledby="subscriptionManagerTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="2" y="5" width="20" height="14" rx="2"></rect>
              <line x1="2" y1="10" x2="22" y2="10"></line>
              <line x1="7" y1="15" x2="7.01" y2="15"></line>
              <line x1="11" y1="15" x2="13" y2="15"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="subscriptionManagerTitle" class="modal-title">Subscription Manager</h2>
            <div class="modal-subtitle">Review and update company tier settings.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="subscriptionManagerModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section" id="tierOverrideSection">
          <div class="section-label">Subscription</div>
          <div class="role-request-meta" id="tierOverrideCompany"></div>
          <div class="tier-admin-grid">
            <div class="tier-admin-stat">
              <div class="tier-admin-label">Base Tier</div>
              <div class="tier-admin-value" id="tierBaseValue">â€”</div>
            </div>
            <div class="tier-admin-stat">
              <div class="tier-admin-label">Active Override</div>
              <div class="tier-admin-value" id="tierOverrideValue">â€”</div>
            </div>
            <div class="tier-admin-stat">
              <div class="tier-admin-label">Effective Tier</div>
              <div class="tier-admin-value" id="tierEffectiveValue">â€”</div>
            </div>
            <div class="tier-admin-stat">
              <div class="tier-admin-label">Override Expires</div>
              <div class="tier-admin-value" id="tierOverrideExpiresValue">â€”</div>
            </div>
          </div>
        </div>
        <div class="section-divider" id="tierOverrideDivider"></div>
        <div class="form-section">
          <div class="section-label">Base Tier</div>
          <label for="tierBaseSelect">Change Base Subscription</label>
          <select id="tierBaseSelect" aria-label="Select base subscription tier"></select>
          <div class="tier-admin-actions">
            <button class="btn-secondary" id="btnTierBaseSave" type="button">Save Base Tier</button>
          </div>
        </div>
        <div class="form-section">
          <div class="section-label">Temporary Access</div>
          <label for="tierOverrideTierSelect">Grant Temporary Access</label>
          <select id="tierOverrideTierSelect" aria-label="Select override tier"></select>
          <label for="tierOverrideEndsAt">Access Ends At (optional)</label>
          <input id="tierOverrideEndsAt" type="datetime-local" />
          <div class="tier-admin-actions">
            <button class="btn-secondary" id="btnTierOverrideGrant" type="button">Grant Temporary Access</button>
            <button class="btn-secondary" id="btnTierOverrideRevoke" type="button">Revoke Override</button>
          </div>
          <div id="tierOverrideMsg" class="muted" style="margin-top:4px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnSubscriptionManagerClose" type="button" data-modal-close="subscriptionManagerModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage companies (super user only) -->
  <div id="advancedCompanyModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--md manage-companies-modal" role="dialog" aria-modal="true" aria-labelledby="advancedCompanyTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M3 21h18"></path>
              <path d="M5 21V7l7-4 7 4v14"></path>
              <path d="M9 21V9h6v12"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="advancedCompanyTitle" class="modal-title">Manage Companies</h2>
            <div class="modal-subtitle">Switching here is temporary and does not change the user's default company.</div>
            <div class="manage-companies-header-meta">
              <span class="manage-companies-badge">Super User</span>
            </div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="advancedCompanyModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section filters-section">
          <div class="section-label">Filters</div>
          <div class="manage-companies-filters advanced-switcher-controls">
            <div class="field">
              <label for="advancedCompanySearch">Search</label>
              <input id="advancedCompanySearch" type="text" placeholder="Company name or exact company ID" />
            </div>
            <div class="field">
              <label for="advancedCompanyTypeFilter">Environment</label>
              <select id="advancedCompanyTypeFilter">
                <option value="production" selected>Production</option>
                <option value="sandbox">Development</option>
                <option value="test">Test</option>
                <option value="system">System</option>
                <option value="">All</option>
              </select>
            </div>
          </div>
          <div class="manage-companies-actions advanced-switcher-actions">
            <button class="btn-primary" id="advancedCompanySearchBtn" type="button">Search</button>
            <button class="btn-secondary" id="advancedCompanyProvisionBtn" type="button">New Company</button>
            <button class="btn-secondary btn-outline-success" id="advancedCompanyReturnBtn" type="button">Return to Production</button>
          </div>
        </div>
        <div class="form-section results-section">
          <div class="section-label">Results</div>
          <div id="advancedCompanyResults" class="manage-companies-results advanced-switcher-results"></div>
          <div id="advancedCompanyMsg" class="manage-companies-hint advanced-switcher-hint"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="advancedCompanyClose" type="button" data-modal-close="advancedCompanyModal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Inventory seeding (super user only) -->
  <div id="seedInventoryModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="seedInventoryTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <path d="M3.27 6.96 12 12.01l8.73-5.05"></path>
              <path d="M12 22.08V12"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="seedInventoryTitle" class="modal-title">Seed Inventory</h2>
            <div class="modal-subtitle">Copy items from another company into this workspace.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="seedInventoryModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Target</div>
          <label>Company</label>
          <div id="seedInventoryTargetName" class="add-job-item"></div>
          <div id="seedInventoryTargetId" class="advanced-switcher-id"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Source</div>
          <label for="seedInventorySource">Source company</label>
          <select id="seedInventorySource"></select>
          <label for="seedInventoryDedupe">Dedupe key</label>
          <select id="seedInventoryDedupe">
            <option value="sku" selected>SKU</option>
            <option value="name">Name</option>
          </select>
          <div class="muted">Seeding runs once per target company. Items are copied without quantities.</div>
          <div id="seedInventoryMsg" class="muted" style="margin-top:6px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnSeedInventoryCancel" type="button" data-modal-close="seedInventoryModal">Cancel</button>
          <button class="btn-primary" id="btnSeedInventoryConfirm" type="button">Seed Inventory</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Company environment (super user only) -->
  <div id="companyEnvironmentModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--sm" role="dialog" aria-modal="true" aria-labelledby="companyEnvironmentTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <path d="M12 2l3 6 6 .9-4.5 4.3 1.1 6.3L12 16.8 6.4 19.5l1.1-6.3L3 8.9 9 8z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="companyEnvironmentTitle" class="modal-title">Set Environment</h2>
            <div class="modal-subtitle">Test enables destructive actions. Production blocks them.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="companyEnvironmentModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Target</div>
          <label>Company</label>
          <div id="companyEnvironmentTargetName" class="add-job-item"></div>
          <div id="companyEnvironmentTargetId" class="advanced-switcher-id"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Environment</div>
          <label for="companyEnvironmentSelect">Set environment</label>
          <select id="companyEnvironmentSelect">
            <option value="production">Production</option>
            <option value="test">Test</option>
          </select>
          <div id="companyEnvironmentNote" class="muted" style="margin-top:6px;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnCompanyEnvironmentCancel" type="button" data-modal-close="companyEnvironmentModal">Cancel</button>
          <button class="btn-primary" id="btnCompanyEnvironmentConfirm" type="button">Save Environment</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Company provisioning dashboard (super user only) -->
  <div id="provisioningModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="provisioningTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="provisioningTitle" class="modal-title">Company Provisioning</h2>
            <div class="modal-subtitle">Super-user only. Each step is explicit and recorded server-side.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="provisioningModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Company Creation</div>
          <div class="provisioning-grid">
            <div>
              <label for="provisioningCompanyName">Company Name</label>
              <input id="provisioningCompanyName" type="text" placeholder="New Company" />
            </div>
            <div>
              <label for="provisioningCompanySlug">Slug</label>
              <input id="provisioningCompanySlug" type="text" placeholder="new-company" />
              <div class="provisioning-note">Auto-generated from name; edit if needed.</div>
            </div>
            <div>
              <label for="provisioningOnboardingState">Onboarding State</label>
              <input id="provisioningOnboardingState" type="text" value="UNINITIALIZED" readonly />
              <div class="provisioning-note">Set automatically for new companies.</div>
            </div>
            <div>
              <div class="provisioning-field-toggle" style="margin-top:18px;">
                <label class="toggle-switch">
                  <input id="provisioningIncludeActor" type="checkbox" checked />
                  <span class="toggle-slider"></span>
                </label>
                <label for="provisioningIncludeActor" class="muted" style="font-size:13px;cursor:pointer;">Add me as admin</label>
              </div>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-label">Initial User Assignment (optional)</div>
          <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap;">
            <div class="provisioning-note" style="margin-top:0;">Attach existing users and assign roles.</div>
            <button class="btn-tertiary btn-sm" id="btnProvisioningAddUser" type="button">Add User</button>
          </div>
          <div id="provisioningUsersList" aria-live="polite"></div>
          <div class="provisioning-warning">Cross-company memberships are allowed for test or super_user accounts.</div>
        </div>

        <div class="form-section">
          <div class="section-label">Subscription Tier (optional)</div>
          <div class="provisioning-grid">
            <div>
              <label for="provisioningTierOverride">Subscription Tier Override</label>
              <select id="provisioningTierOverride">
                <option value="" selected>No override (starter)</option>
                <option value="starter">starter</option>
                <option value="professional">professional</option>
                <option value="business">business</option>
                <option value="enterprise">enterprise</option>
              </select>
              <div class="provisioning-note">Overrides effective tier; base remains starter.</div>
            </div>
            <div>
              <label for="provisioningTierEndsAt">Override Ends At (optional)</label>
              <input id="provisioningTierEndsAt" type="datetime-local" />
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-label">Inventory Seeding (optional)</div>
          <div style="display:flex;align-items:center;gap:8px;justify-content:space-between;flex-wrap:wrap;">
            <div class="provisioning-note" style="margin-top:0;">Seed inventory from an existing company (explicit and auditable).</div>
            <button class="btn-tertiary btn-sm" id="btnProvisioningRefreshCompanies" type="button">Refresh Companies</button>
          </div>
          <div class="provisioning-field-toggle" style="margin-top:8px;">
            <label class="toggle-switch">
              <input id="provisioningSeedToggle" type="checkbox" />
              <span class="toggle-slider"></span>
            </label>
            <label for="provisioningSeedToggle" class="muted" style="font-size:13px;cursor:pointer;">Seed inventory from existing company</label>
          </div>
          <div id="provisioningSeedFields" style="display:none;">
            <div class="provisioning-grid">
              <div>
                <label for="provisioningSeedSource">Source Company</label>
                <select id="provisioningSeedSource"></select>
              </div>
              <div>
                <label for="provisioningSeedDedupe">Dedupe Key</label>
                <select id="provisioningSeedDedupe">
                  <option value="sku" selected>sku</option>
                  <option value="name">name</option>
                </select>
              </div>
              <div>
                <label for="provisioningSeedMode">Mode</label>
                <input id="provisioningSeedMode" type="text" value="items_only" readonly />
              </div>
            </div>
            <div class="provisioning-warning">Warning: Seeding copies item definitions across companies. This action is explicit and auditable.</div>
          </div>
        </div>

        <div class="form-section">
          <div class="section-label">Finalize</div>
          <div style="display:flex;justify-content:flex-end;">
            <button class="btn-tertiary btn-sm" id="btnProvisioningReset" type="button">Reset Form</button>
          </div>
          <div id="provisioningSummary" class="provisioning-summary" aria-live="polite"></div>
        </div>
        <div id="provisioningMsg" class="muted" style="margin-top:8px;"></div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="btnProvisioningClose" type="button" data-modal-close="provisioningModal">Close</button>
          <button class="btn-primary" id="btnProvisioningRun" type="button">Provision Company</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Diagnostics modal (super user only) -->
  <div id="diagnosticsModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal modal--lg" role="dialog" aria-modal="true" aria-labelledby="diagnosticsTitle">
      <div class="modal-header">
        <div class="modal-title-wrap">
          <span class="modal-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
          </span>
          <div class="modal-title-text">
            <h2 id="diagnosticsTitle" class="modal-title">Diagnostics</h2>
            <div class="modal-subtitle">Simulation and inspection only. No data writes.</div>
          </div>
        </div>
        <button class="icon-btn icon-btn--default modal-close" type="button" data-modal-close="diagnosticsModal" aria-label="Close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-section">
          <div class="section-label">Role & Tier Simulation</div>
          <div class="muted">Session-scoped only. Does not affect backend authorization.</div>
          <label for="diagRoleSelect">Simulated Role</label>
          <select id="diagRoleSelect">
            <option value="">Use current role</option>
            <option value="super_user">super_user</option>
            <option value="admin">admin</option>
            <option value="member">member</option>
            <option value="viewer">viewer</option>
          </select>
          <label for="diagTierSelect" style="margin-top:8px;">Simulated Subscription Tier</label>
          <select id="diagTierSelect">
            <option value="">Use current tier</option>
            <option value="starter">Starter</option>
            <option value="professional">Professional</option>
            <option value="business">Business</option>
            <option value="enterprise">Enterprise</option>
          </select>
          <div class="diag-actions">
            <button class="btn-secondary" id="diagApply" type="button">Apply Simulation</button>
            <button class="btn-secondary" id="diagReset" type="button">Reset Simulation</button>
          </div>
          <div id="diagSimMsg" class="muted"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Enforcement Inspection</div>
          <div id="diagChecks"></div>
        </div>
        <div class="form-section">
          <div class="section-label">Metric Preview (Read-Only)</div>
          <label for="diagMetricId">Metric ID</label>
          <input id="diagMetricId" type="text" placeholder="INVENTORY_TURNOVER" />
          <label for="diagMetricContext" style="margin-top:8px;">Time Context (JSON)</label>
          <textarea id="diagMetricContext" rows="3" placeholder='{"period_start":"2025-01-01","period_end":"2025-01-31"}'></textarea>
          <label for="diagMetricInputs" style="margin-top:8px;">Inputs (JSON)</label>
          <textarea id="diagMetricInputs" rows="4" placeholder='{"COGS":100000,"AverageInventory":50000}'></textarea>
          <div class="diag-actions">
            <div class="muted" id="diagMetricTierHint"></div>
            <button class="btn-secondary" id="diagMetricRun" type="button">Run Preview</button>
          </div>
          <pre id="diagMetricOutput" class="diag-output"></pre>
        </div>
      </div>
      <div class="modal-footer">
        <div class="footer-right">
          <button class="btn-secondary" id="diagClose" type="button" data-modal-close="diagnosticsModal">Close</button>
        </div>
      </div>
    </div>
  </div>

	  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script type="module" src="./src/utils.js"></script>

		  <script>
		    // UUID helper (works on older mobile browsers and non-HTTPS dev hosts)
		    let _nativeRandomUUID = null;
		    try{
		      if(typeof crypto !== 'undefined' && crypto && typeof crypto.randomUUID === 'function'){
		        const candidate = crypto.randomUUID.bind(crypto);
		        candidate(); // ensure it works (some browsers expose but throw on insecure contexts)
		        _nativeRandomUUID = candidate;
		      }
		    }catch(e){
		      _nativeRandomUUID = null;
		    }
		    function randomUUID(){
		      if(_nativeRandomUUID){
		        try{ return _nativeRandomUUID(); }catch(e){}
		      }
		      const cryptoObj = (typeof crypto !== 'undefined') ? crypto : null;
		      const bytes = new Uint8Array(16);
		      if(cryptoObj && typeof cryptoObj.getRandomValues === 'function'){
		        try{
		          cryptoObj.getRandomValues(bytes);
		        }catch(e){
		          for(let i=0;i<bytes.length;i++) bytes[i] = Math.floor(Math.random()*256);
		        }
		      }else{
		        for(let i=0;i<bytes.length;i++) bytes[i] = Math.floor(Math.random()*256);
		      }
		      // RFC4122 v4
		      bytes[6] = (bytes[6] & 0x0f) | 0x40;
		      bytes[8] = (bytes[8] & 0x3f) | 0x80;
		      const hex = Array.from(bytes, b => b.toString(16).padStart(2,'0'));
		      return `${hex[0]}${hex[1]}${hex[2]}${hex[3]}-${hex[4]}${hex[5]}-${hex[6]}${hex[7]}-${hex[8]}${hex[9]}-${hex[10]}${hex[11]}${hex[12]}${hex[13]}${hex[14]}${hex[15]}`;
		    }
		    if(!_nativeRandomUUID){
		      try{
		        const cryptoObj = (typeof crypto !== 'undefined') ? crypto : null;
		        if(cryptoObj) cryptoObj.randomUUID = randomUUID;
		      }catch(e){}
		      try{
		        if(typeof Crypto !== 'undefined' && Crypto.prototype){
		          Object.defineProperty(Crypto.prototype, 'randomUUID', { value: randomUUID, configurable: true, writable: true });
		        }
		      }catch(e){}
		    }

	    // ========================
	    // State & persistence
	    // ========================
    const DB_KEY='inv.single.inline.mobile.v1';
    const state={
      items:[],
      updatedAt:null,
      _filter:'',
      _sort:{col:'name', dir:'asc'},
      _rowTapPref:'',
      _order:{
        lines:[],
        email:'',
        companyPoNumber:'',
        internalPoNumber:'',
        subject:'',
        notes:'',
        contactName:'',
        search:'',
        shippingAddressId:'',
        shippingAddressSnapshot:null
      },
      _orderHistoryLinesByPo:new Map(),
      _receiveOrder:null,
      _shippingAddresses:[],
	      _shippingAddressById:new Map(),
	      _shippingAddressEditing:null,
      _orderShippingOptions:[],
      _orderShippingById:new Map(),
      _companyLocations:[],
      _companyLocationById:new Map(),
      _companyLocationEditing:null,
	      _trashItems:[],
	      _trashFilter:'',
	      _roleRequestPending:null,
      _roleRequests:[],
      _auditRows:[],
      _auditTableFilter:'',
      _auditActionFilter:'',
      _auditSearch:'',
      _userMgmtRows:[],
      _pendingInvites:[],
      _pendingInviteBusy:{},
      _snapshots:[],
      _snapshotPreview:null,
      _metrics:null,
      _roleConfigs:{},
      _roleChanges:{},
      _impersonationRole:'super_user',
      _impersonationPermissions:null,
      _tierDetails:null,
      _tierDetailsCompanyId:null,
      _advancedCompanies:[],
      _provisioningUsers:[],
      _provisioningCompanies:[],
      _provisioningExistingUsers:[],
      _provisioningExistingUsersLoading:false,
      _provisioningExistingUsersError:'',
      _provisioningBusy:false,
      _provisioningResult:null,
      _advancedSearch:'',
      _advancedType:'production',
      _defaultCompanyId:null,
      _diagRole:'',
      _diagTier:'',
      _diagPermissions:null,
      _onboardingState:null,
      _onboardingStep:null,
      _onboardingLoading:false,
      _onboardingPlan:null,
      _onboardingSource:null,
      _onboardingError:'',
      _signupError:'',
      _onboardingAllowSuper:false,
      _onboardingGatePrimary:null,
      _onboardingGateSecondary:null,
      _jobs:[],
      _jobsById:new Map(),
      _jobBomByJobId:new Map(),
      _jobActualsByJobId:new Map(),
      _jobEditor:null,
      _jobEditorBusy:false,
      _jobsLoading:false,
      _jobsExpanded:new Set(),
      _jobReservedMap:new Map(),
      _addToJob:null,
      _addToJobBusy:false,
      _seedInventory:null,
      _seedInventoryBusy:false,
      _companyEnvironment:null,
      _companyEnvironmentBusy:false,
      _companySwitcherMode:'basic',
      _profileTab:'',
      _advancedInventoryCounts:{},
      _companyOverflowOpenId:null
    };
    const APP_VERSION = '2.0.0';
    const PROFILE_TAB_STORAGE_KEY = 'profile.activeTab';
    const MENU_TAB_STORAGE_KEY = 'menu.activeTab';

    const $ = (id) => document.getElementById(String(id).replace(/^#/, ''));
    const IMUtils = window.IMUtils || {};
    const toKey = IMUtils.toKey || ((s) => (s || '').trim().toUpperCase());
    const toInt = IMUtils.toInt || ((v, f = 0) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return f;
      const i = Math.floor(n);
      return i < 0 ? f : i;
    });
    const toQty = (v, f = 0) => {
      const n = Number(v);
      if (!Number.isFinite(n)) return f;
      return n < 0 ? f : n;
    };
    function formatQty(value){
      const n = Number(value);
      if(!Number.isFinite(n)) return '0';
      if(Math.abs(n - Math.round(n)) < 1e-9) return String(Math.round(n));
      const fixed = n.toFixed(2);
      return fixed.replace(/\.00$/, '').replace(/(\.\d)0$/, '$1');
    }
    const ICONS = {
      chevronRight:
        '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="m9 18 6-6-6-6"></path>'+
        '</svg>',
      chevronDown:
        '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="m6 9 6 6 6-6"></path>'+
        '</svg>',
      eye:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M2 12s3-6 10-6 10 6 10 6-3 6-10 6-10-6-10-6Z"></path>'+
          '<circle cx="12" cy="12" r="3"></circle>'+
        '</svg>',
      pencil:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M17 3a2.85 2.85 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>'+
          '<path d="m15 5 4 4"></path>'+
        '</svg>',
      checkCircle:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<circle cx="12" cy="12" r="10"></circle>'+
          '<path d="m9 12 2 2 4-4"></path>'+
        '</svg>',
      check:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M20 6 9 17l-5-5"></path>'+
        '</svg>',
      xCircle:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<circle cx="12" cy="12" r="10"></circle>'+
          '<path d="m15 9-6 6"></path>'+
          '<path d="m9 9 6 6"></path>'+
        '</svg>',
      briefcasePlus:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<rect x="2" y="7" width="20" height="14" rx="2"></rect>'+
          '<path d="M16 7V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"></path>'+
          '<line x1="12" y1="12" x2="12" y2="16"></line>'+
          '<line x1="10" y1="14" x2="14" y2="14"></line>'+
        '</svg>',
      alertTriangle:
        '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>'+
          '<line x1="12" y1="9" x2="12" y2="13"></line>'+
          '<line x1="12" y1="17" x2="12.01" y2="17"></line>'+
        '</svg>',
      columns:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<rect x="3" y="3" width="7" height="18"></rect>'+
          '<rect x="14" y="3" width="7" height="18"></rect>'+
        '</svg>',
      plus:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<line x1="12" y1="5" x2="12" y2="19"></line>'+
          '<line x1="5" y1="12" x2="19" y2="12"></line>'+
        '</svg>',
      shoppingCart:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<circle cx="8" cy="21" r="1"></circle>'+
          '<circle cx="19" cy="21" r="1"></circle>'+
          '<path d="M2.05 2.05h2l2.66 12.6a2 2 0 0 0 2 1.6h9.7a2 2 0 0 0 2-1.6l1.65-8.6H6"></path>'+
          '<path class="order-check" d="m9 11 2 2 4-4"></path>'+
        '</svg>',
      shoppingBag:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4H6z"></path>'+
          '<path d="M3 6h18"></path>'+
          '<path d="M16 10a4 4 0 0 1-8 0"></path>'+
          '<path class="order-check" d="m9 14 2 2 4-4"></path>'+
        '</svg>',
      moreHorizontal:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<circle cx="12" cy="12" r="1"></circle>'+
          '<circle cx="19" cy="12" r="1"></circle>'+
          '<circle cx="5" cy="12" r="1"></circle>'+
        '</svg>',
      package:
        '<svg class="icon icon-sm" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>'+
          '<path d="M3.27 6.96 12 12.01l8.73-5.05"></path>'+
          '<path d="M12 22.08V12"></path>'+
        '</svg>',
      trash2:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<polyline points="3 6 5 6 21 6"></polyline>'+
          '<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>'+
          '<path d="M10 11v6"></path>'+
          '<path d="M14 11v6"></path>'+
          '<path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>'+
        '</svg>',
      loader2:
        '<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
          '<path d="M21 12a9 9 0 1 1-9-9"></path>'+
        '</svg>',
    };
    const INVENTORY_ROW_DISPLAY_KEY = 'tableRowDisplay:inventory_list';
    const INVENTORY_ROW_TAP_KEY = 'tableRowTap:inventory_list';
    const INVENTORY_ROW_TAP_DEFAULT = 'expand_details';
    const INVENTORY_ROW_TAP_OPTIONS = new Set(['expand_details', 'add_to_order', 'add_to_job', 'edit_item']);
    const INVENTORY_QUICK_FILTER_KEY = 'inv.quickFilter.inventory_list';
    const INVENTORY_QUICK_FILTERS = new Set(['all', 'in_stock', 'low_stock', 'out_of_stock']);
    window.invQuickFilter = 'all';
    const INVENTORY_LEGACY_COLUMNS_KEY = 'tableColumns:inventory_list';
    const INVENTORY_ANCHOR_KEY = 'item';
    const INVENTORY_ACTIONS_DEF = {
      id:'actions',
      key:'actions',
      label:'Actions',
      type:'actions',
      locked:true,
      lock:true,
      minWidth:192,
      minCellWidth:192,
      dataCol:'actions',
      sortable:false,
      align:'right',
      thClass:'actions'
    };
    const INVENTORY_COLUMN_DEFS = [
      { id:'item', key:'item', label:'Item', type:'item', locked:true, lock:true, minWidth:180, minCellWidth:180, maxWidth:360, defaultVisible:true, dataCol:'name', sortable:true, align:'left', optional:false },
      { id:'sku', key:'sku', label:'SKU', type:'text', locked:false, lock:false, minWidth:140, minCellWidth:140, maxWidth:180, defaultVisible:true, dataCol:'sku', sortable:true, align:'left', optional:true },
      { id:'on_hand', key:'on_hand', label:'On Hand', type:'number', locked:false, lock:false, minWidth:110, minCellWidth:110, defaultVisible:true, dataCol:'qty', sortable:true, align:'center', optional:true },
      { id:'available', key:'available', label:'Available', type:'number', locked:false, lock:false, minWidth:110, minCellWidth:110, defaultVisible:true, dataCol:'available', sortable:true, align:'center', optional:true },
      { id:'reorder_point', key:'reorder_point', label:'Reorder Point', type:'number', locked:false, lock:false, minWidth:120, minCellWidth:120, defaultVisible:true, dataCol:'reorderPoint', sortable:true, align:'center', optional:true },
      { id:'reorder_qty', key:'reorder_qty', label:'Reorder Qty', type:'number', locked:false, lock:false, minWidth:120, minCellWidth:120, defaultVisible:false, dataCol:'reorderQty', sortable:true, align:'center', optional:true },
      { id:'description', key:'description', label:'Description', type:'text', locked:false, lock:false, minWidth:220, minCellWidth:220, maxWidth:280, defaultVisible:false, dataCol:'desc', sortable:true, align:'left', optional:true },
      { id:'location', key:'location', label:'Location', type:'text', locked:false, lock:false, minWidth:140, minCellWidth:140, maxWidth:180, defaultVisible:false, dataCol:'location', sortable:true, align:'left', optional:true },
      { id:'reserved', key:'reserved', label:'Reserved', type:'number', locked:false, lock:false, minWidth:110, minCellWidth:110, defaultVisible:false, dataCol:'reserved', sortable:true, align:'center', optional:true },
      { id:'category', key:'category', label:'Category', type:'text', locked:false, lock:false, minWidth:140, minCellWidth:140, maxWidth:180, defaultVisible:false, dataCol:'category', sortable:true, align:'left', optional:true }
    ];
    const INVENTORY_ROW_ACTION_ORDER = ['edit_item', 'add_to_job', 'order_item', 'delete_item'];
    const INVENTORY_TRAY_SIDE = {
      edit_item: 'right',
      delete_item: 'right',
      add_to_job: 'left',
      order_item: 'left'
    };
    const INVENTORY_TRAY_ORDER = {
      left: ['add_to_job', 'order_item'],
      right: ['edit_item', 'delete_item']
    };
    const INVENTORY_ACTION_META = {
      edit_item: {
        btnClass: 'icon-btn icon-btn--default row-edit-btn',
        icon: () => ICONS.pencil,
        label: () => 'Edit item',
        trayAction: 'edit'
      },
      add_to_job: {
        btnClass: 'icon-btn icon-btn--default row-job-btn',
        icon: () => ICONS.briefcasePlus,
        label: () => 'Add to job',
        trayAction: 'job'
      },
      order_item: {
        btnClass: 'icon-btn icon-btn--success row-order-btn',
        icon: () => ICONS.shoppingBag,
        label: (ctx) => (ctx && ctx.inOrder ? 'Remove from order' : 'Add to order'),
        trayAction: 'order'
      },
      delete_item: {
        btnClass: 'icon-btn icon-btn--danger row-delete-btn',
        icon: () => ICONS.trash2,
        label: () => 'Delete item',
        trayAction: 'delete'
      }
    };
    const INVENTORY_COLUMN_MAP = new Map(INVENTORY_COLUMN_DEFS.map(def => [def.key, def]));
    const INVENTORY_DEFAULT_ORDER = INVENTORY_COLUMN_DEFS.map(def => def.key);
    const INVENTORY_DEFAULT_VISIBLE = INVENTORY_COLUMN_DEFS.filter(def => def.defaultVisible).map(def => def.key);
    let _inventoryColumnSig = '';
    let _inventoryColumnConfig = null;
    let _inventoryActiveColumns = null;
    let _inventoryLayoutSig = '';
    let _inventoryLayout = null;
    let _inventoryItemColWidth = 180;
    const INVENTORY_ITEM_MIN_WIDTH = 180;
    const INVENTORY_ITEM_MAX_WIDTH = 360;
    const INVENTORY_ITEM_FONT = '800 15px Barlow, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    const INVENTORY_HEADER_FONT = '700 12px Barlow, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    const INVENTORY_HEADER_LETTER_SPACING = 0.5;
    const INVENTORY_HEADER_PADDING = 24;
    const INVENTORY_HEADER_SORT_EXTRA = 20;
    let _inventoryMeasureCanvas = null;

    function measureTextPx(text, font){
      try{
        if(!_inventoryMeasureCanvas) _inventoryMeasureCanvas = document.createElement('canvas');
        const ctx = _inventoryMeasureCanvas.getContext('2d');
        if(!ctx) return 0;
        ctx.font = font;
        return ctx.measureText(String(text || '')).width || 0;
      }catch(e){
        return 0;
      }
    }
    function getInventoryColumnMinWidth(def){
      if(!def) return 0;
      const min = Number(def.minCellWidth ?? def.minWidth);
      return Number.isFinite(min) ? min : 0;
    }
    function getInventoryColumnHeaderWidth(def){
      if(!def) return 0;
      if(Number.isFinite(def.headerWidth)) return def.headerWidth;
      const label = String(def.label || def.key || '').trim();
      if(!label){
        def.headerWidth = 0;
        return 0;
      }
      const text = label.toUpperCase();
      let width = measureTextPx(text, INVENTORY_HEADER_FONT);
      if(INVENTORY_HEADER_LETTER_SPACING){
        width += Math.max(0, text.length - 1) * INVENTORY_HEADER_LETTER_SPACING;
      }
      width += INVENTORY_HEADER_PADDING;
      if(def.sortable) width += INVENTORY_HEADER_SORT_EXTRA;
      def.headerWidth = Math.ceil(width);
      return def.headerWidth;
    }
    function getInventoryColumnRequiredWidth(def){
      if(!def) return 0;
      const minWidth = getInventoryColumnMinWidth(def);
      const headerWidth = getInventoryColumnHeaderWidth(def);
      return Math.max(minWidth, headerWidth);
    }
    function computeItemColWidth(items){
      const list = Array.isArray(items) ? items : [];
      let max = 0;
      for(const it of list){
        const name = String(it && it.name ? it.name : '').trim();
        if(!name) continue;
        const w = measureTextPx(name, INVENTORY_ITEM_FONT);
        if(w > max) max = w;
      }
      const padding = 86; // checkbox + spacing + cell padding
      const desired = Math.ceil(max + padding);
      const clamped = Math.max(INVENTORY_ITEM_MIN_WIDTH, Math.min(INVENTORY_ITEM_MAX_WIDTH, desired || INVENTORY_ITEM_MIN_WIDTH));
      return clamped;
    }
    function refreshComputedItemColWidth(items){
      _inventoryItemColWidth = computeItemColWidth(items);
      _inventoryLayoutSig = '';
      return _inventoryItemColWidth;
    }
    function getComputedItemColWidth(){
      return _inventoryItemColWidth || INVENTORY_ITEM_MIN_WIDTH;
    }
    function getInventoryViewportWidth(){
      const wrap = $('tableWrap');
      if(wrap){
        const w = wrap.getBoundingClientRect().width;
        if(Number.isFinite(w) && w > 0) return Math.floor(w);
      }
      const table = $('invTable');
      if(table){
        const w = table.getBoundingClientRect().width;
        if(Number.isFinite(w) && w > 0) return Math.floor(w);
      }
      return Math.max(0, Math.floor(window.innerWidth || 0));
    }
    function computeInventoryVisibleColumns({ enabledOrder, viewportWidthPx, isMobile, computedItemColWidth }){
      const order = Array.isArray(enabledOrder) ? enabledOrder : [];
      const viewport = Math.max(0, Number(viewportWidthPx) || 0);
      const actionsWidth = (!isMobile && INVENTORY_ACTIONS_DEF && INVENTORY_ACTIONS_DEF.minWidth)
        ? Number(INVENTORY_ACTIONS_DEF.minWidth) || 0
        : 0;
      let itemWidth = Math.max(
        INVENTORY_ITEM_MIN_WIDTH,
        Math.min(INVENTORY_ITEM_MAX_WIDTH, Number(computedItemColWidth) || INVENTORY_ITEM_MIN_WIDTH)
      );
      const requiredWidthForKey = (key) => {
        const def = INVENTORY_COLUMN_MAP.get(key);
        return def ? getInventoryColumnRequiredWidth(def) : 0;
      };
      const buildVisible = (remaining) => {
        const out = [];
        let rem = remaining;
        for(const key of order){
          const req = requiredWidthForKey(key);
          if(req <= 0) continue;
          if(rem >= req){
            out.push(key);
            rem -= req;
          }else{
            break;
          }
        }
        return out;
      };
      let remaining = viewport - itemWidth - actionsWidth;
      let visible = buildVisible(remaining);

      if(visible.length === 0 && order.length){
        const firstReq = requiredWidthForKey(order[0]);
        if(firstReq > 0){
          const maxItemForTwo = viewport - actionsWidth - firstReq;
          if(Number.isFinite(maxItemForTwo)){
            const adjustedItem = Math.max(INVENTORY_ITEM_MIN_WIDTH, Math.min(itemWidth, maxItemForTwo));
            if(adjustedItem !== itemWidth){
              itemWidth = adjustedItem;
              remaining = viewport - itemWidth - actionsWidth;
              visible = buildVisible(remaining);
            }
          }
        }
      }

      if(visible.length === 0 && order.length){
        const remainingAfterItem = viewport - itemWidth - actionsWidth;
        for(const key of order){
          const req = requiredWidthForKey(key);
          if(req > 0 && remainingAfterItem >= req){
            visible = [key];
            break;
          }
        }
        if(visible.length === 0){
          visible = [order[0]];
        }
      }

      return { visibleKeys: visible, itemWidth };
    }

    function defaultInventoryOrder(){
      return INVENTORY_DEFAULT_ORDER.slice();
    }
    function defaultInventoryVisibleKeys(){
      return INVENTORY_DEFAULT_VISIBLE.slice();
    }
    function normalizeInventoryOrder(order){
      if(!Array.isArray(order) || !order.includes(INVENTORY_ANCHOR_KEY)) return defaultInventoryOrder();
      const valid = new Set(INVENTORY_DEFAULT_ORDER);
      const seen = new Set();
      const cleaned = [];
      for(const key of order){
        if(!valid.has(key) || seen.has(key)) continue;
        if(key === INVENTORY_ANCHOR_KEY) continue;
        seen.add(key);
        cleaned.push(key);
      }
      const ordered = [INVENTORY_ANCHOR_KEY, ...cleaned];
      for(const key of INVENTORY_DEFAULT_ORDER){
        if(!ordered.includes(key)) ordered.push(key);
      }
      return ordered;
    }
    function normalizeInventoryVisible(visible, order){
      const valid = new Set(INVENTORY_DEFAULT_ORDER);
      if(!Array.isArray(visible)) return defaultInventoryVisibleKeys();
      const visibleSet = new Set();
      visible.forEach(key=>{
        if(valid.has(key)) visibleSet.add(key);
      });
      visibleSet.add(INVENTORY_ANCHOR_KEY);
      const ordered = Array.isArray(order) ? order : defaultInventoryOrder();
      return ordered.filter(key => visibleSet.has(key));
    }
    function getInventoryLayoutFromConfig(config, opts = {}){
      const order = normalizeInventoryOrder(config && Array.isArray(config.order) ? config.order : defaultInventoryOrder());
      const visible = normalizeInventoryVisible(config && Array.isArray(config.visible) ? config.visible : defaultInventoryVisibleKeys(), order);
      const visibleSet = new Set(visible);
      const enabledOrder = order.filter(key => key !== INVENTORY_ANCHOR_KEY && visibleSet.has(key));
      const viewportWidthPx = getInventoryViewportWidth();
      const isMobile = isMobileUx();
      const itemWidth = getComputedItemColWidth();
      const sig = `${order.join('|')}::${visible.join('|')}::${viewportWidthPx}::${isMobile ? '1' : '0'}::${itemWidth}`;
      if(!opts.force && sig === _inventoryLayoutSig && _inventoryLayout){
        return _inventoryLayout;
      }
      const computed = computeInventoryVisibleColumns({
        enabledOrder,
        viewportWidthPx,
        isMobile,
        computedItemColWidth: itemWidth
      });
      const visibleKeys = computed.visibleKeys || [];
      const columnDefs = visibleKeys.map(key => INVENTORY_COLUMN_MAP.get(key)).filter(Boolean);
      const showActions = !isMobile;
      _inventoryLayoutSig = sig;
      _inventoryLayout = {
        order,
        visible,
        columnKeys: visibleKeys,
        columnDefs,
        showActions,
        itemWidth: computed.itemWidth || itemWidth,
        viewportWidthPx,
        isMobile
      };
      return _inventoryLayout;
    }
    function getInventoryLayout(){
      const config = getInventoryColumnConfig();
      return getInventoryLayoutFromConfig(config);
    }
    function loadInventoryColumnConfig(){
      const raw = localStorage.getItem(INVENTORY_ROW_DISPLAY_KEY);
      const fallback = localStorage.getItem(INVENTORY_LEGACY_COLUMNS_KEY);
      if(!raw && !fallback){
        return { order: defaultInventoryOrder(), visible: defaultInventoryVisibleKeys() };
      }
      try{
        const parsed = JSON.parse(raw || fallback || '{}');
        const hasOrder = parsed && Array.isArray(parsed.order);
        const hasVisible = parsed && Array.isArray(parsed.visible);
        const order = hasOrder ? normalizeInventoryOrder(parsed.order) : defaultInventoryOrder();
        const visible = hasVisible ? normalizeInventoryVisible(parsed.visible, order) : defaultInventoryVisibleKeys();
        return { order, visible };
      }catch(e){
        return { order: defaultInventoryOrder(), visible: defaultInventoryVisibleKeys() };
      }
    }
    function saveInventoryColumnConfig(config){
      const existing = loadInventoryColumnConfig();
      const order = normalizeInventoryOrder(config && config.order ? config.order : (existing.order || defaultInventoryOrder()));
      const visible = normalizeInventoryVisible(config && config.visible ? config.visible : (existing.visible || defaultInventoryVisibleKeys()), order);
      localStorage.setItem(INVENTORY_ROW_DISPLAY_KEY, JSON.stringify({ order, visible }));
      _inventoryColumnSig = '';
      _inventoryColumnConfig = null;
      _inventoryLayoutSig = '';
    }
    function getAllowedInventoryRowTapOptions(){
      const allowed = new Set(['expand_details']);
      if(isInventoryActionVisible('order_item') && canOrdersCreate()) allowed.add('add_to_order');
      if(isInventoryActionVisible('add_to_job')) allowed.add('add_to_job');
      if(isInventoryActionVisible('edit_item') && canItemsEdit()) allowed.add('edit_item');
      return allowed;
    }
    function normalizeInventoryRowTapValue(value){
      const raw = String(value || '').trim();
      if(raw === 'expand_qty') return 'expand_details';
      return raw;
    }
    function getInventoryRowTapPref(){
      const allowed = getAllowedInventoryRowTapOptions();
      if(state._rowTapPref && allowed.has(state._rowTapPref)) return state._rowTapPref;
      const raw = normalizeInventoryRowTapValue(localStorage.getItem(INVENTORY_ROW_TAP_KEY));
      state._rowTapPref = (allowed.has(raw) && INVENTORY_ROW_TAP_OPTIONS.has(raw)) ? raw : INVENTORY_ROW_TAP_DEFAULT;
      return state._rowTapPref;
    }
    function setInventoryRowTapPref(value){
      const allowed = getAllowedInventoryRowTapOptions();
      const normalized = normalizeInventoryRowTapValue(value);
      const next = (INVENTORY_ROW_TAP_OPTIONS.has(normalized) && allowed.has(normalized)) ? normalized : INVENTORY_ROW_TAP_DEFAULT;
      state._rowTapPref = next;
      localStorage.setItem(INVENTORY_ROW_TAP_KEY, next);
    }
    function handleInventoryRowTap(id){
      const itemId = String(id || '').trim();
      if(!itemId) return;
      const pref = getInventoryRowTapPref();
      if(pref === 'edit_item'){
        if(isInventoryActionVisible('edit_item') && canItemsEdit()){
          openEditItemModal(itemId);
          return;
        }
      }
      if(pref === 'add_to_job'){
        if(isInventoryActionVisible('add_to_job')){
          openAddToJobModal(itemId);
          return;
        }
      }
      if(pref === 'add_to_order'){
        if(isInventoryActionVisible('order_item') && canOrdersCreate()){
          toggleOrderLineForItemId(itemId);
          return;
        }
      }
      toggleExpandedCard(itemId);
    }
    function loadInventoryQuickFilter(){
      let raw = '';
      try{ raw = String(localStorage.getItem(INVENTORY_QUICK_FILTER_KEY) || '').trim(); }catch(e){ raw = ''; }
      window.invQuickFilter = INVENTORY_QUICK_FILTERS.has(raw) ? raw : 'all';
    }
    function getInventoryQuickFilter(){
      const raw = String(window.invQuickFilter || '').trim();
      return INVENTORY_QUICK_FILTERS.has(raw) ? raw : 'all';
    }
    function updateQuickFilterPills(){
      const wrap = $('invQuickFilters');
      if(!wrap) return;
      const active = getInventoryQuickFilter();
      wrap.querySelectorAll('[data-filter]').forEach(btn=>{
        const key = btn.getAttribute('data-filter');
        const on = key === active;
        btn.classList.toggle('is-active', on);
        btn.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    }
    function setInventoryQuickFilter(value, opts = {}){
      const next = INVENTORY_QUICK_FILTERS.has(value) ? value : 'all';
      window.invQuickFilter = next;
      if(opts.persist !== false){
        try{ localStorage.setItem(INVENTORY_QUICK_FILTER_KEY, next); }catch(e){}
      }
      updateQuickFilterPills();
      if(opts.render !== false){
        renderTable();
      }
    }
    function applyInventoryQuickFilter(items){
      const list = Array.isArray(items) ? items : [];
      const mode = getInventoryQuickFilter();
      if(mode === 'all') return list;
      return list.filter(it=>{
        const qty = toInt(it.qty, 0);
        if(mode === 'in_stock') return qty > 0;
        if(mode === 'out_of_stock') return qty === 0;
        if(mode === 'low_stock') return qty > 0 && isLowStockItem(it);
        return true;
      });
    }
    function getInventoryVisibilityRole(){
      const role = String(getEffectiveRole() || '').trim().toLowerCase();
      if(role === 'member') return 'user';
      if(role === 'user') return 'user';
      return role || '';
    }
    function getInventoryActionVisibilityMap(){
      const vis = UI_VISIBILITY && UI_VISIBILITY.inventory_action && UI_VISIBILITY.inventory_action.row;
      return (vis && typeof vis === 'object') ? vis : {};
    }
    function isInventoryActionVisible(actionKey){
      const role = getInventoryVisibilityRole();
      const map = getInventoryActionVisibilityMap();
      const allowed = map ? map[actionKey] : null;
      return Array.isArray(allowed) && role && allowed.includes(role);
    }
    function getVisibleInventoryRowActions(){
      return INVENTORY_ROW_ACTION_ORDER.filter(key => isInventoryActionVisible(key));
    }
    function getVisibleInventoryTrayActions(side){
      const s = side === 'right' ? 'right' : 'left';
      const order = INVENTORY_TRAY_ORDER[s] || [];
      return order.filter(key => INVENTORY_TRAY_SIDE[key] === s && isInventoryActionVisible(key));
    }
    function inventoryActionMetaForKey(actionKey){
      return INVENTORY_ACTION_META[actionKey] || null;
    }
    if (!IMUtils.toKey) IMUtils.toKey = toKey;
    if (!IMUtils.toInt) IMUtils.toInt = toInt;
    window.IMUtils = IMUtils;
    function setUpdated(){ state.updatedAt=new Date().toISOString(); }
    // Persist only UI prefs; never persist items
    function save(){ const prefs={updatedAt:state.updatedAt,_filter:state._filter,_sort:state._sort}; localStorage.setItem(DB_KEY, JSON.stringify(prefs)); render(); }
    function load(){
      const raw=localStorage.getItem(DB_KEY);
      if(raw){
        try{
          const p=JSON.parse(raw);
          if(p){
            if(typeof p._filter==='string') state._filter=p._filter;
            if(p._sort){
              // Handle array format (convert to single)
              if(Array.isArray(p._sort) && p._sort[0] && typeof p._sort[0].col === 'string'){
                state._sort = { col: p._sort[0].col, dir: p._sort[0].dir === 'desc' ? 'desc' : 'asc' };
              } else if(typeof p._sort.col === 'string'){
                state._sort = { col: p._sort.col, dir: p._sort.dir === 'desc' ? 'desc' : 'asc' };
              }
            }
            if(p.updatedAt) state.updatedAt=p.updatedAt;
          }
        } catch(e){}
      }
    }



    function dedupe(){
      const seen=new Set();
      state.items=state.items.filter(it=>{
        const k=toKey(it.name); if(!k) return false;
        if(seen.has(k)) return false;
        seen.add(k);
        if(!it.id) it.id=randomUUID();
        it.qty = toInt(it.qty,0);
        return true;
      });
    }

    // Shallow clone of items for optimistic-UI rollback
    function snapshotItems(){ return state.items.map(it => ({...it})); }

	    // ========================
	    // Supabase (cloud sync) â€” optional
	    // ========================
    const SB = { client:null, ready:false, connected:false, session:null, user:null, authorized:false, profile:null, companyId:null, company:null, companyTier:null, companies:[], permissions:null, itemsHasLowStockQty:null, itemsHasReorderEnabled:null, ordersHasReceipt:null, warnedLowStockSchema:false, warnedReorderSchema:false, warnedOrdersReceiptSchema:false, warnedTierMissing:false };
    const COMPANY_STORAGE_PREFIX = 'inv.company.v1';
    let _inviteCompanyId = '';
    let _userMgmtCompanyId = '';
    let _onboardingCompanyId = '';
    let _signupMode = false;      // True when in self-service signup flow
    let _signupPlan = '';         // Plan from URL parameter (starter, professional, business)

    // ========================
    // Self-Service Signup Flow
    // ========================
    function isSignupMode() {
      return _signupMode && isOnboardingRoute();
    }

    function setSignupMessage(msg, isError = false) {
      const el = $('signupAccountMsg');
      if (!el) return;
      el.textContent = String(msg || '');
      el.style.color = isError ? '#f87171' : 'var(--wiz-muted)';
    }

    function setCompanyMessage(msg, isError = false) {
      const el = $('signupCompanyMsg');
      if (!el) return;
      el.textContent = String(msg || '');
      el.style.color = isError ? '#f87171' : 'var(--wiz-muted)';
    }

    async function handleSignupSubmit(e) {
      if (e) e.preventDefault();
      const email = String($('signupEmail')?.value || '').trim();
      const password = String($('signupPassword')?.value || '');
      const confirm = String($('signupPasswordConfirm')?.value || '');
      const terms = $('signupTerms')?.checked;

      setSignupMessage('');

      // Validation
      if (!email) {
        setSignupMessage('Email address is required.', true);
        return;
      }
      if (!email.includes('@') || !email.includes('.')) {
        setSignupMessage('Please enter a valid email address.', true);
        return;
      }
      if (!password) {
        setSignupMessage('Password is required.', true);
        return;
      }
      if (password.length < 8) {
        setSignupMessage('Password must be at least 8 characters.', true);
        return;
      }
      if (password !== confirm) {
        setSignupMessage('Passwords do not match.', true);
        return;
      }
      if (!terms) {
        setSignupMessage('Please accept the Terms of Service.', true);
        return;
      }

      const btn = $('btnSignupSubmit');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Creating account...';
      }

      try {
        const { data, error } = await SB.client.auth.signUp({
          email,
          password,
          options: {
            data: { signup_plan: _signupPlan || 'starter' }
          }
        });

        if (error) throw error;

        if (data?.user) {
          // Refresh session
          const { data: sessionData } = await SB.client.auth.getSession();
          if (sessionData?.session) {
            SB.session = sessionData.session;
            SB.user = sessionData.session.user;
          }
          // Move to company creation step
          renderOnboardingStep('company');
          renderSignupProgress(2); // Step 2 of 6
        } else {
          setSignupMessage('Check your email to confirm your account.', false);
        }
      } catch (err) {
        console.error('Signup error:', err);
        const msg = err?.message || 'Signup failed. Please try again.';
        setSignupMessage(msg, true);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Create Account';
        }
      }
    }

    async function handleCompanyCreate(e) {
      if (e) e.preventDefault();
      const name = String($('signupCompanyName')?.value || '').trim();

      setCompanyMessage('');

      if (!name) {
        setCompanyMessage('Company name is required.', true);
        return;
      }
      if (name.length < 2) {
        setCompanyMessage('Company name must be at least 2 characters.', true);
        return;
      }

      const btn = $('btnCompanySubmit');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Creating company...';
      }

      try {
        // Generate slug from name
        const slug = name.toLowerCase()
          .replace(/[^a-z0-9]+/g, '-')
          .replace(/^-|-$/g, '');

        const { data, error } = await SB.client.rpc('create_company_for_signup', {
          p_name: name,
          p_slug: slug,
          p_plan: _signupPlan || 'starter'
        });

        if (error) throw error;

        if (data?.success) {
          // Update SB state
          SB.companyId = data.company_id;
          SB.company = {
            id: data.company_id,
            name: data.company_name,
            slug: data.company_slug
          };
          SB.companyTier = data.tier;
          _onboardingCompanyId = data.company_id;

          // Refresh companies list
          await sbLoadCompanies();

          // Exit signup mode and continue normal onboarding
          _signupMode = false;

          // Fetch onboarding state and continue
          state._onboardingState = await fetchOnboardingState();
          const stepIndex = getOnboardingStepFromState(state._onboardingState);
          const stepId = stepIndex === 1 ? 'profile' : stepIndex === 2 ? 'locations' : stepIndex === 3 ? 'invites' : 'finish';
          state._onboardingStep = stepId;

          // Render normal 4-step progress
          renderOnboardingProgress(stepIndex);
          renderOnboardingStep(stepId);

          // Pre-fill profile with signup email
          if (stepId === 'profile') {
            const profile = await loadOnboardingCompanyProfile();
            applyOnboardingProfileToForm(profile);
            // Also set contact email to signup email if empty
            const contactEmail = $('onboardingContactEmail');
            if (contactEmail && !contactEmail.value && SB.user?.email) {
              contactEmail.value = SB.user.email;
            }
          }
        } else {
          throw new Error(data?.error || 'Company creation failed');
        }
      } catch (err) {
        console.error('Company creation error:', err);
        const msg = err?.message || 'Failed to create company. Please try again.';
        if(/company_members_user_id_fkey|auth\\.users/i.test(msg) || /foreign key constraint/i.test(msg)){
          state._signupError = 'Your local database was reset. Please create your account again.';
          await sbSignOut();
          return;
        }
        setCompanyMessage(msg, true);
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Continue';
        }
      }
    }

    function renderSignupProgress(step) {
      // For signup flow, we show 6 steps
      const steps = [
        { num: 1, label: 'Account' },
        { num: 2, label: 'Company' },
        { num: 3, label: 'Profile' },
        { num: 4, label: 'Locations' },
        { num: 5, label: 'Team' },
        { num: 6, label: 'Finish' }
      ];

      const container = $('onboardingProgressSteps');
      if (!container) return;

      container.innerHTML = steps.map(s => {
        const isComplete = step > s.num;
        const isActive = step === s.num;
        const cls = isComplete ? 'complete' : isActive ? 'active' : '';
        return `<div class="onboarding-progress-step ${cls}" data-onboarding-progress="${s.num}">${s.label}</div>`;
      }).join('');

      const fill = $('onboardingProgressFill');
      if (fill) {
        const percent = Math.round(((step - 1) / (steps.length - 1)) * 100);
        fill.style.width = `${percent}%`;
      }

      // Update header text for signup flow
      const eyebrow = $('onboardingEyebrow');
      const title = $('onboardingTitle');
      const note = $('onboardingNote');

      if (step === 1) {
        if (eyebrow) eyebrow.textContent = 'Get Started';
        if (title) title.textContent = 'Create your account';
        if (note) note.textContent = _signupPlan ? `Selected plan: ${_signupPlan.charAt(0).toUpperCase() + _signupPlan.slice(1)}` : '';
      } else if (step === 2) {
        if (eyebrow) eyebrow.textContent = 'Almost there';
        if (title) title.textContent = 'Name your company';
        if (note) note.textContent = 'This will be your workspace name.';
      } else {
        // Reset to default for profile+ steps
        if (eyebrow) eyebrow.textContent = 'Company Onboarding';
        if (title) title.textContent = 'Set up your workspace';
        if (note) note.textContent = 'You can complete setup later.';
      }
    }

    function showSignInFromSignup() {
      // User clicked "Already have an account?" - show sign in modal
      show('authModal', true);
    }

    // ========================
    // Google Places Autocomplete (PlaceAutocompleteElement)
    // ========================
    let _googlePlacesReady = false;
    let _placesLibraryPromise = null;
    const _autocompleteInstances = new Map();

    function hasPlaceAutocomplete(){
      return !!(window.google && google.maps && google.maps.places && google.maps.places.PlaceAutocompleteElement);
    }

    function safePlaceField(place, key){
      if(!place) return undefined;
      try{
        return place[key];
      }catch(e){
        return undefined;
      }
    }

    async function loadPlacesLibrary(){
      if(_placesLibraryPromise) return _placesLibraryPromise;
      if(window.google && google.maps && typeof google.maps.importLibrary === 'function'){
        _placesLibraryPromise = google.maps.importLibrary('places').catch(()=>null);
      }else{
        _placesLibraryPromise = Promise.resolve(null);
      }
      return _placesLibraryPromise;
    }

    async function initGooglePlaces() {
      await loadPlacesLibrary();
      _googlePlacesReady = hasPlaceAutocomplete();
      initAllAddressAutocomplete();
    }
    window.initGooglePlaces = initGooglePlaces;

    function ensureGooglePlacesLoaded(retries = 10){
      if(_googlePlacesReady && hasPlaceAutocomplete()){
        return Promise.resolve(true);
      }
      if(hasPlaceAutocomplete()){
        _googlePlacesReady = true;
        initAllAddressAutocomplete();
        return Promise.resolve(true);
      }
      return new Promise((resolve)=>{
        let remaining = Math.max(0, retries);
        const timer = setInterval(()=>{
          if(hasPlaceAutocomplete()){
            clearInterval(timer);
            _googlePlacesReady = true;
            initAllAddressAutocomplete();
            resolve(true);
            return;
          }
          if(window.google && google.maps && typeof google.maps.importLibrary === 'function'){
            void loadPlacesLibrary();
          }
          remaining -= 1;
          if(remaining <= 0){
            clearInterval(timer);
            resolve(false);
          }
        }, 200);
      });
    }

    function initAllAddressAutocomplete() {
      if(!_googlePlacesReady) return;
      initAddressAutocomplete('companyLocationAddress1', {
        address1: 'companyLocationAddress1',
        address2: 'companyLocationAddress2',
        city: 'companyLocationCity',
        state: 'companyLocationState',
        postal: 'companyLocationPostal',
        country: 'companyLocationCountry'
      });
    }

    function isPlaceAutocompleteHost(el){
      return !!(el && String(el.tagName || '').toLowerCase() === 'gmp-place-autocomplete');
    }

    function getAutocompleteInputElement(inputId){
      const el = $(inputId);
      if(!el) return null;
      if(isPlaceAutocompleteHost(el)){
        return el.inputElement || null;
      }
      return el;
    }

    function getInputValueById(inputId){
      const el = $(inputId);
      if(!el) return '';
      if(isPlaceAutocompleteHost(el)){
        if(el.inputElement && el.inputElement.value) return String(el.inputElement.value || '');
        if(el._imLastValue) return String(el._imLastValue || '');
        try{
          if(typeof el.value !== 'undefined') return String(el.value || '');
        }catch(e){}
        return '';
      }
      const input = getAutocompleteInputElement(inputId);
      return input ? String(input.value || '') : '';
    }

    function setInputValueById(inputId, value){
      const el = $(inputId);
      const next = String(value || '');
      if(!el) return;
      if(isPlaceAutocompleteHost(el)){
        if(el.inputElement) el.inputElement.value = next;
        el._imLastValue = next;
        try{
          if(typeof el.value !== 'undefined') el.value = next;
        }catch(e){}
        return;
      }
      const input = getAutocompleteInputElement(inputId);
      if(input) input.value = next;
    }

    function initAddressAutocomplete(inputId, fieldMapping, force = false) {
      const host = $(inputId);
      if(!host || !hasPlaceAutocomplete()) return;
      if(_autocompleteInstances.has(inputId)){
        if(!force) return;
        destroyAddressAutocomplete(inputId);
      }

      let placeElement = host;
      let placeholder = '';
      let className = '';
      let inlineStyle = '';
      let currentValue = '';

      if(isPlaceAutocompleteHost(host)){
        placeElement = host;
        placeholder = host.dataset.placeholder || '';
        className = host.dataset.inputClass || '';
        currentValue = getInputValueById(inputId);
      }else{
        currentValue = String(host.value || '');
        placeholder = String(host.getAttribute('placeholder') || '');
        className = String(host.getAttribute('class') || '');
        inlineStyle = String(host.getAttribute('style') || '');

        placeElement = new google.maps.places.PlaceAutocompleteElement();
        placeElement.id = inputId;
        if(className) placeElement.setAttribute('class', className);
        if(inlineStyle) placeElement.setAttribute('style', inlineStyle);
        if(placeholder) placeElement.dataset.placeholder = placeholder;
        if(className) placeElement.dataset.inputClass = className;

        if(host.parentNode) host.parentNode.replaceChild(placeElement, host);
      }

      if(!placeElement.types) placeElement.types = ['address'];

      const wireInput = () => {
        const inputEl = getAutocompleteInputElement(inputId);
        if(!inputEl || inputEl._imPlacesWired) return;
        inputEl._imPlacesWired = true;
        if(className) inputEl.className = className;
        inputEl.type = 'text';
        if(placeholder) inputEl.placeholder = placeholder;
        inputEl.autocomplete = 'off';
        inputEl.spellcheck = false;
        if(currentValue) inputEl.value = currentValue;
        placeElement._imLastValue = inputEl.value || currentValue || '';
        inputEl.addEventListener('input', ()=>{
          placeElement._imLastValue = inputEl.value || '';
        });
      };
      wireInput();
      setTimeout(wireInput, 0);

      const handleSelect = async (event)=>{
        const place = event && event.place ? event.place : null;
        if(!place) return;
        const inputFallback = getInputValueById(inputId);
        let formattedAddress = safePlaceField(place, 'formattedAddress') || inputFallback || '';
        let components = safePlaceField(place, 'addressComponents') || [];

        if(typeof place.fetchFields === 'function' && (!Array.isArray(components) || components.length === 0 || !formattedAddress)){
          try{
            await place.fetchFields({ fields: ['addressComponents','formattedAddress'] });
          }catch(e){}
        }

        formattedAddress = safePlaceField(place, 'formattedAddress') || formattedAddress || inputFallback || '';
        components = safePlaceField(place, 'addressComponents') || components || [];
        populateAddressFields(components, fieldMapping, formattedAddress);

        const nextValue = getInputValueById(inputId) || formattedAddress || inputFallback || '';
        if(nextValue && !getInputValueById(inputId)){
          setInputValueById(inputId, nextValue);
        }
        placeElement._imLastValue = nextValue;
      };

      placeElement.addEventListener('gmp-select', handleSelect);
      _autocompleteInstances.set(inputId, { element: placeElement, handler: handleSelect });
    }

    function populateAddressFields(components, mapping, formattedAddress) {
      const hasComponents = Array.isArray(components) && components.length > 0;
      if(!hasComponents){
        if(formattedAddress){
          const parts = formattedAddress.split(',').map(s => s.trim()).filter(Boolean);
          if(mapping.address1 && parts[0]) setInputValueById(mapping.address1, parts[0]);
          if(mapping.city && parts[1]) setInputValueById(mapping.city, parts[1]);
          if(parts[2]){
            const statePostal = parts[2].split(' ').filter(Boolean);
            if(mapping.state && statePostal[0]) setInputValueById(mapping.state, statePostal[0]);
            if(mapping.postal && statePostal.length > 1) setInputValueById(mapping.postal, statePostal.slice(1).join(' '));
          }
          if(mapping.country && parts[3]){
            const el = $(mapping.country);
            if(el && el.tagName === 'SELECT'){
              const option = Array.from(el.options).find(
                opt => opt.value === parts[3] || opt.textContent === parts[3]
              );
              if(option) el.value = option.value;
            }else{
              setInputValueById(mapping.country, parts[3]);
            }
          }
        }
        return;
      }

      const fields = ['address2', 'city', 'state', 'postal', 'country'];
      fields.forEach(f => {
        const fieldId = mapping[f];
        if(fieldId) setInputValueById(fieldId, '');
      });

      let streetNumber = '';
      let route = '';

      components.forEach(component => {
        const types = Array.isArray(component.types) ? component.types : [];
        const longName = component.longText || component.long_name || component.name || '';
        const shortName = component.shortText || component.short_name || longName;

        if(types.includes('street_number')){
          streetNumber = longName;
        } else if(types.includes('route')){
          route = longName;
        } else if(types.includes('subpremise')){
          if(mapping.address2) setInputValueById(mapping.address2, longName);
        } else if(types.includes('locality') || types.includes('postal_town') || types.includes('sublocality_level_1')){
          if(mapping.city){
            const existing = getInputValueById(mapping.city);
            if(!existing) setInputValueById(mapping.city, longName);
          }
        } else if(types.includes('administrative_area_level_1')){
          if(mapping.state) setInputValueById(mapping.state, shortName);
        } else if(types.includes('postal_code')){
          if(mapping.postal) setInputValueById(mapping.postal, longName);
        } else if(types.includes('country')){
          if(mapping.country){
            const el = $(mapping.country);
            if(el && el.tagName === 'SELECT'){
              const option = Array.from(el.options).find(
                opt => opt.value === shortName || opt.textContent === longName
              );
              if(option) el.value = option.value;
            }else{
              setInputValueById(mapping.country, shortName);
            }
          }
        }
      });

      if(mapping.address1){
        const streetAddress = [streetNumber, route].filter(Boolean).join(' ');
        if(streetAddress){
          setInputValueById(mapping.address1, streetAddress);
        } else if(formattedAddress){
          setInputValueById(mapping.address1, formattedAddress);
        }
      }
    }

    function destroyAddressAutocomplete(inputId) {
      const instance = _autocompleteInstances.get(inputId);
      if(instance && instance.element && instance.handler){
        instance.element.removeEventListener('gmp-select', instance.handler);
      }
      _autocompleteInstances.delete(inputId);
    }

    function getSystemTimezone() {
      try {
        return Intl.DateTimeFormat().resolvedOptions().timeZone;
      } catch (e) {
        return 'America/Chicago';
      }
    }

    const PERMISSIONS = {
      ITEMS_VIEW: 'items:view',
      ITEMS_CREATE: 'items:create',
      ITEMS_EDIT: 'items:edit',
      ITEMS_DELETE: 'items:delete',
      ITEMS_RESTORE: 'items:restore',
      ITEMS_EXPORT: 'items:export',
      ITEMS_IMPORT: 'items:import',
      ORDERS_VIEW: 'orders:view',
      ORDERS_CREATE: 'orders:create',
      ORDERS_EDIT: 'orders:edit',
      ORDERS_DELETE: 'orders:delete',
      ORDERS_RESTORE: 'orders:restore',
      ORDERS_MANAGE_SHIPPING: 'orders:manage_shipping',
      RECEIVING_VIEW: 'receiving:view',
      RECEIVING_CREATE: 'receiving:create',
      RECEIVING_EDIT: 'receiving:edit',
      RECEIVING_APPROVE: 'receiving:approve',
      RECEIVING_VOID: 'receiving:void',
      MEMBERS_VIEW: 'members:view',
      MEMBERS_INVITE: 'members:invite',
      MEMBERS_REMOVE: 'members:remove',
      MEMBERS_CHANGE_ROLE: 'members:change_role',
      COMPANY_VIEW_SETTINGS: 'company:view_settings',
      COMPANY_EDIT_SETTINGS: 'company:edit_settings',
      AUDIT_LOG_VIEW: 'audit_log:view',
      METRICS_VIEW: 'metrics:view',
      SNAPSHOTS_VIEW: 'snapshots:view',
      PLATFORM_VIEW_ALL: 'platform:view_all_companies',
      PLATFORM_MANAGE_ROLES: 'platform:manage_roles',
      PLATFORM_VIEW_METRICS: 'platform:view_metrics',
    };
    const LEGACY_PERMISSION_MAP = {
      [PERMISSIONS.ITEMS_VIEW]: { any:['can_read'] },
      [PERMISSIONS.ITEMS_CREATE]: { any:['can_create'] },
      [PERMISSIONS.ITEMS_EDIT]: { any:['can_update'] },
      [PERMISSIONS.ITEMS_DELETE]: { any:['can_delete'] },
      [PERMISSIONS.ITEMS_RESTORE]: { any:['can_delete'] },
      [PERMISSIONS.ITEMS_EXPORT]: { any:['can_read'] },
      [PERMISSIONS.ITEMS_IMPORT]: { all:['can_create','can_update'] },
      [PERMISSIONS.ORDERS_VIEW]: { any:['can_read'] },
      [PERMISSIONS.ORDERS_CREATE]: { any:['can_create'] },
      [PERMISSIONS.ORDERS_EDIT]: { any:['can_update'] },
      [PERMISSIONS.ORDERS_DELETE]: { any:['can_delete'] },
      [PERMISSIONS.ORDERS_RESTORE]: { any:['can_delete'] },
      [PERMISSIONS.MEMBERS_VIEW]: { any:['can_manage_users','can_invite'] },
      [PERMISSIONS.MEMBERS_INVITE]: { any:['can_invite'] },
      [PERMISSIONS.MEMBERS_REMOVE]: { any:['can_manage_users'] },
      [PERMISSIONS.MEMBERS_CHANGE_ROLE]: { any:['can_manage_users'] },
      [PERMISSIONS.AUDIT_LOG_VIEW]: { any:['can_invite'] },
      [PERMISSIONS.METRICS_VIEW]: { any:['can_invite'] },
      [PERMISSIONS.SNAPSHOTS_VIEW]: { any:['can_delete'] },
      [PERMISSIONS.PLATFORM_VIEW_ALL]: { any:['is_super_user'] },
      [PERMISSIONS.PLATFORM_MANAGE_ROLES]: { any:['is_super_user'] },
      [PERMISSIONS.PLATFORM_VIEW_METRICS]: { any:['is_super_user'] },
    };
    const IMPERSONATION_ROLES = IMUtils.buildImpersonationRoleOptions
      ? IMUtils.buildImpersonationRoleOptions(['super_user','admin','member','viewer'])
      : ['super_user','admin','member','viewer'];
    const IMPERSONATION_LOG_LIMIT = 25;
    const UI_VISIBILITY = (window.UI_VISIBILITY && typeof window.UI_VISIBILITY === 'object')
      ? window.UI_VISIBILITY
      : {
          inventory_action: {
            row: {
              edit_item: ['admin','super_user'],
              add_to_job: ['user','admin','super_user'],
              order_item: ['user','admin','super_user'],
              delete_item: ['admin','super_user']
            }
          }
        };
    if(!window.UI_VISIBILITY){
      window.UI_VISIBILITY = UI_VISIBILITY;
    }
    const TIER_ORDER = ['starter','professional','business','enterprise'];
    const TIER_LABELS = {
      starter: 'Starter',
      professional: 'Professional',
      business: 'Business',
      enterprise: 'Enterprise'
    };
    const TIER_FALLBACK = 'starter';
    function getCompanyStorageKey(){
      const uid = (SB && SB.user && SB.user.id) ? String(SB.user.id) : 'anon';
      return `${COMPANY_STORAGE_PREFIX}.${uid}`;
    }
    function readSavedCompanyId(){
      try{
        const raw = localStorage.getItem(getCompanyStorageKey());
        const id = String(raw || '').trim();
        return id || null;
      }catch(e){ return null; }
    }
    function saveCompanyId(companyId){
      try{
        const id = String(companyId || '').trim();
        if(!id) return;
        localStorage.setItem(getCompanyStorageKey(), id);
        state._defaultCompanyId = id;
      }catch(e){}
    }
    async function sbLoadCompanies(){
      SB.companies = [];
      SB.companyId = null;
      SB.company = null;
      if(!SB.ready || !SB.user) return null;
      // First load with production only
      const { data, error } = await SB.client.rpc('get_my_companies', { p_include_non_production: false });
      if(error) throw error;
      let rows = Array.isArray(data) ? data : [];
      // If user is super user (any row has is_super_user=true), reload with all company types
      const isSuperUserFromRows = rows.some(r => r.is_super_user === true);
      if(isSuperUserFromRows && rows.length > 0){
        const { data: allData, error: allError } = await SB.client.rpc('get_my_companies', { p_include_non_production: true });
        if(!allError && Array.isArray(allData)){
          rows = allData;
        }
      }
      SB.companies = rows;
      let selected = readSavedCompanyId();
      if(selected && !rows.some(r => String(r.company_id) === String(selected))) selected = null;
      if(!selected && rows.length) selected = rows[0].company_id;
      SB.companyId = selected ? String(selected) : null;
      state._defaultCompanyId = SB.companyId ? String(SB.companyId) : null;
      SB.company = SB.companyId ? rows.find(r => String(r.company_id) === String(SB.companyId)) || null : null;
      SB.companyTier = SB.company ? getCompanyTier() : null;
      if(SB.companyId) saveCompanyId(SB.companyId);
      return SB.companyId;
    }
    async function sbLoadPermissions(){
      SB.permissions = null;
      if(!SB.ready || !SB.user || !SB.companyId) return null;
      try{
        const { data, error } = await SB.client.rpc('get_user_permissions', { p_company_id: SB.companyId });
        if(error) throw error;
        let merged = (data && typeof data === 'object') ? data : null;
        try{
          const { data: meta } = await SB.client.rpc('get_my_permissions', { p_company_id: SB.companyId });
          if(meta && typeof meta === 'object'){
            merged = merged ? { ...meta, ...merged } : meta;
          }
        }catch(metaErr){}
        SB.permissions = merged;
        return SB.permissions;
      }catch(e){
        const { data, error } = await SB.client.rpc('get_my_permissions', { p_company_id: SB.companyId });
        if(error) throw error;
        SB.permissions = (data && typeof data === 'object') ? data : null;
        return SB.permissions;
      }
    }
    function sbInit(){
      const url = window.SB_URL, key = window.SB_ANON;
      if(!url || !key || SB.client){ return; }
      try{
        if(!window.supabase || typeof window.supabase.createClient !== 'function'){
          console.warn('Supabase library not loaded; running in offline mode');
          SB.ready = false;
          return;
        }
        SB.client = window.supabase.createClient(url, key);
        SB.ready = true;
      }catch(err){
        console.warn('Supabase init failed:', err);
        SB.ready = false;
      }
    }
    function formatRoleBadgeLabel(role){
      const value = String(role || '').trim().toLowerCase();
      if(value === 'super_user') return 'SUPER USER';
      if(value === 'admin') return 'ADMIN';
      if(value === 'member' || value === 'user') return 'USER';
      if(value === 'viewer') return 'VIEWER';
      return 'GUEST';
    }
    function renderProfileHeaderInfo(){
      const emailEl = $('profileEmail');
      const companyEl = $('profileCompanyName');
      const roleEl = $('profileRoleBadge');
      const email = SB.session?.user?.email || (SB.ready ? 'Not signed in' : 'Not configured');
      if(emailEl) emailEl.textContent = email;
      const companyName = SB.company ? String(SB.company.company_name || SB.company.company_slug || SB.company.company_id || '').trim() : '';
      if(companyEl) companyEl.textContent = companyName || 'No company selected';
      const roleLabel = SB.session ? formatRoleBadgeLabel(getEffectiveRole()) : 'GUEST';
      if(roleEl) roleEl.textContent = roleLabel;
    }
    function setProfileMenuItemVisibility(id, allowed){
      const el = $(id);
      if(!el) return;
      if(allowed){
        el.style.display = '';
        el.setAttribute('aria-hidden', 'false');
        el.disabled = false;
        el.removeAttribute('aria-disabled');
        return;
      }
      el.style.display = 'none';
      el.setAttribute('aria-hidden', 'true');
    }
    function updateProfileTeamEmpty(){
      const empty = $('profileTeamEmpty');
      if(!empty) return;
      const ids = ['openInviteModal','openUserMgmt','openRoleManager','openRoleRequests'];
      const anyVisible = ids.some((id) => {
        const el = $(id);
        return el && el.style.display !== 'none';
      });
      empty.style.display = anyVisible ? 'none' : '';
    }
    function setProfileTab(tabKey, opts = {}){
      const tabs = Array.from(document.querySelectorAll('#profileTabList .profile-tab'));
      const panels = Array.from(document.querySelectorAll('#profileTabPanels .profile-panel'));
      if(!tabs.length) return;
      const desired = String(tabKey || '').trim();
      const resolved = tabs.some(tab => tab.dataset.tab === desired) ? desired : 'account';
      const current = tabs.find(tab => tab.classList.contains('is-active'));
      if(current && current.dataset.tab === resolved && !opts.force) return;
      tabs.forEach(tab => {
        const active = tab.dataset.tab === resolved;
        tab.classList.toggle('is-active', active);
        tab.setAttribute('aria-selected', active ? 'true' : 'false');
        tab.tabIndex = active ? 0 : -1;
      });
      panels.forEach(panel => {
        const active = panel.dataset.panel === resolved;
        if(active){
          panel.classList.add('is-active');
          panel.classList.remove('is-leaving');
          return;
        }
        if(panel.classList.contains('is-active')){
          panel.classList.add('is-leaving');
          setTimeout(() => {
            panel.classList.remove('is-active');
            panel.classList.remove('is-leaving');
          }, 160);
        }else{
          panel.classList.remove('is-active');
          panel.classList.remove('is-leaving');
        }
      });
      state._profileTab = resolved;
      try{ sessionStorage.setItem(PROFILE_TAB_STORAGE_KEY, resolved); }catch(e){}
    }
    function restoreProfileTab(){
      let target = state._profileTab;
      if(!target){
        try{ target = sessionStorage.getItem(PROFILE_TAB_STORAGE_KEY) || ''; }catch(e){}
      }
      setProfileTab(target || 'account', { force:true });
    }
    function initProfileTabs(){
      const tabList = $('profileTabList');
      if(!tabList || tabList._wired) return;
      tabList._wired = true;
      tabList.addEventListener('click', (e)=>{
        const btn = e.target.closest('.profile-tab');
        if(!btn) return;
        setProfileTab(btn.dataset.tab);
      });
      tabList.addEventListener('keydown', (e)=>{
        if(e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;
        const tabs = Array.from(tabList.querySelectorAll('.profile-tab'));
        if(!tabs.length) return;
        const idx = tabs.findIndex(tab => tab.classList.contains('is-active'));
        if(idx < 0) return;
        const dir = e.key === 'ArrowRight' ? 1 : -1;
        const nextIdx = (idx + dir + tabs.length) % tabs.length;
        const nextTab = tabs[nextIdx];
        if(nextTab){
          e.preventDefault();
          setProfileTab(nextTab.dataset.tab);
          nextTab.focus();
        }
      });
      const dropdown = $('profileDropdown');
      if(dropdown && !dropdown._keywired){
        dropdown._keywired = true;
        dropdown.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape'){
            closeProfileMenu();
            $('profileBtn')?.focus();
          }
        });
      }
    }
    function syncProfileTabsForRole(){
      const tabList = $('profileTabList');
      const panels = $('profileTabPanels');
      if(!tabList || !panels) return;
      const isSuper = !!(SB.session && isEffectiveSuperUser());
      let devTab = $('profileTabDeveloper');
      let devPanel = $('profilePanelDeveloper');
      if(isSuper){
        if(!devTab){
          devTab = document.createElement('button');
          devTab.className = 'profile-tab';
          devTab.type = 'button';
          devTab.id = 'profileTabDeveloper';
          devTab.dataset.tab = 'developer';
          devTab.setAttribute('role', 'tab');
          devTab.setAttribute('aria-selected', 'false');
          devTab.setAttribute('aria-controls', 'profilePanelDeveloper');
          devTab.tabIndex = -1;
          devTab.textContent = 'Developer';
          tabList.appendChild(devTab);
        }
        if(!devPanel){
          devPanel = document.createElement('div');
          devPanel.className = 'profile-panel';
          devPanel.id = 'profilePanelDeveloper';
          devPanel.dataset.panel = 'developer';
          devPanel.setAttribute('role', 'tabpanel');
          devPanel.setAttribute('aria-labelledby', 'profileTabDeveloper');
          devPanel.tabIndex = 0;
          devPanel.innerHTML = `
            <button class="profile-item" id="openAdvancedCompanySwitcher" type="button">
              <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              </svg>
              <span>Manage Companies</span>
            </button>
            <button class="profile-item" id="openDiagnostics" type="button">
              <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M3 3v18h18"></path>
                <path d="M18 17v-6"></path>
                <path d="M13 17v-9"></path>
                <path d="M8 17v-3"></path>
              </svg>
              <span>Diagnostics</span>
            </button>
            <button class="profile-item" id="openProvisioningDashboard" type="button">
              <svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18"></path>
                <path d="M6 8h12"></path>
                <path d="M6 12h12"></path>
                <path d="M6 16h12"></path>
              </svg>
              <span>Companies</span>
            </button>
          `;
          panels.appendChild(devPanel);
        }
        wireDeveloperProfileActions();
      }else{
        if(devTab) devTab.remove();
        if(devPanel) devPanel.remove();
        if(state._profileTab === 'developer'){
          state._profileTab = 'account';
          try{ sessionStorage.setItem(PROFILE_TAB_STORAGE_KEY, 'account'); }catch(e){}
        }
      }
      initProfileTabs();
    }
    function closeProfileMenu(){
      const profileDropdown = $('profileDropdown');
      if(profileDropdown){
        profileDropdown.classList.remove('open');
        profileDropdown.style.display = '';
        profileDropdown.setAttribute('aria-hidden', 'true');
      }
      $('profileBtn')?.setAttribute('aria-expanded', 'false');
    }
    function updateRoleRequestsBadge(){
      const badge = $('roleRequestsBadge');
      if(!badge) return;
      const rows = Array.isArray(state._roleRequests) ? state._roleRequests : [];
      const count = rows.filter(row => String(row.status || '').trim() === 'pending').length || rows.length;
      if(count > 0){
        badge.textContent = String(count);
        badge.style.display = '';
      }else{
        badge.textContent = '0';
        badge.style.display = 'none';
      }
    }
    function setCompanySwitcherMode(mode){
      const modal = $('advancedCompanyModal');
      if(!modal) return;
      const nextMode = mode === 'advanced' ? 'advanced' : 'basic';
      state._companySwitcherMode = nextMode;
      modal.classList.toggle('company-switcher-basic', nextMode === 'basic');
      const title = $('advancedCompanyTitle');
      const subtitle = modal.querySelector('.modal-subtitle');
      if(title) title.textContent = nextMode === 'basic' ? 'Change User Company' : 'Manage Companies';
      if(subtitle){
        subtitle.textContent = nextMode === 'basic'
          ? 'Choose the workspace you want to access.'
          : 'Switching here is temporary and does not change the user\'s default company.';
      }
      const badge = modal.querySelector('.manage-companies-badge');
      const meta = modal.querySelector('.manage-companies-header-meta');
      if(badge) badge.style.display = nextMode === 'basic' ? 'none' : '';
      if(meta) meta.style.display = nextMode === 'basic' ? 'none' : '';
    }
    function renderBasicCompanyResults(){
      const container = $('advancedCompanyResults');
      if(!container) return;
      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      if(!rows.length){
        container.innerHTML = '<div class="trash-empty">No companies available.</div>';
        return;
      }
      const header = '<thead><tr><th>Company</th><th>Role</th><th>Action</th></tr></thead>';
      const body = rows.map(row => {
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || 'Company';
        const id = String(row.company_id || '').trim();
        const role = row.is_super_user ? 'super_user' : String(row.my_role || '').trim();
        const roleLabel = role ? formatRoleBadgeLabel(role) : 'USER';
        const isCurrent = String(SB.companyId || '') === id;
        const actionLabel = isCurrent ? 'Current' : 'Switch';
        const disabled = isCurrent ? 'disabled aria-disabled="true"' : '';
        return (
          `<tr>` +
            `<td>` +
              `<div>${escapeHtml(name)}</div>` +
              `<div class="advanced-switcher-id">${escapeHtml(id)}</div>` +
            `</td>` +
            `<td>${escapeHtml(roleLabel)}</td>` +
            `<td><div class="advanced-switcher-row-actions">` +
              `<button class="btn-tertiary btn-sm" type="button" data-basic-switch="${escapeHtmlAttr(id)}" ${disabled}>${escapeHtml(actionLabel)}</button>` +
            `</div></td>` +
          `</tr>`
        );
      }).join('');
      container.innerHTML = `<table class="advanced-switcher-table">${header}<tbody>${body}</tbody></table>`;
      if(!container._basicWired){
        container._basicWired = true;
        container.addEventListener('click', async (e)=>{
          const btn = e.target.closest('[data-basic-switch]');
          if(!btn) return;
          const targetId = String(btn.getAttribute('data-basic-switch') || '').trim();
          if(!targetId || targetId === String(SB.companyId || '')) return;
          const ok = await sbSwitchCompany(targetId);
          if(ok){
            const row = (Array.isArray(SB.companies) ? SB.companies : [])
              .find(r => String(r.company_id || '') === targetId);
            const name = row ? String(row.company_name || row.company_slug || row.company_id || 'company') : 'company';
            toast(`Switched to ${name}`);
            renderBasicCompanyResults();
          }
        });
      }
    }
    async function openCompanySwitcherModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      setCompanySwitcherMode('basic');
      setAdvancedCompanyMessage('');
      renderBasicCompanyResults();
      show('advancedCompanyModal', true);
    }
    function updateStatusBar(){
      // Update profile dropdown UI
      const statusEl = $('profileStatus');
      const emailEl = $('profileEmail');
      const signInText = $('profileSignInText');
      const signInBtn = $('profileSignIn');

      // Icon SVGs
      const signInIcon = '<svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>';
      const signOutIcon = '<svg class="profile-item-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>';

      function setSignInUI(text, icon, danger){
        if(signInText) signInText.textContent = text;
        if(signInBtn){
          signInBtn.classList.toggle('profile-item--danger', !!danger);
          const svg = signInBtn.querySelector('svg');
          if(svg) svg.outerHTML = icon;
        }
      }

      if(statusEl) statusEl.classList.remove('online','offline','warning');
      renderCompanyEnvBadge();

      if(!SB.ready){
        if(emailEl) emailEl.textContent = 'Not configured';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Configure', signInIcon, false);
        renderProfileHeaderInfo();
        return;
      }
      if(!SB.session){
        if(emailEl) emailEl.textContent = 'Not signed in';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Sign In', signInIcon, false);
        renderProfileHeaderInfo();
        return;
      }

      // Show user email
      const userEmail = SB.session?.user?.email || 'Unknown user';
      if(emailEl) emailEl.textContent = userEmail;

      const testingLabel = isImpersonating() ? ` Â· Testing: ${getEffectiveRole()}` : '';
      if(!SB.authorized){
        const reason = (!SB.companyId) ? 'No company access' : ((!SB.permissions || !hasPermission(PERMISSIONS.ITEMS_VIEW)) ? 'Permission denied' : 'Not authorized');
        if(statusEl) statusEl.classList.add('warning');
        setSignInUI('Sign Out', signOutIcon, true);
        renderProfileHeaderInfo();
        return;
      }
      const companyName = (SB.company && SB.company.company_name) ? ` Â· ${SB.company.company_name}` : '';
      if(SB.connected){
        if(statusEl) statusEl.classList.add('online');
      }else{
        if(statusEl) statusEl.classList.add('offline');
      }
      setSignInUI('Sign Out', signOutIcon, true);
      renderProfileHeaderInfo();
    }
    function explainGate(){
      if(!SB.ready) return 'Supabase not configured';
      if(!SB.session) return 'Sign in required';
      if(!SB.companyId) return 'No company access';
      if(!SB.permissions || !hasPermission(PERMISSIONS.ITEMS_VIEW)) return 'Permission denied';
      if(!SB.authorized) return 'Not authorized';
      if(!SB.connected) return 'Offline â€“ edits disabled';
      return '';
    }
    async function checkServerHealth(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId){ SB.connected=false; updateStatusBar(); return false; }
      try{
        const { error } = await SB.client
          .from('inventory_items')
          .select('id', { head:true, count:'exact' })
          .eq('company_id', SB.companyId)
          .is('deleted_at', null)
          .limit(1);
        if(error) throw error;
        SB.connected = true;
      }catch(e){ SB.connected=false; }
      updateStatusBar();
      return SB.connected;
    }
    function isOnline(){ return SB.ready && !!SB.session && SB.authorized && SB.connected; }
    function requireOnline(){
      if(isOnline()) return true;
      const msg = explainGate();
      if(msg) toast(msg);
      if(!SB.session) show('authModal', true);
      return false;
    }
    function normalizeTier(value){
      const tier = String(value || '').trim().toLowerCase();
      return TIER_ORDER.includes(tier) ? tier : '';
    }
    function getCompanyTier(){
      const fromCompany = SB.company ? (SB.company.effective_tier || SB.company.company_tier || SB.company.tier || '') : '';
      const tier = normalizeTier(fromCompany);
      if(tier) return tier;
      if(SB.companyId && !SB.warnedTierMissing){
        SB.warnedTierMissing = true;
        console.warn('Company tier missing; defaulting to', TIER_FALLBACK);
      }
      return TIER_FALLBACK;
    }
    function hasTier(minTier){
      if(isEffectiveSuperUser()) return true;
      const current = normalizeTier(getCompanyTier()) || TIER_FALLBACK;
      const target = normalizeTier(minTier);
      if(!target) return true;
      return TIER_ORDER.indexOf(current) >= TIER_ORDER.indexOf(target);
    }
    function normalizeRoleName(value){
      if(IMUtils.normalizeImpersonationRole){
        return IMUtils.normalizeImpersonationRole(value, IMPERSONATION_ROLES);
      }
      const role = String(value || '').trim().toLowerCase();
      return IMPERSONATION_ROLES.includes(role) ? role : '';
    }
    function ensureImpersonationRole(value){
      if(IMUtils.ensureImpersonationRole){
        return IMUtils.ensureImpersonationRole(value, IMPERSONATION_ROLES);
      }
      return normalizeRoleName(value) || 'super_user';
    }
    function getImpersonationRoleOptions(){
      if(IMUtils.buildImpersonationRoleOptions){
        return IMUtils.buildImpersonationRoleOptions(IMPERSONATION_ROLES);
      }
      return IMPERSONATION_ROLES.slice();
    }
    function getAuthorityRole(){
      const raw = String((SB.company && SB.company.my_role) || (SB.permissions && SB.permissions.role) || '').trim();
      const normalized = normalizeRoleName(raw);
      if(normalized) return normalized;
      return isSuperUser() ? 'super_user' : '';
    }
    function isImpersonating(){
      const role = normalizeRoleName(state._impersonationRole);
      return !!(isSuperUser() && role && role !== 'super_user');
    }
    function getEffectiveRole(){
      if(isImpersonating()){
        return normalizeRoleName(state._impersonationRole) || 'super_user';
      }
      return getAuthorityRole();
    }
    function isEffectiveSuperUser(){
      return isSuperUser() && !isImpersonating();
    }
    function getEffectivePermissions(){
      if(isImpersonating() && state._impersonationPermissions && typeof state._impersonationPermissions === 'object'){
        return state._impersonationPermissions;
      }
      return SB.permissions;
    }
    function getImpersonationLogKey(){
      const userId = SB.user && SB.user.id ? String(SB.user.id) : 'anonymous';
      return `inv.impersonation.log.${userId}`;
    }
    function logImpersonationEvent(fromRole, toRole, reason){
      if(!SB.user) return;
      const entry = {
        ts: new Date().toISOString(),
        user_id: SB.user.id,
        company_id: SB.companyId || null,
        company_name: (SB.company && SB.company.company_name) ? SB.company.company_name : null,
        from: fromRole,
        to: toRole,
        reason: reason || 'manual',
      };
      try{
        const key = getImpersonationLogKey();
        const existing = JSON.parse(localStorage.getItem(key) || '[]');
        const list = Array.isArray(existing) ? existing : [];
        list.unshift(entry);
        if(list.length > IMPERSONATION_LOG_LIMIT) list.length = IMPERSONATION_LOG_LIMIT;
        localStorage.setItem(key, JSON.stringify(list));
      }catch(e){}
      console.info('[impersonation]', entry);
    }
    function resetImpersonationState(reason){
      const prev = normalizeRoleName(state._impersonationRole) || 'super_user';
      state._impersonationRole = 'super_user';
      state._impersonationPermissions = null;
      if(prev && prev !== 'super_user'){
        logImpersonationEvent(prev, 'super_user', reason || 'reset');
      }
    }
    async function loadImpersonationPermissions(role){
      if(!role || role === 'super_user') return null;
      const cached = state._roleConfigs && state._roleConfigs[role];
      if(cached && typeof cached === 'object') return cached;
      if(!SB.ready || !SB.session || !SB.client) return null;
      try{
        const { data, error } = await SB.client
          .from('role_configurations')
          .select('permissions')
          .eq('role_name', role)
          .maybeSingle();
        if(error) throw error;
        if(data && typeof data.permissions === 'object') return data.permissions;
        return {};
      }catch(e){
        console.warn('Impersonation permissions load failed:', e);
        return null;
      }
    }
    function refreshImpersonationUi(){
      updateStatusBar();
      renderRoleTestingSwitcher();
      renderInviteUi();
      renderRoleRequestUi();
      renderProfileMenuVisibility();
      renderAdvancedCompanySwitcherButton();
      renderProvisioningDashboardButton();
      renderDiagnosticsButton();
      renderSubscriptionManagerButton();
      renderCompanyLocationsButton();
      renderRoleRequestsAdminButton();
      renderRoleManagerButton();
      renderUserMgmtButton();
      renderUserMgmtControls();
      renderUserMgmtList();
      renderPendingInvitesSection();
      renderPendingInvitesList();
      renderTierAdminSection();
      applyPermissionUI();
      render();
    }
    async function setImpersonationRole(nextRole, reason){
      if(!isSuperUser()){
        resetImpersonationState('not_super_user');
        refreshImpersonationUi();
        return false;
      }
      const desired = ensureImpersonationRole(nextRole);
      const prev = normalizeRoleName(state._impersonationRole) || 'super_user';
      if(desired === 'super_user'){
        if(prev !== 'super_user'){
          resetImpersonationState(reason || 'manual');
          refreshImpersonationUi();
        }
        return true;
      }
      state._impersonationRole = desired;
      const permissions = await loadImpersonationPermissions(desired);
      state._impersonationPermissions = (permissions && typeof permissions === 'object') ? permissions : {};
      if(prev !== desired){
        logImpersonationEvent(prev, desired, reason || 'manual');
      }
      refreshImpersonationUi();
      return true;
    }
    function hasPermission(key){
      const permissions = getEffectivePermissions();
      if(!permissions || !key) return false;
      if(Object.prototype.hasOwnProperty.call(permissions, key)){
        return permissions[key] === true;
      }
      const legacy = LEGACY_PERMISSION_MAP[key];
      if(legacy && Array.isArray(legacy.any)){
        return legacy.any.some(k => permissions[k] === true);
      }
      if(legacy && Array.isArray(legacy.all)){
        return legacy.all.every(k => permissions[k] === true);
      }
      return false;
    }
    function requirePermission(key, message){
      if(hasPermission(key)) return true;
      toast(message || 'Permission denied');
      return false;
    }
    function isSuperUser(){
      if(SB.company && SB.company.is_super_user) return true;
      if(SB.permissions && SB.permissions.is_super_user === true) return true;
      const role = String((SB.company && SB.company.my_role) || (SB.permissions && SB.permissions.role) || '').trim();
      return role === 'super_user';
    }
    function canItemsView(){ return hasPermission(PERMISSIONS.ITEMS_VIEW); }
    function canItemsCreate(){ return hasPermission(PERMISSIONS.ITEMS_CREATE); }
    function canItemsEdit(){ return hasPermission(PERMISSIONS.ITEMS_EDIT); }
    function canItemsDelete(){ return hasPermission(PERMISSIONS.ITEMS_DELETE); }
    function canItemsRestore(){ return hasPermission(PERMISSIONS.ITEMS_RESTORE); }
    function canItemsExport(){ return hasTier('professional') && hasPermission(PERMISSIONS.ITEMS_EXPORT); }
    function canItemsImport(){ return hasTier('professional') && hasPermission(PERMISSIONS.ITEMS_IMPORT); }
    function canOrdersView(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_VIEW); }
    function canOrdersCreate(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_CREATE); }
    function canOrdersEdit(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_EDIT); }
    function canOrdersDelete(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_DELETE); }
    function canOrdersManageShipping(){ return hasTier('business') && hasPermission(PERMISSIONS.ORDERS_MANAGE_SHIPPING); }
    function canAccessCompanyLocations(){
      if(isEffectiveSuperUser()) return true;
      const role = getEffectiveRole();
      return role === 'admin';
    }
    function canManageCompanyLocations(){
      return canAccessCompanyLocations();
    }
    function canReceivingView(){ return hasTier('professional') && hasPermission(PERMISSIONS.RECEIVING_VIEW); }
    function canReceivingCreate(){ return hasTier('professional') && hasPermission(PERMISSIONS.RECEIVING_CREATE); }
    function canReceivingEdit(){ return hasTier('professional') && hasPermission(PERMISSIONS.RECEIVING_EDIT); }
    function canReceivingApprove(){ return hasTier('professional') && hasPermission(PERMISSIONS.RECEIVING_APPROVE); }
    function canReceivingVoid(){ return hasTier('enterprise') && hasPermission(PERMISSIONS.RECEIVING_VOID); }
    function canReceiveOrders(){
      return canReceivingCreate() || canReceivingEdit() || canReceivingApprove();
    }
    function canMembersView(){ return hasPermission(PERMISSIONS.MEMBERS_VIEW); }
    function canMembersInvite(){ return hasPermission(PERMISSIONS.MEMBERS_INVITE); }
    function canMembersRemove(){ return hasPermission(PERMISSIONS.MEMBERS_REMOVE); }
    function canMembersChangeRole(){ return hasPermission(PERMISSIONS.MEMBERS_CHANGE_ROLE); }
    function canAuditView(){ return hasPermission(PERMISSIONS.AUDIT_LOG_VIEW); }
    function canMetricsView(){ return hasPermission(PERMISSIONS.METRICS_VIEW); }
    function canSnapshotsView(){ return hasPermission(PERMISSIONS.SNAPSHOTS_VIEW); }
    function canPlatformMetricsView(){ return hasPermission(PERMISSIONS.PLATFORM_VIEW_METRICS); }
    function canManageRoles(){ return hasPermission(PERMISSIONS.PLATFORM_MANAGE_ROLES) || isEffectiveSuperUser(); }
    function canAccessTrash(){ return canItemsDelete() || canItemsRestore(); }
    function canAccessMembers(){ return canMembersView() && hasTier('business'); }
    function canAccessInvites(){ return canMembersInvite() && hasTier('business'); }
    function canAccessRoleRequestsAdmin(){ return canMembersChangeRole() && hasTier('business'); }
    function canAccessRoleRequestsSelf(){ return hasTier('business'); }
    function canAccessAuditLog(){
      return canAuditView() && hasTier('enterprise');
    }
    function canAccessSnapshots(){
      return canSnapshotsView() && hasTier('business');
    }
    function canAccessMetrics(){
      const allowCompany = canMetricsView() && hasTier('professional');
      const allowPlatform = canPlatformMetricsView() && isEffectiveSuperUser() && hasTier('professional');
      return allowCompany || allowPlatform;
    }
    function canAccessRoleManager(){
      return isEffectiveSuperUser() && canManageRoles() && hasTier('business');
    }
    function canCreate(){ return canItemsCreate(); }
    function canUpdate(){ return canItemsEdit(); }
    function canDelete(){ return canItemsDelete(); }
    function canInvite(){ return canMembersInvite(); }
    function canManageUsers(){ return canMembersChangeRole() || canMembersRemove(); }
    function applyPermissionUI(){
      const canRead = canItemsView();
      const allowSelect = canItemsCreate() || canItemsEdit() || canItemsDelete();
      const canBulk = canItemsImport();
      const setDisabled = (id, disabled) => {
        const el = $(id);
        if(!el) return;
        el.disabled = !!disabled;
        el.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      };
      setDisabled('menuImport', !canBulk);
      setDisabled('menuPaste', !canBulk);
      setDisabled('menuAddOne', !canItemsCreate());
      setDisabled('menuOrder', !canOrdersCreate());
      setDisabled('menuHistory', !canOrdersView());
      setDisabled('menuReceive', !canReceiveOrders());
      setDisabled('menuTrash', !canAccessTrash());
      setDisabled('menuAudit', !canAccessAuditLog());
      setDisabled('menuSnapshots', !canAccessSnapshots());
      setDisabled('menuMetrics', !canAccessMetrics());
      setDisabled('menuExport', !canItemsExport());
      setDisabled('menuReport', !canItemsView());
      setDisabled('btnOrderSubmit', !canOrdersCreate());
      setDisabled('btnOrderShippingManage', !canOrdersManageShipping());
      setDisabled('btnEditItemDelete', !canItemsDelete());
      setDisabled('btnReportBatchOrder', !canOrdersCreate());
      const chkAll = $('chkAll');
      if(chkAll) chkAll.disabled = !allowSelect;
      setEditHint();
    }

    // ---------- Auth + profile ----------
    function renderAuthUi(){
      const submit = $('btnAuthSubmit');
      const pw = $('authPassword');
      const pwLabel = $('authPasswordLabel');
      if(submit) submit.textContent = 'Sign In';
      if(pw) pw.autocomplete = 'current-password';
      if(pwLabel) pwLabel.textContent = 'Password';
    }
    function setAuthMessage(msg){
      const el = $('authMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setResetMessage(msg){
      const el = $('resetMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setRoleRequestMessage(msg){
      const el = $('roleRequestMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setRoleRequestsMessage(msg){
      const el = $('roleRequestsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setAuditMessage(msg){
      const el = $('auditMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function auditSearchText(row){
      const action = String(row.action || '').trim();
      const tableName = String(row.table_name || '').trim();
      const recordId = String(row.record_id || '').trim();
      const user = String(row.user_email || '').trim();
      const role = String(row.user_role || '').trim();
      const oldVals = row.old_values ? JSON.stringify(row.old_values) : '';
      const newVals = row.new_values ? JSON.stringify(row.new_values) : '';
      const changed = Array.isArray(row.changed_fields) ? row.changed_fields.join(' ') : '';
      return `${action} ${tableName} ${recordId} ${user} ${role} ${changed} ${oldVals} ${newVals}`.toLowerCase();
    }
    function filteredAuditRows(){
      const rows = Array.isArray(state._auditRows) ? state._auditRows : [];
      const raw = String(state._auditSearch || '').trim().toLowerCase();
      if(!raw) return rows;
      const tokens = raw.split(/\s+/g).filter(Boolean);
      return rows.filter(r => {
        const hay = auditSearchText(r);
        return tokens.every(t => hay.includes(t));
      });
    }
    function setUserMgmtMessage(msg){
      const el = $('userMgmtMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function renderAuditList(){
      const list = $('auditList');
      if(!list) return;
      const rows = filteredAuditRows();
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No audit entries.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const action = String(row.action || '').trim();
        const tableName = String(row.table_name || '').trim();
        const when = row.created_at ? formatEasternDateTime(row.created_at) : '';
        const user = String(row.user_email || '').trim();
        const role = String(row.user_role || '').trim();
        const summary = [action, tableName].filter(Boolean).join(' Â· ');
        const meta = [when, user, role].filter(Boolean).join(' Â· ');
        const oldVals = row.old_values ? JSON.stringify(row.old_values, null, 2) : '';
        const newVals = row.new_values ? JSON.stringify(row.new_values, null, 2) : '';
        const changed = Array.isArray(row.changed_fields) && row.changed_fields.length
          ? `Changed: ${row.changed_fields.join(', ')}`
          : '';
        return (
          `<details class="audit-card">`+
            `<summary>`+
              `<div class="audit-summary">`+
                `<div class="audit-title">${escapeHtml(summary || 'Entry')}</div>`+
                `<div class="audit-meta">${escapeHtml(meta)}</div>`+
              `</div>`+
              `<span class="audit-caret" aria-hidden="true">`+
                `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">`+
                  `<polyline points="9 18 15 12 9 6"></polyline>`+
                `</svg>`+
              `</span>`+
            `</summary>`+
            `<div class="audit-body">`+
              `${changed ? `<div class="audit-meta">${escapeHtml(changed)}</div>` : ''}`+
              `${oldVals ? `<div class="audit-json">Old: ${escapeHtml(oldVals)}</div>` : ''}`+
              `${newVals ? `<div class="audit-json">New: ${escapeHtml(newVals)}</div>` : ''}`+
            `</div>`+
          `</details>`
        );
      }).join('');
    }
    function buildAuditCsv(rows){
      const header = [
        'Audit ID',
        'Created At (UTC)',
        'Created (Eastern)',
        'Action',
        'Table',
        'Record ID',
        'User Email',
        'User Role',
        'Changed Fields',
        'Old Values',
        'New Values',
      ];
      const out = [header.map(csvEscape).join(',')];
      const list = Array.isArray(rows) ? rows : [];
      for(const row of list){
        const createdAt = String(row?.created_at || '').trim();
        const createdEastern = createdAt ? formatEasternDateTime(createdAt) : '';
        out.push([
          String(row?.id || '').trim(),
          createdAt,
          createdEastern,
          String(row?.action || '').trim(),
          String(row?.table_name || '').trim(),
          String(row?.record_id || '').trim(),
          String(row?.user_email || '').trim(),
          String(row?.user_role || '').trim(),
          Array.isArray(row?.changed_fields) ? row.changed_fields.join(' ') : '',
          row?.old_values ? JSON.stringify(row.old_values) : '',
          row?.new_values ? JSON.stringify(row.new_values) : '',
        ].map(csvEscape).join(','));
      }
      return '\ufeff' + out.join('\n');
    }
    async function downloadAuditCsv(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!hasTier('enterprise')){ toast('Audit log requires Enterprise tier'); return; }
      if(!canAuditView()){ toast('Permission denied'); return; }
      const btn = $('btnAuditDownload');
      const priorTitle = btn ? btn.getAttribute('title') : '';
      if(btn){ btn.disabled = true; btn.setAttribute('title', 'Downloadingâ€¦'); }
      try{
        const rows = filteredAuditRows();
        if(!rows.length){ toast('No audit entries to download'); return; }
        const csv = buildAuditCsv(rows);
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.download = `audit-log-${stamp}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toast(`Downloaded ${rows.length} audit entries`);
      }catch(e){
        toast((e && e.message) ? e.message : 'Download failed');
      }finally{
        if(btn){ btn.disabled = false; btn.setAttribute('title', priorTitle || 'Download CSV'); }
      }
    }
    async function refreshAuditLog(){
      const list = $('auditList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setAuditMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        if(!hasTier('enterprise')) throw new Error('Audit log requires Enterprise tier');
        if(!canAuditView()) throw new Error('Permission denied');
        const tableFilter = String(state._auditTableFilter || '').trim() || null;
        const actionFilter = String(state._auditActionFilter || '').trim() || null;
        const { data, error } = await SB.client.rpc('get_audit_log', {
          p_company_id: SB.companyId,
          p_limit: 50,
          p_offset: 0,
          p_table_name: tableFilter,
          p_action: actionFilter,
        });
        if(error) throw error;
        state._auditRows = Array.isArray(data) ? data : [];
        renderAuditList();
      }catch(e){
        state._auditRows = [];
        const msg = e && e.message ? e.message : 'Failed to load audit log';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openAuditModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!hasTier('enterprise')){ toast('Audit log requires Enterprise tier'); return; }
      if(!canAuditView()){ toast('Permission denied'); return; }
      show('auditModal', true);
      const tableFilter = $('auditTableFilter'); if(tableFilter) tableFilter.value = state._auditTableFilter || '';
      const actionFilter = $('auditActionFilter'); if(actionFilter) actionFilter.value = state._auditActionFilter || '';
      const searchFilter = $('auditSearchFilter'); if(searchFilter) searchFilter.value = state._auditSearch || '';
      await refreshAuditLog();
    }
    function closeAuditModal(){
      show('auditModal', false);
    }

    // Feature: inventory.snapshots.ui
    const SNAPSHOT_PREVIEW_LIMIT = 200;
    function setSnapshotsMessage(msg){
      const el = $('snapshotsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function showSnapshotList(){
      const list = $('snapshotsList');
      const preview = $('snapshotPreview');
      if(list) list.style.display = '';
      if(preview) preview.style.display = 'none';
      const body = $('snapshotPreviewBody'); if(body) body.innerHTML = '';
      setSnapshotsMessage('');
    }
    function renderSnapshotsList(){
      const list = $('snapshotsList');
      if(!list) return;
      const rows = Array.isArray(state._snapshots) ? state._snapshots : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No snapshots available.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const id = String(row && row.id ? row.id : '').trim();
        const name = String(row && row.name ? row.name : 'Snapshot').trim();
        const desc = String(row && row.description ? row.description : '').trim();
        const createdAt = row && row.created_at ? formatEasternDateTime(row.created_at) : '';
        const createdBy = String(row && row.created_by_email ? row.created_by_email : '').trim();
        const itemsCount = toInt(row && row.items_count ? row.items_count : 0, 0);
        const totalQty = toInt(row && row.total_quantity ? row.total_quantity : 0, 0);
        const type = String(row && row.snapshot_type ? row.snapshot_type : '').trim();
        const restoredAt = row && row.was_restored && row.restored_at ? formatEasternDateTime(row.restored_at) : '';
        const metaParts = [];
        if(createdAt) metaParts.push(`Created: ${createdAt}`);
        if(createdBy) metaParts.push(`By: ${createdBy}`);
        metaParts.push(`Items: ${itemsCount}`);
        metaParts.push(`Qty: ${totalQty}`);
        if(type) metaParts.push(`Type: ${type}`);
        if(restoredAt) metaParts.push(`Restored: ${restoredAt}`);
        const meta = metaParts.join(' | ');
        return (
          `<div class="snapshot-card">`+
            `<div>`+
              `<div class="snapshot-title">${escapeHtml(name)}</div>`+
              `${desc ? `<div class="muted">${escapeHtml(desc)}</div>` : ''}`+
              `<div class="snapshot-meta">${escapeHtml(meta)}</div>`+
            `</div>`+
            `<div>`+
              `<button class="btn-tertiary btn-sm" data-snapshot-preview-id="${escapeHtmlAttr(id)}">Preview</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    async function loadSnapshots(){
      const list = $('snapshotsList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setSnapshotsMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        if(!canAccessSnapshots()) throw new Error('Permission denied');
        const { data, error } = await SB.client.rpc('get_snapshots', { p_company_id: SB.companyId });
        if(error) throw error;
        state._snapshots = Array.isArray(data) ? data : [];
        renderSnapshotsList();
      }catch(e){
        state._snapshots = [];
        const msg = e && e.message ? e.message : 'Failed to load snapshots';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openSnapshotsModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.companyId){ toast('No company selected'); return; }
      if(!hasTier('business')){ toast('Snapshots require Business or Enterprise tier'); return; }
      if(!canSnapshotsView()){ toast('Permission denied'); return; }
      show('snapshotsModal', true);
      showSnapshotList();
      await loadSnapshots();
    }
    function closeSnapshotsModal(){
      show('snapshotsModal', false);
      showSnapshotList();
    }
    async function openSnapshotPreview(snapshotId){
      const list = $('snapshotsList');
      const preview = $('snapshotPreview');
      const body = $('snapshotPreviewBody');
      if(!snapshotId || !preview || !body) return;
      if(list) list.style.display = 'none';
      preview.style.display = '';
      body.innerHTML = `<tr><td colspan="5" class="muted">Loadingâ€¦</td></tr>`;
      setSnapshotsMessage('');
      try{
        const { data, error } = await SB.client
          .from('inventory_snapshots')
          .select('id,name,description,snapshot_type,items_count,total_quantity,created_at,restored_at,items_data')
          .eq('id', snapshotId)
          .eq('company_id', SB.companyId)
          .maybeSingle();
        if(error) throw error;
        const items = Array.isArray(data && data.items_data) ? data.items_data : [];
        const limited = items.slice(0, SNAPSHOT_PREVIEW_LIMIT);
        const metaParts = [];
        const name = String(data && data.name ? data.name : 'Snapshot').trim();
        const desc = String(data && data.description ? data.description : '').trim();
        const createdAt = data && data.created_at ? formatEasternDateTime(data.created_at) : '';
        const restoredAt = data && data.restored_at ? formatEasternDateTime(data.restored_at) : '';
        const count = toInt(data && data.items_count ? data.items_count : items.length, 0);
        const totalQty = toInt(data && data.total_quantity ? data.total_quantity : 0, 0);
        if(createdAt) metaParts.push(`Created: ${createdAt}`);
        metaParts.push(`Items: ${count}`);
        metaParts.push(`Qty: ${totalQty}`);
        if(data && data.snapshot_type) metaParts.push(`Type: ${String(data.snapshot_type)}`);
        if(restoredAt) metaParts.push(`Restored: ${restoredAt}`);
        if(items.length > SNAPSHOT_PREVIEW_LIMIT){
          metaParts.push(`Showing: ${SNAPSHOT_PREVIEW_LIMIT} of ${items.length}`);
        }
        const titleEl = $('snapshotPreviewTitle');
        if(titleEl) titleEl.textContent = name || 'Snapshot';
        const metaEl = $('snapshotPreviewMeta');
        if(metaEl) metaEl.textContent = metaParts.join(' | ');
        if(desc){
          setSnapshotsMessage(desc);
        }
        if(!limited.length){
          body.innerHTML = `<tr><td colspan="5" class="muted">No items in snapshot.</td></tr>`;
          return;
        }
        body.innerHTML = limited.map(item => {
          const label = String(item && item.name ? item.name : '').trim();
          const sku = String(item && item.sku ? item.sku : '').trim();
          const qty = toInt(item && item.quantity !== undefined ? item.quantity : item && item.qty, 0);
          const categoryId = String(item && item.category_id ? item.category_id : '').trim();
          const locationId = String(item && item.location_id ? item.location_id : '').trim();
          return (
            `<tr>`+
              `<td>${escapeHtml(label)}</td>`+
              `<td>${escapeHtml(sku)}</td>`+
              `<td>${escapeHtml(String(qty))}</td>`+
              `<td>${escapeHtml(categoryId)}</td>`+
              `<td>${escapeHtml(locationId)}</td>`+
            `</tr>`
          );
        }).join('');
      }catch(e){
        const msg = e && e.message ? e.message : 'Snapshot preview failed';
        body.innerHTML = `<tr><td colspan="5" class="muted">${escapeHtml(msg)}</td></tr>`;
      }
    }

    // Feature: inventory.metrics.dashboard
    function setMetricsMessage(msg){
      const el = $('metricsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function renderMetricsControls(){
      const viewSelect = $('metricsView');
      if(!viewSelect) return;
      const allowPlatform = canPlatformMetricsView() && isEffectiveSuperUser() && hasTier('professional');
      viewSelect.style.display = allowPlatform ? '' : 'none';
      if(!allowPlatform) viewSelect.value = 'company';
    }
    function openMetricsModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.companyId){ toast('No company selected'); return; }
      if(!canAccessMetrics()){
        if(!hasTier('professional')){
          toast('Metrics require Professional tier or higher');
          return;
        }
        toast('Permission denied');
        return;
      }
      show('metricsModal', true);
      renderMetricsControls();
      loadMetrics();
    }
    function closeMetricsModal(){
      show('metricsModal', false);
      setMetricsMessage('');
    }
    function formatMetricValue(value){
      const num = Number(value);
      if(!Number.isFinite(num)) return '0';
      return Math.round(num).toLocaleString();
    }
    function buildDailySummary(rows){
      const map = new Map();
      (rows || []).forEach(row => {
        const date = String(row && (row.date || row.metric_date) ? row.date || row.metric_date : '').slice(0, 10);
        if(!date) return;
        const entry = map.get(date) || { date, updates:0, deletes:0, restores:0, rollbacks:0, records:0 };
        const action = String(row && row.action_type ? row.action_type : '').toLowerCase();
        const count = toInt(row && row.action_count ? row.action_count : 0, 0);
        if(action === 'update') entry.updates += count;
        else if(action === 'delete' || action === 'bulk_delete') entry.deletes += count;
        else if(action === 'restore') entry.restores += count;
        else if(action === 'rollback') entry.rollbacks += count;
        entry.records += toInt(row && row.records_affected ? row.records_affected : 0, 0);
        map.set(date, entry);
      });
      return Array.from(map.values()).sort((a,b)=> (a.date < b.date ? 1 : -1));
    }
    function renderCompanyMetrics(data, days){
      const container = $('metricsContent');
      if(!container) return;
      const current = data && data.current ? data.current : {};
      const activity = data && data.activity ? data.activity : {};
      const daily = buildDailySummary(data && data.daily ? data.daily : []);
      const topUsers = Array.isArray(data && data.top_users ? data.top_users : []) ? data.top_users : [];
      const dailyRows = daily.map(row => (
        `<tr>`+
          `<td>${escapeHtml(String(row.date || ''))}</td>`+
          `<td>${escapeHtml(String(row.updates))}</td>`+
          `<td>${escapeHtml(String(row.deletes))}</td>`+
          `<td>${escapeHtml(String(row.restores))}</td>`+
          `<td>${escapeHtml(String(row.rollbacks))}</td>`+
          `<td>${escapeHtml(String(row.records))}</td>`+
        `</tr>`
      )).join('');
      const topUserRows = topUsers.map(user => (
        `<tr>`+
          `<td>${escapeHtml(String(user && (user.email || user.user_id) ? (user.email || user.user_id) : 'User'))}</td>`+
          `<td>${escapeHtml(formatMetricValue(user && user.total_actions ? user.total_actions : 0))}</td>`+
        `</tr>`
      )).join('');
      container.innerHTML =
        `<div class="metrics-section">`+
          `<h3>Current State</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.total_items)}</div><div class="metric-label">Total Items</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.total_quantity)}</div><div class="metric-label">Total Qty</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.low_stock_count)}</div><div class="metric-label">Low Stock</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.active_members)}</div><div class="metric-label">Team Members</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(current.snapshot_count)}</div><div class="metric-label">Snapshots</div></div>`+
          `</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Activity (Last ${escapeHtml(String(days))} Days)</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_updates)}</div><div class="metric-label">Updates</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_deletes)}</div><div class="metric-label">Deletes</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_restores)}</div><div class="metric-label">Restores</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_rollbacks)}</div><div class="metric-label">Rollbacks</div></div>`+
          `</div>`+
          `<div class="metrics-note">${formatMetricValue(activity.records_affected)} records affected | -${formatMetricValue(activity.quantity_removed)} qty | +${formatMetricValue(activity.quantity_added)} qty</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Daily Summary</h3>`+
          `${dailyRows ? `<table class="metrics-table"><thead><tr><th>Date</th><th>Updates</th><th>Deletes</th><th>Restores</th><th>Rollbacks</th><th>Records</th></tr></thead><tbody>${dailyRows}</tbody></table>` : '<div class="trash-empty">No activity recorded.</div>'}`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Top Contributors</h3>`+
          `${topUserRows ? `<table class="metrics-table"><thead><tr><th>User</th><th>Actions</th></tr></thead><tbody>${topUserRows}</tbody></table>` : '<div class="trash-empty">No activity in this period.</div>'}`+
        `</div>`;
    }
    function renderPlatformMetrics(data, days){
      const container = $('metricsContent');
      if(!container) return;
      const platform = data && data.platform ? data.platform : {};
      const activity = data && data.activity ? data.activity : {};
      const companies = Array.isArray(data && data.companies ? data.companies : []) ? data.companies : [];
      const daily = Array.isArray(data && data.daily ? data.daily : []) ? data.daily : [];
      const companyRows = companies.map(row => (
        `<tr>`+
          `<td>${escapeHtml(String(row && row.name ? row.name : row && row.id ? row.id : 'Company'))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.member_count ? row.member_count : 0))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.item_count ? row.item_count : 0))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.recent_actions ? row.recent_actions : 0))}</td>`+
        `</tr>`
      )).join('');
      const dailyRows = daily.map(row => (
        `<tr>`+
          `<td>${escapeHtml(String(row && row.date ? row.date : ''))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.total_actions ? row.total_actions : 0))}</td>`+
          `<td>${escapeHtml(formatMetricValue(row && row.active_companies ? row.active_companies : 0))}</td>`+
        `</tr>`
      )).join('');
      container.innerHTML =
        `<div class="metrics-section">`+
          `<h3>Platform Totals</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_companies)}</div><div class="metric-label">Companies</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_users)}</div><div class="metric-label">Users</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_items)}</div><div class="metric-label">Items</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(platform.total_orders)}</div><div class="metric-label">Orders</div></div>`+
          `</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Activity (Last ${escapeHtml(String(days))} Days)</h3>`+
          `<div class="metrics-grid">`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.total_actions)}</div><div class="metric-label">Total Actions</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.active_companies)}</div><div class="metric-label">Active Companies</div></div>`+
            `<div class="metric-card"><div class="metric-value">${formatMetricValue(activity.active_users)}</div><div class="metric-label">Active Users</div></div>`+
          `</div>`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Company Activity</h3>`+
          `${companyRows ? `<table class="metrics-table"><thead><tr><th>Company</th><th>Members</th><th>Items</th><th>Recent Actions</th></tr></thead><tbody>${companyRows}</tbody></table>` : '<div class="trash-empty">No company activity found.</div>'}`+
        `</div>`+
        `<div class="metrics-section">`+
          `<h3>Daily Activity</h3>`+
          `${dailyRows ? `<table class="metrics-table"><thead><tr><th>Date</th><th>Total Actions</th><th>Active Companies</th></tr></thead><tbody>${dailyRows}</tbody></table>` : '<div class="trash-empty">No activity recorded.</div>'}`+
        `</div>`;
    }
    async function loadMetrics(){
      const container = $('metricsContent');
      if(container) container.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setMetricsMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        const rangeEl = $('metricsRange');
        const viewEl = $('metricsView');
        const days = toInt(rangeEl ? rangeEl.value : 30, 30);
        const view = viewEl && viewEl.style.display !== 'none' ? String(viewEl.value || 'company') : 'company';
        if(view === 'platform' && canPlatformMetricsView() && isEffectiveSuperUser() && hasTier('professional')){
          const { data, error } = await SB.client.rpc('get_platform_dashboard_metrics', { p_days: days });
          if(error) throw error;
          const title = $('metricsTitle'); if(title) title.textContent = 'Platform Metrics';
          renderPlatformMetrics(data || {}, days);
          return;
        }
        const { data, error } = await SB.client.rpc('get_company_dashboard_metrics', { p_company_id: SB.companyId, p_days: days });
        if(error) throw error;
        const title = $('metricsTitle'); if(title) title.textContent = 'Metrics Dashboard';
        renderCompanyMetrics(data || {}, days);
      }catch(e){
        const msg = e && e.message ? e.message : 'Failed to load metrics';
        if(container) container.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function sbLoadMyRoleRequest(){
      if(!SB.ready || !SB.session || !SB.client) return null;
      if(!hasTier('business')) return null;
      const { data, error } = await SB.client
        .from('role_change_requests')
        .select('id, requested_role, current_role_name, reason, status, created_at')
        .eq('user_id', SB.user.id)
        .eq('status', 'pending')
        .order('created_at', { ascending:false })
        .limit(1);
      if(error) throw error;
      state._roleRequestPending = Array.isArray(data) && data.length ? data[0] : null;
      return state._roleRequestPending;
    }
    function renderRoleRequestUi(){
      const section = $('roleRequestSection');
      const current = $('roleRequestCurrent');
      const roleSelect = $('roleRequestRole');
      const reason = $('roleRequestReason');
      const btn = $('btnRoleRequest');
      if(!section || !roleSelect) return;
      if(!SB.session || !SB.permissions || !canAccessRoleRequestsSelf()){
        section.style.display = 'none';
        return;
      }
      const role = getEffectiveRole();
      if(role === 'super_user'){
        section.style.display = 'none';
        return;
      }
      section.style.display = '';
      const roleLabel = role ? (isImpersonating() ? `${role} (testing)` : role) : '';
      if(current) current.textContent = role ? `Current role: ${roleLabel}` : 'Current role: (unknown)';
      const pending = state._roleRequestPending;
      if(pending){
        roleSelect.innerHTML = `<option value="${escapeHtmlAttr(pending.requested_role || '')}" selected>${escapeHtml(pending.requested_role || 'pending')}</option>`;
        roleSelect.disabled = true;
        if(reason){ reason.value = pending.reason || ''; reason.disabled = true; }
        if(btn){ btn.disabled = true; btn.setAttribute('aria-disabled', 'true'); }
        setRoleRequestMessage('Pending request submitted.');
        return;
      }
      const roles = ['admin','member','viewer'];
      const available = role ? roles.filter(r => r !== role) : roles;
      roleSelect.innerHTML = available.map(r => `<option value="${escapeHtmlAttr(r)}">${escapeHtml(r)}</option>`).join('');
      roleSelect.disabled = !available.length;
      if(reason){ reason.disabled = false; if(!reason.value) reason.value = ''; }
      if(btn){
        const disabled = !available.length;
        btn.disabled = disabled;
        btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
      }
      setRoleRequestMessage('');
    }
    function renderRoleRequestsAdminButton(){
      const allow = !!(SB.session && SB.companyId && canAccessRoleRequestsAdmin());
      setProfileMenuItemVisibility('openRoleRequests', allow);
      updateRoleRequestsBadge();
      updateProfileTeamEmpty();
    }
    function renderRoleManagerButton(){
      const allow = !!(SB.session && canAccessRoleManager());
      setProfileMenuItemVisibility('openRoleManager', allow);
      updateProfileTeamEmpty();
    }
    function renderUserMgmtButton(){
      const allow = !!(SB.session && hasTier('business') && canMembersView());
      setProfileMenuItemVisibility('openUserMgmt', allow);
      updateProfileTeamEmpty();
    }
    function renderUserMgmtHeaderActions(){
      const addBtn = $('btnUserMgmtAdd');
      if(addBtn){
        const allowInvite = !!(SB.session && canAccessInvites());
        addBtn.disabled = !allowInvite;
        addBtn.setAttribute('aria-disabled', allowInvite ? 'false' : 'true');
      }
    }
    function renderAdvancedCompanySwitcherButton(){
      const allow = !!(SB.session && isEffectiveSuperUser());
      setProfileMenuItemVisibility('openAdvancedCompanySwitcher', allow);
    }
    function renderProvisioningDashboardButton(){
      const allow = !!(SB.session && isEffectiveSuperUser());
      setProfileMenuItemVisibility('openProvisioningDashboard', allow);
    }
    function renderDiagnosticsButton(){
      const allow = !!(SB.session && isEffectiveSuperUser());
      setProfileMenuItemVisibility('openDiagnostics', allow);
    }
    function renderSubscriptionManagerButton(){
      const allow = !!(SB.session && isEffectiveSuperUser());
      setProfileMenuItemVisibility('openSubscriptionManager', allow);
    }
    function renderCompanyLocationsButton(){
      const allow = !!(SB.session && SB.companyId && canAccessCompanyLocations());
      setProfileMenuItemVisibility('openCompanyLocations', allow);
    }
    function renderUserMgmtControls(){
      const controls = $('userMgmtControls');
      const select = $('userMgmtCompany');
      if(!controls || !select) return;
      renderUserMgmtHeaderActions();
      if(!SB.session || !isEffectiveSuperUser()){
        controls.style.display = 'none';
        return;
      }
      controls.style.display = '';
      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      select.innerHTML = '';
      if(!rows.length){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No companies available';
        select.appendChild(opt);
        select.disabled = true;
        _userMgmtCompanyId = '';
        return;
      }
      rows.forEach(row => {
        const id = String(row && row.company_id ? row.company_id : '').trim();
        if(!id) return;
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || id;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = name;
        select.appendChild(opt);
      });
      let desired = _userMgmtCompanyId;
      if(desired && !rows.some(r => String(r.company_id) === desired)) desired = '';
      if(!desired) desired = SB.companyId ? String(SB.companyId) : String(rows[0].company_id || '');
      _userMgmtCompanyId = desired || '';
      if(_userMgmtCompanyId) select.value = _userMgmtCompanyId;
      select.disabled = rows.length <= 1;
      renderPendingInvitesSection();
    }
    function getUserMgmtCompanyId(){
      if(isEffectiveSuperUser()){
        return String(_userMgmtCompanyId || SB.companyId || '').trim();
      }
      return SB.companyId ? String(SB.companyId).trim() : '';
    }
    function renderUserMgmtList(){
      const list = $('userMgmtList');
      if(!list) return;
      const rows = Array.isArray(state._userMgmtRows) ? state._userMgmtRows : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No users found.</div>`;
        return;
      }
      const currentUserId = SB.user && SB.user.id ? String(SB.user.id) : '';
      const roleOptions = ['admin','member','viewer'];
      list.innerHTML = rows.map(row => {
        const userId = String(row.user_id || '').trim();
        const profile = row.profile || {};
        const name = [profile.first_name, profile.last_name].filter(Boolean).join(' ').trim();
        const email = String(profile.email || row.email || '').trim();
        const displayName = name || email || 'User';
        const isSelf = currentUserId && userId === currentUserId;
        const isSuper = !!row.is_super_user;
        const currentRole = roleOptions.includes(String(row.role || '').trim()) ? String(row.role || '').trim() : 'member';
        const canEditRole = !!(canMembersChangeRole() && !isSuper && !isSelf);
        const canRemove = !!(canMembersRemove() && !isSuper && !isSelf);
        const joined = row.created_at ? formatEasternDateTime(row.created_at) : '';
        const metaParts = [];
        if(name && email) metaParts.push(email);
        if(joined) metaParts.push(`Joined ${joined}`);
        if(isSelf) metaParts.push('You');
        if(isSuper) metaParts.push('Super user');
        const roleSelect = isSuper
          ? `<select class="user-mgmt-role" disabled aria-disabled="true"><option selected>super_user</option></select>`
          : `<select class="user-mgmt-role" data-user-role-id="${escapeHtmlAttr(userId)}" data-current-role="${escapeHtmlAttr(currentRole)}" data-user-name="${escapeHtmlAttr(displayName)}" ${canEditRole ? '' : 'disabled aria-disabled="true"'}>`+
              roleOptions.map(r => `<option value="${escapeHtmlAttr(r)}"${r === currentRole ? ' selected' : ''}>${escapeHtml(r)}</option>`).join('')+
            `</select>`;
        const roleAction =
          `<div class="user-mgmt-action">`+
            `<svg class="user-mgmt-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
              `<path d="M12 20h9"></path>`+
              `<path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>`+
            `</svg>`+
            roleSelect+
          `</div>`;
        const removeAction =
          `<button class="btn-tertiary btn-sm user-mgmt-action-btn" data-user-remove-id="${escapeHtmlAttr(userId)}" data-user-name="${escapeHtmlAttr(displayName)}"${canRemove ? '' : ' disabled aria-disabled="true"'}>`+
            `<svg class="user-mgmt-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
              `<polyline points="3 6 5 6 21 6"></polyline>`+
              `<path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"></path>`+
              `<path d="M10 11v6"></path>`+
              `<path d="M14 11v6"></path>`+
              `<path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"></path>`+
            `</svg>`+
            `Remove`+
          `</button>`;
        return (
          `<div class="user-mgmt-card">`+
            `<div>`+
              `<div class="user-mgmt-name">${escapeHtml(displayName)}</div>`+
              `${metaParts.length ? `<div class="user-mgmt-meta">${escapeHtml(metaParts.join(' Â· '))}</div>` : ''}`+
            `</div>`+
            `<div class="user-mgmt-actions">`+
              roleAction+
              removeAction+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    function setPendingInvitesMessage(msg){
      const el = $('pendingInvitesMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function canAccessPendingInvites(){
      if(!SB.session) return false;
      if(isEffectiveSuperUser()) return true;
      const role = getEffectiveRole();
      if(role !== 'admin') return false;
      return canAccessInvites();
    }
    function renderPendingInvitesSection(){
      const section = $('pendingInvitesSection');
      if(!section) return;
      const allow = !!(SB.session && canAccessPendingInvites());
      section.style.display = allow ? '' : 'none';
    }
    function isInviteExpired(invite){
      const status = String(invite && invite.status ? invite.status : '').trim().toLowerCase();
      if(status === 'expired') return true;
      const expiresAt = invite && invite.expires_at ? new Date(invite.expires_at).getTime() : NaN;
      if(Number.isFinite(expiresAt) && expiresAt <= Date.now()) return true;
      return false;
    }
    function renderPendingInvitesList(){
      const list = $('pendingInvitesList');
      if(!list) return;
      const rows = Array.isArray(state._pendingInvites) ? state._pendingInvites : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No pending invites.</div>`;
        return;
      }
      const busyMap = state._pendingInviteBusy || {};
      const allowActions = canAccessPendingInvites();
      const header = (
        `<thead><tr>`+
          `<th>Email</th>`+
          `<th>Role</th>`+
          `<th>Sent At</th>`+
          `<th>Last Sent At</th>`+
          `<th>Expires At</th>`+
          `<th>Status</th>`+
          `<th>Resends</th>`+
          `<th>Actions</th>`+
        `</tr></thead>`
      );
      const body = rows.map(row => {
        const id = String(row.id || '').trim();
        const email = String(row.email || '').trim();
        const role = String(row.role || '').trim();
        const sentAt = row.sent_at ? formatEasternDateTime(row.sent_at) : 'â€”';
        const lastSentAt = row.last_sent_at ? formatEasternDateTime(row.last_sent_at) : 'â€”';
        const expiresAt = row.expires_at ? formatEasternDateTime(row.expires_at) : 'â€”';
        const resendCount = Number.isFinite(row.resend_count) ? row.resend_count : toInt(row.resend_count, 0);
        const expired = isInviteExpired(row);
        const status = expired ? 'expired' : 'pending';
        const busy = id ? String(busyMap[id] || '') : '';
        const isResendBusy = busy === 'resend';
        const isRevokeBusy = busy === 'revoke';
        const resendDisabled = !allowActions || expired || isResendBusy || isRevokeBusy;
        const revokeDisabled = !allowActions || isRevokeBusy || isResendBusy;
        const resendLabel = isResendBusy ? 'Resendingâ€¦' : 'Resend Invite';
        const revokeLabel = isRevokeBusy ? 'Revokingâ€¦' : 'Revoke Invite';
        return (
          `<tr class="${expired ? 'invite-row-expired' : ''}">`+
            `<td>${escapeHtml(email || 'â€”')}</td>`+
            `<td>${escapeHtml(role || 'member')}</td>`+
            `<td>${escapeHtml(sentAt)}</td>`+
            `<td>${escapeHtml(lastSentAt)}</td>`+
            `<td>${escapeHtml(expiresAt)}</td>`+
            `<td><span class="invite-status ${status}">${escapeHtml(status)}</span></td>`+
            `<td>${escapeHtml(String(resendCount))}</td>`+
            `<td>`+
              `<div class="pending-invites-actions">`+
                `<button class="btn-tertiary btn-sm" data-invite-resend-id="${escapeHtmlAttr(id)}"${resendDisabled ? ' disabled aria-disabled="true"' : ''}>${escapeHtml(resendLabel)}</button>`+
                `<button class="btn-tertiary btn-sm btn-danger" data-invite-revoke-id="${escapeHtmlAttr(id)}" data-invite-email="${escapeHtmlAttr(email)}"${revokeDisabled ? ' disabled aria-disabled="true"' : ''}>${escapeHtml(revokeLabel)}</button>`+
              `</div>`+
            `</td>`+
          `</tr>`
        );
      }).join('');
      list.innerHTML = (
        `<div class="pending-invites-table-wrap">`+
          `<table class="metrics-table pending-invites-table">${header}<tbody>${body}</tbody></table>`+
        `</div>`
      );
    }
    async function refreshPendingInvites(){
      const list = $('pendingInvitesList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setPendingInvitesMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) return;
        if(!canAccessPendingInvites()){
          state._pendingInvites = [];
          renderPendingInvitesList();
          return;
        }
        const companyId = getUserMgmtCompanyId();
        if(!companyId) throw new Error('No company selected');
        const { data, error } = await SB.client
          .from('company_invites')
          .select('id,email,role,sent_at,last_sent_at,expires_at,status,resend_count')
          .eq('company_id', companyId)
          .order('sent_at', { ascending: false });
        if(error) throw error;
        state._pendingInvites = Array.isArray(data) ? data : [];
        renderPendingInvitesList();
      }catch(e){
        state._pendingInvites = [];
        const msg = e && e.message ? e.message : 'Failed to load invites';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function sbResendCompanyInvite(inviteId){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!canAccessPendingInvites()) throw Error('Permission denied');
      const id = String(inviteId || '').trim();
      if(!id) throw Error('Invite required');
      const apiUrl = getInviteSendUrl();
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        if(SB.session && SB.session.access_token){
          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
        }
      }
      const baseUrl = `${window.location.origin}${window.location.pathname}`.replace(/\?[^#]*$/, '');
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify({ invite_id: id, app_url: baseUrl }),
      });
      const data = await res.json().catch(() => ({}));
      if(!res.ok){
        const err = data && data.error ? data.error : 'Resend failed';
        const error = new Error(err);
        error.details = data;
        throw error;
      }
      if(data && data.ok === false) throw new Error(data.error || 'Resend failed');
      return data || null;
    }
    async function sbRevokeCompanyInvite(inviteId){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!canAccessPendingInvites()) throw Error('Permission denied');
      const companyId = getUserMgmtCompanyId();
      if(!companyId) throw Error('No company selected');
      const id = String(inviteId || '').trim();
      if(!id) throw Error('Invite required');
      const { error } = await SB.client
        .from('company_invites')
        .delete()
        .eq('id', id)
        .eq('company_id', companyId);
      if(error) throw error;
    }
    async function refreshUserMgmtAll(){
      await refreshUserMgmt();
      await refreshPendingInvites();
    }
    async function refreshUserMgmt(){
      const list = $('userMgmtList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setUserMgmtMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!hasTier('business')) throw new Error('User management requires Business tier');
        if(!canMembersView()) throw new Error('Permission denied');
        const companyId = getUserMgmtCompanyId();
        if(!companyId) throw new Error('No company selected');
        const { data, error } = await SB.client
          .from('company_members')
          .select('user_id,role,is_super_user,invited_by,assigned_admin_id,created_at')
          .eq('company_id', companyId)
          .order('created_at', { ascending:true });
        if(error) throw error;
        const rows = Array.isArray(data) ? data : [];
        const userIds = rows.map(r => r.user_id).filter(Boolean);
        let profileMap = new Map();
        if(userIds.length){
          const { data: profiles, error: profErr } = await SB.client
            .from('profiles')
            .select('user_id,email,first_name,last_name')
            .in('user_id', userIds);
          if(profErr) throw profErr;
          profileMap = new Map((profiles || []).map(p => [String(p.user_id), p]));
        }
        state._userMgmtRows = rows.map(r => ({
          ...r,
          profile: profileMap.get(String(r.user_id)) || null,
        }));
        renderUserMgmtList();
      }catch(e){
        state._userMgmtRows = [];
        const msg = e && e.message ? e.message : 'Failed to load users';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openUserMgmtModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!hasTier('business')){ toast('User management requires Business tier'); return; }
      if(!canMembersView()){ toast('Permission denied'); return; }
      renderUserMgmtControls();
      renderUserMgmtHeaderActions();
      renderPendingInvitesSection();
      show('userMgmtModal', true);
      await refreshUserMgmtAll();
    }
    function closeUserMgmtModal(){
      show('userMgmtModal', false);
    }
    function openInviteFromUserMgmt(){
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!hasTier('business')){ toast('Invites require Business tier'); return; }
      if(!canMembersInvite()){ toast('Permission denied'); return; }
      show('userMgmtModal', false);
      renderInviteUi();
      show('inviteModal', true);
    }
    function openSubscriptionManagerModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!isEffectiveSuperUser()){ toast('Super user access required'); return; }
      if(!SB.companyId){ toast('Select a company first.'); return; }
      renderTierAdminSection();
      show('subscriptionManagerModal', true);
    }
    function closeSubscriptionManagerModal(){
      show('subscriptionManagerModal', false);
    }
    async function openTierOverrideFromUserMgmt(){
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!isEffectiveSuperUser()){ toast('Super user access required'); return; }
      const targetCompanyId = getUserMgmtCompanyId();
      if(!targetCompanyId){ toast('No company selected'); return; }
      show('userMgmtModal', false);
      if(String(targetCompanyId) !== String(SB.companyId || '')){
        const ok = await openConfirmModal(
          'Switch company to update tier?',
          'Tier overrides apply to the selected company and will switch your active context.',
          { okText:'Switch', cancelText:'Cancel' }
        );
        if(!ok) return;
        const switched = await sbSwitchCompany(targetCompanyId, { persist:false, audit:true, source:'user_mgmt_tier' });
        if(!switched) return;
      }
      renderProfileUi();
      show('profileModal', true);
      const section = $('tierOverrideSection');
      if(section){
        section.scrollIntoView({ behavior:'smooth', block:'start' });
      }
    }
    // Feature: inventory.auth.roles
    const ROLE_PERMISSION_CATEGORIES = {
      'Inventory': [
        { key: PERMISSIONS.ITEMS_VIEW, label: 'View Items' },
        { key: PERMISSIONS.ITEMS_CREATE, label: 'Create Items' },
        { key: PERMISSIONS.ITEMS_EDIT, label: 'Edit Items' },
        { key: PERMISSIONS.ITEMS_DELETE, label: 'Delete Items' },
        { key: PERMISSIONS.ITEMS_RESTORE, label: 'Restore Items' },
        { key: PERMISSIONS.ITEMS_EXPORT, label: 'Export Items' },
        { key: PERMISSIONS.ITEMS_IMPORT, label: 'Import Items' },
      ],
      'Orders': [
        { key: PERMISSIONS.ORDERS_VIEW, label: 'View Orders' },
        { key: PERMISSIONS.ORDERS_CREATE, label: 'Create Orders' },
        { key: PERMISSIONS.ORDERS_EDIT, label: 'Edit Orders' },
        { key: PERMISSIONS.ORDERS_DELETE, label: 'Delete Orders' },
        { key: PERMISSIONS.ORDERS_RESTORE, label: 'Restore Orders' },
        { key: PERMISSIONS.ORDERS_MANAGE_SHIPPING, label: 'Manage Shipping Addresses' },
      ],
      'Receiving': [
        { key: PERMISSIONS.RECEIVING_VIEW, label: 'View Receipts' },
        { key: PERMISSIONS.RECEIVING_CREATE, label: 'Create Receipts' },
        { key: PERMISSIONS.RECEIVING_EDIT, label: 'Edit Draft Receipts' },
        { key: PERMISSIONS.RECEIVING_APPROVE, label: 'Complete Receipts' },
        { key: PERMISSIONS.RECEIVING_VOID, label: 'Void Receipts' },
      ],
      'Members': [
        { key: PERMISSIONS.MEMBERS_VIEW, label: 'View Members' },
        { key: PERMISSIONS.MEMBERS_INVITE, label: 'Invite Members' },
        { key: PERMISSIONS.MEMBERS_REMOVE, label: 'Remove Members' },
        { key: PERMISSIONS.MEMBERS_CHANGE_ROLE, label: 'Change Roles' },
      ],
      'Company': [
        { key: PERMISSIONS.COMPANY_VIEW_SETTINGS, label: 'View Settings' },
        { key: PERMISSIONS.COMPANY_EDIT_SETTINGS, label: 'Edit Settings' },
      ],
      'Audit and Metrics': [
        { key: PERMISSIONS.AUDIT_LOG_VIEW, label: 'View Audit Log' },
        { key: PERMISSIONS.METRICS_VIEW, label: 'View Metrics' },
        { key: PERMISSIONS.SNAPSHOTS_VIEW, label: 'View Snapshots' },
      ],
    };
    function setRoleManagerMessage(msg){
      const el = $('roleManagerMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    async function openRoleManagerModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!canAccessRoleManager()){
        toast(hasTier('business') ? 'Super user access required' : 'Role Manager requires Business tier');
        return;
      }
      show('roleManagerModal', true);
      await loadRoleConfigurations();
    }
    function closeRoleManagerModal(){
      show('roleManagerModal', false);
      state._roleChanges = {};
      setRoleManagerMessage('');
    }
    async function loadRoleConfigurations(){
      setRoleManagerMessage('');
      try{
        const { data, error } = await SB.client
          .from('role_configurations')
          .select('role_name,permissions');
        if(error) throw error;
        state._roleConfigs = {};
        (data || []).forEach(row => {
          const role = String(row && row.role_name ? row.role_name : '').trim();
          if(!role) return;
          state._roleConfigs[role] = row.permissions || {};
        });
        state._roleChanges = {};
        renderRoleManagerTable();
      }catch(e){
        const msg = e && e.message ? e.message : 'Failed to load roles';
        setRoleManagerMessage(msg);
      }
    }
    function renderRoleManagerTable(){
      const body = $('roleManagerBody');
      if(!body) return;
      const roles = ['admin','member','viewer'];
      let html = '';
      for(const [category, perms] of Object.entries(ROLE_PERMISSION_CATEGORIES)){
        html += `<tr class="role-manager-category"><td colspan="4">${escapeHtml(category)}</td></tr>`;
        perms.forEach(perm => {
          const key = perm.key;
          const label = perm.label;
          const cells = roles.map(role => {
            const current = state._roleChanges[role] || state._roleConfigs[role] || {};
            const checked = current[key] === true;
            return `<td><input type="checkbox" data-role="${escapeHtmlAttr(role)}" data-permission="${escapeHtmlAttr(key)}"${checked ? ' checked' : ''} /></td>`;
          }).join('');
          html += `<tr><td>${escapeHtml(label)}</td>${cells}</tr>`;
        });
      }
      body.innerHTML = html;
    }
    function handleRoleManagerToggle(target){
      const box = target && target.matches ? (target.matches('input[type="checkbox"][data-role][data-permission]') ? target : null) : null;
      if(!box) return;
      const role = String(box.dataset.role || '').trim();
      const perm = String(box.dataset.permission || '').trim();
      if(!role || !perm) return;
      if(!state._roleChanges[role]){
        state._roleChanges[role] = { ...(state._roleConfigs[role] || {}) };
      }
      state._roleChanges[role][perm] = !!box.checked;
    }
    async function saveRoleManagerChanges(){
      if(!canAccessRoleManager()){
        toast('Permission denied');
        return;
      }
      const entries = Object.entries(state._roleChanges || {});
      if(!entries.length){
        setRoleManagerMessage('No changes to save.');
        return;
      }
      setRoleManagerMessage('');
      try{
        for(const [role, permissions] of entries){
          const { error } = await SB.client
            .from('role_configurations')
            .update({
              permissions,
              updated_at: new Date().toISOString(),
              updated_by: SB.user ? SB.user.id : null,
            })
            .eq('role_name', role);
          if(error) throw error;
        }
        state._roleChanges = {};
        await loadRoleConfigurations();
        await sbLoadPermissions();
        applyPermissionUI();
        setRoleManagerMessage('Role permissions saved.');
        toast('Role permissions saved');
      }catch(e){
        const msg = e && e.message ? e.message : 'Save failed';
        setRoleManagerMessage(msg);
      }
    }
    async function sbUpdateMemberRole(userId, role){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!hasTier('business')) throw Error('Role changes require Business tier');
      if(!canMembersChangeRole()) throw Error('Permission denied');
      const companyId = getUserMgmtCompanyId();
      if(!companyId) throw Error('Company not selected');
      const uid = String(userId || '').trim();
      const cleanRole = String(role || '').trim();
      if(!uid) throw Error('User required');
      if(!cleanRole) throw Error('Role required');
      const { error } = await SB.client
        .from('company_members')
        .update({ role: cleanRole })
        .eq('company_id', companyId)
        .eq('user_id', uid);
      if(error) throw error;
    }
    async function sbRemoveMember(userId){
      if(!SB.ready || !SB.session || !SB.client) throw Error('Not authorized');
      if(!hasTier('business')) throw Error('User removal requires Business tier');
      if(!canMembersRemove()) throw Error('Permission denied');
      const uid = String(userId || '').trim();
      if(!uid) throw Error('User required');
      const { data, error } = await SB.client.rpc('remove_company_member', { p_user_id: uid });
      if(error) throw error;
      if(data && data.success === false) throw new Error(data.error || 'Remove failed');
      return data || null;
    }
    function renderRoleRequestsList(){
      const list = $('roleRequestsList');
      if(!list) return;
      const rows = Array.isArray(state._roleRequests) ? state._roleRequests : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No pending role requests.</div>`;
        updateRoleRequestsBadge();
        return;
      }
      list.innerHTML = rows.map(row => {
        const id = String(row.id || '').trim();
        const profile = row.profile || {};
        const name = [profile.first_name, profile.last_name].filter(Boolean).join(' ').trim();
        const email = profile.email || '';
        const who = name ? `${escapeHtml(name)}${email ? ` Â· ${escapeHtml(email)}` : ''}` : escapeHtml(email || 'User');
        const createdAt = row.created_at ? formatEasternDateTime(row.created_at) : '';
        const reason = String(row.reason || '').trim();
        return (
          `<div class="role-request-card">`+
            `<div>`+
              `<h3>${who}</h3>`+
              `<div class="role-request-meta">`+
                `Requested: ${escapeHtml(row.requested_role || '')} Â· Current: ${escapeHtml(row.current_role_name || '')}`+
                `${createdAt ? ` Â· ${escapeHtml(createdAt)}` : ''}`+
              `</div>`+
              `${reason ? `<div class="muted">${escapeHtml(reason)}</div>` : ''}`+
            `</div>`+
            `<div>`+
              `<label class="muted">Admin Notes</label>`+
              `<textarea rows="2" data-role-notes-id="${escapeHtmlAttr(id)}" placeholder="Optional notes"></textarea>`+
            `</div>`+
            `<div class="role-request-actions-row">`+
              `<button class="btn-secondary" data-role-approve-id="${escapeHtmlAttr(id)}">Approve</button>`+
              `<button class="btn-secondary" data-role-deny-id="${escapeHtmlAttr(id)}">Deny</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
      updateRoleRequestsBadge();
    }
    async function refreshRoleRequests(){
      const list = $('roleRequestsList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setRoleRequestsMessage('');
      try{
        if(!SB.ready || !SB.session || !SB.client) throw new Error('Not authorized');
        if(!SB.companyId) throw new Error('No company selected');
        if(!hasTier('business')) throw new Error('Role requests require Business tier');
        if(!canMembersChangeRole()) throw new Error('Permission denied');
        const { data, error } = await SB.client
          .from('role_change_requests')
          .select('id,user_id,current_role_name,requested_role,reason,status,created_at')
          .eq('company_id', SB.companyId)
          .eq('status', 'pending')
          .order('created_at', { ascending:false });
        if(error) throw error;
        const rows = Array.isArray(data) ? data : [];
        const userIds = rows.map(r => r.user_id).filter(Boolean);
        let profileMap = new Map();
        if(userIds.length){
          const { data: profiles, error: profErr } = await SB.client
            .from('profiles')
            .select('user_id,email,first_name,last_name')
            .in('user_id', userIds);
          if(profErr) throw profErr;
          profileMap = new Map((profiles||[]).map(p => [String(p.user_id), p]));
        }
        state._roleRequests = rows.map(r => ({
          ...r,
          profile: profileMap.get(String(r.user_id)) || null,
        }));
        renderRoleRequestsList();
      }catch(e){
        state._roleRequests = [];
        const msg = e && e.message ? e.message : 'Failed to load requests';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
        updateRoleRequestsBadge();
      }
    }
    async function openRoleRequestsModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!hasTier('business')){ toast('Role requests require Business tier'); return; }
      if(!canMembersChangeRole()){ toast('Permission denied'); return; }
      show('roleRequestsModal', true);
      await refreshRoleRequests();
    }
    function closeRoleRequestsModal(){
      show('roleRequestsModal', false);
    }
    async function sbSendPasswordReset(email){
      if(!SB.ready || !SB.client) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      if(!e) throw Error('Email required');
      const redirectTo = window.location.origin + window.location.pathname;
      const { error } = await SB.client.auth.resetPasswordForEmail(e, { redirectTo });
      if(error) throw error;
    }
    async function sbUpdatePassword(newPassword){
      if(!SB.ready || !SB.client) throw Error('Supabase not configured');
      const pw = String(newPassword||'');
      if(pw.length < 8) throw Error('Use at least 8 characters');
      const { error } = await SB.client.auth.updateUser({ password: pw });
      if(error) throw error;
    }
    function setProfileMessage(msg){
      const el = $('profileMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
	    // Auto-format phone number as (XXX) XXX-XXXX
	    function formatPhoneNumber(value){
	      let digits = String(value || '').replace(/\D/g, '');
	      // iOS often pastes US numbers as 1XXXXXXXXXX â€” drop the leading country code
	      while(digits.length > 10 && digits.startsWith('1')) digits = digits.slice(1);
	      digits = digits.slice(0, 10);
	      if(digits.length === 0) return '';
	      if(digits.length <= 3) return `(${digits}`;
	      if(digits.length <= 6) return `(${digits.slice(0,3)}) ${digits.slice(3)}`;
	      return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
	    }

	    function renderProfileUi(){
	      const email = SB.user && SB.user.email ? String(SB.user.email) : '';
	      const elEmail = $('profileEmailDisplay'); if(elEmail) elEmail.textContent = email ? `Signed in: ${email}` : '';
	      const elFirstName = $('profileFirstName'); if(elFirstName) elFirstName.value = (SB.profile && SB.profile.first_name) ? String(SB.profile.first_name) : '';
	      const elLastName = $('profileLastName'); if(elLastName) elLastName.value = (SB.profile && SB.profile.last_name) ? String(SB.profile.last_name) : '';
	      const elPhone = $('profilePhone'); if(elPhone) elPhone.value = formatPhoneNumber((SB.profile && SB.profile.phone) ? String(SB.profile.phone) : '');
	      const elLowGlobal = $('profileLowStockQtyGlobal'); if(elLowGlobal) elLowGlobal.value = String(getGlobalLowStockQty());
	      const elSilence = $('profileSilenceLowStockAlerts'); if(elSilence) elSilence.checked = lowStockAlertsSilenced();
	      let note = '';
	      if(SB.session && !SB.authorized){
	        if(!SB.companyId) note = 'No company access yet. Ask an admin for an invite.';
        else if(!SB.permissions || !hasPermission(PERMISSIONS.ITEMS_VIEW)) note = 'Your role does not allow inventory access.';
	      }
      if(note && SB.permissions && SB.permissions.assigned_admin_email){
        note += ` Contact: ${SB.permissions.assigned_admin_email}`;
      }
      setProfileMessage(note);
      renderCompanySwitcher();
      renderInviteUi();
      renderRoleRequestUi();
      renderUserMgmtHeaderActions();
      renderTierAdminSection();
    }
	    function renderProfileMenuVisibility(){
      const signedIn = !!SB.session;
      setProfileMenuItemVisibility('openProfileSettings', signedIn);
      setProfileMenuItemVisibility('openCompanySwitcher', signedIn);
      renderCompanyLocationsButton();
      renderSubscriptionManagerButton();
      renderInviteMenuItem();
      renderUserMgmtButton();
      renderRoleManagerButton();
      renderRoleRequestsAdminButton();
      renderAdvancedCompanySwitcherButton();
      renderProvisioningDashboardButton();
      renderDiagnosticsButton();
      updateProfileTeamEmpty();
    }
    function renderInviteMenuItem(){
      const allow = !!(SB.session && hasTier('business') && canMembersInvite());
      setProfileMenuItemVisibility('openInviteModal', allow);
      updateProfileTeamEmpty();
    }
	    function renderCompanySwitcher(){
      renderProfileHeaderInfo();
      syncProfileTabsForRole();
      renderProfileMenuVisibility();
      renderCompanyEnvBadge();
      if(state._companySwitcherMode === 'basic'){
        const modal = $('advancedCompanyModal');
        if(modal && modal.getAttribute('aria-hidden') === 'false'){
          renderBasicCompanyResults();
        }
      }
	    }
    function setAdvancedCompanyMessage(msg){
      const el = $('advancedCompanyMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    async function loadAdvancedInventoryCounts(companyIds){
      const ids = Array.isArray(companyIds) ? companyIds.filter(Boolean) : [];
      if(!ids.length){
        state._advancedInventoryCounts = {};
        return;
      }
      const { data, error } = await SB.client
        .from('inventory_items')
        .select('company_id, count:id')
        .in('company_id', ids)
        .is('deleted_at', null);
      if(error) throw error;
      const counts = {};
      (Array.isArray(data) ? data : []).forEach(row => {
        const id = String(row.company_id || '').trim();
        if(!id) return;
        const raw = row.count;
        const val = Number.isFinite(Number(raw)) ? Number(raw) : 0;
        counts[id] = val;
      });
      state._advancedInventoryCounts = counts;
    }
    function getDefaultProductionCompanyId(){
      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      const preferred = state._defaultCompanyId ? String(state._defaultCompanyId) : '';
      if(preferred && rows.some(r => String(r.company_id) === preferred)){
        return preferred;
      }
      if(rows.length) return String(rows[0].company_id || '');
      return '';
    }
    function renderAdvancedCompanyActions(){
      const btn = $('advancedCompanyReturnBtn');
      if(state._companySwitcherMode !== 'advanced') return;
      if(!btn) return;
      const defaultId = getDefaultProductionCompanyId();
      const allow = !!(defaultId && String(SB.companyId || '') !== defaultId);
      btn.disabled = !allow;
      btn.setAttribute('aria-disabled', allow ? 'false' : 'true');
    }
    function getAdvancedCompanyRow(targetId){
      const rows = Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [];
      const id = String(targetId || '').trim();
      if(!id) return null;
      return rows.find(r => String(r.company_id || '') === id) || null;
    }
    function formatCompanyIdShort(id){
      const raw = String(id || '').trim();
      if(raw.length <= 14) return raw;
      return `${raw.slice(0,8)}...${raw.slice(-4)}`;
    }
    function closeCompanyOverflowMenus(){
      document.querySelectorAll('.company-overflow.open').forEach(menu => {
        menu.classList.remove('open');
        const btn = menu.querySelector('[data-company-overflow]');
        if(btn) btn.setAttribute('aria-expanded', 'false');
      });
      state._companyOverflowOpenId = null;
    }
    function toggleCompanyOverflowMenu(id, btn){
      const targetId = String(id || '').trim();
      if(!targetId) return;
      const wrapper = document.querySelector(`.company-overflow[data-company-menu="${targetId}"]`);
      if(!wrapper) return;
      const isOpen = wrapper.classList.contains('open');
      closeCompanyOverflowMenus();
      if(isOpen) return;
      wrapper.classList.add('open');
      state._companyOverflowOpenId = targetId;
      if(btn) btn.setAttribute('aria-expanded', 'true');
      const first = wrapper.querySelector('.company-overflow-item');
      if(first) first.focus();
    }
    function getSeedSourceCompanies(targetId){
      const target = String(targetId || '').trim();
      const map = new Map();
      const addRow = (row) => {
        if(!row) return;
        const id = String(row.company_id || row.id || '').trim();
        if(!id || id === target) return;
        if(map.has(id)) return;
        map.set(id, {
          company_id: id,
          company_name: String(row.company_name || row.company_slug || id || '').trim() || id,
          company_type: normalizeCompanyType(row.company_type)
        });
      };
      (Array.isArray(state._advancedCompanies) ? state._advancedCompanies : []).forEach(addRow);
      (Array.isArray(SB.companies) ? SB.companies : []).forEach(addRow);
      return Array.from(map.values());
    }
    function setCompanyEnvironmentMessage(msg){
      if(!state._companyEnvironment) return;
      state._companyEnvironment.message = String(msg || '');
      renderCompanyEnvironmentModal();
    }
    function setCompanyEnvironmentBusy(isBusy){
      state._companyEnvironmentBusy = !!isBusy;
      const select = $('companyEnvironmentSelect');
      const btn = $('btnCompanyEnvironmentConfirm');
      const cancel = $('btnCompanyEnvironmentCancel');
      if(select) select.disabled = !!isBusy;
      if(btn){
        btn.disabled = !!isBusy;
        btn.setAttribute('data-loading', isBusy ? 'true' : 'false');
      }
      if(cancel) cancel.disabled = !!isBusy;
    }
    function renderCompanyEnvironmentModal(){
      const data = state._companyEnvironment;
      if(!data) return;
      const nameEl = $('companyEnvironmentTargetName');
      const idEl = $('companyEnvironmentTargetId');
      const select = $('companyEnvironmentSelect');
      const note = $('companyEnvironmentNote');
      const busy = !!state._companyEnvironmentBusy;
      if(nameEl) nameEl.textContent = data.targetName || 'Company';
      if(idEl) idEl.textContent = data.targetId || '';
      if(select){
        select.value = data.nextType || data.currentType || 'production';
        select.disabled = busy;
      }
      if(note){
        const currentLabel = formatCompanyTypeLabel(data.currentType || 'production');
        const nextLabel = formatCompanyTypeLabel(data.nextType || data.currentType || 'production');
        const base = data.currentType === data.nextType
          ? `Current: ${currentLabel}`
          : `Current: ${currentLabel} \u2192 ${nextLabel}`;
        note.textContent = data.message ? data.message : base;
      }
    }
    function openCompanyEnvironmentModal(company, opts = {}){
      if(!company) return;
      if(!isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const currentType = normalizeCompanyType(company.company_type);
      const requested = opts && opts.nextType ? normalizeCompanyType(opts.nextType) : currentType;
      state._companyEnvironment = {
        targetId: id,
        targetName: String(company.company_name || company.company_slug || id || '').trim() || 'Company',
        currentType,
        nextType: requested,
        message: ''
      };
      setCompanyEnvironmentBusy(false);
      renderCompanyEnvironmentModal();
      show('companyEnvironmentModal', true);
    }
    async function confirmCompanyEnvironment(){
      if(!state._companyEnvironment) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      const data = state._companyEnvironment;
      const targetId = String(data.targetId || '').trim();
      const nextType = normalizeCompanyType(data.nextType || data.currentType);
      if(!targetId) return;
      if(nextType !== 'production' && nextType !== 'test'){
        setCompanyEnvironmentMessage('Select a valid environment.');
        return;
      }
      if(nextType === data.currentType){
        show('companyEnvironmentModal', false);
        return;
      }
      const confirmText = nextType === 'test'
        ? 'This enables destructive actions for this company.'
        : 'This blocks destructive actions for this company.';
      const ok = await openConfirmModal(
        `Switch to ${formatCompanyTypeLabel(nextType)}?`,
        confirmText,
        { okText: 'Confirm', cancelText: 'Cancel' }
      );
      if(!ok) return;
      setCompanyEnvironmentBusy(true);
      setCompanyEnvironmentMessage('');
      try{
        const { data: result, error } = await SB.client.rpc('set_company_environment', {
          p_company_id: targetId,
          p_environment: nextType
        });
        if(error) throw error;
        if(result && result.success === false){
          throw new Error(result.error || 'Update failed');
        }
        if(String(SB.companyId || '') === targetId && SB.company){
          SB.company.company_type = nextType;
          renderCompanyEnvBadge();
        }
        show('companyEnvironmentModal', false);
        await loadAdvancedCompanies();
        toast(`Environment set to ${formatCompanyTypeLabel(nextType)}`);
      }catch(e){
        setCompanyEnvironmentMessage(e && e.message ? e.message : 'Update failed');
      }finally{
        setCompanyEnvironmentBusy(false);
      }
    }
    async function ensureCompanyTestEnvironment(company, actionLabel){
      if(!company) return false;
      const type = normalizeCompanyType(company.company_type);
      if(type === 'test') return true;
      const name = String(company.company_name || company.company_slug || company.company_id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Test environment required',
        `${actionLabel} is allowed only in Test. Switch ${name} to Test?`,
        { okText: 'Switch to Test', cancelText: 'Cancel' }
      );
      if(ok){
        openCompanyEnvironmentModal(company, { nextType: 'test' });
      }
      return false;
    }
    function setSeedInventoryMessage(msg){
      const el = $('seedInventoryMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function setSeedInventoryBusy(isBusy){
      state._seedInventoryBusy = !!isBusy;
      const select = $('seedInventorySource');
      const dedupe = $('seedInventoryDedupe');
      const btn = $('btnSeedInventoryConfirm');
      const cancel = $('btnSeedInventoryCancel');
      if(select) select.disabled = !!isBusy;
      if(dedupe) dedupe.disabled = !!isBusy;
      if(btn){
        btn.disabled = !!isBusy;
        btn.setAttribute('data-loading', isBusy ? 'true' : 'false');
      }
      if(cancel) cancel.disabled = !!isBusy;
    }
    function renderSeedInventoryModal(){
      const data = state._seedInventory;
      if(!data) return;
      const nameEl = $('seedInventoryTargetName');
      const idEl = $('seedInventoryTargetId');
      const select = $('seedInventorySource');
      const dedupe = $('seedInventoryDedupe');
      const btn = $('btnSeedInventoryConfirm');
      const busy = !!state._seedInventoryBusy;
      const isTest = normalizeCompanyType(data.targetType) === 'test';
      const targetName = data.targetName || 'Company';
      const targetId = data.targetId || '';
      if(nameEl) nameEl.textContent = targetName;
      if(idEl) idEl.textContent = targetId;
      if(select){
        const sources = getSeedSourceCompanies(targetId);
        const current = String(data.sourceId || '').trim();
        select.innerHTML = '';
        if(!sources.length){
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No source companies available';
          select.appendChild(opt);
          select.disabled = true;
          if(!state._seedInventoryBusy){
            setSeedInventoryMessage('No source companies available. Run a search to load companies.');
          }
        }else{
          sources.forEach(row => {
            const label = row.company_type
              ? `${row.company_name} (${formatCompanyTypeLabel(row.company_type)})`
              : row.company_name;
            const opt = document.createElement('option');
            opt.value = row.company_id;
            opt.textContent = label;
            select.appendChild(opt);
          });
          select.disabled = false;
          if(!state._seedInventoryBusy && !String($('seedInventoryMsg')?.textContent || '').trim()){
            setSeedInventoryMessage('');
          }
          if(current && sources.some(r => r.company_id === current)){
            select.value = current;
          }else{
            select.value = sources[0].company_id;
            data.sourceId = select.value;
          }
        }
        if(busy) select.disabled = true;
      }
      if(dedupe){
        dedupe.value = data.dedupeKey || 'sku';
        dedupe.disabled = busy;
      }
      if(btn){
        const hasSource = select ? !!String(select.value || '').trim() : false;
        btn.disabled = busy || !hasSource || !isTest;
      }
      if(!isTest && !state._seedInventoryBusy){
        setSeedInventoryMessage('Target must be Test environment to seed inventory.');
      }
    }
    async function openSeedInventoryModal(company){
      if(!company) return;
      if(!isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Inventory seeding'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      state._seedInventory = {
        targetId: id,
        targetName: String(company.company_name || company.company_slug || id || '').trim() || 'Company',
        sourceId: '',
        dedupeKey: 'sku',
        targetType: normalizeCompanyType(company.company_type)
      };
      setSeedInventoryBusy(false);
      setSeedInventoryMessage('');
      renderSeedInventoryModal();
      show('seedInventoryModal', true);
    }
    async function confirmSeedInventory(){
      if(!state._seedInventory) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      const data = state._seedInventory;
      const sourceSelect = $('seedInventorySource');
      const dedupeSelect = $('seedInventoryDedupe');
      const sourceId = String(sourceSelect ? sourceSelect.value : data.sourceId || '').trim();
      const targetId = String(data.targetId || '').trim();
      const dedupeKey = String(dedupeSelect ? dedupeSelect.value : data.dedupeKey || 'sku').trim() || 'sku';
      if(normalizeCompanyType(data.targetType) !== 'test'){
        setSeedInventoryMessage('Target must be Test environment to seed inventory.');
        return;
      }
      if(!sourceId){
        setSeedInventoryMessage('Select a source company.');
        return;
      }
      if(sourceId === targetId){
        setSeedInventoryMessage('Source and target must be different.');
        return;
      }
      setSeedInventoryMessage('Seeding inventory...');
      setSeedInventoryBusy(true);
      try{
        const { data: result, error } = await SB.client.rpc('seed_company_inventory', {
          p_source_company_id: sourceId,
          p_target_company_id: targetId,
          p_mode: 'items_only',
          p_dedupe_key: dedupeKey
        });
        if(error) throw error;
        if(result && result.success === false){
          const msg = String(result.error || 'Seed failed');
          if(msg.toLowerCase().includes('already seeded')){
            setSeedInventoryMessage('Target already seeded. Use "Reset Seed Lock" in Manage Companies to reseed.');
            return;
          }
          throw new Error(msg);
        }
        const count = result && Number.isFinite(Number(result.items_copied_count))
          ? Number(result.items_copied_count)
          : null;
        const countLabel = count !== null ? ` (${count} items)` : '';
        toast(`Inventory seeded${countLabel}`);
        show('seedInventoryModal', false);
        await loadAdvancedCompanies();
      }catch(e){
        setSeedInventoryMessage(e && e.message ? e.message : 'Seed failed');
      }finally{
        setSeedInventoryBusy(false);
      }
    }
    async function getCompanyInventoryCount(companyId){
      const { count, error } = await SB.client
        .from('inventory_items')
        .select('id', { head:true, count:'exact' })
        .eq('company_id', companyId)
        .is('deleted_at', null);
      if(error) throw error;
      return Number.isFinite(count) ? count : 0;
    }
    async function getCompanyMemberCount(companyId, includeSuper = true){
      let query = SB.client
        .from('company_members')
        .select('user_id', { head:true, count:'exact' })
        .eq('company_id', companyId);
      if(!includeSuper){
        query = query.eq('is_super_user', false);
      }
      const { count, error } = await query;
      if(error) throw error;
      return Number.isFinite(count) ? count : 0;
    }
    async function deleteCompanyInventory(company){
      if(!company) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Delete inventory'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const name = String(company.company_name || company.company_slug || id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Delete inventory?',
        `Delete ALL inventory items for ${name}?`,
        { okText:'Continue', cancelText:'Cancel' }
      );
      if(!ok) return;
      let count = 0;
      try{ count = await getCompanyInventoryCount(id); }catch(e){}
      const ok2 = await openConfirmModal(
        'Final confirmation',
        `This will permanently delete ${count} items from ${name}.`,
        { okText:'Delete Inventory', cancelText:'Cancel' }
      );
      if(!ok2) return;
      try{
        const { data, error } = await SB.client.rpc('delete_company_inventory', {
          p_company_id: id
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Delete failed');
        }
        const deletedCount = data && Number.isFinite(Number(data.deleted_count)) ? Number(data.deleted_count) : 0;
        if(deletedCount === 0){
          toast('No inventory items to delete.');
        }else{
          toast(`Deleted ${deletedCount} items`);
        }
        await loadAdvancedCompanies();
      }catch(e){
        toast(e && e.message ? e.message : 'Delete failed');
      }
    }
    async function deleteCompanyUsers(company){
      if(!company) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Delete users'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const name = String(company.company_name || company.company_slug || id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Remove users?',
        `Remove all non-super users from ${name}?`,
        { okText:'Continue', cancelText:'Cancel' }
      );
      if(!ok) return;
      let count = 0;
      try{ count = await getCompanyMemberCount(id, false); }catch(e){}
      if(count === 0){
        toast('No removable users found.');
        return;
      }
      const ok2 = await openConfirmModal(
        'Final confirmation',
        `This will remove ${count} users from ${name}. Super users remain; user accounts are not deleted.`,
        { okText:'Remove Users', cancelText:'Cancel' }
      );
      if(!ok2) return;
      try{
        const { data, error } = await SB.client.rpc('delete_company_users', {
          p_company_id: id
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Remove users failed');
        }
        const deletedCount = data && Number.isFinite(Number(data.deleted_count)) ? Number(data.deleted_count) : count;
        toast(`Removed ${deletedCount} users`);
        await loadAdvancedCompanies();
      }catch(e){
        toast(e && e.message ? e.message : 'Remove users failed');
      }
    }
    async function deleteCompanyRecord(company){
      if(!company) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Delete company'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const name = String(company.company_name || company.company_slug || id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Delete company?',
        `Delete ${name} and its company record?`,
        { okText:'Continue', cancelText:'Cancel' }
      );
      if(!ok) return;
      let inventoryCount = 0;
      let memberCount = 0;
      try{ inventoryCount = await getCompanyInventoryCount(id); }catch(e){}
      try{ memberCount = await getCompanyMemberCount(id, true); }catch(e){}
      const ok2 = await openConfirmModal(
        'Final confirmation',
        `This will attempt to delete ${name}. Remaining: ${inventoryCount} items, ${memberCount} users.`,
        { okText:'Delete Company', cancelText:'Cancel' }
      );
      if(!ok2) return;
      try{
        const { data, error } = await SB.client.rpc('delete_company_record', {
          p_company_id: id
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Delete failed');
        }
        state._advancedCompanies = (Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [])
          .filter(row => String(row.company_id || '') !== id);
        renderAdvancedCompanyResults();
        toast('Company deleted');
        if(String(SB.companyId || '') === id){
          const fallbackId = getDefaultProductionCompanyId();
          if(fallbackId && fallbackId !== id){
            await sbSwitchCompany(fallbackId, { persist:false, audit:true, source:'company_delete' });
            renderAdvancedCompanyActions();
          }
        }
      }catch(e){
        toast(e && e.message ? e.message : 'Delete failed');
      }
    }
    async function resetInventorySeedRun(company){
      if(!company) return;
      if(!SB.ready || !SB.session || !SB.client){
        toast('Supabase not configured');
        return;
      }
      if(!isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      if(!(await ensureCompanyTestEnvironment(company, 'Reset seed lock'))){
        return;
      }
      const id = String(company.company_id || '').trim();
      if(!id) return;
      const name = String(company.company_name || company.company_slug || id || '').trim() || 'Company';
      const ok = await openConfirmModal(
        'Reset seed lock?',
        `Allow ${name} to be seeded again?`,
        { okText:'Continue', cancelText:'Cancel' }
      );
      if(!ok) return;
      const ok2 = await openConfirmModal(
        'Final confirmation',
        `This will remove the seed lock for ${name}.`,
        { okText:'Reset Seed Lock', cancelText:'Cancel' }
      );
      if(!ok2) return;
      try{
        const { data, error } = await SB.client.rpc('reset_inventory_seed_run', {
          p_target_company_id: id
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Reset failed');
        }
        toast('Seed lock reset');
        await loadAdvancedCompanies();
      }catch(e){
        toast(e && e.message ? e.message : 'Reset failed');
      }
    }
    function renderAdvancedCompanyResults(){
      if(state._companySwitcherMode !== 'advanced') return;
      const container = $('advancedCompanyResults');
      if(!container) return;
      closeCompanyOverflowMenus();
      const rows = Array.isArray(state._advancedCompanies) ? state._advancedCompanies : [];
      if(!rows.length){
        container.innerHTML = '<div class="trash-empty">No companies found.</div>';
        return;
      }
      const counts = state._advancedInventoryCounts || {};
      const header = (
        '<thead><tr>' +
          '<th>Company</th>' +
          '<th>Environment</th>' +
          '<th class="col-members">Members</th>' +
          '<th class="col-inventory">Total Inventory</th>' +
          '<th>Actions</th>' +
        '</tr></thead>'
      );
      const body = rows.map(row => {
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || 'Company';
        const id = String(row.company_id || '').trim();
        const type = normalizeCompanyType(row.company_type);
        const badge = `<span class="env-badge env-${escapeHtmlAttr(type)}">${escapeHtml(formatCompanyTypeLabel(type))}</span>`;
        const members = Number.isFinite(Number(row.member_count)) ? String(row.member_count) : '0';
        const shortId = formatCompanyIdShort(id);
        const isCurrent = String(SB.companyId || '') === id;
        const hasCount = Object.prototype.hasOwnProperty.call(counts, id);
        let invCount = hasCount ? Number(counts[id]) : null;
        if(invCount !== null && !Number.isFinite(invCount)) invCount = 0;
        if(invCount === null && isCurrent && Array.isArray(state.items)){
          invCount = state.items.length;
        }
        const invClass = invCount === null ? 'col-inventory muted' : (invCount > 0 ? 'col-inventory inv-positive' : 'col-inventory muted');
        const invText = invCount === null ? 'â€”' : String(invCount);
        const switchBtn = isCurrent
          ? `<span class="company-active-label">Active</span>`
          : `<button class="btn-tertiary btn-sm" type="button" data-advanced-switch="${escapeHtmlAttr(id)}">Switch</button>`;
        return (
          `<tr${isCurrent ? ' class="is-current"' : ''}>` +
            `<td>` +
              `<div class="manage-companies-name">` +
                `<span>${escapeHtml(name)}</span>` +
                `${isCurrent ? '<span class="manage-companies-current">Current</span>' : ''}` +
              `</div>` +
              `<button class="company-id-copy" type="button" data-copy-company-id="${escapeHtmlAttr(id)}" title="Click to copy" aria-label="Copy company ID">` +
                `${escapeHtml(shortId)}` +
              `</button>` +
            `</td>` +
            `<td>${badge}</td>` +
            `<td class="col-members">${escapeHtml(members)}</td>` +
            `<td class="${invClass}">${escapeHtml(invText)}</td>` +
            `<td>` +
              `<div class="manage-companies-row-actions">` +
                switchBtn +
                `<div class="company-overflow" data-company-menu="${escapeHtmlAttr(id)}">` +
                  `<button class="icon-btn icon-btn--default company-overflow-btn" type="button" data-company-overflow="${escapeHtmlAttr(id)}" aria-haspopup="menu" aria-expanded="false" aria-label="Open company actions">` +
                    `${ICONS.moreHorizontal}` +
                  `</button>` +
                  `<div class="company-overflow-menu" role="menu" aria-label="Company actions">` +
                    `<div class="company-overflow-section">Data Operations</div>` +
                    `<button class="company-overflow-item" type="button" role="menuitem" data-advanced-seed="${escapeHtmlAttr(id)}">Seed Inventory</button>` +
                    `<button class="company-overflow-item" type="button" role="menuitem" data-advanced-reset-seed="${escapeHtmlAttr(id)}">Reset Seed Lock</button>` +
                    `<div class="company-overflow-section">Environment</div>` +
                    `<button class="company-overflow-item" type="button" role="menuitem" data-advanced-set-env="${escapeHtmlAttr(id)}">Set Environment</button>` +
                    `<div class="company-overflow-section">Danger Zone</div>` +
                    `<button class="company-overflow-item danger" type="button" role="menuitem" data-advanced-delete-inventory="${escapeHtmlAttr(id)}">Delete Inventory</button>` +
                    `<button class="company-overflow-item danger" type="button" role="menuitem" data-advanced-delete-users="${escapeHtmlAttr(id)}">Delete Users</button>` +
                    `<button class="company-overflow-item danger" type="button" role="menuitem" data-advanced-delete-company="${escapeHtmlAttr(id)}">Delete Company</button>` +
                  `</div>` +
                `</div>` +
              `</div>` +
            `</td>` +
          `</tr>`
        );
      }).join('');
      container.innerHTML = `<table class="manage-companies-table results-table advanced-switcher-table">${header}<tbody>${body}</tbody></table>`;
      if(!container._wired){
        container._wired = true;
        container.addEventListener('click', async (e)=>{
          const copyBtn = e.target.closest('[data-copy-company-id]');
          if(copyBtn){
            const cid = String(copyBtn.getAttribute('data-copy-company-id') || '').trim();
            if(cid){
              try{
                await navigator.clipboard.writeText(cid);
                toast('Company ID copied to clipboard');
              }catch(err){
                toast('Copy failed');
              }
            }
            return;
          }
          const overflowBtn = e.target.closest('[data-company-overflow]');
          if(overflowBtn){
            const menuId = String(overflowBtn.getAttribute('data-company-overflow') || '').trim();
            toggleCompanyOverflowMenu(menuId, overflowBtn);
            return;
          }
          const switchBtn = e.target.closest('[data-advanced-switch]');
          if(switchBtn){
            closeCompanyOverflowMenus();
            const targetId = String(switchBtn.getAttribute('data-advanced-switch') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await handleAdvancedCompanySwitch(row);
            return;
          }
          const seedBtn = e.target.closest('[data-advanced-seed]');
          if(seedBtn){
            closeCompanyOverflowMenus();
            const targetId = String(seedBtn.getAttribute('data-advanced-seed') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await openSeedInventoryModal(row);
            return;
          }
          const resetSeedBtn = e.target.closest('[data-advanced-reset-seed]');
          if(resetSeedBtn){
            closeCompanyOverflowMenus();
            const targetId = String(resetSeedBtn.getAttribute('data-advanced-reset-seed') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await resetInventorySeedRun(row);
            return;
          }
          const setEnvBtn = e.target.closest('[data-advanced-set-env]');
          if(setEnvBtn){
            closeCompanyOverflowMenus();
            const targetId = String(setEnvBtn.getAttribute('data-advanced-set-env') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            openCompanyEnvironmentModal(row);
            return;
          }
          const deleteInventoryBtn = e.target.closest('[data-advanced-delete-inventory]');
          if(deleteInventoryBtn){
            closeCompanyOverflowMenus();
            const targetId = String(deleteInventoryBtn.getAttribute('data-advanced-delete-inventory') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await deleteCompanyInventory(row);
            return;
          }
          const deleteUsersBtn = e.target.closest('[data-advanced-delete-users]');
          if(deleteUsersBtn){
            closeCompanyOverflowMenus();
            const targetId = String(deleteUsersBtn.getAttribute('data-advanced-delete-users') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await deleteCompanyUsers(row);
            return;
          }
          const deleteCompanyBtn = e.target.closest('[data-advanced-delete-company]');
          if(deleteCompanyBtn){
            closeCompanyOverflowMenus();
            const targetId = String(deleteCompanyBtn.getAttribute('data-advanced-delete-company') || '').trim();
            const row = getAdvancedCompanyRow(targetId);
            if(!row) return;
            await deleteCompanyRecord(row);
            return;
          }
        });
      }
    }
    async function loadAdvancedCompanies(){
      if(!SB.ready || !SB.session || !SB.client) return;
      if(state._companySwitcherMode !== 'advanced') return;
      if(!isEffectiveSuperUser()){
        setAdvancedCompanyMessage('Super user access required.');
        return;
      }
      const searchInput = $('advancedCompanySearch');
      const typeSelect = $('advancedCompanyTypeFilter');
      const search = String(searchInput ? searchInput.value : '').trim();
      const type = String(typeSelect ? typeSelect.value : '').trim();
      state._advancedSearch = search;
      state._advancedType = type;
      setAdvancedCompanyMessage('Loading...');
      try{
        const { data, error } = await SB.client.rpc('get_company_switcher_companies', {
          p_search: search || null,
          p_company_type: type || null,
          p_limit: 50
        });
        if(error) throw error;
        state._advancedCompanies = Array.isArray(data) ? data : [];
        const countsFromRpc = {};
        state._advancedCompanies.forEach(row => {
          const id = String(row && row.company_id ? row.company_id : '').trim();
          if(!id) return;
          if(row && Object.prototype.hasOwnProperty.call(row, 'inventory_count')){
            const raw = Number(row.inventory_count);
            countsFromRpc[id] = Number.isFinite(raw) ? raw : 0;
          }
        });
        state._advancedInventoryCounts = countsFromRpc;
        if(Object.keys(countsFromRpc).length === 0){
          try{
            const ids = state._advancedCompanies.map(row => String(row.company_id || '').trim()).filter(Boolean);
            await loadAdvancedInventoryCounts(ids);
          }catch(e){
            console.warn('Inventory count query failed:', e);
            state._advancedInventoryCounts = {};
          }
        }
        renderAdvancedCompanyResults();
        renderAdvancedCompanyActions();
        if(state._seedInventory){
          renderSeedInventoryModal();
        }
        if(!state._advancedCompanies.length){
          setAdvancedCompanyMessage('No companies found.');
        }else{
          setAdvancedCompanyMessage('');
        }
      }catch(e){
        console.warn('Advanced company search failed:', e);
        setAdvancedCompanyMessage('Failed to load companies.');
        state._advancedCompanies = [];
        renderAdvancedCompanyResults();
      }
    }
    async function openAdvancedCompanySwitcher(){
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      setCompanySwitcherMode('advanced');
      const searchInput = $('advancedCompanySearch');
      const typeSelect = $('advancedCompanyTypeFilter');
      if(searchInput) searchInput.value = state._advancedSearch || '';
      if(typeSelect){
        const desiredType = Object.prototype.hasOwnProperty.call(state, '_advancedType')
          ? state._advancedType
          : 'production';
        typeSelect.value = desiredType === undefined ? 'production' : desiredType;
      }
      setAdvancedCompanyMessage('');
      show('advancedCompanyModal', true);
      renderAdvancedCompanyActions();
      await loadAdvancedCompanies();
    }
    function wireDeveloperProfileActions(){
      const advancedCompanyBtn = $('openAdvancedCompanySwitcher');
      if(advancedCompanyBtn && !advancedCompanyBtn._wired){
        advancedCompanyBtn._wired = true;
        advancedCompanyBtn.addEventListener('click', ()=>{
          closeProfileMenu();
          void openAdvancedCompanySwitcher();
        });
      }
      const provisioningBtn = $('openProvisioningDashboard');
      if(provisioningBtn && !provisioningBtn._wired){
        provisioningBtn._wired = true;
        provisioningBtn.addEventListener('click', ()=>{
          closeProfileMenu();
          void openProvisioningModal();
        });
      }
      const diagnosticsBtn = $('openDiagnostics');
      if(diagnosticsBtn && !diagnosticsBtn._wired){
        diagnosticsBtn._wired = true;
        diagnosticsBtn.addEventListener('click', ()=>{
          closeProfileMenu();
          openDiagnosticsModal();
        });
      }
    }
    async function handleAdvancedCompanySwitch(company){
      if(!company) return;
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      const type = normalizeCompanyType(company.company_type);
      if(type !== 'production'){
        const ok = await openConfirmModal(
          'Switch to non-production',
          `You are about to switch into ${formatCompanyTypeLabel(type)}. Continue?`,
          { okText: 'Switch', cancelText: 'Cancel' }
        );
        if(!ok) return;
      }
      const ok = await sbSwitchCompany(company.company_id, {
        persist: false,
        companyRow: company,
        audit: true,
        source: 'advanced_switcher'
      });
      if(ok){
        const name = String(company.company_name || company.company_slug || company.company_id || 'company');
        toast(`Switched to ${name}`);
        renderAdvancedCompanyActions();
        renderCompanyEnvBadge();
      }
    }
    function setProvisioningMessage(msg){
      const el = $('provisioningMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function slugifyCompanyName(value){
      return String(value || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }
    function isValidCompanySlug(value){
      const slug = String(value || '').trim();
      if(slug.length < 2) return false;
      return /^[a-z0-9][a-z0-9-]*[a-z0-9]$/.test(slug);
    }
    function renderProvisioningUsersList(){
      const list = $('provisioningUsersList');
      if(!list) return;
      const rows = Array.isArray(state._provisioningUsers) ? state._provisioningUsers : [];
      const busy = !!state._provisioningBusy;
      const existingUsers = Array.isArray(state._provisioningExistingUsers) ? state._provisioningExistingUsers : [];
      const existingUsersLoading = !!state._provisioningExistingUsersLoading;
      const existingUsersError = String(state._provisioningExistingUsersError || '');
      const needsExistingUsers = rows.length > 0;
      if(needsExistingUsers && !existingUsersLoading && !existingUsers.length && !existingUsersError){
        void loadProvisioningExistingUsers();
      }
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No users queued.</div>`;
        return;
      }
      const roleOptions = [
        { value: 'admin', label: 'admin' },
        { value: 'member', label: 'manager' },
        { value: 'viewer', label: 'viewer' },
      ];
      const header = (
        `<thead><tr>`+
          `<th>User</th>`+
          `<th>Role</th>`+
          `<th>Action</th>`+
        `</tr></thead>`
      );
      const buildUserSelect = (id, userId) => {
        const normalizedId = String(userId || '').trim().toLowerCase();
        const options = [];
        if(existingUsersLoading){
          options.push(`<option value="">Loading users...</option>`);
        }else if(existingUsers.length){
          options.push(`<option value="">Select a user</option>`);
          existingUsers.forEach(user => {
            const userEmail = String(user.email || '').trim();
            const uid = String(user.user_id || '').trim();
            if(!userEmail || !uid) return;
            const fullName = String(user.full_name || '').trim();
            const label = (fullName && fullName !== userEmail) ? `${fullName} - ${userEmail}` : userEmail;
            const selected = normalizedId && uid.toLowerCase() === normalizedId;
            options.push(`<option value="${escapeHtmlAttr(uid)}"${selected ? ' selected' : ''}>${escapeHtml(label)}</option>`);
          });
        }else{
          const emptyLabel = existingUsersError ? 'Unable to load users' : 'No users available';
          options.push(`<option value="">${escapeHtml(emptyLabel)}</option>`);
        }
        const disabled = busy || existingUsersLoading || !existingUsers.length;
        return (
          `<select data-provisioning-user-id="${escapeHtmlAttr(id)}" data-provisioning-user-field="user_id"${disabled ? ' disabled aria-disabled="true"' : ''}>`+
            options.join('')+
          `</select>`
        );
      };
      const body = rows.map(row => {
        const id = String(row.id || '').trim();
        const userId = String(row.user_id || '');
        const role = String(row.role || 'member');
        const roleSelect = `<select data-provisioning-user-id="${escapeHtmlAttr(id)}" data-provisioning-user-field="role"${busy ? ' disabled aria-disabled="true"' : ''}>`+
          roleOptions.map(opt => `<option value="${escapeHtmlAttr(opt.value)}"${opt.value === role ? ' selected' : ''}>${escapeHtml(opt.label)}</option>`).join('')+
        `</select>`;
        const userCell = buildUserSelect(id, userId);
        return (
          `<tr>`+
            `<td>${userCell}</td>`+
            `<td>${roleSelect}</td>`+
            `<td><button class="btn-tertiary btn-sm btn-danger" data-provisioning-user-remove="${escapeHtmlAttr(id)}"${busy ? ' disabled aria-disabled="true"' : ''}>Remove</button></td>`+
          `</tr>`
        );
      }).join('');
      const errorNote = (existingUsersError && needsExistingUsers)
        ? `<div class="provisioning-note">${escapeHtml(existingUsersError)}</div>`
        : '';
      list.innerHTML = (
        `<div class="provisioning-table-wrap">`+
          `<table class="metrics-table provisioning-table">${header}<tbody>${body}</tbody></table>`+
        `</div>`+
        errorNote
      );
    }
    function renderProvisioningSummary(){
      const summary = $('provisioningSummary');
      if(!summary) return;
      const result = state._provisioningResult;
      if(!result){
        summary.innerHTML = `<div class="muted">No provisioning run yet.</div>`;
        return;
      }
      const items = [];
      if(result.company && result.company.id){
        const name = escapeHtml(result.company.name || 'Company');
        const slug = escapeHtml(result.company.slug || '');
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Company</span> Â· ${name}${slug ? ` (${slug})` : ''}</div>`+
            `<div class="provisioning-status ok">created</div>`+
          `</div>`
        );
      }else{
        const err = escapeHtml(result.company && result.company.error ? result.company.error : 'Failed');
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Company</span> Â· ${err}</div>`+
            `<div class="provisioning-status fail">failed</div>`+
          `</div>`
        );
      }
      const userSummary = result.users && typeof result.users === 'object' ? result.users : null;
      if(userSummary){
        const count = Number.isFinite(userSummary.count) ? userSummary.count : 0;
        const statusClass = userSummary.error ? 'warn' : 'ok';
        const statusText = userSummary.error ? 'partial' : (count ? 'ok' : 'skipped');
        const detail = count ? `Assigned ${count}` : 'None';
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Users</span> Â· ${escapeHtml(detail)}</div>`+
            `<div class="provisioning-status ${statusClass}">${statusText}</div>`+
          `</div>`
        );
        if(userSummary.error){
          items.push(`<div class="provisioning-note">${escapeHtml(userSummary.error)}</div>`);
        }
      }else{
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Users</span> Â· None</div>`+
            `<div class="provisioning-status warn">skipped</div>`+
          `</div>`
        );
      }
      if(result.tier){
        const tierLabel = escapeHtml(String(result.tier.tier || ''));
        const tierStatus = result.tier.success ? 'ok' : (result.tier.error ? 'fail' : 'warn');
        const tierText = result.tier.success ? 'granted' : (result.tier.error ? 'failed' : 'skipped');
        const endLabel = result.tier.ends_at ? formatEasternDateTime(result.tier.ends_at) : '';
        const detail = tierLabel ? `${tierLabel}${endLabel ? ` Â· ends ${escapeHtml(endLabel)}` : ''}` : 'n/a';
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Subscription Tier</span> Â· ${detail}</div>`+
            `<div class="provisioning-status ${tierStatus}">${tierText}</div>`+
          `</div>`
        );
        if(result.tier.error){
          items.push(`<div class="provisioning-note">${escapeHtml(result.tier.error)}</div>`);
        }
      }
      if(result.seeding){
        const seedStatus = result.seeding.success ? 'ok' : (result.seeding.error ? (result.seeding.warning ? 'warn' : 'fail') : 'warn');
        const seedText = result.seeding.success ? 'seeded' : (result.seeding.error ? (result.seeding.warning ? 'skipped' : 'failed') : 'skipped');
        const seedDetail = result.seeding.source_name ? `${escapeHtml(result.seeding.source_name)} Â· ${escapeHtml(result.seeding.dedupe_key || '')}` : 'n/a';
        const count = Number.isFinite(result.seeding.items_copied_count) ? result.seeding.items_copied_count : null;
        const countText = count !== null ? ` Â· ${count} copied` : '';
        items.push(
          `<div class="provisioning-summary-item">`+
            `<div><span class="provisioning-summary-label">Inventory Seeding</span> Â· ${seedDetail}${countText}</div>`+
            `<div class="provisioning-status ${seedStatus}">${seedText}</div>`+
          `</div>`
        );
        if(result.seeding.error){
          items.push(`<div class="provisioning-note">${escapeHtml(result.seeding.error)}</div>`);
        }
      }
      if(result.company && result.company.id){
        items.push(
          `<div class="provisioning-users-actions">`+
            `<button class="btn-secondary" data-provisioning-open-id="${escapeHtmlAttr(result.company.id)}" data-provisioning-open-name="${escapeHtmlAttr(result.company.name || '')}" data-provisioning-open-slug="${escapeHtmlAttr(result.company.slug || '')}">Open Company</button>`+
          `</div>`
        );
      }
      summary.innerHTML = items.join('');
    }
    function renderProvisioningSeedFields(){
      const toggle = $('provisioningSeedToggle');
      const fields = $('provisioningSeedFields');
      if(!toggle || !fields) return;
      fields.style.display = toggle.checked ? '' : 'none';
    }
    function renderProvisioningCompanies(){
      const select = $('provisioningSeedSource');
      if(!select) return;
      const rows = Array.isArray(state._provisioningCompanies) ? state._provisioningCompanies : [];
      const current = String(select.value || '').trim();
      select.innerHTML = '';
      if(!rows.length){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No companies available';
        select.appendChild(opt);
        select.disabled = true;
        return;
      }
      rows.forEach(row => {
        const id = String(row.company_id || row.id || '').trim();
        if(!id) return;
        const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || id;
        const type = normalizeCompanyType(row.company_type);
        const label = type ? `${name} (${formatCompanyTypeLabel(type)})` : name;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = label;
        select.appendChild(opt);
      });
      const next = rows.some(r => String(r.company_id || r.id) === current) ? current : String(rows[0].company_id || rows[0].id || '');
      if(next) select.value = next;
      select.disabled = rows.length <= 1;
    }
    async function loadProvisioningExistingUsers(){
      if(!SB.ready || !SB.session || !SB.client) return;
      if(!isEffectiveSuperUser()){
        state._provisioningExistingUsersError = 'Super user access required.';
        state._provisioningExistingUsers = [];
        renderProvisioningUsersList();
        return;
      }
      if(state._provisioningExistingUsersLoading) return;
      state._provisioningExistingUsersLoading = true;
      state._provisioningExistingUsersError = '';
      renderProvisioningUsersList();
      try{
        const { data, error } = await SB.client.rpc('get_all_users');
        if(error) throw error;
        const rows = Array.isArray(data) ? data : [];
        const seen = new Set();
        const users = [];
        rows.forEach(row => {
          const email = String(row.email || '').trim();
          if(!email) return;
          const key = String(row.user_id || email).toLowerCase();
          if(seen.has(key)) return;
          seen.add(key);
          users.push({
            user_id: row.user_id || null,
            email,
            full_name: String(row.full_name || '').trim()
          });
        });
        users.sort((a, b) => a.email.localeCompare(b.email));
        state._provisioningExistingUsers = users;
      }catch(e){
        console.warn('Provisioning users load failed:', e);
        state._provisioningExistingUsers = [];
        state._provisioningExistingUsersError = 'Unable to load existing users.';
      }finally{
        state._provisioningExistingUsersLoading = false;
        renderProvisioningUsersList();
      }
    }
    async function loadProvisioningCompanies(){
      if(!SB.ready || !SB.session || !SB.client) return;
      if(!isEffectiveSuperUser()){
        setProvisioningMessage('Super user access required.');
        return;
      }
      setProvisioningMessage('Loading companies...');
      try{
        const { data, error } = await SB.client.rpc('get_company_switcher_companies', {
          p_search: null,
          p_company_type: null,
          p_limit: 200
        });
        if(error) throw error;
        state._provisioningCompanies = Array.isArray(data) ? data : [];
        renderProvisioningCompanies();
        setProvisioningMessage('');
      }catch(e){
        console.warn('Provisioning companies load failed:', e);
        state._provisioningCompanies = [];
        renderProvisioningCompanies();
        setProvisioningMessage('Failed to load companies.');
      }
    }
    function resetProvisioningForm(){
      state._provisioningUsers = [];
      state._provisioningResult = null;
      state._provisioningBusy = false;
      state._provisioningExistingUsersError = '';
      const nameInput = $('provisioningCompanyName');
      const slugInput = $('provisioningCompanySlug');
      const onboardingInput = $('provisioningOnboardingState');
      const includeActor = $('provisioningIncludeActor');
      const tierSelect = $('provisioningTierOverride');
      const tierEndsAt = $('provisioningTierEndsAt');
      const seedToggle = $('provisioningSeedToggle');
      if(nameInput) nameInput.value = '';
      if(slugInput){
        slugInput.value = '';
        slugInput.dataset.manual = '';
      }
      if(onboardingInput) onboardingInput.value = 'UNINITIALIZED';
      if(includeActor) includeActor.checked = true;
      if(tierSelect) tierSelect.value = '';
      if(tierEndsAt) tierEndsAt.value = '';
      if(seedToggle) seedToggle.checked = false;
      renderProvisioningSeedFields();
      renderProvisioningUsersList();
      renderProvisioningSummary();
      setProvisioningMessage('');
    }
    async function openProvisioningModal(){
      if(!SB.ready || !SB.client){
        toast('Supabase not configured.');
        return;
      }
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      show('provisioningModal', true);
      renderProvisioningUsersList();
      renderProvisioningSummary();
      renderProvisioningSeedFields();
      if(!Array.isArray(state._provisioningCompanies) || !state._provisioningCompanies.length){
        await loadProvisioningCompanies();
      }else{
        renderProvisioningCompanies();
      }
      if(!Array.isArray(state._provisioningExistingUsers) || !state._provisioningExistingUsers.length){
        state._provisioningExistingUsersError = '';
        void loadProvisioningExistingUsers();
      }
    }
    function closeProvisioningModal(){
      show('provisioningModal', false);
    }
    async function runProvisioning(){
      if(!SB.ready || !SB.client){
        setProvisioningMessage('Supabase not configured.');
        return;
      }
      if(!SB.session || !isEffectiveSuperUser()){
        setProvisioningMessage('Super user access required.');
        return;
      }
      if(state._provisioningBusy) return;
      const nameInput = $('provisioningCompanyName');
      const slugInput = $('provisioningCompanySlug');
      const includeActor = $('provisioningIncludeActor');
      const tierSelect = $('provisioningTierOverride');
      const tierEndsAt = $('provisioningTierEndsAt');
      const seedToggle = $('provisioningSeedToggle');
      const seedSource = $('provisioningSeedSource');
      const seedDedupe = $('provisioningSeedDedupe');

      const companyName = String(nameInput ? nameInput.value : '').trim();
      if(!companyName){
        setProvisioningMessage('Company name is required.');
        return;
      }
      let slug = String(slugInput ? slugInput.value : '').trim();
      if(!slug) slug = slugifyCompanyName(companyName);
      if(!slug){
        setProvisioningMessage('Company slug is required.');
        return;
      }
      if(!isValidCompanySlug(slug)){
        setProvisioningMessage('Slug must be at least 2 characters and contain only lowercase letters, numbers, and hyphens.');
        return;
      }
      if(slugInput) slugInput.value = slug;

      const userRows = Array.isArray(state._provisioningUsers) ? state._provisioningUsers : [];
      const assignments = [];
      const seenUsers = new Set();
      for(const row of userRows){
        const userId = String(row.user_id || '').trim();
        if(!userId){
          setProvisioningMessage('Select a user for each assignment.');
          return;
        }
        if(seenUsers.has(userId)){
          setProvisioningMessage('Duplicate users selected.');
          return;
        }
        seenUsers.add(userId);
        assignments.push({
          user_id: userId,
          role: String(row.role || 'member').trim() || 'member'
        });
      }

      const wantsSeed = !!(seedToggle && seedToggle.checked);
      const sourceCompanyId = String(seedSource ? seedSource.value : '').trim();
      if(wantsSeed && !sourceCompanyId){
        setProvisioningMessage('Select a source company to seed inventory.');
        return;
      }

      const btn = $('btnProvisioningRun');
      state._provisioningBusy = true;
      renderProvisioningUsersList();
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Provisioning...';
      }
      setProvisioningMessage('');
      state._provisioningResult = null;
      renderProvisioningSummary();

      const result = {
        company: null,
        users: null,
        tier: null,
        seeding: null,
      };

      try{
        const tierValue = String(tierSelect ? tierSelect.value : '').trim();
        const endsAtRaw = String(tierEndsAt ? tierEndsAt.value : '').trim();
        let endsAt = null;
        if(endsAtRaw){
          const parsed = new Date(endsAtRaw);
          if(Number.isNaN(parsed.getTime())){
            setProvisioningMessage('Override end date is invalid.');
            throw new Error('Invalid override end date');
          }
          endsAt = parsed.toISOString();
        }
        if(endsAt && !tierValue){
          setProvisioningMessage('Select a subscription tier before setting an end date.');
          throw new Error('Override tier required');
        }
        const payload = {
          p_name: companyName,
          p_slug: slug,
          p_subscription_tier: tierValue || null,
          p_subscription_tier_reason: 'Provisioning',
          p_subscription_tier_ends_at: endsAt,
          p_seed_inventory: wantsSeed,
          p_source_company_id: wantsSeed ? sourceCompanyId : null,
          p_seed_dedupe_key: String(seedDedupe ? seedDedupe.value : 'sku').trim() || 'sku',
          p_user_assignments: assignments,
          p_include_actor_as_admin: includeActor ? !!includeActor.checked : true
        };
        const { data, error } = await SB.client.rpc('provision_company', payload);
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Company creation failed');
        }
        const companyId = String((data && data.company_id) || '').trim();
        if(!companyId) throw new Error('Company id missing');
        result.company = { id: companyId, name: String(data.company_name || companyName), slug: String(data.company_slug || slug) };
        if(Array.isArray(SB.companies)){
          const existingIdx = SB.companies.findIndex(row => String(row.company_id) === companyId);
          const newRow = {
            company_id: companyId,
            company_name: String(data.company_name || companyName),
            company_slug: String(data.company_slug || slug),
            my_role: 'super_user',
            is_super_user: true,
            company_type: 'production',
          };
          if(existingIdx >= 0){
            SB.companies[existingIdx] = { ...SB.companies[existingIdx], ...newRow };
          }else{
            SB.companies = [newRow, ...SB.companies];
          }
          renderCompanySwitcher();
        }
        result.users = { count: Number(data.users_added_count || 0) };
        result.tier = data.tier_override || null;
        result.seeding = data.inventory_seed || null;
        const sourceRow = (Array.isArray(state._provisioningCompanies) ? state._provisioningCompanies : [])
          .find(r => String(r.company_id || r.id) === sourceCompanyId);
        if(result.seeding){
          result.seeding.source_name = sourceRow ? String(sourceRow.company_name || sourceRow.company_slug || sourceRow.company_id || '') : '';
          result.seeding.dedupe_key = payload.p_seed_dedupe_key;
          const seedErr = String(result.seeding.error || '').toLowerCase();
          if(seedErr && seedErr.includes('already seeded')){
            result.seeding.warning = true;
          }
        }
      }catch(e){
        result.company = { name: companyName, slug, error: e && e.message ? e.message : 'Company creation failed' };
        state._provisioningResult = result;
        renderProvisioningSummary();
        setProvisioningMessage(result.company.error);
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Provision Company';
        }
        state._provisioningBusy = false;
        renderProvisioningUsersList();
        return;
      }

      state._provisioningResult = result;
      renderProvisioningSummary();
      const hasIssues = Boolean(
        (result.users && result.users.error) ||
        (result.tier && result.tier.error) ||
        (result.seeding && result.seeding.error && !result.seeding.warning)
      );
      setProvisioningMessage(hasIssues ? 'Provisioning completed with issues.' : 'Provisioning complete.');
      if(btn){
        btn.disabled = false;
        btn.setAttribute('aria-disabled', 'false');
        btn.textContent = 'Provision Company';
      }
      state._provisioningBusy = false;
      renderProvisioningUsersList();
    }
    function setDiagnosticsMessage(msg){
      const el = $('diagSimMsg');
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function setDiagnosticsMetricOutput(content){
      const el = $('diagMetricOutput');
      if(!el) return;
      el.textContent = content || '';
    }
    function getDiagnosticsRole(){
      const raw = state._diagRole ? String(state._diagRole) : '';
      const normalized = raw ? normalizeRoleName(raw) : '';
      if(normalized) return normalized;
      return getAuthorityRole() || 'super_user';
    }
    function getDiagnosticsTier(){
      const raw = state._diagTier ? String(state._diagTier) : '';
      const normalized = raw ? normalizeTier(raw) : '';
      if(normalized) return normalized;
      return normalizeTier(getCompanyTier()) || TIER_FALLBACK;
    }
    function isDiagnosticsTierSimulated(){
      return !!state._diagTier;
    }
    function isDiagnosticsRoleSimulated(){
      return !!state._diagRole;
    }
    function isTierAtLeast(current, required){
      const currentTier = normalizeTier(current);
      const requiredTier = normalizeTier(required);
      if(!requiredTier) return true;
      return TIER_ORDER.indexOf(currentTier) >= TIER_ORDER.indexOf(requiredTier);
    }
    function hasPermissionInSet(permissions, key){
      if(!permissions || !key) return false;
      if(Object.prototype.hasOwnProperty.call(permissions, key)){
        return permissions[key] === true;
      }
      const legacy = LEGACY_PERMISSION_MAP[key];
      if(legacy && Array.isArray(legacy.any)){
        return legacy.any.some(k => permissions[k] === true);
      }
      if(legacy && Array.isArray(legacy.all)){
        return legacy.all.every(k => permissions[k] === true);
      }
      return false;
    }
    async function applyDiagnosticsSimulation(){
      const roleSelect = $('diagRoleSelect');
      const tierSelect = $('diagTierSelect');
      const roleValue = roleSelect ? String(roleSelect.value || '').trim() : '';
      const tierValue = tierSelect ? String(tierSelect.value || '').trim() : '';
      state._diagRole = roleValue ? normalizeRoleName(roleValue) : '';
      state._diagTier = tierValue ? normalizeTier(tierValue) : '';
      state._diagPermissions = null;
      if(state._diagRole && state._diagRole !== 'super_user'){
        state._diagPermissions = await loadImpersonationPermissions(state._diagRole);
      }
      renderDiagnosticsChecks();
      updateDiagnosticsMetricTierHint();
      if(!state._diagRole && !state._diagTier){
        setDiagnosticsMessage('Simulation cleared.');
      }else{
        const roleLabel = state._diagRole ? state._diagRole : 'current';
        const tierLabel = state._diagTier ? formatTierLabel(state._diagTier) : 'current';
        setDiagnosticsMessage(`Simulation active: role=${roleLabel}, tier=${tierLabel}.`);
      }
    }
    function resetDiagnosticsSimulation(){
      state._diagRole = '';
      state._diagTier = '';
      state._diagPermissions = null;
      const roleSelect = $('diagRoleSelect');
      const tierSelect = $('diagTierSelect');
      if(roleSelect) roleSelect.value = '';
      if(tierSelect) tierSelect.value = '';
      renderDiagnosticsChecks();
      updateDiagnosticsMetricTierHint();
      setDiagnosticsMessage('Simulation cleared.');
    }
    function getDiagnosticsPermissions(){
      const role = getDiagnosticsRole();
      if(role === 'super_user') return null;
      if(state._diagPermissions && typeof state._diagPermissions === 'object') return state._diagPermissions;
      return getEffectivePermissions();
    }
    function getDiagnosticsTierLabel(){
      const tier = getDiagnosticsTier();
      const label = formatTierLabel(tier);
      return isDiagnosticsTierSimulated() ? `${label} (simulated)` : label;
    }
    const DIAGNOSTIC_CHECKS = [
      {
        id: 'items_view',
        label: 'Inventory Items: View',
        requiredTier: 'starter',
        requiredPermission: PERMISSIONS.ITEMS_VIEW,
        source: 'policy',
      },
      {
        id: 'items_export',
        label: 'Inventory: Export',
        requiredTier: 'professional',
        requiredPermission: PERMISSIONS.ITEMS_EXPORT,
        source: 'workflow',
      },
      {
        id: 'orders_view',
        label: 'Orders: View',
        requiredTier: 'business',
        requiredPermission: PERMISSIONS.ORDERS_VIEW,
        source: 'policy',
      },
      {
        id: 'orders_create',
        label: 'Orders: Create',
        requiredTier: 'business',
        requiredPermission: PERMISSIONS.ORDERS_CREATE,
        source: 'policy',
      },
      {
        id: 'snapshots_view',
        label: 'Snapshots: View',
        requiredTier: 'business',
        requiredPermission: PERMISSIONS.SNAPSHOTS_VIEW,
        source: 'workflow',
      },
      {
        id: 'metrics_dashboard',
        label: 'Metrics Dashboard',
        requiredTier: 'professional',
        requiredPermission: PERMISSIONS.METRICS_VIEW,
        source: 'workflow',
      },
      {
        id: 'audit_log_view',
        label: 'Audit Log: View',
        requiredTier: 'enterprise',
        requiredPermission: PERMISSIONS.AUDIT_LOG_VIEW,
        source: 'policy',
      },
      {
        id: 'platform_metrics',
        label: 'Platform Metrics',
        requiredTier: 'professional',
        requiredPermission: PERMISSIONS.PLATFORM_VIEW_METRICS,
        source: 'workflow',
      },
    ];
    function renderDiagnosticsChecks(){
      const container = $('diagChecks');
      if(!container) return;
      if(!SB.session || !isEffectiveSuperUser()){
        container.innerHTML = '<div class="trash-empty">Super user access required.</div>';
        return;
      }
      const role = getDiagnosticsRole();
      const tierLabel = getDiagnosticsTierLabel();
      const permissions = getDiagnosticsPermissions();
      const rows = DIAGNOSTIC_CHECKS.map(check => {
        const tierOk = role === 'super_user' ? true : isTierAtLeast(getDiagnosticsTier(), check.requiredTier);
        const permissionOk = role === 'super_user'
          ? true
          : (check.requiredPermission ? hasPermissionInSet(permissions, check.requiredPermission) : true);
        let rule = 'allowed';
        let allowed = true;
        if(role === 'super_user'){
          rule = 'super_user_bypass';
        }else if(!tierOk){
          rule = 'tier_gate';
          allowed = false;
        }else if(!permissionOk){
          rule = 'permission_gate';
          allowed = false;
        }
        const requiredPermission = check.requiredPermission || 'â€”';
        const badge = `<span class="diag-badge ${allowed ? 'pass' : 'fail'}">${allowed ? 'ALLOW' : 'BLOCK'}</span>`;
        return (
          `<tr>` +
            `<td>${escapeHtml(check.label)}</td>` +
            `<td>${escapeHtml(check.source)}</td>` +
            `<td>${escapeHtml(formatTierLabel(check.requiredTier))}</td>` +
            `<td>${escapeHtml(requiredPermission)}</td>` +
            `<td>${escapeHtml(tierLabel)}</td>` +
            `<td>${escapeHtml(rule)}</td>` +
            `<td>${badge}</td>` +
          `</tr>`
        );
      }).join('');
      container.innerHTML =
        `<table class="diag-table">` +
          `<thead>` +
            `<tr>` +
              `<th>Action</th>` +
              `<th>Source</th>` +
              `<th>Required Tier</th>` +
              `<th>Required Permission</th>` +
              `<th>Current Tier</th>` +
              `<th>Rule Fired</th>` +
              `<th>Result</th>` +
            `</tr>` +
          `</thead>` +
          `<tbody>${rows}</tbody>` +
        `</table>`;
    }
    function mapSubscriptionTierToMetricTier(tier){
      const normalized = normalizeTier(tier);
      if(normalized === 'starter') return 'TIER_1';
      if(normalized === 'professional') return 'TIER_2';
      if(normalized === 'business') return 'TIER_2';
      if(normalized === 'enterprise') return 'TIER_3';
      return 'TIER_1';
    }
    function updateDiagnosticsMetricTierHint(){
      const hint = $('diagMetricTierHint');
      if(!hint) return;
      const tier = getDiagnosticsTier();
      const metricTier = mapSubscriptionTierToMetricTier(tier);
      const label = isDiagnosticsTierSimulated()
        ? `Metric tier preview uses ${metricTier} (from simulated ${formatTierLabel(tier)}).`
        : `Metric tier preview uses ${metricTier} (from ${formatTierLabel(tier)}).`;
      hint.textContent = label;
    }
    function getMetricsPreviewUrl(){
      const override = (typeof window.METRICS_PREVIEW_URL === 'string') ? window.METRICS_PREVIEW_URL.trim() : '';
      if(override) return override;
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/metrics-preview`;
      return '/functions/v1/metrics-preview';
    }
    function parseDiagnosticsJson(value){
      const raw = String(value || '').trim();
      if(!raw) return {};
      return JSON.parse(raw);
    }
    async function runDiagnosticsMetricPreview(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required');
        return;
      }
      const metricId = String($('diagMetricId')?.value || '').trim();
      if(!metricId){
        setDiagnosticsMetricOutput('Metric ID is required.');
        return;
      }
      let context = {};
      let inputs = {};
      try{
        context = parseDiagnosticsJson($('diagMetricContext')?.value || '');
      }catch(e){
        setDiagnosticsMetricOutput('Invalid JSON in Time Context.');
        return;
      }
      try{
        inputs = parseDiagnosticsJson($('diagMetricInputs')?.value || '');
      }catch(e){
        setDiagnosticsMetricOutput('Invalid JSON in Inputs.');
        return;
      }
      const metricTier = mapSubscriptionTierToMetricTier(getDiagnosticsTier());
      const payload = {
        metric_id: metricId,
        context,
        inputs,
        simulate_tier: metricTier
      };
      setDiagnosticsMetricOutput('Running preview...');
      try{
        const apiUrl = getMetricsPreviewUrl();
        const headers = { 'content-type': 'application/json' };
        const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
        const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
        if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
          headers['apikey'] = sbKey;
          if(SB.session && SB.session.access_token){
            headers['Authorization'] = `Bearer ${SB.session.access_token}`;
          }
        }
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers,
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if(!res.ok){
          const msg = data && data.error ? `${data.error.code || 'Error'}: ${data.error.message || ''}` : 'Preview failed';
          const tierEval = data && data.tier_evaluation ? data.tier_evaluation : null;
          const output = {
            ok: false,
            error: msg,
            tier_evaluation: tierEval,
          };
          setDiagnosticsMetricOutput(JSON.stringify(output, null, 2));
          return;
        }
        setDiagnosticsMetricOutput(JSON.stringify(data, null, 2));
      }catch(e){
        setDiagnosticsMetricOutput('Preview failed.');
      }
    }
    function openDiagnosticsModal(){
      if(!SB.session || !isEffectiveSuperUser()){
        toast('Super user access required.');
        return;
      }
      const roleSelect = $('diagRoleSelect');
      const tierSelect = $('diagTierSelect');
      if(roleSelect) roleSelect.value = state._diagRole ? state._diagRole : '';
      if(tierSelect) tierSelect.value = state._diagTier ? state._diagTier : '';
      renderDiagnosticsChecks();
      updateDiagnosticsMetricTierHint();
      setDiagnosticsMetricOutput('');
      if(state._diagRole || state._diagTier){
        const roleLabel = state._diagRole ? state._diagRole : 'current';
        const tierLabel = state._diagTier ? formatTierLabel(state._diagTier) : 'current';
        setDiagnosticsMessage(`Simulation active: role=${roleLabel}, tier=${tierLabel}.`);
      }else{
        setDiagnosticsMessage('');
      }
      show('diagnosticsModal', true);
    }
    function renderRoleTestingSwitcher(){
      const section = $('profileRoleTestingSection');
      const select = $('profileRoleTestingSelect');
      const hint = $('profileRoleTestingHint');
      if(!section || !select) return;
      if(!SB.session || !isSuperUser()){
        section.style.display = 'none';
        if(hint) hint.textContent = '';
        return;
      }
      section.style.display = '';
      const options = getImpersonationRoleOptions();
      const selected = ensureImpersonationRole(state._impersonationRole);
      select.innerHTML = options.map(role => (
        `<option value="${escapeHtmlAttr(role)}">${escapeHtml(role)}</option>`
      )).join('');
      select.value = options.includes(selected) ? selected : 'super_user';
      select.disabled = false;
      select.setAttribute('aria-disabled', 'false');
      if(hint){
        const effective = getEffectiveRole() || 'super_user';
        const label = isImpersonating() ? `Testing as ${effective}` : 'Testing mode';
        hint.textContent = `${label}. UI only; backend stays super_user.`;
      }
    }
    function formatTierLabel(value){
      const tier = normalizeTier(value);
      if(!tier) return 'â€”';
      return TIER_LABELS[tier] || tier;
    }
    function formatBillingState(value){
      const state = String(value || '').trim().toLowerCase();
      if(!state) return 'â€”';
      if(state === 'none') return 'None';
      return state.charAt(0).toUpperCase() + state.slice(1);
    }
    function formatDurationMinutes(ms){
      const totalMinutes = Math.max(0, Math.floor(ms / 60000));
      const days = Math.floor(totalMinutes / 1440);
      const hours = Math.floor((totalMinutes % 1440) / 60);
      const minutes = totalMinutes % 60;
      const parts = [];
      if(days) parts.push(`${days}d`);
      if(hours || (days && minutes)) parts.push(`${hours}h`);
      if(!days && !hours) parts.push(`${minutes}m`);
      return parts.join(' ');
    }
    function formatOverrideExpiry(value){
      if(!value) return 'â€”';
      const end = new Date(value);
      if(Number.isNaN(end.getTime())) return 'â€”';
      const now = new Date();
      const delta = end.getTime() - now.getTime();
      const when = formatEasternDateTime(end);
      if(delta <= 0) return `${when} Â· expired`;
      return `${when} Â· in ${formatDurationMinutes(delta)}`;
    }
    function normalizeCompanyType(value){
      const type = String(value || '').trim().toLowerCase();
      if(type === 'development') return 'sandbox';
      if(type === 'staging') return 'test';
      if(type === 'sandbox' || type === 'test' || type === 'system' || type === 'production') return type;
      return 'production';
    }
    function formatCompanyTypeLabel(value){
      const type = normalizeCompanyType(value);
      if(type === 'production') return 'Production';
      if(type === 'sandbox') return 'Development';
      if(type === 'test') return 'Test';
      if(type === 'system') return 'System';
      return 'Production';
    }
    function renderCompanyEnvBadge(){
      const badge = $('profileEnvBadge');
      if(!badge) return;
      if(!SB.companyId){
        badge.textContent = '';
        badge.className = 'env-badge profile-env-badge hidden';
        return;
      }
      const type = normalizeCompanyType(SB.company && SB.company.company_type);
      badge.textContent = formatCompanyTypeLabel(type);
      badge.className = `env-badge profile-env-badge env-${type}`;
    }
    function setTierOverrideMessage(msg){
      const el = $('tierOverrideMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    async function loadTierDetails(companyId){
      if(!SB.ready || !SB.session || !SB.client) return null;
      try{
        const { data, error } = await SB.client.rpc('get_company_tier_details', {
          p_company_id: companyId
        });
        if(error) throw error;
        const row = Array.isArray(data) ? data[0] : data;
        return row && typeof row === 'object' ? row : null;
      }catch(e){
        console.warn('Tier details load failed:', e);
        return null;
      }
    }
    async function refreshTierAdminDetails(){
      if(!SB.companyId) return;
      state._tierDetailsCompanyId = String(SB.companyId);
      state._tierDetails = await loadTierDetails(SB.companyId);
      renderTierAdminSection();
    }
    function renderTierAdminSection(){
      const section = $('tierOverrideSection');
      const divider = $('tierOverrideDivider');
      if(!section) return;
      if(!SB.session || !isEffectiveSuperUser() || !SB.companyId){
        section.style.display = 'none';
        if(divider) divider.style.display = 'none';
        return;
      }
      section.style.display = '';
      if(divider) divider.style.display = '';
      const companyName = SB.company ? String(SB.company.company_name || SB.company.company_slug || SB.company.company_id || '') : '';
      const meta = $('tierOverrideCompany');
      if(meta) meta.textContent = companyName ? `Company: ${companyName}` : '';

      const baseSelect = $('tierBaseSelect');
      if(baseSelect){
        baseSelect.innerHTML = TIER_ORDER.map(tier => (
          `<option value="${escapeHtmlAttr(tier)}">${escapeHtml(formatTierLabel(tier))}</option>`
        )).join('');
      }
      const overrideSelect = $('tierOverrideTierSelect');
      if(overrideSelect){
        const options = ['', ...TIER_ORDER];
        overrideSelect.innerHTML = options.map(tier => {
          const label = tier ? formatTierLabel(tier) : 'Select tier';
          return `<option value="${escapeHtmlAttr(tier)}">${escapeHtml(label)}</option>`;
        }).join('');
      }

      const details = (state._tierDetailsCompanyId === String(SB.companyId)) ? state._tierDetails : null;
      if(!details){
        if($('tierBaseValue')) $('tierBaseValue').textContent = 'Loadingâ€¦';
        if($('tierOverrideValue')) $('tierOverrideValue').textContent = 'Loadingâ€¦';
        if($('tierEffectiveValue')) $('tierEffectiveValue').textContent = 'Loadingâ€¦';
        if($('tierOverrideExpiresValue')) $('tierOverrideExpiresValue').textContent = 'Loadingâ€¦';
        if(baseSelect) baseSelect.value = '';
        if(overrideSelect) overrideSelect.value = '';
        const endsInput = $('tierOverrideEndsAt');
        if(endsInput) endsInput.value = '';
        setTierOverrideMessage('');
        void refreshTierAdminDetails();
        return;
      }

      if($('tierBaseValue')) $('tierBaseValue').textContent = formatTierLabel(details.base_tier);
      if($('tierOverrideValue')) $('tierOverrideValue').textContent = details.override_tier ? formatTierLabel(details.override_tier) : 'None';
      if($('tierEffectiveValue')) $('tierEffectiveValue').textContent = formatTierLabel(details.effective_tier);
      if($('tierOverrideExpiresValue')) $('tierOverrideExpiresValue').textContent = formatOverrideExpiry(details.override_ends_at);
      if(baseSelect) baseSelect.value = normalizeTier(details.base_tier) || 'starter';
      if(overrideSelect) overrideSelect.value = '';
      const endsInput = $('tierOverrideEndsAt');
      if(endsInput) endsInput.value = '';
      const revokeBtn = $('btnTierOverrideRevoke');
      if(revokeBtn){
        const canRevoke = !!details.override_tier;
        revokeBtn.disabled = !canRevoke;
        revokeBtn.setAttribute('aria-disabled', canRevoke ? 'false' : 'true');
      }
      setTierOverrideMessage('');
    }
	    function setInviteMessage(msg){
	      const el = $('inviteMsg'); if(!el) return;
	      el.textContent = String(msg || '');
	    }
	    function showInviteLink(url){
	      const row = $('inviteLinkRow');
	      const input = $('inviteLink');
	      if(!row || !input) return;
	      const value = String(url || '').trim();
	      input.value = value;
	      row.style.display = value ? 'flex' : 'none';
	    }
    function renderInviteUi(){
      const section = $('inviteSection');
      const email = $('inviteEmail');
      const role = $('inviteRole');
      const btn = $('btnInviteSend');
      const companyRow = $('inviteCompanyRow');
      const companySelect = $('inviteCompany');
      if(!section) return;
      if(!SB.session){
        section.style.display = 'none';
        return;
      }
      section.style.display = '';
      const superUser = isEffectiveSuperUser();
      if(companyRow) companyRow.style.display = superUser ? '' : 'none';
      let selectedCompanyId = SB.companyId ? String(SB.companyId) : '';
      if(superUser && companySelect){
        let rows = Array.isArray(SB.companies) ? SB.companies.slice() : [];
        // During onboarding, ensure the onboarding company is in the list
        if(_onboardingCompanyId && !rows.some(r => String(r.company_id) === _onboardingCompanyId)){
          // Add onboarding company from SB.company if available
          if(SB.company && String(SB.company.id || SB.company.company_id || '') === _onboardingCompanyId){
            rows.unshift({
              company_id: _onboardingCompanyId,
              company_name: SB.company.name || SB.company.company_name || 'Onboarding Company',
              company_slug: SB.company.slug || SB.company.company_slug || ''
            });
          }
        }
        companySelect.innerHTML = '';
        if(!rows.length){
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No companies available';
          companySelect.appendChild(opt);
          companySelect.disabled = true;
          selectedCompanyId = '';
        }else{
          rows.forEach(row => {
            const id = String(row && row.company_id ? row.company_id : '').trim();
            if(!id) return;
            const name = String(row.company_name || row.company_slug || row.company_id || '').trim() || id;
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = name;
            companySelect.appendChild(opt);
          });
          // During onboarding, default to the onboarding company
          if(isOnboardingRoute() && _onboardingCompanyId && rows.some(r => String(r.company_id) === _onboardingCompanyId)){
            selectedCompanyId = _onboardingCompanyId;
          }else if(_inviteCompanyId && rows.some(r => String(r.company_id) === _inviteCompanyId)){
            selectedCompanyId = _inviteCompanyId;
          }else if(!selectedCompanyId || !rows.some(r => String(r.company_id) === selectedCompanyId)){
            selectedCompanyId = String(rows[0].company_id || '');
          }
          companySelect.value = selectedCompanyId || '';
          companySelect.disabled = rows.length <= 1;
        }
      }
      const currentCompanyId = superUser
        ? String(selectedCompanyId || '').trim()
        : (SB.companyId ? String(SB.companyId) : '');
      if(currentCompanyId !== _inviteCompanyId){
        _inviteCompanyId = currentCompanyId;
        showInviteLink('');
        setInviteMessage('');
      }
      const allow = !!(currentCompanyId && canAccessInvites());
      const disabled = !allow;
      if(email) email.disabled = disabled;
      if(role) role.disabled = disabled;
      if(btn){
	        btn.disabled = disabled;
	        btn.setAttribute('aria-disabled', disabled ? 'true' : 'false');
	      }
      if(disabled){
        showInviteLink('');
        if(!currentCompanyId){
          setInviteMessage('Select a company to invite users.');
        }else if(!hasTier('business')){
          setInviteMessage('Invites require Business tier.');
        }else if(!canInvite()){
          setInviteMessage('Invite permissions required.');
        }else{
	          setInviteMessage('');
	        }
	      }
	    }
	    function storeInviteTokenFromUrl(){
	      try{
	        const params = new URLSearchParams(window.location.search);
	        const token = params.get('invite') || params.get('invite_id');
	        if(!token) return '';
	        localStorage.setItem('inv.pendingInvite', token);
	        window.history.replaceState({}, '', window.location.pathname);
	        return token;
	      }catch(e){}
	      return '';
	    }
	    async function sbCheckPendingInvite(){
	      storeInviteTokenFromUrl();
	      if(!SB.ready || !SB.session || !SB.client) return false;
	      const token = localStorage.getItem('inv.pendingInvite');
	      if(!token) return false;
	      try{
	        const { data, error } = await SB.client.rpc('accept_company_invite', { p_invite_id: token });
	        if(error) throw error;
	        if(data && data.success){
	          localStorage.removeItem('inv.pendingInvite');
	          const role = data.role ? String(data.role) : 'member';
	          toast(`Welcome! Joined as ${role}.`);
	          return true;
	        }
	        const msg = data && data.error ? String(data.error) : 'Failed to accept invitation';
	        if(!/different email/i.test(msg)){
	          localStorage.removeItem('inv.pendingInvite');
	        }
	        toast(msg);
	      }catch(e){
	        toast('Invitation error');
	      }
	      return false;
	    }
    function getInviteAcceptUrl(){
      const override = (typeof window.INVITE_ACCEPT_URL === 'string') ? window.INVITE_ACCEPT_URL.trim() : '';
      if(override) return override;
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/accept-invite`;
      return '/functions/v1/accept-invite';
    }
    function getPendingInviteToken(){
      try{
        return localStorage.getItem('inv.pendingInvite') || '';
      }catch(e){
        return '';
      }
    }
    function setInviteAcceptMessage(msg){
      const el = $('inviteAcceptMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function resetInviteAcceptForm(){
      const pw = $('inviteAcceptPassword');
      const confirm = $('inviteAcceptPasswordConfirm');
      if(pw) pw.value = '';
      if(confirm) confirm.value = '';
      setInviteAcceptMessage('');
    }
    function openInviteAcceptModal(){
      resetInviteAcceptForm();
      show('inviteAcceptModal', true);
    }
    function closeInviteAcceptModal(){
      show('inviteAcceptModal', false);
    }
    async function sbCompleteInvite(password, confirm){
      const token = getPendingInviteToken();
      if(!token) throw Error('Invite token missing');
      const pw = String(password || '');
      const pwConfirm = String(confirm || '');
      if(pw.length < 8) throw Error('Use at least 8 characters');
      if(pw !== pwConfirm) throw Error('Passwords do not match');
      const apiUrl = getInviteAcceptUrl();
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        headers['Authorization'] = `Bearer ${SB.session && SB.session.access_token ? SB.session.access_token : sbKey}`;
      }
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify({ invite_id: token, password: pw }),
      });
      const data = await res.json().catch(() => ({}));
      if(!res.ok){
        const errText = data && (data.error || data.message) ? String(data.error || data.message) : 'Invite setup failed';
        return { ok: false, error: errText, code: data?.code, email: data?.email };
      }
      return data || { ok: true };
    }
    function getInviteSendUrl(){
      const override = (typeof window.INVITE_SEND_URL === 'string') ? window.INVITE_SEND_URL.trim() : '';
      if(override) return override;
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/send-invite`;
      return '/functions/v1/send-invite';
    }
    async function sbInviteUser(email, role, companyId, opts = {}){
      if(!SB.ready || !SB.client) throw Error('Not authorized');
      const options = (opts && typeof opts === 'object') ? opts : {};
      const targetCompanyId = String(companyId || '').trim() || (SB.companyId ? String(SB.companyId) : '');
      if(!targetCompanyId) throw Error('Company not selected');
      const currentCompanyId = SB.companyId ? String(SB.companyId) : '';
      const enforceChecks = options.skipChecks !== true && (!currentCompanyId || targetCompanyId === currentCompanyId);
      if(enforceChecks && !hasTier('business')) throw Error('Invites require Business tier');
      if(enforceChecks && !canInvite()) throw Error('Permission denied');
      const cleanEmail = String(email || '').trim();
      if(!cleanEmail) throw Error('Email required');
      const cleanRole = String(role || 'member').trim() || 'member';
      const apiUrl = getInviteSendUrl();
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        if(SB.session && SB.session.access_token){
          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
        }
      }
      const baseUrl = `${window.location.origin}${window.location.pathname}`.replace(/\?[^#]*$/, '');
      const payload = {
        email: cleanEmail,
        role: cleanRole,
        company_id: targetCompanyId,
        app_url: baseUrl,
      };
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload),
      });
      const data = await res.json().catch(() => ({}));
      if(!res.ok){
        return {
          ok: false,
          error: data && data.error ? data.error : 'Invite failed',
          invite_url: data && data.invite_url ? data.invite_url : '',
          invite_id: data && data.invite_id ? data.invite_id : '',
          expires_at: data && data.expires_at ? data.expires_at : null,
        };
      }
      if(data && data.ok === false){
        return {
          ok: false,
          error: data.error || 'Invite failed',
          invite_url: data.invite_url || '',
          invite_id: data.invite_id || '',
          expires_at: data.expires_at || null,
        };
      }
      return {
        ok: true,
        invite_url: data && data.invite_url ? data.invite_url : '',
        invite_id: data && data.invite_id ? data.invite_id : '',
        expires_at: data && data.expires_at ? data.expires_at : null,
      };
	    }
	    function resetCompanyScopedState(){
	      state.items = [];
	      try{ applySelectedRowIds([]); }catch(e){}
	      try{ clearAllOrderLines(); }catch(e){}
      state._orderHistoryRows = [];
      state._orderHistoryById = new Map();
      state._orderHistoryLinesByPo = new Map();
      state._orderHistoryFilter = '';
	      const orderHistoryFilter = $('orderHistoryFilter');
	      if(orderHistoryFilter) orderHistoryFilter.value = '';
	      state._trashItems = [];
	      state._trashFilter = '';
	      const trashFilter = $('trashFilter');
	      if(trashFilter) trashFilter.value = '';
	      state._roleRequestPending = null;
      state._roleRequests = [];
      state._auditRows = [];
      state._auditTableFilter = '';
      state._auditActionFilter = '';
      state._auditSearch = '';
      const auditSearch = $('auditSearchFilter');
      if(auditSearch) auditSearch.value = '';
      state._shippingAddresses = [];
      state._shippingAddressById = new Map();
      state._shippingAddressEditing = null;
      state._orderShippingOptions = [];
      state._orderShippingById = new Map();
      state._companyLocations = [];
      state._companyLocationById = new Map();
      state._companyLocationEditing = null;
      state._receiveOrder = null;
      state._userMgmtRows = [];
      state._pendingInvites = [];
      state._pendingInviteBusy = {};
      state._snapshots = [];
      state._snapshotPreview = null;
      state._metrics = null;
      state._roleConfigs = {};
      state._roleChanges = {};
      _inviteCompanyId = '';
      _userMgmtCompanyId = '';
      updateOrderCounterBadge();
    }
	    async function sbSwitchCompany(nextCompanyId, opts = {}){
	      if(!SB.ready || !SB.session) return false;
      const options = (opts && typeof opts === 'object') ? opts : {};
      const persist = options.persist !== false;
      const audit = options.audit === true;
      const source = options.source ? String(options.source) : null;
      const rowOverride = options.companyRow && typeof options.companyRow === 'object' ? options.companyRow : null;
	      const nextId = String(nextCompanyId || '').trim();
	      if(!nextId || nextId === SB.companyId) return false;
	      const rows = Array.isArray(SB.companies) ? SB.companies : [];
      let target = rowOverride ? { ...rowOverride } : (rows.find(r => String(r.company_id) === nextId) || null);
	      if(!target){
	        toast('Company not found');
	        renderCompanySwitcher();
	        return false;
	      }
      if(rowOverride && !isEffectiveSuperUser()){
        toast('Super user access required');
        return false;
      }
      const prev = {
        companyId: SB.companyId,
        company: SB.company,
        permissions: SB.permissions,
        authorized: SB.authorized,
        connected: SB.connected,
        companyType: normalizeCompanyType(SB.company && SB.company.company_type),
      };
      target.company_type = normalizeCompanyType(target.company_type);
      SB.companyId = nextId;
      SB.company = target;
      SB.companyTier = SB.company ? getCompanyTier() : null;
      state._tierDetails = null;
      state._tierDetailsCompanyId = null;
      if(persist) saveCompanyId(nextId);
      SB.permissions = null;
      SB.authorized = false;
      SB.connected = false;
      updateStatusBar();
      renderCompanySwitcher();
      renderTierAdminSection();
	      applyPermissionUI();
	      resetCompanyScopedState();
	      render();
	      if(_sbChannel && SB.client){ try{ SB.client.removeChannel(_sbChannel); }catch(e){} _sbChannel = null; }
	      try{
	        await sbLoadPermissions();
	      }catch(e){
	        console.warn('Permissions load failed:', e);
	        SB.companyId = prev.companyId;
	        SB.company = prev.company;
	        SB.permissions = prev.permissions;
	        SB.authorized = prev.authorized;
	        SB.connected = prev.connected;
	        updateStatusBar();
	        renderCompanySwitcher();
	        applyPermissionUI();
	        render();
	        toast('Company switch failed');
	        return false;
	      }
      resetImpersonationState('company_switch');
	      SB.authorized = !!(SB.permissions && hasPermission(PERMISSIONS.ITEMS_VIEW));
	      updateStatusBar();
      renderProfileUi();
      applyPermissionUI();
      if(audit && SB.client){
        try{
          await SB.client.rpc('log_company_switch', {
            p_company_id: nextId,
            p_from_company_id: prev.companyId ? String(prev.companyId) : null,
            p_from_company_type: prev.companyType || null,
            p_to_company_type: target.company_type || null,
            p_source: source || null
          });
        }catch(e){
          console.warn('Company switch audit failed:', e);
        }
      }
      if(isOnboardingRoute()){
        await handleOnboardingRoute();
      }
      if(!SB.authorized) return true;
      await checkServerHealth();
	      if(isOnline()){
	        await sbLoadSnapshot();
	        sbStartRealtime();
	      }
	      return true;
	    }
	    async function sbEnsureProfile(){
	      if(!SB.ready || !SB.user) return null;
	      try{
	        const { data, error } = await SB.client
	          .from('profiles')
	          .select('*')
	          .eq('user_id', SB.user.id)
	          .maybeSingle();
	        if(error) throw error;
	        if(data){
	          data.first_name = data.first_name || '';
	          data.last_name = data.last_name || '';
	          data.phone = data.phone || '';
	          if(typeof data.silence_low_stock_alerts === 'undefined'){
	            data.silence_low_stock_alerts = lowStockAlertsSilenced();
	          }else{
	            data.silence_low_stock_alerts = !!data.silence_low_stock_alerts;
	          }
	          if(typeof data.low_stock_qty_global === 'undefined' || data.low_stock_qty_global === null){
	            data.low_stock_qty_global = getGlobalLowStockQty();
	          }else{
	            data.low_stock_qty_global = toInt(data.low_stock_qty_global, 0);
	          }
	          try{ localStorage.setItem('inv.pref.silenceLowStockAlerts', data.silence_low_stock_alerts ? '1' : '0'); }catch(e){}
	          try{ localStorage.setItem('inv.pref.lowStockQtyGlobal', String(toInt(data.low_stock_qty_global,0))); }catch(e){}
	          SB.profile = data;
	          return data;
	        }

	        const desiredSilence = lowStockAlertsSilenced();
	        const desiredGlobal = getGlobalLowStockQty();
	        const base = {
	          user_id: SB.user.id,
	          email: String(SB.user.email||'').trim(),
	          first_name: '',
	          last_name: '',
	          phone: '',
	        };
	        const attempts = [
	          { silence:true, global:true },
	          { silence:true, global:false },
	          { silence:false, global:true },
	          { silence:false, global:false },
	        ];
	        let lastError = null;
	        for(const a of attempts){
	          const row = { ...base };
	          if(a.silence) row.silence_low_stock_alerts = desiredSilence;
	          if(a.global) row.low_stock_qty_global = desiredGlobal;
	          const res = await SB.client.from('profiles').insert([row]);
	          if(!res.error){
	            SB.profile = { ...row };
	            SB.profile.silence_low_stock_alerts = desiredSilence;
	            SB.profile.low_stock_qty_global = desiredGlobal;
	            return SB.profile;
	        }
	        lastError = res.error;
	        const msg = errToText(res.error);
	        if(!(msg.includes('silence_low_stock_alerts') || msg.includes('low_stock_qty_global'))){
	          break;
	        }
	        }
	        if(lastError) throw lastError;
	        throw Error('Profile create failed');
	      }catch(e){
	        console.warn('Profile ensure failed:', e);
	        SB.profile = {
	          user_id: SB.user.id,
	          email: String(SB.user.email||'').trim(),
	          first_name: '',
	          last_name: '',
	          phone: '',
	          silence_low_stock_alerts: lowStockAlertsSilenced(),
	          low_stock_qty_global: getGlobalLowStockQty(),
	        };
	        return SB.profile;
	      }
	    }
    async function sbSaveProfile(firstName, lastName, phone, silenceLowStockAlerts, lowStockQtyGlobal){
      if(!SB.ready || !SB.user) throw Error('Not signed in');
      const desiredSilence = !!silenceLowStockAlerts;
      const desiredGlobal = toInt(lowStockQtyGlobal, -1);
      if(desiredGlobal < 0) throw Error('Global low stock qty must be integer â‰¥ 0');
      try{ localStorage.setItem('inv.pref.silenceLowStockAlerts', desiredSilence ? '1' : '0'); }catch(e){}
      try{ localStorage.setItem('inv.pref.lowStockQtyGlobal', String(desiredGlobal)); }catch(e){}

      const base = {
        user_id: SB.user.id,
        email: String(SB.user.email||'').trim(),
        first_name: String(firstName||'').trim(),
        last_name: String(lastName||'').trim(),
        phone: String(phone||'').trim(),
      };

      const attempts = [
        { silence:true, global:true },
        { silence:true, global:false },
        { silence:false, global:true },
        { silence:false, global:false },
      ];
      let lastError = null;
      for(const a of attempts){
        const row = { ...base };
        if(a.silence) row.silence_low_stock_alerts = desiredSilence;
        if(a.global) row.low_stock_qty_global = desiredGlobal;
        const res = await SB.client.from('profiles').upsert([row], { onConflict: 'user_id' });
        if(!res.error){
          SB.profile = { ...row };
          SB.profile.silence_low_stock_alerts = desiredSilence;
          SB.profile.low_stock_qty_global = desiredGlobal;
          return SB.profile;
        }
        lastError = res.error;
        const msg = String(res.error && res.error.message ? res.error.message : '');
        if(!(msg.includes('silence_low_stock_alerts') || msg.includes('low_stock_qty_global'))){
          break;
        }
      }
      if(lastError) throw lastError;
      throw Error('Save failed');
    }
    async function sbRefreshAccess(){
      SB.authorized = false;
      SB.permissions = null;
      SB.companies = [];
      SB.companyId = null;
      SB.company = null;
      SB.companyTier = null;
      state._tierDetails = null;
      state._tierDetailsCompanyId = null;
      if(!SB.ready || !SB.user){ updateStatusBar(); return false; }
      try{
        await sbLoadCompanies();
      }catch(e){
        console.warn('Company load failed:', e);
        updateStatusBar();
        renderCompanySwitcher();
        renderAdvancedCompanySwitcherButton();
        renderProvisioningDashboardButton();
        renderDiagnosticsButton();
        renderSubscriptionManagerButton();
        renderCompanyLocationsButton();
        renderInviteUi();
        renderRoleRequestUi();
        renderRoleRequestsAdminButton();
        renderRoleManagerButton();
        renderUserMgmtButton();
        renderPendingInvitesSection();
        return false;
      }
      if(!SB.companyId){
        updateStatusBar();
        renderCompanySwitcher();
        renderAdvancedCompanySwitcherButton();
        renderProvisioningDashboardButton();
        renderDiagnosticsButton();
        renderSubscriptionManagerButton();
        renderCompanyLocationsButton();
        renderInviteUi();
        renderRoleRequestUi();
        renderRoleRequestsAdminButton();
        renderRoleManagerButton();
        renderUserMgmtButton();
        return false;
      }
      try{
        await sbLoadPermissions();
      }catch(e){
        console.warn('Permissions load failed:', e);
        updateStatusBar();
        renderCompanySwitcher();
        renderAdvancedCompanySwitcherButton();
        renderProvisioningDashboardButton();
        renderDiagnosticsButton();
        renderSubscriptionManagerButton();
        renderCompanyLocationsButton();
        renderInviteUi();
        renderRoleRequestUi();
        renderRoleRequestsAdminButton();
        renderRoleManagerButton();
        renderUserMgmtButton();
        return false;
      }
      SB.authorized = !!(SB.permissions && hasPermission(PERMISSIONS.ITEMS_VIEW));
      updateStatusBar();
      renderCompanySwitcher();
      renderAdvancedCompanySwitcherButton();
      renderProvisioningDashboardButton();
      renderDiagnosticsButton();
      renderSubscriptionManagerButton();
      renderCompanyLocationsButton();
      renderInviteUi();
      renderRoleRequestUi();
      renderRoleRequestsAdminButton();
      renderRoleManagerButton();
      renderUserMgmtButton();
      renderPendingInvitesSection();
      return SB.authorized;
    }
    async function sbHandleSession(session){
      SB.session = session || null;
      SB.user = session && session.user ? session.user : null;
      SB.connected = false;
      SB.authorized = false;
      SB.profile = null;
      SB.permissions = null;
      SB.companies = [];
      SB.companyId = null;
      SB.company = null;
      SB.companyTier = null;
      if(!session){
        state._diagRole = '';
        state._diagTier = '';
        state._diagPermissions = null;
      }
      updateStatusBar();
      applyPermissionUI();

      if(!SB.session){
        const inviteToken = storeInviteTokenFromUrl() || getPendingInviteToken();
        state.items = [];
        state._userMgmtRows = [];
        state._pendingInvites = [];
        state._pendingInviteBusy = {};
        state._snapshots = [];
        state._snapshotPreview = null;
        state._metrics = null;
        state._provisioningUsers = [];
        state._provisioningCompanies = [];
        state._provisioningExistingUsers = [];
        state._provisioningExistingUsersLoading = false;
        state._provisioningExistingUsersError = '';
        state._provisioningBusy = false;
        state._provisioningResult = null;
        state._roleConfigs = {};
        state._roleChanges = {};
        state._impersonationRole = 'super_user';
        state._impersonationPermissions = null;
        _inviteCompanyId = '';
        _userMgmtCompanyId = '';
        if(_sbChannel && SB.client){ try{ SB.client.removeChannel(_sbChannel); }catch{} _sbChannel=null; }
        render();
        if(inviteToken){
          show('authModal', false);
          openInviteAcceptModal();
        }else if(!isOnboardingRoute()){
          // Only show auth modal if NOT on onboarding route
          // Onboarding route handles its own signup flow
          show('authModal', true);
        }
        applyPermissionUI();
        renderCompanySwitcher();
        renderProvisioningDashboardButton();
        renderSubscriptionManagerButton();
        renderInviteUi();
        renderRoleManagerButton();
        renderUserMgmtButton();
        await handleOnboardingRoute();
        return;
      }

      show('authModal', false);
      setAuthMessage('');

      await sbEnsureProfile();
      await sbCheckPendingInvite();
      await sbRefreshAccess();
      try{ await sbLoadMyRoleRequest(); }catch(e){}
      renderProfileUi();
      applyPermissionUI();
      await handleOnboardingRoute();

      if(!SB.authorized){
        state.items = [];
        render();
        updateStatusBar();
        return;
      }

      await checkServerHealth();
      if(isOnline()){
        await sbLoadSnapshot();
        sbStartRealtime();
      }
    }
    async function sbAuthBoot(){
      if(!SB.ready || !SB.client) return;

      renderAuthUi();

      // Profile dropdown handlers
      const profileBtn = $('profileBtn');
      const profileDropdown = $('profileDropdown');
      const profileSignIn = $('profileSignIn');
      function toggleProfileDropdown(open){
        if(profileDropdown){
          profileDropdown.style.display = '';
          profileDropdown.classList.toggle('open', open);
          profileDropdown.setAttribute('aria-hidden', open ? 'false' : 'true');
          if(profileBtn) profileBtn.setAttribute('aria-expanded', open);
          if(open){
            initProfileTabs();
            restoreProfileTab();
          }
        }
      }

      if(profileBtn && !profileBtn._wired){
        profileBtn._wired = true;
        profileBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          toggleProfileDropdown(!profileDropdown.classList.contains('open'));
        });
      }

      if(profileSignIn && !profileSignIn._wired){
        profileSignIn._wired = true;
        profileSignIn.addEventListener('click', ()=>{
          toggleProfileDropdown(false);
          if(!SB.session) {
            show('authModal', true);
          } else {
            // Sign out
            sbSignOut();
          }
        });
      }

      // Close profile dropdown when clicking outside
      document.addEventListener('click', (e)=>{
        if(profileDropdown && profileDropdown.classList.contains('open')){
          if(!e.target.closest('.profile-menu')){
            toggleProfileDropdown(false);
          }
        }
      });

      try{
        const { data } = await SB.client.auth.getSession();
        await sbHandleSession(data && data.session ? data.session : null);
      }catch(e){
        console.warn('Auth boot failed:', e);
        await sbHandleSession(null);
      }

      SB.client.auth.onAuthStateChange((event, session)=>{
        if(event === 'PASSWORD_RECOVERY'){
          show('authModal', false);
          show('resetModal', true);
          setResetMessage('');
        }
        void sbHandleSession(session);
      });
    }
    async function sbSignIn(email, password){
      if(!SB.ready) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      const p = String(password||'');
      if(!e) throw Error('Email required');
      if(!p) throw Error('Password required');
      const { error } = await SB.client.auth.signInWithPassword({ email: e, password: p });
      if(error) throw error;
    }
    async function sbSignOut(){
      if(!SB.ready || !SB.client) return;
      await SB.client.auth.signOut();
    }

    // ---------- Auth/Profile modal events ----------
    const btnAuthSubmit = $('btnAuthSubmit');
    if(btnAuthSubmit) btnAuthSubmit.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      const password = $('authPassword')?.value || '';
      setAuthMessage('');
      btnAuthSubmit.disabled = true;
      try{
        await sbSignIn(email, password);
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Authentication failed');
      }finally{
        btnAuthSubmit.disabled = false;
      }
    });

    const btnAuthForgot = $('btnAuthForgot');
    if(btnAuthForgot) btnAuthForgot.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      setAuthMessage('');
      btnAuthForgot.disabled = true;
      btnAuthForgot.setAttribute('aria-disabled', 'true');
      try{
        await sbSendPasswordReset(email);
        setAuthMessage('Password reset email sent.');
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Reset failed');
      }finally{
        btnAuthForgot.disabled = false;
        btnAuthForgot.setAttribute('aria-disabled', 'false');
      }
    });

    const authPassword = $('authPassword');
    if(authPassword) authPassword.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); $('btnAuthSubmit')?.click(); }
    });

    const btnInviteAcceptSubmit = $('btnInviteAcceptSubmit');
    if(btnInviteAcceptSubmit) btnInviteAcceptSubmit.addEventListener('click', async ()=>{
      const password = $('inviteAcceptPassword')?.value || '';
      const confirm = $('inviteAcceptPasswordConfirm')?.value || '';
      setInviteAcceptMessage('');
      btnInviteAcceptSubmit.disabled = true;
      btnInviteAcceptSubmit.setAttribute('aria-disabled', 'true');
      try{
        const result = await sbCompleteInvite(password, confirm);
        if(result && result.ok){
          const email = String(result.email || '').trim();
          if(!email) throw new Error('Invite email missing');
          try{ localStorage.removeItem('inv.pendingInvite'); }catch(e){}
          setInviteAcceptMessage('Account created. Signing you in...');
          await sbSignIn(email, password);
          closeInviteAcceptModal();
        }else{
          const code = result && result.code ? String(result.code) : '';
          const email = result && result.email ? String(result.email) : '';
          if(code === 'ExistingUser'){
            if(email) $('authEmail') && ($('authEmail').value = email);
            closeInviteAcceptModal();
            show('authModal', true);
            setAuthMessage('Account already exists. Please sign in.');
          }else{
            const msg = result && result.error ? String(result.error) : 'Invite setup failed';
            setInviteAcceptMessage(msg);
          }
        }
      }catch(e){
        setInviteAcceptMessage(e && e.message ? e.message : 'Invite setup failed');
      }finally{
        btnInviteAcceptSubmit.disabled = false;
        btnInviteAcceptSubmit.setAttribute('aria-disabled', 'false');
      }
    });

    const inviteAcceptConfirm = $('inviteAcceptPasswordConfirm');
    if(inviteAcceptConfirm) inviteAcceptConfirm.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); $('btnInviteAcceptSubmit')?.click(); }
    });

    const btnInviteAcceptClose = $('btnInviteAcceptClose');
    if(btnInviteAcceptClose) btnInviteAcceptClose.addEventListener('click', ()=>{
      closeInviteAcceptModal();
      show('authModal', true);
    });

    const btnInviteAcceptSignIn = $('btnInviteAcceptSignIn');
    if(btnInviteAcceptSignIn) btnInviteAcceptSignIn.addEventListener('click', ()=>{
      closeInviteAcceptModal();
      show('authModal', true);
    });

    const btnResetSubmit = $('btnResetSubmit');
    if(btnResetSubmit) btnResetSubmit.addEventListener('click', async ()=>{
      const pw = $('resetPassword')?.value || '';
      const confirm = $('resetPasswordConfirm')?.value || '';
      setResetMessage('');
      if(!pw || !confirm){ setResetMessage('Enter and confirm your new password'); return; }
      if(pw !== confirm){ setResetMessage('Passwords do not match'); return; }
      btnResetSubmit.disabled = true;
      btnResetSubmit.setAttribute('aria-disabled', 'true');
      try{
        await sbUpdatePassword(pw);
        setResetMessage('Password updated. You can close this window.');
        toast('Password updated');
      }catch(e){
        setResetMessage(e && e.message ? e.message : 'Update failed');
      }finally{
        btnResetSubmit.disabled = false;
        btnResetSubmit.setAttribute('aria-disabled', 'false');
      }
    });

    const btnResetClose = $('btnResetClose');
    if(btnResetClose) btnResetClose.addEventListener('click', ()=> show('resetModal', false));

    const btnRoleRequest = $('btnRoleRequest');
    if(btnRoleRequest) btnRoleRequest.addEventListener('click', async ()=>{
      const role = $('roleRequestRole')?.value || '';
      const reason = $('roleRequestReason')?.value || '';
      setRoleRequestMessage('');
      if(!role){ setRoleRequestMessage('Select a role'); return; }
      btnRoleRequest.disabled = true;
      btnRoleRequest.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('request_role_change', {
          p_requested_role: role,
          p_reason: String(reason || '').trim() || null,
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Request failed');
        }
        await sbLoadMyRoleRequest();
        renderRoleRequestUi();
        setRoleRequestMessage('Request submitted.');
      }catch(e){
        setRoleRequestMessage(e && e.message ? e.message : 'Request failed');
      }finally{
        btnRoleRequest.disabled = false;
        btnRoleRequest.setAttribute('aria-disabled', 'false');
      }
    });

    const btnTierBaseSave = $('btnTierBaseSave');
    if(btnTierBaseSave) btnTierBaseSave.addEventListener('click', async ()=>{
      const selected = String($('tierBaseSelect')?.value || '').trim();
      setTierOverrideMessage('');
      if(!SB.session || !isEffectiveSuperUser()){
        setTierOverrideMessage('Super user access required.');
        return;
      }
      if(!SB.companyId){
        setTierOverrideMessage('Select a company first.');
        return;
      }
      if(!selected){
        setTierOverrideMessage('Select a base tier.');
        return;
      }
      btnTierBaseSave.disabled = true;
      btnTierBaseSave.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('set_company_base_tier', {
          p_company_id: SB.companyId,
          p_new_base_tier: selected
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Base tier update failed');
        }
        await sbRefreshAccess();
        await refreshTierAdminDetails();
        setTierOverrideMessage('Base tier updated.');
        toast('Base tier updated');
      }catch(e){
        setTierOverrideMessage(e && e.message ? e.message : 'Base tier update failed');
      }finally{
        btnTierBaseSave.disabled = false;
        btnTierBaseSave.setAttribute('aria-disabled', 'false');
      }
    });

    const btnTierOverrideGrant = $('btnTierOverrideGrant');
    if(btnTierOverrideGrant) btnTierOverrideGrant.addEventListener('click', async ()=>{
      const selected = String($('tierOverrideTierSelect')?.value || '').trim();
      const endsAtRaw = String($('tierOverrideEndsAt')?.value || '').trim();
      const endsAt = endsAtRaw ? new Date(endsAtRaw).toISOString() : null;
      setTierOverrideMessage('');
      if(!SB.session || !isEffectiveSuperUser()){
        setTierOverrideMessage('Super user access required.');
        return;
      }
      if(!SB.companyId){
        setTierOverrideMessage('Select a company first.');
        return;
      }
      if(!selected){
        setTierOverrideMessage('Select an override tier.');
        return;
      }
      btnTierOverrideGrant.disabled = true;
      btnTierOverrideGrant.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('grant_company_tier_override', {
          p_company_id: SB.companyId,
          p_override_tier: selected,
          p_ends_at: endsAt
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Override failed');
        }
        await sbRefreshAccess();
        await refreshTierAdminDetails();
        setTierOverrideMessage('Override granted.');
        toast('Override granted');
        const endsInput = $('tierOverrideEndsAt');
        if(endsInput) endsInput.value = '';
      }catch(e){
        setTierOverrideMessage(e && e.message ? e.message : 'Override failed');
      }finally{
        btnTierOverrideGrant.disabled = false;
        btnTierOverrideGrant.setAttribute('aria-disabled', 'false');
      }
    });

    const btnTierOverrideRevoke = $('btnTierOverrideRevoke');
    if(btnTierOverrideRevoke) btnTierOverrideRevoke.addEventListener('click', async ()=>{
      setTierOverrideMessage('');
      if(!SB.session || !isEffectiveSuperUser()){
        setTierOverrideMessage('Super user access required.');
        return;
      }
      if(!SB.companyId){
        setTierOverrideMessage('Select a company first.');
        return;
      }
      btnTierOverrideRevoke.disabled = true;
      btnTierOverrideRevoke.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('revoke_company_tier_override', {
          p_company_id: SB.companyId
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Override revoke failed');
        }
        await sbRefreshAccess();
        await refreshTierAdminDetails();
        setTierOverrideMessage('Override revoked.');
        toast('Override revoked');
      }catch(e){
        setTierOverrideMessage(e && e.message ? e.message : 'Override revoke failed');
      }finally{
        btnTierOverrideRevoke.disabled = false;
        btnTierOverrideRevoke.setAttribute('aria-disabled', 'false');
      }
    });

    const advancedCompanySearchBtn = $('advancedCompanySearchBtn');
    if(advancedCompanySearchBtn) advancedCompanySearchBtn.addEventListener('click', async ()=>{
      await loadAdvancedCompanies();
    });
    const advancedCompanyProvisionBtn = $('advancedCompanyProvisionBtn');
    if(advancedCompanyProvisionBtn) advancedCompanyProvisionBtn.addEventListener('click', ()=>{
      show('advancedCompanyModal', false);
      void openProvisioningModal();
    });
    const advancedCompanyReturnBtn = $('advancedCompanyReturnBtn');
    if(advancedCompanyReturnBtn) advancedCompanyReturnBtn.addEventListener('click', async ()=>{
      if(!isEffectiveSuperUser()){
        toast('Super user access required');
        return;
      }
      const defaultId = getDefaultProductionCompanyId();
      if(!defaultId){
        toast('No production company available');
        return;
      }
      const ok = await sbSwitchCompany(defaultId, {
        persist: false,
        audit: true,
        source: 'advanced_switcher'
      });
      if(ok){
        toast('Returned to production');
        renderAdvancedCompanyActions();
      }
    });
    const advancedCompanyClose = $('advancedCompanyClose');
    if(advancedCompanyClose) advancedCompanyClose.addEventListener('click', ()=>{
      show('advancedCompanyModal', false);
    });
    const advancedCompanySearch = $('advancedCompanySearch');
    if(advancedCompanySearch) advancedCompanySearch.addEventListener('keydown', async (e)=>{
      if(e.key !== 'Enter') return;
      e.preventDefault();
      await loadAdvancedCompanies();
    });
    const advancedCompanyTypeFilter = $('advancedCompanyTypeFilter');
    if(advancedCompanyTypeFilter) advancedCompanyTypeFilter.addEventListener('change', async ()=>{
      await loadAdvancedCompanies();
    });
    if(!document._companyOverflowWired){
      document._companyOverflowWired = true;
      document.addEventListener('click', (e)=>{
        if(!state._companyOverflowOpenId) return;
        if(e.target && e.target.closest && e.target.closest('.company-overflow')) return;
        closeCompanyOverflowMenus();
      });
      document.addEventListener('keydown', (e)=>{
        if(!state._companyOverflowOpenId) return;
        if(e.key === 'Escape'){
          e.preventDefault();
          closeCompanyOverflowMenus();
          return;
        }
        if(e.key !== 'Tab') return;
        const wrapper = document.querySelector(`.company-overflow[data-company-menu="${state._companyOverflowOpenId}"]`);
        if(!wrapper) return;
        const items = Array.from(wrapper.querySelectorAll('.company-overflow-item'));
        if(!items.length) return;
        const first = items[0];
        const last = items[items.length - 1];
        if(e.shiftKey && document.activeElement === first){
          e.preventDefault();
          last.focus();
        }else if(!e.shiftKey && document.activeElement === last){
          e.preventDefault();
          first.focus();
        }
      });
    }
    const btnSeedInventoryCancel = $('btnSeedInventoryCancel');
    if(btnSeedInventoryCancel) btnSeedInventoryCancel.addEventListener('click', ()=>{
      show('seedInventoryModal', false);
    });
    const btnSeedInventoryConfirm = $('btnSeedInventoryConfirm');
    if(btnSeedInventoryConfirm) btnSeedInventoryConfirm.addEventListener('click', confirmSeedInventory);
    const seedInventorySource = $('seedInventorySource');
    if(seedInventorySource) seedInventorySource.addEventListener('change', ()=>{
      if(!state._seedInventory) return;
      state._seedInventory.sourceId = String(seedInventorySource.value || '').trim();
      renderSeedInventoryModal();
    });
    const seedInventoryDedupe = $('seedInventoryDedupe');
    if(seedInventoryDedupe) seedInventoryDedupe.addEventListener('change', ()=>{
      if(!state._seedInventory) return;
      state._seedInventory.dedupeKey = String(seedInventoryDedupe.value || 'sku').trim() || 'sku';
      renderSeedInventoryModal();
    });
    const btnCompanyEnvironmentCancel = $('btnCompanyEnvironmentCancel');
    if(btnCompanyEnvironmentCancel) btnCompanyEnvironmentCancel.addEventListener('click', ()=>{
      show('companyEnvironmentModal', false);
    });
    const btnCompanyEnvironmentConfirm = $('btnCompanyEnvironmentConfirm');
    if(btnCompanyEnvironmentConfirm) btnCompanyEnvironmentConfirm.addEventListener('click', confirmCompanyEnvironment);
    const companyEnvironmentSelect = $('companyEnvironmentSelect');
    if(companyEnvironmentSelect) companyEnvironmentSelect.addEventListener('change', ()=>{
      if(!state._companyEnvironment) return;
      state._companyEnvironment.nextType = normalizeCompanyType(companyEnvironmentSelect.value);
      renderCompanyEnvironmentModal();
    });

    const btnProvisioningClose = $('btnProvisioningClose');
    if(btnProvisioningClose) btnProvisioningClose.addEventListener('click', closeProvisioningModal);
    const btnProvisioningRun = $('btnProvisioningRun');
    if(btnProvisioningRun) btnProvisioningRun.addEventListener('click', async ()=>{
      await runProvisioning();
    });
    const btnProvisioningReset = $('btnProvisioningReset');
    if(btnProvisioningReset) btnProvisioningReset.addEventListener('click', resetProvisioningForm);
    const btnProvisioningAddUser = $('btnProvisioningAddUser');
    if(btnProvisioningAddUser) btnProvisioningAddUser.addEventListener('click', ()=>{
      state._provisioningUsers = Array.isArray(state._provisioningUsers) ? state._provisioningUsers : [];
      state._provisioningUsers.push({ id: randomUUID(), user_id: '', role: 'member' });
      renderProvisioningUsersList();
    });
    const btnProvisioningRefreshCompanies = $('btnProvisioningRefreshCompanies');
    if(btnProvisioningRefreshCompanies) btnProvisioningRefreshCompanies.addEventListener('click', async ()=>{
      await loadProvisioningCompanies();
    });
    const provisioningSeedToggle = $('provisioningSeedToggle');
    if(provisioningSeedToggle) provisioningSeedToggle.addEventListener('change', ()=>{
      if(provisioningSeedToggle.checked){
        const confirmed = window.confirm('Copy inventory from an existing company? This action is explicit and auditable.');
        if(!confirmed){
          provisioningSeedToggle.checked = false;
          renderProvisioningSeedFields();
          return;
        }
        void loadProvisioningCompanies();
      }
      renderProvisioningSeedFields();
    });
    const provisioningName = $('provisioningCompanyName');
    const provisioningSlug = $('provisioningCompanySlug');
    if(provisioningName) provisioningName.addEventListener('input', ()=>{
      if(!provisioningSlug) return;
      if(provisioningSlug.dataset.manual === 'true') return;
      provisioningSlug.value = slugifyCompanyName(provisioningName.value);
      provisioningSlug.dataset.manual = 'false';
    });
    if(provisioningSlug) provisioningSlug.addEventListener('input', ()=>{
      provisioningSlug.dataset.manual = 'true';
    });
    const provisioningUsersList = $('provisioningUsersList');
    if(provisioningUsersList) provisioningUsersList.addEventListener('change', (e)=>{
      const target = e.target;
      if(!target) return;
      const field = target.getAttribute && target.getAttribute('data-provisioning-user-field');
      const id = target.getAttribute && target.getAttribute('data-provisioning-user-id');
      if(!field || !id) return;
      const rows = Array.isArray(state._provisioningUsers) ? state._provisioningUsers : [];
      const idx = rows.findIndex(r => String(r.id) === String(id));
      if(idx < 0) return;
      const value = target.value;
      rows[idx] = { ...rows[idx], [field]: value };
      state._provisioningUsers = rows;
    });
    if(provisioningUsersList) provisioningUsersList.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-provisioning-user-remove]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-provisioning-user-remove') || '').trim();
      if(!id) return;
      state._provisioningUsers = (Array.isArray(state._provisioningUsers) ? state._provisioningUsers : []).filter(r => String(r.id) !== id);
      renderProvisioningUsersList();
    });
    const provisioningSummary = $('provisioningSummary');
    if(provisioningSummary) provisioningSummary.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-provisioning-open-id]');
      if(!btn) return;
      const companyId = String(btn.getAttribute('data-provisioning-open-id') || '').trim();
      if(!companyId) return;
      const companyName = String(btn.getAttribute('data-provisioning-open-name') || '').trim();
      const companySlug = String(btn.getAttribute('data-provisioning-open-slug') || '').trim();
      const companyRow = {
        company_id: companyId,
        company_name: companyName || null,
        company_slug: companySlug || null,
        company_type: 'production',
      };
      const ok = await sbSwitchCompany(companyId, {
        persist: false,
        audit: true,
        source: 'provisioning',
        companyRow,
      });
      if(ok){
        toast(`Switched to ${companyName || 'company'}`);
        show('provisioningModal', false);
      }
    });

    const diagApply = $('diagApply');
    if(diagApply) diagApply.addEventListener('click', async ()=>{
      await applyDiagnosticsSimulation();
    });
    const diagReset = $('diagReset');
    if(diagReset) diagReset.addEventListener('click', ()=>{
      resetDiagnosticsSimulation();
    });
    const diagClose = $('diagClose');
    if(diagClose) diagClose.addEventListener('click', ()=>{
      show('diagnosticsModal', false);
    });
    const diagMetricRun = $('diagMetricRun');
    if(diagMetricRun) diagMetricRun.addEventListener('click', async ()=>{
      await runDiagnosticsMetricPreview();
    });
    const diagRoleSelect = $('diagRoleSelect');
    if(diagRoleSelect) diagRoleSelect.addEventListener('change', ()=>{
      setDiagnosticsMessage('Simulation changed. Apply to activate.');
    });
    const diagTierSelect = $('diagTierSelect');
    if(diagTierSelect) diagTierSelect.addEventListener('change', ()=>{
      setDiagnosticsMessage('Simulation changed. Apply to activate.');
      updateDiagnosticsMetricTierHint();
    });

    const btnProfileClose = $('btnProfileClose');
    if(btnProfileClose) btnProfileClose.addEventListener('click', ()=> {
      if(_profileAutoSaveTimer){ clearTimeout(_profileAutoSaveTimer); _profileAutoSaveTimer = null; }
      show('profileModal', false);
    });

    const btnInviteSend = $('btnInviteSend');
    if(btnInviteSend) btnInviteSend.addEventListener('click', async ()=>{
      if(!btnInviteSend) return;
      const email = $('inviteEmail')?.value || '';
      const role = $('inviteRole')?.value || 'member';
      const companyId = _inviteCompanyId || (SB.companyId ? String(SB.companyId) : '');
      setInviteMessage('');
      showInviteLink('');
      btnInviteSend.disabled = true;
      btnInviteSend.setAttribute('aria-disabled', 'true');
      try{
        const data = await sbInviteUser(email, role, companyId);
        const createdInvite = !!(data && (data.ok || data.invite_id || data.invite_url));
        if(data && data.ok){
          const expiry = data && data.expires_at ? formatEasternDateTime(data.expires_at) : '';
          const suffix = expiry ? ` Expires ${expiry}.` : '';
          if(data.invite_url) showInviteLink(data.invite_url);
          setInviteMessage(`Invite email sent to ${String(email || '').trim()}.${suffix}`);
          await refreshPendingInvites();
          if(createdInvite) await maybeAdvanceOnboardingAfterInvite();
        }else{
          const msg = data && data.error ? String(data.error) : 'Invite failed';
          if(data && data.invite_url) showInviteLink(data.invite_url);
          setInviteMessage(msg);
          if(data && (data.invite_id || data.invite_url)){
            await refreshPendingInvites();
            if(createdInvite) await maybeAdvanceOnboardingAfterInvite();
          }
        }
      }catch(e){
        setInviteMessage(e && e.message ? e.message : 'Invite failed');
      }finally{
        btnInviteSend.disabled = false;
        btnInviteSend.setAttribute('aria-disabled', 'false');
        renderInviteUi();
      }
    });

    const btnInviteCopy = $('btnInviteCopy');
    if(btnInviteCopy) btnInviteCopy.addEventListener('click', async ()=>{
      const url = $('inviteLink')?.value || '';
      if(!url){ toast('No invite link'); return; }
      try{
        await copyText(String(url));
        toast('Invite link copied');
      }catch(e){
        toast('Copy failed');
      }
    });

    const inviteEmail = $('inviteEmail');
    if(inviteEmail) inviteEmail.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){
        e.preventDefault();
        $('btnInviteSend')?.click();
      }
    });
    const inviteCompany = $('inviteCompany');
    if(inviteCompany && !inviteCompany._wired){
      inviteCompany._wired = true;
      inviteCompany.addEventListener('change', ()=>{
        _inviteCompanyId = inviteCompany.value || '';
        showInviteLink('');
        setInviteMessage('');
        renderInviteUi();
      });
    }

    const openProfileSettings = $('openProfileSettings');
    if(openProfileSettings) openProfileSettings.addEventListener('click', ()=>{
      closeProfileMenu();
      renderProfileUi();
      show('profileModal', true);
      if(SB.session){
        sbLoadMyRoleRequest()
          .then(() => renderRoleRequestUi())
          .catch(()=>{});
      }
    });

    const openCompanySwitcher = $('openCompanySwitcher');
    if(openCompanySwitcher) openCompanySwitcher.addEventListener('click', ()=>{
      closeProfileMenu();
      void openCompanySwitcherModal();
    });

    const openCompanyLocations = $('openCompanyLocations');
    if(openCompanyLocations) openCompanyLocations.addEventListener('click', ()=>{
      closeProfileMenu();
      void openCompanyLocationsModal();
    });

    const openSubscriptionManager = $('openSubscriptionManager');
    if(openSubscriptionManager) openSubscriptionManager.addEventListener('click', ()=>{
      closeProfileMenu();
      openSubscriptionManagerModal();
    });

    const openInviteModal = $('openInviteModal');
    if(openInviteModal) openInviteModal.addEventListener('click', ()=>{
      closeProfileMenu();
      if(!SB.session){
        show('authModal', true);
        return;
      }
      renderInviteUi();
      show('inviteModal', true);
    });

    const openUserMgmt = $('openUserMgmt');
    if(openUserMgmt) openUserMgmt.addEventListener('click', ()=>{
      closeProfileMenu();
      openUserMgmtModal();
    });

    const openRoleManager = $('openRoleManager');
    if(openRoleManager) openRoleManager.addEventListener('click', ()=>{
      closeProfileMenu();
      openRoleManagerModal();
    });

    const btnInviteClose = $('btnInviteClose');
    if(btnInviteClose) btnInviteClose.addEventListener('click', ()=>{
      show('inviteModal', false);
    });

    const openRoleRequests = $('openRoleRequests');
    if(openRoleRequests) openRoleRequests.addEventListener('click', ()=>{
      closeProfileMenu();
      openRoleRequestsModal();
    });

    const btnRoleRequestsClose = $('btnRoleRequestsClose');
    if(btnRoleRequestsClose) btnRoleRequestsClose.addEventListener('click', closeRoleRequestsModal);
    const btnRoleRequestsRefresh = $('btnRoleRequestsRefresh');
    if(btnRoleRequestsRefresh) btnRoleRequestsRefresh.addEventListener('click', refreshRoleRequests);
    const btnRoleManagerClose = $('btnRoleManagerClose');
    if(btnRoleManagerClose) btnRoleManagerClose.addEventListener('click', closeRoleManagerModal);
    const btnRoleManagerSave = $('btnRoleManagerSave');
    if(btnRoleManagerSave) btnRoleManagerSave.addEventListener('click', saveRoleManagerChanges);
    const roleManagerBody = $('roleManagerBody');
    if(roleManagerBody) roleManagerBody.addEventListener('change', (e)=> handleRoleManagerToggle(e.target));
    const roleRequestsList = $('roleRequestsList');
    if(roleRequestsList) roleRequestsList.addEventListener('click', async (e)=>{
      const approveBtn = e.target.closest('[data-role-approve-id]');
      const denyBtn = e.target.closest('[data-role-deny-id]');
      if(!approveBtn && !denyBtn) return;
      const id = String((approveBtn || denyBtn).getAttribute(approveBtn ? 'data-role-approve-id' : 'data-role-deny-id') || '').trim();
      if(!id) return;
      const approved = !!approveBtn;
      let notesEl = null;
      if(window.CSS && CSS.escape){
        notesEl = roleRequestsList.querySelector(`[data-role-notes-id="${CSS.escape(id)}"]`);
      }else{
        const safeId = String(id).replace(/"/g, '\\"');
        notesEl = roleRequestsList.querySelector(`[data-role-notes-id="${safeId}"]`);
      }
      const notes = notesEl ? String(notesEl.value || '').trim() : '';
      const label = approved ? 'Approve request?' : 'Deny request?';
      const okText = approved ? 'Approve' : 'Deny';
      if(!(await openConfirmModal(label, 'This will update the user role.', { okText, cancelText:'Cancel' }))) return;
      try{
        const { data, error } = await SB.client.rpc('process_role_request', {
          p_request_id: id,
          p_approved: approved,
          p_admin_notes: notes || null,
        });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Request failed');
        }
        const row = state._roleRequests.find(r => String(r.id) === id);
        state._roleRequests = (state._roleRequests || []).filter(r => String(r.id) !== id);
        renderRoleRequestsList();
        if(row && SB.user && String(row.user_id) === String(SB.user.id) && approved){
          await sbRefreshAccess();
        }
        toast(approved ? 'Role updated' : 'Request denied');
      }catch(err){
        toast(err && err.message ? err.message : 'Update failed');
      }
    });

    const btnUserMgmtClose = $('btnUserMgmtClose');
    if(btnUserMgmtClose) btnUserMgmtClose.addEventListener('click', closeUserMgmtModal);
    const btnSubscriptionManagerClose = $('btnSubscriptionManagerClose');
    if(btnSubscriptionManagerClose) btnSubscriptionManagerClose.addEventListener('click', closeSubscriptionManagerModal);
    const btnUserMgmtRefresh = $('btnUserMgmtRefresh');
    if(btnUserMgmtRefresh) btnUserMgmtRefresh.addEventListener('click', refreshUserMgmtAll);
    const btnUserMgmtAdd = $('btnUserMgmtAdd');
    if(btnUserMgmtAdd) btnUserMgmtAdd.addEventListener('click', openInviteFromUserMgmt);
    const btnPendingInvitesRefresh = $('btnPendingInvitesRefresh');
    if(btnPendingInvitesRefresh) btnPendingInvitesRefresh.addEventListener('click', refreshPendingInvites);
    const userMgmtCompany = $('userMgmtCompany');
    if(userMgmtCompany && !userMgmtCompany._wired){
      userMgmtCompany._wired = true;
      userMgmtCompany.addEventListener('change', async (e)=>{
        _userMgmtCompanyId = e && e.target ? e.target.value : '';
        await refreshUserMgmtAll();
      });
    }
    const userMgmtList = $('userMgmtList');
    if(userMgmtList) userMgmtList.addEventListener('change', async (e)=>{
      const select = e.target.closest('[data-user-role-id]');
      if(!select) return;
      const userId = String(select.getAttribute('data-user-role-id') || '').trim();
      const currentRole = String(select.getAttribute('data-current-role') || '').trim();
      const nextRole = String(select.value || '').trim();
      if(!userId || !nextRole || nextRole === currentRole) return;
      const displayName = String(select.getAttribute('data-user-name') || 'user');
      const ok = await openConfirmModal(
        `Change role for ${displayName}?`,
        `This will set the role to ${nextRole}.`,
        { okText:'Update', cancelText:'Cancel' }
      );
      if(!ok){
        select.value = currentRole;
        return;
      }
      try{
        await sbUpdateMemberRole(userId, nextRole);
        toast('Role updated');
        await refreshUserMgmt();
      }catch(err){
        select.value = currentRole;
        toast(err && err.message ? err.message : 'Update failed');
      }
    });
    if(userMgmtList) userMgmtList.addEventListener('click', async (e)=>{
      const removeBtn = e.target.closest('[data-user-remove-id]');
      if(!removeBtn) return;
      if(removeBtn.disabled) return;
      const userId = String(removeBtn.getAttribute('data-user-remove-id') || '').trim();
      if(!userId) return;
      const displayName = String(removeBtn.getAttribute('data-user-name') || 'user');
      const ok = await openConfirmModal(
        `Remove ${displayName}?`,
        'This will revoke their access to the company.',
        { okText:'Remove', cancelText:'Cancel' }
      );
      if(!ok) return;
      try{
        await sbRemoveMember(userId);
        toast('User removed');
        await refreshUserMgmt();
      }catch(err){
        toast(err && err.message ? err.message : 'Remove failed');
      }
    });
    const pendingInvitesList = $('pendingInvitesList');
    if(pendingInvitesList) pendingInvitesList.addEventListener('click', async (e)=>{
      const resendBtn = e.target.closest('[data-invite-resend-id]');
      const revokeBtn = e.target.closest('[data-invite-revoke-id]');
      if(resendBtn){
        if(resendBtn.disabled) return;
        const inviteId = String(resendBtn.getAttribute('data-invite-resend-id') || '').trim();
        if(!inviteId) return;
        state._pendingInviteBusy = state._pendingInviteBusy || {};
        state._pendingInviteBusy[inviteId] = 'resend';
        renderPendingInvitesList();
        try{
          const data = await sbResendCompanyInvite(inviteId);
          const idx = (state._pendingInvites || []).findIndex(row => String(row.id) === inviteId);
          if(idx >= 0){
            const current = state._pendingInvites[idx];
            const nextResend = (data && typeof data.resend_count === 'number') ? data.resend_count : (toInt(current.resend_count, 0) + 1);
            const nextLastSent = data && data.last_sent_at ? data.last_sent_at : new Date().toISOString();
            state._pendingInvites[idx] = { ...current, resend_count: nextResend, last_sent_at: nextLastSent };
            renderPendingInvitesList();
          }
          toast('Invite resent');
        }catch(err){
          toast(err && err.message ? err.message : 'Resend failed');
        }finally{
          delete state._pendingInviteBusy[inviteId];
          await refreshPendingInvites();
        }
        return;
      }
      if(revokeBtn){
        if(revokeBtn.disabled) return;
        const inviteId = String(revokeBtn.getAttribute('data-invite-revoke-id') || '').trim();
        if(!inviteId) return;
        const email = String(revokeBtn.getAttribute('data-invite-email') || 'this invite');
        const ok = await openConfirmModal(
          `Revoke invite for ${email}?`,
          'This will delete the invite.',
          { okText:'Revoke', cancelText:'Cancel' }
        );
        if(!ok) return;
        state._pendingInviteBusy = state._pendingInviteBusy || {};
        state._pendingInviteBusy[inviteId] = 'revoke';
        const prev = Array.isArray(state._pendingInvites) ? state._pendingInvites.slice() : [];
        state._pendingInvites = prev.filter(row => String(row.id) !== inviteId);
        renderPendingInvitesList();
        try{
          await sbRevokeCompanyInvite(inviteId);
          toast('Invite revoked');
        }catch(err){
          state._pendingInvites = prev;
          renderPendingInvitesList();
          toast(err && err.message ? err.message : 'Revoke failed');
        }finally{
          delete state._pendingInviteBusy[inviteId];
          await refreshPendingInvites();
        }
      }
    });

    const profilePhoneInput = $('profilePhone');
    if(profilePhoneInput){
      profilePhoneInput.addEventListener('input', (e)=>{
        const cursorPos = e.target.selectionStart;
        const oldLen = e.target.value.length;
        e.target.value = formatPhoneNumber(e.target.value);
        const newLen = e.target.value.length;
        // Adjust cursor position after formatting
        const newPos = Math.max(0, cursorPos + (newLen - oldLen));
        e.target.setSelectionRange(newPos, newPos);
      });
    }

	    // Profile auto-save
    let _profileAutoSaveTimer = null;
    async function autoSaveProfile(){
      const modal = $('profileModal');
      if(!modal || modal.getAttribute('aria-hidden') === 'true') return;
      const firstName = $('profileFirstName')?.value || '';
      const lastName = $('profileLastName')?.value || '';
      const phone = $('profilePhone')?.value || '';
      const lowStockQtyGlobal = $('profileLowStockQtyGlobal')?.value || '';
      const silenceLowStockAlerts = !!($('profileSilenceLowStockAlerts')?.checked);
      setProfileMessage('');
      try{
        await sbSaveProfile(firstName, lastName, phone, silenceLowStockAlerts, lowStockQtyGlobal);
        renderProfileUi();
        try{ renderTable(); }catch(e){}
        toast('Auto-saved');
      }catch(e){
        setProfileMessage(e && e.message ? e.message : 'Save failed');
      }
    }
    function scheduleProfileAutoSave(){
      if(_profileAutoSaveTimer) clearTimeout(_profileAutoSaveTimer);
      _profileAutoSaveTimer = setTimeout(()=> autoSaveProfile(), 600);
    }
    // Attach auto-save listeners to profile inputs
    ['profileFirstName','profileLastName','profilePhone','profileLowStockQtyGlobal'].forEach(id=>{
      const el = $(id);
      if(el){
        el.addEventListener('blur', scheduleProfileAutoSave);
        el.addEventListener('change', scheduleProfileAutoSave);
      }
    });
    const profileSilenceToggle = $('profileSilenceLowStockAlerts');
    if(profileSilenceToggle) profileSilenceToggle.addEventListener('change', ()=> autoSaveProfile());

    const btnSignOut = $('btnSignOut');
    if(btnSignOut) btnSignOut.addEventListener('click', async ()=>{
      try{
        await sbSignOut();
        show('profileModal', false);
        toast('Signed out');
      }catch(e){
        toast(e && e.message ? e.message : 'Sign out failed');
      }
    });
		    async function sbLoadSnapshot(){
		      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
		      let data = null;
		      const baseSel = 'id,name,description,quantity,sku,category_id,location_id,reorder_point,reorder_quantity,updated_at,deleted_at';
		
		      function buildSel(){
		        let sel = baseSel;
		        if(SB.itemsHasLowStockQty !== false) sel += ',low_stock_qty';
		        if(SB.itemsHasReorderEnabled !== false) sel += ',reorder_enabled';
		        if(SB.itemsHasUnitOfMeasure !== false) sel += ',unit_of_measure';
		        return sel;
		      }
		
		      for(let attempt=0; attempt<3; attempt++){
		        const sel = buildSel();
		        const res = await SB.client
		          .from('inventory_items')
		          .select(sel)
		          .eq('company_id', SB.companyId)
		          .is('deleted_at', null)
		          .order('name', { ascending:true });
		        if(!res.error){
		          data = res.data;
		          if(sel.includes('low_stock_qty')) SB.itemsHasLowStockQty = true;
		          if(sel.includes('reorder_enabled')) SB.itemsHasReorderEnabled = true;
		          if(sel.includes('unit_of_measure')) SB.itemsHasUnitOfMeasure = true;
		          break;
		        }
		        const e = res.error;
		        const msg = errToText(e).toLowerCase();
		        let changed = false;
		
		        if(msg.includes('low_stock_qty')){
		          if(SB.itemsHasLowStockQty !== false) changed = true;
		          SB.itemsHasLowStockQty = false;
		          if(isSchemaCacheMissingColumnError(e, 'low_stock_qty') && !SB.warnedLowStockSchema){
		            SB.warnedLowStockSchema = true;
		            toast("Supabase needs schema reload for low stock (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing inventory_items.low_stock_qty. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		        if(msg.includes('reorder_enabled')){
		          if(SB.itemsHasReorderEnabled !== false) changed = true;
		          SB.itemsHasReorderEnabled = false;
		          if(isSchemaCacheMissingColumnError(e, 'reorder_enabled') && !SB.warnedReorderSchema){
		            SB.warnedReorderSchema = true;
		            toast("Supabase needs schema reload for reorder settings (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing inventory_items.reorder_enabled. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		        if(msg.includes('unit_of_measure')){
		          if(SB.itemsHasUnitOfMeasure !== false) changed = true;
		          SB.itemsHasUnitOfMeasure = false;
		          if(isSchemaCacheMissingColumnError(e, 'unit_of_measure') && !SB.warnedUnitSchema){
		            SB.warnedUnitSchema = true;
		            toast("Supabase needs schema reload for units of measure (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing inventory_items.unit_of_measure. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		
		        if(!changed){
		          console.warn('Supabase load error', e);
		          return;
		        }
		      }
		
		      if(data === null) return;
		      state.items = (data||[]).map(r => ({
		        id:r.id,
		        name:r.name||'',
		        desc:r.description||'',
		        qty:toInt(r.quantity,0),
		        sku: r.sku || '',
		        unitOfMeasure: (r && Object.prototype.hasOwnProperty.call(r, 'unit_of_measure')) ? String(r.unit_of_measure || '').trim() : '',
		        categoryId: String(r.category_id || '').trim(),
		        locationId: String(r.location_id || '').trim(),
		        reorderPoint: (r && Object.prototype.hasOwnProperty.call(r,'reorder_point') && r.reorder_point !== null && typeof r.reorder_point !== 'undefined') ? toInt(r.reorder_point,0) : null,
		        reorderQty: (r && Object.prototype.hasOwnProperty.call(r,'reorder_quantity') && r.reorder_quantity !== null && typeof r.reorder_quantity !== 'undefined') ? toInt(r.reorder_quantity,0) : null,
		        lowStockQty: (r && Object.prototype.hasOwnProperty.call(r,'low_stock_qty') && r.low_stock_qty !== null) ? toInt(r.low_stock_qty,0) : null,
		        reorderEnabled: (r && Object.prototype.hasOwnProperty.call(r,'reorder_enabled')) ? !!r.reorder_enabled : true,
		        updatedAt:r.updated_at||null
		      }));
		      refreshComputedItemColWidth(state.items);
		      setUpdated(); render();
		    }
    let _sbChannel=null;
    function sbStartRealtime(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
      if(_sbChannel){ SB.client.removeChannel(_sbChannel); _sbChannel=null; }
      _sbChannel = SB.client.channel('inventory_items_all')
        .on('postgres_changes', {event:'*', schema:'public', table:'inventory_items', filter:`company_id=eq.${SB.companyId}`}, payload=>{
          const row = payload.new || payload.old;
          console.log('[realtime]', payload.eventType, row && row.id, row);
		          if(payload.eventType==='INSERT'){
		            if(row && row.deleted_at) return;
		            const i = state.items.findIndex(x=> x.id===row.id);
		            if(i===-1) state.items.push({
		              id:row.id,
		              name:row.name,
		              desc:row.description||'',
		              qty:toInt(row.quantity,0),
		              sku: row.sku || '',
		              unitOfMeasure: (row && Object.prototype.hasOwnProperty.call(row,'unit_of_measure')) ? String(row.unit_of_measure || '').trim() : '',
		              categoryId: String(row.category_id || '').trim(),
		              locationId: String(row.location_id || '').trim(),
		              reorderPoint: (row && Object.prototype.hasOwnProperty.call(row,'reorder_point') && row.reorder_point !== null && typeof row.reorder_point !== 'undefined') ? toInt(row.reorder_point,0) : null,
		              reorderQty: (row && Object.prototype.hasOwnProperty.call(row,'reorder_quantity') && row.reorder_quantity !== null && typeof row.reorder_quantity !== 'undefined') ? toInt(row.reorder_quantity,0) : null,
		              lowStockQty: (row && Object.prototype.hasOwnProperty.call(row,'low_stock_qty') && row.low_stock_qty !== null) ? toInt(row.low_stock_qty,0) : null,
		              reorderEnabled: (row && Object.prototype.hasOwnProperty.call(row,'reorder_enabled')) ? !!row.reorder_enabled : true,
		              updatedAt:row.updated_at
		            });
		          }else if(payload.eventType==='UPDATE'){
		            if(row && row.deleted_at){
		              state.items = state.items.filter(x=> x.id!==row.id);
		              setUpdated(); render();
		              return;
		            }
		            const it = state.items.find(x=> x.id===row.id);
		            if(it){
		              it.name=row.name;
		              it.desc=row.description||'';
		              it.qty=toInt(row.quantity,0);
		              if(Object.prototype.hasOwnProperty.call(row,'sku')) it.sku = row.sku || '';
		              if(Object.prototype.hasOwnProperty.call(row,'unit_of_measure')) it.unitOfMeasure = String(row.unit_of_measure || '').trim();
		              if(Object.prototype.hasOwnProperty.call(row,'category_id')) it.categoryId = String(row.category_id || '').trim();
		              if(Object.prototype.hasOwnProperty.call(row,'location_id')) it.locationId = String(row.location_id || '').trim();
		              if(Object.prototype.hasOwnProperty.call(row,'reorder_point')){
		                it.reorderPoint = (row.reorder_point === null || typeof row.reorder_point === 'undefined') ? null : toInt(row.reorder_point,0);
		              }
		              if(Object.prototype.hasOwnProperty.call(row,'reorder_quantity')){
		                it.reorderQty = (row.reorder_quantity === null || typeof row.reorder_quantity === 'undefined') ? null : toInt(row.reorder_quantity,0);
		              }
		              if(Object.prototype.hasOwnProperty.call(row,'low_stock_qty')){
		                it.lowStockQty = (row.low_stock_qty === null) ? null : toInt(row.low_stock_qty,0);
		              }
		              if(Object.prototype.hasOwnProperty.call(row,'reorder_enabled')){
		                it.reorderEnabled = !!row.reorder_enabled;
		              }
		              it.updatedAt=row.updated_at;
		            }
		          }else if(payload.eventType==='DELETE'){
	            state.items = state.items.filter(x=> x.id!==row.id);
	          }
          refreshComputedItemColWidth(state.items);
          setUpdated(); render();
        })
        .subscribe();
    }
    async function sbAddItem(name, desc, qty){
      if(!canCreate()) throw Error('Permission denied');
      if(!SB.companyId) throw Error('Company not selected');
      const id = randomUUID();
      const { error } = await SB.client.from('inventory_items').insert([{
        id,
        company_id: SB.companyId,
        name,
        description:desc||'',
        quantity: toInt(qty,0),
        reorder_enabled: true,
        created_by: SB.user ? SB.user.id : null,
      }]);
      if(error) throw error; return id;
    }
	    async function sbUpdateFields(id, fields){
	      if(!canUpdate()) throw Error('Permission denied');
	      if(!SB.companyId) throw Error('Company not selected');
	      const clean = {};
	      if('name' in fields) clean.name = String(fields.name||'');
	      if('desc' in fields) clean.description = String(fields.desc||'');
	      if('sku' in fields) clean.sku = String(fields.sku||'');
	      if('unitOfMeasure' in fields && SB.itemsHasUnitOfMeasure !== false){
	        const raw = String(fields.unitOfMeasure || '').trim();
	        clean.unit_of_measure = raw ? raw : null;
	      }
	      if('locationId' in fields){
	        const raw = String(fields.locationId || '').trim();
	        clean.location_id = raw ? raw : null;
	      }
	      if('categoryId' in fields){
	        const raw = String(fields.categoryId || '').trim();
	        clean.category_id = raw ? raw : null;
	      }
	      if('qty'  in fields) clean.quantity  = toInt(fields.qty,0);
	      if('reorderEnabled' in fields) clean.reorder_enabled = !!fields.reorderEnabled;
	      if('reorderPoint' in fields){
	        const raw = fields.reorderPoint;
	        if(raw === null || typeof raw === 'undefined' || String(raw).trim() === ''){
	          clean.reorder_point = null;
	        }else{
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Reorder point must be integer â‰¥ 0');
	          clean.reorder_point = v;
	        }
	      }
	      if('reorderQty' in fields){
	        const raw = fields.reorderQty;
	        if(raw === null || typeof raw === 'undefined' || String(raw).trim() === ''){
	          clean.reorder_quantity = null;
	        }else{
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Reorder qty must be integer â‰¥ 0');
	          clean.reorder_quantity = v;
	        }
	      }
	      if('lowStockQty' in fields){
		        const raw = fields.lowStockQty;
		        if(raw === null || typeof raw === 'undefined' || String(raw).trim() === ''){
		          clean.low_stock_qty = null;
		        }else{
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Low stock qty must be integer â‰¥ 0');
	          clean.low_stock_qty = v;
	        }
	      }
	      const { error } = await SB.client
	        .from('inventory_items')
	        .update(clean)
	        .eq('id', id)
	        .eq('company_id', SB.companyId)
	        .is('deleted_at', null);
	      if(error) throw error;
	    }

	    async function sbFetchItemQtyMap(ids){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      const requested = Array.isArray(ids) ? ids.map(x=> String(x||'').trim()).filter(Boolean) : [];
	      const out = new Map();
	      if(!requested.length) return out;
	      const size = 200;
	      for(let i=0;i<requested.length;i+=size){
	        const chunk = requested.slice(i, i+size);
	        const { data, error } = await SB.client
	          .from('inventory_items')
	          .select('id,quantity')
	          .eq('company_id', SB.companyId)
	          .is('deleted_at', null)
	          .in('id', chunk);
	        if(error) throw error;
	        (Array.isArray(data) ? data : []).forEach(r=>{
	          if(r && r.id) out.set(String(r.id), toInt(r.quantity, 0));
	        });
	      }
	      return out;
	    }

	    async function sbUpdateItemQtyIfMatch(itemId, expectedQty, nextQty){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      if(!canUpdate()) throw new Error('Permission denied');
	      const id = String(itemId || '').trim();
	      if(!id) throw new Error('Invalid item ID');
	      const { data, error } = await SB.client
	        .from('inventory_items')
	        .update({ quantity: toInt(nextQty, 0) })
	        .eq('id', id)
	        .eq('company_id', SB.companyId)
	        .eq('quantity', toInt(expectedQty, 0))
	        .is('deleted_at', null)
	        .select('id');
	      if(error) throw error;
	      return Array.isArray(data) && data.length > 0;
	    }

	    function errToText(err){
	      if(!err) return '';
	      if(typeof err === 'string') return err;
	      const parts = [];
	      try{
	        if(err.message) parts.push(String(err.message));
	        if(err.details) parts.push(String(err.details));
	        if(err.hint) parts.push(String(err.hint));
	        if(err.code) parts.push(String(err.code));
	      }catch(e){}
	      return parts.join(' ');
	    }

	    function isMissingRelationError(err){
	      const msg = errToText(err);
	      if(!msg) return false;
	      const lower = msg.toLowerCase();
	      if(lower.includes('schema cache') && lower.includes('relationship')) return true;
	      return (
	        lower.includes('does not exist') ||
	        lower.includes('relation') ||
	        lower.includes('could not find the table') ||
	        String(err && err.code || '') === '42P01' ||
	        String(err && err.code || '') === 'PGRST205'
	      );
	    }

	    function isSchemaCacheMissingColumnError(err, column){
	      const msg = errToText(err);
	      if(!msg) return false;
	      const lower = msg.toLowerCase();
	      if(!lower.includes('schema cache')) return false;
	      if(column && !lower.includes(String(column).toLowerCase())) return false;
	      return true;
	    }

	    function isPostgrestMissingColumnError(err, column){
	      const msg = errToText(err);
	      if(!msg) return false;
	      const lower = msg.toLowerCase();
	      if(column && !lower.includes(String(column).toLowerCase())) return false;
	      return lower.includes('schema cache') || (lower.includes('column') && lower.includes('does not exist'));
	    }

	    function isOrdersReceiptColumnsMissingError(err){
	      return [
	        'receiving_at','receiving_by','receiving_snapshot',
	        'received_at','received_by','received_snapshot',
	        'received_undone_at','received_undone_by',
	      ].some(c => isPostgrestMissingColumnError(err, c));
	    }
	
	    function showSchemaCacheReloadHelp(tableName, columnName){
	      const sql = "NOTIFY pgrst, 'reload schema';";
	      try{
	        if(navigator.clipboard && navigator.clipboard.writeText){
	          navigator.clipboard.writeText(sql)
	            .then(()=> toast('Copied schema reload SQL'))
	            .catch(()=>{});
	        }
	      }catch(e){}
	      openMsgModal(
	        'Supabase schema cache',
	        `Supabase is reporting â€œcolumn not found in schema cacheâ€ for ${tableName}.${columnName}.\n\n`+
	          `This usually means PostgREST hasnâ€™t reloaded its schema cache yet.\n\n`+
	          `Fix:\n`+
	          `1) Supabase Dashboard â†’ SQL Editor\n`+
	          `2) Run:\n${sql}\n`+
	          `3) Refresh this page\n\n`+
	          `If it still fails, wait ~30 seconds and try again.`,
	        sql
	      );
	    }
	    async function sbDeleteMany(ids){
	      if(!canDelete()) throw Error('Permission denied');
	      if(!SB.companyId) throw Error('Company not selected');
	      const requested = Array.isArray(ids) ? ids.filter(Boolean) : [];
	      if(requested.length===0) return { deleted:0, requested:0 };
	      const { data, error } = await SB.client
	        .rpc('soft_delete_items', { p_item_ids: requested });
	      if (error) throw error;
	      if(data && data.success === false){
	        throw new Error(data.error || 'Delete failed');
	      }
      return { deleted: requested.length, requested: requested.length };
    }
    async function sbUpsertMany(rows){
      if(!canItemsImport()) throw Error('Permission denied');
      if(!SB.companyId) throw Error('Company not selected');
      const payload = (Array.isArray(rows) ? rows : [])
        .map(r => ({
          name: String(r && r.name ? r.name : '').trim(),
          desc: String(r && r.desc ? r.desc : '').trim(),
          qty: toInt(r && r.qty ? r.qty : 0, 0),
        }))
        .filter(r => r.name);
      if(!payload.length) throw Error('No valid rows to import');

      const { data, error } = await SB.client.rpc('bulk_upsert_inventory_items', {
        p_company_id: SB.companyId,
        p_items: payload,
      });
      if(error) throw error;
      if(data && data.success === false){
        throw new Error(data.error || 'Import failed');
      }
    }

    async function sbExportItems(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
      if(!canItemsExport()) throw new Error('Export permission required');
      const { data, error } = await SB.client.rpc('export_inventory_items', { p_company_id: SB.companyId });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }

    // ========================
    // Rendering & inline edit
    // ========================
    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function escapeHtmlAttr(s){
      return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function bindInventorySortHandlers(){
      document.querySelectorAll('#invTable thead th.sortable').forEach(th=>{
        if(th.dataset.sortBound === '1') return;
        th.dataset.sortBound = '1';
        th.addEventListener('click', (e)=>{
          if(e && e.target && e.target.closest){
            const isSelectAll = e.target.closest('#chkAll');
            if(isSelectAll) return;
          }
          const col = th.getAttribute('data-col'); if(!col) return;
          const srt = getSort();
          if(!srt || srt.col !== col){
            state._sort = { col, dir: 'asc' };
          }else if(srt.dir === 'asc'){
            state._sort = { col, dir: 'desc' };
          }else{
            state._sort = null;
          }
          renderTable();
          save();
        });
      });
    }
    function renderInventoryTableShell(config){
      const table = $('invTable');
      const colgroup = $('invTableColgroup');
      const thead = $('invTableHead');
      if(!table || !colgroup || !thead) return;
      const layout = getInventoryLayoutFromConfig(config);
      const columnDefs = layout.columnDefs || [];
      _inventoryActiveColumns = columnDefs.slice();
      const colHtml = [`<col style="width:${escapeHtmlAttr(layout.itemWidth)}px">`];
      columnDefs.forEach(def=>{
        const width = getInventoryColumnRequiredWidth(def);
        colHtml.push(`<col style="width:${escapeHtmlAttr(width)}px">`);
      });
      if(layout.showActions){
        const actionsWidth = Number(INVENTORY_ACTIONS_DEF && INVENTORY_ACTIONS_DEF.minWidth) || 0;
        colHtml.push(`<col style="width:${escapeHtmlAttr(actionsWidth)}px">`);
      }
      colgroup.innerHTML = colHtml.join('');
      const sortDefs = getInventorySortDefsFromConfig({ order: layout.order, visible: layout.visible });
      ensureSortVisible(sortDefs);
      const sortSpan = ' <span class="sort-ind"></span>';
      const thHtml = [];
      const selectAll = `<label class="inv-select-all"><input type="checkbox" id="chkAll" aria-label="Select all"><span>Item</span></label>`;
      thHtml.push(`<th scope="col" class="sortable" data-col="name">${selectAll}${sortSpan}</th>`);
      columnDefs.forEach(def=>{
        if(!def) return;
        const col = def.dataCol || def.key;
        const label = def.label || def.key;
        const classes = [];
        if(def.sortable) classes.push('sortable');
        if(def.align === 'left') classes.push('align-left');
        if(def.align === 'center') classes.push('num');
        if(def.thClass) classes.push(def.thClass);
        const classAttr = classes.length ? ` class="${classes.join(' ')}"` : '';
        const sortHtml = def.sortable ? sortSpan : '';
        thHtml.push(`<th scope="col"${classAttr} data-col="${escapeHtmlAttr(col)}">${escapeHtml(label)}${sortHtml}</th>`);
      });
      if(layout.showActions && INVENTORY_ACTIONS_DEF){
        thHtml.push(`<th scope="col" class="actions" data-col="${escapeHtmlAttr(INVENTORY_ACTIONS_DEF.dataCol)}">${escapeHtml(INVENTORY_ACTIONS_DEF.label)}</th>`);
      }
      thead.innerHTML = `<tr>${thHtml.join('')}</tr>`;
      rebuildMobileSortOptions(sortDefs);
      bindInventorySortHandlers();
    }
    function renderColumnBuilderList(config){
      const list = $('columnBuilderList');
      if(!list) return;
      const order = (config && Array.isArray(config.order)) ? config.order : defaultInventoryOrder();
      const visible = new Set((config && Array.isArray(config.visible)) ? config.visible : defaultInventoryVisibleKeys());
      list.innerHTML = order.map(key => INVENTORY_COLUMN_MAP.get(key)).filter(Boolean).map(def=>{
        const checked = visible.has(def.key) ? ' checked' : '';
        const isLocked = def.lock || def.key === INVENTORY_ANCHOR_KEY;
        const disabled = isLocked ? ' disabled' : '';
        const draggable = isLocked ? 'false' : 'true';
        const rowClass = `${!isLocked ? ' is-draggable' : ''}`;
        const handle = `<span class="drag-handle${isLocked ? ' disabled' : ''}" aria-hidden="true"></span>`;
        return (
          `<div class="column-option${rowClass}" data-col-key="${escapeHtmlAttr(def.key)}" data-draggable="${draggable}" draggable="${draggable}">`+
            `<input type="checkbox" data-col-key="${escapeHtmlAttr(def.key)}"${checked}${disabled}>`+
            `<span class="column-option-label">${escapeHtml(def.label)}</span>`+
            `${handle}`+
          `</div>`
        );
      }).join('');
    }
    function getInventoryColumnConfig(){
      const config = loadInventoryColumnConfig();
      const orderSig = Array.isArray(config.order) ? config.order.join('|') : '';
      const visibleSig = Array.isArray(config.visible) ? config.visible.join('|') : '';
      const sig = `${orderSig}::${visibleSig}`;
      if(sig !== _inventoryColumnSig){
        _inventoryColumnSig = sig;
        _inventoryColumnConfig = { order: config.order.slice(), visible: config.visible.slice() };
        renderInventoryTableShell(config);
        renderColumnBuilderList(config);
      }
      return config;
    }
    function getInventoryColumnDefsFromConfig(config){
      return getInventoryLayoutFromConfig(config).columnDefs.slice();
    }
    function getInventorySortDefsFromConfig(config){
      const defs = [];
      const anchor = INVENTORY_COLUMN_MAP.get(INVENTORY_ANCHOR_KEY);
      if(anchor) defs.push(anchor);
      const layout = getInventoryLayoutFromConfig(config);
      return defs.concat(layout.columnDefs || []);
    }
    function getInventoryVisibleColumnDefs(){
      const layout = getInventoryLayout();
      return layout.columnDefs ? layout.columnDefs.slice() : [];
    }
    function getInventorySortDefs(){
      const layout = getInventoryLayout();
      const anchor = INVENTORY_COLUMN_MAP.get(INVENTORY_ANCHOR_KEY);
      const defs = [];
      if(anchor) defs.push(anchor);
      return defs.concat(layout.columnDefs || []);
    }
    function formatInventoryDate(value){
      const t = Date.parse(String(value || ''));
      if(!Number.isFinite(t)) return '';
      return new Date(t).toLocaleDateString(undefined, { month:'short', day:'numeric', year:'numeric' });
    }
    function renderTextCell(value){
      const txt = String(value ?? '').trim();
      const inner = txt ? escapeHtml(txt) : '<span class="muted">â€”</span>';
      return `<span class="cell-val">${inner}</span>`;
    }
    function renderNumberCell(value){
      const inner = (value === null || typeof value === 'undefined' || value === '')
        ? '<span class="muted">â€”</span>'
        : escapeHtml(formatQty(value));
      return `<span class="cell-val">${inner}</span>`;
    }
    function getInventoryReservedQty(item){
      if(!item || !Object.prototype.hasOwnProperty.call(item, 'reserved')) return null;
      const v = Number(item.reserved);
      return Number.isFinite(v) ? v : null;
    }
    function getInventoryReorderPoint(item){
      if(!item) return null;
      if(Object.prototype.hasOwnProperty.call(item, 'reorderPoint') && item.reorderPoint !== null && typeof item.reorderPoint !== 'undefined'){
        return item.reorderPoint;
      }
      if(Object.prototype.hasOwnProperty.call(item, 'lowStockQty') && item.lowStockQty !== null && typeof item.lowStockQty !== 'undefined'){
        return item.lowStockQty;
      }
      return null;
    }
    function render(){
      refreshInventoryLayout();
      renderKpis();
    }
    function ensureButtonSpinners(root){
      const scope = root && root.querySelectorAll ? root : document;
      const buttons = scope.querySelectorAll('.btn-primary, .btn-secondary, .btn-tertiary, .icon-btn');
      buttons.forEach(btn=>{
        if(btn.querySelector('.btn-spinner')) return;
        const spinner = document.createElement('span');
        spinner.className = 'btn-spinner';
        spinner.innerHTML = ICONS.loader2;
        btn.appendChild(spinner);
      });
    }
    function initButtonSystem(){
      ensureButtonSpinners();
      if(initButtonSystem._wired) return;
      initButtonSystem._wired = true;
      document.addEventListener('pointerdown', (e)=>{
        const btn = e.target && e.target.closest ? e.target.closest('.btn-primary, .btn-secondary, .btn-tertiary, .icon-btn') : null;
        if(!btn) return;
        if(btn.disabled || btn.getAttribute('aria-disabled') === 'true' || btn.dataset.loading === 'true') return;
        if(e.button && e.button !== 0) return;
        const rect = btn.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const ripple = document.createElement('span');
        ripple.className = 'btn-ripple';
        ripple.style.width = `${size}px`;
        ripple.style.height = `${size}px`;
        ripple.style.left = `${e.clientX - rect.left - size / 2}px`;
        ripple.style.top = `${e.clientY - rect.top - size / 2}px`;
        btn.appendChild(ripple);
        setTimeout(()=>{ if(ripple && ripple.parentNode) ripple.parentNode.removeChild(ripple); }, 520);
      }, { passive:true });
    }
    initButtonSystem.refresh = ensureButtonSpinners;

function adjustTitleSize(){
  try{
    const h1=document.querySelector('header h1');
    if(!h1) return;
    const wrap=document.querySelector('.brandtext');
    if(!wrap) return;
    h1.style.whiteSpace='nowrap'; h1.style.maxWidth='100%';
    h1.style.fontSize='';
    const rootStyles = getComputedStyle(document.documentElement);
    let min = parseFloat(rootStyles.getPropertyValue('--title-min')) || 12;
    let max = parseFloat(rootStyles.getPropertyValue('--title-max')) || 56;
    let size=parseFloat(getComputedStyle(h1).fontSize)||32;
    const roomEl = stack || wrap;
    const room = Math.max(0, roomEl.getBoundingClientRect().width - 8);
    const fits = ()=> h1.scrollWidth <= room;
    if(!fits()){
      while(size>min && !fits()){ size-=1; h1.style.fontSize=size+'px'; }
    }else{
      while(size<max){ h1.style.fontSize=(size+1)+'px'; if(!fits()){ h1.style.fontSize=size+'px'; break; } size+=1; }
    }
  }catch(e){}
}

	function getSort(){
	  if(!state._sort) return null;
	  // Handle if array was saved (convert back to single)
	  if(Array.isArray(state._sort)) return state._sort[0] || null;
	  if(!state._sort.col) return null;
	  return {col:state._sort.col, dir:state._sort.dir === 'desc' ? 'desc' : 'asc'};
	}
	function ensureSortVisible(defs){
	  const srt = getSort();
	  if(!srt) return;
	  const visibleCols = new Set((Array.isArray(defs) ? defs : []).map(def => def && (def.dataCol || def.key)).filter(Boolean));
	  if(!visibleCols.has(srt.col)){
	    state._sort = null;
	  }
	}
	function syncMobileSortSelect(){
	  const sel = $('mobileSort');
	  if(!sel) return;
	  const srt = getSort();
	  if(!srt){
	    sel.value = '';
	    return;
	  }
	  const key = `${srt.col}:${srt.dir}`;
	  const has = Array.from(sel.options || []).some(o => o.value === key);
	  if(has) sel.value = key;
	}
	function rebuildMobileSortOptions(defs){
	  const sel = $('mobileSort');
	  if(!sel) return;
	  const numericCols = new Set(['qty','reserved','available','reorderPoint','reorderQty']);
	  const dateCols = new Set(['updatedAt']);
	  const opts = ['<option value=\"\">No sort</option>'];
	  (Array.isArray(defs) ? defs : []).forEach(def=>{
	    const col = def ? (def.dataCol || def.key) : '';
	    if(!col || !def || !def.sortable) return;
	    const label = def.label || col;
	    if(dateCols.has(col)){
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:asc\">${escapeHtml(label)} (Oldest)</option>`);
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:desc\">${escapeHtml(label)} (Newest)</option>`);
	    }else if(numericCols.has(col)){
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:asc\">${escapeHtml(label)} (Lowâ€“High)</option>`);
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:desc\">${escapeHtml(label)} (Highâ€“Low)</option>`);
	    }else{
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:asc\">${escapeHtml(label)} (Aâ€“Z)</option>`);
	      opts.push(`<option value=\"${escapeHtmlAttr(col)}:desc\">${escapeHtml(label)} (Zâ€“A)</option>`);
	    }
	  });
	  sel.innerHTML = opts.join('');
	  syncMobileSortSelect();
	}
	function applySortIndicators(){
	  const srt = getSort();
	  document.querySelectorAll('#invTable thead th.sortable').forEach(th=>{
	    const col = th.getAttribute('data-col');
	    th.removeAttribute('aria-sort');
	    th.classList.remove('sorted-asc','sorted-desc');
	    if(srt && col === srt.col){
	      const desc = (srt.dir === 'desc');
	      th.setAttribute('aria-sort', desc ? 'descending' : 'ascending');
	      th.classList.add(desc ? 'sorted-desc' : 'sorted-asc');
	    }
	  });
	  syncMobileSortSelect();
	}

	function toTime(v){
	  const t = Date.parse(String(v || ''));
	  return Number.isFinite(t) ? t : 0;
	}
	function sortItems(arr){
	  const srt = getSort();
	  if(!srt) return arr;
	  const dir = srt.dir === 'desc' ? -1 : 1;
	  const col = srt.col || 'name';
	  const rows = arr.map((item, index) => ({ item, index }));
	  const getValue = (it)=>{
	    if(col === 'qty') return { type:'number', value: toInt(it.qty,0) };
	    if(col === 'reserved') return { type:'number', value: getInventoryReservedQty(it) };
	    if(col === 'available'){
	      const reserved = getInventoryReservedQty(it);
	      return { type:'number', value: toInt(it.qty,0) - (Number.isFinite(reserved) ? reserved : 0) };
	    }
	    if(col === 'reorderPoint') return { type:'number', value: getInventoryReorderPoint(it) };
	    if(col === 'reorderQty') return { type:'number', value: Number.isFinite(Number(it.reorderQty)) ? Number(it.reorderQty) : null };
	    if(col === 'updatedAt') return { type:'number', value: toTime(it.updatedAt) };
	    if(col === 'location') return { type:'string', value: toKey(String(inventoryLocationLabel(it) || '')) };
	    if(col === 'category') return { type:'string', value: toKey(String(it.categoryId || '')) };
	    if(col === 'sku') return { type:'string', value: toKey(String(it.sku || '')) };
	    if(col === 'desc') return { type:'string', value: toKey(String(it.desc || '')) };
	    return { type:'string', value: toKey(String(it.name || '')) };
	  };
	  rows.sort((a,b)=>{
	    const av = getValue(a.item);
	    const bv = getValue(b.item);
	    if(av.type === 'number'){
	      const aNil = av.value === null || typeof av.value === 'undefined' || Number.isNaN(av.value);
	      const bNil = bv.value === null || typeof bv.value === 'undefined' || Number.isNaN(bv.value);
	      if(aNil && bNil) return a.index - b.index;
	      if(aNil) return 1;
	      if(bNil) return -1;
	      if(av.value !== bv.value) return (av.value - bv.value) * dir;
	    }else{
	      const aVal = av.value || '';
	      const bVal = bv.value || '';
	      if(aVal !== bVal) return aVal.localeCompare(bVal) * dir;
	    }
	    return a.index - b.index;
	  });
	  return rows.map(r => r.item);
	}

	function adjustDescColumnWidth(){
	  return;
	}

		function isMobileUx(){
		  try{
		    if(!window.matchMedia) return false;
		    return window.matchMedia('(pointer: coarse)').matches;
		  }catch(e){ return false; }
		}
		function isMobileStacked(){ return isMobileUx(); }

	    function renderKpis(){
	      const el=$('lastUpdate');
	      if(!el) return;
	      el.textContent = state.updatedAt? `Last Update: ${new Date(state.updatedAt).toLocaleString(undefined,{hour12:true})}` : '';
      const fb=$('filterBox'); if(fb) fb.value = state._filter || '';
          }

    // -------- Partial-optimistic DOM helpers --------
	function tbodyEl(){ return document.querySelector('#invTable tbody'); }
	function rowElById(id){ return tbodyEl()?.querySelector(`tr[data-id="${id}"]`) || null; }
		function cellEl(tr, col){ return tr?.querySelector(`td[data-col="${col}"]`) || null; }
		function getSelectedRowIds(){
		  return Array.from(document.querySelectorAll('.rowChk:checked'))
		    .map(cb => String(cb.dataset.id || '').trim())
		    .filter(Boolean);
		}
		function applySelectedRowIds(ids){
		  const set = new Set((ids || []).map(id => String(id || '').trim()).filter(Boolean));
		  document.querySelectorAll('.rowChk').forEach(cb => {
		    const id = String(cb.dataset.id || '').trim();
		    cb.checked = set.has(id);
		  });
		  const all = document.querySelectorAll('.rowChk');
		  const checked = document.querySelectorAll('.rowChk:checked');
		  const m = $('chkAll');
		  if(m){
		    m.checked = (checked.length === all.length && all.length > 0);
		    m.indeterminate = (checked.length > 0 && checked.length < all.length);
		  }
		}
		function normalizeDescValue(value){
		  return String(value || '').replace(/[\r\n]+/g,' ').trim();
		}
		function truncateForConfirm(value, max = 60){
		  const txt = String(value || '');
		  if(!txt) return '(blank)';
		  return txt.length > max ? `${txt.slice(0, max - 1)}â€¦` : txt;
		}
			let _openTrayId = '';
			let _expandedCardId = '';
			const REVEAL_PX = 48; // icons begin appearing
			const TRAY_BTN_W = 72; // keep in sync with .card-tray-btn width
			const TRAY_SNAP_PAD = 20; // extra reveal beyond icons
			const COMMIT_PX = 210; // auto-trigger action (edit/order)
			const MAX_PX = 336; // elastic clamp

			function traySideFromSwipeX(x){
			  return (Number(x) || 0) < 0 ? 'right' : 'left';
			}
				function trayIconCountForSide(side){
				  const s = (side === 'left') ? 'left' : 'right';
				  return getVisibleInventoryTrayActions(s).length;
				}
			function trayHasActionsForSide(side){
			  return trayIconCountForSide(side) > 0;
			}
			function traySnapPxForSide(side){
			  const iconCount = trayIconCountForSide(side);
			  if(iconCount <= 0) return 0;
			  return (iconCount * TRAY_BTN_W) + TRAY_SNAP_PAD;
			}

		function collapseExpandedCard(){
		  if(!_expandedCardId) return;
		  const tr = rowElById(_expandedCardId);
		  if(tr) tr.classList.remove('card-expanded');
		  const tbody = tbodyEl();
		  if(tbody){
		    const rows = Array.from(tbody.querySelectorAll('tr.inv-detail-row'));
		    rows.forEach(row=>{
		      if(String(row.dataset.detailId || '') === String(_expandedCardId)) row.remove();
		    });
		  }
		  _expandedCardId = '';
		}
		function expandCard(id){
		  const nextId = String(id || '').trim();
		  if(!nextId) return;
		  if(_expandedCardId === nextId) return;
		  collapseExpandedCard();
		  const tr = rowElById(nextId);
		  if(!tr) return;
		  tr.classList.add('card-expanded');
		  _expandedCardId = nextId;
		  const it = state.items.find(x=> x && String(x.id || '') === nextId) || null;
		  if(!it) return;
		  const layout = getInventoryLayout();
		  const incomingMap = (state._incomingByItemId && typeof state._incomingByItemId.get === 'function')
		    ? state._incomingByItemId
		    : buildInventoryIncomingMap();
		  state._incomingByItemId = incomingMap;
		  const detailRow = document.createElement('tr');
		  detailRow.className = 'inv-detail-row';
		  detailRow.dataset.detailId = nextId;
		  detailRow.innerHTML = buildInventoryDetailRow(it, layout, incomingMap);
		  if(tr.parentNode){
		    if(tr.nextSibling) tr.parentNode.insertBefore(detailRow, tr.nextSibling);
		    else tr.parentNode.appendChild(detailRow);
		  }
		}
		function toggleExpandedCard(id){
		  const nextId = String(id || '').trim();
		  if(!nextId) return;
		  if(_expandedCardId === nextId) collapseExpandedCard();
		  else expandCard(nextId);
		}
	function clampNum(v, min, max){
	  return Math.max(min, Math.min(max, v));
	}
		function trayProgressForSwipeX(x){
		  const ax = Math.abs(Number(x) || 0);
		  const side = traySideFromSwipeX(x);
		  const snapPx = traySnapPxForSide(side);
		  if(!trayHasActionsForSide(side)) return 0;
		  if(ax <= REVEAL_PX) return 0;
		  return clampNum((ax - REVEAL_PX) / Math.max(1, (snapPx - REVEAL_PX)), 0, 1);
		}
	function getRowSwipeX(tr){
	  if(!tr || !tr.style) return 0;
	  const raw = String(tr.style.getPropertyValue('--swipe-x') || '').trim();
	  const n = Number.parseFloat(raw);
	  return Number.isFinite(n) ? n : 0;
	}
		function setRowSwipeX(tr, x){
		  if(!tr || !tr.style) return;
		  const v = clampNum(Number(x) || 0, -MAX_PX, MAX_PX);
		  const ax = Math.abs(v);
		  const side = traySideFromSwipeX(v);
		  if(!trayHasActionsForSide(side) && ax > 0){
		    tr.style.setProperty('--swipe-x', '0px');
		    tr.style.setProperty('--tray-progress', '0');
		    tr.style.setProperty('--tray-outer', '0');
		    tr.style.setProperty('--tray-inner', '0');
		    tr.style.setProperty('--commit-progress', '0');
		    tr.classList.remove('commit-armed');
		    return;
		  }
		  const snapPx = traySnapPxForSide(side);
		  const outer = trayProgressForSwipeX(v);
		  let inner = 0;
		  if(trayIconCountForSide(side) > 1){
		    const innerRevealPx = Math.round((REVEAL_PX + snapPx) / 2);
		    inner = (ax <= innerRevealPx) ? 0 : clampNum((ax - innerRevealPx) / Math.max(1, (snapPx - innerRevealPx)), 0, 1);
		  }
		  const commitDen = Math.max(1, (COMMIT_PX - snapPx));
		  const commitProgress = (ax <= snapPx) ? 0 : clampNum((ax - snapPx) / commitDen, 0, 1);
		  tr.style.setProperty('--swipe-x', `${v}px`);
		  tr.style.setProperty('--tray-progress', String(outer));
		  tr.style.setProperty('--tray-outer', String(outer));
			  tr.style.setProperty('--tray-inner', String(inner));
			  tr.style.setProperty('--commit-progress', String(commitProgress));
			  const traySide = (tr && tr.dataset) ? String(tr.dataset.traySide || '') : '';
			  const commitArmed = (!!traySide) && (Math.abs(v) >= COMMIT_PX);
			  tr.classList.toggle('commit-armed', commitArmed);
			}
		function traySideToSwipeX(side){
		  const s = (side === 'left') ? 'left' : 'right';
		  const snapPx = traySnapPxForSide(s);
		  if(!trayHasActionsForSide(s)) return 0;
		  return (s === 'left') ? snapPx : -snapPx;
		}
	function setMobileTrayA11y(tr, open){
	  const tray = tr ? tr.querySelector('.card-tray') : null;
	  if(!tray) return;
	  tray.setAttribute('aria-hidden', open ? 'false' : 'true');
	  tray.querySelectorAll('button.card-tray-btn').forEach(btn=>{
	    if(open) btn.removeAttribute('tabindex');
	    else btn.setAttribute('tabindex', '-1');
	  });
	}
	function closeMobileTray(){
	  if(!_openTrayId) return;
	  const tr = rowElById(_openTrayId);
	  if(tr){
	    tr.classList.remove('swiping');
	    tr.classList.remove('tray-peek');
	    tr.classList.remove('tray-open');
	    setRowSwipeX(tr, 0);
	    try{ delete tr.dataset.traySide; }catch(e){ tr.dataset.traySide = ''; }
	    setMobileTrayA11y(tr, false);
	  }
	  _openTrayId = '';
	}
		function closeMobileTrayElastic(targetTr){
		  const tr = targetTr || (_openTrayId ? rowElById(_openTrayId) : null);
		  if(tr){
		    tr.classList.remove('swiping');
		    tr.classList.remove('tray-peek');
		    tr.classList.remove('tray-open');
		    tr.classList.add('snap-elastic');
		    setRowSwipeX(tr, 0);
		    try{ delete tr.dataset.traySide; }catch(e){ tr.dataset.traySide = ''; }
		    setMobileTrayA11y(tr, false);
		    // Remove elastic class after animation completes
		    setTimeout(()=>{ try{ tr.classList.remove('snap-elastic'); }catch(e){} }, 400);
		  }
		  _openTrayId = '';
		}
			function trayLeftHTML(){
			  const actions = getVisibleInventoryTrayActions('left');
			  return actions.map(key=>{
			    const meta = inventoryActionMetaForKey(key);
			    if(!meta) return '';
			    const label = meta.label ? meta.label() : '';
			    return ''+
			      '<button type="button" class="card-tray-btn" data-tray-action="'+meta.trayAction+'" tabindex="-1" aria-label="'+escapeHtmlAttr(label)+'" title="'+escapeHtmlAttr(label)+'">'+
			        meta.icon()+
			      '</button>';
			  }).join('');
			}
		function trayRightHTML(){
		  const actions = getVisibleInventoryTrayActions('right');
		  return actions.map(key=>{
		    const meta = inventoryActionMetaForKey(key);
		    if(!meta) return '';
		    const label = meta.label ? meta.label() : '';
		    return ''+
		      '<button type="button" class="card-tray-btn" data-tray-action="'+meta.trayAction+'" tabindex="-1" aria-label="'+escapeHtmlAttr(label)+'" title="'+escapeHtmlAttr(label)+'">'+
		        meta.icon()+
		      '</button>';
		  }).join('');
		}
		function updateOrderTrayButtonLabel(tr){
		  const btn = tr ? tr.querySelector('button.card-tray-btn[data-tray-action="order"]') : null;
		  if(!btn) return;
		  const inOrder = !!(tr && tr.classList && tr.classList.contains('order-selected'));
		  const label = inOrder ? 'Remove from order' : 'Add to order';
		  btn.setAttribute('aria-label', label);
		  btn.setAttribute('title', label);
		}
		function ensureMobileTrayContent(tr, side){
		  const tray = tr ? tr.querySelector('.card-tray') : null;
		  if(!tray) return;
		  const kind = (side === 'left') ? 'left' : 'right';
		  const prior = tray.dataset ? String(tray.dataset.kind || '') : '';
		  if(prior === kind) return;
		  if(tray.dataset) tray.dataset.kind = kind;
		  tray.innerHTML = (kind === 'left') ? trayLeftHTML() : trayRightHTML();
		  try{
		    tray.querySelectorAll('button.card-tray-btn').forEach(btn=> btn.setAttribute('tabindex', '-1'));
		  }catch(e){}
		  updateOrderTrayButtonLabel(tr);
		}
		function prepareMobileTrayForRow(tr, side){
		  if(!tr) return;
		  const id = String(tr.dataset && tr.dataset.id ? tr.dataset.id : '').trim();
		  if(!id) return;
		  if(!trayHasActionsForSide(side)){
		    closeMobileTray();
		    return;
		  }
		  if(_openTrayId && _openTrayId !== id) closeMobileTray();
		  _openTrayId = id;
		  tr.dataset.traySide = (side === 'left') ? 'left' : 'right';
		  ensureMobileTrayContent(tr, tr.dataset.traySide);
		  tr.classList.remove('tray-open');
		  tr.classList.add('tray-peek');
		  setMobileTrayA11y(tr, false);
		}
		function openMobileTrayForRow(tr, side){
		  if(!tr) return;
		  const id = String(tr.dataset && tr.dataset.id ? tr.dataset.id : '').trim();
		  if(!id) return;
		  if(!trayHasActionsForSide(side)){
		    closeMobileTray();
		    return;
		  }
		  if(_openTrayId && _openTrayId !== id) closeMobileTray();
		  _openTrayId = id;
		  tr.dataset.traySide = (side === 'left') ? 'left' : 'right';
		  ensureMobileTrayContent(tr, tr.dataset.traySide);
		  tr.classList.remove('tray-peek');
		  tr.classList.add('tray-open');
		  setMobileTrayA11y(tr, true);
		  const targetX = traySideToSwipeX(tr.dataset.traySide);
		  try{ requestAnimationFrame(()=> setRowSwipeX(tr, targetX)); }catch(e){ setRowSwipeX(tr, targetX); }
		}
		function syncOrderIndicatorForRow(id){
		  const tr = rowElById(id);
		  if(!tr) return;
		  let inOrder = false;
		  try{
		    const ord = orderState();
		    inOrder = !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && l.id === id));
		  }catch(e){}
		  const orderBtn = tr.querySelector('.row-order-btn');
		  if(orderBtn){
		    orderBtn.classList.toggle('row-order-btn--active', inOrder);
		    orderBtn.setAttribute('aria-pressed', inOrder ? 'true' : 'false');
		    const label = inOrder ? 'Remove from order' : 'Add to order';
		    orderBtn.setAttribute('aria-label', label);
		    orderBtn.setAttribute('title', label);
		  }
		  const detailBtn = document.querySelector(`tr.inv-detail-row[data-detail-id="${CSS.escape(String(id || ''))}"] button[data-detail-action="order"]`);
		  if(detailBtn){
		    const label = inOrder ? 'Remove from Order' : 'Add to Order';
		    detailBtn.setAttribute('aria-label', label);
		    detailBtn.setAttribute('title', label);
		    const text = detailBtn.querySelector('span');
		    if(text) text.textContent = label;
		  }
		  tr.classList.toggle('order-selected', inOrder);
		  updateOrderTrayButtonLabel(tr);
		}
		function toggleOrderLineForItemId(id){
		  const itemId = String(id || '').trim();
		  if(!itemId) return;
		  if(!canOrdersCreate()) return;
		  const item = state.items.find(x => x && x.id === itemId);
		  if(!item) return;
		  let exists = false;
		  try{
		    const ord = orderState();
		    exists = !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && l.id === itemId));
		  }catch(e){ exists = false; }
		  if(exists) removeOrderLine(itemId);
		  else upsertOrderLineFromItem(item, 1);
		}
		function syncLowStockOverrideIndicatorForRow(id){
		  const tr = rowElById(id);
		  if(!tr) return;
		  const item = state.items.find(x => x && x.id === id);
	  if(!item) return;
	  const hasLowStockOverride = getItemLowStockQtyOverride(item) !== null;

	  const btn = tr.querySelector('.row-stock-btn');
	  if(btn){
	    btn.classList.toggle('has-override', hasLowStockOverride);
	    const lowStockBtnLabel = hasLowStockOverride ? 'Set low stock qty (override)' : 'Set low stock qty';
	    btn.setAttribute('aria-label', lowStockBtnLabel);
	    btn.setAttribute('title', lowStockBtnLabel);
	  }
	}
	function syncLowStockIndicatorForRowNow(id){
	  const tr = rowElById(id);
	  if(!tr) return;
	  const item = state.items.find(x => x && x.id === id);
	  if(!item) return;
	  const silenced = lowStockAlertsSilenced();
	  const qty = toInt(item.qty, 0);
	  const isLowStock = !silenced && isLowStockItem(item);
	  const isOutOfStock = isLowStock && qty === 0;
	  const isLowButInStock = isLowStock && qty > 0;
	  const led = tr.querySelector('.card-led--lowstock');
	  if(led){
	    led.classList.toggle('card-led--outofstock', isOutOfStock);
	    led.classList.toggle('card-led--on', isLowButInStock);
	  }
	}
	// Debounced version - waits for user to stop clicking before updating LED
	function syncLowStockIndicatorForRow(id){
	  const existing = _qtyLedSync.get(id);
	  if(existing) clearTimeout(existing);
	  _qtyLedSync.set(id, setTimeout(()=> {
	    _qtyLedSync.delete(id);
	    syncLowStockIndicatorForRowNow(id);
	  }, 300));
	}
		function inventoryLocationLabel(it){
		  const id = String(it && it.locationId ? it.locationId : '').trim();
		  if(!id) return '';
		  const map = state._companyLocationById;
		  const row = map && typeof map.get === 'function' ? map.get(id) : null;
		  return row && row.name ? String(row.name) : id;
		}
		function inventorySignalValue(def, it){
		  if(!def || !it) return '';
		  if(def.key === 'description') return normalizeDescValue(it.desc || '');
		  if(def.key === 'sku') return String(it.sku || '').trim();
		  if(def.key === 'location') return inventoryLocationLabel(it);
		  if(def.key === 'on_hand') return formatQty(toInt(it.qty,0));
		  if(def.key === 'reserved'){
		    const reserved = getInventoryReservedQty(it);
		    return Number.isFinite(reserved) ? formatQty(reserved) : '';
		  }
		  if(def.key === 'available'){
		    const reserved = getInventoryReservedQty(it);
		    const available = toInt(it.qty,0) - (Number.isFinite(reserved) ? reserved : 0);
		    return formatQty(available);
		  }
		  if(def.key === 'reorder_point'){
		    const rp = getInventoryReorderPoint(it);
		    return (rp === null || typeof rp === 'undefined') ? '' : formatQty(rp);
		  }
		  if(def.key === 'reorder_qty'){
		    const rq = Number.isFinite(Number(it.reorderQty)) ? Number(it.reorderQty) : null;
		    return (rq === null || typeof rq === 'undefined') ? '' : formatQty(rq);
		  }
		  if(def.key === 'category') return String(it.categoryId || '').trim();
		  return '';
		}
		function isItemInOrder(itemId){
		  const id = String(itemId || '').trim();
		  if(!id) return false;
		  try{
		    const ord = orderState();
		    return !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && String(l.id || '') === id));
		  }catch(e){
		    return false;
		  }
		}
		function buildInventoryIncomingMap(){
		  const map = new Map();
		  const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
		  if(!rows.length) return map;
		  const lineMap = state._orderHistoryLinesByPo || new Map();
		  for(const row of rows){
		    if(isOrderCurrentlyReceived(row)) continue;
		    const orderId = String(row && row.id ? row.id : '').trim();
		    if(!orderId) continue;
		    const lines = normalizePurchaseOrderLines(lineMap.get(orderId) || []);
		    for(const line of lines){
		      const itemId = String(line.item_id || '').trim();
		      if(!itemId) continue;
		      const ordered = toQty(line.quantity_ordered, 0);
		      const received = toQty(line.quantity_received, 0);
		      const remaining = Math.max(0, ordered - received);
		      if(remaining <= 0) continue;
		      let entry = map.get(itemId);
		      if(!entry){
		        entry = { qty: 0, orders: new Set() };
		      }
		      entry.qty += remaining;
		      entry.orders.add(orderId);
		      map.set(itemId, entry);
		    }
		  }
		  return map;
		}
		function buildInventorySignalsHtml(it, defs){
		  const list = Array.isArray(defs) ? defs : [];
		  if(!list.length) return '';
		  return list.map(def=>{
		    const raw = inventorySignalValue(def, it);
		    const display = (raw === '' || raw === null || typeof raw === 'undefined') ? 'â€”' : String(raw);
		    const label = def.label || def.key;
		    const title = `${label}: ${display}`;
		    return (
		      `<span class="inv-signal" title="${escapeHtmlAttr(title)}">`+
		        `<span class="inv-signal-label">${escapeHtml(label)}</span>`+
		        `<span class="inv-signal-value">${escapeHtml(display)}</span>`+
		      `</span>`
		    );
		  }).join('');
		}
		function buildInventoryQtyStepper(it, ctx){
		  const qty = toInt(it.qty,0);
		  const display = escapeHtml(formatQty(qty));
		  if(!ctx || !ctx.allowInlineEdit){
		    return `<div class="qty-stepper qty-stepper--table" aria-label="On hand quantity"><span class="qty-value">${display}</span></div>`;
		  }
		  return (
		    `<div class="qty-stepper qty-stepper--table" aria-label="On hand quantity">`+
		      `<button type="button" class="qty-step" data-id="${escapeHtmlAttr(ctx.id)}" data-delta="-1"${qty <= 0 ? ' disabled' : ''}>âˆ’</button>`+
		      `<span class="qty-value">${display}</span>`+
		      `<button type="button" class="qty-step" data-id="${escapeHtmlAttr(ctx.id)}" data-delta="1">+</button>`+
		    `</div>`
		  );
		}
		function buildInventoryItemCell(ctx){
		  const it = ctx.item;
		  const name = String(it.name || '').trim();
		  const checkbox = `<input type="checkbox" class="rowChk inv-row-check" data-id="${escapeHtmlAttr(ctx.id)}"${ctx.allowSelect ? '' : ' disabled'}>`;
		  return (
		    `<td data-col="name">`+
		      `<div class="card-leds" aria-hidden="true">`+
		        `<span class="${ctx.lowstockLedClass}"></span>`+
		      `</div>`+
		      `<div class="card-tray" aria-hidden="true" data-kind=""></div>`+
		      `<div class="inv-item-main">`+
		        checkbox+
		        `<div class="inv-item-line">`+
		          `<span class="inv-item-name" title="${escapeHtmlAttr(name)}">${escapeHtml(name || '(Unnamed item)')}</span>`+
		        `</div>`+
		      `</div>`+
		    `</td>`
		  );
		}
		function buildInventoryColumnCellInner(it, def, ctx){
		  if(!def) return renderTextCell('');
		  if(def.key === 'on_hand'){
		    return renderNumberCell(toInt(it.qty,0));
		  }
		  if(def.key === 'sku'){
		    const sku = String(it.sku || '').trim();
		    return renderTextCell(sku);
		  }
		  if(def.key === 'description'){
		    const desc = normalizeDescValue(it.desc || '');
		    return renderTextCell(desc);
		  }
		  if(def.key === 'location'){
		    const loc = inventoryLocationLabel(it);
		    return renderTextCell(loc);
		  }
		  if(def.key === 'reserved'){
		    const reserved = getInventoryReservedQty(it);
		    return renderNumberCell(reserved);
		  }
		  if(def.key === 'available'){
		    const reserved = getInventoryReservedQty(it);
		    const available = toInt(it.qty,0) - (Number.isFinite(reserved) ? reserved : 0);
		    return renderNumberCell(available);
		  }
		  if(def.key === 'reorder_point'){
		    const rp = getInventoryReorderPoint(it);
		    return renderNumberCell(rp);
		  }
		  if(def.key === 'reorder_qty'){
		    const rq = Number.isFinite(Number(it.reorderQty)) ? Number(it.reorderQty) : null;
		    return renderNumberCell(rq);
		  }
		  if(def.key === 'category'){
		    const cat = String(it.categoryId || '').trim();
		    return renderTextCell(cat);
		  }
		  const fallback = inventorySignalValue(def, it);
		  return renderTextCell(fallback);
		}
		function buildInventoryColumnCells(it, columnDefs, ctx){
		  const defs = Array.isArray(columnDefs) ? columnDefs : [];
		  if(!defs.length) return '';
		  return defs.map(def=>{
		    if(!def) return '';
		    const col = def.dataCol || def.key;
		    const numeric = def.align === 'center';
		    const alignLeft = def.align === 'left';
		    const classAttr = (numeric || alignLeft) ? ` class="${numeric ? 'num' : 'align-left'}"` : '';
		    const inner = buildInventoryColumnCellInner(it, def, ctx);
		    return `<td data-col="${escapeHtmlAttr(col)}"${classAttr}>${inner}</td>`;
		  }).join('');
		}
		function buildInventoryActionsCell(ctx, showActions){
		  if(!showActions) return '';
		  const actions = getVisibleInventoryRowActions();
		  if(!actions.length){
		    return '<td class="actions" data-col="actions"><div class="actions-wrap"></div></td>';
		  }
		  const buttons = actions.map(key=>{
		    const meta = inventoryActionMetaForKey(key);
		    if(!meta) return '';
		    const label = meta.label ? meta.label(ctx) : '';
		    const ariaPressed = (key === 'order_item') ? ` aria-pressed="${ctx.inOrder ? 'true' : 'false'}"` : '';
		    const extraClass = (key === 'order_item') ? ` ${ctx.orderBtnClass}` : '';
		    return (
		      '<button class="'+meta.btnClass+extraClass+'" data-id="'+ctx.id+'" aria-label="'+escapeHtmlAttr(label)+'" title="'+escapeHtmlAttr(label)+'"'+ariaPressed+'>'+
		        meta.icon()+
		      '</button>'
		    );
		  }).join('');
		  return '<td class="actions" data-col="actions"><div class="actions-wrap">'+buttons+'</div></td>';
		}
		function buildInventoryDetailRow(it, layout, incomingMap){
		  if(!it || !layout) return '';
		  const id = String(it.id || '').trim();
		  const colCount = 1 + (layout.columnDefs ? layout.columnDefs.length : 0) + (layout.showActions ? 1 : 0);
		  const qty = toInt(it.qty, 0);
		  const reserved = getInventoryReservedQty(it);
		  const reservedNum = Number.isFinite(reserved) ? reserved : 0;
		  const available = Math.max(0, qty - reservedNum);
		  const incoming = incomingMap && incomingMap.get(id) ? incomingMap.get(id) : null;
		  const incomingQty = incoming ? incoming.qty : 0;
		  const incomingOrders = incoming ? incoming.orders.size : 0;
		  const incomingText = (incomingQty > 0)
		    ? `+${formatQty(incomingQty)} from ${incomingOrders} open order${incomingOrders === 1 ? '' : 's'}`
		    : '';
		  const incomingHtml = incomingQty > 0
		    ? `<span class="inv-detail-incoming">${ICONS.package}<span class="inv-detail-incoming-text">${escapeHtml(incomingText)}</span></span>`
		    : '<span class="muted">â€”</span>';
		  const hasDescColumn = Array.isArray(layout.columnKeys) && layout.columnKeys.includes('description');
		  const desc = normalizeDescValue(it.desc || '');
		  const descHtml = (!hasDescColumn && desc)
		    ? `<div class="inv-detail-section">`+
		        `<div class="inv-detail-title">Description</div>`+
		        `<div class="inv-detail-desc">${escapeHtml(desc)}</div>`+
		      `</div>`
		    : '';
		  const actions = [];
		  const inOrder = isItemInOrder(id);
		  if(isInventoryActionVisible('order_item') && canOrdersCreate()){
		    const label = inOrder ? 'Remove from Order' : 'Add to Order';
		    actions.push(
		      `<button class="btn-tertiary btn-sm btn-with-icon" type="button" data-detail-action="order" data-id="${escapeHtmlAttr(id)}" aria-label="${escapeHtmlAttr(label)}" title="${escapeHtmlAttr(label)}">`+
		        ICONS.shoppingBag+
		        `<span>${escapeHtml(label)}</span>`+
		      `</button>`
		    );
		  }
		  if(isInventoryActionVisible('add_to_job')){
		    actions.push(
		      `<button class="btn-tertiary btn-sm btn-with-icon" type="button" data-detail-action="job" data-id="${escapeHtmlAttr(id)}" aria-label="Add to Job" title="Add to Job">`+
		        ICONS.briefcasePlus+
		        `<span>Add to Job</span>`+
		      `</button>`
		    );
		  }
		  if(isInventoryActionVisible('edit_item') && canItemsEdit()){
		    actions.push(
		      `<button class="btn-tertiary btn-sm btn-with-icon" type="button" data-detail-action="edit" data-id="${escapeHtmlAttr(id)}" aria-label="Edit Item" title="Edit Item">`+
		        ICONS.pencil+
		        `<span>Edit Item</span>`+
		      `</button>`
		    );
		  }
		  const actionsHtml = actions.length
		    ? `<div class="inv-detail-section">`+
		        `<div class="inv-detail-title">Quick Actions</div>`+
		        `<div class="inv-detail-actions">${actions.join('')}</div>`+
		      `</div>`
		    : '';
		  return (
		    `<td colspan="${colCount}">`+
		      `<div class="inv-detail-panel">`+
		        `<div class="inv-detail-section">`+
		          `<div class="inv-detail-title">Inventory Snapshot</div>`+
		          `<div class="inv-detail-metrics">`+
		            `<div class="inv-detail-metric">`+
		              `<span class="inv-detail-label">On Hand</span>`+
		              `<span class="inv-detail-value">${escapeHtml(formatQty(qty))}</span>`+
		            `</div>`+
		            `<div class="inv-detail-metric">`+
		              `<span class="inv-detail-label">Reserved</span>`+
		              `<span class="inv-detail-value">${(reserved === null || typeof reserved === 'undefined') ? '<span class=\"muted\">â€”</span>' : escapeHtml(formatQty(reserved))}</span>`+
		            `</div>`+
		            `<div class="inv-detail-metric">`+
		              `<span class="inv-detail-label">Available</span>`+
		              `<span class="inv-detail-value">${escapeHtml(formatQty(available))}</span>`+
		            `</div>`+
		            `<div class="inv-detail-metric">`+
		              `<span class="inv-detail-label">Incoming</span>`+
		              `<span class="inv-detail-value">${incomingHtml}</span>`+
		            `</div>`+
		          `</div>`+
		        `</div>`+
		        `${descHtml}`+
		        `${actionsHtml}`+
		      `</div>`+
		    `</td>`
		  );
		}
		function buildRowHTML(it, columnDefs, layout){
		  const rawId = String(it && it.id ? it.id : '');
		  const id = escapeHtmlAttr(rawId);
		  const allowSelect = canItemsCreate() || canItemsEdit() || canItemsDelete();
		  const canEdit = canItemsEdit();
		  const isLowStock = isLowStockItem(it);
		  const inOrder = isItemInOrder(rawId);
		  const showLowStockLed = isLowStock && !lowStockAlertsSilenced();
		  const qty = toInt(it.qty, 0);
		  const isOutOfStock = showLowStockLed && qty === 0;
		  const isLowButInStock = showLowStockLed && qty > 0;
		  const lowstockLedClass = isOutOfStock ? 'card-led card-led--lowstock card-led--outofstock' : (isLowButInStock ? 'card-led card-led--lowstock card-led--on' : 'card-led card-led--lowstock');
		  const orderBtnClass = inOrder ? 'row-order-btn--active' : '';
		  const cols = Array.isArray(columnDefs) ? columnDefs : getInventoryVisibleColumnDefs();
		  const showActions = layout && typeof layout.showActions === 'boolean' ? layout.showActions : getInventoryLayout().showActions;
		  const ctx = { item: it, id, allowSelect, canEdit, inOrder, lowstockLedClass, orderBtnClass, allowInlineEdit: canEdit && !isMobileUx() };
		  let html = buildInventoryItemCell(ctx);
		  html += buildInventoryColumnCells(it, cols, ctx);
		  if(showActions){
		    html += buildInventoryActionsCell(ctx, showActions);
		  }
		  return html;
		}
// Insert a row into the table in sorted position by name
function insertRowSorted(it){
  const tb = tbodyEl(); if(!tb) return;
  const empty = tb.querySelector('tr[data-empty="1"]'); if(empty) empty.remove();
  const trs = Array.from(tb.querySelectorAll('tr[data-id]'));
  const k = toKey(it.name);
  let anchor = null;
  for(const tr of trs){
    const nm = tr.querySelector('.inv-item-name')?.textContent || '';
    if(toKey(nm) > k){ anchor = tr; break; }
  }
  const tr = document.createElement('tr');
  tr.dataset.id = it.id;
  tr.innerHTML = buildRowHTML(it, _inventoryActiveColumns, getInventoryLayout());
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing(); // attach listeners to the new row
}
// Reposition existing row if its name changed
function repositionRowByName(id){
  const tb = tbodyEl(); if(!tb) return;
  const tr = rowElById(id); if(!tr) return;
  const it = state.items.find(x=> x.id===id); if(!it) return;
  tr.innerHTML = buildRowHTML(it, _inventoryActiveColumns, getInventoryLayout()); // refresh cells
  const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
  const k = toKey(it.name);
  let anchor = null;
  for(const r of others){
    const nm = r.querySelector('.inv-item-name')?.textContent || '';
    if(toKey(nm) > k){ anchor = r; break; }
  }
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing();
}
// Update just one cell
	function updateCellDisplay(id, col, value){
	  const tr = rowElById(id); if(!tr) return;
	  const td = cellEl(tr, col); if(!td) return;
		  if(col==='qty'){
		    const v = String(toInt(value,0));
		    const cellVal = td.querySelector('.cell-val');
		    const stepVal = td.querySelector('.qty-value');
		    if(cellVal) cellVal.textContent = v;
		    else if(stepVal) stepVal.textContent = v;
		    else td.textContent = v;
		    return;
		  }
	  td.textContent = String(value||'');
	}

function updateFilterClearBtn(){
  const fb = $('filterBox');
  const btn = $('btnClearFilter');
  if(!fb || !btn) return;
  const has = String(fb.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderSearchClearBtn(){
  const inp = $('orderSearch');
  const btn = $('btnClearOrderSearch');
  if(!inp || !btn) return;
  const has = String(inp.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderHistoryFilterClearBtn(){
  const inp = $('orderHistoryFilter');
  const btn = $('btnClearOrderHistoryFilter');
  if(!inp || !btn) return;
  const has = String(inp.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}
// Ensure an empty-state row exists when there are no data rows
function emptyStateHtml(){
  const gate = explainGate();
  if(!gate){
    return 'No items yet. Use <b>Import File</b> or <b>Paste Data</b> above, or <b>Add Item</b> to create one.';
  }
  if(gate === 'Sign in required'){
    return 'Sign in to view your inventory. Tap the status bar above.';
  }
  if(gate === 'No company access'){
    return 'No company access yet. Tap the status bar above for account details.';
  }
  if(gate === 'Permission denied'){
    return 'Your role does not allow inventory access. Tap the status bar above for account details.';
  }
  if(gate === 'Not authorized'){
    return 'Not authorized for this inventory. Tap the status bar above for account details.';
  }
  if(gate.startsWith('Offline')){
    return 'Offline. Connect to load your inventory.';
  }
  return escapeHtml(gate);
}
	function ensureEmptyState(){
	  const tb = tbodyEl(); if(!tb) return;
	  const hasRows = tb.querySelector('tr[data-id]') !== null;
	  const existingEmpty = tb.querySelector('tr[data-empty="1"]');
	  if(!hasRows && !existingEmpty){
	    const layout = getInventoryLayout();
	    const activeCols = Array.isArray(layout.columnDefs) ? layout.columnDefs : getInventoryVisibleColumnDefs();
	    const colCount = 1 + activeCols.length + (layout.showActions ? 1 : 0);
	    const tr=document.createElement('tr'); tr.setAttribute('data-empty','1');
	    tr.innerHTML = '<td colspan="'+colCount+'" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
	    tb.appendChild(tr);
	  } else if(hasRows && existingEmpty){
	    existingEmpty.remove();
	  }
	}

	function isCompactTotals(){
	  try{ return window.matchMedia && window.matchMedia('(max-width:520px)').matches; }catch(e){ return false; }
	}
	function totalsLabel(key){
	  const compact = isCompactTotals();
	  if(key === 'items') return compact ? 'Items' : 'Total Items';
	  if(key === 'inStock') return compact ? 'Stock' : 'In Stock';
	  if(key === 'lowStock') return compact ? 'Low' : 'Low Stock';
	  if(key === 'qty') return compact ? 'Qty' : 'Total Qty';
	  return String(key || '');
	}
	function getTotalsValue(elId){
	  const el = $(elId);
	  if(!el) return null;
	  const dv = el.dataset ? String(el.dataset.value || '').trim() : '';
	  if(dv){
	    const v = Number(dv);
	    if(Number.isFinite(v)) return Math.trunc(v);
	  }
	  const m = /:\s*(\d+)/.exec(el.textContent || '');
	  if(!m) return null;
	  return toInt(m[1], 0);
	}
	function setTotalsMetric(elId, key, value){
	  const el = $(elId);
	  if(!el) return;
	  const v = Math.max(0, toInt(value,0));
	  if(el.dataset) el.dataset.value = String(v);
	  el.textContent = `${totalsLabel(key)}: ${v}`;
	}
	function refreshTotalsLabels(){
	  const vItems = getTotalsValue('totalItems'); if(vItems !== null) setTotalsMetric('totalItems','items', vItems);
	  const vStock = getTotalsValue('totalInStock'); if(vStock !== null) setTotalsMetric('totalInStock','inStock', vStock);
	  const vLow = getTotalsValue('totalLowStock'); if(vLow !== null) setTotalsMetric('totalLowStock','lowStock', vLow);
	  const vQty = getTotalsValue('totalQty'); if(vQty !== null) setTotalsMetric('totalQty','qty', vQty);
	}
	    function renderTable(columnDefsOverride, layoutOverride){
	      try{ closeMobileTray(); }catch(e){}
	      const config = getInventoryColumnConfig();
	      const layout = layoutOverride || getInventoryLayoutFromConfig(config);
	      let columnDefs = Array.isArray(columnDefsOverride) ? columnDefsOverride.slice() : null;
	      if(!columnDefs){
	        columnDefs = Array.isArray(layout.columnDefs) ? layout.columnDefs.slice() : getInventoryColumnDefsFromConfig(config);
	      }
	      _inventoryActiveColumns = columnDefs.slice();
	      applySortIndicators();
		      const tbody=$('#invTable').querySelector('tbody'); tbody.innerHTML='';
		      const term=(state._filter||'').trim().toLowerCase();

      let items = applyInventoryQuickFilter(state.items);
      if(term){
        items = items.filter(it=>{
          const name=(it.name||'').toLowerCase();
          const desc=(it.desc||'').toLowerCase();
          const qty = String(toInt(it.qty,0));
          return name.includes(term) || desc.includes(term) || qty.includes(term);
        });
      }
      items = sortItems(items);
      const incomingMap = buildInventoryIncomingMap();
      state._incomingByItemId = incomingMap;
      const totalQty = items.reduce((sum, it) => sum + toInt(it.qty,0), 0);
		      const totalItems = items.length;
		      const inStock = items.reduce((count, it) => count + (toInt(it.qty,0) > 0 ? 1 : 0), 0);
		      const lowStock = items.reduce((count, it) => count + (isLowStockItem(it) ? 1 : 0), 0);
		      setTotalsMetric('totalQty', 'qty', totalQty);
		      setTotalsMetric('totalItems', 'items', totalItems);
		      setTotalsMetric('totalInStock', 'inStock', inStock);
		      setTotalsMetric('totalLowStock', 'lowStock', lowStock);
		      if(items.length===0){
	      const tr=document.createElement('tr');
	      const colCount = 1 + columnDefs.length + (layout.showActions ? 1 : 0);
	      tr.innerHTML = '<td colspan="'+colCount+'" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
	      tbody.appendChild(tr);
      return;
      }
				      for(const it of items){
				        const tr=document.createElement('tr'); tr.dataset.id=it.id;
				        const inOrder = isItemInOrder(it.id);
				        if(inOrder) tr.classList.add('order-selected');
				        const isExpanded = _expandedCardId && String(it.id) === String(_expandedCardId);
				        if(isExpanded) tr.classList.add('card-expanded');
				        tr.innerHTML = buildRowHTML(it, columnDefs, layout);
				        tbody.appendChild(tr);
				        if(isExpanded){
				          const detailRow = document.createElement('tr');
				          detailRow.className = 'inv-detail-row';
				          detailRow.dataset.detailId = String(it.id || '');
				          detailRow.innerHTML = buildInventoryDetailRow(it, layout, incomingMap);
				          tbody.appendChild(detailRow);
				        }
				      }
	      enableInlineEditing();
	      try{ initButtonSystem.refresh(); }catch(e){}
	      try{ requestAnimationFrame(()=>{ adjustTitleSize(); }); }catch(e){}
	    }

      let _inventoryLayoutTimer = null;
      function refreshInventoryLayout(){
        const config = getInventoryColumnConfig();
        _inventoryLayoutSig = '';
        renderInventoryTableShell(config);
        renderTable();
      }
      function scheduleInventoryLayoutRefresh(){
        if(_inventoryLayoutTimer) clearTimeout(_inventoryLayoutTimer);
        _inventoryLayoutTimer = setTimeout(()=>{
          _inventoryLayoutTimer = null;
          try{ closeMobileTray(); }catch(e){}
          try{ refreshInventoryLayout(); }catch(e){}
          try{ adjustTitleSize(); }catch(e){}
          try{ setEditHint(); }catch(e){}
          try{ refreshTotalsLabels(); }catch(e){}
        }, 120);
      }

	    function initColumnBuilder(){
	      const btn = $('btnColumnBuilder');
	      const panel = $('columnBuilder');
	      const list = $('columnBuilderList');
	      const resetBtn = $('btnColumnsReset');
	      const closeBtn = $('btnColumnsClose');
	      const dragHandle = $('columnBuilderDrag');
	      const tapWrap = $('columnBuilderTap');
	      if(!btn || !panel || !list) return;
	      const syncTapUI = ()=>{
	        if(!tapWrap) return;
	        const allowed = getAllowedInventoryRowTapOptions();
	        tapWrap.querySelectorAll('[data-tap-option]').forEach(label=>{
	          const key = String(label.getAttribute('data-tap-option') || '').trim();
	          const visible = allowed.has(key);
	          label.style.display = visible ? '' : 'none';
	          const input = label.querySelector('input[name="rowTapPref"]');
	          if(input) input.disabled = !visible;
	        });
	        const pref = getInventoryRowTapPref();
	        tapWrap.querySelectorAll('input[name="rowTapPref"]').forEach(input=>{
	          input.checked = String(input.value || '') === pref;
	        });
	      };

	      const applyPanelOffset = (x, y)=>{
	        if(panel.classList.contains('column-builder--centered')) return;
	        const nx = Number.isFinite(x) ? x : 0;
	        const ny = Number.isFinite(y) ? y : 0;
	        panel.dataset.offsetX = String(nx);
	        panel.dataset.offsetY = String(ny);
	        panel.style.transform = `translate(${nx}px, ${ny}px)`;
	      };
	      const getPanelOffset = ()=>{
	        const x = Number(panel.dataset.offsetX || '0');
	        const y = Number(panel.dataset.offsetY || '0');
	        return { x: Number.isFinite(x) ? x : 0, y: Number.isFinite(y) ? y : 0 };
	      };
	      const open = ()=>{
	        getInventoryColumnConfig();
	        const mobile = isMobileUx();
	        panel.classList.toggle('column-builder--centered', mobile);
	        if(mobile){
	          panel.dataset.offsetX = '0';
	          panel.dataset.offsetY = '0';
	          panel.style.transform = '';
	        }else{
	          const offset = getPanelOffset();
	          applyPanelOffset(offset.x, offset.y);
	        }
	        panel.classList.add('open');
	        panel.setAttribute('aria-hidden', 'false');
	        btn.setAttribute('aria-expanded', 'true');
	        syncTapUI();
	      };
	      const close = ()=>{
	        panel.classList.remove('open');
	        panel.setAttribute('aria-hidden', 'true');
	        btn.setAttribute('aria-expanded', 'false');
	      };

	      if(!btn._wired){
	        btn._wired = true;
	        btn.addEventListener('click', (e)=>{
	          e.preventDefault();
	          e.stopPropagation();
	          if(panel.classList.contains('open')) close();
	          else open();
	        });
	      }
	      if(closeBtn && !closeBtn._wired){
	        closeBtn._wired = true;
	        closeBtn.addEventListener('click', (e)=>{
	          e.preventDefault();
	          close();
	        });
	      }
	      if(dragHandle && !dragHandle._wired){
	        dragHandle._wired = true;
	        dragHandle.addEventListener('pointerdown', (e)=>{
	          if(!panel.classList.contains('open')) return;
	          if(panel.classList.contains('column-builder--centered')) return;
	          e.preventDefault();
	          const start = getPanelOffset();
	          const startX = e.clientX;
	          const startY = e.clientY;
	          panel.classList.add('dragging-panel');
	          const onMove = (ev)=>{
	            const nx = start.x + (ev.clientX - startX);
	            const ny = start.y + (ev.clientY - startY);
	            applyPanelOffset(nx, ny);
	          };
	          const onUp = ()=>{
	            panel.classList.remove('dragging-panel');
	            document.removeEventListener('pointermove', onMove);
	            document.removeEventListener('pointerup', onUp);
	          };
	          document.addEventListener('pointermove', onMove);
	          document.addEventListener('pointerup', onUp);
	        });
	      }
	      if(resetBtn && !resetBtn._wired){
	        resetBtn._wired = true;
	        resetBtn.addEventListener('click', (e)=>{
	          e.preventDefault();
	          saveInventoryColumnConfig({ order: defaultInventoryOrder(), visible: defaultInventoryVisibleKeys() });
	          getInventoryColumnConfig();
	          renderTable();
	          syncTapUI();
	        });
	      }
	      if(tapWrap && !tapWrap._wired){
	        tapWrap._wired = true;
	        tapWrap.addEventListener('change', (e)=>{
	          const target = e.target;
	          if(!target || !target.matches || !target.matches('input[name="rowTapPref"]')) return;
	          setInventoryRowTapPref(String(target.value || ''));
	        });
	      }
	      if(!list._wired){
	        list._wired = true;
	        const dragState = list._dragState || { key:null, overEl:null, lastTargetKey:null, lastAfter:null, initialOrder:null, dropped:false };
	        list._dragState = dragState;

	        const getListOrder = ()=> Array.from(list.querySelectorAll('.column-option'))
	          .map(el => el.getAttribute('data-col-key'))
	          .filter(Boolean);
	        const updateTablePreview = (order)=>{
	          const config = loadInventoryColumnConfig();
	          const nextOrder = normalizeInventoryOrder(order);
	          const previewConfig = { order: nextOrder, visible: config.visible };
	          const layout = getInventoryLayoutFromConfig(previewConfig, { force:true });
	          const columnDefs = layout.columnDefs;
	          renderInventoryTableShell(previewConfig);
	          renderTable(columnDefs, layout);
	        };
	        const clearDragStyles = ()=>{
	          list.querySelectorAll('.column-option.drag-over').forEach(el=> el.classList.remove('drag-over'));
	          list.querySelectorAll('.column-option.dragging').forEach(el=> el.classList.remove('dragging'));
	          dragState.overEl = null;
	        };
	        const capturePositions = ()=>{
	          const map = new Map();
	          list.querySelectorAll('.column-option').forEach(el=>{
	            map.set(el.dataset.colKey, el.getBoundingClientRect());
	          });
	          return map;
	        };
	        const animateReorder = (firstRects)=>{
	          requestAnimationFrame(()=>{
	            list.querySelectorAll('.column-option').forEach(el=>{
	              const first = firstRects.get(el.dataset.colKey);
	              if(!first) return;
	              const last = el.getBoundingClientRect();
	              const deltaY = first.top - last.top;
	              if(Math.abs(deltaY) < 1) return;
	              el.style.transform = `translateY(${deltaY}px)`;
	              el.style.transition = 'transform 0s';
	              requestAnimationFrame(()=>{
	                el.style.transition = '';
	                el.style.transform = '';
	              });
	            });
	          });
	        };
	        const moveDomItem = (dragKey, targetKey, insertAfter)=>{
	          const draggingEl = list.querySelector(`.column-option[data-col-key="${dragKey}"]`);
	          const targetEl = list.querySelector(`.column-option[data-col-key="${targetKey}"]`);
	          if(!draggingEl || !targetEl || draggingEl === targetEl) return false;
	          if(targetKey === INVENTORY_ANCHOR_KEY) insertAfter = true;
	          const firstRects = capturePositions();
	          if(insertAfter){
	            if(targetEl.nextSibling !== draggingEl) targetEl.after(draggingEl);
	          }else{
	            if(targetEl.previousSibling !== draggingEl) targetEl.before(draggingEl);
	          }
	          animateReorder(firstRects);
	          return true;
	        };

	        list.addEventListener('change', (e)=>{
	          const target = e.target;
	          if(!target || !target.matches || !target.matches('input[type="checkbox"][data-col-key]')) return;
	          const key = target.getAttribute('data-col-key');
	          if(!key) return;
	          const config = loadInventoryColumnConfig();
	          const visible = new Set(config.visible || []);
	          if(target.checked) visible.add(key); else visible.delete(key);
	          visible.add(INVENTORY_ANCHOR_KEY);
	          const next = {
	            order: config.order,
	            visible: normalizeInventoryVisible(Array.from(visible), config.order)
	          };
	          saveInventoryColumnConfig(next);
	          getInventoryColumnConfig();
	          renderTable();
	        });
	        list.addEventListener('dragstart', (e)=>{
	          const row = e.target && e.target.closest ? e.target.closest('.column-option') : null;
	          if(!row) return;
	          if(String(row.getAttribute('data-draggable') || '') !== 'true') return;
	          const key = row.getAttribute('data-col-key');
	          if(!key || key === INVENTORY_ANCHOR_KEY) return;
	          dragState.key = key;
	          dragState.initialOrder = getListOrder();
	          dragState.dropped = false;
	          dragState.lastTargetKey = null;
	          dragState.lastAfter = null;
	          row.classList.add('dragging');
	          if(e.dataTransfer){
	            e.dataTransfer.effectAllowed = 'move';
	            try{ e.dataTransfer.setData('text/plain', key); }catch(err){}
	            if(e.dataTransfer.setDragImage){
	              try{ e.dataTransfer.setDragImage(row, 16, 16); }catch(err){}
	            }
	          }
	        });
	        list.addEventListener('dragover', (e)=>{
	          if(!dragState.key) return;
	          const row = e.target && e.target.closest ? e.target.closest('.column-option') : null;
	          if(!row) return;
	          const targetKey = row.getAttribute('data-col-key');
	          if(!targetKey || targetKey === dragState.key) return;
	          e.preventDefault();
	          if(dragState.overEl && dragState.overEl !== row) dragState.overEl.classList.remove('drag-over');
	          dragState.overEl = row;
	          row.classList.add('drag-over');
	          const rect = row.getBoundingClientRect();
	          let after = e.clientY > rect.top + rect.height / 2;
	          if(targetKey === INVENTORY_ANCHOR_KEY) after = true;
	          if(dragState.lastTargetKey !== targetKey || dragState.lastAfter !== after){
	            dragState.lastTargetKey = targetKey;
	            dragState.lastAfter = after;
	            if(moveDomItem(dragState.key, targetKey, after)){
	              updateTablePreview(normalizeInventoryOrder(getListOrder()));
	            }
	          }
	          if(e.dataTransfer) e.dataTransfer.dropEffect = 'move';
	        });
	        list.addEventListener('dragleave', (e)=>{
	          const row = e.target && e.target.closest ? e.target.closest('.column-option') : null;
	          if(row && dragState.overEl === row){
	            row.classList.remove('drag-over');
	            dragState.overEl = null;
	          }
	        });
	        list.addEventListener('drop', (e)=>{
	          if(!dragState.key) return;
	          e.preventDefault();
	          // Save the current DOM order regardless of drop target
	          const config = loadInventoryColumnConfig();
	          const order = normalizeInventoryOrder(getListOrder());
	          saveInventoryColumnConfig({ order, visible: config.visible });
	          getInventoryColumnConfig();
	          const layout = getInventoryLayoutFromConfig({ order, visible: config.visible }, { force: true });
	          renderTable(layout.columnDefs, layout);
	          dragState.dropped = true;
	          clearDragStyles();
	          dragState.key = null;
	        });
	        list.addEventListener('dragend', ()=>{
	          clearDragStyles();
	          // Always save the current DOM order on dragend
	          const config = loadInventoryColumnConfig();
	          const order = normalizeInventoryOrder(getListOrder());
	          saveInventoryColumnConfig({ order, visible: config.visible });
	          const layout = getInventoryLayoutFromConfig({ order, visible: config.visible }, { force: true });
	          renderInventoryTableShell({ order, visible: config.visible });
	          renderTable(layout.columnDefs, layout);
	          dragState.key = null;
	        });
	      }

	      if(!initColumnBuilder._wired){
	        initColumnBuilder._wired = true;
	        document.addEventListener('click', (e)=>{
	          if(!panel.classList.contains('open')) return;
	          if(panel.contains(e.target) || btn.contains(e.target)) return;
	          close();
	        });
	        document.addEventListener('keydown', (e)=>{
	          if(e.key === 'Escape') close();
	        });
	      }
	    }

    function enableInlineEditing(){
      return;
      const tbody=$('#invTable').querySelector('tbody');
      const editableCols = new Set(['name','desc','qty']);
      tbody.querySelectorAll('td').forEach(td=>{
        if(td.classList.contains('sel')) return; // skip checkbox column
        const col = td.getAttribute('data-col');
        if(!editableCols.has(col)) return;
        td.addEventListener('click', (e)=> startCellEdit(td, e));
        td.addEventListener('dblclick', (e)=> startCellEdit(td, e));
      });
    }

    // Mobile-friendly modal editor (helps iOS cursor/precision issues)
    let _editItemCtx = null;
    let _lastEditHintPref = null;
    const _qtyCommit = new Map(); // id -> { timer, desiredQty, inFlight }
    const _qtyReposition = new Map(); // id -> timer for debounced row repositioning
    const _qtyLedSync = new Map(); // id -> timer for debounced low stock LED sync

    function isIOS(){
      try{
        const ua = navigator.userAgent || '';
        const platform = navigator.platform || '';
        return /iPad|iPhone|iPod/.test(ua) || (platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }catch(e){ return false; }
    }
    function prefersModalEditing(){
      try{
        if(isIOS()) return true;
        const hasTouch = ('ontouchstart' in window) || (navigator && navigator.maxTouchPoints > 0);
        if(!hasTouch) return false;
        return window.matchMedia && (
          window.matchMedia('(pointer: coarse)').matches ||
          window.matchMedia('(hover: none)').matches ||
          window.matchMedia('(max-width: 768px)').matches
        );
      }catch(e){ return false; }
    }
	    function setEditHint(){
	      const el = $('editHint');
	      if(!el) return;
	      if(SB.session && SB.authorized && !canUpdate()){
	        el.textContent = 'Read-only access.';
	        _lastEditHintPref = 'readonly';
	        return;
	      }
	      el.textContent = 'Use the pencil icon to edit item details.';
	      _lastEditHintPref = 'icon';
	    }

    function setEditItemMessage(msg){
      const el = $('editItemMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function closeEditItemModal(){
      _editItemCtx = null;
      setEditItemMessage('');
      show('editItemModal', false);
    }
	    function updateEditItemAvailability(){
	      const ctx = _editItemCtx;
	      if(!ctx || !ctx.id) return;
	      const it = state.items.find(x=> x.id===ctx.id);
	      if(!it) return;
	      const qtyInput = $('editItemQty');
	      const qtyVal = qtyInput ? toInt(qtyInput.value, toInt(it.qty,0)) : toInt(it.qty,0);
	      const reserved = getInventoryReservedQty(it);
	      const reservedNum = Number.isFinite(reserved) ? reserved : 0;
	      const reservedEl = $('editItemReserved');
	      const availableEl = $('editItemAvailable');
	      if(reservedEl) reservedEl.value = (reserved === null || typeof reserved === 'undefined') ? 'â€”' : formatQty(reserved);
	      if(availableEl) availableEl.value = formatQty(Math.max(0, qtyVal - reservedNum));
	    }
	    const DEFAULT_UOM_OPTIONS = ['Each','Box','Case','Pack','Pallet','Set','Pair','Roll','Foot','Meter'];
	    function renderEditItemUomOptions(selected){
	      const select = $('editItemUom');
	      if(!select) return;
	      const values = new Set(DEFAULT_UOM_OPTIONS);
	      (state.items || []).forEach(it=>{
	        const val = String(it.unitOfMeasure || '').trim();
	        if(val) values.add(val);
	      });
	      const current = String(selected || '').trim();
	      const sorted = Array.from(values.values()).sort((a,b)=> a.localeCompare(b));
	      select.innerHTML = `<option value="">Unspecified</option>` + sorted.map(val => (
	        `<option value="${escapeHtmlAttr(val)}">${escapeHtml(val)}</option>`
	      )).join('');
	      if(current && !values.has(current)){
	        const opt = document.createElement('option');
	        opt.value = current;
	        opt.textContent = current;
	        opt.selected = true;
	        select.appendChild(opt);
	      }
	      select.value = current || '';
	    }
	    function renderEditItemLocationOptions(selectedId){
	      const select = $('editItemLocation');
	      if(!select) return;
	      const current = String(selectedId || '').trim();
	      const rows = Array.isArray(state._companyLocations) ? state._companyLocations : [];
	      const active = rows.filter(r => r && r.is_active);
	      select.innerHTML = `<option value="">Unassigned</option>` + active.map(row => (
	        `<option value="${escapeHtmlAttr(String(row.id || ''))}">${escapeHtml(String(row.name || 'Location'))}</option>`
	      )).join('');
	      if(current && !active.some(row => String(row.id || '') === current)){
	        const opt = document.createElement('option');
	        opt.value = current;
	        opt.textContent = current;
	        opt.selected = true;
	        select.appendChild(opt);
	      }
	      select.value = current || '';
	    }
	    function renderEditItemCategoryOptions(selectedId){
	      const input = $('editItemCategory');
	      const list = $('editItemCategoryList');
	      if(!input || !list) return;
	      const current = String(selectedId || '').trim();
	      const values = new Set();
	      (state.items || []).forEach(it=>{
	        const val = String(it.categoryId || '').trim();
	        if(val) values.add(val);
	      });
	      const sorted = Array.from(values.values()).sort((a,b)=> a.localeCompare(b));
	      list.innerHTML = sorted.map(val => `<option value="${escapeHtmlAttr(val)}"></option>`).join('');
	      input.value = current;
	    }
	    async function ensureEditItemLookups(selectedLocationId, selectedCategoryId, selectedUom){
	      renderEditItemUomOptions(selectedUom);
	      renderEditItemCategoryOptions(selectedCategoryId);
	      renderEditItemLocationOptions(selectedLocationId);
	      if((state._companyLocations || []).length) return;
	      try{
	        await loadCompanyLocations();
	      }catch(e){}
	      renderEditItemLocationOptions(selectedLocationId);
	    }
	    function openEditItemModal(id){
	      if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
	      const it = state.items.find(x=> x.id===id); if(!it) return;
	      _editItemCtx = { id };

	      const name = $('editItemName'); if(name) name.value = String(it.name||'');
	      const sku = $('editItemSku'); if(sku) sku.value = String(it.sku||'');
	      const desc = $('editItemDesc'); if(desc) desc.value = String(it.desc||'');
		      const qty  = $('editItemQty');  if(qty)  qty.value  = String(toInt(it.qty,0));
		      const globalLowStock = getGlobalLowStockQty();
		      const lowStockOverride = getItemLowStockQtyOverride(it);
		      const reorderPointValue = (Object.prototype.hasOwnProperty.call(it, 'reorderPoint') && it.reorderPoint !== null && typeof it.reorderPoint !== 'undefined')
		        ? it.reorderPoint
		        : lowStockOverride;
		      const lowStockQty = $('editLowStockQty');
		      if(lowStockQty) lowStockQty.value = (reorderPointValue === null) ? '' : String(reorderPointValue);
		      const btnUseGlobal = $('btnEditUseGlobal');
		      if(btnUseGlobal) btnUseGlobal.textContent = `Use Global (${globalLowStock})`;
		      const reorderQty = $('editItemReorderQty');
		      if(reorderQty) reorderQty.value = (it.reorderQty === null || typeof it.reorderQty === 'undefined') ? '' : String(toInt(it.reorderQty,0));
		      const uomValue = String(it.unitOfMeasure || '').trim();
		      const locationId = String(it.locationId || '').trim();
		      const categoryId = String(it.categoryId || '').trim();
		      void ensureEditItemLookups(locationId, categoryId, uomValue);
		      const reorderEnabled = $('editReorderEnabled');
		      if(reorderEnabled) reorderEnabled.checked = getItemReorderEnabled(it);
		      updateEditItemAvailability();

	      setEditItemMessage('');
	      show('editItemModal', true);
	      setTimeout(()=>{
	        const inp = $('editItemName');
        if(!inp) return;
        inp.focus();
        try{ inp.select(); }catch(e){}
      }, 0);
    }
	    function bumpEditItemQty(delta){
	      const inp = $('editItemQty'); if(!inp) return;
	      const q = toInt(inp.value, 0);
	      const nv = Math.max(0, q + toSignedInt(delta, 0));
	      inp.value = String(nv);
	      updateEditItemAvailability();
	    }
	    function bumpEditItemLowStockQty(delta){
	      const inp = $('editLowStockQty'); if(!inp) return;
	      const global = getGlobalLowStockQty();
	      const curRaw = String(inp.value ?? '').trim();
	      const cur = (curRaw === '') ? global : toInt(curRaw, 0);
	      const step = toSignedInt(delta, 0);
	      const nv = Math.max(0, cur + step);
	      inp.value = String(nv);
	      try{ inp.focus(); }catch(e){}
	    }
	    function bumpEditItemReorderQty(delta){
	      const inp = $('editItemReorderQty'); if(!inp) return;
	      const curRaw = String(inp.value ?? '').trim();
	      const cur = (curRaw === '') ? 0 : toInt(curRaw, 0);
	      const step = toSignedInt(delta, 0);
	      const nv = Math.max(0, cur + step);
	      inp.value = String(nv);
	      try{ inp.focus(); }catch(e){}
	    }

    async function commitItemUpdate(id, updates){
      const it = state.items.find(x=> x.id===id);
      if(!it) throw Error('Item not found');

      const fields = {};
      if(updates && 'name' in updates){
        const nv = String(updates.name||'').trim();
        if(!nv) throw Error('Name required');
        const prev = String(it.name||'');
        if(nv !== prev){
          if(toKey(nv)!==toKey(prev) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))) throw Error('Duplicate name');
          fields.name = nv;
        }
      }
      if(updates && 'desc' in updates){
        const nv = String(updates.desc||'').replace(/[\r\n]+/g,' ').trim();
        const prev = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
        if(nv !== prev) fields.desc = nv;
      }
      if(updates && 'sku' in updates){
        const nv = String(updates.sku||'').trim();
        const prev = String(it.sku||'').trim();
        if(nv !== prev) fields.sku = nv;
      }
      if(updates && 'unitOfMeasure' in updates){
        const nv = String(updates.unitOfMeasure||'').trim();
        const prev = String(it.unitOfMeasure||'').trim();
        if(nv !== prev) fields.unitOfMeasure = nv;
      }
      if(updates && 'locationId' in updates){
        const nv = String(updates.locationId||'').trim();
        const prev = String(it.locationId||'').trim();
        if(nv !== prev) fields.locationId = nv;
      }
      if(updates && 'categoryId' in updates){
        const nv = String(updates.categoryId||'').trim();
        const prev = String(it.categoryId||'').trim();
        if(nv !== prev) fields.categoryId = nv;
      }
	      if(updates && 'qty' in updates){
	        const q = toInt(updates.qty, -1); if(q < 0) throw Error('Qty must be integer â‰¥ 0');
	        const prev = toInt(it.qty, 0);
	        if(q !== prev) fields.qty = q;
	      }
	      if(updates && 'reorderPoint' in updates){
	        const raw = updates.reorderPoint;
	        let next = null;
	        if(!(raw === null || typeof raw === 'undefined' || String(raw).trim() === '')){
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Reorder point must be integer â‰¥ 0');
	          next = v;
	        }
	        const prev = Object.prototype.hasOwnProperty.call(it, 'reorderPoint') ? it.reorderPoint : null;
	        if(next !== prev) fields.reorderPoint = next;
	      }
	      if(updates && 'reorderQty' in updates){
	        const raw = updates.reorderQty;
	        let next = null;
	        if(!(raw === null || typeof raw === 'undefined' || String(raw).trim() === '')){
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Reorder qty must be integer â‰¥ 0');
	          next = v;
	        }
	        const prev = Object.prototype.hasOwnProperty.call(it, 'reorderQty') ? it.reorderQty : null;
	        if(next !== prev) fields.reorderQty = next;
	      }
	      if(updates && 'reorderEnabled' in updates){
	        const nv = !!updates.reorderEnabled;
	        const prev = getItemReorderEnabled(it);
	        if(nv !== prev) fields.reorderEnabled = nv;
	      }
	      if(updates && 'lowStockQty' in updates){
	        const raw = updates.lowStockQty;
	        let next = null;
	        if(!(raw === null || typeof raw === 'undefined' || String(raw).trim() === '')){
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Low stock qty must be integer â‰¥ 0');
	          next = v;
	        }
	        const prev = getItemLowStockQtyOverride(it);
	        if(next !== prev) fields.lowStockQty = next;
	      }

	      if(Object.keys(fields).length === 0) return;
	      await sbUpdateFields(id, fields);
	      await sbLoadSnapshot();
	    }
    async function commitItemField(id, col, rawValue){
      if(col==='name') return commitItemUpdate(id, { name: rawValue });
      if(col==='desc') return commitItemUpdate(id, { desc: rawValue });
      if(col==='qty')  return commitItemUpdate(id, { qty: rawValue });
      throw Error('Unknown field');
    }

	    async function autoSaveEditItem(){
	      if(!_editItemCtx) return false;
	      const modal = $('editItemModal');
	      if(!modal || modal.getAttribute('aria-hidden') === 'true') return false;
	      if(!requireOnline()) return false;

	      const id = _editItemCtx.id;
	      const name = $('editItemName') ? $('editItemName').value : '';
	      const sku = $('editItemSku') ? $('editItemSku').value : '';
	      const desc = $('editItemDesc') ? $('editItemDesc').value : '';
	      const unitOfMeasure = $('editItemUom') ? $('editItemUom').value : '';
	      const locationId = $('editItemLocation') ? $('editItemLocation').value : '';
	      const categoryId = $('editItemCategory') ? $('editItemCategory').value : '';
	      const qty  = $('editItemQty')  ? $('editItemQty').value  : '';
	      const lowStockQty = $('editLowStockQty') ? $('editLowStockQty').value : '';
	      const reorderQty = $('editItemReorderQty') ? $('editItemReorderQty').value : '';
	      const reorderEnabled = $('editReorderEnabled') ? $('editReorderEnabled').checked : true;

	      const btnCancel = $('btnEditItemCancel');
	      if(btnCancel) btnCancel.disabled = true;
	      setEditItemMessage('');

	      try{
	        await commitItemUpdate(id, { name, sku, desc, unitOfMeasure, locationId, categoryId, qty, lowStockQty, reorderPoint: lowStockQty, reorderQty, reorderEnabled });
	        try{ syncLowStockOverrideIndicatorForRow(id); }catch(e){}
	        try{ syncLowStockIndicatorForRow(id); }catch(e){}
	        toast('Auto-saved');
	        return true;
	      }catch(e){
	        const msg = (e && e.message) ? e.message : 'Update failed';
	        setEditItemMessage(msg);
	        toast(msg);
	        return false;
      }finally{
        if(btnCancel) btnCancel.disabled = false;
	      }
	    }
	    let _editItemAutoSaveTimer = null;
	    function scheduleEditItemAutoSave(){
	      if(_editItemAutoSaveTimer) clearTimeout(_editItemAutoSaveTimer);
	      _editItemAutoSaveTimer = setTimeout(()=> autoSaveEditItem(), 600);
	    }
	
	    async function deleteEditItemModal(){
	      if(!_editItemCtx) return;
	      if(!requireOnline()) return;
	      if(!requirePermission(PERMISSIONS.ITEMS_DELETE, 'Delete not allowed')) return;

	      const id = _editItemCtx.id;
	      const item = state.items.find(x=> x && x.id === id);
	      const itemName = item && item.name ? String(item.name) : 'this item';
	      if(!(await openConfirmModal('Delete item?', `Delete "${itemName}"?`, { okText:'Delete', cancelText:'Cancel' }))) return;

	      const btnDelete = $('btnEditItemDelete');
	      const btnCancel = $('btnEditItemCancel');
	      if(btnDelete) btnDelete.disabled = true;
	      if(btnCancel) btnCancel.disabled = true;
	      setEditItemMessage('');
	
	      try{
	        await sbDeleteMany([id]);
	        try{ removeOrderLine(id); }catch(e){}
	        await sbLoadSnapshot();
	        closeEditItemModal();
	        toast('Item deleted');
	      }catch(e){
	        const msg = (e && e.message) ? e.message : 'Delete failed';
	        setEditItemMessage(msg);
	        toast(msg);
	      }finally{
	        if(btnDelete) btnDelete.disabled = false;
	        if(btnCancel) btnCancel.disabled = false;
	      }
	    }

	    // Modal editor events
	    const btnEditItemDelete = $('btnEditItemDelete');
	    if(btnEditItemDelete) btnEditItemDelete.addEventListener('click', deleteEditItemModal);
	    const btnEditItemCancel = $('btnEditItemCancel');
	    if(btnEditItemCancel) btnEditItemCancel.addEventListener('click', closeEditItemModal);
	    // Auto-save listeners for edit item modal
		    ['editItemName','editItemSku','editItemDesc','editItemQty','editLowStockQty','editItemReorderQty','editItemUom','editItemLocation','editItemCategory'].forEach(id=>{
		      const el = $(id);
		      if(el){
		        el.addEventListener('blur', scheduleEditItemAutoSave);
		        el.addEventListener('change', scheduleEditItemAutoSave);
		      }
		    });
	    const btnQtyMinus = $('editItemQtyMinus');
	    if(btnQtyMinus) btnQtyMinus.addEventListener('click', ()=> { bumpEditItemQty(-1); scheduleEditItemAutoSave(); });
	    const btnQtyPlus = $('editItemQtyPlus');
	    if(btnQtyPlus) btnQtyPlus.addEventListener('click', ()=> { bumpEditItemQty(1); scheduleEditItemAutoSave(); });
	    const btnLowStockMinus = $('editLowStockMinus');
	    if(btnLowStockMinus) btnLowStockMinus.addEventListener('click', ()=> { bumpEditItemLowStockQty(-1); scheduleEditItemAutoSave(); });
	    const btnLowStockPlus = $('editLowStockPlus');
	    if(btnLowStockPlus) btnLowStockPlus.addEventListener('click', ()=> { bumpEditItemLowStockQty(1); scheduleEditItemAutoSave(); });
	    const btnReorderQtyMinus = $('editItemReorderQtyMinus');
	    if(btnReorderQtyMinus) btnReorderQtyMinus.addEventListener('click', ()=> { bumpEditItemReorderQty(-1); scheduleEditItemAutoSave(); });
	    const btnReorderQtyPlus = $('editItemReorderQtyPlus');
	    if(btnReorderQtyPlus) btnReorderQtyPlus.addEventListener('click', ()=> { bumpEditItemReorderQty(1); scheduleEditItemAutoSave(); });
	    const btnEditUseGlobal = $('btnEditUseGlobal');
	    if(btnEditUseGlobal) btnEditUseGlobal.addEventListener('click', ()=>{
	      const inp = $('editLowStockQty');
	      if(inp){
	        inp.value = '';
	        try{ inp.focus(); }catch(e){}
	      }
	      scheduleEditItemAutoSave();
	    });
	    const editReorderEnabled = $('editReorderEnabled');
	    if(editReorderEnabled) editReorderEnabled.addEventListener('change', scheduleEditItemAutoSave);

    const editItemName = $('editItemName');
    if(editItemName) editItemName.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
      if(e.key==='Enter'){
        // On mobile, Enter often means "Done" â€” move to description instead of saving.
        e.preventDefault();
        $('editItemDesc')?.focus();
      }
    });
	    const editItemQty = $('editItemQty');
	    if(editItemQty) editItemQty.addEventListener('keydown', e=>{
	      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
	      if(e.key==='Enter'){ e.preventDefault(); autoSaveEditItem().then(ok=> { if(ok) closeEditItemModal(); }); }
	    });
	    const btnEditItemDone = $('btnEditItemDone');
	    if(btnEditItemDone) btnEditItemDone.addEventListener('click', async ()=>{
	      const ok = await autoSaveEditItem();
	      if(ok) closeEditItemModal();
	    });
	    if(editItemQty) editItemQty.addEventListener('input', updateEditItemAvailability);
	    if(editItemQty) editItemQty.addEventListener('click', async (e)=>{
	      if(!isMobileUx()) return;
	      if(!requireOnline()) return;
	      e.preventDefault();
	      e.stopPropagation();

	      const id = _editItemCtx && _editItemCtx.id ? String(_editItemCtx.id) : '';
	      const it = id ? state.items.find(x => x && x.id === id) : null;
	      const itemName = it ? String(it.name || '').trim() : '';
	      const oldQty = toInt(editItemQty.value, 0);
	      const next = await openQtyEntryModal('Set Qty', itemName || 'Inventory Qty', oldQty, { min:0, okText:'Save', cancelText:'Cancel' });
	      if(next === null || typeof next === 'undefined') return;
	      const newQty = Math.max(0, toInt(next, oldQty));
	      if(newQty === oldQty) return;
	      editItemQty.value = String(newQty);
	      updateEditItemAvailability();
	      scheduleEditItemAutoSave();
	    });
	    const editLowStockQty = $('editLowStockQty');
	    if(editLowStockQty) editLowStockQty.addEventListener('keydown', e=>{
	      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
	      if(e.key==='Enter'){ e.preventDefault(); autoSaveEditItem().then(()=> closeEditItemModal()); }
	    });
	    if(editLowStockQty) editLowStockQty.addEventListener('click', async (e)=>{
	      if(!isMobileUx()) return;
	      if(!requireOnline()) return;
	      e.preventDefault();
	      e.stopPropagation();

	      const id = _editItemCtx && _editItemCtx.id ? String(_editItemCtx.id) : '';
	      const it = id ? state.items.find(x => x && x.id === id) : null;
	      const itemName = it ? String(it.name || '').trim() : '';
	      const globalQty = getGlobalLowStockQty();
	      const curRaw = String(editLowStockQty.value ?? '').trim();
	      const oldQty = (curRaw === '') ? globalQty : toInt(curRaw, 0);
	      const next = await openQtyEntryModal('Low Stock Threshold', itemName || 'Low Stock Threshold', oldQty, { min:0, okText:'Save', cancelText:'Cancel' });
	      if(next === null || typeof next === 'undefined') return;
	      const newQty = Math.max(0, toInt(next, oldQty));
	      if(newQty === oldQty) return;
	      editLowStockQty.value = (newQty === globalQty) ? '' : String(newQty);
	      scheduleEditItemAutoSave();
	    });
		    const editItemDesc = $('editItemDesc');
		    if(editItemDesc) editItemDesc.addEventListener('keydown', e=>{
		      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
		      if((e.key==='Enter' || e.key==='NumpadEnter') && (e.metaKey || e.ctrlKey)){
		        e.preventDefault(); autoSaveEditItem().then(()=> closeEditItemModal());
		      }
		    });
	
	    // Table Qty +/- (mobile): optimistic UI + debounced commit
	    function toSignedInt(v, f=0){
	      const n = Number(v);
      if(!Number.isFinite(n)) return f;
      return Math.trunc(n);
    }
			    function adjustDisplayedTotalQty(delta){
			      const cur = getTotalsValue('totalQty');
			      if(cur === null) return;
			      setTotalsMetric('totalQty', 'qty', Math.max(0, cur + toSignedInt(delta,0)));
			    }
				    function adjustDisplayedInStock(prevQty, nextQty){
				      const cur = getTotalsValue('totalInStock');
				      if(cur === null) return;
				      const was = toInt(prevQty, 0) > 0;
				      const now = toInt(nextQty, 0) > 0;
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalInStock', 'inStock', Math.max(0, cur + delta));
				    }
				    function adjustDisplayedLowStock(item, prevQty, nextQty){
				      const cur = getTotalsValue('totalLowStock');
				      if(cur === null) return;
				      const thr = effectiveLowStockQty(item);
				      const was = toInt(prevQty, 0) <= thr;
				      const now = toInt(nextQty, 0) <= thr;
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalLowStock', 'lowStock', Math.max(0, cur + delta));
				    }
				    function adjustDisplayedLowStockThreshold(item, prevThr, nextThr){
				      const cur = getTotalsValue('totalLowStock');
				      if(cur === null) return;
				      const qty = toInt(item && item.qty, 0);
				      const was = qty <= toInt(prevThr, 0);
				      const now = qty <= toInt(nextThr, 0);
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalLowStock', 'lowStock', Math.max(0, cur + delta));
				    }
			    function updateQtyCellUIForRow(id, qty){
			      const tr = rowElById(id);
			      const nextVal = String(toInt(qty,0));
			      const val = tr ? tr.querySelector('td[data-col="qty"] .cell-val, td[data-col="qty"] .qty-value') : null;
			      if(val) val.textContent = nextVal;
			      refreshInventoryRowColumns(id);
			    }
    function refreshInventoryRowColumns(id){
      const tr = rowElById(id);
      if(!tr) return;
      const it = state.items.find(x=> x && x.id === id);
      if(!it) return;
      const columnDefs = Array.isArray(_inventoryActiveColumns) ? _inventoryActiveColumns : getInventoryVisibleColumnDefs();
      columnDefs.forEach(def=>{
        if(!def) return;
        const col = def.dataCol || def.key;
        const td = tr.querySelector(`td[data-col="${col}"]`);
        if(!td) return;
        td.innerHTML = buildInventoryColumnCellInner(it, def, { id: String(id || ''), canEdit: canItemsEdit(), allowInlineEdit: canItemsEdit() && !isMobileUx() });
      });
      const detailRow = document.querySelector(`tr.inv-detail-row[data-detail-id="${CSS.escape(String(id || ''))}"]`);
      if(detailRow){
        const layout = getInventoryLayout();
        const incomingMap = (state._incomingByItemId && typeof state._incomingByItemId.get === 'function')
          ? state._incomingByItemId
          : buildInventoryIncomingMap();
        state._incomingByItemId = incomingMap;
        detailRow.innerHTML = buildInventoryDetailRow(it, layout, incomingMap);
      }
    }
    function repositionRowByQtyNow(id){
      const srt = getSort();
      if(!srt || srt.col !== 'qty') return;
      const tb = tbodyEl(); if(!tb) return;
      const tr = rowElById(id); if(!tr) return;
      const it = state.items.find(x=> x.id===id); if(!it) return;
      const myQty = toInt(it.qty,0);
      const myName = toKey(it.name||'');
      const desc = (srt.dir === 'desc');
      const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
      let anchor = null;
      for(const r of others){
        const rid = r.dataset.id;
        const o = state.items.find(x=> x.id===rid);
        if(!o) continue;
        const oq = toInt(o.qty,0);
        const on = toKey(o.name||'');
        if(desc){
          if(oq < myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }else{
          if(oq > myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }
      }
      if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
    }
    // Debounced version - waits for user to stop clicking before repositioning
    function repositionRowByQty(id){
      const existing = _qtyReposition.get(id);
      if(existing) clearTimeout(existing);
      _qtyReposition.set(id, setTimeout(()=> {
        _qtyReposition.delete(id);
        repositionRowByQtyNow(id);
      }, 350));
    }
    function queueQtyCommit(id, desiredQty){
      if(!id) return;
      const q = toInt(desiredQty, 0);
      let entry = _qtyCommit.get(id);
      if(!entry){
        entry = { timer:null, desiredQty:q, inFlight:false };
        _qtyCommit.set(id, entry);
      }
      entry.desiredQty = q;
      if(entry.timer) clearTimeout(entry.timer);
      entry.timer = setTimeout(()=> flushQtyCommit(id), 400);
    }
    async function flushQtyCommit(id){
      const entry = _qtyCommit.get(id);
      if(!entry) return;
      entry.timer = null;
      if(entry.inFlight) return;
      entry.inFlight = true;
      const qtyToSend = entry.desiredQty;
      try{
        await sbUpdateFields(id, { qty: qtyToSend });
      }catch(e){
        toast((e && e.message) ? e.message : 'Qty update failed');
        try{ await sbLoadSnapshot(); }catch{}
      }finally{
        entry.inFlight = false;
        if(entry.desiredQty !== qtyToSend){
          queueQtyCommit(id, entry.desiredQty);
        }
      }
    }

		    const invTable = $('invTable');
		    const tableWrap = $('tableWrap');
		    if(tableWrap){
		      tableWrap.addEventListener('scroll', ()=>{
		        if(!isMobileUx()) return;
		        collapseExpandedCard();
		      }, { passive:true });
		    }
		    if(invTable){

	      // Mobile UX v2: tray actions (Order / Add to Job / Edit / Delete)
		      invTable.addEventListener('click', (e)=>{
	        const trayBtn = e.target.closest('button.card-tray-btn');
	        if(!trayBtn) return;
	        const tr = trayBtn.closest('tr[data-id]');
	        const id = tr && tr.dataset ? String(tr.dataset.id || '').trim() : '';
	        const action = trayBtn.dataset ? String(trayBtn.dataset.trayAction || '').trim() : '';
	        if(!id || !action) return;
	        e.preventDefault();
	        e.stopPropagation();
	        closeMobileTray();
	        if(action === 'order'){
	          if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
	          toggleOrderLineForItemId(id);
	          return;
	        }
	        if(!requireOnline()) return;
	        if(action === 'job'){
	          openAddToJobModal(id);
	          return;
	        }
	        if(action === 'edit'){
	          if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
	          openEditItemModal(id);
	          return;
	        }
        if(action === 'delete'){
          handleInventoryDeleteAction(id);
          return;
        }
		      });

      // Expanded detail panel actions
      invTable.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-detail-action]');
        if(!btn) return;
        const id = String(btn.dataset.id || '').trim();
        const action = String(btn.dataset.detailAction || '').trim();
        if(!id || !action) return;
        e.preventDefault();
        e.stopPropagation();
        if(action === 'order'){
          if(!canOrdersCreate() || !isInventoryActionVisible('order_item')) return;
          toggleOrderLineForItemId(id);
          return;
        }
        if(action === 'job'){
          if(!isInventoryActionVisible('add_to_job')) return;
          openAddToJobModal(id);
          return;
        }
        if(action === 'edit'){
          if(!isInventoryActionVisible('edit_item') || !canItemsEdit()) return;
          openEditItemModal(id);
          return;
        }
      });

	      // Mobile UX v2: tap to expand qty + swipe trays (edit/order)
	      let _mobGesture = null;
      function resetMobGesture(){ _mobGesture = null; }
      function isAnyModalOpen(){
        try{ return !!document.querySelector('.modal-backdrop[aria-hidden="false"]'); }catch(e){ return false; }
      }
      function findTouchById(list, id){
        try{
          for(let i=0;i<list.length;i++){
            const t = list[i];
            if(t && t.identifier === id) return t;
          }
        }catch(e){}
        return null;
      }

      invTable.addEventListener('pointerdown', (e)=>{
        if(!isMobileUx()) return;
        if(e && e.pointerType === 'touch') return; // prefer touch events for broader mobile compatibility
        if(isAnyModalOpen()) return;

	        // If a tray is open, the first touch/pointer down on a different row just closes it.
		        if(_openTrayId){
		          const openTr = rowElById(_openTrayId);
		          if(openTr){
		            const sameRow = !!(e.target.closest('tr[data-id]') === openTr);
		            // Allow re-swiping/tapping the open row even though the tray overlay covers the card;
		            // only ignore direct presses on tray buttons so normal button clicks still work.
		            if(sameRow && e.target.closest('button.card-tray-btn')) return;
		            if(!sameRow){ closeMobileTray(); return; }
		          }
		          // Stale tray state (row re-rendered)
		          else closeMobileTray();
		        }

        const tr = e.target.closest('tr[data-id]');
        if(!tr) return;
        const id = String(tr.dataset.id || '').trim();
        if(!id) return;

        // Ignore gestures starting from any other interactive control.
        if(e.target.closest('button, input, textarea, select, a')) return;

        const now = performance.now();
        const startSwipeX = getRowSwipeX(tr);
        const startSide = (startSwipeX < 0) ? 'right' : ((startSwipeX > 0) ? 'left' : null);
        _mobGesture = {
          id,
          tr,
          kind: 'pointer',
          pointerId: e.pointerId,
          startX: e.clientX,
          startY: e.clientY,
          startTime: now,
          prevMoveTime: now,
          lastMoveTime: now,
          prevMoveClientX: e.clientX,
          lastMoveClientX: e.clientX,
          startSwipeX,
          swipeX: startSwipeX,
          moved: false,
          intent: null, // 'h' | 'v'
          side: startSide, // 'left' | 'right'
        };
        try{ tr.setPointerCapture(e.pointerId); }catch(e){}
      }, { passive:true });

      invTable.addEventListener('pointermove', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'pointer') return;
        if(e.pointerId !== _mobGesture.pointerId) return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }

        const dx = e.clientX - _mobGesture.startX;
        const dy = e.clientY - _mobGesture.startY;
        const ax = Math.abs(dx);
	        const ay = Math.abs(dy);

	        // Any meaningful movement cancels a "tap".
	        if(ax >= 10 || ay >= 10) _mobGesture.moved = true;

        if(!_mobGesture.intent){
          if(ax < 10 && ay < 10) return;
          _mobGesture.intent = (ax >= ay) ? 'h' : 'v';
          if(_mobGesture.intent === 'v'){ resetMobGesture(); return; }
        }
        if(_mobGesture.intent !== 'h') return;

        const now = performance.now();
        _mobGesture.prevMoveTime = _mobGesture.lastMoveTime;
        _mobGesture.prevMoveClientX = _mobGesture.lastMoveClientX;
        _mobGesture.lastMoveTime = now;
        _mobGesture.lastMoveClientX = e.clientX;

        const tr = _mobGesture.tr;
        if(!tr || !tr.isConnected){ resetMobGesture(); return; }

        // Elastic resistance when swiping back from detent toward origin
        const startAx = Math.abs(_mobGesture.startSwipeX);
        const startSide = traySideFromSwipeX(_mobGesture.startSwipeX);
        const startSnapPx = traySnapPxForSide(startSide);
        const isAtDetent = startAx >= startSnapPx - 10;
        const isSwipingBack = (_mobGesture.startSwipeX < 0 && dx > 0) || (_mobGesture.startSwipeX > 0 && dx < 0);

        let nextX;
        if(isAtDetent && isSwipingBack){
          // Apply damping for sticky/elastic feel (0.35x movement)
          const dampedDx = dx * 0.35;
          nextX = clampNum(_mobGesture.startSwipeX + dampedDx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = true;
        }else{
          nextX = clampNum(_mobGesture.startSwipeX + dx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = false;
        }
        _mobGesture.swipeX = nextX;

        let side = _mobGesture.side;
        if(Math.abs(nextX) > 6) side = (nextX < 0) ? 'right' : 'left';
        else if(!side) side = (dx < 0) ? 'right' : 'left';
        _mobGesture.side = side || 'left';

        prepareMobileTrayForRow(tr, _mobGesture.side);
        tr.classList.add('swiping');
        setRowSwipeX(tr, nextX);
      }, { passive:true });

      invTable.addEventListener('pointerup', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'pointer') return;
        if(e.pointerId !== _mobGesture.pointerId) return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }

        const { id, tr, moved, intent, swipeX, startTime, startX, prevMoveTime, lastMoveTime, prevMoveClientX, lastMoveClientX, closingFromDetent } = _mobGesture;
        resetMobGesture();
        if(!id || !tr) return;

	        if(!moved){
	          if(_openTrayId === id && tr.classList.contains('tray-open')){
	            closeMobileTrayElastic(tr);
	            return;
	          }
	          handleInventoryRowTap(id);
	          return;
	        }

        if(intent === 'h'){
          tr.classList.remove('swiping');
          const finalX = Number.isFinite(swipeX) ? swipeX : getRowSwipeX(tr);
          const ax = Math.abs(finalX);
          const side = (finalX < 0) ? 'right' : 'left';

          // If user was swiping back from detent, always snap back with elastic animation
          if(closingFromDetent){
            closeMobileTrayElastic(tr);
            return;
          }

          let vx = 0;
          try{
            if(Number.isFinite(lastMoveTime) && Number.isFinite(prevMoveTime) && lastMoveTime > prevMoveTime){
              const dt = lastMoveTime - prevMoveTime;
              vx = dt > 0 ? (lastMoveClientX - prevMoveClientX) / dt : 0;
            }else{
              const tNow = performance.now();
              const dt = tNow - (Number(startTime) || tNow);
              vx = dt > 0 ? (e.clientX - startX) / dt : 0;
            }
          }catch(e){ vx = 0; }

		          const canCommitEdit = trayHasActionsForSide('right') && isInventoryActionVisible('edit_item');
		          const shouldCommitEdit = canCommitEdit && (side === 'right') && (ax >= COMMIT_PX);
		          if(shouldCommitEdit){
		            closeMobileTray();
		            if(!requireOnline()) return;
		            if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
		            openEditItemModal(id);
		            return;
		          }
		          const canCommitOrder = trayHasActionsForSide('left') && isInventoryActionVisible('order_item');
		          const shouldCommitOrder = canCommitOrder && (side === 'left') && (ax >= COMMIT_PX);
		          if(shouldCommitOrder){
		            closeMobileTray();
		            if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		            toggleOrderLineForItemId(id);
		            return;
		          }

		          if(!trayHasActionsForSide(side)){
		            closeMobileTray();
		            return;
		          }
		          const fastOpen = (side === 'right') ? (vx <= -0.55) : (vx >= 0.55);
		          const fastClose = (side === 'right') ? (vx >= 0.55) : (vx <= -0.55);
		          const snapPx = traySnapPxForSide(side);
		          if(fastClose && ax < COMMIT_PX){
	            closeMobileTray();
	          }else if(ax >= snapPx || (ax >= REVEAL_PX && fastOpen)){
	            openMobileTrayForRow(tr, side);
	          }else{
	            closeMobileTray();
          }
        }
      }, { passive:true });

      invTable.addEventListener('pointercancel', ()=>{
        if(!isMobileUx()) return;
        try{ if(_mobGesture && _mobGesture.tr) _mobGesture.tr.classList.remove('swiping'); }catch(e){}
        try{ closeMobileTray(); }catch(e){}
        resetMobGesture();
      }, { passive:true });

      invTable.addEventListener('touchstart', (e)=>{
        if(!isMobileUx()) return;
        if(isAnyModalOpen()) return;
        if(!e || !e.target) return;

	        // If a tray is open, the first touch on a different row just closes it.
		        if(_openTrayId){
		          const openTr = rowElById(_openTrayId);
		          if(openTr){
		            const sameRow = !!(e.target.closest('tr[data-id]') === openTr);
		            // Allow re-swiping/tapping the open row even though the tray overlay covers the card;
		            // only ignore direct taps on tray buttons so normal button clicks still work.
		            if(sameRow && e.target.closest('button.card-tray-btn')) return;
		            if(!sameRow){ closeMobileTray(); return; }
		          }
		          else closeMobileTray();
		        }

        const tr = e.target.closest('tr[data-id]');
        if(!tr) return;
        const id = String(tr.dataset.id || '').trim();
        if(!id) return;

        // Ignore gestures starting from any other interactive control.
        if(e.target.closest('button, input, textarea, select, a')) return;

        const t = (e.touches && e.touches[0]) ? e.touches[0] : null;
        if(!t) return;
        const now = performance.now();
        const startSwipeX = getRowSwipeX(tr);
        const startSide = (startSwipeX < 0) ? 'right' : ((startSwipeX > 0) ? 'left' : null);
        _mobGesture = {
          id,
          tr,
          kind: 'touch',
          touchId: t.identifier,
          startX: t.clientX,
          startY: t.clientY,
          startTime: now,
          prevMoveTime: now,
          lastMoveTime: now,
          prevMoveClientX: t.clientX,
          lastMoveClientX: t.clientX,
          startSwipeX,
          swipeX: startSwipeX,
          moved: false,
          intent: null, // 'h' | 'v'
          side: startSide, // 'left' | 'right'
        };
      }, { passive:true });

      invTable.addEventListener('touchmove', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'touch') return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }

        const t = findTouchById(e.touches || [], _mobGesture.touchId);
        if(!t) return;

        const dx = t.clientX - _mobGesture.startX;
        const dy = t.clientY - _mobGesture.startY;
        const ax = Math.abs(dx);
	        const ay = Math.abs(dy);

	        // Any meaningful movement cancels a "tap".
	        if(ax >= 10 || ay >= 10) _mobGesture.moved = true;

        if(!_mobGesture.intent){
          if(ax < 10 && ay < 10) return;
          _mobGesture.intent = (ax >= ay) ? 'h' : 'v';
          if(_mobGesture.intent === 'v'){ resetMobGesture(); return; }
        }
        if(_mobGesture.intent !== 'h') return;

        // Horizontal swipe: prevent scroll once locked.
        try{ e.preventDefault(); }catch(e){}

        const now = performance.now();
        _mobGesture.prevMoveTime = _mobGesture.lastMoveTime;
        _mobGesture.prevMoveClientX = _mobGesture.lastMoveClientX;
        _mobGesture.lastMoveTime = now;
        _mobGesture.lastMoveClientX = t.clientX;

        const tr = _mobGesture.tr;
        if(!tr || !tr.isConnected){ resetMobGesture(); return; }

	        // Elastic resistance when swiping back from detent toward origin
	        const startAx = Math.abs(_mobGesture.startSwipeX);
	        const startSide = traySideFromSwipeX(_mobGesture.startSwipeX);
	        const startSnapPx = traySnapPxForSide(startSide);
	        const isAtDetent = startAx >= startSnapPx - 10;
	        const isSwipingBack = (_mobGesture.startSwipeX < 0 && dx > 0) || (_mobGesture.startSwipeX > 0 && dx < 0);

        let nextX;
        if(isAtDetent && isSwipingBack){
          // Apply damping for sticky/elastic feel (0.35x movement)
          const dampedDx = dx * 0.35;
          nextX = clampNum(_mobGesture.startSwipeX + dampedDx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = true;
        }else{
          nextX = clampNum(_mobGesture.startSwipeX + dx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = false;
        }
        _mobGesture.swipeX = nextX;

        let side = _mobGesture.side;
        if(Math.abs(nextX) > 6) side = (nextX < 0) ? 'right' : 'left';
        else if(!side) side = (dx < 0) ? 'right' : 'left';
        _mobGesture.side = side || 'left';

        prepareMobileTrayForRow(tr, _mobGesture.side);
        tr.classList.add('swiping');
        setRowSwipeX(tr, nextX);
      }, { passive:false });

      invTable.addEventListener('touchend', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'touch') return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }
        const ended = findTouchById(e.changedTouches || [], _mobGesture.touchId);
        if(!ended) return;
        try{ e.preventDefault(); }catch(e){}

        const { id, tr, moved, intent, swipeX, startTime, startX, prevMoveTime, lastMoveTime, prevMoveClientX, lastMoveClientX, closingFromDetent } = _mobGesture;
        resetMobGesture();
        if(!id || !tr) return;

	        if(!moved){
	          if(_openTrayId === id && tr.classList.contains('tray-open')){
	            closeMobileTrayElastic(tr);
	            return;
	          }
	          handleInventoryRowTap(id);
	          return;
	        }

        if(intent === 'h'){
          tr.classList.remove('swiping');
          const finalX = Number.isFinite(swipeX) ? swipeX : getRowSwipeX(tr);
          const ax = Math.abs(finalX);
          const side = (finalX < 0) ? 'right' : 'left';

          // If user was swiping back from detent, always snap back with elastic animation
          if(closingFromDetent){
            closeMobileTrayElastic(tr);
            return;
          }

          let vx = 0;
          try{
            if(Number.isFinite(lastMoveTime) && Number.isFinite(prevMoveTime) && lastMoveTime > prevMoveTime){
              const dt = lastMoveTime - prevMoveTime;
              vx = dt > 0 ? (lastMoveClientX - prevMoveClientX) / dt : 0;
            }else{
              const tNow = performance.now();
              const dt = tNow - (Number(startTime) || tNow);
              vx = dt > 0 ? (ended.clientX - startX) / dt : 0;
            }
          }catch(e){ vx = 0; }

		          const canCommitEdit = trayHasActionsForSide('right') && isInventoryActionVisible('edit_item');
		          const shouldCommitEdit = canCommitEdit && (side === 'right') && (ax >= COMMIT_PX);
		          if(shouldCommitEdit){
		            closeMobileTray();
		            if(!requireOnline()) return;
		            if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
		            openEditItemModal(id);
		            return;
		          }
		          const canCommitOrder = trayHasActionsForSide('left') && isInventoryActionVisible('order_item');
		          const shouldCommitOrder = canCommitOrder && (side === 'left') && (ax >= COMMIT_PX);
		          if(shouldCommitOrder){
		            closeMobileTray();
		            if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		            toggleOrderLineForItemId(id);
		            return;
		          }

		          if(!trayHasActionsForSide(side)){
		            closeMobileTray();
		            return;
		          }
		          const fastOpen = (side === 'right') ? (vx <= -0.55) : (vx >= 0.55);
		          const fastClose = (side === 'right') ? (vx >= 0.55) : (vx <= -0.55);
		          const snapPx = traySnapPxForSide(side);
		          if(fastClose && ax < COMMIT_PX){
	            closeMobileTray();
	          }else if(ax >= snapPx || (ax >= REVEAL_PX && fastOpen)){
	            openMobileTrayForRow(tr, side);
	          }else{
	            closeMobileTray();
	          }
        }
      }, { passive:false });

      invTable.addEventListener('touchcancel', ()=>{
        if(!isMobileUx()) return;
        try{ if(_mobGesture && _mobGesture.tr) _mobGesture.tr.classList.remove('swiping'); }catch(e){}
        try{ closeMobileTray(); }catch(e){}
        resetMobGesture();
      }, { passive:true });

      invTable.addEventListener('click', (e)=>{
        if(isMobileUx()) return;
        const tr = e.target.closest('tr[data-id]');
        if(!tr) return;
        if(e.target.closest('button, input, textarea, select, a, .actions-wrap, .card-tray')) return;
        const id = String(tr.dataset.id || '').trim();
        if(!id) return;
        handleInventoryRowTap(id);
      });
		    }

	    function startCellEdit(td, ev){
	      // If the user tapped a control inside the cell, don't open an editor.
	      if(ev && ev.target && ev.target.closest('button, input, textarea, select, a')) return;
	      if(td.querySelector('input')) return;
	      if(isMobileUx()) return;
	      const col=td.getAttribute('data-col'); if(!col) return;
	      const tr=td.closest('tr'); const id=tr?.dataset?.id; if(!id) return;
	      const it=state.items.find(x=> x.id===id); if(!it) return;
	      const selectedIds = getSelectedRowIds();
	      const batchIds = (selectedIds.length > 1 && selectedIds.includes(id)) ? selectedIds : [];
	      const isBatch = batchIds.length > 1;
	      const prevBatch = isBatch ? new Map(
	        batchIds
	          .map(batchId => {
	            const item = getInventoryById(batchId);
	            if(!item) return null;
	            return [batchId, { name: String(item.name||''), desc: String(item.desc||''), qty: toInt(item.qty,0) }];
	          })
	          .filter(Boolean)
	      ) : null;

      if(prefersModalEditing()){
        if(!requireOnline()) return;
        if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
        openEditItemModal(id);
        return;
      }

      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
      const fb = $('filterBox'); if (fb) fb.value = '';
	      state._filter = '';
	      try{ updateFilterClearBtn(); }catch(e){}

	      const oldVal = (col==='qty'? String(toInt(it.qty,0)) : String(col==='name'?it.name:(it.desc||'')));
	      const prevName = String(it.name||'');
	      const prevDesc = String(it.desc||'');
	      const prevQty = toInt(it.qty,0);
	      const inp=document.createElement('input');
	      inp.type = (col==='qty')? 'number' : 'text';
	      if(col==='qty'){ inp.min='0'; inp.step='1'; inp.inputMode='numeric'; inp.pattern='[0-9]*'; inp.setAttribute('enterkeyhint','done'); }
	      inp.value = oldVal; inp.autocapitalize='off'; inp.autocomplete='off'; inp.spellcheck=false;
	      td.classList.add('editing'); td.innerHTML=''; td.appendChild(inp);
	      setTimeout(()=>{ inp.focus(); inp.select(); }, 0);

	      let _done = false;
	      const restore = ()=>{
	        if(_done) return;
	        _done = true;
	        td.classList.remove('editing');
	        if(col==='qty') td.innerHTML = qtyCellHTML(it);
	        else td.innerHTML = '<span class="cell-val">' + escapeHtml((col==='name') ? String(it.name||'') : String(it.desc||'')) + '</span>';
	      };
	      const cancel=()=>{
	        it.name = prevName;
	        it.desc = prevDesc;
	        it.qty = prevQty;
	        restore();
	      };

	      const commit = async () => {
	        if(_done) return;
	        const raw = inp.value;
	        try{
	          if(isBatch){
	            if(!requireOnline()) return;
	            const count = batchIds.length;
	            if(col === 'name'){
	              const nv = String(raw||'').trim();
	              if(!nv){ cancel(); toast('Name required'); return; }
	              const normNv = toKey(nv);
	              const dup = state.items.some(x => x && x.id && !batchIds.includes(x.id) && toKey(String(x.name||'')) === normNv);
	              if(dup){ cancel(); toast('Duplicate name'); return; }
	              const allSame = batchIds.every(batchId => {
	                const item = getInventoryById(batchId);
	                return item && toKey(String(item.name||'')) === normNv;
	              });
	              if(allSame){ cancel(); return; }
	              const ok = await openConfirmModal('Batch edit?', `Set Item to "${truncateForConfirm(nv)}" for ${count} selected items?`, { okText:'Apply', cancelText:'Cancel' });
	              if(!ok){ cancel(); return; }
	              batchIds.forEach(batchId => {
	                const item = getInventoryById(batchId);
	                if(item) item.name = nv;
	              });
	              restore();
	              renderTable();
	              applySelectedRowIds(batchIds);
	              try{
	                await Promise.all(batchIds.map(batchId => sbUpdateFields(batchId, { name: nv })));
	              }catch(e){
	                if(prevBatch){
	                  prevBatch.forEach((prev, batchId) => {
	                    const item = getInventoryById(batchId);
	                    if(item){
	                      item.name = prev.name;
	                      item.desc = prev.desc;
	                      item.qty = prev.qty;
	                    }
	                  });
	                  renderTable();
	                  applySelectedRowIds(batchIds);
	                }
	                toast((e && e.message) ? e.message : 'Batch update failed');
	                try{ await sbLoadSnapshot(); }catch{}
	              }
	              return;
	            }
	            if(col === 'desc'){
	              const nv = normalizeDescValue(raw);
	              const allSame = batchIds.every(batchId => {
	                const item = getInventoryById(batchId);
	                return item && normalizeDescValue(item.desc) === nv;
	              });
	              if(allSame){ cancel(); return; }
	              const ok = await openConfirmModal('Batch edit?', `Set Description to "${truncateForConfirm(nv)}" for ${count} selected items?`, { okText:'Apply', cancelText:'Cancel' });
	              if(!ok){ cancel(); return; }
	              batchIds.forEach(batchId => {
	                const item = getInventoryById(batchId);
	                if(item) item.desc = nv;
	              });
	              restore();
	              renderTable();
	              applySelectedRowIds(batchIds);
	              try{
	                await Promise.all(batchIds.map(batchId => sbUpdateFields(batchId, { desc: nv })));
	              }catch(e){
	                if(prevBatch){
	                  prevBatch.forEach((prev, batchId) => {
	                    const item = getInventoryById(batchId);
	                    if(item){
	                      item.name = prev.name;
	                      item.desc = prev.desc;
	                      item.qty = prev.qty;
	                    }
	                  });
	                  renderTable();
	                  applySelectedRowIds(batchIds);
	                }
	                toast((e && e.message) ? e.message : 'Batch update failed');
	                try{ await sbLoadSnapshot(); }catch{}
	              }
	              return;
	            }
	            if(col === 'qty'){
	              const q = toInt(raw, -1);
	              if(q < 0){ cancel(); toast('Qty must be integer â‰¥ 0'); return; }
	              const allSame = batchIds.every(batchId => {
	                const item = getInventoryById(batchId);
	                return item && toInt(item.qty, 0) === q;
	              });
	              if(allSame){ cancel(); return; }
	              const ok = await openConfirmModal('Batch edit?', `Set Qty to ${q} for ${count} selected items?`, { okText:'Apply', cancelText:'Cancel' });
	              if(!ok){ cancel(); return; }
	              batchIds.forEach(batchId => {
	                const item = getInventoryById(batchId);
	                if(item) item.qty = q;
	              });
	              restore();
	              renderTable();
	              applySelectedRowIds(batchIds);
	              batchIds.forEach(batchId => queueQtyCommit(batchId, q));
	              return;
	            }
	            cancel();
	            return;
	          }
	          if(col==='name'){
	            const nv = String(raw||'').trim();
	            if(!nv){ cancel(); toast('Name required'); return; }
	            if(nv === prevName){ cancel(); return; }
	            if(toKey(nv)!==toKey(prevName) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))){ cancel(); toast('Duplicate name'); return; }
	            it.name = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'name') renderTable();
	            await sbUpdateFields(id, { name: nv });
	            return;
	          }
	          if(col==='desc'){
	            const nv = normalizeDescValue(raw);
	            const pv = normalizeDescValue(prevDesc);
	            if(nv === pv){ cancel(); return; }
	            it.desc = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'desc') renderTable();
	            await sbUpdateFields(id, { desc: nv });
	            return;
	          }
			          if(col==='qty'){
			            const q = toInt(raw, -1);
			            if(q < 0){ cancel(); toast('Qty must be integer â‰¥ 0'); return; }
			            if(q === prevQty){ cancel(); return; }
			            it.qty = q;
			            restore();
			            adjustDisplayedTotalQty(q - prevQty);
			            adjustDisplayedInStock(prevQty, q);
			            adjustDisplayedLowStock(it, prevQty, q);
			            repositionRowByQty(id);
			            queueQtyCommit(id, q);
			            try{ syncLowStockIndicatorForRow(id); }catch(e){}
			            return;
			          }
	          cancel();
	        }catch(e){
	          it.name = prevName;
	          it.desc = prevDesc;
	          it.qty = prevQty;
	          try{ renderTable(); }catch(_){}
	          toast((e && e.message) ? e.message : 'Update failed');
	          try{ await sbLoadSnapshot(); }catch{}
	        }
	      };

	      inp.addEventListener('keydown', e=>{
	        if(e.key==='Enter'){ e.preventDefault(); commit(); }
	        if(e.key==='Escape'){ e.preventDefault(); cancel(); }
	      });
	      inp.addEventListener('blur', commit);
	    }

    // ========================
    // Hamburger Menu Toggle
    // ========================
    const hamburgerBtn = $('hamburgerBtn');
    const menuBackdrop = $('menuBackdrop');
    const menuPanel = $('menuPanel');
    const menuCloseBtn = $('menuCloseBtn');
    const menuTabList = $('menuTabList');
    let _menuOpen = false;

    function setMenuTab(tabKey, opts = {}){
      const tabs = Array.from(document.querySelectorAll('#menuTabList .menu-tab'));
      const panels = Array.from(document.querySelectorAll('#menuTabPanels .menu-tab-panel'));
      if(!tabs.length) return;
      const desired = String(tabKey || '').trim();
      const resolved = tabs.some(tab => tab.dataset.tab === desired) ? desired : 'inventory';
      const current = tabs.find(tab => tab.classList.contains('is-active'));
      if(current && current.dataset.tab === resolved && !opts.force) return;
      tabs.forEach(tab => {
        const active = tab.dataset.tab === resolved;
        tab.classList.toggle('is-active', active);
        tab.setAttribute('aria-selected', active ? 'true' : 'false');
        tab.tabIndex = active ? 0 : -1;
      });
      panels.forEach(panel => {
        const active = panel.dataset.panel === resolved;
        if(active){
          panel.classList.add('is-active');
          panel.classList.remove('is-leaving');
          return;
        }
        if(panel.classList.contains('is-active')){
          panel.classList.add('is-leaving');
          setTimeout(() => {
            panel.classList.remove('is-active');
            panel.classList.remove('is-leaving');
          }, 160);
        }else{
          panel.classList.remove('is-active');
          panel.classList.remove('is-leaving');
        }
      });
      try{ sessionStorage.setItem(MENU_TAB_STORAGE_KEY, resolved); }catch(e){}
    }
    function restoreMenuTab(){
      let target = '';
      try{ target = sessionStorage.getItem(MENU_TAB_STORAGE_KEY) || ''; }catch(e){}
      setMenuTab(target || 'inventory', { force:true });
    }
    function initMenuTabs(){
      if(!menuTabList || menuTabList._wired) return;
      menuTabList._wired = true;
      menuTabList.addEventListener('click', (e)=>{
        const btn = e.target.closest('.menu-tab');
        if(!btn) return;
        setMenuTab(btn.dataset.tab);
      });
      menuTabList.addEventListener('keydown', (e)=>{
        if(e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;
        const tabs = Array.from(menuTabList.querySelectorAll('.menu-tab'));
        if(!tabs.length) return;
        const idx = tabs.findIndex(tab => tab.classList.contains('is-active'));
        if(idx < 0) return;
        const dir = e.key === 'ArrowRight' ? 1 : -1;
        const nextIdx = (idx + dir + tabs.length) % tabs.length;
        const nextTab = tabs[nextIdx];
        if(nextTab){
          e.preventDefault();
          setMenuTab(nextTab.dataset.tab);
          nextTab.focus();
        }
      });
    }
    function getMenuFocusables(){
      if(!menuPanel) return [];
      return Array.from(menuPanel.querySelectorAll(MODAL_FOCUSABLE))
        .filter(el => !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true' && el.tabIndex !== -1);
    }
    function focusMenuFirst(){
      const items = getMenuFocusables();
      if(items.length){
        items[0].focus();
        return;
      }
      if(menuPanel){
        menuPanel.setAttribute('tabindex', '-1');
        menuPanel.focus();
      }
    }
    function handleMenuKeydown(e){
      if(!_menuOpen) return;
      if(e.key === 'Escape'){
        toggleMenu(false);
        return;
      }
      if(e.key !== 'Tab') return;
      const items = getMenuFocusables();
      if(!items.length){
        e.preventDefault();
        return;
      }
      const first = items[0];
      const last = items[items.length - 1];
      if(e.shiftKey){
        if(document.activeElement === first){
          e.preventDefault();
          last.focus();
        }
      }else if(document.activeElement === last){
        e.preventDefault();
        first.focus();
      }
    }
    function toggleMenu(open) {
      const isOpen = open !== undefined ? open : !menuBackdrop.classList.contains('open');
      _menuOpen = isOpen;
      if(menuBackdrop){
        menuBackdrop.classList.toggle('open', isOpen);
        menuBackdrop.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
      }
      if(hamburgerBtn){
        hamburgerBtn.classList.toggle('open', isOpen);
        hamburgerBtn.setAttribute('aria-expanded', isOpen);
      }
      if(isOpen){
        initMenuTabs();
        restoreMenuTab();
        updateMenuJobsBadge();
        focusMenuFirst();
      }
    }

    if(hamburgerBtn) hamburgerBtn.addEventListener('click', () => toggleMenu());
    if(menuCloseBtn) menuCloseBtn.addEventListener('click', () => toggleMenu(false));
    if(menuBackdrop) menuBackdrop.addEventListener('click', (e) => {
      if(e.target === menuBackdrop) toggleMenu(false);
    });
    document.addEventListener('keydown', handleMenuKeydown);

    // ========================
    // Import / Paste / Export
    // ========================
    $('menuImport').addEventListener('click', ()=> {
      toggleMenu(false);
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk import requires import permission' : 'Bulk import requires Professional tier');
        return;
      }
      $('#fileImport').click();
    });
    $('#fileImport').addEventListener('change', async ev=>{
      if(!requireOnline()){ ev.target.value=''; return; }
      const f=ev.target.files[0]; if(!f) return; await handleFile(f); ev.target.value='';
    });

    $('menuPaste').addEventListener('click', ()=>{
      toggleMenu(false);
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk paste requires import permission' : 'Bulk paste requires Professional tier');
        return;
      }
      $('#pasteArea').value='';
      show('pasteModal', true);
    });
    $('btnPasteCancel').addEventListener('click', ()=> show('pasteModal', false));
    $('btnPasteApply').addEventListener('click', ()=>{
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk paste requires import permission' : 'Bulk paste requires Professional tier');
        return;
      }
      const text=$('#pasteArea').value||''; if(!text.trim()){ toast('Nothing to import'); return; }
      const rows=parseDelimitedSmart(text); const items=rowsToItems(rows);
      if(!items.length){ toast('Could not detect headers or rows'); return; }
      show('pasteModal', false);
      showPreview(items);
    });

    const drop=$('#dropZone');
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#0e1621'; });
    drop.addEventListener('dragleave', ()=>{ drop.style.background=''; });
    drop.addEventListener('drop', async e=>{
      e.preventDefault(); drop.style.background='';
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk import requires import permission' : 'Bulk import requires Professional tier');
        return;
      }
      const f=e.dataTransfer.files[0]; if(f) await handleFile(f);
    });

    $('#fileImportModal').addEventListener('change', async ev=>{ if(!requireOnline()){ ev.target.value=''; return; } const f=ev.target.files[0]; if(f) await handleFile(f); ev.target.value=''; });

    async function handleFile(f){
      if(!requireOnline()) return;
      if(!canItemsImport()){
        toast(hasTier('professional') ? 'Bulk import requires import permission' : 'Bulk import requires Professional tier');
        return;
      }
      try{
        const items=await parseAnyFile(f);
        if(!items.length){ toast('No rows found in file'); return; }
        show('pasteModal', false);
        showPreview(items);
      }catch(err){ toast(err.message||'Import failed'); }
    }
    function buildPreview(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      const rows=[]; let add=0, upd=0, same=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        const it=index.get(k);
        if(!it){ rows.push({name:r.name, desc:r.desc||'', oldQty:'â€”', newQty:toInt(r.qty,0), action:'Add'}); add++; }
        else{
          const oldQ=toInt(it.qty,0), newQ=toInt(r.qty,0);
          const act = (oldQ===newQ && (r.desc||'').trim()===String(it.desc||'').trim())? 'No change' : 'Update';
          if(act==='Update') upd++; else same++;
          rows.push({name:it.name, desc:(r.desc||it.desc||''), oldQty:oldQ, newQty:newQ, action:act});
        }
      }
      return {rows, add, upd, same, total: imported.length};
    }
    function showPreview(imported){
      const pv=buildPreview(imported);
      const info=$('previewInfo'); if(info){ info.textContent = `${pv.total} row(s): ${pv.add} add, ${pv.upd} update, ${pv.same} unchanged`; }
      const tbody=$('previewBody'); if(tbody){
        tbody.innerHTML='';
        for(const r of pv.rows){
          const tr=document.createElement('tr');
          tr.innerHTML =
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.name)}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.desc||'')}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.oldQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.newQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${r.action}</td>`;
          tbody.appendChild(tr);
        }
      }
      state._pendingImport = imported;
      show('previewModal', true);
    }
    $('btnPreviewCancel').addEventListener('click', ()=>{ state._pendingImport=null; show('previewModal', false); });
    $('btnPreviewApply').addEventListener('click', async ()=>{
      if(!requireOnline()) return;
      const imp = state._pendingImport||[]; state._pendingImport=null; show('previewModal', false);
      if(!imp.length){ toast('Nothing to import'); return; }
      try{
        await sbUpsertMany(imp);
        await sbLoadSnapshot();
        toast('Import applied');
      }catch(e){ toast(e.message || 'Import failed'); }
    });

	    $('menuExport').addEventListener('click', ()=>{
	      toggleMenu(false);
	      if(!requireOnline()) return;
	      if(!canItemsExport()){
	        toast(hasTier('professional') ? 'Export permission required' : 'Export requires Professional tier');
	        return;
	      }
	      (async ()=>{
	        try{
	          const items = await sbExportItems();
	          if(!items.length){ toast('No items to export'); return; }
	          const rows=[["Item","Description","Qty"]];
	          for(const it of items){ rows.push([it.name||'', it.description||'', String(toInt(it.quantity,0))]); }
	          const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
	          const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
	          const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventory.csv'; a.click(); URL.revokeObjectURL(url);
	        }catch(e){
	          toast(e && e.message ? e.message : 'Export failed');
	        }
	      })();
	    });

			    // ========================
			    // Inventory report
			    // ========================
			    function getGlobalLowStockQty(){
		      try{
		        if(SB && SB.profile && typeof SB.profile.low_stock_qty_global !== 'undefined'){
		          const v = Number(SB.profile.low_stock_qty_global);
	          if(Number.isFinite(v) && v >= 0) return Math.trunc(v);
	        }
	      }catch(e){}
	      try{
	        const raw = localStorage.getItem('inv.pref.lowStockQtyGlobal');
	        const v = Number(raw);
	        if(Number.isFinite(v) && v >= 0) return Math.trunc(v);
	      }catch(e){}
	      return 0;
	    }
	    function getItemLowStockQtyOverride(item){
	      if(!item) return null;
	      const v = Object.prototype.hasOwnProperty.call(item, 'lowStockQty') ? item.lowStockQty : null;
	      if(v === null || typeof v === 'undefined') return null;
	      const n = Number(v);
	      if(!Number.isFinite(n)) return null;
	      const i = Math.trunc(n);
	      if(i < 0) return null;
	      return i;
	    }
	    function getItemReorderEnabled(item){
	      if(!item) return true;
	      if(!Object.prototype.hasOwnProperty.call(item, 'reorderEnabled')) return true;
	      return !!item.reorderEnabled;
	    }
	    function effectiveLowStockQty(item){
	      const override = getItemLowStockQtyOverride(item);
	      return override !== null ? override : getGlobalLowStockQty();
	    }
	    function isLowStockItem(item){
	      if(!getItemReorderEnabled(item)) return false;
	      const qty = toInt(item && item.qty, 0);
	      const thr = effectiveLowStockQty(item);
	      return qty <= thr;
	    }
	    function isExemptLowStockItem(item){
	      if(getItemReorderEnabled(item)) return false;
	      const qty = toInt(item && item.qty, 0);
	      const thr = effectiveLowStockQty(item);
	      return qty <= thr;
	    }
	    function reportDataSnapshot(){
	      const all = (Array.isArray(state.items) ? state.items : [])
	        .filter(Boolean)
		        .map(it => ({
		          id: it.id,
		          name: String(it.name||''),
		          desc: String(it.desc||''),
		          qty: toInt(it.qty,0),
		          lowStockQty: getItemLowStockQtyOverride(it),
		          reorderEnabled: getItemReorderEnabled(it),
		        }))
	        .sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
	      const totalItems = all.length;
	      const totalQty = all.reduce((sum, it) => sum + toInt(it.qty,0), 0);
	      const inStock = all.filter(it => toInt(it.qty,0) > 0);
	      const lowStock = all.filter(it => isLowStockItem(it));
	      const exemptLowStock = all.filter(it => isExemptLowStockItem(it));
	      return {
	        all,
	        inStock,
	        lowStock,
	        exemptLowStock,
	        totalItems,
	        totalQty,
	        inStockCount: inStock.length,
	        lowStockCount: lowStock.length,
	        exemptLowStockCount: exemptLowStock.length,
	      };
	    }
	    function reportCsvEscape(value){
	      const s = String(value ?? '');
	      return '"' + s.replace(/"/g, '""') + '"';
	    }
	    function buildInventoryReportCsv(data){
	      const d = data || reportDataSnapshot();
	      const out = [];
	      out.push(['Item','Description','Qty','In Stock'].map(reportCsvEscape).join(','));
	      for(const it of d.all){
	        out.push([
	          it.name || '',
	          String(it.desc||'').replace(/[\r\n]+/g,' ').trim(),
	          String(toInt(it.qty,0)),
	          toInt(it.qty,0) > 0 ? 'Yes' : 'No',
	        ].map(reportCsvEscape).join(','));
	      }
	      return out.join('\n');
	    }
	    function buildInventoryReportText(data, opts = {}){
	      const d = data || reportDataSnapshot();
	      const maxLines = Math.max(10, Math.min(500, toInt(opts.maxLines, 180)));
	      const out = [];
	      const when = formatEasternDateTime(new Date());
	      out.push(`Inventory Report`);
	      out.push(`Generated: ${when}`);
	      out.push('');
	      out.push(`Total Items: ${d.totalItems}`);
	      out.push(`In Stock: ${d.inStockCount}`);
	      out.push(`Low Stock: ${d.lowStockCount}`);
	      out.push(`Total Qty: ${d.totalQty}`);
	      out.push('');
	      out.push('Inventory:');
	      out.push('');
	      if(!d.all.length){
	        out.push('(none)');
	        return out.join('\n');
	      }
	      let linesUsed = out.length;
	      for(const it of d.all){
	        if(linesUsed >= maxLines){
	          out.push('');
	          out.push(`(trimmed; use CSV for full report)`);
	          break;
	        }
	        const qty = toInt(it.qty,0);
	        const desc = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
	        out.push(`${it.name}\t${qty}\t${desc}`);
	        linesUsed++;
	      }
	      return out.join('\n');
	    }
	
	    function reportTableHtml(items, opts = {}){
	      const rows = Array.isArray(items) ? items : [];
	      const showThreshold = !!opts.showThreshold;
	      let html = '<table class="report-table" role="table">';
	      html += '<thead><tr>';
	      html += '<th>Item</th>';
	      html += '<th>Description</th>';
	      html += '<th class="qty">Qty</th>';
	      if(showThreshold) html += '<th class="thr">Low</th>';
	      html += '</tr></thead><tbody>';
	      for(const it of rows){
	        const name = escapeHtml(it && it.name ? it.name : '');
	        const descRaw = String(it && it.desc ? it.desc : '').replace(/[\r\n]+/g,' ').trim();
	        const desc = escapeHtml(descRaw);
	        const qty = toInt(it && it.qty, 0);
	        html += '<tr>';
	        html += `<td class="item">${name}</td>`;
	        html += `<td class="desc">${desc}</td>`;
	        html += `<td class="qty">${qty}</td>`;
	        if(showThreshold){
	          const thr = effectiveLowStockQty(it);
	          html += `<td class="thr">${toInt(thr,0)}</td>`;
	        }
	        html += '</tr>';
	      }
	      html += '</tbody></table>';
	      return html;
	    }
	    function reportOrderHasItem(id){
	      const ord = orderState();
	      const key = String(id || '').trim();
	      return !!(key && ord && Array.isArray(ord.lines) && ord.lines.some(l => String(l && l.id ? l.id : '').trim() === key));
	    }
	    function reportRowButtonHtml(item, opts = {}){
	      const it = item || {};
	      const id = String(it.id || '').trim();
	      if(!id) return '';
	      const safeId = id.replace(/"/g, '&quot;');
	      const name = escapeHtml(String(it.name || '').trim());
	      const descRaw = String(it.desc || '').replace(/[\r\n]+/g,' ').trim();
	      const desc = escapeHtml(descRaw);
	      const qty = toInt(it.qty, 0);
	      const showThreshold = !!opts.showThreshold;
	      const thr = showThreshold ? toInt(effectiveLowStockQty(it), 0) : null;
	      const selected = reportOrderHasItem(id);
	      const dotClass = selected ? 'led-dot--green' : 'led-dot--off';
	      const pressed = selected ? 'true' : 'false';

	      return (
	        `<button type="button" class="report-row" data-report-order-id="${safeId}" aria-pressed="${pressed}">`+
	          `<div class="report-row-main">`+
	            `<div class="report-item">`+
	              `<span class="led-dot ${dotClass}" aria-hidden="true"></span>`+
	              `<span class="report-item-name">${name}</span>`+
	            `</div>`+
	            (desc ? `<div class="report-desc">${desc}</div>` : ``)+
	          `</div>`+
	          `<div class="report-qty">`+
	            `${qty}`+
	            (showThreshold ? `<div class="muted">Low: ${thr}</div>` : ``)+
	          `</div>`+
	        `</button>`
	      );
	    }
	    function reportRowsHtml(items, opts = {}){
	      const rows = Array.isArray(items) ? items : [];
	      if(!rows.length){
	        const emptyText = (opts && typeof opts.emptyText === 'string') ? opts.emptyText : 'No items.';
	        return `<div class="order-empty">${escapeHtml(emptyText)}</div>`;
	      }
	      const sepText = (opts && typeof opts.separatorText === 'string') ? opts.separatorText : 'Not in Cart';
	      const selected = [];
	      const rest = [];
	      for(const it of rows){
	        const id = String(it && it.id ? it.id : '').trim();
	        if(id && reportOrderHasItem(id)) selected.push(it);
	        else rest.push(it);
	      }
	      let html = '';
	      if(selected.length) html += selected.map(it => reportRowButtonHtml(it, opts)).join('');
	      if(selected.length && rest.length){
	        html += `<div class="report-separator" role="separator"><span>${escapeHtml(sepText)}</span></div>`;
	      }
	      if(rest.length) html += rest.map(it => reportRowButtonHtml(it, opts)).join('');
	      return html;
	    }
	    function updateReportOrderBadge(){
	      const modal = $('reportModal');
	      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
	      const pillContainer = $('reportOrderPillContainer');
	      const pill = $('reportOrderBadge');
	      const valueEl = $('reportOrderCount');
	      if(!pillContainer || !pill || !valueEl) return;
	      const ord = orderState();
	      const count = Array.isArray(ord.lines) ? ord.lines.length : 0;
	      if(count > 0){
	        pillContainer.style.display = 'flex';
	        valueEl.textContent = String(count);
	        const labelEl = pill.querySelector('.order-pill-label');
	        if(labelEl) labelEl.textContent = count === 1 ? 'Item in Cart' : 'Items in Cart';
	      }else{
	        pillContainer.style.display = 'none';
	        valueEl.textContent = '0';
	      }
	    }
		    function syncReportOrderIndicators(){
		      const modal = $('reportModal');
		      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
		      const ord = orderState();
		      const ids = new Set((Array.isArray(ord.lines) ? ord.lines : []).map(l => String(l && l.id ? l.id : '').trim()).filter(Boolean));
	      document.querySelectorAll('[data-report-order-id]').forEach(el=>{
	        const id = String(el.dataset && el.dataset.reportOrderId ? el.dataset.reportOrderId : '').trim();
	        if(!id) return;
	        const selected = ids.has(id);
	        el.setAttribute('aria-pressed', selected ? 'true' : 'false');
	        const dot = el.querySelector('.led-dot');
	        if(dot){
	          dot.classList.toggle('led-dot--green', selected);
	          dot.classList.toggle('led-dot--off', !selected);
	        }
	      });
		      updateReportOrderBadge();
		    }
		    function batchAddLowStockToCart(){
		      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		      const d = reportDataSnapshot();
		      const rows = Array.isArray(d.lowStock) ? d.lowStock : [];
		      if(!rows.length){ toast('No low stock items'); return; }
		      let added = 0;
		      for(const it of rows){
		        const need = Math.max(1, toInt(effectiveLowStockQty(it), 0) - toInt(it.qty, 0));
		        if(upsertOrderLineFromItem(it, need)) added++;
		      }
		      if(added){
		        toast(`Added ${added} low stock ${added === 1 ? 'item' : 'items'} to cart`);
		      }else{
		        toast('Low stock items already in cart');
		      }
		      try{ syncReportOrderIndicators(); }catch(e){}
		    }
			    function renderInventoryReport(){
			      const d = reportDataSnapshot();
			      const elTotal = $('reportMetricTotalItems'); if(elTotal) elTotal.textContent = String(d.totalItems);
			      const elQty = $('reportMetricTotalQty'); if(elQty) elQty.textContent = String(d.totalQty);
			      const elLowCount = $('reportLowStockCount'); if(elLowCount) elLowCount.textContent = `(${d.lowStockCount})`;
			      const elExemptCount = $('reportExemptCount'); if(elExemptCount) elExemptCount.textContent = `(${d.exemptLowStockCount})`;
			      const elInCount = $('reportInStockCount'); if(elInCount) elInCount.textContent = `(${d.inStockCount})`;

			      const lowSection = $('reportLowStockSection');
			      const lowList = $('reportLowStockList');
			      if(lowSection && lowList){
			        lowList.innerHTML = reportRowsHtml(d.lowStock, { showThreshold:true, emptyText:'No low stock items.' });
			      }

			      const exemptSection = $('reportExemptSection');
			      const exemptList = $('reportExemptList');
			      if(exemptSection && exemptList){
			        exemptList.innerHTML = reportRowsHtml(d.exemptLowStock, { showThreshold:true, emptyText:'No exempt low stock items.' });
			      }

		      const list = $('reportList');
		      if(list){
		        list.innerHTML = reportRowsHtml(d.inStock, { showThreshold:false, emptyText:'No in-stock items.' });
		      }
		      updateReportOrderBadge();
		    }
		    function downloadInventoryReportCsv(){
		      try{
		        const csv = buildInventoryReportCsv(reportDataSnapshot());
		        const stamp = new Date().toISOString().slice(0,10);
	        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
	        const url = URL.createObjectURL(blob);
	        const a = document.createElement('a');
	        a.href = url;
	        a.download = `inventory-report-${stamp}.csv`;
	        document.body.appendChild(a);
	        a.click();
	        document.body.removeChild(a);
	        URL.revokeObjectURL(url);
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Download failed');
		      }
		    }
		    const MODULUS_LOGO_HORIZONTAL_SVG = `<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2030.96 800">
  <g>
    <polygon points="103.57 382.69 103.76 312.57 161.49 343.09 265.73 288.14 298.02 272.49 298.42 341.25 197.12 395.72 161.56 414.15 103.57 382.69"/>
    <polygon points="87.48 516.09 23.36 481.08 23.4 271.54 87.22 304.49 87.48 516.09"/>
    <path d="M229.31,517.53l-.3-113.92c22.55-12.88,44.55-24.16,68.94-35.85l.13,113.06-68.77,36.71Z"/>
  </g>
  <g>
    <path d="M473.02,438.27l-8.31-31.8c-1.33-5.42-2.29-11.2-2.29-14.33-2.41,4.94-4.94,9.76-11.44,20.96l-9.64,16.5c-4.94,8.79-9.03,10.12-15.78,10.12s-11.08-1.21-16.14-10.12l-10.72-19.27c-6.14-10.84-8.07-14.46-9.88-18.19-.6,3.85-1.57,8.67-2.89,13.73l-8.07,32.4h-27.34l19.51-69.5c2.41-8.43,8.55-12.53,15.66-12.53s11.8,3.73,15.18,9.52l13.25,22.16c7.47,12.41,10,16.74,11.92,20.72,1.93-3.98,4.46-8.19,11.8-20.6l13.25-22.28c3.25-5.54,7.95-9.52,15.3-9.52,6.87,0,13.13,4.1,15.54,12.53,6.38,23.13,12.53,46.38,18.91,69.5h-27.82Z"/>
    <path d="M574.81,439.59c-39.99,0-60.11-12.89-60.11-41.68s20.12-41.56,60.11-41.56,60.23,12.77,60.23,41.56-20.24,41.68-60.23,41.68ZM574.81,379.85c-24.09,0-32.28,2.05-32.28,18.07s8.19,18.19,32.28,18.19,32.4-2.29,32.4-18.19-8.19-18.07-32.4-18.07Z"/>
    <path d="M659.85,438.27v-50.23h27.95v27.1h26.98c12.65,0,21.68-4.7,21.68-17.95,0-10.96-9.52-16.02-21.68-16.02h-54.93l17.71-23.49h37.22c28.67,0,49.39,16.26,49.39,39.51s-20.96,41.07-49.39,41.07h-54.93Z"/>
    <path d="M867.39,357.68h28.07v45.41c0,24.33-16.98,36.5-51.19,36.5-39.39,0-56.37-12.17-56.37-36.5v-45.41h27.82v45.41c0,10.48,3.49,13.37,28.55,13.37,16.98,0,23.13-3.73,23.13-13.37v-45.41Z"/>
    <path d="M921.84,438.27v-80.58h27.82v57.46h61.19l-17.95,23.13h-71.07Z"/>
    <path d="M1109.75,357.68h28.07v45.41c0,24.33-16.98,36.5-51.19,36.5-39.39,0-56.37-12.17-56.37-36.5v-45.41h27.82v45.41c0,10.48,3.49,13.37,28.55,13.37,16.98,0,23.13-3.73,23.13-13.37v-45.41Z"/>
    <path d="M1159.38,438.27l17.95-23.13h60.83c3.61,0,5.66-1.33,5.66-4.22s-2.05-4.21-5.9-4.21h-45.53c-20.84,0-30.35-9.76-30.35-23.37,0-16.26,10.12-25.66,35.29-25.66h71.07l-17.95,23.49h-55.77c-3.73,0-5.66.96-5.66,3.86s1.93,3.97,5.66,3.97h45.77c19.51,0,30.23,7.59,30.23,22.28,0,16.62-7.95,26.98-32.88,26.98h-78.42Z"/>
  </g>
  <g>
    <path d="M1359.68,388.44c-3.08-3.95-7.47-6.07-16.09-6.07-7.08,0-12.96,1.45-12.96,6.02,0,3.42,3.18,4.38,14.75,5.45,10.65.96,19.85,1.25,19.85,10.02,0,9.2-10.12,11.37-18.79,11.37-11.85,0-18.41-4.05-21.49-9.11l3.9-1.78c3.42,4.34,8.14,7.04,17.69,7.04,7.85,0,13.83-1.83,13.83-7.13,0-4.14-3.61-4.96-15.66-6.07-10.55-1.01-18.89-1.45-18.89-9.35,0-8.43,9.78-10.36,18.02-10.36,11.42,0,17.01,3.71,19.81,8.24l-3.95,1.74Z"/>
    <path d="M1381.45,396.87c0-10.12,7.47-18.41,22.7-18.41s22.79,8.29,22.79,18.41-7.57,18.36-22.79,18.36-22.7-8.24-22.7-18.36ZM1422.08,396.87c0-8.29-6.12-14.5-17.93-14.5s-17.83,6.22-17.83,14.5,6.02,14.46,17.83,14.46,17.93-6.22,17.93-14.46Z"/>
    <path d="M1446.26,414.12v-34.46h31.71v3.9h-27.13v11.9h17.01v3.9h-17.01v14.75h-4.58Z"/>
    <path d="M1507.02,414.12v-30.55h-16.58v-3.9h37.68v3.9h-16.53v30.55h-4.58Z"/>
    <path d="M1540.8,379.66h5.06l11.28,27.42,10.55-27.42h2.89l10.5,27.32,11.28-27.32h4.72l-14.65,34.46h-2.89l-10.65-27.52-10.55,27.52h-2.89l-14.65-34.46Z"/>
    <path d="M1611.82,414.12h-4.96l18.94-34.46h3.18l18.94,34.46h-5.54l-5.01-9.4h-20.53l-5.01,9.4ZM1618.95,400.82h16.29l-8.14-15.23-8.14,15.23Z"/>
    <path d="M1702.84,414.12c-1.49.53-2.79.87-4.72.87-13.3,0-7.13-16.48-18.84-16.48h-9.98v15.61h-4.58v-34.46h23.23c7.71,0,13.16,3.18,13.16,9.4s-5.59,9.35-13.16,9.35h-.29v.1c5.83,3.57,4.67,12.24,11.37,12.24,1.11,0,2.6-.24,3.81-.58v3.95ZM1669.3,383.57v11.04h19.13c4.05,0,7.85-1.4,7.85-5.54s-3.81-5.49-7.85-5.49h-19.13Z"/>
    <path d="M1721.53,414.12v-34.46h31.71v3.9h-27.13v10.94h17.01v3.9h-17.01v11.8h29.35v3.9h-33.92Z"/>
    <path d="M1781.13,413.15c0,5.01-3.52,9.98-8.38,9.98v-2.6c1.88-.38,4.82-2.36,4.82-6.41h-5.01v-5.06h8.58v4.1Z"/>
    <path d="M1829.65,379.66h4.58v30.55h25.64v3.9h-30.21v-34.46Z"/>
    <path d="M1877.11,379.66h4.58v30.55h25.64v3.9h-30.21v-34.46Z"/>
    <path d="M1962.83,406.89c-2.55,2.75-7.85,8.34-20.29,8.34-15.13,0-22.65-8.24-22.65-18.36s7.52-18.41,22.79-18.41c12.58,0,17.68,5.59,19.56,7.42l-3.42,2.65c-4.14-3.37-7.95-6.17-16.43-6.17-11.85,0-17.68,6.26-17.68,14.46s6.02,14.5,17.97,14.5c9.01,0,12.96-3.52,16.72-7.08l3.42,2.65Z"/>
  </g>
</svg>`;
		    function buildModulusLogoHtml({ width = 220, color = '#111', marginTop = 18 } = {}){
		      const svg = MODULUS_LOGO_HORIZONTAL_SVG.replace(
		        '<svg ',
		        `<svg role="img" aria-label="Modulus Software, LLC" fill="currentColor" style="width:${width}px;height:auto;display:block;" `
		      );
		      return `<div style="margin-top:${marginTop}px;display:flex;justify-content:center;color:${color};">${svg}</div>`;
		    }
		    function inventoryReportEmailTableHtml(items, opts = {}){
		      const rows = Array.isArray(items) ? items : [];
		      const showThreshold = !!opts.showThreshold;

		      const th = (label, alignRight) => (
		        `<th style="padding:10px;border:1px solid #d0d7de;${alignRight ? 'text-align:right;' : 'text-align:left;'}background:#f6f8fa;font-size:12px;text-transform:uppercase;letter-spacing:.06em;">${label}</th>`
		      );
		      const td = (value, alignRight, extra = '') => (
		        `<td style="padding:10px;border:1px solid #d0d7de;${alignRight ? 'text-align:right;font-variant-numeric:tabular-nums;font-weight:700;' : 'text-align:left;'}${extra}">${value}</td>`
		      );

		      let html = `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;">`;
		      html += `<thead><tr>`;
		      html += th('Item', false);
		      html += th('Description', false);
		      html += th('Qty', true);
		      if(showThreshold) html += th('Low', true);
		      html += `</tr></thead><tbody>`;

		      for(const it of rows){
		        const name = escapeHtml(it && it.name ? it.name : '');
		        const descRaw = String(it && it.desc ? it.desc : '').replace(/[\r\n]+/g,' ').trim();
		        const desc = escapeHtml(descRaw);
		        const qty = toInt(it && it.qty, 0);
		        html += `<tr>`;
		        html += td(`<strong>${name}</strong>`, false, 'word-break:break-word;overflow-wrap:anywhere;');
		        html += td(desc, false, 'word-break:break-word;overflow-wrap:anywhere;');
		        html += td(String(qty), true, '');
		        if(showThreshold){
		          const thr = effectiveLowStockQty(it);
		          html += td(String(toInt(thr,0)), true, '');
		        }
		        html += `</tr>`;
		      }

		      html += `</tbody></table>`;
		      return html;
		    }
		    function buildInventoryReportEmailHtml(data){
		      const d = data || reportDataSnapshot();
		      const when = formatEasternDateTime(new Date());
		      const global = getGlobalLowStockQty();

		      const metricsRow = (label, val) => (
		        `<tr>`+
		          `<td style="padding:8px 10px;border:1px solid #d0d7de;background:#f6f8fa;font-weight:700;">${label}</td>`+
		          `<td style="padding:8px 10px;border:1px solid #d0d7de;text-align:right;font-variant-numeric:tabular-nums;font-weight:800;">${val}</td>`+
		        `</tr>`
		      );

		      const metricsTable =
		        `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;margin:12px 0 18px;">`+
		          `<tbody>`+
		            metricsRow('Total Items', String(d.totalItems))+
		            metricsRow('In Stock', String(d.inStockCount))+
		            metricsRow('Low Stock', String(d.lowStockCount))+
		            metricsRow('Total Qty', String(d.totalQty))+
		          `</tbody>`+
		        `</table>`;

		      const lowStockBlock = d.lowStock && d.lowStock.length
		        ? (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Low Stock Items</div>`+
		            inventoryReportEmailTableHtml(d.lowStock, { showThreshold:true })+
		          `</div>`
		        )
		        : '';

		      const inventoryBlock = d.inStock && d.inStock.length
		        ? (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Current Inventory</div>`+
		            inventoryReportEmailTableHtml(d.inStock, { showThreshold:false })+
		          `</div>`
		        )
		        : (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Current Inventory</div>`+
		            `<div style="color:#57606a;">No in-stock items.</div>`+
		          `</div>`
		        );

		      const brandLogo = buildModulusLogoHtml({ width: 220, color: '#111', marginTop: 18 });
		      const brandLine = `<div style="margin-top:8px;font-size:12px;color:#6a737d;text-align:center;">contact@modulus-software.com</div>`;

		      return (
		        `<!doctype html>`+
		        `<html><body style="margin:0;padding:0;background:#ffffff;">`+
		          `<div style="max-width:760px;margin:0 auto;padding:18px 16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.35;">`+
		            `<h2 style="margin:0 0 10px;font-size:18px;">Inventory Report</h2>`+
		            `<div style="font-size:13px;color:#444;margin:0 0 6px;"><strong>Generated:</strong> ${escapeHtml(when)}</div>`+
		            `${metricsTable}`+
		            `${lowStockBlock}`+
		            `${inventoryBlock}`+
		            `${brandLogo}`+
		            `${brandLine}`+
		          `</div>`+
		        `</body></html>`
		      );
		    }

		    let _reportEmailHtml = '';
		    function setReportEmailMessage(msg){
		      const el = $('reportEmailMsg');
		      if(el) el.textContent = String(msg || '');
		    }
		    function renderReportEmailPreview(html){
		      const wrap = $('reportEmailPreview');
		      if(!wrap) return;
		      const safe = String(html || '').replace(/"/g, '&quot;');
		      wrap.innerHTML = `<iframe srcdoc="${safe}" sandbox="allow-same-origin"></iframe>`;
		    }
		    function defaultInventoryReportEmailSubject(){
		      const stamp = new Date().toISOString().slice(0,10);
		      return `Inventory Report (${stamp})`;
		    }
		    function openReportEmailModal(){
		      const data = reportDataSnapshot();
		      _reportEmailHtml = buildInventoryReportEmailHtml(data);
		      const to = $('reportEmailTo');
		      const subject = $('reportEmailSubject');
		      if(subject) subject.value = defaultInventoryReportEmailSubject();
		      if(to && !String(to.value || '').trim()){
		        const signed = getSignedInEmail();
		        if(signed) to.value = signed;
		      }
		      renderReportEmailPreview(_reportEmailHtml);
		      setReportEmailMessage('');
		      show('reportEmailModal', true);
		    }
		    function closeReportEmailModal(){
		      show('reportEmailModal', false);
		      setReportEmailMessage('');
		    }
		    async function sendInventoryReportEmailViaApi({ toEmail, subjectLine, html }){
		      const to = String(toEmail || '').trim();
		      const subject = String(subjectLine || '').trim() || defaultInventoryReportEmailSubject();
		      const replyTo = getSignedInEmail();
		      const apiUrl = getOrderApiUrl();

		      const headers = { 'content-type': 'application/json' };
		      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
		      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
		      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
		        headers['apikey'] = sbKey;
		        if(SB.session && SB.session.access_token){
		          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
		        }
		      }

		      const res = await fetch(apiUrl, {
		        method: 'POST',
		        headers,
		        body: JSON.stringify({ to, subject, html: String(html || ''), replyTo }),
		      });
		      let data = null;
		      try { data = await res.json(); } catch {}
		      if(!res.ok || !data || data.ok !== true){
		        const msg = (data && data.error) ? String(data.error) : `Send failed (${res.status})`;
		        throw Object.assign(new Error(msg), { status: res.status, data });
		      }
		      return data;
		    }

		    async function shareInventoryReport(){
		      openReportEmailModal();
		    }
		    function lowStockAlertsSilenced(){
		      try{
		        if(SB && SB.profile && typeof SB.profile.silence_low_stock_alerts !== 'undefined'){
		          return !!SB.profile.silence_low_stock_alerts;
		        }
	      }catch(e){}
	      try{
	        const raw = localStorage.getItem('inv.pref.silenceLowStockAlerts');
	        return raw === '1' || raw === 'true';
		      }catch(e){ return false; }
		    }
		    let _reportLoadToken = 0;
		    function setReportLoading(isLoading){
		      const prog = $('reportProgress');
		      const content = $('reportContent');
		      if(prog) prog.style.display = isLoading ? 'block' : 'none';
		      if(content) content.style.display = isLoading ? 'none' : 'block';
		    }
		    function setReportProgress(progress, label){
		      const p = Math.max(0, Math.min(100, Math.round(Number(progress) || 0)));
		      const labelEl = $('reportProgressLabel');
		      const valueEl = $('reportProgressValue');
		      const barEl = $('reportProgressBar');
		      const trackEl = $('reportProgress')?.querySelector('.report-progress-track');
		      if(labelEl && typeof label === 'string') labelEl.textContent = label;
		      if(valueEl) valueEl.textContent = `${p}%`;
		      if(barEl) barEl.style.width = `${p}%`;
		      if(trackEl) trackEl.setAttribute('aria-valuenow', String(p));
		    }
		    function simulateReportProgress(token){
		      let progress = 0;
		      const baseMs = 1000;
		      const phaseOneTarget = 40 + Math.random() * 10; // 40â€“50%
		      let phaseTwo = false;
		      let label = 'Analyzing Low Stock Items...';
		      const start = performance.now();
		      setReportProgress(0, label);

		      const tick = () => {
		        if(token !== _reportLoadToken) return;
		        const modal = $('reportModal');
		        if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;

		        const elapsed = performance.now() - start;
		        const timeCap = Math.min(100, (elapsed / baseMs) * 100 + 12);
		        const increment = (Math.random() * 9) + 3; // 3â€“12%
		        progress = Math.min(progress + increment, timeCap, 100);

		        if(!phaseTwo && progress >= phaseOneTarget){
		          phaseTwo = true;
		          label = 'Generating Current Inventory...';
		        }
		        setReportProgress(progress, label);

		        if(progress >= 100 || elapsed >= baseMs){
		          setReportProgress(100, label);
		          finishReportLoad(token);
		          return;
		        }

		        let delay = (Math.random() * 100) + 50; // 50â€“150ms
		        if(Math.random() < 0.14) delay += (Math.random() * 250) + 200; // occasional pause
		        setTimeout(tick, delay);
		      };
		      tick();
		    }
			    function finishReportLoad(token){
			      if(token !== _reportLoadToken) return;
			      setReportLoading(false);
			      renderInventoryReport();
			      const lowSection = $('reportLowStockSection'); if(lowSection) lowSection.open = false;
			      const exemptSection = $('reportExemptSection'); if(exemptSection) exemptSection.open = false;
			      const invSection = $('reportInventorySection'); if(invSection) invSection.open = false;
			      try{ syncReportOrderIndicators(); }catch(e){}
			    }
			    function startReportLoad(){
			      _reportLoadToken++;
			      const token = _reportLoadToken;
			      setReportLoading(true);
			      const lowSection = $('reportLowStockSection'); if(lowSection) lowSection.open = false;
			      const exemptSection = $('reportExemptSection'); if(exemptSection) exemptSection.open = false;
			      const invSection = $('reportInventorySection'); if(invSection) invSection.open = false;
			      simulateReportProgress(token);
			    }
				    function openReportModal(){
				      show('reportModal', true);
				      startReportLoad();
				    }
		    function closeReportModal(){
		      _reportLoadToken++;
		      show('reportModal', false);
		    }

	    // ========================
	    // Order engine (email-based)
	    // ========================
	    function getSignedInEmail(){
      return (SB && SB.user && SB.user.email) ? String(SB.user.email).trim() : '';
    }
    function userNameFromEmail(email){
      const e = String(email || '').trim();
      const local = e.includes('@') ? e.split('@')[0] : e;
      const cleaned = local
        .replace(/[._-]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      if(!cleaned) return '';
      return cleaned
        .split(' ')
        .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : '')
        .join(' ')
        .trim();
    }
    function formatStateToken(token){
      const t = String(token || '').trim().replace(/[.,]$/,'');
      if(!t) return '';
      if(t.length === 2) return t.toUpperCase();
      return t
        .split(/[\s_-]+/)
        .map(w => w ? (w[0].toUpperCase() + w.slice(1).toLowerCase()) : '')
        .join(' ')
        .trim();
    }
    function formatEasternDateTime(value){
      const d = (value instanceof Date) ? value : new Date(value);
      try{
        return new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/New_York',
          year: 'numeric',
          month: 'short',
          day: '2-digit',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true,
          timeZoneName: 'short',
        }).format(d);
      }catch{
        return d.toLocaleString(undefined, { hour12:true });
      }
    }
    function formatDateShort(value){
      if(!value) return '';
      const d = (value instanceof Date) ? value : new Date(value);
      if(Number.isNaN(d.getTime())) return String(value);
      try{
        return new Intl.DateTimeFormat('en-US', {
          year: 'numeric',
          month: 'short',
          day: '2-digit',
        }).format(d);
      }catch{
        return d.toLocaleDateString();
      }
    }
	    function getOrderCompanyName(){
	      const name = SB && SB.company && SB.company.company_name ? String(SB.company.company_name).trim() : '';
	      return name;
	    }
	    function generateInternalPoNumber(){
	      const digits = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
	      const letters = 'ABCDEFGHJKMNPQRSTVWXYZ';
	      let suffix = '';
	      for(let i = 0; i < 4; i++){
	        const idx = Math.floor(Math.random() * letters.length);
	        suffix += letters.charAt(idx);
	      }
	      return `${digits}-${suffix}`;
	    }
	    function ensureOrderIdentifiers(ord){
	      if(!ord) return;
	      if(!ord.internalPoNumber) ord.internalPoNumber = generateInternalPoNumber();
	    }
	    function getOrderIdentifier(ord){
	      if(!ord) return '';
	      const companyPo = String(ord.companyPoNumber || '').trim();
	      if(companyPo) return companyPo;
	      ensureOrderIdentifiers(ord);
	      return String(ord.internalPoNumber || '').trim();
	    }
	    function composeOrderSubject(ord){
	      const companyName = getOrderCompanyName();
	      if(!companyName) return '';
	      const po = getOrderIdentifier(ord);
	      return po ? `Purchase Order ${po} \u2013 ${companyName}` : `Purchase Order \u2013 ${companyName}`;
	    }
    function orderActiveLines(){
      const ord = orderState();
      return ord.lines
        .filter(l => toInt(l.qty, 0) > 0)
        .slice()
        .sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
    }
    function orderState(){
      if(!state._order){
        state._order = { lines:[], email:'', companyPoNumber:'', internalPoNumber:'', subject:'', notes:'', contactName:'', search:'', shippingAddressId:'', shippingAddressSnapshot:null };
      }
      ensureOrderIdentifiers(state._order);
      return state._order;
    }
    function resetOrderIdentifiers(){
      const ord = orderState();
      ord.companyPoNumber = '';
      ord.internalPoNumber = generateInternalPoNumber();
      ord.subject = composeOrderSubject(ord);
    }
    const orderLineSelection = new Set();
    function pruneOrderLineSelection(lines){
      const ids = new Set((lines || []).map(l => String(l && l.id ? l.id : '').trim()).filter(Boolean));
      for(const id of Array.from(orderLineSelection)){
        if(!ids.has(id)) orderLineSelection.delete(id);
      }
    }
    function orderLineSelectedIds(){
      return Array.from(orderLineSelection);
    }
    function setOrderLineSelected(id, selected){
      const key = String(id || '').trim();
      if(!key) return;
      if(selected) orderLineSelection.add(key);
      else orderLineSelection.delete(key);
    }
    function updateOrderCounterBadge(){
      const ord = orderState();
      const count = ord.lines.length;
      // Update new main pill (below totals)
      const pillContainer = $('orderPillContainer');
      const pillValue = $('orderPillValue');
      const pill = $('orderPill');
      if(pillContainer){
        if(count > 0){
          pillContainer.style.display = 'flex';
          if(pillValue) pillValue.textContent = String(count);
          const labelEl = pill && pill.querySelector('.order-pill-label');
          if(labelEl) labelEl.textContent = count === 1 ? 'Item in Cart' : 'Items in Cart';
        }else{
          pillContainer.style.display = 'none';
        }
      }
      try{
        const modal = $('reportModal');
        const content = $('reportContent');
        if(modal && modal.getAttribute('aria-hidden') === 'false' && content && content.style.display !== 'none'){
          renderInventoryReport();
        }else{
          syncReportOrderIndicators();
        }
      }catch(e){}
    }
    function clearAllOrderLines(){
      const ord = orderState();
      const ids = ord.lines.map(l => l.id);
      ord.lines = [];
      try{ orderLineSelection.clear(); }catch(e){}
      ids.forEach(id => { try{ syncOrderIndicatorForRow(String(id)); }catch(e){} });
      updateOrderCounterBadge();
    }
    function getInventoryById(id){
      return state.items.find(x => x && x.id === id) || null;
    }
    function getOrderQtyForItem(id){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      return line ? toInt(line.qty, 0) : 0;
    }
	    function upsertOrderLineFromItem(it, qty = 1){
	      const ord = orderState();
	      if(!it || !it.id) return false;
	      if(ord.lines.some(l => l.id === it.id)) return false;
	      ord.lines.push({ id: it.id, name: String(it.name||'').trim(), desc: String(it.desc||'').trim(), qty: toInt(qty, 1) });
	      ord.lines.sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
	      try{ syncOrderIndicatorForRow(String(it.id)); }catch(e){}
	      try{ updateOrderCounterBadge(); }catch(e){}
	      return true;
	    }
	    function removeOrderLine(id){
	      const ord = orderState();
	      ord.lines = ord.lines.filter(l => l.id !== id);
	      try{ orderLineSelection.delete(String(id || '').trim()); }catch(e){}
	      try{ syncOrderIndicatorForRow(String(id)); }catch(e){}
	      try{ updateOrderCounterBadge(); }catch(e){}
	    }
    function setOrderQty(id, qty){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      if(!line) return;
      line.qty = toInt(qty, 0);
    }
    function normalizeEmailLineItems(lineItems){
      const arr = Array.isArray(lineItems) ? lineItems : [];
      return arr
        .map((x) => {
          const item_id = String(x?.item_id || x?.itemId || x?.id || '').trim();
          const part = String(x?.part || x?.name || x?.item || '').trim();
          const desc = String(x?.desc || x?.description || '').trim();
          const qty = toInt(x?.qty, 0);
          return { item_id, part, desc, qty };
        })
        .filter((x) => x.part && x.qty > 0)
        .sort((a,b)=> toKey(a.part).localeCompare(toKey(b.part)));
    }
    function normalizeShippingSnapshot(value){
      if(!value || typeof value !== 'object') return null;
      const label = String(value.label || '').trim();
      const address = String(value.address || '').trim();
      if(!label && !address) return null;
      return { label, address };
    }
    function formatShippingSnapshotLines(value){
      const snap = normalizeShippingSnapshot(value);
      if(!snap) return [];
      const lines = [];
      if(snap.label) lines.push(snap.label);
      if(snap.address) lines.push(snap.address);
      return lines;
    }
    function buildOrderBodyFromData({ subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim();
      const out = [];

      out.push(subject);
      out.push(`Date: ${when}`);
      if(companyName) out.push(`Company: ${companyName}`);
      if(companyPoNumber) out.push(`Company PO: ${companyPoNumber}`);
      if(internalPoNumber) out.push(`Internal PO: ${internalPoNumber}`);
      out.push('');
      out.push('Items:');
      out.push('');

      const active = normalizeEmailLineItems(lineItems);
      if(!active.length){
        out.push('(none)');
      }else{
        const parts = active.map(l => String(l.part||'').trim());
        const descs = active.map(l => String(l.desc||'').trim());
        const partW = Math.min(25, Math.max(4, ...parts.map(p => p.length)));
        const descW = Math.min(35, Math.max(11, ...descs.map(d => d.length)));
        const qtyW = Math.min(6, Math.max(3, ...active.map(l => String(toInt(l.qty, 0)).length)));
        out.push(`${'Item'.padEnd(partW)} | ${'Description'.padEnd(descW)} | ${'Qty'.padStart(qtyW)}`);
        out.push(`${'-'.repeat(partW)}-+-${'-'.repeat(descW)}-+-${'-'.repeat(qtyW)}`);
        for(const l of active){
          const part = String(l.part||'').replace(/\t/g,' ').trim();
          const desc = String(l.desc||'').replace(/\t/g,' ').trim();
          const qty = String(toInt(l.qty, 0)).padStart(qtyW, ' ');
          out.push(`${part.padEnd(partW)} | ${desc.padEnd(descW)} | ${qty}`);
        }
      }

      const nt = String(notes||'').trim();
      if(nt){
        out.push('');
        out.push('Notes:');
        out.push(nt);
      }

      // Add sender info from profile
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const deliveryLines = [];
      if(fullName) deliveryLines.push(fullName);
      if(userPhone) deliveryLines.push(userPhone);
      if(userEmail) deliveryLines.push(userEmail);

      if(deliveryLines.length){
        out.push('');
        out.push('Contact:');
        for(const line of deliveryLines) out.push(line);
      }

      const shippingLines = formatShippingSnapshotLines(shippingAddress);
      if(shippingLines.length){
        out.push('');
        out.push('Shipping Address:');
        for(const line of shippingLines) out.push(line);
      }

      out.push('');
      out.push('contact@modulus-software.com');
      return out.join('\n');
    }
    function buildOrderHtmlFromData({ subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim();

      const active = normalizeEmailLineItems(lineItems);
      const rows = active.map(l=>{
        const part = escapeHtml(String(l.part||'').trim());
        const desc = escapeHtml(String(l.desc||'').trim());
        const qty = toInt(l.qty, 0);
        return (
          `<tr>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;font-weight:600;">${part}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;">${desc}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;text-align:right;font-variant-numeric:tabular-nums;font-weight:700;">${qty}</td>`+
          `</tr>`
        );
      }).join('');

      const notesRaw = String(notes||'').trim();
      const notesHtml = notesRaw ? escapeHtml(notesRaw).replace(/\n/g, '<br>') : '';

      // Build contact + shipping blocks
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const contactLines = [];
      if(fullName) contactLines.push(escapeHtml(fullName));
      if(userPhone) contactLines.push(escapeHtml(userPhone));
      if(userEmail) contactLines.push(`<a href="mailto:${escapeHtmlAttr(userEmail)}" style="color:#0969da;text-decoration:underline;">${escapeHtml(userEmail)}</a>`);

      const contactBlock = contactLines.length
        ? (
          `<div style="margin:16px 0 16px;padding:12px;background:#f6f8fa;border:1px solid #d0d7de;border-radius:6px;">`+
            `<div style="font-weight:700;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Contact</div>`+
            `<div style="font-size:14px;line-height:1.5;">${contactLines.join('<br>')}</div>`+
          `</div>`
        )
        : '';

      const shippingLines = formatShippingSnapshotLines(shippingAddress);
      const shippingBlock = shippingLines.length
        ? (
          `<div style="margin:16px 0 16px;padding:12px;background:#f6f8fa;border:1px solid #d0d7de;border-radius:6px;">`+
            `<div style="font-weight:700;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Shipping Address</div>`+
            `<div style="font-size:14px;line-height:1.5;">${shippingLines.map(l => escapeHtml(l).replace(/\\n/g, '<br>')).join('<br>')}</div>`+
          `</div>`
        )
        : '';

      const metaLines = [];
      if(companyName) metaLines.push(`<div><strong>Company:</strong> ${escapeHtml(companyName)}</div>`);
      if(companyPoNumber) metaLines.push(`<div><strong>Company PO:</strong> ${escapeHtml(companyPoNumber)}</div>`);
      if(internalPoNumber) metaLines.push(`<div><strong>Internal PO:</strong> ${escapeHtml(internalPoNumber)}</div>`);
      const metaBlock = metaLines.length
        ? `<div style="margin:12px 0 0;font-size:14px;line-height:1.5;">${metaLines.join('')}</div>`
        : '';

      const notesBlock = notesHtml
        ? (
          `<div style="margin-top:16px;">`+
            `<div style="font-weight:700;margin-bottom:6px;">Notes</div>`+
            `<div>${notesHtml}</div>`+
          `</div>`
        )
        : '';

      const itemsBlock = active.length
        ? (
          `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;table-layout:fixed;">`+
            `<colgroup>`+
              `<col style="width:35%;">`+
              `<col style="width:50%;">`+
              `<col style="width:15%;">`+
            `</colgroup>`+
            `<thead>`+
              `<tr>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Item</th>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Description</th>`+
                `<th align="right" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Qty</th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>${rows}</tbody>`+
          `</table>`
        )
        : `<div style="padding:12px;border:1px dashed #d0d7de;color:#444;">(No items)</div>`;

      const brandLogo = buildModulusLogoHtml({ width: 200, color: '#111', marginTop: 18 });
      const brandLine = `<div style="margin-top:8px;font-size:12px;color:#6a737d;text-align:center;">contact@modulus-software.com</div>`;

      return (
        `<!doctype html>`+
        `<html><body style="margin:0;padding:0;background:#ffffff;">`+
        `<div style="max-width:620px;margin:0 auto;padding:18px 16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.35;">`+
          `<h2 style="margin:0 0 10px;font-size:18px;">${escapeHtml(subject)}</h2>`+
          `<div style="font-size:13px;color:#444;margin:0 0 16px;">`+
            `<div style="margin:2px 0;"><strong>Date:</strong> ${escapeHtml(when)}</div>`+
            `${metaBlock}`+
          `</div>`+
          `<div style="margin:0 0 10px;">Please supply the following materials:</div>`+
          `${itemsBlock}`+
          `${notesBlock}`+
          `${contactBlock}`+
          `${shippingBlock}`+
          `${brandLogo}`+
          `${brandLine}`+
        `</div>`+
        `</body></html>`
      );
    }
    function looksLikeEmailAddress(email){
      const s = String(email || '').trim();
      if(!s) return false;
      if(s.length > 254) return false;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    }
    function getOrderShippingSnapshot(ord){
      if(!ord) return null;
      const direct = normalizeShippingSnapshot(ord.shippingAddressSnapshot);
      if(direct) return direct;
      const id = String(ord.shippingAddressId || '').trim();
      if(!id) return null;
      const row = (state._orderShippingById && typeof state._orderShippingById.get === 'function'
        ? state._orderShippingById.get(id)
        : null)
        || (state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
          ? state._shippingAddressById.get(id)
          : null);
      if(!row) return null;
      return normalizeShippingSnapshot({ label: row.label, address: row.address });
    }
    function buildOrderBody(){
      const ord = orderState();
      const subjectLine = composeOrderSubject(ord);
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shippingAddress = getOrderShippingSnapshot(ord);
      const companyName = getOrderCompanyName();
      const companyPoNumber = String(ord.companyPoNumber||'').trim();
      const internalPoNumber = String(ord.internalPoNumber||'').trim();
      return buildOrderBodyFromData({ subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
    }
    function buildOrderHtml(){
      const ord = orderState();
      const subjectLine = composeOrderSubject(ord);
      const notesRaw = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shippingAddress = getOrderShippingSnapshot(ord);
      const companyName = getOrderCompanyName();
      const companyPoNumber = String(ord.companyPoNumber||'').trim();
      const internalPoNumber = String(ord.internalPoNumber||'').trim();
      return buildOrderHtmlFromData({ subjectLine, notes: notesRaw, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
    }
    function buildMailtoUrl(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const subject = composeOrderSubject(ord);
      const body = buildOrderBody();
      if(!to) return '';
      return `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    function getOrderApiUrl(){
      // Allow explicit override via window.ORDER_API_URL
      const override = (typeof window.ORDER_API_URL === 'string') ? window.ORDER_API_URL.trim() : '';
      if(override) return override;
      // Use Supabase Edge Function if available
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/send-order`;
      // Fallback to local dev server
      return '/api/send-order';
    }
    async function sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber }){
      const toEmail = String(to||'').trim();
      const replyTo = getSignedInEmail();
      const subject = String(subjectLine||'').trim();
      const text = buildOrderBodyFromData({ subjectLine: subject, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
      const html = buildOrderHtmlFromData({ subjectLine: subject, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
      const apiUrl = getOrderApiUrl();

      // Build headers - include Supabase auth if using Edge Function
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        // Add auth token if user is signed in
        if(SB.session && SB.session.access_token){
          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
        }
      }

      const payload = {
        to: toEmail,
        subject,
        text,
        html,
        replyTo,
      };
      if(SB.companyId){
        payload.company_id = SB.companyId;
      }

      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify(payload),
      });
      let data = null;
      try { data = await res.json(); } catch {}
      if(!res.ok || !data || data.ok !== true){
        const msg = (data && data.error) ? String(data.error) : `Send failed (${res.status})`;
        throw Object.assign(new Error(msg), { status: res.status, data });
      }
      return data;
    }
    async function sendOrderViaApi(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const companyName = getOrderCompanyName();
      if(!companyName) throw new Error('Company name is required to send orders');
      const subjectLine = composeOrderSubject(ord);
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      const shippingAddress = getOrderShippingSnapshot(ord);
      const companyPoNumber = String(ord.companyPoNumber||'').trim();
      const internalPoNumber = String(ord.internalPoNumber||'').trim();
      return sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems, shippingAddress, companyName, companyPoNumber, internalPoNumber });
    }
    async function copyText(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return;
      }
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position='fixed';
      ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
    async function copyOrderToClipboard(){
      try{
        await copyText(buildOrderBody());
        toast('Copied order text');
      }catch{
        toast('Copy failed');
      }
    }

    function setShippingAddressMessage(msg){
      const el = $('shippingAddressMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function clearShippingAddressForm(){
      state._shippingAddressEditing = null;
      const label = $('shippingAddressLabel'); if(label) label.value = '';
      const address = $('shippingAddressValue'); if(address) address.value = '';
      const isDefault = $('shippingAddressDefault'); if(isDefault) isDefault.checked = false;
      const title = $('shippingAddressFormTitle'); if(title) title.textContent = 'Add Shipping Address';
      setShippingAddressMessage('');
    }
    function renderShippingAddressList(){
      const list = $('shippingAddressList');
      if(!list) return;
      const rows = Array.isArray(state._shippingAddresses) ? state._shippingAddresses : [];
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">No shipping addresses yet.</div>`;
        return;
      }
      list.innerHTML = rows.map(row => {
        const id = String(row.id || '').trim();
        const label = String(row.label || '').trim();
        const address = String(row.address || '').trim();
        const isDefault = !!row.is_default;
        const meta = [isDefault ? 'Default' : '', id ? `ID: ${id.slice(0,8)}` : ''].filter(Boolean).join(' Â· ');
        return (
          `<div class="shipping-address-card" data-shipping-id="${escapeHtmlAttr(id)}">`+
            `<div>`+
              `<div style="font-weight:700;">${escapeHtml(label || 'Address')}</div>`+
              `<div class="shipping-address-meta">${escapeHtml(meta)}</div>`+
              `<div style="margin-top:6px;white-space:pre-wrap;">${escapeHtml(address)}</div>`+
            `</div>`+
            `<div class="shipping-address-actions">`+
              `<button class="btn-tertiary btn-sm" type="button" data-shipping-edit="${escapeHtmlAttr(id)}">Edit</button>`+
              `<button class="btn-tertiary btn-sm btn-danger" type="button" data-shipping-delete="${escapeHtmlAttr(id)}">Delete</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    function renderShippingAddressSelect(){
      const select = $('orderShippingAddress');
      if(!select) return;
      const rows = Array.isArray(state._orderShippingOptions) ? state._orderShippingOptions : [];
      select.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = rows.length ? 'Select shipping location' : 'No locations';
      placeholder.disabled = !rows.length;
      select.appendChild(placeholder);
      rows.forEach(row => {
        const id = String(row && row.id ? row.id : '').trim();
        if(!id) return;
        const opt = document.createElement('option');
        opt.value = id;
        opt.textContent = String(row.label || row.address || id).trim();
        select.appendChild(opt);
      });
      const ord = orderState();
      if(ord.shippingAddressId && !rows.some(r => String(r.id) === String(ord.shippingAddressId))){
        ord.shippingAddressId = '';
        ord.shippingAddressSnapshot = null;
      }
      if(!ord.shippingAddressId && rows.length){
        const def = rows.find(r => r && r.is_default) || rows[0];
        ord.shippingAddressId = def ? String(def.id) : '';
        ord.shippingAddressSnapshot = def ? { label: def.label, address: def.address } : null;
      }
      select.value = ord.shippingAddressId || '';
      const manageBtn = $('btnOrderShippingManage');
      if(manageBtn){
        manageBtn.disabled = !canAccessCompanyLocations();
        manageBtn.style.display = canAccessCompanyLocations() ? '' : 'none';
      }
    }
    function mapLocationToOrderShipping(row){
      if(!row) return null;
      const id = String(row.id || '').trim();
      if(!id) return null;
      const label = String(row.name || '').trim() || 'Location';
      return {
        id,
        label,
        address: formatLocationAddress(row),
        is_default: !!row.is_default_ship_to,
        source: 'location'
      };
    }
    function buildOrderShippingOptions(locationRows){
      const options = [];
      const seen = new Set();
      const add = (opt) => {
        if(!opt || !opt.id || seen.has(opt.id)) return;
        seen.add(opt.id);
        options.push(opt);
      };
      (locationRows || []).forEach(row => add(mapLocationToOrderShipping(row)));
      return options;
    }
    async function sbFetchOrderShippingLocations(){
      if(!SB.ready || !SB.session || !SB.companyId) return [];
      const { data, error } = await SB.client
        .from('company_locations')
        .select('id,name,location_type,address_line1,address_line2,city,state_region,postal_code,country_code,is_active,is_default_ship_to')
        .eq('company_id', SB.companyId)
        .eq('is_active', true)
        .order('is_default_ship_to', { ascending:false })
        .order('name', { ascending:true });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function loadOrderShippingOptions(){
      let locations = [];
      try{
        locations = await sbFetchOrderShippingLocations();
      }catch(e){
        if(!isMissingRelationError(e)){
          console.warn('Order shipping locations load failed:', e);
        }
      }
      const options = buildOrderShippingOptions(locations);
      state._orderShippingOptions = options;
      state._orderShippingById = new Map(options.map(r => [String(r.id || '').trim(), r]).filter(x => x[0]));
      renderShippingAddressSelect();
    }
    async function sbFetchShippingAddresses(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
      if(!canOrdersView()) return [];
      const { data, error } = await SB.client
        .from('company_shipping_addresses')
        .select('id,label,address,is_default,created_at,updated_at')
        .eq('company_id', SB.companyId)
        .order('is_default', { ascending:false })
        .order('label', { ascending:true });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function loadShippingAddresses(){
      const rows = await sbFetchShippingAddresses();
      state._shippingAddresses = rows;
      state._shippingAddressById = new Map(rows.map(r => [String(r.id || '').trim(), r]).filter(x => x[0]));
      renderShippingAddressList();
    }
    async function openShippingAddressModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!canOrdersManageShipping()){ toast('Shipping address permissions required'); return; }
      clearShippingAddressForm();
      show('shippingAddressModal', true);
      try{ await loadShippingAddresses(); }catch(e){ setShippingAddressMessage(e && e.message ? e.message : 'Failed to load addresses'); }
    }
    function closeShippingAddressModal(){
      show('shippingAddressModal', false);
    }
    async function saveShippingAddress(){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
      if(!canOrdersManageShipping()) throw new Error('Permission denied');
      const label = String($('shippingAddressLabel')?.value || '').trim();
      const address = String($('shippingAddressValue')?.value || '').trim();
      const isDefault = !!($('shippingAddressDefault')?.checked);
      if(!label || !address) throw new Error('Label and address are required');
      if(isDefault){
        await SB.client
          .from('company_shipping_addresses')
          .update({ is_default: false })
          .eq('company_id', SB.companyId);
      }
      const payload = {
        company_id: SB.companyId,
        label,
        address,
        is_default: isDefault,
        updated_at: new Date().toISOString(),
        updated_by: SB.user ? SB.user.id : null,
      };
      if(state._shippingAddressEditing){
        payload.id = state._shippingAddressEditing;
      }else{
        payload.created_by = SB.user ? SB.user.id : null;
      }
      const { error } = await SB.client
        .from('company_shipping_addresses')
        .upsert([payload], { onConflict: 'id' });
      if(error) throw error;
      await loadShippingAddresses();
      clearShippingAddressForm();
      renderOrderPreview();
    }
    async function deleteShippingAddress(id){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
      if(!canOrdersManageShipping()) throw new Error('Permission denied');
      const addrId = String(id || '').trim();
      if(!addrId) return;
      const { error } = await SB.client
        .from('company_shipping_addresses')
        .delete()
        .eq('id', addrId)
        .eq('company_id', SB.companyId);
      if(error) throw error;
      await loadShippingAddresses();
      const ord = orderState();
      if(String(ord.shippingAddressId || '') === addrId){
        ord.shippingAddressId = '';
        ord.shippingAddressSnapshot = null;
        renderOrderPreview();
      }
    }

    const LOCATION_COUNTRY_OPTIONS = [
      { code:'US', label:'United States' },
      { code:'CA', label:'Canada' },
      { code:'MX', label:'Mexico' },
      { code:'GB', label:'United Kingdom' },
      { code:'IE', label:'Ireland' },
      { code:'AU', label:'Australia' },
      { code:'NZ', label:'New Zealand' },
      { code:'DE', label:'Germany' },
      { code:'FR', label:'France' },
      { code:'ES', label:'Spain' },
      { code:'IT', label:'Italy' },
      { code:'NL', label:'Netherlands' },
      { code:'SE', label:'Sweden' },
      { code:'NO', label:'Norway' },
      { code:'DK', label:'Denmark' },
      { code:'CH', label:'Switzerland' },
      { code:'AT', label:'Austria' },
      { code:'BE', label:'Belgium' },
      { code:'PT', label:'Portugal' },
      { code:'JP', label:'Japan' }
    ];
    function setCompanyLocationsMessage(msg){
      const el = $('companyLocationsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setCompanyLocationEditorMessage(msg){
      const el = $('companyLocationEditorMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function formatLocationTypeLabel(value){
      return formatStateToken(value || '');
    }
    function formatLocationAddress(row){
      const line1 = String(row && row.address_line1 ? row.address_line1 : '').trim();
      const line2 = String(row && row.address_line2 ? row.address_line2 : '').trim();
      const city = String(row && row.city ? row.city : '').trim();
      const region = String(row && row.state_region ? row.state_region : '').trim();
      const postal = String(row && row.postal_code ? row.postal_code : '').trim();
      const country = String(row && row.country_code ? row.country_code : '').trim();
      let cityLine = '';
      if(city && region) cityLine = `${city}, ${region}`;
      else cityLine = city || region;
      if(postal) cityLine = cityLine ? `${cityLine} ${postal}` : postal;
      const parts = [line1, line2, cityLine, country].filter(Boolean);
      return parts.join('\n');
    }
    function renderCompanyLocationsList(){
      const list = $('companyLocationsList');
      if(!list) return;
      const rows = Array.isArray(state._companyLocations) ? state._companyLocations : [];
      if(!rows.length){
        list.innerHTML = `<div class="order-empty">No locations yet. Add your first location to enable receiving.</div>`;
        return;
      }
      const canManage = canManageCompanyLocations();
      list.innerHTML =
        `<div class="pending-invites-table-wrap">`+
          `<table class="metrics-table company-locations-table">`+
            `<thead>`+
              `<tr>`+
                `<th>Name</th>`+
                `<th>Type</th>`+
                `<th>Address</th>`+
                `<th>Status</th>`+
                `<th>Defaults</th>`+
                `<th></th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>`+
              rows.map(row => {
                const id = String(row && row.id ? row.id : '').trim();
                const name = String(row && row.name ? row.name : '').trim() || 'Location';
                const type = formatLocationTypeLabel(row && row.location_type ? row.location_type : '');
                const address = formatLocationAddress(row || {});
                const active = !!(row && row.is_active);
                const statusText = active ? 'Active' : 'Archived';
                const statusClass = active ? 'active' : 'archived';
                const shipDefault = !!(row && row.is_default_ship_to);
                const receiveDefault = !!(row && row.is_default_receive_at);
                const badges = [
                  shipDefault ? `<span class="company-location-badge ship">Ship-To</span>` : '',
                  receiveDefault ? `<span class="company-location-badge receive">Receive-At</span>` : ''
                ].filter(Boolean).join('');
                const disableActions = !canManage;
                const editIcon = canManage
                  ? `<button class="icon-btn icon-btn--default company-location-edit-btn" type="button" data-location-edit="${escapeHtmlAttr(id)}"${disableActions ? ' disabled aria-disabled=\"true\"' : ''} title="Edit location" aria-label="Edit location">`+
                      `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
                        `<path d="M12 20h9"></path>`+
                        `<path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>`+
                      `</svg>`+
                    `</button>`
                  : `<span class="muted">Read-only</span>`;
                const defaultShipBtn = active
                  ? `<button class="btn-tertiary btn-sm" type="button" data-location-default="${escapeHtmlAttr(id)}" data-default-type="ship_to"${disableActions || shipDefault ? ' disabled aria-disabled=\"true\"' : ''}>Set Ship-To</button>`
                  : '';
                const defaultReceiveBtn = active
                  ? `<button class="btn-tertiary btn-sm" type="button" data-location-default="${escapeHtmlAttr(id)}" data-default-type="receive_at"${disableActions || receiveDefault ? ' disabled aria-disabled=\"true\"' : ''}>Set Receive-At</button>`
                  : '';
                const archiveBtn = active
                  ? `<button class="btn-tertiary btn-sm btn-danger" type="button" data-location-archive="${escapeHtmlAttr(id)}"${disableActions ? ' disabled aria-disabled=\"true\"' : ''}>Archive</button>`
                  : '';
                const restoreBtn = !active
                  ? `<button class="btn-tertiary btn-sm" type="button" data-location-restore="${escapeHtmlAttr(id)}"${disableActions ? ' disabled aria-disabled=\"true\"' : ''}>Restore</button>`
                  : '';
                return (
                  `<tr data-location-id="${escapeHtmlAttr(id)}">`+
                    `<td>`+
                      `<div class="company-location-name-row">`+
                        `<div class="company-location-name">${escapeHtml(name)}</div>`+
                        `${editIcon}`+
                      `</div>`+
                      `<div class="muted" style="font-size:12px;">ID: ${escapeHtml(id.slice(0,8))}</div>`+
                    `</td>`+
                    `<td>${escapeHtml(type || 'Other')}</td>`+
                    `<td class="company-location-address">${escapeHtml(address)}</td>`+
                    `<td><span class="company-location-status ${statusClass}">${statusText}</span></td>`+
                    `<td><div class="company-location-badges">${badges || '<span class=\"muted\">None</span>'}</div></td>`+
                    `<td>`+
                      `<div class="company-location-actions">`+
                        defaultShipBtn+
                        defaultReceiveBtn+
                        archiveBtn+
                        restoreBtn+
                      `</div>`+
                    `</td>`+
                  `</tr>`
                );
              }).join('')+
            `</tbody>`+
          `</table>`+
        `</div>`;
    }
    function renderCompanyLocationCountryOptions(selected){
      const select = $('companyLocationCountry');
      if(!select) return;
      const current = String(selected || select.value || '').trim().toUpperCase();
      select.innerHTML = LOCATION_COUNTRY_OPTIONS
        .map(opt => `<option value="${escapeHtmlAttr(opt.code)}"${current === opt.code ? ' selected' : ''}>${escapeHtml(opt.label)} (${escapeHtml(opt.code)})</option>`)
        .join('');
      if(current && !LOCATION_COUNTRY_OPTIONS.some(opt => opt.code === current)){
        const custom = document.createElement('option');
        custom.value = current;
        custom.textContent = `${current} (custom)`;
        custom.selected = true;
        select.appendChild(custom);
      }
    }
    async function sbFetchCompanyLocations(){
      if(!SB.ready || !SB.session || !SB.companyId) return [];
      if(!canAccessCompanyLocations()) return [];
      const { data, error } = await SB.client
        .from('company_locations')
        .select('id,company_id,name,location_type,address_line1,address_line2,city,state_region,postal_code,country_code,is_active,is_default_ship_to,is_default_receive_at,created_at,updated_at')
        .eq('company_id', SB.companyId)
        .order('is_active', { ascending:false })
        .order('name', { ascending:true });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function loadCompanyLocations(){
      const rows = await sbFetchCompanyLocations();
      state._companyLocations = rows;
      state._companyLocationById = new Map(rows.map(r => [String(r.id || '').trim(), r]).filter(x => x[0]));
      renderCompanyLocationsList();
    }
    function clearCompanyLocationForm(){
      state._companyLocationEditing = null;
      const name = $('companyLocationName'); if(name) name.value = '';
      const type = $('companyLocationType'); if(type) type.value = 'warehouse';
      setInputValueById('companyLocationAddress1', '');
      const addr2 = $('companyLocationAddress2'); if(addr2) addr2.value = '';
      const city = $('companyLocationCity'); if(city) city.value = '';
      const region = $('companyLocationState'); if(region) region.value = '';
      const postal = $('companyLocationPostal'); if(postal) postal.value = '';
      renderCompanyLocationCountryOptions('US');
      const ship = $('companyLocationDefaultShipTo'); if(ship){ ship.checked = false; ship.disabled = false; }
      const receive = $('companyLocationDefaultReceiveAt'); if(receive){ receive.checked = false; receive.disabled = false; }
      const title = $('companyLocationEditorTitle'); if(title) title.textContent = 'Add Location';
      setCompanyLocationEditorMessage('');
    }
    function openCompanyLocationEditor(locationId){
      const id = String(locationId || '').trim();
      if(id){
        const row = state._companyLocationById && typeof state._companyLocationById.get === 'function'
          ? state._companyLocationById.get(id)
          : null;
        if(!row) return;
        state._companyLocationEditing = id;
        const title = $('companyLocationEditorTitle'); if(title) title.textContent = row.is_active ? 'Edit Location' : 'Edit Location (Archived)';
        const name = $('companyLocationName'); if(name) name.value = row.name || '';
        const type = $('companyLocationType'); if(type) type.value = row.location_type || 'warehouse';
        setInputValueById('companyLocationAddress1', row.address_line1 || '');
        const addr2 = $('companyLocationAddress2'); if(addr2) addr2.value = row.address_line2 || '';
        const city = $('companyLocationCity'); if(city) city.value = row.city || '';
        const region = $('companyLocationState'); if(region) region.value = row.state_region || '';
        const postal = $('companyLocationPostal'); if(postal) postal.value = row.postal_code || '';
        renderCompanyLocationCountryOptions(row.country_code || 'US');
        const isArchived = !row.is_active;
        const ship = $('companyLocationDefaultShipTo');
        if(ship){
          ship.checked = !!row.is_default_ship_to;
          ship.disabled = isArchived || !!row.is_default_ship_to;
        }
        const receive = $('companyLocationDefaultReceiveAt');
        if(receive){
          receive.checked = !!row.is_default_receive_at;
          receive.disabled = isArchived || !!row.is_default_receive_at;
        }
        setCompanyLocationEditorMessage(isArchived ? 'Archived locations can be edited, but must be restored before use.' : '');
      }else{
        clearCompanyLocationForm();
      }
      show('companyLocationEditorModal', true);
      // Initialize Google Places autocomplete after modal is visible
      void ensureGooglePlacesLoaded().then((ok)=>{
        if(!ok) {
          console.warn('[Places] Google Places not available');
          return;
        }
        initAddressAutocomplete('companyLocationAddress1', {
          address1: 'companyLocationAddress1',
          address2: 'companyLocationAddress2',
          city: 'companyLocationCity',
          state: 'companyLocationState',
          postal: 'companyLocationPostal',
          country: 'companyLocationCountry'
        }, true);
      });
    }
    function closeCompanyLocationEditor(){
      show('companyLocationEditorModal', false);
    }
    async function openCompanyLocationsModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!canAccessCompanyLocations()){ toast('Company admin access required'); return; }
      const list = $('companyLocationsList');
      if(list) list.innerHTML = `<div class="muted">Loading locations...</div>`;
      setCompanyLocationsMessage('');
      show('companyLocationsModal', true);
      const btnNew = $('btnCompanyLocationNew');
      if(btnNew){
        btnNew.disabled = !canManageCompanyLocations();
        btnNew.setAttribute('aria-disabled', canManageCompanyLocations() ? 'false' : 'true');
      }
      try{
        await loadCompanyLocations();
      }catch(e){
        const msg = e && e.message ? e.message : 'Failed to load locations';
        if(isMissingRelationError(e)){
          setCompanyLocationsMessage('Locations are not available yet.');
        }else{
          setCompanyLocationsMessage(msg);
        }
      }
    }
    async function closeCompanyLocationsModal(){
      show('companyLocationsModal', false);
      const isOnboardingLocations = isOnboardingRoute() && (
        state._onboardingStep === 'locations' ||
        !!document.querySelector('[data-onboarding-step="locations"].active')
      );
      if(!isOnboardingLocations) return;
      let rows = [];
      try{
        rows = await sbFetchCompanyLocations();
      }catch(e){}
      renderOnboardingLocationsStatus(rows);
      const activeCount = Array.isArray(rows) ? rows.filter(r => r && r.is_active).length : 0;
      if(activeCount < 1) return;
      setOnboardingMessage('onboardingLocationsMsg', '');
      try{
        await advanceOnboardingState('LOCATIONS_CONFIGURED');
      }catch(e){
        setOnboardingMessage('onboardingLocationsMsg', e && e.message ? e.message : 'Unable to advance onboarding.');
        return;
      }
      setTimeout(()=>{ void handleOnboardingRoute(); }, 500);
    }
    function companyLocationFormPayload(){
      return {
        name: String($('companyLocationName')?.value || '').trim(),
        locationType: String($('companyLocationType')?.value || '').trim(),
        addressLine1: String(getInputValueById('companyLocationAddress1') || '').trim(),
        addressLine2: String($('companyLocationAddress2')?.value || '').trim(),
        city: String($('companyLocationCity')?.value || '').trim(),
        stateRegion: String($('companyLocationState')?.value || '').trim(),
        postalCode: String($('companyLocationPostal')?.value || '').trim(),
        countryCode: String($('companyLocationCountry')?.value || '').trim().toUpperCase(),
        setDefaultShipTo: !!$('companyLocationDefaultShipTo')?.checked,
        setDefaultReceiveAt: !!$('companyLocationDefaultReceiveAt')?.checked
      };
    }
    function validateCompanyLocationPayload(payload){
      if(!payload.name) return 'Name is required.';
      if(!payload.locationType) return 'Location type is required.';
      if(!payload.addressLine1) return 'Address Line 1 is required.';
      if(!payload.city) return 'City is required.';
      if(!payload.stateRegion) return 'State/Region is required.';
      if(!payload.postalCode) return 'Postal Code is required.';
      if(!payload.countryCode || payload.countryCode.length !== 2) return 'Country code is required.';
      return '';
    }
    async function saveCompanyLocation(){
      if(!SB.ready || !SB.session || !SB.companyId) return;
      if(!canManageCompanyLocations()){
        setCompanyLocationEditorMessage('Location permissions required.');
        return;
      }
      const payload = companyLocationFormPayload();
      const errorMsg = validateCompanyLocationPayload(payload);
      if(errorMsg){
        setCompanyLocationEditorMessage(errorMsg);
        return;
      }
      const btn = $('btnCompanyLocationSave');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Saving...'; }
      try{
        if(state._companyLocationEditing){
          const locationId = state._companyLocationEditing;
          const { data, error } = await SB.client.rpc('update_company_location', {
            p_location_id: locationId,
            p_name: payload.name,
            p_location_type: payload.locationType,
            p_address_line1: payload.addressLine1,
            p_address_line2: payload.addressLine2 || null,
            p_city: payload.city,
            p_state_region: payload.stateRegion,
            p_postal_code: payload.postalCode,
            p_country_code: payload.countryCode
          });
          if(error) throw error;
          if(data && data.success === false){
            throw new Error(data.error || 'Update failed');
          }
          const row = state._companyLocationById && typeof state._companyLocationById.get === 'function'
            ? state._companyLocationById.get(locationId)
            : null;
          const isActive = row ? !!row.is_active : true;
          if(isActive && payload.setDefaultShipTo && row && !row.is_default_ship_to){
            const { data: defData, error: defError } = await SB.client.rpc('set_default_location', {
              p_location_id: locationId,
              p_default_type: 'ship_to'
            });
            if(defError) throw defError;
            if(defData && defData.success === false){
              throw new Error(defData.error || 'Failed to set default ship-to');
            }
          }
          if(isActive && payload.setDefaultReceiveAt && row && !row.is_default_receive_at){
            const { data: defData, error: defError } = await SB.client.rpc('set_default_location', {
              p_location_id: locationId,
              p_default_type: 'receive_at'
            });
            if(defError) throw defError;
            if(defData && defData.success === false){
              throw new Error(defData.error || 'Failed to set default receive-at');
            }
          }
        }else{
          const { data, error } = await SB.client.rpc('create_company_location', {
            p_company_id: SB.companyId,
            p_name: payload.name,
            p_location_type: payload.locationType,
            p_address_line1: payload.addressLine1,
            p_address_line2: payload.addressLine2 || null,
            p_city: payload.city,
            p_state_region: payload.stateRegion,
            p_postal_code: payload.postalCode,
            p_country_code: payload.countryCode,
            p_set_default_ship_to: payload.setDefaultShipTo,
            p_set_default_receive_at: payload.setDefaultReceiveAt
          });
          if(error) throw error;
          if(data && data.success === false){
            throw new Error(data.error || 'Create failed');
          }
        }
        await loadCompanyLocations();
        closeCompanyLocationEditor();
        clearCompanyLocationForm();
        toast('Location saved');
        const isOnboardingLocations = isOnboardingRoute() && (
          state._onboardingStep === 'locations' ||
          !!document.querySelector('[data-onboarding-step="locations"].active')
        );
        if(isOnboardingLocations){
          void closeCompanyLocationsModal();
        }
      }catch(e){
        setCompanyLocationEditorMessage(e && e.message ? e.message : 'Save failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Save'; }
      }
    }
    async function setDefaultCompanyLocation(locationId, defaultType){
      const id = String(locationId || '').trim();
      const type = String(defaultType || '').trim();
      if(!id || !type) return;
      if(!canManageCompanyLocations()){
        toast('Location permissions required');
        return;
      }
      const { data, error } = await SB.client.rpc('set_default_location', {
        p_location_id: id,
        p_default_type: type
      });
      if(error) throw error;
      if(data && data.success === false){
        throw new Error(data.error || 'Default update failed');
      }
      await loadCompanyLocations();
    }
    async function archiveCompanyLocation(locationId){
      const id = String(locationId || '').trim();
      if(!id) return;
      if(!canManageCompanyLocations()){
        toast('Location permissions required');
        return;
      }
      const ok = await openConfirmModal(
        'Archive location?',
        'Archived locations cannot be used for new shipments or receipts.',
        { okText:'Archive', cancelText:'Cancel' }
      );
      if(!ok) return;
      const { data, error } = await SB.client.rpc('archive_company_location', { p_location_id: id });
      if(error) throw error;
      if(data && data.success === false){
        throw new Error(data.error || 'Archive failed');
      }
      await loadCompanyLocations();
      toast('Location archived');
    }
    async function restoreCompanyLocation(locationId){
      const id = String(locationId || '').trim();
      if(!id) return;
      if(!canManageCompanyLocations()){
        toast('Location permissions required');
        return;
      }
      const { data, error } = await SB.client.rpc('restore_company_location', { p_location_id: id });
      if(error) throw error;
      if(data && data.success === false){
        throw new Error(data.error || 'Restore failed');
      }
      await loadCompanyLocations();
      toast('Location restored');
    }

    async function sbFetchOrderRecipientSuggestions(prefix){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
      if(!canOrdersView()) return [];
      const q = String(prefix||'').trim();
      let req = SB.client
        .from('order_recipients')
        .select('email,name,last_used_at')
        .eq('company_id', SB.companyId)
        .order('last_used_at', { ascending:false })
        .limit(20);
      if(q) req = req.ilike('email', q + '%');
      const { data, error } = await req;
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbRecordOrderRecipient(email, name){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return;
      if(!canOrdersCreate()) throw new Error('Permission denied');
      const e = String(email||'').trim().toLowerCase();
      if(!e) return;
      const row = {
        company_id: SB.companyId,
        email: e,
        last_used_at: new Date().toISOString(),
        created_by: SB.user ? SB.user.id : null,
      };
      const nm = String(name||'').trim();
      if(nm) row.name = nm;
      const { error } = await SB.client
        .from('order_recipients')
        .upsert([row], { onConflict: 'email' });
      if(error) throw error;
    }
    function normalizeOrderLineItems(value){
      const arr = Array.isArray(value) ? value : [];
      return arr
        .map((x) => {
          const item_id = String(x?.item_id || x?.itemId || x?.id || '').trim();
          const part = String(x?.part || x?.name || x?.item || '').trim();
          let desc = String(x?.desc || x?.description || '').trim();
          // Fallback: look up description from inventory if not stored
          if(!desc && part){
            const inv = state.items.find(it => it.name === part);
            if(inv) desc = String(inv.desc || '').trim();
          }
          const qty = toInt(x?.qty, 0);
          return { item_id, part, desc, qty };
        })
        .filter((x) => x.part);
    }
    async function sbInsertOrderHistoryFromData({ toEmail, subjectLine, contactName, notes, lineItems, providerResult, companyPoNumber, internalPoNumber, shippingAddressId, shippingAddressSnapshot }){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.user || !SB.companyId) return;
      if(!canOrdersCreate()) throw new Error('Permission denied');
      const cleaned = normalizeEmailLineItems(lineItems).map(x => ({ item_id: x.item_id ? String(x.item_id).trim() : null, part: x.part, desc: x.desc, qty: x.qty }));
      const row = {
        company_id: SB.companyId,
        created_by: SB.user.id,
        to_email: String(toEmail||'').trim(),
        reply_to_email: String(getSignedInEmail()||'').trim(),
        subject: String(subjectLine||'').trim(),
        contact_name: String(contactName||'').trim(),
        notes: String(notes||'').trim(),
        line_items: cleaned,
        provider_result: providerResult || null,
        company_po_number: String(companyPoNumber||'').trim() || null,
        internal_po_number: String(internalPoNumber||'').trim() || null,
        shipping_address_id: shippingAddressId ? String(shippingAddressId).trim() : null,
        shipping_address_snapshot: shippingAddressSnapshot || null,
      };
      const { error } = await SB.client.from('orders').insert([row]);
      if(error) throw error;
    }
    async function sbInsertOrderHistory(providerResult){
      const ord = orderState();
      const lineItems = orderActiveLines().map(l => ({ item_id: String(l.id || '').trim() || null, part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return sbInsertOrderHistoryFromData({
        toEmail: String(ord.email||'').trim(),
        subjectLine: composeOrderSubject(ord),
        contactName: String(ord.contactName||'').trim(),
        notes: String(ord.notes||'').trim(),
        lineItems,
        providerResult,
        companyPoNumber: String(ord.companyPoNumber||'').trim(),
        internalPoNumber: String(ord.internalPoNumber||'').trim(),
        shippingAddressId: ord.shippingAddressId,
        shippingAddressSnapshot: getOrderShippingSnapshot(ord),
      });
    }
	    async function sbFetchOrders(limit = 50){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
	      if(!canOrdersView()) return [];
	      const lim = Math.max(1, Math.min(200, toInt(limit, 50)));
	      const baseSelect = 'id,po_number,status,order_date,expected_date,received_date,notes,vendor_id,created_at';
	      let rows = [];
	      const { data, error } = await SB.client
	        .from('purchase_orders')
	        .select(`${baseSelect},vendor:vendors(name)`)
	        .eq('company_id', SB.companyId)
	        .order('order_date', { ascending:false })
	        .order('created_at', { ascending:false })
	        .limit(lim);
	      if(error){
	        if(isMissingRelationError(error)){
	          const { data: data2, error: err2 } = await SB.client
	            .from('purchase_orders')
	            .select(baseSelect)
	            .eq('company_id', SB.companyId)
	            .order('order_date', { ascending:false })
	            .order('created_at', { ascending:false })
	            .limit(lim);
	          if(err2) throw err2;
	          rows = Array.isArray(data2) ? data2 : [];
	        }else{
	          throw error;
	        }
	      }else{
	        rows = Array.isArray(data) ? data : [];
	      }
	      return rows.map(normalizePurchaseOrderRow);
	    }
	    async function sbFetchAllOrders(pageSize = 200){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) return [];
	      const size = Math.max(1, Math.min(200, toInt(pageSize, 200)));
	      let offset = 0;
	      const out = [];
	      for(let page=0; page<200; page++){
	        const baseSelect = 'id,po_number,status,order_date,expected_date,received_date,notes,vendor_id,created_at';
	        const { data, error } = await SB.client
	          .from('purchase_orders')
	          .select(baseSelect)
	          .eq('company_id', SB.companyId)
	          .order('order_date', { ascending:false })
	          .order('created_at', { ascending:false })
	          .range(offset, offset + size - 1);
	        if(error) throw error;
	        const rows = Array.isArray(data) ? data : [];
	        out.push(...rows.map(normalizePurchaseOrderRow));
	        if(rows.length < size) break;
	        offset += size;
	      }
	      return out;
	    }
      function normalizePurchaseOrderRow(row){
        const vendorName = row && row.vendor && row.vendor.name ? String(row.vendor.name).trim() : '';
        const fallbackVendor = String(row && row.vendor_name ? row.vendor_name : '').trim();
        return { ...row, vendor_name: vendorName || fallbackVendor };
      }
      function lineQtyOrdered(row){
        return toQty(
          row && (
            row.quantity_ordered ??
            row.qty_ordered ??
            row.ordered_qty ??
            row.quantity ??
            row.qty
          ),
          0
        );
      }
      function lineQtyReceived(row){
        return toQty(
          row && (
            row.quantity_received ??
            row.qty_received ??
            row.received_qty ??
            row.qty_received_total
          ),
          0
        );
      }
      function normalizePurchaseOrderLine(row){
        return {
          id: row && row.id ? String(row.id).trim() : '',
          purchase_order_id: row && row.purchase_order_id ? String(row.purchase_order_id).trim() : '',
          item_id: row && row.item_id ? String(row.item_id).trim() : '',
          item_name: String(row && (row.item_name || row.name || row.item) ? (row.item_name || row.name || row.item) : '').trim(),
          item_sku: String(row && (row.item_sku || row.sku) ? (row.item_sku || row.sku) : '').trim(),
          quantity_ordered: lineQtyOrdered(row),
          quantity_received: lineQtyReceived(row),
          unit_cost: row && row.unit_cost !== undefined ? row.unit_cost : null,
          notes: String(row && row.notes ? row.notes : '').trim(),
          created_at: row && row.created_at ? row.created_at : null,
        };
      }
      function normalizePurchaseOrderLines(rows){
        const list = Array.isArray(rows) ? rows : [];
        return list.map(normalizePurchaseOrderLine);
      }
      async function sbFetchPurchaseOrderLinesByPoIds(poIds){
        const ids = Array.isArray(poIds) ? poIds.filter(Boolean) : [];
        const map = new Map();
        if(!ids.length) return map;
        const select =
          'id,purchase_order_id,item_id,item_name,item_sku,quantity_ordered,quantity_received,unit_cost,notes,created_at';
        let data = null;
        let error = null;
        ({ data, error } = await SB.client
          .from('purchase_order_lines')
          .select(select)
          .in('purchase_order_id', ids));
        if(error && isMissingRelationError(error)){
          ({ data, error } = await SB.client
            .from('purchase_order_items')
            .select(select)
            .in('purchase_order_id', ids));
        }
        if(error) throw error;
        const rows = normalizePurchaseOrderLines(data || []);
        for(const row of rows){
          const key = String(row.purchase_order_id || '').trim();
          if(!key) continue;
          if(!map.has(key)) map.set(key, []);
          map.get(key).push(row);
        }
        return map;
      }
	    function csvEscape(value){
	      const s = String(value ?? '');
	      return '"' + s.replace(/"/g, '""') + '"';
	    }
	    function orderLineItemsToCsvCell(value){
	      const items = normalizePurchaseOrderLines(value);
	      if(!items.length) return '';
	      return items
	        .map(it => {
	          const name = String(it.item_name || '').trim();
	          const sku = String(it.item_sku || '').trim();
	          const qty = formatQty(it.quantity_ordered);
	          const label = sku ? `${name} (${sku})` : name;
	          return `${label} | ${qty}`;
	        })
	        .join(' ; ');
	    }
	    function buildOrderHistoryCsv(rows, lineMap){
      const header = [
        'PO ID',
        'PO Number',
        'Status',
        'Order Date',
        'Expected Date',
        'Received Date',
        'Vendor',
        'Notes',
        'Item Count',
        'Items',
      ];
	      const out = [header.map(csvEscape).join(',')];
	      const list = Array.isArray(rows) ? rows : [];
	      for(const o of list){
	        const id = String(o?.id || '').trim();
        const poNumber = String(o?.po_number || '').trim();
        const status = String(o?.status || '').trim();
        const orderDate = String(o?.order_date || '').trim();
        const expectedDate = String(o?.expected_date || '').trim();
        const receivedDate = String(o?.received_date || '').trim();
        const vendor = String(o?.vendor_name || o?.vendor?.name || o?.vendor_id || '').trim();
        const notes = String(o?.notes || '').trim();
        const lines = lineMap && typeof lineMap.get === 'function' ? (lineMap.get(id) || []) : [];
        const items = normalizePurchaseOrderLines(lines);
        const itemsCell = orderLineItemsToCsvCell(lines);
        out.push([
          id,
          poNumber,
          status,
          orderDate,
          expectedDate,
          receivedDate,
          vendor,
          notes,
          String(items.length),
          itemsCell,
        ].map(csvEscape).join(','));
      }
	      // Add BOM so Excel opens UTF-8 correctly
	      return '\ufeff' + out.join('\n');
	    }
	    async function downloadOrderHistoryCsv(){
	      if(!SB.ready){ toast('Supabase not configured'); return; }
	      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }

	      const btn = $('btnOrderHistoryDownload');
	      const priorTitle = btn ? btn.getAttribute('title') : '';
	      if(btn){ btn.disabled = true; btn.setAttribute('title', 'Downloadingâ€¦'); }
	      try{
	        toast('Downloading order historyâ€¦');
	        const rows = await sbFetchAllOrders(200);
	        if(!rows.length){ toast('No orders to download'); return; }
	        const lineMap = await sbFetchPurchaseOrderLinesByPoIds(rows.map(r => r && r.id));
	        const csv = buildOrderHistoryCsv(rows, lineMap);
	        const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
	        const url = URL.createObjectURL(blob);
	        const a = document.createElement('a');
	        a.href = url;
	        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
	        a.download = `order-history-${stamp}.csv`;
	        document.body.appendChild(a);
	        a.click();
	        document.body.removeChild(a);
	        URL.revokeObjectURL(url);
	        toast(`Downloaded ${rows.length} order(s)`);
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Download failed');
	      }finally{
	        if(btn){ btn.disabled = false; btn.setAttribute('title', priorTitle || 'Download CSV'); }
	      }
	    }
	    async function sbDeleteOrder(orderId){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      if(!canOrdersDelete()) throw new Error('Permission denied');
	      const id = String(orderId || '').trim();
	      if(!id) throw new Error('Invalid order ID');
	      const { data, error } = await SB.client
	        .rpc('soft_delete_order', { p_order_id: id });
	      if(error) throw error;
	      if(data && data.success === false){
	        throw new Error(data.error || 'Delete failed');
	      }
	    }

	    async function deleteOrderFromHistory(orderId, btnEl){
	      const id = String(orderId || '').trim();
	      if(!id) return false;
	      if(!canOrdersDelete()){ toast('Delete not allowed'); return false; }
	      if(!(await openConfirmModal('Delete order?', 'Delete this order from history?', { okText:'Delete', cancelText:'Cancel' }))) return false;
	      if(btnEl) btnEl.disabled = true;
	      try{
	        await sbDeleteOrder(id);
	        try{
	          if(state._orderHistoryById && typeof state._orderHistoryById.delete === 'function'){
	            state._orderHistoryById.delete(id);
	          }
	          if(Array.isArray(state._orderHistoryRows)){
	            state._orderHistoryRows = state._orderHistoryRows.filter(r => String(r && r.id ? r.id : '') !== id);
	          }
	        }catch(e){}
	        renderOrderHistoryFiltered();
	        toast('Order deleted');
	        return true;
	      }catch(err){
	        toast(err && err.message ? err.message : 'Delete failed');
	        if(btnEl) btnEl.disabled = false;
	        return false;
	      }
	    }

	    async function sbUpdateOrder(orderId, fields){
	      if(!SB.ready || !SB.session || !SB.authorized || !SB.companyId) throw new Error('Not authorized');
	      if(!canOrdersEdit()) throw new Error('Permission denied');
	      const id = String(orderId || '').trim();
	      if(!id) throw new Error('Invalid order ID');
	      const { error } = await SB.client
	        .from('orders')
	        .update(fields || {})
	        .eq('id', id)
	        .eq('company_id', SB.companyId)
	        .is('deleted_at', null);
	      if(error) throw error;
	    }

	    // Order History (mobile): swipe tray state
	    let _openHistoryTrayId = '';
	    function orderHistoryItemElById(orderId){
	      const id = String(orderId || '').trim();
	      if(!id) return null;
	      const list = $('orderHistoryList');
	      if(!list) return null;
	      try{
	        if(window.CSS && CSS.escape){
	          return list.querySelector(`details.history-item[data-order-id="${CSS.escape(id)}"]`) || null;
	        }
	      }catch(e){}
	      const safe = id.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
	      return list.querySelector(`details.history-item[data-order-id="${safe}"]`) || null;
	    }
	    function orderSubjectFromRow(row){
	      const poNumber = String(row && row.po_number ? row.po_number : '').trim();
	      const vendor = String(row && (row.vendor_name || (row.vendor && row.vendor.name) || row.vendor_id) ? (row.vendor_name || (row.vendor && row.vendor.name) || row.vendor_id) : '').trim();
	      if(poNumber && vendor) return `PO ${poNumber} \u2013 ${vendor}`;
	      if(poNumber) return `PO ${poNumber}`;
	      const id = String(row && row.id ? row.id : '').trim();
	      return id ? `Purchase Order ${id}` : 'Purchase Order';
	    }
	    function setHistoryTrayA11y(det, open){
	      const tray = det ? det.querySelector('.history-tray') : null;
	      if(!tray) return;
	      tray.setAttribute('aria-hidden', open ? 'false' : 'true');
	      tray.querySelectorAll('button.history-tray-btn').forEach(btn=>{
	        if(open) btn.removeAttribute('tabindex');
	        else btn.setAttribute('tabindex', '-1');
	      });
	    }
	    function closeHistoryTray(){
	      if(!_openHistoryTrayId) return;
	      const det = orderHistoryItemElById(_openHistoryTrayId);
	      if(det){
	        det.classList.remove('swiping');
	        det.classList.remove('tray-peek');
	        det.classList.remove('tray-open');
	        setRowSwipeX(det, 0);
	        try{ delete det.dataset.traySide; }catch(e){ det.dataset.traySide = ''; }
	        setHistoryTrayA11y(det, false);
	      }
	      _openHistoryTrayId = '';
	    }
	    function closeHistoryTrayElastic(targetDet){
	      const det = targetDet || (_openHistoryTrayId ? orderHistoryItemElById(_openHistoryTrayId) : null);
	      if(det){
	        det.classList.remove('swiping');
	        det.classList.remove('tray-peek');
	        det.classList.remove('tray-open');
	        det.classList.add('snap-elastic');
	        setRowSwipeX(det, 0);
	        try{ delete det.dataset.traySide; }catch(e){ det.dataset.traySide = ''; }
	        setHistoryTrayA11y(det, false);
	        setTimeout(()=>{ try{ det.classList.remove('snap-elastic'); }catch(e){} }, 400);
	      }
	      _openHistoryTrayId = '';
	    }
	    function prepareHistoryTrayForItem(det, side){
	      if(!det) return;
	      const id = String(det.dataset && det.dataset.orderId ? det.dataset.orderId : '').trim();
	      if(!id) return;
	      if(_openHistoryTrayId && _openHistoryTrayId !== id) closeHistoryTray();
	      _openHistoryTrayId = id;
	      det.dataset.traySide = (side === 'left') ? 'left' : 'right';
	      det.classList.remove('tray-open');
	      det.classList.add('tray-peek');
	      setHistoryTrayA11y(det, false);
	    }
	    function openHistoryTrayForItem(det, side){
	      if(!det) return;
	      const id = String(det.dataset && det.dataset.orderId ? det.dataset.orderId : '').trim();
	      if(!id) return;
	      if(_openHistoryTrayId && _openHistoryTrayId !== id) closeHistoryTray();
	      _openHistoryTrayId = id;
	      det.dataset.traySide = (side === 'left') ? 'left' : 'right';
	      det.classList.remove('tray-peek');
	      det.classList.add('tray-open');
	      setHistoryTrayA11y(det, true);
	      const targetX = traySideToSwipeX(det.dataset.traySide);
	      try{ requestAnimationFrame(()=> setRowSwipeX(det, targetX)); }catch(e){ setRowSwipeX(det, targetX); }
	    }

	    function isOrderCurrentlyReceived(orderRow){
	      const status = String(orderRow && orderRow.status ? orderRow.status : '').trim().toLowerCase();
	      return status === 'received';
	    }

	    function orderReceiptMetaText(orderRow){
	      const status = String(orderRow && orderRow.status ? orderRow.status : '').trim();
	      return status ? formatStateToken(status) : '';
	    }

	    function getOrderHistoryRowById(orderId){
	      const id = String(orderId || '').trim();
	      if(!id) return null;
	      if(state._orderHistoryById && typeof state._orderHistoryById.get === 'function'){
	        const row = state._orderHistoryById.get(id) || null;
	        if(row) return row;
	      }
	      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
	      return rows.find(r => String(r && r.id ? r.id : '').trim() === id) || null;
	    }

	    function patchOrderHistoryRow(orderId, patch){
	      const id = String(orderId || '').trim();
	      if(!id || !patch || typeof patch !== 'object') return;
	      try{
	        const row = getOrderHistoryRowById(id);
	        if(row) Object.assign(row, patch);
	      }catch(e){}
	      try{
	        if(state._orderHistoryById && typeof state._orderHistoryById.get === 'function'){
	          const row2 = state._orderHistoryById.get(id) || null;
	          if(row2) Object.assign(row2, patch);
	        }
	      }catch(e){}
	      try{
	        if(Array.isArray(state._orderHistoryRows)){
	          const i = state._orderHistoryRows.findIndex(r => String(r && r.id ? r.id : '').trim() === id);
	          if(i >= 0 && state._orderHistoryRows[i]) Object.assign(state._orderHistoryRows[i], patch);
	        }
	      }catch(e){}
	    }

	    function setLocalItemQty(itemId, qty){
	      const id = String(itemId || '').trim();
	      if(!id) return;
	      const it = state.items.find(x => x && x.id === id);
	      if(!it) return;
	      it.qty = toInt(qty, 0);
	    }

	    function resolveInventoryItemForOrderLine(line){
	      const storedId = String(line && line.item_id ? line.item_id : '').trim();
	      if(storedId){
	        const byId = getInventoryById(storedId);
	        if(byId) return byId;
	      }
	      const part = String(line && line.part ? line.part : '').trim();
	      const k = toKey(part);
	      if(!k) return null;
	      return state.items.find(it => it && toKey(it.name) === k) || null;
	    }

	    function normalizeReceiptLines(value){
	      const arr = Array.isArray(value) ? value : [];
	      return arr
	        .map((x) => ({
	          item_id: String(x && x.item_id ? x.item_id : '').trim(),
	          part: String(x && x.part ? x.part : '').trim(),
	          delta_qty: toInt(x && x.delta_qty, 0),
	          prev_qty: toInt(x && x.prev_qty, 0),
	          next_qty: toInt(x && x.next_qty, 0),
	        }))
	        .filter((l) => l.item_id && l.part && l.delta_qty > 0);
	    }

	    function normalizeReceiptSkipped(value){
	      const arr = Array.isArray(value) ? value : [];
	      return arr
	        .map((x) => ({
	          part: String(x && (x.part || x.name || x.item) ? (x.part || x.name || x.item) : '').trim(),
	          reason: String(x && x.reason ? x.reason : '').trim() || 'not_found',
	        }))
	        .filter((s) => s.part);
	    }

	    function receiptSkipText(s){
	      const reason = String(s && s.reason ? s.reason : '').trim();
	      const part = String(s && s.part ? s.part : '').trim();
	      if(reason === 'conflict') return `${part} (qty changed)`;
	      if(reason === 'deleted') return `${part} (item deleted)`;
	      return `${part} (not found)`;
	    }

	    function receiptAppliedLineText(line, mode){
	      const l = line || {};
	      const part = String(l.part || '').trim();
	      const delta = toInt(l.delta_qty, 0);
	      const prev = toInt(l.prev_qty, 0);
	      const next = toInt(l.next_qty, 0);
	      if(mode === 'undo') return `${part}: -${delta} (${next} â†’ ${prev})`;
	      return `${part}: +${delta} (${prev} â†’ ${next})`;
	    }

	    function buildReceiptSummary({ subject, applied, skipped, mode }){
	      const title = (mode === 'undo') ? 'Receive undone' : 'Order received';
	      const lines = Array.isArray(applied) ? applied : [];
	      const skips = Array.isArray(skipped) ? skipped : [];
	      const body = [
	        subject ? `Order: ${subject}` : '',
	        '',
	        `Applied: ${lines.length}`,
	        `Skipped: ${skips.length}`,
	        '',
	        'Applied lines:',
	        lines.length ? lines.map(l => `- ${receiptAppliedLineText(l, mode)}`).join('\n') : '(none)',
	        '',
	        'Skipped lines:',
	        skips.length ? skips.map(s => `- ${receiptSkipText(s)}`).join('\n') : '(none)',
	      ].filter((x, i, arr) => !(x === '' && arr[i-1] === '')).join('\n');
	      const copy = JSON.stringify({ mode, subject, applied: lines, skipped: skips }, null, 2);
	      return { title, body, copy };
	    }

	    async function buildReceivingSnapshotForOrder(orderRow){
	      const items = normalizeOrderLineItems(orderRow && orderRow.line_items ? orderRow.line_items : []);
	      const skipped = [];
	      const agg = new Map(); // itemId -> { item_id, part, delta_qty }
	      for(const it of items){
	        const delta = toInt(it && it.qty, 0);
	        if(delta <= 0) continue;
	        const inv = resolveInventoryItemForOrderLine(it);
	        if(!inv){
	          const part = String(it && it.part ? it.part : '').trim();
	          if(part) skipped.push({ part, reason:'not_found' });
	          continue;
	        }
	        const key = String(inv.id || '').trim();
	        if(!key) continue;
	        const existing = agg.get(key);
	        const part = String(it && it.part ? it.part : (inv.name || '')).trim();
	        if(existing){
	          existing.delta_qty += delta;
	        }else{
	          agg.set(key, { item_id: key, part: part || String(inv.name||'').trim(), delta_qty: delta });
	        }
	      }

	      const ids = Array.from(agg.keys());
	      const qtyMap = await sbFetchItemQtyMap(ids);
	      const lines = [];
	      for(const [id, entry] of agg){
	        const prev = qtyMap.get(id);
	        if(typeof prev !== 'number'){
	          const part = String(entry && entry.part ? entry.part : '').trim();
	          if(part) skipped.push({ part, reason:'not_found' });
	          continue;
	        }
	        const delta = toInt(entry.delta_qty, 0);
	        if(delta <= 0) continue;
	        lines.push({
	          item_id: id,
	          part: String(entry.part || '').trim() || id,
	          delta_qty: delta,
	          prev_qty: prev,
	          next_qty: prev + delta,
	        });
	      }

	      return {
	        planned_at: new Date().toISOString(),
	        planned_by: SB.user ? SB.user.id : null,
	        lines,
	        skipped,
	      };
	    }

	    async function applyReceivingSnapshot(orderId, snapshot){
	      const planned = (snapshot && typeof snapshot === 'object') ? snapshot : {};
	      const lines = normalizeReceiptLines(planned.lines);
	      const baseSkipped = normalizeReceiptSkipped(planned.skipped).map(s => ({ part: s.part, reason: 'not_found' }));
	      const ids = lines.map(l => l.item_id);
	      const qtyMap = await sbFetchItemQtyMap(ids);
	      const applied = [];
	      const skipped = baseSkipped.slice();

	      for(const l of lines){
	        const current = qtyMap.get(l.item_id);
	        if(typeof current !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        if(current === l.next_qty){
	          applied.push(l);
	          setLocalItemQty(l.item_id, l.next_qty);
	          continue;
	        }
	        if(current !== l.prev_qty){
	          skipped.push({ part: l.part, reason:'conflict' });
	          continue;
	        }
	        const ok = await sbUpdateItemQtyIfMatch(l.item_id, l.prev_qty, l.next_qty);
	        if(ok){
	          qtyMap.set(l.item_id, l.next_qty);
	          applied.push(l);
	          setLocalItemQty(l.item_id, l.next_qty);
	          continue;
	        }
	        const refreshed = await sbFetchItemQtyMap([l.item_id]);
	        const current2 = refreshed.get(l.item_id);
	        if(typeof current2 !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        qtyMap.set(l.item_id, current2);
	        if(current2 === l.next_qty){
	          applied.push(l);
	          setLocalItemQty(l.item_id, l.next_qty);
	          continue;
	        }
	        skipped.push({ part: l.part, reason:'conflict' });
	      }

	      const appliedAt = new Date().toISOString();
	      const receivedSnapshot = {
	        applied_at: appliedAt,
	        applied_by: SB.user ? SB.user.id : null,
	        lines: applied,
	        skipped,
	      };
	      const patch = {
	        receiving_at: null,
	        receiving_by: null,
	        receiving_snapshot: null,
	        received_at: appliedAt,
	        received_by: SB.user ? SB.user.id : null,
	        received_snapshot: receivedSnapshot,
	        received_undone_at: null,
	        received_undone_by: null,
	      };
	      await sbUpdateOrder(orderId, patch);
	      patchOrderHistoryRow(orderId, patch);
	      try{ setUpdated(); render(); }catch(e){}
	      try{ renderOrderHistoryFiltered(); }catch(e){}
	      return { receivedSnapshot, applied, skipped };
	    }

	    async function undoReceivedSnapshot(orderId, receivedSnapshot){
	      const snap = (receivedSnapshot && typeof receivedSnapshot === 'object') ? receivedSnapshot : {};
	      const lines = normalizeReceiptLines(snap.lines);
	      if(!lines.length) return { undone: [], skipped: [] };

	      const ids = lines.map(l => l.item_id);
	      const qtyMap = await sbFetchItemQtyMap(ids);
	      const undone = [];
	      const skipped = [];

	      for(const l of lines){
	        const current = qtyMap.get(l.item_id);
	        if(typeof current !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        if(current === l.prev_qty){
	          undone.push(l);
	          setLocalItemQty(l.item_id, l.prev_qty);
	          continue;
	        }
	        if(current !== l.next_qty){
	          skipped.push({ part: l.part, reason:'conflict' });
	          continue;
	        }
	        const ok = await sbUpdateItemQtyIfMatch(l.item_id, l.next_qty, l.prev_qty);
	        if(ok){
	          qtyMap.set(l.item_id, l.prev_qty);
	          undone.push(l);
	          setLocalItemQty(l.item_id, l.prev_qty);
	          continue;
	        }
	        const refreshed = await sbFetchItemQtyMap([l.item_id]);
	        const current2 = refreshed.get(l.item_id);
	        if(typeof current2 !== 'number'){
	          skipped.push({ part: l.part, reason:'deleted' });
	          continue;
	        }
	        qtyMap.set(l.item_id, current2);
	        if(current2 === l.prev_qty){
	          undone.push(l);
	          setLocalItemQty(l.item_id, l.prev_qty);
	          continue;
	        }
	        skipped.push({ part: l.part, reason:'conflict' });
	      }

	      const undoneAt = new Date().toISOString();
	      const patch = {
	        receiving_at: null,
	        receiving_by: null,
	        receiving_snapshot: null,
	        received_undone_at: undoneAt,
	        received_undone_by: SB.user ? SB.user.id : null,
	      };
	      await sbUpdateOrder(orderId, patch);
	      patchOrderHistoryRow(orderId, patch);
	      try{ setUpdated(); render(); }catch(e){}
	      try{ renderOrderHistoryFiltered(); }catch(e){}
	      return { undone, skipped };
	    }

	    function showOrderReceivingSetupHelp(){
	      const sql = "NOTIFY pgrst, 'reload schema';";
	      openMsgModal(
	        'Enable order receiving',
	        `Order receiving requires a Supabase schema update.\n\n`+
	          `Run the latest SUPABASE_SECURE_SETUP.sql in Supabase SQL Editor, then run:\n${sql}\n\n`+
	          `After that, refresh this page and tap Receive again.`,
	        sql
	      );
	    }

	    function setReceiveOrderMessage(msg){
	      const el = $('receiveOrderMsg'); if(!el) return;
	      el.textContent = String(msg || '');
	    }
	    function setReceiveOrderWarning(msg){
	      const el = $('receiveOrderWarning'); if(!el) return;
	      el.textContent = String(msg || '');
	    }
	    function shortId(value){
	      const id = String(value || '').trim();
	      return id ? id.slice(0, 8) : '';
	    }
	    function receiveLineOverBy(line){
	      const remaining = Number(line && line.remaining_qty !== undefined ? line.remaining_qty : 0);
	      const total = toQty(line && line.qty_received, 0) + toQty(line && line.qty_rejected, 0);
	      return total - remaining;
	    }
	    function receiveLineHasOverage(line){
	      return receiveLineOverBy(line) > 0;
	    }
	    function updateReceiveLineDom(line){
	      const key = String(line && line.key ? line.key : '').trim();
	      if(!key) return;
	      let selector = `[data-receive-line-key="${key}"]`;
	      try{
	        if(window.CSS && CSS.escape){
	          selector = `[data-receive-line-key="${CSS.escape(key)}"]`;
	        }
	      }catch(e){}
	      const row = document.querySelector(selector);
	      if(!row) return;
	      const warningEl = row.querySelector('[data-receive-line-warning]');
	      const overBy = receiveLineOverBy(line);
	      if(overBy > 0){
	        row.classList.add('over');
	        if(warningEl) warningEl.textContent = `Over by ${formatQty(overBy)}`;
	      }else{
	        row.classList.remove('over');
	        if(warningEl) warningEl.textContent = '';
	      }
	    }
	    function getReceiveOrderLineByKey(key){
	      const ro = state._receiveOrder;
	      if(!ro || !Array.isArray(ro.lines)) return null;
	      const id = String(key || '').trim();
	      if(!id) return null;
	      return ro.lines.find(l => String(l && l.key ? l.key : '').trim() === id) || null;
	    }
	    function updateReceiveLineFromInput(input, opts = {}){
	      const el = input;
	      if(!el) return null;
	      const key = String(el.dataset.receiveLineKey || '').trim();
	      const field = String(el.dataset.receiveField || '').trim();
	      if(!key || (field !== 'received' && field !== 'rejected')) return null;
	      const line = getReceiveOrderLineByKey(key);
	      if(!line || line.disabled) return null;
	      const raw = String(el.value || '');
	      const numeric = Number(raw);
	      const invalid = raw !== '' && !Number.isFinite(numeric);
	      const negative = Number.isFinite(numeric) && numeric < 0;
	      let next = Number.isFinite(numeric) ? numeric : 0;
	      if(next < 0) next = 0;
	      if(field === 'received') line.qty_received = next;
	      else line.qty_rejected = next;
	      if(opts.format){
	        el.value = formatQty(next);
	      }
	      if(opts.showError){
	        const msgEl = $('receiveOrderMsg');
	        if(negative){
	          setReceiveOrderMessage('Quantities must be 0 or higher.');
	        }else if(invalid){
	          setReceiveOrderMessage('Enter a valid quantity.');
	        }else if(msgEl){
	          const existing = String(msgEl.textContent || '').trim();
	          if(existing === 'Quantities must be 0 or higher.' || existing === 'Enter a valid quantity.'){
	            setReceiveOrderMessage('');
	          }
	        }
	      }
	      updateReceiveLineDom(line);
	      updateReceiveOrderWarning();
	      return line;
	    }
	    function updateReceiveOrderWarning(){
	      const ro = state._receiveOrder;
	      if(!ro){
	        setReceiveOrderWarning('');
	        return;
	      }
	      const overCount = ro.lines.filter(l => !l.disabled && receiveLineHasOverage(l)).length;
	      setReceiveOrderWarning(
	        overCount
	          ? `${overCount} line${overCount === 1 ? '' : 's'} exceed remaining quantities. Over-receipt is allowed but will be flagged.`
	          : ''
	      );
	    }
	    function computeReceiveTotals(lines){
	      const totals = { ordered:0, received:0, remaining:0 };
	      for(const line of lines){
	        totals.ordered += Number(line.ordered_qty || 0);
	        totals.received += Number(line.prev_received || 0);
	        totals.remaining += Number(line.remaining_qty || 0);
	      }
	      return totals;
	    }
	    async function sbFetchPurchaseOrderById(poId){
	      const id = String(poId || '').trim();
	      if(!id) throw new Error('Invalid purchase order');
	      const baseSelect = 'id,po_number,status,order_date,expected_date,received_date,notes,vendor_id,created_at';
	      const { data, error } = await SB.client
	        .from('purchase_orders')
	        .select(`${baseSelect},vendor:vendors(name)`)
	        .eq('id', id)
	        .single();
	      if(error){
	        if(isMissingRelationError(error)){
	          const fallback = await SB.client
	            .from('purchase_orders')
	            .select(baseSelect)
	            .eq('id', id)
	            .single();
	          if(fallback.error) throw fallback.error;
	          return normalizePurchaseOrderRow(fallback.data);
	        }
	        throw error;
	      }
	      return normalizePurchaseOrderRow(data);
	    }
	    async function sbFetchReceiptDataForPo(poId){
	      const id = String(poId || '').trim();
	      if(!id) return { receipts: [], receiptLines: [] };
	      const { data: receipts, error } = await SB.client
	        .from('receipts')
	        .select('id,status,received_at,created_at,received_by')
	        .eq('purchase_order_id', id)
	        .order('created_at', { ascending:false });
	      if(error) throw error;
	      const receiptIds = (receipts || []).map(r => r && r.id).filter(Boolean);
	      if(!receiptIds.length){
	        return { receipts: Array.isArray(receipts) ? receipts : [], receiptLines: [] };
	      }
	      const { data: lines, error: lineError } = await SB.client
	        .from('receipt_lines')
	        .select('id,receipt_id,item_id,qty_received,qty_rejected,created_at')
	        .in('receipt_id', receiptIds);
	      if(lineError) throw lineError;
	      return {
	        receipts: Array.isArray(receipts) ? receipts : [],
	        receiptLines: Array.isArray(lines) ? lines : [],
	      };
	    }
	    function buildReceiveOrderState(po, poLines, receipts, receiptLines){
	      const normalizedLines = normalizePurchaseOrderLines(poLines || []);
	      const lineByItemId = new Map();
	      normalizedLines.forEach(line => {
	        if(line.item_id) lineByItemId.set(line.item_id, line);
	      });

	      const normalizedReceiptLines = (Array.isArray(receiptLines) ? receiptLines : []).map((line) => ({
	        id: String(line && line.id ? line.id : '').trim(),
	        receipt_id: String(line && line.receipt_id ? line.receipt_id : '').trim(),
	        item_id: String(line && line.item_id ? line.item_id : '').trim(),
	        qty_received: toQty(line && line.qty_received, 0),
	        qty_rejected: toQty(line && line.qty_rejected, 0),
	        created_at: line && line.created_at ? line.created_at : null,
	      }));

	      const draftReceipts = (receipts || []).filter(r => String(r && r.status ? r.status : '').trim() === 'draft');
	      const draftReceipt = draftReceipts
	        .slice()
	        .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0))[0] || null;
	      const draftReceiptId = draftReceipt && draftReceipt.id ? String(draftReceipt.id) : '';

	      const draftLineMap = new Map();
	      if(draftReceiptId){
	        normalizedReceiptLines
	          .filter(l => l.receipt_id === draftReceiptId)
	          .forEach(l => { if(l.item_id) draftLineMap.set(l.item_id, l); });
	      }

	      const completedReceiptIds = new Set(
	        (receipts || [])
	          .filter(r => String(r && r.status ? r.status : '').trim() === 'completed')
	          .map(r => String(r && r.id ? r.id : '').trim())
	          .filter(Boolean)
	      );
	      const receivedByItem = new Map();
	      for(const line of normalizedReceiptLines){
	        if(!completedReceiptIds.has(line.receipt_id)) continue;
	        if(!line.item_id) continue;
	        const prev = receivedByItem.get(line.item_id) || 0;
	        receivedByItem.set(line.item_id, prev + toQty(line.qty_received, 0));
	      }

	      const lines = normalizedLines.map((line, idx) => {
	        const key = line.id || line.item_id || `line-${idx}`;
	        const ordered = toQty(line.quantity_ordered, 0);
	        const prevReceived = receivedByItem.get(line.item_id) || 0;
	        const remaining = ordered - prevReceived;
	        const draftLine = line.item_id ? draftLineMap.get(line.item_id) : null;
	        const qtyReceived = draftLine ? toQty(draftLine.qty_received, 0) : Math.max(remaining, 0);
	        const qtyRejected = draftLine ? toQty(draftLine.qty_rejected, 0) : 0;
	        return {
	          ...line,
	          key,
	          ordered_qty: ordered,
	          prev_received: prevReceived,
	          remaining_qty: remaining,
	          qty_received: qtyReceived,
	          qty_rejected: qtyRejected,
	          disabled: !line.item_id,
	        };
	      });

	      const receiptLinesByReceipt = new Map();
	      for(const line of normalizedReceiptLines){
	        const receiptId = String(line.receipt_id || '').trim();
	        if(!receiptId) continue;
	        if(!receiptLinesByReceipt.has(receiptId)) receiptLinesByReceipt.set(receiptId, []);
	        const poLine = lineByItemId.get(line.item_id);
	        receiptLinesByReceipt.get(receiptId).push({
	          ...line,
	          item_name: poLine ? poLine.item_name : '',
	          item_sku: poLine ? poLine.item_sku : '',
	        });
	      }

	      return {
	        po,
	        lines,
	        receipts: Array.isArray(receipts) ? receipts : [],
	        receiptLines: normalizedReceiptLines,
	        receiptLinesByReceipt,
	        draftReceiptId,
	        draftReceiptsCount: draftReceipts.length,
	      };
	    }
	    function renderReceiveOrderModal(){
	      const ro = state._receiveOrder;
	      const meta = $('receiveOrderMeta');
	      const summary = $('receiveOrderSummary');
	      const linesWrap = $('receiveOrderLines');
	      const receiptsWrap = $('receiveOrderReceipts');
	      if(!meta || !summary || !linesWrap || !receiptsWrap) return;

	      if(!ro || ro.loading){
	        if(meta) meta.innerHTML = '';
	        if(summary) summary.innerHTML = '';
	        if(linesWrap) linesWrap.innerHTML = `<div class="muted">Loading receipt detailsâ€¦</div>`;
	        if(receiptsWrap) receiptsWrap.innerHTML = '';
	        return;
	      }

	      const po = ro.po || {};
	      const poNumber = String(po.po_number || '').trim();
	      const supplier = String(po.vendor_name || (po.vendor && po.vendor.name) || po.vendor_id || '').trim() || 'Unknown';
	      const status = formatStateToken(po.status || '');

	      meta.innerHTML =
	        `<div class="receive-order-card">`+
	          `<div class="label">Purchase Order</div>`+
	          `<div class="value">${escapeHtml(poNumber || String(po.id || '').trim() || 'â€”')}</div>`+
	        `</div>`+
	        `<div class="receive-order-card">`+
	          `<div class="label">Supplier</div>`+
	          `<div class="value">${escapeHtml(supplier)}</div>`+
	        `</div>`+
	        `<div class="receive-order-card">`+
	          `<div class="label">Status</div>`+
	          `<div class="value">${escapeHtml(status || 'â€”')}</div>`+
	        `</div>`;

	      const totals = computeReceiveTotals(ro.lines || []);
	      summary.innerHTML =
	        `<div class="receive-order-card">`+
	          `<div class="label">Ordered Qty</div>`+
	          `<div class="value">${formatQty(totals.ordered)}</div>`+
	        `</div>`+
	        `<div class="receive-order-card">`+
	          `<div class="label">Previously Received</div>`+
	          `<div class="value">${formatQty(totals.received)}</div>`+
	        `</div>`+
	        `<div class="receive-order-card">`+
	          `<div class="label">Remaining Qty</div>`+
	          `<div class="value">${formatQty(totals.remaining)}</div>`+
	        `</div>`;

	      if(!ro.lines || !ro.lines.length){
	        linesWrap.innerHTML = `<div class="order-empty">No line items found.</div>`;
	      }else{
	        linesWrap.innerHTML = ro.lines.map(line => {
	          const name = line.item_name || '(Unnamed item)';
	          const sku = line.item_sku || '';
	          const remaining = formatQty(line.remaining_qty);
	          const disabled = line.disabled;
	          const receivedVal = formatQty(line.qty_received);
	          const rejectedVal = formatQty(line.qty_rejected);
	          return (
	            `<div class="receive-line${disabled ? ' disabled' : ''}" data-receive-line-key="${escapeHtmlAttr(line.key)}">`+
	              `<div class="receive-line-header">`+
	                `<div>`+
	                  `<div class="receive-line-title">${escapeHtml(name)}</div>`+
	                  (sku ? `<div class="receive-line-sku">SKU: ${escapeHtml(sku)}</div>` : '')+
	                `</div>`+
	                `<div class="receive-line-stats">`+
	                  `<div>Ordered: ${formatQty(line.ordered_qty)}</div>`+
	                  `<div>Previously received: ${formatQty(line.prev_received)}</div>`+
	                  `<div>Remaining: ${remaining}</div>`+
	                `</div>`+
	              `</div>`+
	              `<div class="receive-line-inputs">`+
	                `<div>`+
	                  `<label>Qty Received</label>`+
	                  `<input type="number" inputmode="decimal" step="0.01" min="0" data-receive-line-key="${escapeHtmlAttr(line.key)}" data-receive-field="received" value="${escapeHtmlAttr(receivedVal)}"${disabled ? ' disabled' : ''}>`+
	                `</div>`+
	                `<div>`+
	                  `<label>Qty Rejected</label>`+
	                  `<input type="number" inputmode="decimal" step="0.01" min="0" data-receive-line-key="${escapeHtmlAttr(line.key)}" data-receive-field="rejected" value="${escapeHtmlAttr(rejectedVal)}"${disabled ? ' disabled' : ''}>`+
	                `</div>`+
	              `</div>`+
	              `<div class="receive-line-warning" data-receive-line-warning></div>`+
	              (disabled ? `<div class="receive-line-note">Item mapping missing. This line cannot be received.</div>` : '')+
	            `</div>`
	          );
	        }).join('');
	        ro.lines.forEach(updateReceiveLineDom);
	      }

	      const visibleReceipts = (ro.receipts || []).filter(r => String(r && r.status ? r.status : '').trim() !== 'draft');
	      const draftCount = ro.draftReceiptsCount || 0;
	      if(!visibleReceipts.length){
	        receiptsWrap.innerHTML = `<div class="muted">No completed receipts yet.</div>`;
	      }else{
	        receiptsWrap.innerHTML =
	          `<div class="muted" style="letter-spacing:.08em;text-transform:uppercase;font-weight:800;">Previous Receipts</div>`+
	          visibleReceipts.map(r => {
	            const receiptId = String(r && r.id ? r.id : '').trim();
	            const statusText = formatStateToken(r && r.status ? r.status : '');
	            const when = r && (r.received_at || r.created_at) ? formatEasternDateTime(r.received_at || r.created_at) : '';
	            const lines = ro.receiptLinesByReceipt && ro.receiptLinesByReceipt.get(receiptId) ? ro.receiptLinesByReceipt.get(receiptId) : [];
	            const totalReceived = lines.reduce((sum, l) => sum + toQty(l.qty_received, 0), 0);
	            const totalRejected = lines.reduce((sum, l) => sum + toQty(l.qty_rejected, 0), 0);
	            const canVoid = (String(r && r.status ? r.status : '').trim() === 'completed') && canReceivingVoid();
	            return (
	              `<div class="receive-receipt">`+
	                `<div class="receive-receipt-header">`+
	                  `<div>`+
	                    `<div class="receive-receipt-title">Receipt ${escapeHtml(shortId(receiptId) || receiptId)}</div>`+
	                    `<div class="receive-receipt-meta">${escapeHtml(statusText || '')}${when ? ` â€¢ ${escapeHtml(when)}` : ''}</div>`+
	                  `</div>`+
	                  `<div>`+
	                    (canVoid ? `<button class="btn-tertiary btn-sm btn-danger" type="button" data-void-receipt-id="${escapeHtmlAttr(receiptId)}">Void</button>` : '')+
	                  `</div>`+
	                `</div>`+
	                `<div class="receive-receipt-meta">Received: ${formatQty(totalReceived)} â€¢ Rejected: ${formatQty(totalRejected)}</div>`+
	                `<div class="receive-receipt-lines">`+
	                  (lines.length ? lines.map(line => {
	                    const itemName = line.item_name || line.item_id || 'Item';
	                    const sku = line.item_sku ? ` (${line.item_sku})` : '';
	                    return (
	                      `<div class="receive-receipt-line">`+
	                        `<div>${escapeHtml(itemName)}${escapeHtml(sku)}</div>`+
	                        `<span>+${formatQty(line.qty_received)}</span>`+
	                        `<span>âˆ’${formatQty(line.qty_rejected)}</span>`+
	                      `</div>`
	                    );
	                  }).join('') : `<div class="muted">No lines.</div>`) +
	                `</div>`+
	              `</div>`
	            );
	          }).join('');
	      }

	      if(draftCount > 1){
	        setReceiveOrderMessage('Multiple draft receipts detected. The most recent draft is loaded.');
	      }else if(ro.draftReceiptId){
	        setReceiveOrderMessage('Draft receipt loaded. Save or complete to apply changes.');
	      }else{
	        setReceiveOrderMessage('');
	      }

	      updateReceiveOrderWarning();
	      const saveBtn = $('btnReceiveOrderSave');
	      const completeBtn = $('btnReceiveOrderComplete');
	      const cancelBtn = $('btnReceiveOrderCancel');
	      const canSave = ro.draftReceiptId ? canReceivingEdit() : (canReceivingCreate() && canReceivingEdit());
	      if(saveBtn) saveBtn.disabled = !canSave;
	      if(completeBtn) completeBtn.disabled = !canReceivingApprove();
	      if(cancelBtn) cancelBtn.disabled = false;
	    }
	    async function refreshReceiveOrderModal(poId){
	      const id = String(poId || '').trim();
	      if(!id) return;
	      const existing = state._receiveOrder && state._receiveOrder.po ? state._receiveOrder.po : null;
	      const poRow = existing && String(existing.id || '').trim() === id ? existing : (getOrderHistoryRowById(id) || await sbFetchPurchaseOrderById(id));
	      let lineMap = state._orderHistoryLinesByPo && state._orderHistoryLinesByPo.get ? state._orderHistoryLinesByPo : new Map();
	      let poLines = lineMap.get(id) || null;
	      if(!poLines){
	        const fetched = await sbFetchPurchaseOrderLinesByPoIds([id]);
	        poLines = fetched.get(id) || [];
	      }
	      const { receipts, receiptLines } = await sbFetchReceiptDataForPo(id);
	      state._receiveOrder = buildReceiveOrderState(poRow, poLines, receipts, receiptLines);
	      renderReceiveOrderModal();
	    }
	    async function ensureDraftReceiptId(receiveState){
	      if(receiveState.draftReceiptId) return receiveState.draftReceiptId;
	      const { data, error } = await SB.client.rpc('create_receipt', {
	        p_company_id: SB.companyId,
	        p_purchase_order_id: receiveState.po && receiveState.po.id ? receiveState.po.id : receiveState.poId
	      });
	      if(error) throw error;
	      if(data && data.success === false){
	        throw new Error(data.error || 'Failed to create receipt');
	      }
	      const receiptId = data && data.receipt_id ? String(data.receipt_id).trim() : '';
	      if(!receiptId) throw new Error('Failed to create receipt');
	      receiveState.draftReceiptId = receiptId;
	      return receiptId;
	    }
	    async function saveReceiptLines(receiveState){
	      const lines = receiveState.lines || [];
	      const hasAny = lines.some(l => !l.disabled && (toQty(l.qty_received, 0) > 0 || toQty(l.qty_rejected, 0) > 0));
	      if(!hasAny) throw new Error('Enter at least one received or rejected quantity.');
	      const receiptId = await ensureDraftReceiptId(receiveState);
	      for(const line of lines){
	        if(line.disabled) continue;
	        const { data, error } = await SB.client.rpc('upsert_receipt_line', {
	          p_receipt_id: receiptId,
	          p_item_id: line.item_id,
	          p_qty_received: toQty(line.qty_received, 0),
	          p_qty_rejected: toQty(line.qty_rejected, 0),
	        });
	        if(error) throw error;
	        if(data && data.success === false){
	          throw new Error(data.error || 'Failed to save receipt line');
	        }
	      }
	      return receiptId;
	    }
	    async function handleSaveReceiptDraft(){
	      const ro = state._receiveOrder;
	      if(!ro) return;
	      if(!canReceivingEdit() || (!ro.draftReceiptId && !canReceivingCreate())){
	        toast('Receipt draft permission required');
	        return;
	      }
	      const btn = $('btnReceiveOrderSave');
	      const prior = btn ? btn.textContent : '';
	      if(btn){ btn.disabled = true; btn.textContent = 'Savingâ€¦'; }
	      try{
	        await saveReceiptLines(ro);
	        toast('Draft saved');
	        setReceiveOrderMessage('Draft saved.');
	      }catch(e){
	        setReceiveOrderMessage(e && e.message ? e.message : 'Failed to save draft');
	      }finally{
	        if(btn){ btn.disabled = false; btn.textContent = prior || 'Save Draft'; }
	      }
	    }
	    async function handleCompleteReceipt(){
	      const ro = state._receiveOrder;
	      if(!ro) return;
	      if(!canReceivingApprove()){
	        toast('Complete receipt permission required');
	        return;
	      }
	      const ok = await openConfirmModal(
	        'Complete receipt?',
	        'Inventory is updated only when the receipt is completed.',
	        { okText:'Complete', cancelText:'Cancel' }
	      );
	      if(!ok) return;

	      const btn = $('btnReceiveOrderComplete');
	      const prior = btn ? btn.textContent : '';
	      if(btn){ btn.disabled = true; btn.textContent = 'Completingâ€¦'; }
	      try{
	        const receiptId = await saveReceiptLines(ro);
	        const { data, error } = await SB.client.rpc('complete_receipt', { p_receipt_id: receiptId });
	        if(error) throw error;
	        if(data && data.success === false){
	          throw new Error(data.error || 'Failed to complete receipt');
	        }
	        toast('Receipt completed');
	        setReceiveOrderMessage('Receipt completed. Inventory updated on completion.');
	        await refreshReceiveOrderModal(ro.po && ro.po.id ? ro.po.id : ro.poId);
	      }catch(e){
	        setReceiveOrderMessage(e && e.message ? e.message : 'Failed to complete receipt');
	      }finally{
	        if(btn){ btn.disabled = false; btn.textContent = prior || 'Complete Receipt'; }
	      }
	    }
	    async function handleVoidReceipt(receiptId, btnEl){
	      const id = String(receiptId || '').trim();
	      if(!id) return;
	      if(!canReceivingVoid()){
	        toast('Void receipt permission required');
	        return;
	      }
	      const ok = await openConfirmModal(
	        'Void receipt?',
	        'Voiding reverses inventory adjustments for this receipt.',
	        { okText:'Void', cancelText:'Cancel' }
	      );
	      if(!ok) return;
	      const btn = btnEl || null;
	      const prior = btn ? btn.textContent : '';
	      if(btn){
	        btn.disabled = true;
	        btn.textContent = 'Voidingâ€¦';
	      }
	      try{
	        const { data, error } = await SB.client.rpc('void_receipt', { p_receipt_id: id });
	        if(error) throw error;
	        if(data && data.success === false){
	          throw new Error(data.error || 'Failed to void receipt');
	        }
	        toast('Receipt voided');
	        const ro = state._receiveOrder;
	        if(ro) await refreshReceiveOrderModal(ro.po && ro.po.id ? ro.po.id : ro.poId);
	      }catch(e){
	        toast(e && e.message ? e.message : 'Failed to void receipt');
	      }finally{
	        if(btn && btn.isConnected){
	          btn.disabled = false;
	          btn.textContent = prior || 'Void';
	        }
	      }
	    }
	    function closeReceiveOrderModal(){
	      state._receiveOrder = null;
	      setReceiveOrderMessage('');
	      setReceiveOrderWarning('');
	      show('receiveOrderModal', false);
	    }
	    async function openReceiveOrderModal(orderId){
	      const id = String(orderId || '').trim();
	      if(!id) return;
	      if(!SB.ready){ toast('Supabase not configured'); return; }
	      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
	      if(!canReceiveOrders()){ toast('Receiving access required'); return; }

	      setReceiveOrderMessage('');
	      setReceiveOrderWarning('');
	      state._receiveOrder = { poId: id, po: getOrderHistoryRowById(id), lines: [], receipts: [], receiptLines: [], receiptLinesByReceipt: new Map(), draftReceiptId:'', draftReceiptsCount:0, loading:true };
	      show('receiveOrderModal', true);
	      renderReceiveOrderModal();
	      try{
	        await refreshReceiveOrderModal(id);
	      }catch(e){
	        setReceiveOrderMessage(e && e.message ? e.message : 'Failed to load receipt data');
	        renderReceiveOrderModal();
	      }
	    }

	    async function handleOrderReceiptButtonClick(orderId, btnEl){
	      const id = String(orderId || '').trim();
	      if(!id) return;
	      if(btnEl){
	        btnEl.disabled = true;
	      }
	      try{
	        await openReceiveOrderModal(id);
	      }finally{
	        if(btnEl){
	          btnEl.disabled = false;
	        }
	      }
	    }

	    function renderOrderHistoryList(list, opts = {}){
	      const wrap = $('orderHistoryList');
	      if(!wrap) return;
	      wrap.innerHTML = '';
	      const rows = Array.isArray(list) ? list : [];
	      if(!rows.length){
	        const empty = document.createElement('div');
	        empty.className = 'order-empty';
	        empty.textContent = (opts && typeof opts.emptyText === 'string' && opts.emptyText.trim())
	          ? opts.emptyText
	          : 'No orders yet.';
	        wrap.appendChild(empty);
	        return;
	      }
      for(const o of rows){
        const det = document.createElement('details');
        det.className = 'history-item';
        det.dataset.orderId = String(o.id || '');

	        const subject = escapeHtml(orderSubjectFromRow(o));
        const orderDate = formatDateShort(o.order_date || o.created_at || '');
        const expectedDate = formatDateShort(o.expected_date || '');
        const receivedDate = formatDateShort(o.received_date || '');
        const statusLabel = formatStateToken(o.status || '');
        const supplier = String(o.vendor_name || (o.vendor && o.vendor.name) || o.vendor_id || '').trim();
        const notes = String(o.notes||'').trim();

        const orderId = String(o.id || '');
        const receiptMeta = orderNonEmpty(orderReceiptMetaText(o));
        const canReceipt = canReceiveOrders();
        const isReceived = isOrderCurrentlyReceived(o);
        det.classList.toggle('order-received', isReceived);
        const receiveBtnTitle = canReceipt ? 'Receive Order' : 'Receiving not allowed';
        const receiveBtnClass = 'btn-tertiary btn-with-icon btn-sm';
        const receiveBtnIcon =
          `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
            `<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>`+
            `<path d="M3.27 6.96 12 12.01l8.73-5.05"></path>`+
            `<path d="M12 22.08V12"></path>`+
            `<polyline class="recv-check" points="9 11 12 14 16 10"></polyline>`+
          `</svg>`;
        const receiptBtn =
          `<button class="${receiveBtnClass}" data-receive-order-id="${escapeHtml(orderId)}" aria-disabled="${canReceipt ? 'false' : 'true'}" aria-label="${escapeHtml(receiveBtnTitle)}" title="${escapeHtml(receiveBtnTitle)}"${canReceipt ? '' : ' disabled'}>`+
            receiveBtnIcon+
            `<span>Receive Order</span>`+
          `</button>`;
        const trayReceiveBtn =
          `<button type="button" class="history-tray-btn history-tray-btn--receive" data-receive-order-id="${escapeHtml(orderId)}" tabindex="-1" aria-disabled="${canReceipt ? 'false' : 'true'}" aria-label="${escapeHtml(receiveBtnTitle)}" title="${escapeHtml(receiveBtnTitle)}"${canReceipt ? '' : ' disabled'}>`+
            `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">`+
              `<path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>`+
              `<path d="M3.27 6.96 12 12.01l8.73-5.05"></path>`+
              `<path d="M12 22.08V12"></path>`+
              `<polyline class="recv-check" points="9 11 12 14 16 10"></polyline>`+
            `</svg>`+
          `</button>`;

        const lineMap = state._orderHistoryLinesByPo || new Map();
        const items = normalizePurchaseOrderLines(lineMap.get(orderId) || []);
        const itemsTable = items.length ? (
          `<table class="history-table">`+
            `<thead>`+
              `<tr>`+
                `<th>Item</th>`+
                `<th>SKU</th>`+
                `<th style="text-align:right">Ordered</th>`+
                `<th style="text-align:right">Received</th>`+
                `<th style="text-align:right">Remaining</th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>`+
              items.map(it =>
                `<tr>`+
                  `<td>${escapeHtml(it.item_name || '(Unnamed item)')}</td>`+
                  `<td>${escapeHtml(it.item_sku)}</td>`+
                  `<td class="qty">${formatQty(it.quantity_ordered)}</td>`+
                  `<td class="qty">${formatQty(it.quantity_received)}</td>`+
                  `<td class="qty">${formatQty(it.quantity_ordered - it.quantity_received)}</td>`+
                `</tr>`
              ).join('')+
            `</tbody>`+
          `</table>`
        ) : `<div class="order-empty" style="margin-top:10px;">(No line items)</div>`;

        det.innerHTML =
          `<summary>`+
            `<div class="history-tray" aria-hidden="true">`+
              trayReceiveBtn+
            `</div>`+
            `<div class="history-header">`+
              `<div class="history-title">${subject}</div>`+
              `<div class="history-actions">`+
                receiptBtn+
              `</div>`+
            `</div>`+
            `<div class="history-meta">${orderDate ? escapeHtml(orderDate) : ''}${receiptMeta ? ` â€¢ ${escapeHtml(receiptMeta)}` : ''}</div>`+
            `<span class="history-caret" aria-hidden="true">`+
              `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">`+
                `<polyline points="6 9 12 15 18 9"></polyline>`+
              `</svg>`+
            `</span>`+
          `</summary>`+
          `<div class="history-body">`+
            `<div class="history-kv">`+
              (supplier ? `<div><span class="muted">Supplier:</span> ${escapeHtml(supplier)}</div>` : '')+
              (statusLabel ? `<div><span class="muted">Status:</span> ${escapeHtml(statusLabel)}</div>` : '')+
              (expectedDate ? `<div><span class="muted">Expected:</span> ${escapeHtml(expectedDate)}</div>` : '')+
              (receivedDate ? `<div><span class="muted">Received:</span> ${escapeHtml(receivedDate)}</div>` : '')+
              (notes ? `<div><span class="muted">Notes:</span> ${escapeHtml(notes)}</div>` : '')+
            `</div>`+
            itemsTable +
          `</div>`;

	        wrap.appendChild(det);
	      }
	    }
	    function orderHistorySearchText(orderRow){
	      const o = orderRow || {};
	      const createdAt = String(o.created_at || '').trim();
	      const orderDate = String(formatDateShort(o.order_date || '') || '').trim();
	      const expectedDate = String(formatDateShort(o.expected_date || '') || '').trim();
	      const receivedDate = String(formatDateShort(o.received_date || '') || '').trim();
	      const subject = orderSubjectFromRow(o);
	      const notes = String(o.notes || '').trim();
	      const id = String(o.id || '').trim();
	      const poNumber = String(o.po_number || '').trim();
	      const status = String(o.status || '').trim();
	      const vendor = String(o.vendor_name || (o.vendor && o.vendor.name) || o.vendor_id || '').trim();
        const lineMap = state._orderHistoryLinesByPo || new Map();
        const items = normalizePurchaseOrderLines(lineMap.get(id) || []);
        const itemText = items.map(it => `${it.item_name} ${it.item_sku} ${formatQty(it.quantity_ordered)}`).join(' ');
	      return `${id} ${poNumber} ${status} ${orderDate} ${expectedDate} ${receivedDate} ${createdAt} ${subject} ${vendor} ${notes} ${itemText}`.toLowerCase();
	    }
	    function renderOrderHistoryFiltered(){
	      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
	      const raw = String(state._orderHistoryFilter || '').trim().toLowerCase();
	      if(!raw){
	        renderOrderHistoryList(rows, { emptyText: 'No orders yet.' });
	        return;
	      }
	      const tokens = raw.split(/\s+/g).filter(Boolean);
	      const out = rows.filter(r => {
	        const hay = orderHistorySearchText(r);
	        return tokens.every(t => hay.includes(t));
	      });
	      renderOrderHistoryList(out, { emptyText: 'No matching orders.' });
	    }
		    let _orderSuggestTimer = null;
		    function renderOrderEmailSuggestions(list){
		      const wrap = $('orderEmailSuggest');
		      if(!wrap) return;
	      wrap.innerHTML = '';
	      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
	      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
	      wrap.classList.add('has-suggest');
	      rows.forEach(r=>{
	        const btn = document.createElement('button');
	        btn.type = 'button';
	        btn.className = 'suggest-chip';
	        btn.dataset.suggestEmail = String(r.email);
	        btn.textContent = String(r.email);
	        wrap.appendChild(btn);
	      });
	    }
	    function hideOrderEmailSuggestions(){
	      if(_orderSuggestTimer){ clearTimeout(_orderSuggestTimer); _orderSuggestTimer = null; }
	      renderOrderEmailSuggestions([]);
	    }
    function orderNonEmpty(value){
      const s = String(value || '').trim();
      return s ? s : '';
    }
	    function requestOrderEmailSuggestions(prefix){
	      if(_orderSuggestTimer) clearTimeout(_orderSuggestTimer);
	      const q = String(prefix||'');
	      _orderSuggestTimer = setTimeout(async ()=>{
	        const wrap = $('orderEmailSuggest');
	        const inp = $('orderEmail');
	        const ae = document.activeElement;
	        const allow = (inp && ae === inp) || (wrap && ae && wrap.contains(ae));
	        if(!allow){ hideOrderEmailSuggestions(); return; }
	        try{
	          const data = await sbFetchOrderRecipientSuggestions(q);
	          // If focus moved away while we awaited, don't reopen the list.
	          const wrap2 = $('orderEmailSuggest');
	          const inp2 = $('orderEmail');
	          const ae2 = document.activeElement;
	          const allow2 = (inp2 && ae2 === inp2) || (wrap2 && ae2 && wrap2.contains(ae2));
	          if(!allow2){ hideOrderEmailSuggestions(); return; }
	          renderOrderEmailSuggestions(data);
	        }catch{
	          renderOrderEmailSuggestions([]);
	        }
	      }, 160);
	    }

    const _forwardSuggestTimers = new Map();
    function renderForwardEmailSuggestions(orderId, list){
      const id = String(orderId || '').trim();
      if(!id) return;
      const wrap = document.querySelector(`[data-forward-suggest-id="${id}"]`);
      if(!wrap) return;
      wrap.innerHTML = '';
      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
      wrap.classList.add('has-suggest');
      rows.forEach(r=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggest-chip';
        btn.dataset.forwardSuggestEmail = String(r.email);
        btn.textContent = String(r.email);
        wrap.appendChild(btn);
      });
    }
    function requestForwardEmailSuggestions(orderId, prefix){
      const id = String(orderId || '').trim();
      if(!id) return;
      const prev = _forwardSuggestTimers.get(id);
      if(prev) clearTimeout(prev);
      const q = String(prefix||'');
      const t = setTimeout(async ()=>{
        try{
          const data = await sbFetchOrderRecipientSuggestions(q);
          renderForwardEmailSuggestions(id, data);
        }catch{
          renderForwardEmailSuggestions(id, []);
        }
      }, 160);
      _forwardSuggestTimers.set(id, t);
    }
    async function forwardOrderFromHistory(orderId){
      const id = String(orderId || '').trim();
      if(!id) return;
      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }

      const row = state._orderHistoryById && typeof state._orderHistoryById.get === 'function'
        ? (state._orderHistoryById.get(id) || null)
        : null;
      if(!row){ toast('Order not found'); return; }

      const input = document.querySelector(`[data-forward-email-id="${id}"]`);
      const to = String(input && input.value ? input.value : '').trim();
      if(!looksLikeEmailAddress(to)){ toast('Enter a valid email'); return; }

      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Sendingâ€¦'; }

      try{
        const subjectLine = orderSubjectFromRow(row);
        const notes = String(row.notes||'').trim();
        const lineItems = Array.isArray(row.line_items) ? row.line_items : [];
        const companyName = getOrderCompanyName();
        if(!companyName) throw new Error('Company name is required to send orders');
        const shippingAddress = normalizeShippingSnapshot(row.shipping_address_snapshot);
        const companyPoNumber = String(row.company_po_number || '').trim();
        const internalPoNumber = String(row.internal_po_number || '').trim();

        const sendRes = await sendOrderPayloadViaApi({
          to,
          subjectLine,
          notes,
          lineItems,
          shippingAddress,
          companyName,
          companyPoNumber,
          internalPoNumber,
        });
        try{ await sbRecordOrderRecipient(to, ''); }catch{}
        try{
          await sbInsertOrderHistoryFromData({
            toEmail: to,
            subjectLine,
            contactName: '',
            notes,
            lineItems,
            providerResult: sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes,
            companyPoNumber,
            internalPoNumber,
            shippingAddressId: row.shipping_address_id,
            shippingAddressSnapshot: shippingAddress,
          });
        }catch{}

        toast('Forwarded');
        if(input) input.value = '';
        renderForwardEmailSuggestions(id, []);
      }catch(e){
        toast((e && e.message) ? e.message : 'Forward failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Forward'; }
      }
    }
    let _orderHistoryReturnToOrder = false;
	    async function refreshOrderHistory(){
	      const wrap = $('orderHistoryList');
	      if(wrap) wrap.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
	      const btn = $('btnOrderHistoryRefresh');
	      const prior = btn ? btn.textContent : '';
	      if(btn){ btn.disabled = true; btn.textContent = 'Loadingâ€¦'; }
	      try{
	        const rows = await sbFetchOrders(60);
	        state._orderHistoryRows = Array.isArray(rows) ? rows : [];
	        state._orderHistoryById = new Map((rows||[]).map(r => [String(r && r.id ? r.id : ''), r]).filter(x=>x[0]));
          state._orderHistoryLinesByPo = await sbFetchPurchaseOrderLinesByPoIds(
            (rows || []).map(r => r && r.id)
          );
	        renderOrderHistoryFiltered();
	      }catch(e){
	        state._orderHistoryById = new Map();
	        state._orderHistoryRows = [];
          state._orderHistoryLinesByPo = new Map();
	        const msg = e && e.message ? e.message : 'Failed to load history';
	        if(wrap) wrap.innerHTML = `<div class="order-empty">${escapeHtml(msg)}</div>`;
	      }finally{
	        if(btn){ btn.disabled = false; btn.textContent = prior || 'Refresh'; }
	      }
	    }
    async function openOrderHistoryModal(opts = {}){
      const returnToOrder = !!opts.returnToOrder;
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!canOrdersView()){ toast('Order history access required'); return; }
      _orderHistoryReturnToOrder = returnToOrder;
	      if(returnToOrder) show('orderModal', false);
	      show('orderHistoryModal', true);
	      const f = $('orderHistoryFilter'); if(f) f.value = state._orderHistoryFilter || '';
	      try{ updateOrderHistoryFilterClearBtn(); }catch(e){}
	      await refreshOrderHistory();
	    }
    function closeOrderHistoryModal(){
      try{ closeHistoryTray(); }catch(e){}
      show('orderHistoryModal', false);
      if(_orderHistoryReturnToOrder){
        _orderHistoryReturnToOrder = false;
        show('orderModal', true);
        renderOrderPreview();
      }
    }

    function jobStatusLabel(status){
      const s = String(status || 'draft').trim();
      if(s === 'draft') return 'Draft';
      if(s === 'quoted') return 'Quoted';
      if(s === 'approved') return 'Approved';
      if(s === 'in_progress') return 'In Progress';
      if(s === 'completed') return 'Completed';
      if(s === 'voided') return 'Voided';
      return s;
    }
    function jobStatusClass(status){
      const s = String(status || 'draft').trim();
      return `job-status--${s}`;
    }
    function isJobEditable(status){
      return ['draft', 'quoted'].includes(String(status || 'draft'));
    }
    function canApproveJob(status){
      return ['draft', 'quoted'].includes(String(status || ''));
    }
    function canCompleteJob(status){
      return ['approved', 'in_progress'].includes(String(status || ''));
    }
    function canVoidJob(status){
      return ['draft', 'quoted', 'approved', 'in_progress'].includes(String(status || ''));
    }
    function setJobsMessage(msg){
      const el = $('jobsMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setJobEditorMessage(msg){
      const el = $('jobEditorMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setJobBomMessage(msg){
      const el = $('jobBomMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setJobCompleteMessage(msg){
      const el = $('jobCompleteMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }

    async function sbFetchJobs(){
      if(!SB.ready) throw new Error('Supabase not configured');
      if(!SB.session) throw new Error('Sign in required');
      if(!SB.companyId) throw new Error('No company selected');
      const { data, error } = await SB.client
        .from('jobs')
        .select('id,company_id,name,status,notes,created_at,updated_at,created_by')
        .eq('company_id', SB.companyId)
        .order('created_at', { ascending:false });
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbFetchJobBom(jobId){
      const { data, error } = await SB.client
        .from('job_bom')
        .select('job_id,item_id,qty_planned')
        .eq('job_id', jobId);
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbFetchJobBomForJobs(jobIds){
      const ids = Array.isArray(jobIds) ? jobIds.filter(Boolean) : [];
      const map = new Map();
      if(!ids.length) return map;
      const { data, error } = await SB.client
        .from('job_bom')
        .select('job_id,item_id,qty_planned')
        .in('job_id', ids);
      if(error) throw error;
      (Array.isArray(data) ? data : []).forEach(line=>{
        const jobId = String(line.job_id || '').trim();
        if(!jobId) return;
        if(!map.has(jobId)) map.set(jobId, []);
        map.get(jobId).push(line);
      });
      return map;
    }
    async function sbFetchJobActuals(jobId){
      const { data, error } = await SB.client
        .from('job_actuals')
        .select('job_id,item_id,qty_used')
        .eq('job_id', jobId);
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbFetchReservedMap(){
      const approved = (state._jobs || []).filter(j => ['approved','in_progress'].includes(String(j.status || '')));
      const jobIds = approved.map(j => j.id).filter(Boolean);
      const reserved = new Map();
      if(!jobIds.length) return reserved;
      const { data, error } = await SB.client
        .from('job_bom')
        .select('job_id,item_id,qty_planned')
        .in('job_id', jobIds);
      if(error) throw error;
      (Array.isArray(data) ? data : []).forEach(line=>{
        const itemId = String(line.item_id || '');
        if(!itemId) return;
        const qty = Number(line.qty_planned || 0);
        if(!Number.isFinite(qty)) return;
        reserved.set(itemId, (reserved.get(itemId) || 0) + qty);
      });
      return reserved;
    }
    async function ensureInventoryLoaded(){
      if(!state.items || !state.items.length){
        await sbLoadSnapshot();
      }
    }
    function updateMenuJobsBadge(rows){
      const badge = $('menuJobsBadge');
      if(!badge) return;
      const list = Array.isArray(rows) ? rows : (Array.isArray(state._jobs) ? state._jobs : []);
      const activeCount = list.filter(row => {
        const status = String(row && row.status ? row.status : '').trim();
        return status !== 'completed' && status !== 'voided';
      }).length;
      if(activeCount > 0){
        badge.textContent = String(activeCount);
        badge.style.display = '';
      }else{
        badge.textContent = '0';
        badge.style.display = 'none';
      }
    }
    function renderJobsList(){
      const list = $('jobsList');
      if(!list) return;
      const rows = Array.isArray(state._jobs) ? state._jobs : [];
      updateMenuJobsBadge(rows);
      if(!rows.length){
        list.innerHTML = `<div class="order-empty">No jobs yet.</div>`;
        return;
      }
      const canAdmin = canItemsDelete();
      const reservedMap = state._jobReservedMap || new Map();
      const expanded = state._jobsExpanded || new Set();
      let html = `<div class="jobs-list">`;
      for(const row of rows){
        const id = String(row.id || '').trim();
        if(!id) continue;
        const name = String(row.name || '').trim() || '(Untitled job)';
        const status = String(row.status || 'draft').trim();
        const created = row.created_at ? formatDateShort(row.created_at) : 'â€”';
        const bomLines = state._jobBomByJobId && state._jobBomByJobId.get ? (state._jobBomByJobId.get(id) || []) : [];
        let totalNeeded = 0;
        let totalAvailable = 0;
        let totalShortage = 0;
        bomLines.forEach(line=>{
          const itemId = String(line.item_id || '').trim();
          const qtyPlanned = Number(line.qty_planned || 0);
          const stats = computeJobLineStats(itemId, qtyPlanned, reservedMap);
          totalNeeded += qtyPlanned;
          totalAvailable += stats.available;
          totalShortage += Math.max(0, qtyPlanned - stats.available);
        });
        const itemCount = bomLines.length;
        const summary = `${itemCount} item${itemCount === 1 ? '' : 's'}`;
        const isExpanded = expanded.has(id);
        const toggleLabel = isExpanded ? 'Collapse job' : 'Expand job';
        const badgeTone = (status === 'approved' || status === 'completed')
          ? 'approved'
          : (status === 'draft' || status === 'voided')
            ? 'draft'
            : 'pending';
        const badgeLabel = (status === 'approved')
          ? 'Approved'
          : (status === 'completed')
            ? 'Completed'
            : (status === 'draft')
              ? 'Draft'
              : (status === 'voided')
                ? 'Voided'
                : 'Pending';
        const shortageLabel = totalShortage > 0 ? `${formatQty(totalShortage)} short` : '';
        html += (
          `<div class="job-row" data-job-row="${escapeHtmlAttr(id)}" aria-expanded="${isExpanded ? 'true' : 'false'}">`+
            `<div class="job-card-header" data-job-toggle-id="${escapeHtmlAttr(id)}">`+
              `<button class="job-chevron" data-job-toggle-id="${escapeHtmlAttr(id)}" aria-label="${escapeHtmlAttr(toggleLabel)}" title="${escapeHtmlAttr(toggleLabel)}">${ICONS.chevronRight}</button>`+
              `<div class="job-header-main">`+
                `<div class="job-name" title="${escapeHtmlAttr(name)}">${escapeHtml(name)}</div>`+
                `<div class="job-header-meta">`+
                  `<span class="job-status-pill job-status-pill--${escapeHtmlAttr(badgeTone)}">${escapeHtml(badgeLabel)}</span>`+
                  `<span class="job-meta">${escapeHtml(created)}</span>`+
                  `<span class="job-summary">${escapeHtml(summary)}</span>`+
                  (totalShortage > 0 ? `<span class="job-shortage" title="${escapeHtmlAttr(shortageLabel)}">${ICONS.alertTriangle}<span>${escapeHtml(shortageLabel)}</span></span>` : '')+
                `</div>`+
              `</div>`+
              `<div class="job-actions">`+
                `<button class="icon-btn icon-btn--default job-action--view" data-job-view-id="${escapeHtmlAttr(id)}" aria-label="View job" title="View job">${ICONS.eye}</button>`+
                `<button class="icon-btn icon-btn--default job-action--edit" data-job-edit-id="${escapeHtmlAttr(id)}" aria-label="Edit job" title="Edit job">${ICONS.pencil}</button>`+
                (canAdmin && canApproveJob(status) ? `<button class="icon-btn icon-btn--success job-action--approve" data-job-approve-id="${escapeHtmlAttr(id)}" aria-label="Approve job" title="Approve job">${ICONS.checkCircle}</button>` : '')+
                (canAdmin && canCompleteJob(status) ? `<button class="icon-btn icon-btn--success job-action--complete" data-job-complete-id="${escapeHtmlAttr(id)}" aria-label="Complete job" title="Complete job">${ICONS.check}</button>` : '')+
                (canAdmin && canVoidJob(status) ? `<button class="icon-btn icon-btn--danger job-action--void" data-job-void-id="${escapeHtmlAttr(id)}" aria-label="Void job" title="Void job">${ICONS.xCircle}</button>` : '')+
              `</div>`+
            `</div>`+
          `</div>`
        );
        if(isExpanded){
          if(!bomLines.length){
            html += `<div class="job-detail"><div class="muted">No BOM items yet.</div></div>`;
          }else{
            html += `<div class="job-detail">`;
            html += `<table class="job-items-table"><thead><tr><th>Item</th><th class="num">Needed</th><th class="num">Available</th><th>Status</th></tr></thead><tbody>`;
            bomLines.forEach(line=>{
              const itemId = String(line.item_id || '').trim();
              const qtyPlanned = Number(line.qty_planned || 0);
              const item = getInventoryById(itemId);
              const itemName = item ? String(item.name || '') : itemId;
              const sku = item && item.sku ? String(item.sku || '').trim() : '';
              const stats = computeJobLineStats(itemId, qtyPlanned, reservedMap);
              let statusText = 'Fulfilled';
              let statusClass = 'job-item-status--fulfilled';
              let statusIcon = ICONS.check;
              if(stats.available <= 0){
                statusText = 'Out of Stock';
                statusClass = 'job-item-status--out';
                statusIcon = ICONS.xCircle;
              }else if(stats.available < qtyPlanned){
                statusText = 'Shortage';
                statusClass = 'job-item-status--shortage';
                statusIcon = ICONS.alertTriangle;
              }
              html += (
                `<tr>`+
                  `<td class="item-cell" data-label="Item">`+
                    `<div class="job-item-name" title="${escapeHtmlAttr(itemName)}">${escapeHtml(itemName)}</div>`+
                    (sku ? `<div class="job-item-sku">${escapeHtml(sku)}</div>` : '')+
                  `</td>`+
                  `<td class="num" data-label="Needed">${escapeHtml(formatQty(qtyPlanned))}</td>`+
                  `<td class="num" data-label="Available">${escapeHtml(formatQty(stats.available))}</td>`+
                  `<td data-label="Status">`+
                    `<span class="job-item-status ${escapeHtmlAttr(statusClass)}">${statusIcon}<span>${escapeHtml(statusText)}</span></span>`+
                  `</td>`+
                `</tr>`
              );
            });
            html += `</tbody></table>`;
            html += (
              `<div class="job-items-summary">`+
                `<span><span>Total Needed</span><span>${escapeHtml(formatQty(totalNeeded))}</span></span>`+
                `<span><span>Total Available</span><span>${escapeHtml(formatQty(totalAvailable))}</span></span>`+
                `<span class="${totalShortage > 0 ? 'job-total-short' : ''}"><span>Total Shortage</span><span>${escapeHtml(formatQty(totalShortage))}</span></span>`+
              `</div>`
            );
            html += `</div>`;
          }
        }
      }
      html += `</div>`;
      list.innerHTML = html;
      try{ initButtonSystem.refresh(); }catch(e){}
    }
    function toggleJobExpanded(jobId){
      const id = String(jobId || '').trim();
      if(!id) return;
      if(!state._jobsExpanded || typeof state._jobsExpanded.has !== 'function'){
        state._jobsExpanded = new Set();
      }
      if(state._jobsExpanded.has(id)) state._jobsExpanded.delete(id);
      else state._jobsExpanded.add(id);
      renderJobsList();
    }
    async function refreshJobs(){
      const list = $('jobsList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setJobsMessage('');
      try{
        await ensureInventoryLoaded();
        const rows = await sbFetchJobs();
        state._jobs = rows;
        state._jobsById = new Map(rows.map(r => [String(r.id || ''), r]).filter(x => x[0]));
        const jobIds = rows.map(r => r && r.id).filter(Boolean);
        state._jobBomByJobId = await sbFetchJobBomForJobs(jobIds);
        state._jobReservedMap = await sbFetchReservedMap();
        renderJobsList();
      }catch(e){
        state._jobs = [];
        state._jobsById = new Map();
        state._jobBomByJobId = new Map();
        state._jobReservedMap = new Map();
        const msg = e && e.message ? e.message : 'Failed to load jobs';
        if(list) list.innerHTML = `<div class="order-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openJobsModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!requirePermission(PERMISSIONS.ITEMS_VIEW, 'Inventory access required')) return;
      show('jobsModal', true);
      await refreshJobs();
    }
    function closeJobsModal(){
      show('jobsModal', false);
    }
    function renderJobEditor(){
      const editor = state._jobEditor;
      const job = editor ? editor.job : null;
      const status = job ? String(job.status || 'draft') : 'draft';
      const editable = job ? isJobEditable(status) : true;
      const canAdmin = canItemsDelete();
      const statusLabel = jobStatusLabel(status);
      const statusPill = $('jobStatusPill');
      const nameInput = $('jobNameInput');
      const notesInput = $('jobNotesInput');
      const createdMeta = $('jobCreatedMeta');
      const approveSection = $('jobApprovalSection');
      const completeSection = $('jobCompletionSection');
      const voidSection = $('jobVoidSection');
      const saveBtn = $('btnJobSave');

      if(statusPill){
        statusPill.textContent = statusLabel;
        statusPill.className = `job-status ${jobStatusClass(status)}`;
      }
      if(createdMeta){
        const created = job && job.created_at ? formatDateShort(job.created_at) : '';
        createdMeta.textContent = created ? `Created ${created}` : '';
      }
      if(nameInput) nameInput.value = job ? String(job.name || '') : '';
      if(notesInput) notesInput.value = job ? String(job.notes || '') : '';

      if(nameInput) nameInput.disabled = !editable;
      if(notesInput) notesInput.disabled = !editable;
      if(saveBtn){
        saveBtn.textContent = job && job.id ? 'Save' : 'Create Job';
        saveBtn.disabled = state._jobEditorBusy || !editable;
      }

      const hasJob = !!(job && job.id);
      if(!hasJob){
        setJobBomMessage('Create the job, then add items from Inventory.');
      }

      if(approveSection){
        approveSection.style.display = (job && job.id && canApproveJob(status)) ? 'block' : 'none';
        const btn = $('btnJobApprove');
        if(btn) btn.disabled = !(job && job.id && canApproveJob(status) && canAdmin);
      }
      if(completeSection){
        completeSection.style.display = (job && job.id && canCompleteJob(status)) ? 'block' : 'none';
        const btn = $('btnJobComplete');
        if(btn) btn.disabled = !(job && job.id && canCompleteJob(status) && canAdmin);
      }
      if(voidSection){
        voidSection.style.display = (job && job.id && canVoidJob(status)) ? 'block' : 'none';
        const btn = $('btnJobVoid');
        if(btn) btn.disabled = !(job && job.id && canVoidJob(status) && canAdmin);
      }

      renderJobBomTable();
      renderJobActualsTable();
    }
    function computeJobLineStats(itemId, qtyPlanned, reservedMap){
      const item = getInventoryById(itemId);
      const onHand = item ? toInt(item.qty, 0) : 0;
      const reserved = reservedMap && reservedMap.has(itemId) ? Number(reservedMap.get(itemId)) : 0;
      const available = onHand - reserved;
      const shortfall = Math.max(Number(qtyPlanned || 0) - available, 0);
      return { onHand, reserved, available, shortfall };
    }
    function updateBomIndicators(itemId, qtyPlanned){
      const editor = state._jobEditor;
      if(!editor) return;
      const stats = computeJobLineStats(itemId, qtyPlanned, editor.reservedMap);
      const onHandEl = document.querySelector(`[data-bom-on-hand="${CSS.escape(itemId)}"]`);
      const reservedEl = document.querySelector(`[data-bom-reserved="${CSS.escape(itemId)}"]`);
      const availableEl = document.querySelector(`[data-bom-available="${CSS.escape(itemId)}"]`);
      const shortfallEl = document.querySelector(`[data-bom-shortfall="${CSS.escape(itemId)}"]`);
      if(onHandEl) onHandEl.textContent = String(stats.onHand);
      if(reservedEl) reservedEl.textContent = String(stats.reserved);
      if(availableEl){
        availableEl.textContent = String(stats.available);
        availableEl.classList.toggle('job-bom-available', stats.available >= Number(qtyPlanned || 0));
      }
      if(shortfallEl){
        shortfallEl.textContent = String(stats.shortfall);
        shortfallEl.classList.toggle('job-bom-shortfall', stats.shortfall > 0);
      }
    }
    function renderJobBomTable(){
      const wrap = $('jobBomTable');
      if(!wrap) return;
      const editor = state._jobEditor;
      const job = editor ? editor.job : null;
      const status = job ? String(job.status || 'draft') : 'draft';
      const editable = job ? isJobEditable(status) : false;
      const lines = editor && Array.isArray(editor.bomLines) ? editor.bomLines : [];
      const reservedMap = editor ? editor.reservedMap : new Map();

      if(!lines.length){
        wrap.innerHTML = `<div class="muted" style="margin-top:8px;">No BOM lines yet. Add items from the Inventory list.</div>`;
        return;
      }

      let html = '<table class="job-bom-table"><thead><tr><th>Item</th><th class="num">Planned</th><th class="num">On Hand</th><th class="num">Reserved</th><th class="num">Available</th><th class="num">Shortfall</th><th style="text-align:right;">Actions</th></tr></thead><tbody>';
      for(const line of lines){
        const itemId = String(line.item_id || '').trim();
        const item = getInventoryById(itemId);
        const name = item ? String(item.name || '') : 'Unknown item';
        const qtyPlanned = Number(line.qty_planned || 0);
        const stats = computeJobLineStats(itemId, qtyPlanned, reservedMap);
        const availableClass = stats.available >= qtyPlanned ? 'job-bom-available' : '';
        const shortfallClass = stats.shortfall > 0 ? 'job-bom-shortfall' : '';
        html += (
          `<tr data-bom-item-id="${escapeHtmlAttr(itemId)}">`+
            `<td>${escapeHtml(name)}</td>`+
            `<td class="num">`+
              `<input type="number" min="0" step="1" value="${escapeHtmlAttr(String(qtyPlanned))}" data-bom-qty-input="${escapeHtmlAttr(itemId)}"${editable ? '' : ' disabled'} style="max-width:90px;">`+
            `</td>`+
            `<td class="num"><span data-bom-on-hand="${escapeHtmlAttr(itemId)}">${escapeHtml(String(stats.onHand))}</span></td>`+
            `<td class="num"><span data-bom-reserved="${escapeHtmlAttr(itemId)}">${escapeHtml(String(stats.reserved))}</span></td>`+
            `<td class="num"><span data-bom-available="${escapeHtmlAttr(itemId)}" class="${availableClass}">${escapeHtml(String(stats.available))}</span></td>`+
            `<td class="num"><span data-bom-shortfall="${escapeHtmlAttr(itemId)}" class="${shortfallClass}">${escapeHtml(String(stats.shortfall))}</span></td>`+
            `<td style="text-align:right;">`+
              `<button class="icon-btn icon-btn--success" data-bom-update-id="${escapeHtmlAttr(itemId)}" aria-label="Update planned quantity" title="Update planned quantity"${editable ? '' : ' disabled aria-disabled="true"'}>${ICONS.check}</button>`+
              `<button class="icon-btn icon-btn--danger" data-bom-remove-id="${escapeHtmlAttr(itemId)}" aria-label="Remove item" title="Remove item"${editable ? '' : ' disabled aria-disabled=\"true\"'}>${ICONS.xCircle}</button>`+
            `</td>`+
          `</tr>`
        );
      }
      html += '</tbody></table>';
      wrap.innerHTML = html;
      try{ initButtonSystem.refresh(); }catch(e){}
    }
    function renderJobActualsTable(){
      const wrap = $('jobActualsTable');
      if(!wrap) return;
      const editor = state._jobEditor;
      const job = editor ? editor.job : null;
      const status = job ? String(job.status || 'draft') : 'draft';
      if(!job || !canCompleteJob(status)){
        wrap.innerHTML = '';
        return;
      }
      const lines = editor && Array.isArray(editor.bomLines) ? editor.bomLines : [];
      const actuals = editor && Array.isArray(editor.actuals) ? editor.actuals : [];
      const actualMap = new Map(actuals.map(a => [String(a.item_id || ''), Number(a.qty_used || 0)]));
      if(!lines.length){
        wrap.innerHTML = `<div class="muted" style="margin-top:8px;">No BOM lines found.</div>`;
        return;
      }
      let html = '<table class="job-bom-table"><thead><tr><th>Item</th><th class="num">Planned</th><th class="num">Actual</th></tr></thead><tbody>';
      for(const line of lines){
        const itemId = String(line.item_id || '').trim();
        const item = getInventoryById(itemId);
        const name = item ? String(item.name || '') : 'Unknown item';
        const planned = Number(line.qty_planned || 0);
        const actual = actualMap.has(itemId) ? Number(actualMap.get(itemId)) : planned;
        html += (
          `<tr data-actual-item-id="${escapeHtmlAttr(itemId)}">`+
            `<td>${escapeHtml(name)}</td>`+
            `<td class="num">${escapeHtml(String(planned))}</td>`+
            `<td class="num"><input type="number" min="0" step="1" value="${escapeHtmlAttr(String(actual))}" data-actual-qty-input="${escapeHtmlAttr(itemId)}" style="max-width:90px;"></td>`+
          `</tr>`
        );
      }
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }
    function collectJobActuals(){
      const rows = Array.from(document.querySelectorAll('[data-actual-item-id]'));
      return rows.map(row=>{
        const itemId = String(row.getAttribute('data-actual-item-id') || '').trim();
        const input = row.querySelector('[data-actual-qty-input]');
        const qty = input ? Number(input.value || 0) : 0;
        return { item_id: itemId, qty_used: qty };
      });
    }
    function parseShortageDetails(msg){
      const text = String(msg || '');
      const start = text.indexOf('[');
      const end = text.lastIndexOf(']');
      if(start === -1 || end === -1) return null;
      const raw = text.slice(start, end + 1);
      try{
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : null;
      }catch{
        return null;
      }
    }
    function renderApprovalShortages(list){
      const box = $('jobApprovalWarnings');
      if(!box) return;
      if(!Array.isArray(list) || !list.length){
        box.style.display = 'none';
        box.innerHTML = '';
        return;
      }
      const rows = list.map(row=>{
        const itemId = String(row.item_id || '').trim();
        const item = getInventoryById(itemId);
        const name = item ? String(item.name || '') : itemId;
        const shortfall = Number(row.shortfall || 0);
        const required = Number(row.required || row.qty_planned || 0);
        const available = Number(row.available || 0);
        return `${escapeHtml(name)}: need ${required}, available ${available} (short ${shortfall})`;
      });
      box.style.display = 'block';
      box.innerHTML = rows.join('<br>');
    }
    const ADD_TO_JOB_NEW_VALUE = '__new__';
    function setAddToJobMessage(msg, isError = false){
      const el = $('addToJobMsg');
      if(!el) return;
      el.textContent = String(msg || '');
      el.style.color = isError ? '#f87171' : 'var(--muted)';
    }
    function getAddToJobJobs(){
      const rows = Array.isArray(state._jobs) ? state._jobs : [];
      return rows
        .filter(r => ['draft','quoted','approved'].includes(String(r && r.status ? r.status : '').trim()))
        .sort((a,b)=>{
          const at = Date.parse(String(a && a.created_at ? a.created_at : '')) || 0;
          const bt = Date.parse(String(b && b.created_at ? b.created_at : '')) || 0;
          return bt - at;
        });
    }
    function renderAddToJobModal(){
      const data = state._addToJob;
      if(!data) return;
      const itemName = $('addToJobItemName');
      const select = $('addToJobSelect');
      const newWrap = $('addToJobNewWrap');
      const newInput = $('addToJobNewName');
      const qtyInput = $('addToJobQty');
      const confirmBtn = $('btnAddToJobConfirm');
      const jobs = Array.isArray(data.jobs) ? data.jobs : [];
      if(itemName) itemName.textContent = String(data.itemName || '');

      const jobIds = new Set(jobs.map(j => String(j && j.id ? j.id : '')).filter(Boolean));
      let selected = data.selectedJobId;
      if(selected && selected !== ADD_TO_JOB_NEW_VALUE && !jobIds.has(selected)) selected = '';
      if(!selected){
        selected = jobs.length ? String(jobs[0].id || '') : ADD_TO_JOB_NEW_VALUE;
      }
      data.selectedJobId = selected;

      if(select){
        const options = [];
        if(jobs.length){
          options.push('<option value="">Select jobâ€¦</option>');
          jobs.forEach(job=>{
            const id = String(job.id || '').trim();
            if(!id) return;
            const name = String(job.name || '').trim() || '(Untitled job)';
            const status = jobStatusLabel(String(job.status || 'draft'));
            options.push(`<option value="${escapeHtmlAttr(id)}">${escapeHtml(name)} â€” ${escapeHtml(status)}</option>`);
          });
        }
        options.push(`<option value="${ADD_TO_JOB_NEW_VALUE}">Create new job</option>`);
        select.innerHTML = options.join('');
        if(selected) select.value = selected;
        select.disabled = !!state._addToJobBusy;
      }

      const isNew = selected === ADD_TO_JOB_NEW_VALUE;
      if(newWrap) newWrap.style.display = isNew ? 'block' : 'none';
      if(newInput && isNew){
        newInput.value = String(data.newJobName || newInput.value || '');
        newInput.disabled = !!state._addToJobBusy;
      }
      if(qtyInput){
        const nextQty = Math.max(1, toInt(qtyInput.value || data.qty || 1, 1));
        qtyInput.value = String(nextQty);
        qtyInput.disabled = !!state._addToJobBusy;
      }
      const minus = $('addToJobQtyMinus');
      const plus = $('addToJobQtyPlus');
      if(minus) minus.disabled = !!state._addToJobBusy;
      if(plus) plus.disabled = !!state._addToJobBusy;
      if(confirmBtn) confirmBtn.disabled = !!state._addToJobBusy;
    }
    async function openAddToJobModal(itemId){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_VIEW, 'Inventory access required')) return;
      const item = getInventoryById(itemId);
      if(!item){ toast('Item not found'); return; }
      state._addToJob = {
        itemId: String(item.id || '').trim(),
        itemName: String(item.name || '').trim(),
        jobs: [],
        selectedJobId: '',
        qty: 1,
        newJobName: ''
      };
      setAddToJobMessage('');
      show('addToJobModal', true);
      renderAddToJobModal();
      try{
        await ensureInventoryLoaded();
        if(!state._jobs || !state._jobs.length){
          const rows = await sbFetchJobs();
          state._jobs = rows;
          state._jobsById = new Map(rows.map(r => [String(r.id || ''), r]).filter(x => x[0]));
        }
        state._addToJob.jobs = getAddToJobJobs();
        renderAddToJobModal();
      }catch(e){
        setAddToJobMessage(e && e.message ? e.message : 'Failed to load jobs', true);
      }
    }
    async function confirmAddToJob(){
      const data = state._addToJob;
      if(!data) return;
      const select = $('addToJobSelect');
      const newInput = $('addToJobNewName');
      const qtyInput = $('addToJobQty');
      const rawQty = qtyInput ? Number(qtyInput.value || 0) : 0;
      const qty = Number.isFinite(rawQty) ? rawQty : 0;
      if(qty <= 0){ setAddToJobMessage('Quantity must be greater than zero.', true); return; }
      const selection = select ? String(select.value || '').trim() : '';
      if(!selection){ setAddToJobMessage('Select a job.', true); return; }
      setAddToJobMessage('');
      state._addToJobBusy = true;
      renderAddToJobModal();
      try{
        let jobId = selection;
        let jobName = '';
        if(selection === ADD_TO_JOB_NEW_VALUE){
          const name = newInput ? String(newInput.value || '').trim() : '';
          if(!name){ setAddToJobMessage('Job name is required.', true); return; }
          const { data: createdId, error } = await SB.client.rpc('create_job', {
            p_company_id: SB.companyId,
            p_name: name,
            p_notes: null
          });
          if(error) throw error;
          jobId = createdId;
          jobName = name;
          await refreshJobs();
        }else{
          const job = (data.jobs || []).find(j => String(j && j.id ? j.id : '') === String(selection));
          jobName = job ? String(job.name || '').trim() : '';
        }
        const { error } = await SB.client.rpc('upsert_job_bom_line', {
          p_job_id: jobId,
          p_item_id: data.itemId,
          p_qty_planned: qty
        });
        if(error) throw error;
        if(state._jobEditor && state._jobEditor.job && String(state._jobEditor.job.id) === String(jobId)){
          state._jobEditor.bomLines = await sbFetchJobBom(jobId);
          renderJobEditor();
        }
        show('addToJobModal', false);
        toast(`Added to ${jobName || 'job'}`);
      }catch(e){
        setAddToJobMessage(e && e.message ? e.message : 'Failed to add item to job', true);
      }finally{
        state._addToJobBusy = false;
        renderAddToJobModal();
      }
    }
    async function openJobEditor(jobId, opts = {}){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!requirePermission(PERMISSIONS.ITEMS_VIEW, 'Inventory access required')) return;

      setJobEditorMessage('');
      setJobBomMessage('');
      setJobCompleteMessage('');
      renderApprovalShortages([]);
      show('jobEditorModal', true);
      state._jobEditorBusy = true;
      renderJobEditor();
      try{
        await ensureInventoryLoaded();
        if(!state._jobs || !state._jobs.length){
          const rows = await sbFetchJobs();
          state._jobs = rows;
          state._jobsById = new Map(rows.map(r => [String(r.id || ''), r]).filter(x => x[0]));
        }
        const reservedMap = await sbFetchReservedMap();
        let job = null;
        let bomLines = [];
        let actuals = [];
        if(jobId){
          job = state._jobsById.get(String(jobId)) || null;
          if(!job){
            const rows = await sbFetchJobs();
            state._jobs = rows;
            state._jobsById = new Map(rows.map(r => [String(r.id || ''), r]).filter(x => x[0]));
            job = state._jobsById.get(String(jobId)) || null;
          }
          if(job){
            bomLines = await sbFetchJobBom(job.id);
            actuals = await sbFetchJobActuals(job.id);
          }
        }else{
          job = { id:null, name:'', status:'draft', notes:'' };
        }
        state._jobEditor = { job, bomLines, actuals, reservedMap };
      }catch(e){
        state._jobEditor = { job: { id:null, name:'', status:'draft', notes:'' }, bomLines:[], actuals:[], reservedMap:new Map() };
        setJobEditorMessage(e && e.message ? e.message : 'Failed to load job');
      }finally{
        state._jobEditorBusy = false;
        renderJobEditor();
        if(opts && opts.focus === 'complete'){
          const section = $('jobCompletionSection');
          if(section) section.scrollIntoView({ behavior:'smooth', block:'start' });
        }
      }
    }
    async function saveJobDetails(){
      const editor = state._jobEditor;
      if(!editor || !editor.job) return;
      const job = editor.job;
      const nameInput = $('jobNameInput');
      const notesInput = $('jobNotesInput');
      const name = nameInput ? String(nameInput.value || '').trim() : '';
      const notes = notesInput ? String(notesInput.value || '').trim() : '';
      if(!name){ setJobEditorMessage('Job name is required.'); return; }
      setJobEditorMessage('');
      const btn = $('btnJobSave');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = job.id ? 'Savingâ€¦' : 'Creatingâ€¦'; }
      try{
        if(!job.id){
          const { data, error } = await SB.client.rpc('create_job', {
            p_company_id: SB.companyId,
            p_name: name,
            p_notes: notes || null
          });
          if(error) throw error;
          job.id = data;
          job.name = name;
          job.notes = notes;
          job.status = 'draft';
          await refreshJobs();
          const refreshed = state._jobsById.get(String(job.id));
          if(refreshed) editor.job = refreshed;
          toast('Job created');
          setJobBomMessage('');
        }else{
          const { error } = await SB.client
            .from('jobs')
            .update({ name, notes: notes || null, updated_at: new Date().toISOString() })
            .eq('id', job.id)
            .eq('company_id', SB.companyId);
          if(error) throw error;
          job.name = name;
          job.notes = notes;
          await refreshJobs();
          toast('Job saved');
        }
      }catch(e){
        setJobEditorMessage(e && e.message ? e.message : 'Save failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Save'; }
        renderJobEditor();
      }
    }
    async function updateJobBomLine(itemId){
      const editor = state._jobEditor;
      if(!editor || !editor.job || !editor.job.id) return;
      const input = document.querySelector(`[data-bom-qty-input="${CSS.escape(itemId)}"]`);
      const qty = input ? Number(input.value || 0) : 0;
      if(!Number.isFinite(qty) || qty <= 0){ setJobBomMessage('Planned quantity must be greater than zero.'); return; }
      setJobBomMessage('');
      try{
        const { error } = await SB.client.rpc('upsert_job_bom_line', {
          p_job_id: editor.job.id,
          p_item_id: itemId,
          p_qty_planned: qty
        });
        if(error) throw error;
        editor.bomLines = await sbFetchJobBom(editor.job.id);
        renderJobEditor();
        toast('BOM updated');
      }catch(e){
        setJobBomMessage(e && e.message ? e.message : 'Failed to update BOM');
      }
    }
    async function removeJobBomLine(itemId){
      const editor = state._jobEditor;
      if(!editor || !editor.job || !editor.job.id) return;
      if(!(await openConfirmModal('Remove BOM line?', 'Remove this item from the planned BOM?', { okText:'Remove', cancelText:'Cancel' }))) return;
      setJobBomMessage('');
      try{
        const { error } = await SB.client
          .from('job_bom')
          .delete()
          .eq('job_id', editor.job.id)
          .eq('item_id', itemId);
        if(error) throw error;
        editor.bomLines = await sbFetchJobBom(editor.job.id);
        renderJobEditor();
        toast('BOM line removed');
      }catch(e){
        setJobBomMessage(e && e.message ? e.message : 'Failed to remove BOM line');
      }
    }
    async function approveJob(jobId, opts = {}){
      const btn = opts.button || document.querySelector(`[data-job-approve-id="${CSS.escape(jobId)}"]`) || $('btnJobApprove');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Approvingâ€¦'; }
      renderApprovalShortages([]);
      try{
        const { data, error } = await SB.client.rpc('approve_job', { p_job_id: jobId });
        if(error) throw error;
        await refreshJobs();
        if(state._jobEditor && state._jobEditor.job && String(state._jobEditor.job.id) === String(jobId)){
          await openJobEditor(jobId);
        }
        toast('Job approved');
        return data;
      }catch(e){
        const msg = e && e.message ? e.message : 'Approval failed';
        const details = parseShortageDetails(msg);
        if(details){
          renderApprovalShortages(details);
          const summary = details.map(row=>{
            const itemId = String(row.item_id || '').trim();
            const item = getInventoryById(itemId);
            const name = item ? String(item.name || '') : itemId;
            const shortfall = Number(row.shortfall || 0);
            return `${name} short ${shortfall}`;
          }).join('; ');
          setJobsMessage(summary);
        }
        toast(msg);
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Approve'; }
      }
    }
    async function completeJob(jobId){
      const btn = $('btnJobComplete');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Completingâ€¦'; }
      setJobCompleteMessage('');
      try{
        const actuals = collectJobActuals();
        const { error } = await SB.client.rpc('complete_job', {
          p_job_id: jobId,
          p_actuals: actuals
        });
        if(error) throw error;
        await refreshJobs();
        try{ await sbLoadSnapshot(); }catch(e){}
        await openJobEditor(jobId);
        toast('Job completed');
      }catch(e){
        setJobCompleteMessage(e && e.message ? e.message : 'Completion failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Complete Job'; }
      }
    }
    async function voidJob(jobId){
      if(!(await openConfirmModal('Void job?', 'This will release reservations and reverse consumption if needed.', { okText:'Void Job', cancelText:'Cancel' }))) return;
      const btn = document.querySelector(`[data-job-void-id="${CSS.escape(jobId)}"]`) || $('btnJobVoid');
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Voidingâ€¦'; }
      try{
        const { error } = await SB.client.rpc('void_job', { p_job_id: jobId });
        if(error) throw error;
        await refreshJobs();
        try{ await sbLoadSnapshot(); }catch(e){}
        if(state._jobEditor && state._jobEditor.job && String(state._jobEditor.job.id) === String(jobId)){
          await openJobEditor(jobId);
        }
        toast('Job voided');
      }catch(e){
        toast(e && e.message ? e.message : 'Void failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Void'; }
      }
    }
    function setTrashMessage(msg){
      const el = $('trashMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function trashSearchText(row){
      const r = row || {};
      const name = String(r.name || '').toLowerCase();
      const desc = String(r.description || '').toLowerCase();
      const qty = String(toInt(r.quantity, 0));
      const deletedBy = String(r.deleted_by_email || '').toLowerCase();
      const deletedAt = String(r.deleted_at || '').toLowerCase();
      return `${name} ${desc} ${qty} ${deletedBy} ${deletedAt}`.trim();
    }
    function renderTrashList(){
      const list = $('trashList');
      if(!list) return;
      const rows = Array.isArray(state._trashItems) ? state._trashItems : [];
      const filter = String(state._trashFilter || '').trim().toLowerCase();
      const filtered = filter ? rows.filter(r => trashSearchText(r).includes(filter)) : rows;
      if(!rows.length){
        list.innerHTML = `<div class="trash-empty">Trash is empty.</div>`;
        return;
      }
      if(!filtered.length){
        list.innerHTML = `<div class="trash-empty">No matches.</div>`;
        return;
      }
      list.innerHTML = filtered.map(row => {
        const id = String(row.id || '').trim();
        const name = String(row.name || '').trim() || '(Unnamed item)';
        const desc = String(row.description || '').trim();
        const qty = toInt(row.quantity, 0);
        const deletedAt = row.deleted_at ? formatEasternDateTime(row.deleted_at) : '';
        const deletedBy = String(row.deleted_by_email || '').trim();
        const metaParts = [];
        if(deletedAt) metaParts.push(`Deleted ${escapeHtml(deletedAt)}`);
        if(deletedBy) metaParts.push(`By ${escapeHtml(deletedBy)}`);
        metaParts.push(`Qty ${qty}`);
        const meta = metaParts.join(' â€¢ ');
        return (
          `<div class="trash-item">`+
            `<div>`+
              `<div class="trash-title">${escapeHtml(name)}</div>`+
              (desc ? `<div class="muted">${escapeHtml(desc)}</div>` : '')+
              `<div class="trash-meta">${meta}</div>`+
            `</div>`+
            `<div>`+
              `<button class="btn-secondary" data-restore-id="${escapeHtmlAttr(id)}">Restore</button>`+
            `</div>`+
          `</div>`
        );
      }).join('');
    }
    async function refreshTrash(){
      const list = $('trashList');
      if(list) list.innerHTML = `<div class="muted">Loadingâ€¦</div>`;
      setTrashMessage('');
      try{
        if(!SB.ready) throw new Error('Supabase not configured');
        if(!SB.session) throw new Error('Sign in required');
        if(!SB.companyId) throw new Error('No company selected');
        if(!canAccessTrash()) throw new Error('Trash access requires delete or restore permission');
        const { data, error } = await SB.client.rpc('get_deleted_items', { p_company_id: SB.companyId });
        if(error) throw error;
        state._trashItems = Array.isArray(data) ? data : [];
        renderTrashList();
      }catch(e){
        state._trashItems = [];
        const msg = e && e.message ? e.message : 'Failed to load trash';
        if(list) list.innerHTML = `<div class="trash-empty">${escapeHtml(msg)}</div>`;
      }
    }
    async function openTrashModal(){
      if(!SB.ready){ toast('Supabase not configured'); return; }
      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
      if(!canAccessTrash()){ toast('Trash access requires delete or restore permission'); return; }
      show('trashModal', true);
      const f = $('trashFilter'); if(f) f.value = state._trashFilter || '';
      await refreshTrash();
    }
    function closeTrashModal(){
      show('trashModal', false);
    }
    function renderOrderResults(){
      const ord = orderState();
      const list = $('orderResultsBody');
      if(!list) return;
      const qRaw = String(ord.search||'').trim();
      const q = toKey(qRaw);

      const items = (state.items||[]).slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      list.innerHTML = '';
      if(!items.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No inventory loaded yet.';
        list.appendChild(empty);
        return;
      }
      if(!qRaw){
        return;
      }

      const hits = items.filter(it=>{
        if(!it) return false;
        const name = toKey(it.name);
        const desc = toKey(it.desc);
        return name.includes(q) || desc.includes(q) || String(toInt(it.qty,0)).includes(qRaw);
      }).slice(0, 20);

      if(!hits.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No matches.';
        list.appendChild(empty);
        return;
      }

      for(const it of hits){
        const card = document.createElement('div');
        card.className = 'order-card';
        const desc = String(it.desc||'').trim();
        const orderQty = getOrderQtyForItem(it.id);
        card.innerHTML =
          `<div class="order-card-top">`+
            `<div class="order-meta">`+
              `<div class="order-title">${escapeHtml(it.name||'')}</div>`+
              (desc ? `<div class="order-sub">${escapeHtml(desc)}</div>` : ``)+
            `</div>`+
            `<div class="order-side">`+
              `<div class="order-kpi">`+
                `<div class="order-kpi-label">On Hand</div>`+
                `<div class="order-kpi-value">${toInt(it.qty,0)}</div>`+
              `</div>`+
              `<div class="qty-stepper">`+
                `<button class="qty-stepper-btn" data-stepper-dec="${it.id}"${orderQty === 0 ? ' disabled style="opacity:0.3"' : ''}>âˆ’</button>`+
                `<span class="qty-stepper-val">${orderQty}</span>`+
                `<button class="qty-stepper-btn" data-stepper-inc="${it.id}">+</button>`+
              `</div>`+
            `</div>`+
          `</div>`;
        list.appendChild(card);
      }
    }
    function renderOrderLines(){
      const ord = orderState();
      const list = $('orderLinesBody');
      const info = $('orderLinesInfo');
      if(!list) return;
      list.innerHTML = '';

      const lines = ord.lines.slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      pruneOrderLineSelection(lines);
      if(info){
        info.textContent = lines.length ? (lines.length === 1 ? '1 item' : `${lines.length} items`) : '';
      }

      if(!lines.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No items in the order yet. Add from inventory above, or pre-select items in the main table before opening Create Order.';
        list.appendChild(empty);
        renderOrderPreview();
        return;
      }

      for(const l of lines){
        const inv = getInventoryById(l.id);
        const onHand = inv ? toInt(inv.qty, 0) : null;
        const card = document.createElement('div');
        card.className = 'order-card order-card--selected';
        card.dataset.orderLineId = l.id;
        const isSelected = orderLineSelection.has(String(l.id || '').trim());
        const selectLabel = `Select ${String(l.name || '').trim() || 'item'} for batch qty edit`;
        const desc = String(l.desc||'').trim();
        card.innerHTML =
          `<div class="order-card-header">`+
            `<div class="order-title">${escapeHtml(l.name||'')}</div>`+
            `<div class="order-inline-kpi"><span class="muted">On Hand</span><span class="order-inline-kpi-val">${onHand===null ? 'â€”' : onHand}</span></div>`+
          `</div>`+
          (desc ? `<div class="order-sub">${escapeHtml(desc)}</div>` : ``)+
          `<div class="order-controls order-controls--compact">`+
            `<label class="order-batch-toggle" title="Select for batch qty edit">`+
              `<input type="checkbox" class="order-line-select" data-order-select-id="${escapeHtmlAttr(l.id)}" aria-label="${escapeHtmlAttr(selectLabel)}"${isSelected ? ' checked' : ''}>`+
            `</label>`+
            `<div class="qty-stepper" data-qty-picker-trigger="${l.id}">`+
              `<button class="qty-stepper-btn" data-line-dec="${l.id}">âˆ’</button>`+
              `<input type="text" inputmode="numeric" pattern="[0-9]*" class="qty-stepper-input" data-line-qty-input="${l.id}" value="${toInt(l.qty,0)}" aria-label="Order quantity">`+
              `<button class="qty-stepper-btn" data-line-inc="${l.id}">+</button>`+
            `</div>`+
            `<button class="icon-btn icon-btn--danger order-remove-btn" data-remove-order-id="${l.id}" title="Remove">`+
              `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`+
            `</button>`+
          `</div>`;
        list.appendChild(card);
      }

      renderOrderPreview();
    }
    function renderOrderPreview(){
      const ord = orderState();
      const wrap = $('orderPreviewHtml');
      const subjectLine = composeOrderSubject(ord);
      ord.subject = subjectLine;
      const subjectInput = $('orderSubject'); if(subjectInput) subjectInput.value = subjectLine;
      const internalInput = $('orderInternalPoNumber'); if(internalInput) internalInput.value = String(ord.internalPoNumber || '').trim();
      if(wrap){
        const html = buildOrderHtml();
        wrap.innerHTML = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" sandbox="allow-same-origin"></iframe>`;
      }
      const shippingPreview = $('orderShippingPreview');
      if(shippingPreview){
        const shippingLines = formatShippingSnapshotLines(getOrderShippingSnapshot(ord));
        shippingPreview.innerHTML = shippingLines.length
          ? shippingLines.map(l => escapeHtml(l)).join('<br>')
          : '<span class="muted">No shipping location selected.</span>';
      }
      const replyEl = $('orderReplyToNote');
      if(replyEl){
        const e = getSignedInEmail();
        replyEl.textContent = e ? `Reply-To: ${e}` : 'Reply-To: (sign in to set)';
      }
      const histBtn = $('btnOrderHistory');
      if(histBtn){
        histBtn.disabled = !(SB.ready && SB.session && SB.authorized && canOrdersView());
      }
      const btn = $('btnOrderSubmit');
      if(btn){
        const okEmail = !!String(ord.email||'').trim();
        const okLines = ord.lines.some(l => toInt(l.qty, 0) > 0);
        const okCompany = !!getOrderCompanyName();
        btn.disabled = !(okEmail && okLines && okCompany);
      }
    }
    async function openOrderModal(opts = {}){
		      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
		      const ord = orderState();
		      const addSelected = !isMobileUx() && !(opts && Object.prototype.hasOwnProperty.call(opts, 'addSelected') && opts.addSelected === false);
		      if(addSelected){
		        const selectedIds = Array.from(document.querySelectorAll('.rowChk:checked'))
		          .map(cb => cb.dataset.id)
		          .filter(Boolean);

	        let added = 0;
	        for(const id of selectedIds){
	          const it = getInventoryById(id);
	          if(it && upsertOrderLineFromItem(it, 1)) added++;
	        }
	        if(added) toast(`Added ${added} selected item(s)`);
	      }

	      ensureOrderIdentifiers(ord);
	      ord.subject = composeOrderSubject(ord);

      const s = $('orderSearch'); if(s) s.value = ord.search || '';
      const e = $('orderEmail'); if(e) e.value = ord.email || '';
      const companyPo = $('orderCompanyPoNumber'); if(companyPo) companyPo.value = ord.companyPoNumber || '';
      const internalPo = $('orderInternalPoNumber'); if(internalPo) internalPo.value = ord.internalPoNumber || '';
      const sub = $('orderSubject'); if(sub) sub.value = ord.subject || '';
      const n = $('orderNotes'); if(n) n.value = ord.notes || '';

      renderOrderResults();
      renderOrderLines();
      try{ await loadOrderShippingOptions(); }catch(e){}
      renderOrderPreview();
      try{ updateOrderSearchClearBtn(); }catch(e){}

      show('orderModal', true);
    }

	    const menuOrder = $('menuOrder');
	    if(menuOrder) menuOrder.addEventListener('click', ()=>{
	      toggleMenu(false);
	      if(!requirePermission(PERMISSIONS.ORDERS_CREATE, 'Order creation not allowed')) return;
	      openOrderModal();
	    });
	    const menuJobs = $('menuJobs');
	    if(menuJobs) menuJobs.addEventListener('click', ()=>{
	      toggleMenu(false);
	      openJobsModal();
	    });
    const menuReceive = $('menuReceive');
    if(menuReceive) menuReceive.addEventListener('click', ()=>{ toggleMenu(false); openOrderHistoryModal({ returnToOrder: false }); });
    const menuHistory = $('menuHistory');
    if(menuHistory) menuHistory.addEventListener('click', ()=>{ toggleMenu(false); openOrderHistoryModal({ returnToOrder: false }); });
    const menuTrash = $('menuTrash');
    if(menuTrash) menuTrash.addEventListener('click', ()=>{ toggleMenu(false); openTrashModal(); });
    const menuAudit = $('menuAudit');
    if(menuAudit) menuAudit.addEventListener('click', ()=>{ toggleMenu(false); openAuditModal(); });
    const menuSnapshots = $('menuSnapshots');
    if(menuSnapshots) menuSnapshots.addEventListener('click', ()=>{ toggleMenu(false); openSnapshotsModal(); });
    const menuMetrics = $('menuMetrics');
    if(menuMetrics) menuMetrics.addEventListener('click', ()=>{ toggleMenu(false); openMetricsModal(); });
    const btnTrashClose = $('btnTrashClose');
    if(btnTrashClose) btnTrashClose.addEventListener('click', closeTrashModal);
    const btnJobsClose = $('btnJobsClose');
    if(btnJobsClose) btnJobsClose.addEventListener('click', closeJobsModal);
    const btnJobsRefresh = $('btnJobsRefresh');
    if(btnJobsRefresh) btnJobsRefresh.addEventListener('click', refreshJobs);
    const btnJobsCreate = $('btnJobsCreate');
    if(btnJobsCreate) btnJobsCreate.addEventListener('click', ()=> openJobEditor(null));
    const jobsList = $('jobsList');
    if(jobsList) jobsList.addEventListener('click', async (e)=>{
      const viewBtn = e.target.closest('[data-job-view-id]');
      if(viewBtn){
        const id = String(viewBtn.getAttribute('data-job-view-id') || '').trim();
        if(id) toggleJobExpanded(id);
        return;
      }
      const toggleRow = e.target.closest('[data-job-toggle-id]');
      if(toggleRow && !e.target.closest('.job-actions')){
        const id = String(toggleRow.getAttribute('data-job-toggle-id') || '').trim();
        if(id) toggleJobExpanded(id);
        return;
      }
      const editBtn = e.target.closest('[data-job-edit-id]');
      if(editBtn){
        const id = String(editBtn.getAttribute('data-job-edit-id') || '').trim();
        if(id) openJobEditor(id);
        return;
      }
      const approveBtn = e.target.closest('[data-job-approve-id]');
      if(approveBtn){
        const id = String(approveBtn.getAttribute('data-job-approve-id') || '').trim();
        if(!id) return;
        if(!(await openConfirmModal('Approve job?', 'This will reserve inventory for the planned BOM.', { okText:'Approve', cancelText:'Cancel' }))) return;
        await approveJob(id);
        return;
      }
      const completeBtn = e.target.closest('[data-job-complete-id]');
      if(completeBtn){
        const id = String(completeBtn.getAttribute('data-job-complete-id') || '').trim();
        if(id) openJobEditor(id, { focus:'complete' });
        return;
      }
      const voidBtn = e.target.closest('[data-job-void-id]');
      if(voidBtn){
        const id = String(voidBtn.getAttribute('data-job-void-id') || '').trim();
        if(id) await voidJob(id);
        return;
      }
    });
    const btnJobEditorClose = $('btnJobEditorClose');
    if(btnJobEditorClose) btnJobEditorClose.addEventListener('click', ()=> show('jobEditorModal', false));
    const btnJobSave = $('btnJobSave');
    if(btnJobSave) btnJobSave.addEventListener('click', saveJobDetails);
    const jobBomTable = $('jobBomTable');
    if(jobBomTable) jobBomTable.addEventListener('click', (e)=>{
      const updateBtn = e.target.closest('[data-bom-update-id]');
      if(updateBtn){
        const itemId = String(updateBtn.getAttribute('data-bom-update-id') || '').trim();
        if(itemId) updateJobBomLine(itemId);
        return;
      }
      const removeBtn = e.target.closest('[data-bom-remove-id]');
      if(removeBtn){
        const itemId = String(removeBtn.getAttribute('data-bom-remove-id') || '').trim();
        if(itemId) removeJobBomLine(itemId);
        return;
      }
    });
    if(jobBomTable) jobBomTable.addEventListener('input', (e)=>{
      const input = e.target;
      if(!input || !input.matches || !input.matches('[data-bom-qty-input]')) return;
      const itemId = String(input.getAttribute('data-bom-qty-input') || '').trim();
      const qty = Number(input.value || 0);
      if(itemId) updateBomIndicators(itemId, qty);
    });
    const btnJobApprove = $('btnJobApprove');
    if(btnJobApprove) btnJobApprove.addEventListener('click', async ()=>{
      const editor = state._jobEditor;
      const jobId = editor && editor.job ? editor.job.id : null;
      if(!jobId) return;
      if(!(await openConfirmModal('Approve job?', 'This will reserve inventory for the planned BOM.', { okText:'Approve', cancelText:'Cancel' }))) return;
      await approveJob(jobId, { button: btnJobApprove });
    });
    const btnJobComplete = $('btnJobComplete');
    if(btnJobComplete) btnJobComplete.addEventListener('click', ()=>{
      const editor = state._jobEditor;
      const jobId = editor && editor.job ? editor.job.id : null;
      if(jobId) completeJob(jobId);
    });
    const btnJobVoid = $('btnJobVoid');
    if(btnJobVoid) btnJobVoid.addEventListener('click', ()=>{
      const editor = state._jobEditor;
      const jobId = editor && editor.job ? editor.job.id : null;
      if(jobId) voidJob(jobId);
    });
    const btnAddToJobCancel = $('btnAddToJobCancel');
    if(btnAddToJobCancel) btnAddToJobCancel.addEventListener('click', ()=> show('addToJobModal', false));
    const btnAddToJobConfirm = $('btnAddToJobConfirm');
    if(btnAddToJobConfirm) btnAddToJobConfirm.addEventListener('click', confirmAddToJob);
    const addToJobSelect = $('addToJobSelect');
    if(addToJobSelect) addToJobSelect.addEventListener('change', ()=>{
      if(!state._addToJob) return;
      state._addToJob.selectedJobId = String(addToJobSelect.value || '').trim();
      setAddToJobMessage('');
      renderAddToJobModal();
    });
    const addToJobNewName = $('addToJobNewName');
    if(addToJobNewName) addToJobNewName.addEventListener('input', ()=>{
      if(!state._addToJob) return;
      state._addToJob.newJobName = String(addToJobNewName.value || '');
    });
    const addToJobQty = $('addToJobQty');
    if(addToJobQty) addToJobQty.addEventListener('input', ()=>{
      if(!state._addToJob) return;
      state._addToJob.qty = Math.max(1, toInt(addToJobQty.value, 1));
    });
    const addToJobQtyMinus = $('addToJobQtyMinus');
    if(addToJobQtyMinus) addToJobQtyMinus.addEventListener('click', ()=>{
      const inp = $('addToJobQty');
      if(!inp) return;
      inp.value = Math.max(1, toInt(inp.value, 1) - 1);
      if(state._addToJob) state._addToJob.qty = toInt(inp.value, 1);
    });
    const addToJobQtyPlus = $('addToJobQtyPlus');
    if(addToJobQtyPlus) addToJobQtyPlus.addEventListener('click', ()=>{
      const inp = $('addToJobQty');
      if(!inp) return;
      inp.value = Math.max(1, toInt(inp.value, 1) + 1);
      if(state._addToJob) state._addToJob.qty = toInt(inp.value, 1);
    });
    const btnTrashReload = $('btnTrashReload');
    if(btnTrashReload) btnTrashReload.addEventListener('click', refreshTrash);
    const trashFilter = $('trashFilter');
    if(trashFilter) trashFilter.addEventListener('input', ()=>{
      state._trashFilter = trashFilter.value || '';
      renderTrashList();
    });
    const trashList = $('trashList');
    if(trashList) trashList.addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-restore-id]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-restore-id') || '').trim();
      if(!id) return;
      if(!canItemsRestore()){ toast('Restore not allowed'); return; }
      const row = Array.isArray(state._trashItems) ? state._trashItems.find(r => String(r && r.id ? r.id : '') === id) : null;
      const name = row && row.name ? String(row.name) : 'item';
      if(!(await openConfirmModal('Restore item?', `Restore "${name}" from trash?`, { okText:'Restore', cancelText:'Cancel' }))) return;
      btn.disabled = true;
      btn.setAttribute('aria-disabled', 'true');
      try{
        const { data, error } = await SB.client.rpc('restore_item', { p_item_id: id });
        if(error) throw error;
        if(data && data.success === false){
          throw new Error(data.error || 'Restore failed');
        }
        state._trashItems = (state._trashItems || []).filter(r => String(r && r.id ? r.id : '') !== id);
        renderTrashList();
        try{ await sbLoadSnapshot(); }catch(e){}
        toast('Item restored');
      }catch(err){
        toast(err && err.message ? err.message : 'Restore failed');
      }finally{
        btn.disabled = false;
        btn.setAttribute('aria-disabled', 'false');
      }
    });
    const btnAuditClose = $('btnAuditClose');
    if(btnAuditClose) btnAuditClose.addEventListener('click', closeAuditModal);
    const btnAuditRefresh = $('btnAuditRefresh');
    if(btnAuditRefresh) btnAuditRefresh.addEventListener('click', refreshAuditLog);
    const auditTableFilter = $('auditTableFilter');
    if(auditTableFilter) auditTableFilter.addEventListener('change', ()=>{
      state._auditTableFilter = auditTableFilter.value || '';
      refreshAuditLog();
    });
    const auditActionFilter = $('auditActionFilter');
    if(auditActionFilter) auditActionFilter.addEventListener('change', ()=>{
      state._auditActionFilter = auditActionFilter.value || '';
      refreshAuditLog();
    });
    const auditSearchFilter = $('auditSearchFilter');
    if(auditSearchFilter) auditSearchFilter.addEventListener('input', ()=>{
      state._auditSearch = auditSearchFilter.value || '';
      renderAuditList();
    });
    const btnAuditDownload = $('btnAuditDownload');
    if(btnAuditDownload) btnAuditDownload.addEventListener('click', downloadAuditCsv);
    const btnSnapshotsClose = $('btnSnapshotsClose');
    if(btnSnapshotsClose) btnSnapshotsClose.addEventListener('click', closeSnapshotsModal);
    const btnSnapshotBack = $('btnSnapshotBack');
    if(btnSnapshotBack) btnSnapshotBack.addEventListener('click', showSnapshotList);
    const snapshotsList = $('snapshotsList');
    if(snapshotsList) snapshotsList.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-snapshot-preview-id]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-snapshot-preview-id') || '').trim();
      if(!id) return;
      openSnapshotPreview(id);
    });
    const btnMetricsClose = $('btnMetricsClose');
    if(btnMetricsClose) btnMetricsClose.addEventListener('click', closeMetricsModal);
    const metricsRange = $('metricsRange');
    if(metricsRange) metricsRange.addEventListener('change', loadMetrics);
    const metricsView = $('metricsView');
    if(metricsView) metricsView.addEventListener('change', loadMetrics);
		    const menuReport = $('menuReport');
		    if(menuReport) menuReport.addEventListener('click', ()=>{
		      toggleMenu(false);
		      if(!canItemsView()){ toast('Report access requires view permission'); return; }
		      openReportModal();
		    });
		    const btnReportClose = $('btnReportClose');
		    if(btnReportClose) btnReportClose.addEventListener('click', closeReportModal);
				    const btnReportBatchOrder = $('btnReportBatchOrder');
				    if(btnReportBatchOrder) btnReportBatchOrder.addEventListener('click', (e)=>{
				      try{ e.preventDefault(); e.stopPropagation(); }catch(ex){}
				      batchAddLowStockToCart();
				    });
				    const btnReportDownload = $('btnReportDownload');
				    if(btnReportDownload) btnReportDownload.addEventListener('click', downloadInventoryReportCsv);
				    const btnReportShare = $('btnReportShare');
				    if(btnReportShare) btnReportShare.addEventListener('click', ()=>{ void shareInventoryReport(); });
				    const reportLowStockList = $('reportLowStockList');
				    const reportExemptList = $('reportExemptList');
				    const reportInventoryList = $('reportList');
				    function toggleOrderFromReportClick(e){
				      const row = e.target.closest('button[data-report-order-id]');
				      if(!row) return;
			      e.preventDefault();
			      e.stopPropagation();
			      const id = String(row.dataset.reportOrderId || '').trim();
			      if(!id) return;
			      const item = getInventoryById(id);
			      if(!item) return;
				      const ord = orderState();
				      const exists = Array.isArray(ord.lines) && ord.lines.some(l => String(l && l.id ? l.id : '').trim() === id);
				      if(exists) removeOrderLine(id);
				      else upsertOrderLineFromItem(item, 1);
					    }
				    if(reportLowStockList) reportLowStockList.addEventListener('click', toggleOrderFromReportClick);
				    if(reportExemptList) reportExemptList.addEventListener('click', toggleOrderFromReportClick);
				    if(reportInventoryList) reportInventoryList.addEventListener('click', toggleOrderFromReportClick);
				    const btnReportEmailClose = $('btnReportEmailClose');
				    if(btnReportEmailClose) btnReportEmailClose.addEventListener('click', closeReportEmailModal);
				    const btnReportEmailCopy = $('btnReportEmailCopy');
		    if(btnReportEmailCopy) btnReportEmailCopy.addEventListener('click', async ()=>{
		      try{
		        const html = String(_reportEmailHtml || '').trim();
		        if(!html){ toast('Nothing to copy'); return; }
		        await navigator.clipboard.writeText(html);
		        toast('Copied');
		      }catch(e){
		        toast('Copy failed');
		      }
		    });
		    const btnReportEmailSend = $('btnReportEmailSend');
		    if(btnReportEmailSend) btnReportEmailSend.addEventListener('click', async ()=>{
		      const to = String($('reportEmailTo')?.value || '').trim();
		      const subjectLine = String($('reportEmailSubject')?.value || '').trim() || defaultInventoryReportEmailSubject();
		      const html = String(_reportEmailHtml || '').trim();
		      setReportEmailMessage('');
		      if(!looksLikeEmailAddress(to)){ setReportEmailMessage('Enter a valid email.'); return; }
		      if(!html){ setReportEmailMessage('Nothing to send.'); return; }

		      const prior = btnReportEmailSend.textContent;
		      btnReportEmailSend.disabled = true;
		      btnReportEmailSend.textContent = 'Sendingâ€¦';
		      try{
		        await sendInventoryReportEmailViaApi({ toEmail: to, subjectLine, html });
		        toast('Report sent');
		        closeReportEmailModal();
		      }catch(e){
		        const msg = (e && e.message) ? String(e.message) : 'Send failed';
		        setReportEmailMessage(msg);
		        const fallback = await openConfirmModal('Send failed', `${msg}\n\nOpen your email app with a text report instead?`, { okText:'Open Email', cancelText:'Stay' });
		        if(fallback){
		          const data = reportDataSnapshot();
		          const text = buildInventoryReportText(data, { maxLines: 180 });
		          const stamp = new Date().toISOString().slice(0,10);
		          const subject = subjectLine || `Inventory Report (${stamp})`;
		          const mailto = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
		          window.location.href = mailto;
		        }
		      }finally{
		        btnReportEmailSend.disabled = false;
		        btnReportEmailSend.textContent = prior || 'Send';
		      }
		    });
	    const btnOrderHistory = $('btnOrderHistory');
	    if(btnOrderHistory) btnOrderHistory.addEventListener('click', ()=> openOrderHistoryModal({ returnToOrder: true }));
	    const btnOrderHistoryClose = $('btnOrderHistoryClose');
	    if(btnOrderHistoryClose) btnOrderHistoryClose.addEventListener('click', closeOrderHistoryModal);
	    const btnOrderHistoryDownload = $('btnOrderHistoryDownload');
	    if(btnOrderHistoryDownload) btnOrderHistoryDownload.addEventListener('click', downloadOrderHistoryCsv);
	    const btnOrderHistoryRefresh = $('btnOrderHistoryRefresh');
	    if(btnOrderHistoryRefresh) btnOrderHistoryRefresh.addEventListener('click', refreshOrderHistory);
	    const btnReceiveOrderClose = $('btnReceiveOrderClose');
	    if(btnReceiveOrderClose) btnReceiveOrderClose.addEventListener('click', closeReceiveOrderModal);
	    const btnReceiveOrderCancel = $('btnReceiveOrderCancel');
	    if(btnReceiveOrderCancel) btnReceiveOrderCancel.addEventListener('click', closeReceiveOrderModal);
	    const btnReceiveOrderSave = $('btnReceiveOrderSave');
	    if(btnReceiveOrderSave) btnReceiveOrderSave.addEventListener('click', handleSaveReceiptDraft);
	    const btnReceiveOrderComplete = $('btnReceiveOrderComplete');
	    if(btnReceiveOrderComplete) btnReceiveOrderComplete.addEventListener('click', handleCompleteReceipt);
	    const receiveOrderLines = $('receiveOrderLines');
	    if(receiveOrderLines){
	      receiveOrderLines.addEventListener('input', (e)=>{
	        const inp = e.target.closest('input[data-receive-line-key]');
	        if(!inp) return;
	        updateReceiveLineFromInput(inp, { format:false });
	      });
	      receiveOrderLines.addEventListener('change', (e)=>{
	        const inp = e.target.closest('input[data-receive-line-key]');
	        if(!inp) return;
	        updateReceiveLineFromInput(inp, { format:true, showError:true });
	      });
	    }
	    const receiveOrderReceipts = $('receiveOrderReceipts');
	    if(receiveOrderReceipts) receiveOrderReceipts.addEventListener('click', (e)=>{
	      const btn = e.target.closest('button[data-void-receipt-id]');
	      if(!btn) return;
	      const id = String(btn.dataset.voidReceiptId || '').trim();
	      if(!id) return;
	      void handleVoidReceipt(id, btn);
	    });

    const btnShippingAddressClose = $('btnShippingAddressClose');
    if(btnShippingAddressClose) btnShippingAddressClose.addEventListener('click', closeShippingAddressModal);
    const btnShippingAddressNew = $('btnShippingAddressNew');
    if(btnShippingAddressNew) btnShippingAddressNew.addEventListener('click', clearShippingAddressForm);
    const btnShippingAddressSave = $('btnShippingAddressSave');
    if(btnShippingAddressSave) btnShippingAddressSave.addEventListener('click', async ()=>{
      setShippingAddressMessage('');
      try{
        await saveShippingAddress();
        toast('Shipping address saved');
      }catch(e){
        setShippingAddressMessage(e && e.message ? e.message : 'Save failed');
      }
    });
    const shippingAddressList = $('shippingAddressList');
    if(shippingAddressList) shippingAddressList.addEventListener('click', async (e)=>{
      const editBtn = e.target.closest('[data-shipping-edit]');
      const delBtn = e.target.closest('[data-shipping-delete]');
      if(editBtn){
        const id = String(editBtn.getAttribute('data-shipping-edit') || '').trim();
        const row = state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
          ? state._shippingAddressById.get(id)
          : null;
        if(!row) return;
        state._shippingAddressEditing = id;
        const label = $('shippingAddressLabel'); if(label) label.value = row.label || '';
        const address = $('shippingAddressValue'); if(address) address.value = row.address || '';
        const isDefault = $('shippingAddressDefault'); if(isDefault) isDefault.checked = !!row.is_default;
        const title = $('shippingAddressFormTitle'); if(title) title.textContent = 'Edit Shipping Address';
        return;
      }
      if(delBtn){
        const id = String(delBtn.getAttribute('data-shipping-delete') || '').trim();
        if(!id) return;
        const ok = await openConfirmModal('Delete address?', 'Delete this shipping address?', { okText:'Delete', cancelText:'Cancel' });
        if(!ok) return;
        try{
          await deleteShippingAddress(id);
          toast('Shipping address deleted');
        }catch(e){
          toast(e && e.message ? e.message : 'Delete failed');
        }
      }
    });
    const btnCompanyLocationsClose = $('btnCompanyLocationsClose');
    if(btnCompanyLocationsClose) btnCompanyLocationsClose.addEventListener('click', ()=>{
      void closeCompanyLocationsModal();
    });
    const btnCompanyLocationNew = $('btnCompanyLocationNew');
    if(btnCompanyLocationNew) btnCompanyLocationNew.addEventListener('click', ()=>{
      if(!canManageCompanyLocations()){
        toast('Location permissions required');
        return;
      }
      clearCompanyLocationForm();
      openCompanyLocationEditor();
    });
    const btnCompanyLocationSave = $('btnCompanyLocationSave');
    if(btnCompanyLocationSave) btnCompanyLocationSave.addEventListener('click', saveCompanyLocation);
    const btnCompanyLocationCancel = $('btnCompanyLocationCancel');
    if(btnCompanyLocationCancel) btnCompanyLocationCancel.addEventListener('click', closeCompanyLocationEditor);
    const companyLocationsList = $('companyLocationsList');
    if(companyLocationsList) companyLocationsList.addEventListener('click', async (e)=>{
      const editBtn = e.target.closest('[data-location-edit]');
      if(editBtn){
        const id = String(editBtn.getAttribute('data-location-edit') || '').trim();
        if(!id) return;
        openCompanyLocationEditor(id);
        return;
      }
      const defaultBtn = e.target.closest('[data-location-default]');
      if(defaultBtn){
        const id = String(defaultBtn.getAttribute('data-location-default') || '').trim();
        const type = String(defaultBtn.getAttribute('data-default-type') || '').trim();
        if(!id || !type) return;
        const prior = defaultBtn.textContent;
        defaultBtn.disabled = true;
        defaultBtn.textContent = 'Saving...';
        setCompanyLocationsMessage('');
        try{
          await setDefaultCompanyLocation(id, type);
          toast('Default updated');
        }catch(err){
          setCompanyLocationsMessage(err && err.message ? err.message : 'Default update failed');
        }finally{
          defaultBtn.disabled = false;
          defaultBtn.textContent = prior || 'Set Default';
        }
        return;
      }
      const archiveBtn = e.target.closest('[data-location-archive]');
      if(archiveBtn){
        const id = String(archiveBtn.getAttribute('data-location-archive') || '').trim();
        if(!id) return;
        const prior = archiveBtn.textContent;
        archiveBtn.disabled = true;
        archiveBtn.textContent = 'Archiving...';
        setCompanyLocationsMessage('');
        try{
          await archiveCompanyLocation(id);
        }catch(err){
          setCompanyLocationsMessage(err && err.message ? err.message : 'Archive failed');
        }finally{
          archiveBtn.disabled = false;
          archiveBtn.textContent = prior || 'Archive';
        }
        return;
      }
      const restoreBtn = e.target.closest('[data-location-restore]');
      if(restoreBtn){
        const id = String(restoreBtn.getAttribute('data-location-restore') || '').trim();
        if(!id) return;
        const prior = restoreBtn.textContent;
        restoreBtn.disabled = true;
        restoreBtn.textContent = 'Restoring...';
        setCompanyLocationsMessage('');
        try{
          await restoreCompanyLocation(id);
        }catch(err){
          setCompanyLocationsMessage(err && err.message ? err.message : 'Restore failed');
        }finally{
          restoreBtn.disabled = false;
          restoreBtn.textContent = prior || 'Restore';
        }
      }
    });

	    const orderHistoryFilter = $('orderHistoryFilter');
	    if(orderHistoryFilter){
	      updateOrderHistoryFilterClearBtn();
	      orderHistoryFilter.addEventListener('input', ()=>{
	        state._orderHistoryFilter = orderHistoryFilter.value || '';
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	      });
	      orderHistoryFilter.addEventListener('keydown', (e)=>{
	        if(e.key==='Escape' && orderHistoryFilter.value){
	          e.preventDefault();
	          orderHistoryFilter.value = '';
	          state._orderHistoryFilter = '';
	          renderOrderHistoryFiltered();
	          updateOrderHistoryFilterClearBtn();
	        }
	      });
	    }
	    const btnClearOrderHistoryFilter = $('btnClearOrderHistoryFilter');
	    if(btnClearOrderHistoryFilter && orderHistoryFilter){
	      btnClearOrderHistoryFilter.addEventListener('click', ()=>{
	        if(!orderHistoryFilter.value) return;
	        orderHistoryFilter.value = '';
	        state._orderHistoryFilter = '';
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	        try{ orderHistoryFilter.focus(); }catch(e){}
	      });
	    }
	    const btnOrderCancel = $('btnOrderCancel');
	    if(btnOrderCancel) btnOrderCancel.addEventListener('click', ()=> show('orderModal', false));
    const btnResetOrderList = $('btnResetOrderList');
    if(btnResetOrderList) btnResetOrderList.addEventListener('click', ()=> {
      clearAllOrderLines();
      renderOrderLines();
      toast('Order list cleared');
    });
    const btnOrderCopy = $('btnOrderCopy');
    if(btnOrderCopy) btnOrderCopy.addEventListener('click', copyOrderToClipboard);
    const btnOrderSubmit = $('btnOrderSubmit');
    if(btnOrderSubmit) btnOrderSubmit.addEventListener('click', async ()=>{
      const url = buildMailtoUrl();
      if(!url){ toast('Add at least 1 item and an email'); return; }
      if(!requirePermission(PERMISSIONS.ORDERS_CREATE, 'Order creation not allowed')) return;

      const btn = $('btnOrderSubmit');
      const priorText = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Submittingâ€¦'; }

	      try{
	        const sendRes = await sendOrderViaApi();
	        let historySaved = false;
	        try{
	          const ord = orderState();
	          await sbRecordOrderRecipient(ord.email, ord.contactName);
	        }catch{}
	        try{
	          await sbInsertOrderHistory(sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes);
	          historySaved = true;
	        }catch{}
	        toast(historySaved ? 'Order sent' : 'Order sent (history not saved)');
	        try{
	          clearAllOrderLines();
	          renderOrderResults();
	          renderOrderLines();
	          resetOrderIdentifiers();
	          const companyPo = $('orderCompanyPoNumber'); if(companyPo) companyPo.value = '';
	          const internalPo = $('orderInternalPoNumber'); if(internalPo) internalPo.value = orderState().internalPoNumber || '';
	        }catch(e){}
	        show('orderModal', false);
	      }catch(e){
	        const msg = e && e.message ? e.message : 'Send failed';
	        const fallback = await openConfirmModal('Send failed', `${msg}\n\nOpen your email app instead?`, { okText:'Open Email', cancelText:'Cancel' });
	        if(fallback){ window.location.href = url; }
	        else { toast(msg); }
	      }finally{
	        if(btn){ btn.textContent = priorText || 'Submit Order'; }
	        renderOrderPreview();
	      }
    });

    const orderSearch = $('orderSearch');
    if(orderSearch){
      updateOrderSearchClearBtn();
      orderSearch.addEventListener('input', ()=>{
        const ord = orderState();
        ord.search = orderSearch.value || '';
        renderOrderResults();
        updateOrderSearchClearBtn();
      });
      orderSearch.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && orderSearch.value){
          e.preventDefault();
          orderSearch.value = '';
          const ord = orderState();
          ord.search = '';
          renderOrderResults();
          updateOrderSearchClearBtn();
        }
      });
    }
    const btnClearOrderSearch = $('btnClearOrderSearch');
    if(btnClearOrderSearch && orderSearch){
      btnClearOrderSearch.addEventListener('click', ()=>{
        if(!orderSearch.value) return;
        orderSearch.value = '';
        const ord = orderState();
        ord.search = '';
        renderOrderResults();
        updateOrderSearchClearBtn();
        try{ orderSearch.focus(); }catch(e){}
      });
    }
	    const orderEmail = $('orderEmail');
	    if(orderEmail) orderEmail.addEventListener('input', ()=>{
	      const ord = orderState();
	      ord.email = orderEmail.value || '';
	      renderOrderPreview();
	      requestOrderEmailSuggestions(ord.email);
	    });
	    if(orderEmail) orderEmail.addEventListener('focus', ()=> requestOrderEmailSuggestions(orderEmail.value || ''));
	    if(orderEmail) orderEmail.addEventListener('blur', ()=>{
	      // Defer so clicks on suggestions can still be handled.
	      setTimeout(()=>{
	        const wrap = $('orderEmailSuggest');
	        if(!wrap || !wrap.classList.contains('has-suggest')) return;
	        const ae = document.activeElement;
	        if(ae && wrap.contains(ae)) return;
	        hideOrderEmailSuggestions();
	      }, 0);
	    });
	    const orderCompanyPoNumber = $('orderCompanyPoNumber');
	    if(orderCompanyPoNumber) orderCompanyPoNumber.addEventListener('input', ()=>{
	      const ord = orderState();
	      ord.companyPoNumber = orderCompanyPoNumber.value || '';
	      ord.subject = composeOrderSubject(ord);
	      renderOrderPreview();
	    });
	    const orderShippingAddress = $('orderShippingAddress');
	    if(orderShippingAddress) orderShippingAddress.addEventListener('change', ()=>{
	      const ord = orderState();
	      const selected = String(orderShippingAddress.value || '').trim();
	      ord.shippingAddressId = selected;
	      const row = (state._orderShippingById && typeof state._orderShippingById.get === 'function'
	        ? state._orderShippingById.get(selected)
	        : null)
	        || (state._shippingAddressById && typeof state._shippingAddressById.get === 'function'
	          ? state._shippingAddressById.get(selected)
	          : null);
	      ord.shippingAddressSnapshot = row ? { label: row.label, address: row.address } : null;
	      renderOrderPreview();
	    });
	    const btnOrderShippingManage = $('btnOrderShippingManage');
	    if(btnOrderShippingManage) btnOrderShippingManage.addEventListener('click', openCompanyLocationsModal);
    const orderNotes = $('orderNotes');
    if(orderNotes) orderNotes.addEventListener('input', ()=>{
      const ord = orderState();
      ord.notes = orderNotes.value || '';
      renderOrderPreview();
    });

	    const orderResultsBody = $('orderResultsBody');
	    if(orderResultsBody) orderResultsBody.addEventListener('click', async (e)=>{
	      const val = e.target.closest('.qty-stepper-val');
	      if(val){
	        const stepper = val.closest('.qty-stepper');
	        if(!stepper) return;
	        const id = String(
	          stepper.querySelector('button[data-stepper-inc]')?.getAttribute('data-stepper-inc')
	          || stepper.querySelector('button[data-stepper-dec]')?.getAttribute('data-stepper-dec')
	          || ''
	        ).trim();
	        if(!id) return;
	        const it = getInventoryById(id);
	        if(!it) return;
	        const currentQty = getOrderQtyForItem(id);
	        const name = String(it.name || '').trim();
	        const next = await openQtyEntryModal('Order Qty', name || 'Order Qty', currentQty, { min:0, okText:'Set', cancelText:'Cancel' });
	        if(next === null || typeof next === 'undefined') return;
	        const desiredQty = Math.max(0, toInt(next, currentQty));
	        if(desiredQty === currentQty) return;
	        if(desiredQty <= 0){
	          if(currentQty > 0) removeOrderLine(id);
	        }else{
	          if(currentQty === 0) upsertOrderLineFromItem(it, desiredQty);
	          else setOrderQty(id, desiredQty);
	        }
	        renderOrderResults();
	        renderOrderLines();
	        return;
	      }
	      const incBtn = e.target.closest('button[data-stepper-inc]');
	      const decBtn = e.target.closest('button[data-stepper-dec]');
	      if(incBtn){
	        const id = incBtn.getAttribute('data-stepper-inc');
	        const it = getInventoryById(id);
        if(!it) return;
        const currentQty = getOrderQtyForItem(id);
        if(currentQty === 0){
          upsertOrderLineFromItem(it, 1);
        } else {
          setOrderQty(id, currentQty + 1);
        }
        renderOrderResults();
        renderOrderLines();
      } else if(decBtn){
        const id = decBtn.getAttribute('data-stepper-dec');
        const currentQty = getOrderQtyForItem(id);
        if(currentQty <= 1){
          removeOrderLine(id);
        } else {
          setOrderQty(id, currentQty - 1);
        }
        renderOrderResults();
        renderOrderLines();
      }
    });

	    const orderEmailSuggest = $('orderEmailSuggest');
	    if(orderEmailSuggest) orderEmailSuggest.addEventListener('click', (e)=>{
	      const btn = e.target.closest('button[data-suggest-email]');
	      if(!btn) return;
	      const email = String(btn.dataset.suggestEmail || '').trim();
      if(!email) return;
      const ord = orderState();
      ord.email = email;
      const inp = $('orderEmail'); if(inp) inp.value = email;
	      renderOrderPreview();
	      hideOrderEmailSuggestions();
	    });
	    if(orderEmailSuggest) orderEmailSuggest.addEventListener('mouseleave', (e)=>{
	      // Only close when the mouse leaves below the last entry (not when moving back to the input).
	      try{
	        const rect = orderEmailSuggest.getBoundingClientRect();
	        if(e && typeof e.clientY === 'number' && e.clientY >= rect.bottom - 1){
	          hideOrderEmailSuggestions();
	        }
	      }catch(e){}
	    });
	    document.addEventListener('pointerdown', (e)=>{
	      const wrap = $('orderEmailSuggest');
	      if(!wrap || !wrap.classList.contains('has-suggest')) return;
	      const inp = $('orderEmail');
	      const t = e && e.target ? e.target : null;
	      if(t && wrap.contains(t)) return;
	      if(inp && (t === inp || (t && inp.contains(t)))) return;
	      hideOrderEmailSuggestions();
	    });

    const orderHistoryList = $('orderHistoryList');
    if(orderHistoryList) orderHistoryList.addEventListener('input', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      if(btn) btn.disabled = !looksLikeEmailAddress(inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('focusin', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('click', async (e)=>{
      if(isMobileUx() && _openHistoryTrayId){
        const openDet = orderHistoryItemElById(_openHistoryTrayId);
        const trayBtn = e.target.closest('button.history-tray-btn');
        if(openDet && !trayBtn){
          e.preventDefault();
          e.stopPropagation();
          closeHistoryTrayElastic(openDet);
          return;
        }
        if(!openDet) _openHistoryTrayId = '';
      }
      const recvBtn = e.target.closest('button[data-receive-order-id]');
      if(recvBtn){
        e.preventDefault();
        e.stopPropagation();
        const id = String(recvBtn.dataset.receiveOrderId || '').trim();
        if(!id) return;
        closeHistoryTray();
        void handleOrderReceiptButtonClick(id, recvBtn);
        return;
      }
      // Delete order button
      const delBtn = e.target.closest('button[data-delete-order-id]');
	      if(delBtn){
	        e.preventDefault();
		        e.stopPropagation();
		        const id = String(delBtn.dataset.deleteOrderId || '').trim();
		        if(!id) return;
		        closeHistoryTray();
		        await deleteOrderFromHistory(id, delBtn);
	        return;
	      }
      const sugBtn = e.target.closest('button[data-forward-suggest-email]');
      if(sugBtn){
        const email = String(sugBtn.dataset.forwardSuggestEmail || '').trim();
        const wrap = sugBtn.closest('[data-forward-suggest-id]');
        const id = wrap ? String(wrap.dataset.forwardSuggestId || '').trim() : '';
        if(id && email){
          const inp = document.querySelector(`input[data-forward-email-id="${id}"]`);
          if(inp) inp.value = email;
          const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
          if(btn) btn.disabled = false;
          renderForwardEmailSuggestions(id, []);
        }
        return;
      }
      const fwdBtn = e.target.closest('button[data-forward-send-id]');
      if(fwdBtn){
        const id = String(fwdBtn.dataset.forwardSendId || '').trim();
        if(!id) return;
        void forwardOrderFromHistory(id);
      }
    });

	    // Order History (mobile): swipe to reveal Receive/Delete
	    if(orderHistoryList){
	      let _histGesture = null;
	      function resetHistGesture(){ _histGesture = null; }
	      function isOrderHistoryModalOpen(){
	        const m = $('orderHistoryModal');
	        return !!(m && m.getAttribute('aria-hidden') === 'false');
	      }
	      function isBlockingModalOpenForHistory(){
	        try{
	          const open = Array.from(document.querySelectorAll('.modal-backdrop[aria-hidden="false"]'));
	          return open.some(el => el && el.id !== 'orderHistoryModal');
	        }catch(e){ return false; }
	      }
	      function findTouchById(list, id){
	        try{
	          for(let i=0;i<list.length;i++){
	            const t = list[i];
	            if(t && t.identifier === id) return t;
	          }
	        }catch(e){}
	        return null;
	      }

	      orderHistoryList.addEventListener('touchstart', (e)=>{
	        if(!isMobileUx()) return;
	        if(!isOrderHistoryModalOpen()) return;
	        if(isBlockingModalOpenForHistory()) return;
	        if(!e || !e.target) return;

	        const det = e.target.closest('details.history-item[data-order-id]');
	        if(!det) return;
	        const id = String(det.dataset.orderId || '').trim();
	        if(!id) return;

		        // Allow re-swiping the open item even though the tray overlay covers it.
		        // Only ignore direct taps on tray buttons so normal button clicks still work.
		        if(e.target.closest('button.history-tray-btn')) return;
		        if(e.target.closest('button, input, textarea, select, a')) return;

	        const t = (e.touches && e.touches[0]) ? e.touches[0] : null;
	        if(!t) return;

	        const now = performance.now();
	        const startSwipeX = getRowSwipeX(det);
	        const startSide = (startSwipeX < 0) ? 'right' : ((startSwipeX > 0) ? 'left' : null);
	        _histGesture = {
	          id,
	          det,
	          kind: 'touch',
	          touchId: t.identifier,
	          startX: t.clientX,
	          startY: t.clientY,
	          startTime: now,
	          prevMoveTime: now,
	          lastMoveTime: now,
	          prevMoveClientX: t.clientX,
	          lastMoveClientX: t.clientX,
	          startSwipeX,
	          swipeX: startSwipeX,
	          moved: false,
	          intent: null, // 'h' | 'v'
	          side: startSide, // 'left' | 'right'
	          closingFromDetent: false,
	        };
	      }, { passive:true });

	      orderHistoryList.addEventListener('touchmove', (e)=>{
	        if(!isMobileUx()) return;
	        if(!_histGesture || _histGesture.kind !== 'touch') return;
	        if(!isOrderHistoryModalOpen()) return;
	        if(isBlockingModalOpenForHistory()){ resetHistGesture(); return; }

	        const t = findTouchById(e.touches || [], _histGesture.touchId);
	        if(!t) return;

	        const dx = t.clientX - _histGesture.startX;
	        const dy = t.clientY - _histGesture.startY;
	        const ax = Math.abs(dx);
	        const ay = Math.abs(dy);

	        if(ax >= 10 || ay >= 10) _histGesture.moved = true;

	        if(!_histGesture.intent){
	          if(ax < 10 && ay < 10) return;
	          _histGesture.intent = (ax >= ay) ? 'h' : 'v';
	          if(_histGesture.intent === 'v'){ resetHistGesture(); return; }
	        }
	        if(_histGesture.intent !== 'h') return;

	        try{ e.preventDefault(); }catch(e){}

	        const now = performance.now();
	        _histGesture.prevMoveTime = _histGesture.lastMoveTime;
	        _histGesture.prevMoveClientX = _histGesture.lastMoveClientX;
	        _histGesture.lastMoveTime = now;
	        _histGesture.lastMoveClientX = t.clientX;

	        const det = _histGesture.det;
	        if(!det || !det.isConnected){ resetHistGesture(); return; }

	        const startAx = Math.abs(_histGesture.startSwipeX);
	        const startSide = traySideFromSwipeX(_histGesture.startSwipeX);
	        const startSnapPx = traySnapPxForSide(startSide);
	        const isAtDetent = startAx >= startSnapPx - 10;
	        const isSwipingBack = (_histGesture.startSwipeX < 0 && dx > 0) || (_histGesture.startSwipeX > 0 && dx < 0);

	        let nextX;
	        if(isAtDetent && isSwipingBack){
	          const dampedDx = dx * 0.35;
	          nextX = clampNum(_histGesture.startSwipeX + dampedDx, -MAX_PX, MAX_PX);
	          _histGesture.closingFromDetent = true;
	        }else{
	          nextX = clampNum(_histGesture.startSwipeX + dx, -MAX_PX, MAX_PX);
	          _histGesture.closingFromDetent = false;
	        }
	        nextX = Math.min(0, nextX);
	        _histGesture.swipeX = nextX;
	        _histGesture.side = 'right';

	        prepareHistoryTrayForItem(det, 'right');
	        det.classList.add('swiping');
	        setRowSwipeX(det, nextX);
	      }, { passive:false });

	      orderHistoryList.addEventListener('touchend', (e)=>{
	        if(!isMobileUx()) return;
	        if(!_histGesture || _histGesture.kind !== 'touch') return;
	        if(!isOrderHistoryModalOpen()) return;
	        if(isBlockingModalOpenForHistory()){ resetHistGesture(); return; }

	        const ended = findTouchById(e.changedTouches || [], _histGesture.touchId);
	        if(!ended) return;

	        const { id, det, moved, intent, swipeX, startTime, startX, prevMoveTime, lastMoveTime, prevMoveClientX, lastMoveClientX, closingFromDetent } = _histGesture;
	        resetHistGesture();
	        if(!id || !det) return;

	        if(!moved){
	          // Let the native <summary> click toggle work.
	          return;
	        }

	        if(intent === 'h'){
	          try{ e.preventDefault(); }catch(e){}
	          det.classList.remove('swiping');
	          const finalX = Number.isFinite(swipeX) ? swipeX : getRowSwipeX(det);
	          const ax = Math.abs(finalX);
	          const side = 'right';

	          if(closingFromDetent){
	            closeHistoryTrayElastic(det);
	            return;
	          }

	          let vx = 0;
	          try{
	            if(Number.isFinite(lastMoveTime) && Number.isFinite(prevMoveTime) && lastMoveTime > prevMoveTime){
	              const dt = lastMoveTime - prevMoveTime;
	              vx = dt > 0 ? (lastMoveClientX - prevMoveClientX) / dt : 0;
	            }else{
	              const tNow = performance.now();
	              const dt = tNow - (Number(startTime) || tNow);
	              vx = dt > 0 ? (ended.clientX - startX) / dt : 0;
	            }
	          }catch(e){ vx = 0; }

	          const shouldCommitReceive = (side === 'right') && (ax >= COMMIT_PX);
	          if(shouldCommitReceive){
	            closeHistoryTray();
	            void handleOrderReceiptButtonClick(id, null);
	            return;
	          }

	          const fastOpen = (side === 'right') ? (vx <= -0.55) : (vx >= 0.55);
	          const fastClose = (side === 'right') ? (vx >= 0.55) : (vx <= -0.55);
	          const snapPx = traySnapPxForSide(side);
	          if(fastClose && ax < COMMIT_PX){
	            closeHistoryTray();
	          }else if(ax >= snapPx || (ax >= REVEAL_PX && fastOpen)){
	            openHistoryTrayForItem(det, side);
	          }else{
	            closeHistoryTray();
	          }
	        }
	      }, { passive:false });

	      orderHistoryList.addEventListener('touchcancel', ()=>{
	        if(!_histGesture) return;
	        try{ if(_histGesture.det) _histGesture.det.classList.remove('swiping'); }catch(e){}
	        try{ closeHistoryTray(); }catch(e){}
	        resetHistGesture();
	      }, { passive:true });
	    }
	    const orderLinesBody = $('orderLinesBody');
	    if(orderLinesBody) orderLinesBody.addEventListener('click', async (e)=>{
	      // Remove button
	      const removeBtn = e.target.closest('button[data-remove-order-id]');
	      if(removeBtn){
	        removeOrderLine(removeBtn.getAttribute('data-remove-order-id'));
	        renderOrderResults();
	        renderOrderLines();
	        return;
	      }

	      // Stepper increment
	      const incBtn = e.target.closest('button[data-line-inc]');
	      if(incBtn){
	        const id = incBtn.getAttribute('data-line-inc');
	        const ord = orderState();
	        const selectedIds = orderLineSelectedIds().filter(selId =>
	          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
	        );
	        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
	        if(isBatch){
	          for(const selId of selectedIds){
	            const currentQty = getOrderQtyForItem(selId);
	            setOrderQty(selId, currentQty + 1);
	          }
	        } else {
	          const currentQty = getOrderQtyForItem(id);
	          setOrderQty(id, currentQty + 1);
	        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
      // Stepper decrement
      const decBtn = e.target.closest('button[data-line-dec]');
      if(decBtn){
        const id = decBtn.getAttribute('data-line-dec');
        const ord = orderState();
        const selectedIds = orderLineSelectedIds().filter(selId =>
          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
        );
        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
        if(isBatch){
          for(const selId of selectedIds){
            const currentQty = getOrderQtyForItem(selId);
            if(currentQty <= 1){
              removeOrderLine(selId);
            } else {
              setOrderQty(selId, currentQty - 1);
            }
          }
        } else {
          const currentQty = getOrderQtyForItem(id);
          if(currentQty <= 1){
            removeOrderLine(id);
          } else {
            setOrderQty(id, currentQty - 1);
          }
        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
    });
    if(orderLinesBody) orderLinesBody.addEventListener('change', (e)=>{
      const cb = e.target.closest('.order-line-select');
      if(cb){
        const id = String(cb.dataset.orderSelectId || '').trim();
        if(!id) return;
        setOrderLineSelected(id, cb.checked);
        return;
      }
      // Handle inline qty input change
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput){
        const id = String(qtyInput.dataset.lineQtyInput || '').trim();
        if(!id) return;
        const currentQty = getOrderQtyForItem(id);
        const newQty = Math.max(0, toInt(qtyInput.value, currentQty));
        if(newQty === currentQty) return;
        const ord = orderState();
        const selectedIds = orderLineSelectedIds().filter(selId =>
          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
        );
        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
        if(isBatch){
          for(const selId of selectedIds){
            if(newQty <= 0) removeOrderLine(selId);
            else setOrderQty(selId, newQty);
          }
        } else {
          if(newQty <= 0){
            removeOrderLine(id);
          } else {
            setOrderQty(id, newQty);
          }
        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
    });
    // Handle Enter key on qty input
    if(orderLinesBody) orderLinesBody.addEventListener('keydown', (e)=>{
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput && e.key === 'Enter'){
        e.preventDefault();
        qtyInput.blur();
      }
    });
    // Select all text on focus for easier editing
    if(orderLinesBody) orderLinesBody.addEventListener('focus', (e)=>{
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput){
        setTimeout(()=> qtyInput.select(), 0);
      }
    }, true);
    // Handle blur explicitly for mobile browsers
    if(orderLinesBody) orderLinesBody.addEventListener('blur', (e)=>{
      const qtyInput = e.target.closest('.qty-stepper-input');
      if(qtyInput){
        const id = String(qtyInput.dataset.lineQtyInput || '').trim();
        if(!id) return;
        const currentQty = getOrderQtyForItem(id);
        const newQty = Math.max(0, toInt(qtyInput.value, currentQty));
        if(newQty === currentQty) return;
        const ord = orderState();
        const selectedIds = orderLineSelectedIds().filter(selId =>
          ord.lines.some(l => l && String(l.id || '').trim() === String(selId || '').trim())
        );
        const isBatch = selectedIds.length > 0 && selectedIds.includes(id);
        if(isBatch){
          for(const selId of selectedIds){
            if(newQty <= 0) removeOrderLine(selId);
            else setOrderQty(selId, newQty);
          }
        } else {
          if(newQty <= 0){
            removeOrderLine(id);
          } else {
            setOrderQty(id, newQty);
          }
        }
        renderOrderResults();
        renderOrderLines();
      }
    }, true);

    // Add-one modal
    $('menuAddOne').addEventListener('click', ()=>{
      toggleMenu(false);
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_CREATE, 'Create permission required')) return;
      show('addOneModal', true);
      $('addName').focus();
    });
    $('btnAddCancel').addEventListener('click', ()=> show('addOneModal', false));
    $('btnAddSave').addEventListener('click', saveAddOne);
    $('addQty').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); saveAddOne(); }});
    $('addQty').addEventListener('focus', e=>{ setTimeout(()=> e.target.select(), 0); });
    $('addQtyInc').addEventListener('click', ()=>{
      const inp = $('addQty');
      inp.value = Math.max(1, toInt(inp.value, 1) + 1);
    });
    $('addQtyDec').addEventListener('click', ()=>{
      const inp = $('addQty');
      inp.value = Math.max(1, toInt(inp.value, 1) - 1);
    });
    async function saveAddOne(){
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_CREATE, 'Create permission required')) return;
      const name = String(($('addName').value||'').trim());
      const desc = String(($('addDesc').value||'').trim());
      const qty  = toInt($('addQty').value,-1);
      if(!name){ toast('Item name required'); return; }
      if(qty<=0){ toast('Qty must be > 0'); return; }
      if(state.items.some(x=> toKey(x.name)===toKey(name))){ toast('Duplicate item'); return; }

      try{
        await sbAddItem(name, desc, qty);
        await sbLoadSnapshot();
        $('addName').value=''; $('addDesc').value=''; $('addQty').value='1';
        show('addOneModal', false);
        toast('Item added');
      }catch(e){
        toast(e.message || 'Cloud add failed');
      }
    }

        async function handleInventoryDeleteAction(id){
          if(!id) return;
          if(!requireOnline()) return;
          if(!requirePermission(PERMISSIONS.ITEMS_DELETE, 'Delete not allowed')) return;
          const selectedIds = getSelectedRowIds();
          const batchIds = (selectedIds.length > 1 && selectedIds.includes(id)) ? selectedIds : [id];
          const isBatch = batchIds.length > 1;
          const item = !isBatch ? state.items.find(it => it && it.id === id) : null;
          const itemName = item ? item.name : 'this item';
          const title = isBatch ? 'Delete items?' : 'Delete item?';
          const message = isBatch
            ? `Delete ${batchIds.length} selected items?`
            : `Delete "${itemName}"?`;
          const ok = await openConfirmModal(title, message, { okText:'Delete', cancelText:'Cancel' });
          if(!ok) return;
          try{
            await sbDeleteMany(batchIds);
            await sbLoadSnapshot();
            toast(isBatch ? `Deleted ${batchIds.length} items` : 'Item deleted', 'success');
          }catch(e){
            toast(e && e.message ? e.message : 'Delete failed', 'error');
          }
        }

			    // Row delete button handler (delegated)
			    document.addEventListener('click', (e)=>{
		      const btn = e.target.closest('.row-delete-btn');
		      if(!btn) return;
		      const id = String(btn.dataset.id || '').trim();
          handleInventoryDeleteAction(id);
    });

    // Row edit button handler (delegated)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.row-edit-btn');
      if(!btn) return;
      if(!requireOnline()) return;
      if(!requirePermission(PERMISSIONS.ITEMS_EDIT, 'Read-only access')) return;
      const id = String(btn.dataset.id || '').trim();
      if(!id) return;
      openEditItemModal(id);
    });

    // Row order button handler (delegated)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.row-order-btn');
      if(!btn) return;
      const id = String(btn.dataset.id || '').trim();
      if(!id) return;
      if(!canOrdersCreate()){ toast('Order creation not allowed'); return; }
      try{ e.preventDefault(); e.stopPropagation(); }catch(_){}
      const selectedIds = getSelectedRowIds();
      if(selectedIds.length > 1 && selectedIds.includes(id)){
        let added = 0;
        for(const selId of selectedIds){
          const item = getInventoryById(selId);
          if(item && upsertOrderLineFromItem(item, 1)) added++;
        }
        if(added) toast(`Added ${added} selected item(s)`);
        else toast('Selected items already in cart');
        return;
      }
      toggleOrderLineForItemId(id);
    });

    // Row add-to-job button handler (delegated)
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('.row-job-btn');
      if(!btn) return;
      const id = String(btn.dataset.id || '').trim();
      if(!id) return;
      if(!canItemsView()){ toast('Job access requires view permission'); return; }
      openAddToJobModal(id);
    });

    // Master checkbox + indeterminate state
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.id==='chkAll'){
        const on = e.target.checked;
        document.querySelectorAll('.rowChk').forEach(cb=> cb.checked=on);
      }
      if(e.target && e.target.classList && e.target.classList.contains('rowChk')){
        const all = document.querySelectorAll('.rowChk');
        const checked = document.querySelectorAll('.rowChk:checked');
        const m = $('chkAll');
        if(m){
          m.checked = (checked.length===all.length && all.length>0);
          m.indeterminate = (checked.length>0 && checked.length<all.length);
        }
      }
    });

    // ========================
    // Parsing helpers
    // ========================
    const parseDelimitedSmart = IMUtils.parseDelimitedSmart || function parseDelimitedSmart(text){
      const firstLine=(text.split(/\r?\n/)[0]||'');
      let delim='\t';
      const tabScore=(firstLine.split('\t').length-1);
      const commaScore=(firstLine.split(',').length-1);
      const spaceScore=((firstLine.match(/\s{2,}/g)||[]).length);
      if(commaScore>tabScore && commaScore>=spaceScore) delim=','; else if(spaceScore>tabScore && spaceScore>commaScore) delim='  ';

      const rows=[]; let row=[]; let field=''; let inQ=false; let i=0; const N=text.length;
      const isDelim=(ch,pk)=> delim==='\t'? ch==='\t' : (delim===','? ch===',' : (ch===' ' && pk===' '));
      while(i<N){
        const ch=text[i], pk=text[i+1];
        if(ch==='"'){ if(inQ && pk==='"'){ field+='"'; i+=2; continue; } inQ=!inQ; i++; continue; }
        if(!inQ && (isDelim(ch,pk) || ch==='\n')){
          row.push(field); field='';
          if(delim==='  ' && ch===' ' && pk===' '){ while(text[i]===' ') i++; continue; }
          if(ch==='\n'){ rows.push(row); row=[]; }
          i++; continue;
        }
        if(ch==='\r'){ i++; continue; }
        field+=ch; i++;
      }
      if(field.length||row.length){ row.push(field); rows.push(row); }
      return rows.filter(r=> r.some(c=> String(c).trim().length));
    };
    const rowsToItems = IMUtils.rowsToItems || function rowsToItems(rows){
      if(!rows||!rows.length) return [];
      const canon=s=> toKey(String(s).replace(/[^A-Za-z0-9]+/g,'').trim());
      const hdrsRaw=rows[0]||[]; const hdrs=hdrsRaw.map(canon);
      const idxFromHdr=names=>{ for(const n of names){ const i=hdrs.indexOf(n); if(i>=0) return i; } return -1; };
      let iItem=idxFromHdr(['ITEM','NAME']);
      let iDesc=idxFromHdr(['DESCRIPTION','DESC']);
      let iQty = idxFromHdr(['QTY','QUANTITY','COUNT','QUANTITYONHAND']);
      const hasHeader=(iItem>=0);
      if(!hasHeader){ iItem=0; iDesc=1; iQty=2; }
      const start=hasHeader?1:0; const out=[];
      for(let r=start;r<rows.length;r++){
        const row=rows[r]||[];
        const name=String((row[iItem]!==undefined? row[iItem] : '')).trim(); if(!name) continue;
        const desc=String((iDesc>=0 && row[iDesc]!==undefined? row[iDesc] : '')).trim();
        const qtyV=(iQty>=0 && row[iQty]!==undefined)? row[iQty] : 0; const qty=toInt(qtyV,0);
        out.push({name, desc, qty});
      }
      return out;
    };
    if(!IMUtils.parseDelimitedSmart) IMUtils.parseDelimitedSmart = parseDelimitedSmart;
    if(!IMUtils.rowsToItems) IMUtils.rowsToItems = rowsToItems;
    async function ensureXlsx(){
      if(window.XLSX) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load XLSX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensureDocx(){
      if(window.mammoth) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load DOCX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensurePdf(){
      if(window.pdfjsLib) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load PDF parser'));
        document.head.appendChild(s);
      });
      // Configure worker
      if(window.pdfjsLib){
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
      }
    }
    async function parsePdf(file){
      await ensurePdf();
      const buf = await file.arrayBuffer();
      const doc = await window.pdfjsLib.getDocument({ data: buf }).promise;
      const allLines = [];
      for(let p=1; p<=doc.numPages; p++){
        const page = await doc.getPage(p);
        const tc = await page.getTextContent();
        const rows = new Map(); // y -> [{x,str}]
        for(const item of tc.items){
          const t = (item.str||'').trim(); if(!t) continue;
          const tr = item.transform || [0,0,0,0,0,0];
          const x = tr[4] || 0; const y = Math.round(tr[5] || 0);
          if(!rows.has(y)) rows.set(y, []);
          rows.get(y).push({ x, str:t });
        }
        // Sort by Y descending (PDF origin bottom-left), then by X asc
        const yKeys = Array.from(rows.keys()).sort((a,b)=> b-a);
        for(const y of yKeys){
          const cols = rows.get(y).sort((a,b)=> a.x-b.x).map(o=> o.str);
          const line = cols.join(' ').replace(/\s{2,}/g,'  ').trim();
          if(line) allLines.push(line);
        }
      }
      // Try to parse with existing delimited parser
      if(allLines.length){
        const text = allLines.join('\n');
        const items = rowsToItems(parseDelimitedSmart(text));
        if(items.length) return items;
        // Fallback: pairwise lines as name/desc with qty 0
        const rows=[]; for(let i=0;i<allLines.length;i+=2){ rows.push([allLines[i]||'', allLines[i+1]||'', '0']); }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseDocx(file){
      await ensureDocx();
      const buf = await file.arrayBuffer();
      const result = await window.mammoth.convertToHtml({arrayBuffer: buf});
      const html = result && result.value ? result.value : '';
      if(!html) return [];
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      const tables = tmp.querySelectorAll('table');
      const items = [];
      if(tables.length){
        tables.forEach(tbl=>{
          const rows = Array.from(tbl.querySelectorAll('tr'))
            .map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
          const parsed = rowsToItems(rows);
          parsed.forEach(r=> items.push(r));
        });
        if(items.length) return items;
      }
      const lines = Array.from(tmp.querySelectorAll('p'))
        .map(p=> p.textContent.replace(/\u00a0/g,' ').trim())
        .filter(s=> s.length);
      if(lines.length){
        if(lines.some(l=>/[\t,]/.test(l))){
          const text = lines.join('\n');
          return rowsToItems(parseDelimitedSmart(text));
        }
        const rows = [];
        for(let i=0;i<lines.length;i++){
          const a = lines[i];
          const b = (i+1 < lines.length) ? lines[++i] : '';
          rows.push([a, b, '0']);
        }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseAnyFile(file){
      const ext=(file.name.split('.').pop()||'').toLowerCase();
      if(ext==='json'){
        const t=await file.text();
        try{
          const p=JSON.parse(t);
          if(Array.isArray(p.items)) return p.items.map(it=>({name:String(it.name||'').trim(), desc:String(it.desc||''), qty:toInt(it.qty,0)}));
          if(Array.isArray(p)) return p.map(it=>({name:String(it.Item||it.name||'').trim(), desc:String(it.Description||it.desc||''), qty:toInt(it.Qty||it.qty,0)}));
        }catch{}
        return [];
      }
      if(ext==='pdf'){ try { return await parsePdf(file); } catch { return []; } }
      if(ext==='docx' || ext==='doc'){ try { return await parseDocx(file); } catch{ return []; } }
      if(ext==='csv'||ext==='tsv'||ext==='txt'){ const t=await file.text(); return rowsToItems(parseDelimitedSmart(t)); }
      if(ext==='xlsx'||ext==='xls'){
        await ensureXlsx();
        const buf=await file.arrayBuffer();
        const wb=XLSX.read(buf,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const aoa=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
        return rowsToItems(aoa);
      }
      return [];
    }

    // ========================
    // Merge semantics (local mode)
    // ========================
    function mergeSet(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      let added=0, updated=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        let it=index.get(k);
        if(!it){
          it={id:randomUUID(), name:r.name.trim(), desc:(r.desc||'').trim(), qty:toInt(r.qty,0)};
          state.items.push(it); index.set(k,it); added++;
        }else{
          if(r.desc && r.desc.trim()) it.desc=r.desc.trim();
          it.qty=toInt(r.qty,0);
          updated++;
        }
      }
      dedupe(); setUpdated(); save();
      return {added, updated, total:imported.length};
    }

    // ========================
    // Utilities
    // ========================
    const MODAL_FOCUSABLE = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    let _activeModal = null;
    let _lastFocused = null;
    function getOpenModals(){
      try{ return Array.from(document.querySelectorAll('.modal-backdrop[aria-hidden="false"]')); }catch(e){ return []; }
    }
    function getTopOpenModal(){
      const list = getOpenModals();
      return list.length ? list[list.length - 1] : null;
    }
    function lockBodyScroll(){
      const open = getOpenModals().length > 0;
      document.body.classList.toggle('modal-open', open);
    }
    function focusModal(backdrop){
      if(!backdrop) return;
      const modal = backdrop.querySelector('.modal') || backdrop;
      if(!modal) return;
      const focusables = Array.from(modal.querySelectorAll(MODAL_FOCUSABLE))
        .filter(el => !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true' && el.tabIndex !== -1);
      if(focusables.length){
        focusables[0].focus();
      }else{
        modal.setAttribute('tabindex','-1');
        modal.focus();
      }
    }
    function handleModalKeydown(e){
      if(!_activeModal) return;
      const modal = _activeModal.querySelector('.modal') || _activeModal;
      if(!modal) return;
      if(e.key === 'Tab'){
        const focusables = Array.from(modal.querySelectorAll(MODAL_FOCUSABLE))
          .filter(el => !el.hasAttribute('disabled') && el.getAttribute('aria-hidden') !== 'true' && el.tabIndex !== -1);
        if(!focusables.length){
          e.preventDefault();
          return;
        }
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if(e.shiftKey && document.activeElement === first){
          e.preventDefault();
          last.focus();
        }else if(!e.shiftKey && document.activeElement === last){
          e.preventDefault();
          first.focus();
        }
      }
      if(e.key === 'Escape'){
        const open = getTopOpenModal();
        if(!open) return;
        e.preventDefault();
        const id = open.id || '';
        if(id === 'confirmModal') closeConfirmModal(false);
        else if(id === 'msgModal') closeMsgModal();
        else if(id === 'qtyEntryModal') closeQtyEntryModal(null);
        else if(id === 'pasteModal') show('pasteModal', false);
        else if(id) show(id, false);
      }
    }
    document.addEventListener('keydown', handleModalKeydown);
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-modal-close]');
      if(!btn) return;
      const id = String(btn.getAttribute('data-modal-close') || '').trim();
      if(!id) return;
      if(id === 'confirmModal') closeConfirmModal(false);
      else if(id === 'msgModal') closeMsgModal();
      else if(id === 'qtyEntryModal') closeQtyEntryModal(null);
      else show(id, false);
    });
    function show(id, on = true) {
  const el = document.getElementById(id);
  if (!el) return;
  if (!on) {
    if (el.contains(document.activeElement)) {
      document.activeElement.blur();
    }
    el.setAttribute('aria-hidden', 'true');
    el.style.display = 'none';
    if(_activeModal === el) _activeModal = null;
    lockBodyScroll();
    if(_lastFocused) try{ _lastFocused.focus(); }catch(e){}
    return;
  }
	  _lastFocused = document.activeElement;
	  el.style.display = 'flex';
	  el.setAttribute('aria-hidden', 'false');
	  _activeModal = el;
	  lockBodyScroll();
	  try{ closeMobileTray(); }catch(e){}
	
	  // Optional: auto-focus a sensible control
	  if (id === 'addOneModal') {
	    const inp = document.getElementById('addName');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'pasteModal') {
    const ta = document.getElementById('pasteArea');
    if (ta) setTimeout(() => ta.focus(), 0);
  } else if (id === 'orderModal') {
    const inp = document.getElementById('orderSearch');
    if (inp) setTimeout(() => inp.focus(), 0);
	  } else if (id === 'qtyEntryModal') {
	    const inp = document.getElementById('qtyEntryInput');
	    if (inp) setTimeout(() => inp.focus(), 0);
	  } else if (id === 'authModal') {
	    const inp = document.getElementById('authEmail');
	    if (inp) setTimeout(() => inp.focus(), 0);
	  } else if (id === 'msgModal') {
	    const btn = document.getElementById('btnMsgOk');
	    if (btn) setTimeout(() => btn.focus(), 0);
  } else if (id === 'confirmModal') {
    const btn = document.getElementById('btnConfirmCancel');
    if (btn) setTimeout(() => btn.focus(), 0);
  } else if (id === 'profileModal') {
    const inp = document.getElementById('profilePhone');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'companyLocationEditorModal') {
    const inp = document.getElementById('companyLocationName');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'advancedCompanyModal') {
    if(state._companySwitcherMode === 'basic'){
      const btn = document.querySelector('#advancedCompanyResults [data-basic-switch]:not([disabled])');
      if (btn) setTimeout(() => btn.focus(), 0);
    }else{
      const inp = document.getElementById('advancedCompanySearch');
      if (inp) setTimeout(() => inp.focus(), 0);
    }
  } else if (id === 'diagnosticsModal') {
    const inp = document.getElementById('diagRoleSelect');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'addToJobModal') {
    const sel = document.getElementById('addToJobSelect');
    if (sel) setTimeout(() => sel.focus(), 0);
  } else if (id === 'seedInventoryModal') {
    const sel = document.getElementById('seedInventorySource');
    if (sel) setTimeout(() => sel.focus(), 0);
  } else if (id === 'companyEnvironmentModal') {
    const sel = document.getElementById('companyEnvironmentSelect');
    if (sel) setTimeout(() => sel.focus(), 0);
  }
	  setTimeout(()=>{
	    if(el.contains(document.activeElement)) return;
	    focusModal(el);
	  }, 0);
}

    // App message modal (replaces browser alert/prompt where possible)
    let _msgCopyText = '';
    function openMsgModal(title, body, copyText){
      _msgCopyText = String(copyText || '');
      const t = $('msgTitle'); if(t) t.textContent = String(title || 'Message');
      const b = $('msgBody'); if(b) b.textContent = String(body || '');
      const btnCopy = $('btnMsgCopy');
      if(btnCopy){
        const has = !!_msgCopyText;
        btnCopy.style.display = has ? 'inline-flex' : 'none';
        btnCopy.disabled = !has;
      }
      show('msgModal', true);
    }
    function closeMsgModal(){
      _msgCopyText = '';
      show('msgModal', false);
    }
    const btnMsgOk = $('btnMsgOk');
    if(btnMsgOk) btnMsgOk.addEventListener('click', closeMsgModal);
    const btnMsgCopy = $('btnMsgCopy');
	    if(btnMsgCopy) btnMsgCopy.addEventListener('click', async ()=>{
	      if(!_msgCopyText) return;
	      try{
	        await navigator.clipboard.writeText(_msgCopyText);
	        toast('Copied');
	      }catch(e){
	        toast('Copy failed');
	      }
	    });

	    // App confirm modal (replaces browser confirm)
	    let _confirmResolve = null;
	    function openConfirmModal(title, body, opts = {}){
	      if(_confirmResolve){
	        try{ _confirmResolve(false); }catch(e){}
	        _confirmResolve = null;
	      }
	      const t = $('confirmTitle'); if(t) t.textContent = String(title || 'Confirm');
	      const b = $('confirmBody'); if(b) b.textContent = String(body || '');
	      const okText = opts && opts.okText ? String(opts.okText) : 'OK';
	      const cancelText = opts && opts.cancelText ? String(opts.cancelText) : 'Cancel';
	      const okBtn = $('btnConfirmOk'); if(okBtn) okBtn.textContent = okText;
	      const cancelBtn = $('btnConfirmCancel'); if(cancelBtn) cancelBtn.textContent = cancelText;
	      show('confirmModal', true);
	      return new Promise(resolve => { _confirmResolve = resolve; });
	    }
	    function closeConfirmModal(result){
	      show('confirmModal', false);
	      const resolve = _confirmResolve;
	      _confirmResolve = null;
	      if(resolve) resolve(!!result);
	    }
	    const btnConfirmCancel = $('btnConfirmCancel');
	    if(btnConfirmCancel) btnConfirmCancel.addEventListener('click', ()=> closeConfirmModal(false));
	    const btnConfirmOk = $('btnConfirmOk');
	    if(btnConfirmOk) btnConfirmOk.addEventListener('click', ()=> closeConfirmModal(true));
		    document.addEventListener('keydown', (e)=>{
		      if(e.key !== 'Escape') return;
		      const modal = $('confirmModal');
		      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
		      e.preventDefault();
		      closeConfirmModal(false);
		    });

		    // Qty entry modal (number prompt)
		    let _qtyEntryResolve = null;
		    let _qtyEntryOpts = {};
		    function openQtyEntryModal(title, subtitle, initialValue, opts = {}){
		      if(_qtyEntryResolve){
		        try{ _qtyEntryResolve(null); }catch(e){}
		        _qtyEntryResolve = null;
		      }
		      _qtyEntryOpts = opts || {};
		      const t = $('qtyEntryTitle'); if(t) t.textContent = String(title || 'Set Qty');
		      const sub = $('qtyEntrySubtitle');
		      if(sub){
		        const txt = String(subtitle || '').trim();
		        sub.textContent = txt;
		        sub.style.display = txt ? 'block' : 'none';
		      }
		      const input = $('qtyEntryInput');
		      if(input){
		        const min = Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'min') ? toInt(_qtyEntryOpts.min, 0) : 0;
		        input.min = String(min);
		        const hasMax = Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'max') && _qtyEntryOpts.max !== null && typeof _qtyEntryOpts.max !== 'undefined';
		        if(hasMax){
		          const max = Number(_qtyEntryOpts.max);
		          if(Number.isFinite(max) && Math.trunc(max) >= min) input.max = String(Math.trunc(max));
		          else input.removeAttribute('max');
		        }else{
		          input.removeAttribute('max');
		        }
		        input.value = String(toInt(initialValue, 0));
		      }
		      const okBtn = $('btnQtyEntryOk');
		      if(okBtn) okBtn.textContent = (_qtyEntryOpts && _qtyEntryOpts.okText) ? String(_qtyEntryOpts.okText) : 'Save';
		      const cancelBtn = $('btnQtyEntryCancel');
		      if(cancelBtn) cancelBtn.textContent = (_qtyEntryOpts && _qtyEntryOpts.cancelText) ? String(_qtyEntryOpts.cancelText) : 'Cancel';
		      show('qtyEntryModal', true);
		      setTimeout(()=>{
		        const inp = $('qtyEntryInput');
		        if(!inp) return;
		        try{ inp.focus(); inp.select(); }catch(e){}
		      }, 0);
		      return new Promise(resolve => { _qtyEntryResolve = resolve; });
		    }
		    function closeQtyEntryModal(result){
		      show('qtyEntryModal', false);
		      const resolve = _qtyEntryResolve;
		      _qtyEntryResolve = null;
		      if(resolve) resolve(result);
		    }
		    function handleQtyEntryOk(){
		      const input = $('qtyEntryInput');
		      const raw = input ? input.value : '';
		      const min = (_qtyEntryOpts && Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'min')) ? toInt(_qtyEntryOpts.min, 0) : 0;
		      const max = (_qtyEntryOpts && Object.prototype.hasOwnProperty.call(_qtyEntryOpts,'max')) ? Number(_qtyEntryOpts.max) : NaN;
		      const q = toInt(raw, -1);
		      if(q < min){
		        toast(`Qty must be â‰¥ ${min}`);
		        try{ if(input){ input.focus(); input.select(); } }catch(e){}
		        return;
		      }
		      if(Number.isFinite(max) && q > Math.trunc(max)){
		        toast(`Qty must be â‰¤ ${Math.trunc(max)}`);
		        try{ if(input){ input.focus(); input.select(); } }catch(e){}
		        return;
		      }
		      closeQtyEntryModal(q);
		    }
		    const btnQtyEntryCancel = $('btnQtyEntryCancel');
		    if(btnQtyEntryCancel) btnQtyEntryCancel.addEventListener('click', ()=> closeQtyEntryModal(null));
		    const btnQtyEntryOk = $('btnQtyEntryOk');
		    if(btnQtyEntryOk) btnQtyEntryOk.addEventListener('click', handleQtyEntryOk);
		    const qtyEntryInput = $('qtyEntryInput');
		    if(qtyEntryInput) qtyEntryInput.addEventListener('keydown', (e)=>{
		      if(e.key==='Escape'){ e.preventDefault(); closeQtyEntryModal(null); }
		      if(e.key==='Enter'){ e.preventDefault(); handleQtyEntryOk(); }
		    });
		    document.addEventListener('keydown', (e)=>{
		      if(e.key !== 'Escape') return;
		      const modal = $('qtyEntryModal');
		      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
		      e.preventDefault();
		      closeQtyEntryModal(null);
		    });
		    function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._tmr); t._tmr=setTimeout(()=> t.style.display='none', 2000); }

    // iOS keyboard-safe scroll height
    document.addEventListener('focusin', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','60vh');
      }
    });
    document.addEventListener('focusout', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','70vh');
      }
    });

    // iOS-style qty picker
    const _qtyPicker = {
      itemId: null,
      itemName: '',
      currentQty: 0,
      selectedQty: 0,
      maxQty: 999,
      scrollY: 0,
      isDragging: false,
      startY: 0,
      startScrollY: 0
    };
    function openQtyPicker(itemId, itemName, currentQty){
      _qtyPicker.itemId = itemId;
      _qtyPicker.itemName = itemName;
      _qtyPicker.currentQty = currentQty;
      _qtyPicker.selectedQty = currentQty;
      _qtyPicker.scrollY = -currentQty * 36;
      const title = $('qtyPickerTitle');
      if(title) title.textContent = itemName || 'Order Qty';
      renderQtyPickerWheel();
      show('qtyPickerModal', true);
    }
    function closeQtyPicker(){
      show('qtyPickerModal', false);
      _qtyPicker.itemId = null;
    }
    function renderQtyPickerWheel(){
      const wheel = $('qtyPickerWheel');
      if(!wheel) return;
      let html = '';
      for(let i = 0; i <= _qtyPicker.maxQty; i++){
        const isSelected = i === _qtyPicker.selectedQty;
        html += `<div class="qty-picker-item${isSelected ? ' selected' : ''}" data-qty="${i}">${i}</div>`;
      }
      wheel.innerHTML = html;
      wheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
    }
    function updateQtyPickerSelection(){
      const wheel = $('qtyPickerWheel');
      if(!wheel) return;
      const idx = Math.round(-_qtyPicker.scrollY / 36);
      _qtyPicker.selectedQty = Math.max(0, Math.min(_qtyPicker.maxQty, idx));
      wheel.querySelectorAll('.qty-picker-item').forEach((el, i) => {
        el.classList.toggle('selected', i === _qtyPicker.selectedQty);
      });
    }
    function snapQtyPicker(){
      const idx = Math.round(-_qtyPicker.scrollY / 36);
      const clampedIdx = Math.max(0, Math.min(_qtyPicker.maxQty, idx));
      _qtyPicker.selectedQty = clampedIdx;
      _qtyPicker.scrollY = -clampedIdx * 36;
      const wheel = $('qtyPickerWheel');
      if(wheel){
        wheel.style.transition = 'transform 150ms ease-out';
        wheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
        setTimeout(()=>{ wheel.style.transition = ''; }, 150);
      }
      updateQtyPickerSelection();
    }
    function handleQtyPickerDone(){
      const id = _qtyPicker.itemId;
      const qty = _qtyPicker.selectedQty;
      if(id){
        const ord = orderState();
        const line = ord.lines.find(l => l.id === id);
        if(line){
          if(qty === 0){
            removeOrderLine(id);
          } else {
            line.qty = qty;
          }
          renderOrderLines();
        }
      }
      closeQtyPicker();
    }

    // ========================
    // Onboarding UI
    // ========================
    const ONBOARDING_INTENT_KEY = 'inv.onboarding.intent';
    const ONBOARDING_PLANS = ['starter','professional','business','enterprise'];
    const ONBOARDING_STATES = [
      'UNINITIALIZED',
      'SUBSCRIPTION_ACTIVE',
      'COMPANY_PROFILE_COMPLETE',
      'LOCATIONS_CONFIGURED',
      'USERS_INVITED',
      'ONBOARDING_COMPLETE'
    ];
    function isOnboardingRoute(){
      const path = String(window.location.pathname || '');
      return /\/onboarding\/?$/.test(path);
    }
    function getAppHomeUrl(){
      const path = String(window.location.pathname || '/');
      const base = path.replace(/\/onboarding\/?$/, '/') || '/';
      return `${window.location.origin}${base}`;
    }
    function redirectToAppHome(){
      _onboardingCompanyId = '';
      window.location.href = getAppHomeUrl();
    }
    function normalizeOnboardingPlan(value){
      const plan = String(value || '').trim().toLowerCase();
      return ONBOARDING_PLANS.includes(plan) ? plan : '';
    }
    function storeOnboardingIntentFromUrl(){
      if(!isOnboardingRoute()) return;
      try{
        const params = new URLSearchParams(window.location.search);
        const plan = normalizeOnboardingPlan(params.get('plan'));
        const source = String(params.get('source') || '').trim();
        if(!plan && !source) return;
        const payload = { plan, source, ts: Date.now() };
        sessionStorage.setItem(ONBOARDING_INTENT_KEY, JSON.stringify(payload));
      }catch(e){}
    }
    function readOnboardingIntent(){
      try{
        const raw = sessionStorage.getItem(ONBOARDING_INTENT_KEY);
        if(!raw) return { plan:'', source:'' };
        const data = JSON.parse(raw);
        return {
          plan: normalizeOnboardingPlan(data && data.plan ? data.plan : ''),
          source: String(data && data.source ? data.source : '').trim()
        };
      }catch(e){
        return { plan:'', source:'' };
      }
    }
    function loadOnboardingIntent(){
      const intent = readOnboardingIntent();
      state._onboardingPlan = intent.plan;
      state._onboardingSource = intent.source;
    }
    function renderOnboardingPlanSummary(){
      const el = $('onboardingPlanSummary');
      if(!el) return;
      const plan = normalizeOnboardingPlan(state._onboardingPlan);
      const source = String(state._onboardingSource || '').trim();
      if(!plan){
        el.textContent = '';
        el.style.display = 'none';
        return;
      }
      const label = formatTierLabel(plan);
      const sourceLabel = source ? ` Â· Source: ${source}` : '';
      el.textContent = `Plan: ${label}${sourceLabel}`;
      el.style.display = '';
    }
    function setOnboardingRouteActive(active){
      const main = $('onboardingMain');
      if(main) main.classList.toggle('active', active);
      document.body.classList.toggle('onboarding-route', active);
      if(!active) restorePendingInvitesToUserMgmt();
    }
    function setOnboardingGate(config){
      const gate = $('onboardingGate');
      const wizard = $('onboardingWizard');
      if(!gate) return;
      const showGate = !!(config && config.show !== false);
      gate.style.display = showGate ? '' : 'none';
      if(wizard) wizard.style.display = showGate ? 'none' : '';
      if(!showGate){
        state._onboardingGatePrimary = null;
        state._onboardingGateSecondary = null;
        return;
      }
      const title = $('onboardingGateTitle');
      const message = $('onboardingGateMessage');
      const primary = $('onboardingGatePrimary');
      const secondary = $('onboardingGateSecondary');
      if(title) title.textContent = String(config && config.title ? config.title : '');
      if(message) message.textContent = String(config && config.message ? config.message : '');
      if(primary){
        const label = config && config.primaryLabel ? String(config.primaryLabel) : 'Continue';
        primary.textContent = label;
        primary.style.display = '';
      }
      if(secondary){
        const label = config && config.secondaryLabel ? String(config.secondaryLabel) : '';
        secondary.textContent = label;
        secondary.style.display = label ? '' : 'none';
      }
      state._onboardingGatePrimary = config && typeof config.primaryAction === 'function' ? config.primaryAction : null;
      state._onboardingGateSecondary = config && typeof config.secondaryAction === 'function' ? config.secondaryAction : null;
    }
    function normalizeOnboardingState(value){
      const stateValue = String(value || '').trim().toUpperCase();
      return ONBOARDING_STATES.includes(stateValue) ? stateValue : 'UNINITIALIZED';
    }
    function getOnboardingStepFromState(value){
      const stateValue = normalizeOnboardingState(value);
      if(stateValue === 'COMPANY_PROFILE_COMPLETE') return 2;
      if(stateValue === 'LOCATIONS_CONFIGURED') return 3;
      if(stateValue === 'USERS_INVITED') return 4;
      if(stateValue === 'ONBOARDING_COMPLETE') return 5;
      return 1;
    }
    function renderOnboardingProgress(stepIndex){
      const fill = $('onboardingProgressFill');
      const total = 4;
      const safeStep = Math.min(Math.max(stepIndex, 1), total);
      if(fill){
        const pct = Math.round((safeStep / total) * 100);
        fill.style.width = `${pct}%`;
      }
      document.querySelectorAll('[data-onboarding-progress]').forEach(el=>{
        const idx = Number(el.getAttribute('data-onboarding-progress') || '0');
        el.classList.toggle('active', idx === safeStep);
        el.classList.toggle('complete', idx < safeStep);
      });
    }
    function renderOnboardingStep(stepId){
      document.querySelectorAll('.onboarding-step').forEach(el=>{
        const match = String(el.getAttribute('data-onboarding-step') || '') === stepId;
        el.classList.toggle('active', match);
      });
    }
    function setOnboardingMessage(id, msg){
      const el = $(id);
      if(!el) return;
      el.textContent = String(msg || '');
    }
    function renderOnboardingTimezoneOptions(){
      const select = $('onboardingTimezone');
      if(!select || select._filled) return;

      // US timezones with friendly labels (prioritized)
      const usTimezones = [
        { value: 'America/New_York', label: 'Eastern (New York)' },
        { value: 'America/Chicago', label: 'Central (Chicago)' },
        { value: 'America/Denver', label: 'Mountain (Denver)' },
        { value: 'America/Phoenix', label: 'Mountain - Arizona (Phoenix)' },
        { value: 'America/Los_Angeles', label: 'Pacific (Los Angeles)' },
        { value: 'America/Anchorage', label: 'Alaska (Anchorage)' },
        { value: 'Pacific/Honolulu', label: 'Hawaii (Honolulu)' }
      ];

      // Get all IANA timezones
      let allZones = [];
      try {
        if(typeof Intl !== 'undefined' && typeof Intl.supportedValuesOf === 'function'){
          allZones = Intl.supportedValuesOf('timeZone');
        }
      } catch(e){}

      // Group timezones by region
      const usValues = new Set(usTimezones.map(t => t.value));
      const groups = {
        'Canada': [],
        'Mexico & Caribbean': [],
        'Central & South America': [],
        'Europe': [],
        'Africa': [],
        'Asia': [],
        'Australia & Pacific': [],
        'Other': []
      };

      allZones.forEach(zone => {
        if(usValues.has(zone)) return; // Skip US zones already listed

        if(zone.startsWith('America/') && (zone.includes('Toronto') || zone.includes('Vancouver') || zone.includes('Edmonton') || zone.includes('Winnipeg') || zone.includes('Halifax') || zone.includes('St_Johns') || zone.includes('Regina') || zone.includes('Whitehorse') || zone.includes('Yellowknife'))){
          groups['Canada'].push(zone);
        } else if(zone.startsWith('America/') && (zone.includes('Mexico') || zone.includes('Cancun') || zone.includes('Tijuana') || zone.includes('Merida') || zone.includes('Jamaica') || zone.includes('Puerto_Rico') || zone.includes('Havana') || zone.includes('Bahamas') || zone.includes('Santo_Domingo') || zone.includes('Barbados') || zone.includes('Martinique') || zone.includes('Nassau'))){
          groups['Mexico & Caribbean'].push(zone);
        } else if(zone.startsWith('America/') && !usValues.has(zone)){
          groups['Central & South America'].push(zone);
        } else if(zone.startsWith('Europe/')){
          groups['Europe'].push(zone);
        } else if(zone.startsWith('Africa/')){
          groups['Africa'].push(zone);
        } else if(zone.startsWith('Asia/') || zone.startsWith('Indian/')){
          groups['Asia'].push(zone);
        } else if(zone.startsWith('Australia/') || zone.startsWith('Pacific/')){
          if(!usValues.has(zone)) groups['Australia & Pacific'].push(zone);
        } else if(zone !== 'UTC' && !zone.startsWith('Etc/')){
          groups['Other'].push(zone);
        }
      });

      // Sort each group
      Object.keys(groups).forEach(key => groups[key].sort());

      // Build HTML
      let html = '<option value="">Select timezone...</option>';

      // US timezones first
      html += '<optgroup label="United States">';
      usTimezones.forEach(tz => {
        html += `<option value="${escapeHtmlAttr(tz.value)}">${escapeHtml(tz.label)}</option>`;
      });
      html += '</optgroup>';

      // Other groups
      const groupOrder = ['Canada', 'Mexico & Caribbean', 'Central & South America', 'Europe', 'Africa', 'Asia', 'Australia & Pacific', 'Other'];
      groupOrder.forEach(groupName => {
        const zones = groups[groupName];
        if(zones && zones.length > 0){
          html += `<optgroup label="${escapeHtmlAttr(groupName)}">`;
          zones.forEach(zone => {
            // Extract city name for display
            const parts = zone.split('/');
            const city = parts[parts.length - 1].replace(/_/g, ' ');
            html += `<option value="${escapeHtmlAttr(zone)}">${escapeHtml(city)}</option>`;
          });
          html += '</optgroup>';
        }
      });

      // Add UTC option at the end
      html += '<optgroup label="Universal"><option value="UTC">UTC</option></optgroup>';

      select.innerHTML = html;
      select._filled = true;
    }
    async function fetchOnboardingState(){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const { data, error } = await SB.client.rpc('get_onboarding_state', { p_company_id: SB.companyId });
      if(error) throw error;
      return normalizeOnboardingState(data);
    }
    async function loadOnboardingCompanyProfile(){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const { data, error } = await SB.client
        .from('companies')
        .select('name,settings')
        .eq('id', SB.companyId)
        .single();
      if(error) throw error;
      const settings =
        data && data.settings && typeof data.settings === 'object' && !Array.isArray(data.settings)
          ? data.settings
          : {};
      return { name: data && data.name ? data.name : '', settings };
    }
    function applyOnboardingProfileToForm(profile){
      const name = $('onboardingCompanyName');
      const email = $('onboardingContactEmail');
      const timezone = $('onboardingTimezone');
      if(name) name.value = profile && profile.name ? String(profile.name) : '';
      if(email) email.value = profile && profile.settings ? String(profile.settings.primary_contact_email || '') : '';
      // Populate timezone options first
      renderOnboardingTimezoneOptions();
      // Set timezone: use saved value, or auto-detect from system
      if(timezone){
        const savedTz = profile && profile.settings ? String(profile.settings.timezone || '') : '';
        timezone.value = savedTz || getSystemTimezone();
      }
    }
    async function updateCompanySettings(patch, nameOverride){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const payload = {
        p_company_id: SB.companyId,
        p_settings_patch: patch || {}
      };
      if(typeof nameOverride === 'string' && nameOverride.trim()){
        payload.p_name = nameOverride.trim();
      }
      const { data, error } = await SB.client.rpc('update_company_settings', payload);
      if(error) throw error;
      const result = data && typeof data === 'object' ? data : {};
      return {
        settings: result.settings && typeof result.settings === 'object' ? result.settings : {},
        name: result.name || (typeof nameOverride === 'string' ? nameOverride.trim() : '')
      };
    }
    async function advanceOnboardingState(targetState){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const { data, error } = await SB.client.rpc('advance_onboarding_state', {
        p_company_id: SB.companyId,
        p_target_state: targetState
      });
      if(error) throw error;
      return normalizeOnboardingState(data);
    }
    async function fetchActiveLocationCount(){
      if(!SB.ready || !SB.session || !SB.client || !SB.companyId) throw new Error('Not authorized');
      const { count, error } = await SB.client
        .from('company_locations')
        .select('id', { count:'exact', head:true })
        .eq('company_id', SB.companyId)
        .eq('is_active', true);
      if(error) throw error;
      return Number.isFinite(count) ? count : 0;
    }
    function renderOnboardingLocationsStatus(rows){
      const status = $('onboardingLocationsStatus');
      const summary = $('onboardingLocationsSummary');
      if(!summary) return;
      const list = Array.isArray(rows) ? rows.filter(r => r && r.is_active) : [];
      if(!list.length){
        if(status) status.textContent = '';
        summary.innerHTML = '<div class="muted">No active locations yet.</div>';
        return;
      }
      if(status){
        status.textContent = `Active locations: ${list.length}`;
      }
      const primary = list[0];
      const addressLines = formatLocationAddress(primary).split('\n').filter(Boolean);
      const addressHtml = addressLines.map(line => `<div>${escapeHtml(line)}</div>`).join('');
      const extraCount = list.length - 1;
      const extra = extraCount > 0
        ? `<div class="onboarding-location-meta">+${extraCount} more active location${extraCount > 1 ? 's' : ''}</div>`
        : '';
      summary.innerHTML =
        `<div class="onboarding-location-card">`+
          `<div class="onboarding-location-name">${escapeHtml(primary.name || 'Location')}</div>`+
          `<div class="onboarding-location-address">${addressHtml}</div>`+
          `${extra}`+
        `</div>`;
    }
    function attachPendingInvitesToOnboarding(){
      const slot = $('onboardingPendingInvitesSlot');
      const section = $('pendingInvitesSection');
      if(!slot || !section) return;
      if(section.parentElement !== slot) slot.appendChild(section);
      renderPendingInvitesSection();
    }
    function restorePendingInvitesToUserMgmt(){
      const mount = $('pendingInvitesMount');
      const section = $('pendingInvitesSection');
      if(!mount || !section) return;
      if(section.parentElement !== mount) mount.appendChild(section);
    }
    function renderOnboardingInviteNotice(){
      const msg = $('onboardingInvitesMsg');
      if(!msg) return;
      if(!canAccessInvites()){
        msg.textContent = 'Invites require Business tier and invite permissions. You can skip for now.';
        return;
      }
      msg.textContent = '';
    }
    async function handleOnboardingProfileSubmit(){
      const btn = $('btnOnboardingProfileSave');
      const name = String($('onboardingCompanyName')?.value || '').trim();
      const email = String($('onboardingContactEmail')?.value || '').trim();
      const timezone = String($('onboardingTimezone')?.value || '').trim();
      setOnboardingMessage('onboardingProfileMsg', '');
      if(!name){
        setOnboardingMessage('onboardingProfileMsg', 'Company name is required.');
        return;
      }
      if(!email){
        setOnboardingMessage('onboardingProfileMsg', 'Primary contact email is required.');
        return;
      }
      if(!timezone){
        setOnboardingMessage('onboardingProfileMsg', 'Timezone is required.');
        return;
      }
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Saving...';
      }
      try{
        const result = await updateCompanySettings({
          primary_contact_email: email,
          timezone
        }, name);
        if(SB.company){
          SB.company.company_name = result.name;
        }
        if(Array.isArray(SB.companies)){
          const idx = SB.companies.findIndex(row => String(row.company_id) === String(SB.companyId));
          if(idx >= 0){
            SB.companies[idx] = { ...SB.companies[idx], company_name: result.name };
          }
        }
        renderCompanySwitcher();
      }catch(e){
        setOnboardingMessage('onboardingProfileMsg', e && e.message ? e.message : 'Failed to save profile.');
        return;
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Continue';
        }
      }
      try{
        await advanceOnboardingState('COMPANY_PROFILE_COMPLETE');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingProfileMsg', e && e.message ? e.message : 'Unable to advance onboarding.');
      }
    }
    async function handleOnboardingLocationsContinue(){
      const btn = $('btnOnboardingLocationsContinue');
      setOnboardingMessage('onboardingLocationsMsg', '');
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Checking...';
      }
      try{
        const rows = await sbFetchCompanyLocations();
        renderOnboardingLocationsStatus(rows);
        const activeCount = Array.isArray(rows) ? rows.filter(r => r && r.is_active).length : 0;
        if(activeCount < 1){
          setOnboardingMessage('onboardingLocationsMsg', 'Add at least one active location to continue.');
          return;
        }
        await advanceOnboardingState('LOCATIONS_CONFIGURED');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingLocationsMsg', e && e.message ? e.message : 'Unable to advance onboarding.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Continue';
        }
      }
    }
    async function handleOnboardingInvitesSkip(){
      const btn = $('btnOnboardingInvitesSkip');
      setOnboardingMessage('onboardingInvitesMsg', '');
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
      }
      try{
        await updateCompanySettings({ onboarding_skip_invites: true });
        await advanceOnboardingState('USERS_INVITED');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingInvitesMsg', e && e.message ? e.message : 'Unable to skip invites.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
        }
      }
    }
    async function handleOnboardingInvitesContinue(){
      const btn = $('btnOnboardingInvitesContinue');
      setOnboardingMessage('onboardingInvitesMsg', '');
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Saving...';
      }
      try{
        await advanceOnboardingState('USERS_INVITED');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingInvitesMsg', e && e.message ? e.message : 'Invite at least one user or skip for now.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Continue';
        }
      }
    }
    async function maybeAdvanceOnboardingAfterInvite(){
      if(!isOnboardingRoute()) return;
      if(getOnboardingStepFromState(state._onboardingState) !== 3) return;
      try{
        await advanceOnboardingState('USERS_INVITED');
        await handleOnboardingRoute();
      }catch(e){
        setOnboardingMessage('onboardingInvitesMsg', e && e.message ? e.message : 'Unable to advance onboarding.');
      }
    }
    async function handleOnboardingFinish(){
      const btn = $('btnOnboardingFinish');
      setOnboardingMessage('onboardingFinishMsg', '');
      if(btn){
        btn.disabled = true;
        btn.setAttribute('aria-disabled', 'true');
        btn.textContent = 'Finalizing...';
      }
      try{
        await advanceOnboardingState('ONBOARDING_COMPLETE');
        redirectToAppHome();
      }catch(e){
        setOnboardingMessage('onboardingFinishMsg', e && e.message ? e.message : 'Unable to finish onboarding.');
      }finally{
        if(btn){
          btn.disabled = false;
          btn.setAttribute('aria-disabled', 'false');
          btn.textContent = 'Go to Dashboard';
        }
      }
    }
    function wireOnboardingEvents(){
      const gatePrimary = $('onboardingGatePrimary');
      if(gatePrimary && !gatePrimary._wired){
        gatePrimary._wired = true;
        gatePrimary.addEventListener('click', ()=>{
          if(typeof state._onboardingGatePrimary === 'function') state._onboardingGatePrimary();
        });
      }
      const gateSecondary = $('onboardingGateSecondary');
      if(gateSecondary && !gateSecondary._wired){
        gateSecondary._wired = true;
        gateSecondary.addEventListener('click', ()=>{
          if(typeof state._onboardingGateSecondary === 'function') state._onboardingGateSecondary();
        });
      }
      // Signup form listeners
      const signupForm = $('onboardingAccountForm');
      if(signupForm && !signupForm._wired){
        signupForm._wired = true;
        signupForm.addEventListener('submit', (e)=>{
          e.preventDefault();
          void handleSignupSubmit(e);
        });
      }
      const signupHaveAccount = $('btnSignupHaveAccount');
      if(signupHaveAccount && !signupHaveAccount._wired){
        signupHaveAccount._wired = true;
        signupHaveAccount.addEventListener('click', ()=>{
          showSignInFromSignup();
        });
      }
      const companyForm = $('onboardingCompanyForm');
      if(companyForm && !companyForm._wired){
        companyForm._wired = true;
        companyForm.addEventListener('submit', (e)=>{
          e.preventDefault();
          void handleCompanyCreate(e);
        });
      }
      const profileForm = $('onboardingProfileForm');
      if(profileForm && !profileForm._wired){
        profileForm._wired = true;
        profileForm.addEventListener('submit', (e)=>{
          e.preventDefault();
          void handleOnboardingProfileSubmit();
        });
      }
      const locationsManage = $('btnOnboardingManageLocations');
      if(locationsManage && !locationsManage._wired){
        locationsManage._wired = true;
        locationsManage.addEventListener('click', ()=>{
          setOnboardingMessage('onboardingLocationsMsg', '');
          if(!canAccessCompanyLocations()){
            setOnboardingMessage('onboardingLocationsMsg', 'Ask an admin to manage locations for your company.');
            return;
          }
          void openCompanyLocationsModal();
        });
      }
      const locationsContinue = $('btnOnboardingLocationsContinue');
      if(locationsContinue && !locationsContinue._wired){
        locationsContinue._wired = true;
        locationsContinue.addEventListener('click', ()=>{
          void handleOnboardingLocationsContinue();
        });
      }
      const inviteOpen = $('btnOnboardingInviteOpen');
      if(inviteOpen && !inviteOpen._wired){
        inviteOpen._wired = true;
        inviteOpen.addEventListener('click', ()=>{
          if(!canAccessInvites()){
            setOnboardingMessage('onboardingInvitesMsg', 'Invites require Business tier and invite permissions. You can skip for now.');
            return;
          }
          show('inviteModal', true);
        });
      }
      const invitesRefresh = $('btnOnboardingInvitesRefresh');
      if(invitesRefresh && !invitesRefresh._wired){
        invitesRefresh._wired = true;
        invitesRefresh.addEventListener('click', ()=>{
          void refreshPendingInvites();
        });
      }
      const invitesSkip = $('btnOnboardingInvitesSkip');
      if(invitesSkip && !invitesSkip._wired){
        invitesSkip._wired = true;
        invitesSkip.addEventListener('click', ()=>{
          void handleOnboardingInvitesSkip();
        });
      }
      const invitesContinue = $('btnOnboardingInvitesContinue');
      if(invitesContinue && !invitesContinue._wired){
        invitesContinue._wired = true;
        invitesContinue.addEventListener('click', ()=>{
          void handleOnboardingInvitesContinue();
        });
      }
      const finishBtn = $('btnOnboardingFinish');
      if(finishBtn && !finishBtn._wired){
        finishBtn._wired = true;
        finishBtn.addEventListener('click', ()=>{
          void handleOnboardingFinish();
        });
      }
    }
    async function handleOnboardingRoute(){
      const active = isOnboardingRoute();
      setOnboardingRouteActive(active);
      if(!active) return false;
      loadOnboardingIntent();
      renderOnboardingPlanSummary();

      if(!SB.ready){
        setOnboardingGate({
          title:'Supabase not configured',
          message:'Connect Supabase to continue onboarding.',
          primaryLabel:'Close',
          primaryAction:()=>{ show('authModal', false); },
          secondaryLabel:''
        });
        return true;
      }

      if(!SB.session){
        // Self-service signup flow - show account creation step
        _signupMode = true;
        _signupPlan = state._onboardingIntent?.plan || '';
        setOnboardingGate({ show: false });
        renderOnboardingStep('account');
        renderSignupProgress(1);
        if(state._signupError){
          setSignupMessage(state._signupError, true);
          state._signupError = '';
        }
        return true;
      }

      if(isEffectiveSuperUser() && !state._onboardingAllowSuper){
        setOnboardingGate({
          title:'Super users can bypass onboarding',
          message:'You can skip onboarding and go straight to the dashboard.',
          primaryLabel:'Go to Dashboard',
          primaryAction:()=>{ redirectToAppHome(); },
          secondaryLabel:'Continue onboarding',
          secondaryAction:()=>{ state._onboardingAllowSuper = true; void handleOnboardingRoute(); }
        });
        return true;
      }

      if(!SB.companyId){
        // User has account but no company - show company creation step
        _signupMode = true;
        _signupPlan = state._onboardingIntent?.plan || '';
        setOnboardingGate({ show: false });
        renderOnboardingStep('company');
        renderSignupProgress(2);
        return true;
      }

      // Track onboarding company for invite dropdown
      _onboardingCompanyId = String(SB.companyId);

      setOnboardingGate({ show:false });
      setOnboardingMessage('onboardingProfileMsg', '');
      setOnboardingMessage('onboardingLocationsMsg', '');
      setOnboardingMessage('onboardingInvitesMsg', '');
      setOnboardingMessage('onboardingFinishMsg', '');

      try{
        state._onboardingState = await fetchOnboardingState();
      }catch(e){
        setOnboardingGate({
          title:'Unable to load onboarding',
          message:e && e.message ? e.message : 'Try again in a moment.',
          primaryLabel:'Retry',
          primaryAction:()=>{ void handleOnboardingRoute(); },
          secondaryLabel:''
        });
        return true;
      }

      if(state._onboardingState === 'ONBOARDING_COMPLETE'){
        redirectToAppHome();
        return true;
      }

      const stepIndex = getOnboardingStepFromState(state._onboardingState);
      const stepId = stepIndex === 1 ? 'profile' : stepIndex === 2 ? 'locations' : stepIndex === 3 ? 'invites' : 'finish';
      state._onboardingStep = stepId;
      renderOnboardingProgress(stepIndex);
      renderOnboardingStep(stepId);

      if(stepId === 'profile'){
        try{
          const profile = await loadOnboardingCompanyProfile();
          applyOnboardingProfileToForm(profile);
        }catch(e){
          setOnboardingMessage('onboardingProfileMsg', e && e.message ? e.message : 'Unable to load profile.');
        }
      }

      if(stepId === 'locations'){
        try{
          const rows = await sbFetchCompanyLocations();
          renderOnboardingLocationsStatus(rows);
          if(!canAccessCompanyLocations()){
            setOnboardingMessage('onboardingLocationsMsg', 'Ask an admin to manage locations for your company.');
          }
        }catch(e){
          setOnboardingMessage('onboardingLocationsMsg', e && e.message ? e.message : 'Unable to load locations.');
        }
      }

      if(stepId === 'invites'){
        attachPendingInvitesToOnboarding();
        _userMgmtCompanyId = SB.companyId ? String(SB.companyId) : '';
        renderOnboardingInviteNotice();
        try{
          await refreshPendingInvites();
        }catch(e){}
      }else{
        restorePendingInvitesToUserMgmt();
      }

      return true;
    }

    // Boot
      document.addEventListener('DOMContentLoaded', async ()=>{
      load();
      loadInventoryQuickFilter();
      render();
      initColumnBuilder();
      initButtonSystem();
      storeOnboardingIntentFromUrl();
      loadOnboardingIntent();
      renderOnboardingPlanSummary();
      setOnboardingRouteActive(isOnboardingRoute());
      wireOnboardingEvents();
      try{ setEditHint(); }catch(e){}
      try{ adjustTitleSize(); if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=> requestAnimationFrame(adjustTitleSize)); } }catch(e){}
      const fb=$('filterBox'); if(fb){
        fb.value=state._filter||'';
        updateFilterClearBtn();
        fb.addEventListener('input', ()=>{ state._filter=fb.value; renderTable(); save(); updateFilterClearBtn(); });
        fb.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && fb.value){ e.preventDefault(); fb.value=''; state._filter=''; renderTable(); save(); updateFilterClearBtn(); }});
      }
	      const clr=$('btnClearFilter'); if(clr && fb){
	        clr.addEventListener('click', ()=>{
	          if(!fb.value) return;
	          fb.value='';
	          state._filter='';
          renderTable();
          save();
          updateFilterClearBtn();
          try{ fb.focus(); }catch(e){}
	        });
	      }
      const quickFilters = $('invQuickFilters');
      if(quickFilters && !quickFilters._wired){
        quickFilters._wired = true;
        quickFilters.addEventListener('click', (e)=>{
          const btn = e.target && e.target.closest ? e.target.closest('[data-filter]') : null;
          if(!btn) return;
          const key = btn.getAttribute('data-filter');
          setInventoryQuickFilter(key);
        });
      }
      updateQuickFilterPills();

	      // Order counter badge - delegated handler for all [data-order-reset] elements
	      document.addEventListener('click', (e)=>{
	        const badge = e.target.closest('[data-order-reset]');
	        if(!badge) return;
	        e.preventDefault();
	        clearAllOrderLines();
	        toast('Shopping cart cleared');
	        try{ syncReportOrderIndicators(); }catch(ex){}
	      });
	      try{ updateOrderCounterBadge(); }catch(e){}

	      // iOS-style qty picker - event handlers
	      const qtyPickerCancel = $('qtyPickerCancel');
	      const qtyPickerDone = $('qtyPickerDone');
	      const qtyPickerWheel = $('qtyPickerWheel');
	      if(qtyPickerCancel) qtyPickerCancel.addEventListener('click', closeQtyPicker);
	      if(qtyPickerDone) qtyPickerDone.addEventListener('click', handleQtyPickerDone);

	      // Wheel touch/mouse drag
	      if(qtyPickerWheel){
	        const getY = (e) => e.touches ? e.touches[0].clientY : e.clientY;
	        qtyPickerWheel.addEventListener('touchstart', (e)=>{
	          _qtyPicker.isDragging = true;
	          _qtyPicker.startY = getY(e);
	          _qtyPicker.startScrollY = _qtyPicker.scrollY;
	          qtyPickerWheel.style.transition = '';
	        }, { passive: true });
	        qtyPickerWheel.addEventListener('touchmove', (e)=>{
	          if(!_qtyPicker.isDragging) return;
	          const deltaY = getY(e) - _qtyPicker.startY;
	          _qtyPicker.scrollY = _qtyPicker.startScrollY + deltaY;
	          // Clamp scroll
	          const minScroll = -_qtyPicker.maxQty * 36;
	          _qtyPicker.scrollY = Math.max(minScroll, Math.min(0, _qtyPicker.scrollY));
	          qtyPickerWheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
	          updateQtyPickerSelection();
	        }, { passive: true });
	        qtyPickerWheel.addEventListener('touchend', ()=>{
	          _qtyPicker.isDragging = false;
	          snapQtyPicker();
	        });
	        // Click on item to select
	        qtyPickerWheel.addEventListener('click', (e)=>{
	          const item = e.target.closest('.qty-picker-item');
	          if(!item) return;
	          const qty = parseInt(item.dataset.qty, 10);
	          if(!isNaN(qty)){
	            _qtyPicker.selectedQty = qty;
	            _qtyPicker.scrollY = -qty * 36;
	            snapQtyPicker();
	          }
	        });
	      }

	      // Long-press on qty stepper in order modal to open picker
	      let _longPressTimer = null;
	      const orderLinesBody = $('orderLinesBody');
	      if(orderLinesBody){
	        orderLinesBody.addEventListener('touchstart', (e)=>{
	          const trigger = e.target.closest('[data-qty-picker-trigger]');
	          if(!trigger) return;
	          const id = trigger.dataset.qtyPickerTrigger;
	          _longPressTimer = setTimeout(()=>{
	            const ord = orderState();
	            const line = ord.lines.find(l => l.id === id);
	            if(line){
	              openQtyPicker(id, line.name, toInt(line.qty, 0));
	            }
	            _longPressTimer = null;
	          }, 500);
	        }, { passive: true });
	        orderLinesBody.addEventListener('touchend', ()=>{
	          if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer = null; }
	        });
	        orderLinesBody.addEventListener('touchmove', ()=>{
	          if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer = null; }
	        }, { passive: true });
	      }

      const mobileSort = $('mobileSort');
      if(mobileSort){
        mobileSort.addEventListener('change', ()=>{
          const raw = String(mobileSort.value || '');
          const parts = raw.split(':');
          const col = (parts[0] || '').trim();
          const dir = (parts[1] || '').trim() === 'desc' ? 'desc' : 'asc';
          if(!col){
            state._sort = null;
            renderTable();
            save();
            return;
          }
          const visibleDefs = getInventorySortDefs();
          const visibleCols = new Set(visibleDefs.map(def => (def.dataCol || def.key)).filter(Boolean));
          if(!visibleCols.has(col)){
            state._sort = null;
          }else{
            state._sort = { col, dir };
          }
          renderTable();
          save();
        });
      }

	      bindInventorySortHandlers();

	      // Supabase init and health check
	      try{
        sbInit();
        updateStatusBar();
        await sbAuthBoot();
      }catch(e){
        console.warn('Startup error', e);
        SB.connected = false;
        updateStatusBar();
      }

      // Keep the status fresh
      window.addEventListener('online', checkServerHealth);
      window.addEventListener('offline', checkServerHealth);
	      setInterval(checkServerHealth, 15000);
	
	      // Responsive: recompute inventory column layout on viewport change
		      window.addEventListener('resize', ()=> { try{ scheduleInventoryLayoutRefresh(); }catch(e){} });
	
	      // Close modals when clicking outside (on backdrop)
	      document.addEventListener('click', (e)=>{
	        try{
	          if(isMobileUx() && _openTrayId){
	            const inTray = !!e.target.closest('.card-tray');
	            const inTable = !!e.target.closest('#invTable');
	            if(!inTray && !inTable) closeMobileTray();
	          }
	        }catch(e){}
	        const modalBackdrop = e.target.closest('.modal-backdrop');
	        if(modalBackdrop && e.target === modalBackdrop){
	          if(modalBackdrop.id === 'editItemModal') return;
	          show(modalBackdrop.id, false);
        }
      });

      if('serviceWorker' in navigator){
        // Listen for SW activation and update flow
        let _swReloaded = false;
        navigator.serviceWorker.addEventListener('controllerchange', ()=>{
          if(_swReloaded) return; _swReloaded = true;
          try{ toast('App updated. Reloadingâ€¦'); }catch{}
          setTimeout(()=> location.reload(), 400);
        });
        navigator.serviceWorker.addEventListener('message', (e)=>{
          if(!e || !e.data) return;
          if(e.data.type === 'SW_ACTIVATED'){
            // No-op: controllerchange handler above will handle reload UX
          }
        });
        navigator.serviceWorker.register('./sw.js?v=14', { scope: './' }).catch(console.warn);
      }
    });
  </script>
</body>
</html>
