<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <link rel="manifest" href="./manifest.webmanifest?v=7" />
  <link rel="icon" href="./assets/oakley/favicon/favicon.ico" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@600;700;800&display=swap" rel="stylesheet">
  <title>Oakley Services Inventory</title>

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>

  <!-- Optional: set your Supabase URL and anon key here -->
  <script>
    // Supabase project credentials (safe to expose anon public key in client)
    window.SB_URL  = "https://entmbaxeylglposptsuy.supabase.co";
    window.SB_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVudG1iYXhleWxnbHBvc3B0c3V5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTQ2NjEsImV4cCI6MjA3MjQ5MDY2MX0.vDTzhL0Q-iDZShWu2hcaYOavPLltY31OThXj-ohBjAc";
  </script>

  <script>
  // Lightweight observability: log JS errors so users can screenshot
  window.addEventListener('error', e => console.log('JS Error:', e.message, e.error));
  window.addEventListener('unhandledrejection', e => console.log('Promise Rejection:', e.reason));
  </script>

  <style>
    :root{
      --bg:#24292d;--fg:#eaeff7;--muted:#a9b4c0;--accent:#5aa9ff;
      --card:#000000;--border:#1f2a36;--title-min:12px;--title-max:56px
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background:var(--bg);color:var(--fg);overflow-x:hidden
    }
    @media (pointer: fine){
      body{ min-width:390px; }
    }
    header{
      padding:calc(10px + env(safe-area-inset-top)) 16px 8px;
      border-bottom:1px solid var(--border);
      position:sticky;top:0;background:var(--bg);z-index:20;text-align:center;
    }
    .header-inner{ max-width:1100px; margin:0 auto; padding:0 24px; }
.status{margin-top:8px;display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;background:#0d1420;color:#9fb3c8;appearance:none;-webkit-appearance:none;cursor:pointer;text-align:left}
.status.online{color:#ffffff;background:#0f2d18;border-color:#1b5432}
.status.offline{color:#ffffff;background:#2a1212;border-color:#5a1c1c}
    h1{margin:0;text-align:left;font-family:'Barlow',ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; font-weight:800; font-size:clamp(var(--title-min), 6vw, var(--title-max)); letter-spacing:1px}
    main{padding:12px;max-width:1100px;margin:0 auto}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .toolbar .spacer{flex:1}
    .btn{
      cursor:pointer;border:1px solid var(--border);background:#101826;color:#fff;
      padding: clamp(10px, 2.2vw, 12px) clamp(12px, 3vw, 14px);
      border-radius:10px;font-weight:600;
      font-size: clamp(14px, 2.8vw, 16px);
      line-height:1.1; white-space:nowrap; min-height:44px
    }
    .btn.small{
      padding:8px 10px;
      font-size:13px;
      min-height:36px;
    }
    .btn.btn-icon{
      padding:10px;
      min-height:44px;
      min-width:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .btn.primary{background:var(--accent);color:#06121f;border-color:transparent}
    .btn.danger{background:#2a1212;color:#fff;border-color:#5a1c1c}
    .btn.danger:hover{background:#351414}
    .edit-footer .btn.danger{ margin-right:auto }
    .btn:disabled{ opacity:.55; cursor:not-allowed }
    /* Modern toggle switch */
    .toggle-switch{
      position:relative;
      width:48px;
      height:26px;
      flex-shrink:0;
    }
    .toggle-switch input{
      opacity:0;
      width:0;
      height:0;
      position:absolute;
    }
    .toggle-slider{
      position:absolute;
      cursor:pointer;
      inset:0;
      background:#374151;
      border-radius:26px;
      transition:background 0.25s ease, box-shadow 0.25s ease;
    }
    .toggle-slider::before{
      content:'';
      position:absolute;
      width:20px;
      height:20px;
      left:3px;
      bottom:3px;
      background:#fff;
      border-radius:50%;
      transition:transform 0.25s ease;
      box-shadow:0 1px 3px rgba(0,0,0,0.3);
    }
    .toggle-switch input:checked + .toggle-slider{
      background:#22c55e;
      box-shadow:0 0 8px rgba(34,197,94,0.4);
    }
    .toggle-switch input:checked + .toggle-slider::before{
      transform:translateX(22px);
    }
    .toggle-switch input:focus + .toggle-slider{
      box-shadow:0 0 0 2px rgba(34,197,94,0.3);
    }
    .muted{color:var(--muted);font-size:12px}
    .time{font-size:12px;color:var(--muted)}
    .scroll{overflow:auto;max-height:70vh;border-radius:10px;position:relative;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
    #tableWrap{ overflow-x:hidden; }
    table{width:100%;border-collapse:collapse;font-size:15px}
	    thead th{
	      text-align:center;color:#e2e8f0;font-weight:700;border-bottom:2px solid var(--border);
	      padding:14px 12px;position:sticky;top:0;background:#0d1117;z-index:7;
	      text-transform:uppercase;font-size:12px;letter-spacing:0.5px;
	      white-space:nowrap;
	    }
	    /* Table header alignment + contrast */
	    #invTable thead th[data-col="name"],
	    #invTable thead th[data-col="desc"]{
	      text-align:left;
	    }
	    #invTable tbody td[data-col="name"] .cell-val{ font-weight:900; }
	    #invTable tbody td[data-col="desc"] .cell-val{ color:var(--muted); }
    th.sortable{ cursor:pointer; user-select:none }
    th.sortable .sort-ind{ margin-left:6px; opacity:.85; display:inline }
    
    th.sorted-asc .sort-ind::before{ content:'\25B2'; opacity:1 }
    th.sorted-desc .sort-ind::before{ content:'\25BC'; opacity:1 }
	tbody td{padding:12px;border-bottom:1px solid var(--border);vertical-align:middle}
    td.actions{padding:8px;text-align:right}
    .actions-wrap{display:inline-flex;gap:8px;align-items:center;justify-content:flex-end}
				    .row-delete-btn,
				    .row-stock-btn{
				      background:none;
				      border:none;
				      cursor:pointer;
				      padding:6px;
				      color:var(--muted);
				      display:inline-flex;
				      align-items:center;
				      justify-content:center;
				      border-radius:6px;
				      position:relative;
				      transition:background 0.15s,color 0.15s;
				      touch-action:manipulation;
				      -webkit-appearance:none;
				      appearance:none;
				    }
			    .row-delete-btn svg,
			    .row-stock-btn svg{
			      width:18px;
			      height:18px;
			      display:block;
			    }
				    .row-delete-btn:hover{background:rgba(255,80,80,0.15);color:#ff6b6b}
				    .row-stock-btn:hover{background:rgba(135,245,255,0.12);color:#87F5FF}
				    .row-stock-btn.has-override::after{
				      content:'';
				      position:absolute;
				      bottom:4px;
				      right:4px;
				      width:8px;
				      height:8px;
				      border-radius:50%;
				      background:#87F5FF;
				      border:2px solid rgba(0,0,0,0.9);
				      box-shadow:
				        0 0 0 1px rgba(255,255,255,0.08),
				        0 0 10px rgba(135,245,255,0.35);
				    }
				    /* Hidden by default (mobile-only UI elements) */
				    .card-leds,
				    .card-tray{
				      display:none;
				    }
				    @media (hover: hover) and (pointer: fine){
				      #invTable tbody tr[data-id]{
				        transition: filter 160ms ease;
				        transition-delay: 0ms;
				        filter:none;
				      }
				      #invTable tbody tr[data-id]:hover{
				        transition-delay: 200ms; /* avoids flicker while scrolling */
				        filter:
				          drop-shadow(0 0 16px rgba(135,245,255,0.24))
				          drop-shadow(0 0 46px rgba(135,245,255,0.08));
				      }
				    }
			    /* Mobile table layout: stack fields vertically per record */
				    @media (max-width: 768px), (pointer: coarse){
				      #invTable thead{ display:none; }
				      #invTable tbody tr[data-id]{
			        position:relative;
			        isolation:isolate;
			        display:block;
			        --swipe-x: 0px;
			        --tray-progress: 0;
			        --tray-outer: 0;
			        --tray-inner: 0;
			        --focus-y: 0px;
			        --spot-i: 0;
			        --spot-a0: 0;
			        --spot-a1: 0;
			        --spot-a2: 0;
			        --spot-x: 0px;
			        --spot-y: 0px;
			        --spot-rx: 120px;
			        --spot-ry: 74px;
			        padding:6px; /* tighter cards to reduce scrolling */
			        border-radius:14px;
			        border:none;
			        background:none;
			        box-shadow:none;
			        margin:0 0 6px 0;
			        touch-action: pan-y;
			        transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
			        will-change: transform, box-shadow;
			        transform: translateX(var(--swipe-x)) translateY(var(--focus-y));
				      }
				      /* Elastic snap-back animation when releasing from detent */
				      #invTable tbody tr[data-id].snap-elastic{
				        transition: transform 380ms cubic-bezier(0.175, 0.885, 0.32, 1.175) !important;
				      }
				      /* iMessage-style swipe layering: tray behind a card surface */
				      #invTable tbody tr[data-id]::after{
				        content:'';
				        position:absolute;
				        inset:0;
				        border:1px solid var(--border);
				        border-radius:14px;
				        background: linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
				        box-shadow:0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
				        transition: border-color 180ms ease, box-shadow 180ms ease;
				        z-index:2;
				        pointer-events:none;
				      }
				      #invTable tbody tr[data-id].order-selected::after{
				        background:
				          radial-gradient(200px 110px at 50% 40%, rgba(34,197,94,0.20), rgba(34,197,94,0) 70%),
				          linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%) !important;
				        box-shadow:
				          0 0 0 1px rgba(34,197,94,0.12),
				          0 0 16px rgba(34,197,94,0.10),
				          0 2px 8px rgba(0,0,0,0.3),
				          inset 0 1px 0 rgba(255,255,255,0.05) !important;
				      }
		      #invTable tbody tr[data-id] td{
		        display:block;
		        width:100%;
		        padding:0;
		        border-bottom:none;
		        position:relative;
		      }
		      #invTable tbody tr[data-id] td[data-col]::before,
		      #invTable tbody tr[data-id] td[data-col] .cell-val,
		      #invTable tbody tr[data-id] td[data-col="qty"] .qty-stepper{
		        position:relative;
		        z-index:3;
		      }
			      #invTable tbody tr[data-id] td[data-col]{
			        padding:2px 0;
			      }
				      #invTable tbody tr[data-id] td[data-col="name"]{
				        padding-left:0;
				        padding-right:0;
				        min-height:0;
				        position:static; /* Allow tray to position relative to tr, not td */
				      }
				      #invTable tbody tr[data-id] td[data-col="desc"]{ padding-left:0; }
				      #invTable tbody tr[data-id] td[data-col]::before{
				        display:block;
				        font-size:10px;
				        letter-spacing:.08em;
				        text-transform:uppercase;
				        color:var(--muted);
				        margin:0 0 4px 0;
				        text-align:left;
				      }
				      /* Mobile UX v2: remove Item/Description labels to reduce vertical height */
				      #invTable tbody tr[data-id] td[data-col="name"]::before{ content:''; display:none; }
				      #invTable tbody tr[data-id] td[data-col="desc"]::before{ content:''; display:none; }
				      #invTable tbody tr[data-id] td[data-col="qty"]::before{ content:''; display:none; }

				      #invTable tbody tr[data-id] td[data-col="name"] .cell-val{ font-weight:900; }
				      #invTable tbody tr[data-id] td[data-col="desc"] .cell-val{
				        color:var(--muted);
				        font-size:12px;
				        white-space:nowrap;
				        overflow:hidden;
				        text-overflow:ellipsis;
				        display:block;
		      }

			      #invTable tbody tr[data-id] td[data-col="qty"]{ text-align:center; }
			      
			      /* Mobile UX v2: no checkbox selection + no inline action buttons */
			      #invTable tbody tr[data-id] td.sel{ display:none !important; }
			      #invTable tbody tr[data-id] td.actions{ display:none !important; }

			      /* Mobile UX v2: order/override LEDs */
			      #invTable tbody tr[data-id] .card-leds{
			        position:absolute;
			        top:8px;
			        right:8px;
			        display:flex;
			        gap:6px;
			        pointer-events:none;
			        z-index:4;
			      }
			      #invTable tbody tr[data-id] .card-led{
			        width:10px;
			        height:10px;
			        border-radius:50%;
			        background:rgba(148,163,184,0.55); /* muted/off */
			        border:1px solid rgba(0,0,0,0.65);
			        box-shadow:0 0 0 1px rgba(255,255,255,0.08);
			      }
			      #invTable tbody tr[data-id] .card-led.card-led--on{ filter:saturate(1.15); }
			      #invTable tbody tr[data-id] .card-led.card-led--order.card-led--on{
			        background:#22c55e;
			        box-shadow: 0 0 10px rgba(34,197,94,0.35), 0 0 0 1px rgba(255,255,255,0.10);
			      }
			      #invTable tbody tr[data-id] .card-led.card-led--lowstock.card-led--on{
			        background:#f59e0b;
			        box-shadow: 0 0 10px rgba(245,158,11,0.45), 0 0 0 1px rgba(255,255,255,0.10);
			      }
			      #invTable tbody tr[data-id] .card-led.card-led--lowstock.card-led--outofstock{
			        background:#ef4444;
			        box-shadow: 0 0 10px rgba(239,68,68,0.5), 0 0 0 1px rgba(255,255,255,0.10);
			      }

			      /* Mobile UX v2: iMessage-style swipe tray (Edit + Low Stock only) */
			      #invTable tbody tr[data-id] .card-tray{
			        position:absolute;
			        inset:0;
			        transform:translateX(calc(0px - var(--swipe-x, 0px)));
			        display:flex;
			        flex-direction:row;
			        align-items:center;
			        justify-content:flex-end;
			        gap:0;
			        opacity:1;
			        pointer-events:none;
			        z-index:1;
			      }
				      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray{
				        justify-content:flex-start;
				      }
				      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray{
				        justify-content:flex-end;
				      }
				      #invTable tbody tr[data-id].tray-open .card-tray{
				        pointer-events:auto;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn{
				        width:96px;
				        height:100%;
				        border:0;
				        border-radius:0;
				        background:transparent;
				        color:#e5e7eb;
				        display:flex;
				        align-items:center;
				        justify-content:center;
				        padding:4px;
				        cursor:pointer;
				        touch-action:manipulation;
				        -webkit-appearance:none;
				        appearance:none;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn:active{
				        filter:brightness(0.96);
				      }

				      #invTable tbody tr[data-id] .card-tray-btn svg{
				        width:61px;
				        height:61px;
				        display:block;
				        opacity:0;
				        transform:scale(0.4);
				        transition: opacity 160ms ease, transform 160ms ease;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn svg *{
				        stroke-width:2.4px;
				      }

				      /* High-contrast strokes (no action background colors) */
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="lowStock"]{
				        color:#fbbf24;
				      }
				      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="edit"]{
				        color:#22c55e;
				      }

			      /* Sequential icon reveal: outer icon first, then inner icon */
			      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray-btn:last-child svg{
			        opacity: var(--tray-outer, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
			      }
			      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray-btn:first-child svg{
			        opacity: var(--tray-inner, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-inner, 0))));
			      }
			      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray-btn:first-child svg{
			        opacity: var(--tray-outer, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-outer, 0))));
			      }
			      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray-btn:last-child svg{
			        opacity: var(--tray-inner, 0);
			        transform: scale(calc(0.4 + (0.6 * var(--tray-inner, 0))));
			      }

			      /* Rounded outer corners to match the card */
			      #invTable tbody tr[data-id][data-tray-side="right"] .card-tray-btn:last-child{
			        border-top-right-radius:14px;
			        border-bottom-right-radius:14px;
			      }
			      #invTable tbody tr[data-id][data-tray-side="left"] .card-tray-btn:first-child{
			        border-top-left-radius:14px;
			        border-bottom-left-radius:14px;
			      }

			      /* Glow effect on edit icon - fades in based on --commit-progress variable */
			      #invTable tbody tr[data-id] .card-tray-btn[data-tray-action="edit"] svg{
			        filter: drop-shadow(0 0 calc(16px * var(--commit-progress, 0)) rgba(34,197,94, var(--commit-progress, 0)));
			      }
			      /* Elastic stretch effect on edit icon when approaching commit threshold */
			      #invTable tbody tr[data-id].commit-armed .card-tray-btn[data-tray-action="edit"] svg{
			        transform: scale(1.03) !important;
			      }

			      /* Mobile UX v2: ensure steppers meet 48×48 target */
			      .qty-step{ min-width:48px; min-height:48px; }
			      .qty-stepper--table .qty-step{ min-width:48px; }
			      #invTable tbody tr[data-id].swiping .card-tray,
			      #invTable tbody tr[data-id].swiping .card-tray-btn,
			      #invTable tbody tr[data-id].swiping .card-tray-btn svg{ transition:none !important; }
			      #invTable tbody tr[data-id].swiping{ transition:none !important; }
		    }
		    @media (prefers-reduced-motion: reduce){
		      #invTable tbody tr[data-id]{ transition:none !important; }
		      #invTable tbody tr[data-id]::before{ transition:none !important; }
		      #invTable tbody tr[data-id]::after{ transition:none !important; }
		      #invTable tbody tr[data-id] .card-tray{ transition:none !important; }
		    }

    /* Desktop description: keep on one line (dynamic width handles it) */
    @media (min-width: 769px){ td[data-col="desc"], th[data-col="desc"]{ white-space:nowrap; } }
	    td.qty{text-align:center;font-variant-numeric:tabular-nums}
    th.sel, td.sel{ width:42px; text-align:center }
    input[type=text],input[type=number],input[type=email],input[type=password],input[type=tel],textarea,select{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);
      background:#0d131b;color:#fff;font-size:16px
    }
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .hero-logo{height:clamp(36px,8vw,56px); margin:10px auto 0 auto;}
    .headwrap{display:flex;align-items:center;justify-content:center;gap:10px;flex-wrap:nowrap}
    .logo{height:auto;width:auto;display:block}
    .brandrow{display:flex;align-items:center;justify-content:space-between;gap:14px}
    .title-logo{height:clamp(44px,9vw,62px); width:auto; display:block;}
	    .brandtext{display:flex;flex-direction:column;align-items:flex-start;flex:1;min-width:0;}
	    .inv-controls{ display:flex; align-items:center; justify-content:center; gap:10px; width:100%; flex-wrap:nowrap; }
	    .input-wrap{ position:relative; width:100%; max-width:480px; }
	    .sort-wrap{ display:none; }
	    .clear-input-btn{
	      position:absolute;
	      right:8px;
	      top:50%;
      transform:translateY(-50%);
      width:40px;
      height:40px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      cursor:pointer;
      touch-action:manipulation;
      -webkit-appearance:none;
      appearance:none;
    }
    .clear-input-btn:hover{ background:#0e1621; }
	    .clear-input-btn:disabled{ opacity:.55; cursor:not-allowed; }
	    .input-wrap > input{ padding-right:52px; }
	    #filterBox{
	      width:100%; max-width:480px;
	      padding:12px 52px 12px 12px;border-radius:10px;border:1px solid var(--border);
	      background:#0d131b;color:#eaeff7;font-size:16px
	    }
	    @media (max-width: 768px){
	      .inv-controls{ gap:8px; }
	      .inv-controls .input-wrap{ flex:1 1 auto; max-width:none; }
	      .sort-wrap{ display:block; flex:0 0 auto; width:160px; }
	      #mobileSort{ padding:12px; border-radius:10px; }
	    }
    td.editing{padding:6px}
    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:calc(18px + env(safe-area-inset-bottom));
      background:rgba(255,255,255,0.96);
      border:1px solid rgba(0,0,0,0.12);
      color:#0b1020;
      font-weight:800;
      padding:10px 14px;border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,.55);
      z-index:300;
      display:none
    }
	    .modal{
	      display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:200;
	      overflow:auto;
	      padding:calc(12px + env(safe-area-inset-top)) 12px calc(12px + env(safe-area-inset-bottom));
	      -webkit-backdrop-filter: blur(8px);
	      backdrop-filter: blur(8px);
	    }
	    #reportEmailModal{ z-index:220; }
	    #msgModal{ z-index:240; }
	    #confirmModal{ z-index:250; }
	    .modal .box{
	      max-width:580px;
	      width:100%;
	      margin:0 auto;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      max-height:calc(100vh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      max-height:calc(100dvh - 24px - env(safe-area-inset-top) - env(safe-area-inset-bottom));
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .modal .box.edit-box{
      padding:0;
      overflow:hidden; /* body scrolls */
      display:flex;
      flex-direction:column;
    }
    .edit-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background:var(--card);
    }
    .edit-header h2{ margin:0; font-size:16px; }
    .edit-sub{ margin-top:6px; color:var(--muted); font-size:12px; }
    .edit-body{
      padding:12px 14px 14px;
      overflow:auto;
      flex:1;
      -webkit-overflow-scrolling:touch;
    }
    .edit-body textarea{
      min-height:30vh;
    }
    .qty-stepper.qty-stepper--modal,
    .qty-stepper.qty-stepper--table{
      display:inline-flex;
      align-items:center;
      flex-wrap:nowrap;
      justify-content:center;
      background:transparent;
      border:none;
      border-radius:0;
      overflow:visible;
      height:auto;
    }
    .qty-stepper.qty-stepper--modal{ gap:10px; }
    .qty-stepper.qty-stepper--table{ gap:6px; }
    .qty-stepper--table .qty-step{ min-width:38px; }
    .qty-stepper--table .qty-value{ min-width:30px; font-size:15px; }
    .qty-step{
      cursor:pointer;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      border-radius:10px;
      min-width:44px;
      min-height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      font-size:20px;
      line-height:1;
      user-select:none;
      -webkit-appearance:none;
      appearance:none;
      touch-action:manipulation;
    }
    .qty-step:disabled{ opacity:.55; cursor:not-allowed; }
    .qty-value{
      min-width:44px;
      text-align:center;
      font-variant-numeric:tabular-nums;
      font-weight:800;
      font-size:16px;
      line-height:1;
    }
    .qty-stepper.qty-stepper--modal input[type=number]{
      width:4rem;
      text-align:center;
      font-variant-numeric:tabular-nums;
    }
    .qty-stepper input[type=number]::-webkit-outer-spin-button,
	    .qty-stepper input[type=number]::-webkit-inner-spin-button{
	      -webkit-appearance:none;
	      margin:0;
	    }
	    .qty-stepper input[type=number]{ -moz-appearance:textfield; }
	    .edit-footer{
	      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
	      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#0b1017;
    }
    .section + .section{ margin-top:12px; }
    .section-title{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin:0 0 10px;
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .btn-icon-inline{
      background:transparent;
      border:none;
      padding:4px;
      margin-left:auto;
      cursor:pointer;
      color:var(--muted);
      border-radius:6px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:color 0.15s, background 0.15s;
    }
    .btn-icon-inline:hover{
      color:#fff;
      background:rgba(255,255,255,0.1);
    }
    .btn-icon-inline:active{
      background:rgba(255,255,255,0.15);
    }
    .order-box{
      padding:0;
      overflow:hidden; /* body scrolls */
      display:flex;
      flex-direction:column;
    }
    .order-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--border);
      background:var(--card);
    }
    .order-header h2{ margin:0; font-size:16px; }
    .order-body{
      padding:12px 14px 14px;
      overflow:auto;
      flex:1;
      -webkit-overflow-scrolling:touch;
    }
    .order-footer{
      padding:12px 14px calc(12px + env(safe-area-inset-bottom));
      border-top:1px solid var(--border);
      background:var(--card);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .order-recipient{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .order-recipient input[type=email]{ flex:1; min-width:200px; }
    .order-suggest{
      display:none;
      flex-direction:column;
      gap:6px;
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:6px;
      background:#000;
      max-height:190px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .order-suggest.has-suggest{ display:flex; }
    .suggest-chip{
      cursor:pointer;
      border:1px solid var(--border);
      background:#101826;
      color:#fff;
      padding:8px 10px;
      border-radius:10px;
      font-weight:700;
      font-size:13px;
      min-height:36px;
      max-width:100%;
      text-align:left;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .order-list{ display:flex; flex-direction:column; gap:10px; }
    .order-empty{
      padding:14px;
      border:1px dashed var(--border);
      border-radius:14px;
      background:transparent;
      color:var(--muted);
      font-size:13px;
      text-align:center;
    }
    .order-card{
      border:1px solid rgba(255,255,255,0.12);
      border-radius:14px;
      padding:14px;
      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
      box-shadow:0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
      transition: border-color 180ms ease, box-shadow 180ms ease;
    }
    .order-card.order-card--selected{
      background:
        radial-gradient(220px 120px at 40% 35%, rgba(34,197,94,0.20), rgba(34,197,94,0) 70%),
        linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%);
      box-shadow:0 0 0 1px rgba(34,197,94,0.12), 0 0 16px rgba(34,197,94,0.10), 0 2px 8px rgba(0,0,0,0.3), inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .order-card-led{
      width:8px; height:8px; border-radius:50%; flex-shrink:0;
      background:rgba(148,163,184,0.55);
      box-shadow:0 0 0 1px rgba(255,255,255,0.10);
      transition: background 180ms ease, box-shadow 180ms ease;
    }
    .order-card-led--on{
      background:#22c55e;
      box-shadow:0 0 6px rgba(34,197,94,0.5), 0 0 12px rgba(34,197,94,0.3);
    }
    .order-card-header{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .order-inline-kpi{
      margin-left:auto;
      display:flex;
      align-items:baseline;
      gap:6px;
      white-space:nowrap;
      font-size:12px;
      color:var(--muted);
      font-variant-numeric:tabular-nums;
    }
    .order-inline-kpi-val{
      color:var(--fg);
      font-weight:800;
      font-size:14px;
    }
    .order-card-top{ display:flex; gap:12px; align-items:flex-start; }
    .order-meta{ flex:1; min-width:0; }
    .order-title{ font-weight:700; font-size:15px; letter-spacing:-0.01em; }
    .order-sub{ margin-top:3px; color:var(--muted); font-size:12px; line-height:1.4; }
    .order-side{ display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
    .order-kpi{ text-align:right; }
    .order-kpi-label{ color:var(--muted); font-size:11px; text-transform:uppercase; letter-spacing:0.04em; }
    .order-kpi-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:18px; }
    .order-controls{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;
      gap:12px;
      align-items:flex-end;
    }
    .order-controls.order-controls--compact{
      margin-top:10px;
      padding-top:10px;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
    }
    .order-control{ flex-shrink:0; display:flex; flex-direction:column; }
    .order-control.qty{ width:64px; margin-left:auto; text-align:center; }
    .order-control.qty input{
      width:100%;
      text-align:center;
      font-weight:600;
      font-size:16px;
      font-variant-numeric:tabular-nums;
      height:42px;
      padding:0 8px;
      box-sizing:border-box;
    }
    .order-control-label{ color:var(--muted); font-size:11px; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.03em; }
    .order-control-value{ font-variant-numeric:tabular-nums; font-weight:700; font-size:17px; height:42px; display:flex; align-items:center; }
    .order-control-spacer{ height:17px; }
    .order-remove-btn{
      background:none; border:none; cursor:pointer; padding:8px;
      color:var(--muted); display:flex; align-items:center; justify-content:center;
      height:42px; width:42px; border-radius:8px; transition:background 0.15s, color 0.15s;
    }
    .order-remove-btn:hover{ background:rgba(255,80,80,0.15); color:#ff6b6b; }
    .order-remove-btn svg{ width:20px; height:20px; }
    .qty-stepper{
      display:flex; align-items:center; gap:0; background:#0d131b; border:1px solid var(--border);
      border-radius:10px; overflow:hidden; height:42px;
    }
    .qty-stepper-btn{
      width:42px; height:42px; border:none; background:transparent; color:#fff;
      font-size:20px; font-weight:500; cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition:background 0.15s;
    }
    .qty-stepper-btn:hover{ background:rgba(255,255,255,0.08); }
    .qty-stepper-btn:active{ background:rgba(255,255,255,0.12); }
    .qty-stepper-val{
      min-width:32px; text-align:center; font-weight:700; font-size:16px;
      font-variant-numeric:tabular-nums; color:#fff;
    }
    .order-preview{
      border:1px solid var(--border);
      border-radius:12px;
      background:#000;
      padding:10px;
    }
    .order-preview summary{
      cursor:pointer;
      list-style:none;
      font-weight:700;
      user-select:none;
    }
    .order-preview summary::-webkit-details-marker{ display:none; }
    .order-preview summary::after{ content:'▾'; float:right; color:var(--muted); }
    .order-preview[open] summary::after{ content:'▴'; }
    .order-preview-html{
      margin-top:10px;
      border-radius:8px;
      overflow:hidden;
      background:#fff;
      max-height:320px;
      overflow-y:auto;
    }
    .order-preview-html iframe{
      width:100%;
      border:none;
      min-height:280px;
    }
    .history-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .history-item{
      border:1px solid var(--border);
      border-radius:12px;
      background:#000;
      padding:10px;
    }
    .history-item summary{
      cursor:pointer;
      list-style:none;
      font-weight:800;
      user-select:none;
    }
    .history-item summary::-webkit-details-marker{ display:none; }
    .history-item summary::after{ content:'▾'; float:right; color:var(--muted); }
    .history-item[open] summary::after{ content:'▴'; }
    .history-meta{
      margin-top:4px;
      color:var(--muted);
      font-size:12px;
      font-weight:600;
    }
    .history-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .history-title{ flex:1; }
    .btn-icon-danger{
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      padding:4px;
      border-radius:4px;
      display:flex;
      align-items:center;
      justify-content:center;
      transition:color 0.15s, background 0.15s;
    }
	    .btn-icon-danger:hover{
	      color:#ef4444;
	      background:rgba(239,68,68,0.1);
	    }
	    /* iOS-style qty picker */
	    .qty-picker-modal{
	      display:flex !important;
	      align-items:flex-end;
	      justify-content:center;
	      padding:0;
	      opacity:0;
	      pointer-events:none;
	      transition:opacity 250ms ease;
	    }
	    .qty-picker-modal[aria-hidden="false"]{
	      opacity:1;
	      pointer-events:auto;
	    }
	    .qty-picker-modal .box{ display:none; }
	    .qty-picker-backdrop{
	      position:absolute;
	      inset:0;
	      background:rgba(0,0,0,0.5);
	    }
	    .qty-picker-sheet{
	      position:relative;
	      width:100%;
	      max-width:420px;
	      background:#1c1c1e;
	      border-radius:14px 14px 0 0;
	      padding-bottom:env(safe-area-inset-bottom, 20px);
	      transform:translateY(100%);
	      transition:transform 300ms cubic-bezier(0.32, 0.72, 0, 1);
	    }
	    .qty-picker-modal[aria-hidden="false"] .qty-picker-sheet{
	      transform:translateY(0);
	    }
	    .qty-picker-header{
	      display:flex;
	      align-items:center;
	      justify-content:space-between;
	      padding:12px 16px;
	      border-bottom:1px solid rgba(255,255,255,0.1);
	    }
	    .qty-picker-cancel,
	    .qty-picker-done{
	      background:none;
	      border:none;
	      font-size:17px;
	      font-weight:400;
	      cursor:pointer;
	      padding:8px 4px;
	      min-width:70px;
	    }
	    .qty-picker-cancel{ color:#ff453a; text-align:left; }
	    .qty-picker-done{ color:#30d158; text-align:right; font-weight:600; }
	    .qty-picker-title{
	      font-size:17px;
	      font-weight:600;
	      color:#fff;
	      text-align:center;
	    }
	    .qty-picker-wheel-wrap{
	      position:relative;
	      height:216px;
	      overflow:hidden;
	      -webkit-mask-image:linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
	      mask-image:linear-gradient(to bottom, transparent 0%, black 20%, black 80%, transparent 100%);
	    }
	    .qty-picker-highlight{
	      position:absolute;
	      top:50%;
	      left:16px;
	      right:16px;
	      height:36px;
	      transform:translateY(-50%);
	      background:rgba(120,120,128,0.24);
	      border-radius:8px;
	      pointer-events:none;
	    }
	    .qty-picker-wheel{
	      position:absolute;
	      top:0;
	      left:0;
	      right:0;
	      padding:90px 0;
	      display:flex;
	      flex-direction:column;
	      align-items:center;
	      transition:transform 150ms ease-out;
	    }
	    .qty-picker-item{
	      height:36px;
	      display:flex;
	      align-items:center;
	      justify-content:center;
	      font-size:22px;
	      font-weight:400;
	      color:rgba(255,255,255,0.85);
	      font-variant-numeric:tabular-nums;
	      transition:opacity 100ms ease, transform 100ms ease;
	    }
	    .qty-picker-item.selected{
	      font-weight:500;
	      color:#fff;
	    }
	    .report-metrics{
	      display:grid;
	      grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
	      gap:10px;
	      margin-top:12px;
	    }
	    .report-metric{
	      border:1px solid var(--border);
	      border-radius:12px;
	      padding:10px 12px;
	      background:#0d1420;
	    }
	    .report-metric .val{
	      margin-top:4px;
	      font-weight:900;
	      font-size:18px;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-metric--actionable{
	      position:relative;
	    }
	    .report-metric-action{
	      position:absolute;
	      top:8px;
	      right:8px;
	      background:rgba(255,255,255,0.08);
	      border:none;
	      border-radius:6px;
	      padding:6px;
	      cursor:pointer;
	      color:var(--muted);
	      display:flex;
	      align-items:center;
	      justify-content:center;
	      transition:color 0.15s, background 0.15s, transform 0.15s;
	    }
	    .report-metric-action:hover{
	      color:#22c55e;
	      background:rgba(34,197,94,0.15);
	      transform:scale(1.1);
	    }
	    .report-metric-action:active{
	      transform:scale(0.95);
	    }
	    .led-dot{
	      display:inline-block;
	      width:8px;
	      height:8px;
	      border-radius:50%;
	      margin-right:6px;
	      vertical-align:middle;
	      position:relative;
	      top:-1px;
	    }
	    .led-dot--red{
	      background:#ef4444;
	      box-shadow:0 0 6px rgba(239,68,68,0.5), 0 0 12px rgba(239,68,68,0.3);
	    }
	    .led-dot--amber{
	      background:#f59e0b;
	      box-shadow:0 0 6px rgba(245,158,11,0.5), 0 0 12px rgba(245,158,11,0.3);
	    }
	    .led-dot--green{
	      background:#22c55e;
	      box-shadow:0 0 6px rgba(34,197,94,0.5), 0 0 12px rgba(34,197,94,0.3);
	    }
	    .led-dot--cyan{
	      background:#06b6d4;
	      box-shadow:0 0 6px rgba(6,182,212,0.5), 0 0 12px rgba(6,182,212,0.3);
	    }
	    .led-dot--off{
	      background:rgba(148,163,184,0.55);
	      box-shadow:0 0 0 1px rgba(255,255,255,0.10);
	    }
	    .report-count{
	      color:var(--muted);
	      font-weight:900;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-progress{
	      margin-top:12px;
	      padding:10px 12px;
	      border:1px solid var(--border);
	      border-radius:14px;
	      background:#0d1420;
	    }
	    .report-progress-label{
	      display:flex;
	      align-items:center;
	      justify-content:space-between;
	      gap:10px;
	      color:var(--muted);
	      font-size:11px;
	      font-weight:900;
	      letter-spacing:0.08em;
	      text-transform:uppercase;
	    }
	    .report-progress-value{
	      flex:0 0 auto;
	      font-variant-numeric:tabular-nums;
	    }
	    .report-progress-track{
	      margin-top:10px;
	      height:10px;
	      border-radius:999px;
	      background:rgba(255,255,255,0.10);
	      overflow:hidden;
	      border:1px solid rgba(255,255,255,0.10);
	    }
	    .report-progress-bar{
	      height:100%;
	      width:0%;
	      border-radius:999px;
	      background:linear-gradient(90deg, rgba(34,197,94,1), rgba(135,245,255,0.9));
	      box-shadow:0 0 16px rgba(34,197,94,0.35);
	      transition: width 120ms ease;
	    }
	    .report-pill-container{
	      position:static;
	      margin:12px 0 0;
	      padding:0;
	      background:none;
	    }
		    .report-section{
		      margin-top:14px;
		      border:1px solid var(--border);
		      border-radius:14px;
		      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
		      overflow:hidden;
		    }
		    .report-summary{
		      display:flex;
		      align-items:center;
		      justify-content:space-between;
		      gap:10px;
		      padding:10px 12px;
		      cursor:pointer;
		      user-select:none;
		      list-style:none;
		    }
		    .report-section summary::-webkit-details-marker{ display:none; }
		    .report-section summary::marker{ content:''; }
		    .report-summary-left h3{
		      margin:0;
		      font-size:13px;
		      letter-spacing:.08em;
		      text-transform:uppercase;
		    }
		    .report-summary-right{
		      display:flex;
		      align-items:center;
		      justify-content:flex-end;
		      gap:10px;
		      flex-shrink:0;
		    }
		    .report-summary-right .muted{ font-size:12px; }
		    .report-chevron{
		      display:inline-block;
		      color:var(--muted);
		      font-size:14px;
		      line-height:1;
		      transform: rotate(0deg);
		      transition: transform 160ms ease;
		    }
		    .report-section[open] .report-chevron{ transform: rotate(180deg); }
		    .report-section[open] .report-summary{ border-bottom:1px solid rgba(255,255,255,0.08); }
		    .report-list{
		      display:flex;
		      flex-direction:column;
		      gap:8px;
		    }
		    .report-table{
		      width:100%;
		      border-collapse:collapse;
		      font-size:13px;
		    }
		    .report-table th{
		      text-align:left;
		      color:var(--muted);
		      font-weight:800;
		      border-bottom:1px solid rgba(255,255,255,0.10);
		      padding:10px 12px;
		      background:transparent;
		      position:static;
		      top:auto;
		      z-index:auto;
		      text-transform:uppercase;
		      font-size:11px;
		      letter-spacing:0.08em;
		      white-space:nowrap;
		    }
		    .report-table td{
		      padding:10px 12px;
		      border-bottom:1px solid rgba(255,255,255,0.08);
		      vertical-align:top;
		    }
		    .report-table td.item{
		      font-weight:900;
		      letter-spacing:0.02em;
		      white-space:nowrap;
		    }
		    .report-table td.desc{
		      color:var(--muted);
		      line-height:1.25;
		    }
		    .report-table th.qty,
		    .report-table td.qty,
		    .report-table th.thr,
		    .report-table td.thr{
		      text-align:right;
		      font-variant-numeric:tabular-nums;
		      font-weight:900;
		      white-space:nowrap;
		    }
		    .report-banner{
		      margin-top:12px;
		      padding:10px 12px;
		      border:1px solid rgba(135,245,255,0.22);
		      border-radius:12px;
		      background:rgba(135,245,255,0.06);
		      display:flex;
		      align-items:center;
		      justify-content:space-between;
		      gap:10px;
		    }
		    .report-banner-text{
		      min-width:0;
		      font-weight:700;
		      color:#c9f7ff;
		    }
		    .report-banner-actions{ display:flex; gap:8px; flex-shrink:0; }
		    .report-row{
		      display:flex;
		      align-items:flex-start;
		      justify-content:space-between;
		      gap:12px;
		      width:100%;
		      text-align:left;
		      cursor:pointer;
	      padding:10px 12px;
	      border:1px solid var(--border);
	      border-radius:12px;
	      background:linear-gradient(145deg, #1a1f26 0%, #12161c 100%);
	      color:inherit;
	      -webkit-appearance:none;
	      appearance:none;
	    }
	    .report-row:active{ transform:scale(0.99); }
	    .report-row:focus-visible{
	      outline:2px solid rgba(90,169,255,0.65);
	      outline-offset:2px;
	    }
		    .report-row[aria-pressed="true"]{
		      background:
		        radial-gradient(180px 90px at 50% 40%, rgba(34,197,94,0.20), rgba(34,197,94,0) 68%),
		        linear-gradient(145deg, rgba(34,197,94,0.10) 0%, #12161c 100%);
		      box-shadow:0 0 0 1px rgba(34,197,94,0.12), 0 10px 24px rgba(0,0,0,0.35);
		    }
		    .report-separator{
		      display:flex;
		      align-items:center;
		      gap:10px;
		      margin:12px 0;
		      color:rgba(255,255,255,0.55);
		      font-size:11px;
		      text-transform:uppercase;
		      letter-spacing:0.08em;
		      user-select:none;
		    }
		    .report-separator::before,
		    .report-separator::after{
		      content:'';
		      flex:1;
		      height:1px;
		      background:rgba(255,255,255,0.10);
		    }
		    .report-separator span{ padding:0 2px; }
		    .report-row-main{ min-width:0; flex:1; }
	    .report-item{
	      display:flex;
	      align-items:center;
	      gap:8px;
	      min-width:0;
	      font-weight:800;
	      letter-spacing:.02em;
	    }
	    .report-item-name{
	      overflow:hidden;
	      text-overflow:ellipsis;
	      white-space:nowrap;
	      min-width:0;
	    }
	    .report-desc{
	      margin-top:4px;
	      color:var(--muted);
	      font-size:13px;
	      line-height:1.25;
	      overflow:hidden;
	      display:-webkit-box;
	      -webkit-box-orient:vertical;
	      -webkit-line-clamp:2;
	    }
	    .report-qty{
	      flex:0 0 auto;
	      min-width:56px;
	      text-align:right;
	      font-weight:900;
	      font-variant-numeric:tabular-nums;
	      display:flex;
	      flex-direction:column;
	      align-items:flex-end;
	      gap:4px;
	    }
	    .report-qty .muted{ font-size:10px; }
	    .history-kv{ margin-top:10px; font-size:13px; }
	    .history-kv div{ margin-top:4px; }
	    .history-table{
	      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:14px;
    }
    .history-table th,
    .history-table td{ padding:8px; border-bottom:1px solid var(--border); }
    .history-table th{
      text-align:left;
      color:var(--muted);
      font-weight:700;
    }
    .history-table td.qty{
      text-align:right;
      font-variant-numeric:tabular-nums;
      font-weight:800;
    }
	    .drop{
	      border:1px dashed var(--border);border-radius:10px;padding:12px;text-align:center;color:var(--muted)
	    }
		    .totals{ display:flex; justify-content:center; align-items:center; gap:0; flex-wrap:wrap; margin:6px 0 4px; text-align:center; }
		    .totals > span{ white-space:nowrap; }
		    .totals > span + span::before{
		      content:'|';
		      display:inline-block;
		      margin:0 10px;
		      opacity:.65;
		    }
		    @media (max-width:520px){
		      .totals{ flex-wrap:nowrap; }
		      .totals > span{ font-size:11px; }
		      .totals > span + span::before{ margin:0 6px; }
		    }
		    @media (max-width:360px){
		      .totals > span{ font-size:10px; }
		      .totals > span + span::before{ margin:0 4px; }
		    }
    @media (max-width:640px){
      .toolbar{gap:6px}
      .toolbar .btn{flex:1}
      .scroll{max-height:calc(100vh - 240px)}
    }
    /* no right-side logo anymore */
    @media (max-width:360px){ .toolbar{gap:4px} }
  
    @media (max-width: 480px){
      header{ padding: calc(8px + env(safe-area-inset-top)) 12px 6px; }
      .header-inner{ padding: 0 12px; }
      .brandrow{ gap:8px }
      .title-logo{ height:36px }
      .modal{ padding:calc(10px + env(safe-area-inset-top)) 10px calc(10px + env(safe-area-inset-bottom)); }
      .order-header{ padding:12px; }
      .order-body{ padding:10px 12px 12px; }
      .order-footer{ padding:10px 12px calc(10px + env(safe-area-inset-bottom)); }
      .order-footer{ display:grid; grid-template-columns:1fr 1fr; }
      .order-footer .order-send{ grid-column:1 / -1; }
      .order-recipient{ flex-direction:column; align-items:stretch; }
      .order-recipient input[type=email]{ min-width:0; }
    }

    /* Hamburger Menu Styles */
    .hamburger-menu{
      position:relative;
      z-index:25;
    }
    .hamburger-btn{
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      width:44px;
      height:44px;
      padding:8px;
      border:1px solid var(--border);
      background:#101826;
      border-radius:10px;
      cursor:pointer;
      gap:5px;
    }
    .hamburger-btn:hover{
      background:#1a2636;
    }
    .hamburger-btn span{
      display:block;
      width:22px;
      height:2px;
      background:var(--fg);
      border-radius:2px;
      transition:transform 0.2s, opacity 0.2s;
    }
    .hamburger-btn.open span:nth-child(1){
      transform:translateY(7px) rotate(45deg);
    }
    .hamburger-btn.open span:nth-child(2){
      opacity:0;
    }
    .hamburger-btn.open span:nth-child(3){
      transform:translateY(-7px) rotate(-45deg);
    }
    .menu-dropdown{
      display:none;
      position:absolute;
      top:calc(100% + 8px);
      right:0;
      min-width:200px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:8px;
      box-shadow:0 10px 40px rgba(0,0,0,.5);
      z-index:30;
    }
    .menu-dropdown.open{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .menu-dropdown .menu-item{
      display:flex;
      align-items:center;
      gap:12px;
      width:100%;
      padding:12px 14px;
      border:none;
      background:transparent;
      color:var(--fg);
      font-size:15px;
      font-weight:600;
      text-align:left;
      border-radius:10px;
      cursor:pointer;
      transition:background 0.15s;
    }
    .menu-dropdown .menu-item:hover{
      background:#1a2636;
    }
    .menu-dropdown .menu-item .menu-icon-svg{
      flex-shrink:0;
      opacity:0.8;
    }
    .menu-divider{
      height:1px;
      background:var(--border);
      margin:4px 0;
    }
    .header-row{
      display:grid;
      grid-template-columns:auto minmax(0, 1fr) auto;
      align-items:center;
      gap:12px;
    }
    .header-right{
      grid-column:3;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
    }
    .header-left{
      grid-column:1;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      gap:12px;
      min-width:0;
    }
    /* Main app order pill - positioned below totals, sticky */
    .order-pill-container{
      position:sticky;
      top:0;
      z-index:15;
      display:flex;
      justify-content:center;
      padding:10px 0;
      background:linear-gradient(to bottom, var(--bg) 60%, transparent 100%);
    }
    .order-pill{
      width:75%;
      max-width:400px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background:rgba(34,197,94,0.18);
      border:1px solid rgba(34,197,94,0.55);
      color:#fff;
      font-weight:600;
      padding:12px 20px;
      border-radius:14px;
      cursor:pointer;
      box-shadow: 0 0 0 1px rgba(34,197,94,0.12), 0 10px 24px rgba(0,0,0,0.35);
      -webkit-backdrop-filter: blur(10px);
      backdrop-filter: blur(10px);
      transition: transform 150ms ease, box-shadow 150ms ease;
      -webkit-tap-highlight-color: transparent;
      animation: orderPillIn 220ms ease;
    }
    @keyframes orderPillIn{
      from{ opacity:0; transform:translateY(-8px); }
      to{ opacity:1; transform:translateY(0); }
    }
    .order-pill:active{
      transform: scale(0.97);
    }
    .order-pill-value{
      font-size:20px;
      font-weight:700;
    }
    .order-pill-label{
      font-size:15px;
      font-weight:600;
    }
    .order-pill-hint{
      font-size:11px;
      opacity:0.8;
      text-transform:uppercase;
      letter-spacing:0.3px;
      margin-left:auto;
    }
    .menu-backdrop{
      display:none;
      position:fixed;
      inset:0;
      z-index:22;
    }
    .menu-backdrop.open{
      display:block;
    }
    /* Profile dropdown */
    .profile-menu{
      position:relative;
    }
    .profile-btn{
      background:none;border:none;cursor:pointer;padding:8px;
      color:var(--muted);display:flex;align-items:center;gap:6px;
      border-radius:50%;transition:background 0.15s;position:relative;
    }
    .profile-btn:hover{background:rgba(255,255,255,0.08)}
    .profile-status{
      position:absolute;bottom:6px;right:6px;width:10px;height:10px;
      border-radius:50%;border:2px solid var(--bg);
      background:#6b7280;
    }
    .profile-status.online{background:#22c55e}
    .profile-status.offline{background:#ef4444}
    .profile-status.warning{background:#f59e0b}
    .profile-dropdown{
      position:absolute;top:100%;right:0;margin-top:8px;
      background:#1a1f26;border:1px solid var(--border);border-radius:12px;
      min-width:220px;padding:8px 0;z-index:30;
      box-shadow:0 10px 40px rgba(0,0,0,0.4);
      display:none;
    }
    .profile-dropdown.open{display:block}
    .profile-info{padding:12px 16px}
    .profile-email{font-weight:600;font-size:14px;color:var(--fg);margin-bottom:4px;word-break:break-all}
    .profile-connection{font-size:12px;color:var(--muted)}
    .profile-dropdown .menu-item{
      display:flex;align-items:center;gap:10px;width:100%;
      padding:12px 16px;border:none;background:transparent;
      color:var(--fg);font-size:14px;font-weight:500;
      text-align:left;cursor:pointer;transition:background 0.15s;
    }
    .profile-dropdown .menu-item:hover{background:rgba(255,255,255,0.06)}
    .profile-meta{padding:10px 16px;border-top:1px solid var(--border);margin-top:8px}
    .profile-meta .time{font-size:11px;color:var(--muted)}
    .menu-icon-svg{flex-shrink:0}
</style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="header-row">
        <div class="header-left">
          <div class="brandtext">
            <img class="title-logo" src="./assets/oakley/logo/oakley-logo-horizontal-h128.png" alt="Oakley Services" />
          </div>
        </div>
        <div class="header-right">
        <div class="profile-menu">
          <button class="profile-btn" id="profileBtn" aria-label="Account menu" aria-expanded="false">
            <span class="profile-status" id="profileStatus"></span>
            <svg class="profile-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          </button>
          <div class="profile-dropdown" id="profileDropdown">
            <div class="profile-info" id="profileInfo">
              <div class="profile-email" id="profileEmail">Not signed in</div>
              <div class="profile-connection" id="profileConnection">Offline</div>
            </div>
            <div class="menu-divider"></div>
            <button class="menu-item" id="openProfileSettings">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
              <span>Profile Settings</span>
            </button>
            <button class="menu-item" id="profileSignIn">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
              <span id="profileSignInText">Sign Out</span>
            </button>
            <div class="profile-meta">
              <span class="time" id="lastUpdate" aria-live="polite"></span>
            </div>
          </div>
        </div>
        <div class="hamburger-menu">
          <button class="hamburger-btn" id="hamburgerBtn" aria-label="Open menu" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <nav class="menu-dropdown" id="menuDropdown" role="menu">
            <button class="menu-item" id="menuImport" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
              Import File
            </button>
            <button class="menu-item" id="menuPaste" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></svg>
              Paste Data
            </button>
	            <button class="menu-item" id="menuExport" role="menuitem">
	              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
	              Export File
	            </button>
	            <button class="menu-item" id="menuReport" role="menuitem">
	              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
	              Create Inventory Report
	            </button>
	            <div class="menu-divider"></div>
	            <button class="menu-item" id="menuAddOne" role="menuitem">
	              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
	              Add Item
            </button>
            <button class="menu-item" id="menuOrder" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
              Create Order
            </button>
            <button class="menu-item" id="menuHistory" role="menuitem">
              <svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
              Order History
            </button>
          </nav>
        </div>
        </div>
      </div>
      <div id="menuBackdrop" class="menu-backdrop"></div>
    </div>
  </header>

  <main>
    <section class="card">
	      <div class="toolbar" role="toolbar" aria-label="Inventory actions" style="justify-content:center;">
	        <input type="file" id="fileImport" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" style="display:none" />
	        <div class="inv-controls">
	          <div class="input-wrap">
	            <input id="filterBox" type="text" placeholder="Filter items…" aria-label="Filter items" />
	            <button class="clear-input-btn" id="btnClearFilter" type="button" aria-label="Clear filter" title="Clear filter" style="display:none">
	              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	                <path d="M18 6L6 18"></path>
	                <path d="M6 6l12 12"></path>
	              </svg>
	            </button>
	          </div>
	          <div class="sort-wrap" id="mobileSortWrap">
	            <select id="mobileSort" aria-label="Sort items">
	              <option value="name:asc">Item (A–Z)</option>
	              <option value="name:desc">Item (Z–A)</option>
	              <option value="desc:asc">Description (A–Z)</option>
	              <option value="desc:desc">Description (Z–A)</option>
	              <option value="qty:asc">Qty (Low–High)</option>
	              <option value="qty:desc">Qty (High–Low)</option>
	              <option value="updatedAt:desc">Last Modified (Newest)</option>
	              <option value="updatedAt:asc">Last Modified (Oldest)</option>
	            </select>
	          </div>
	        </div>
	      </div>

	      <div class="totals" aria-live="polite">
	        <span id="totalItems" class="muted">Total Items: 0</span>
	        <span id="totalInStock" class="muted">In Stock: 0</span>
	        <span id="totalLowStock" class="muted">Low Stock: 0</span>
	        <span id="totalQty" class="muted">Total Qty: 0</span>
	      </div>

	      <div class="order-pill-container" id="orderPillContainer" style="display:none;">
	        <button class="order-pill" id="orderPill" data-order-reset aria-label="Shopping Cart (tap to clear selected items)">
	          <span class="order-pill-value" id="orderPillValue">0</span>
	          <span class="order-pill-label">Items in Cart</span>
	          <span class="order-pill-hint">tap to clear</span>
	        </button>
	      </div>

	      <div class="scroll" id="tableWrap">
	        <table id="invTable" role="grid" aria-label="Inventory table">
		          <colgroup>
		            <col style="width:42px">
		            <col id="col-name">
		            <col id="col-desc">
		            <col style="width:150px">
		            <col style="width:112px">
		          </colgroup>
          <thead>
            <tr>
              <th class="sel"><input type="checkbox" id="chkAll" aria-label="Select all"></th>
              <th scope="col" class="sortable" data-col="name" aria-sort="ascending">Item <span class="sort-ind"></span></th>
              <th scope="col" class="sortable" data-col="desc">Description <span class="sort-ind"></span></th>
              <th scope="col" class="qty sortable" data-col="qty">Qty <span class="sort-ind"></span></th>
              <th scope="col" class="actions"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="muted" style="margin-top:8px">
        <span id="editHint">Tap any cell to edit inline; <kbd>Enter</kbd> saves, <kbd>Esc</kbd> cancels.</span>
      </div>
    </section>
  </main>

  <!-- Paste/Import modal -->
  <div id="pasteModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Paste Data</h2>
      <div class="muted" style="margin-bottom:10px;">
        Provide columns <code>Item, Description, Qty</code>. Headers optional; Qty optional (defaults to 0).
        Tabs, commas, or multi-space columns are accepted. You may also drop or choose a file.
      </div>
      <div class="drop" id="dropZone">Drop a CSV/TSV/TXT/JSON/XLSX/XLS/DOCX/PDF file here, or choose below.</div>
      <input type="file" id="fileImportModal" accept=".csv,.tsv,.txt,.json,.xlsx,.xls,.docx,.doc,.pdf" style="display:block;margin:10px 0;" />
      <textarea id="pasteArea" rows="8" placeholder="Item, Description, Qty"></textarea>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <span id="pasteInfo" class="muted" style="margin-right:auto"></span>
        <button class="btn" id="btnPasteCancel">Cancel</button>
        <button class="btn primary" id="btnPasteApply">Import</button>
      </div>
    </div>
  </div>

  <!-- Add-one modal -->
  <div id="addOneModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Add Item</h2>
      <div style="display:grid; grid-template-columns:1fr; gap:8px;">
        <label class="muted">Item (unique)</label>
        <input id="addName" type="text" placeholder="Item" autocapitalize="off" autocomplete="off" spellcheck="false" />
        <label class="muted">Description (optional)</label>
        <input id="addDesc" type="text" placeholder="Description" />
        <label class="muted">Qty (integer > 0)</label>
        <input id="addQty" type="number" min="1" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" />
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnAddCancel">Cancel</button>
        <button class="btn primary" id="btnAddSave">Add</button>
      </div>
    </div>
  </div>

  <!-- Mobile-friendly cell edit modal -->
  <div id="editItemModal" class="modal" aria-hidden="true">
    <div class="box edit-box">
      <div class="edit-header">
        <h2 id="editItemTitle">Edit Item</h2>
        <div class="edit-sub" id="editItemSub"></div>
      </div>
      <div class="edit-body">
        <div style="display:grid; grid-template-columns:1fr; gap:10px;">
          <div>
            <label class="muted" for="editItemName">Item</label>
            <input id="editItemName" type="text" placeholder="Item" autocapitalize="off" autocomplete="off" spellcheck="false" />
          </div>
          <div>
            <label class="muted" for="editItemDesc">Description</label>
            <textarea id="editItemDesc" rows="6" placeholder="Description" autocapitalize="off" autocomplete="off" spellcheck="false"></textarea>
          </div>
          <div>
            <label class="muted" for="editItemQty">Qty</label>
            <div class="qty-stepper qty-stepper--modal">
              <button class="qty-step" id="editItemQtyMinus" type="button" aria-label="Decrease qty">−</button>
              <input id="editItemQty" type="number" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" />
              <button class="qty-step" id="editItemQtyPlus" type="button" aria-label="Increase qty">+</button>
            </div>
            <div class="muted" style="margin-top:6px;">Tap +/- for small changes, or type a number.</div>
          </div>
        </div>
        <div id="editItemMsg" class="muted" style="margin-top:10px;"></div>
	      </div>
	      <div class="edit-footer">
	        <button class="btn danger" id="btnEditItemDelete">Delete</button>
	        <button class="btn" id="btnEditItemCancel">Close</button>
	      </div>
	    </div>
	  </div>

  <!-- Low stock modal -->
  <div id="lowStockModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Low Stock</h2>
      <div id="lowStockItemLabel" class="muted" style="margin-bottom:8px;"></div>
	      <div id="lowStockCurrentLabel" class="muted"></div>
	      <div id="lowStockGlobalLabel" class="muted" style="margin-bottom:10px;"></div>
	      <div class="qty-stepper qty-stepper--modal" aria-label="Low stock qty controls">
	        <button class="qty-step" id="lowStockMinus" type="button" aria-label="Decrease low stock">−</button>
	        <input id="lowStockValue" type="number" min="0" step="1" pattern="[0-9]*" inputmode="numeric" enterkeyhint="done" />
	        <button class="qty-step" id="lowStockPlus" type="button" aria-label="Increase low stock">+</button>
	      </div>
	      <label style="display:flex;align-items:center;gap:10px;margin-top:10px;">
	        <input id="lowStockReorderEnabled" type="checkbox" />
	        <span class="muted" style="font-size:13px;">Include in reorder suggestions</span>
	      </label>
	      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
	        <button class="btn" id="btnLowStockUseGlobal" type="button">Use Global</button>
	        <button class="btn" id="btnLowStockCancel" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Message modal -->
  <div id="msgModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 id="msgTitle" style="margin:0 0 10px;font-size:16px;">Message</h2>
      <div id="msgBody" class="muted" style="white-space:pre-wrap;"></div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnMsgCopy" type="button" style="display:none">Copy</button>
        <button class="btn primary" id="btnMsgOk" type="button">OK</button>
      </div>
    </div>
  </div>
	
  <!-- Confirm modal -->
  <div id="confirmModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 id="confirmTitle" style="margin:0 0 10px;font-size:16px;">Confirm</h2>
      <div id="confirmBody" class="muted" style="white-space:pre-wrap;"></div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnConfirmCancel" type="button">Cancel</button>
        <button class="btn primary" id="btnConfirmOk" type="button">OK</button>
      </div>
    </div>
  </div>

  <!-- Import preview -->
  <div id="previewModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Import Preview</h2>
      <div class="muted" id="previewInfo" style="margin-bottom:10px"></div>
      <div class="scroll" style="max-height:50vh">
        <table style="width:100%;border-collapse:collapse;font-size:14px">
          <thead>
            <tr>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Item</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Description</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">Old Qty</th>
              <th style="text-align:right;padding:8px;border-bottom:1px solid var(--border)">New Qty</th>
              <th style="text-align:left;padding:8px;border-bottom:1px solid var(--border)">Action</th>
            </tr>
          </thead>
          <tbody id="previewBody"></tbody>
        </table>
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnPreviewCancel">Cancel</button>
        <button class="btn primary" id="btnPreviewApply">Apply Import</button>
      </div>
    </div>
  </div>

  <!-- Order modal -->
  <div id="orderModal" class="modal" aria-hidden="true">
    <div class="box order-box">
      <div class="order-header">
        <h2>Create Order</h2>
      </div>

      <div class="order-body">
	        <div class="section">
	          <div class="section-title"><span>Materials</span></div>
	          <div class="input-wrap" style="max-width:100%;">
	            <input id="orderSearch" type="text" placeholder="Search inventory to add items…" autocomplete="off" />
	            <button class="clear-input-btn" id="btnClearOrderSearch" type="button" aria-label="Clear search" title="Clear search" style="display:none">
	              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	                <path d="M18 6L6 18"></path>
	                <path d="M6 6l12 12"></path>
	              </svg>
	            </button>
	          </div>
	          <div id="orderResultsBody" class="order-list" style="margin-top:10px;"></div>
	        </div>

        <div class="section">
          <div class="section-title">
            <span>Order List</span>
            <span id="orderLinesInfo"></span>
            <button type="button" id="btnResetOrderList" class="btn-icon-inline" aria-label="Reset order list" title="Reset order list">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
              </svg>
            </button>
          </div>
          <div id="orderLinesBody" class="order-list"></div>
        </div>

        <div class="section">
          <div class="section-title"><span>Order Fulfillment - Email Address</span></div>
          <input id="orderEmail" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />
          <div id="orderEmailSuggest" class="order-suggest" aria-label="Email suggestions"></div>
        </div>

        <div class="section">
          <div class="section-title"><span>Message</span></div>
          <div style="display:grid; grid-template-columns:1fr; gap:10px;">
		            <div>
		              <div class="muted" style="margin-bottom:6px;">Subject</div>
		              <input id="orderSubject" type="text" placeholder="Order for Oakley Services, LLC (City/State)" />
		            </div>
            <div>
              <div class="muted" style="margin-bottom:6px;">Notes (optional)</div>
              <textarea id="orderNotes" rows="3" placeholder="Any notes…"></textarea>
            </div>
            <div class="order-preview">
              <div class="muted" style="margin-bottom:6px;">Email Preview</div>
              <div id="orderPreviewHtml" class="order-preview-html"></div>
            </div>
          </div>
        </div>
      </div>

	      <div class="order-footer">
	        <button class="btn" id="btnOrderCancel">Close</button>
	        <button class="btn" id="btnOrderCopy">Copy</button>
	        <button class="btn primary order-send" id="btnOrderSubmit">Submit Order</button>
	      </div>
	    </div>
	  </div>

  <!-- iOS-style qty picker -->
  <div id="qtyPickerModal" class="modal qty-picker-modal" aria-hidden="true">
    <div class="qty-picker-backdrop"></div>
    <div class="qty-picker-sheet">
      <div class="qty-picker-header">
        <button type="button" class="qty-picker-cancel" id="qtyPickerCancel">Cancel</button>
        <div class="qty-picker-title" id="qtyPickerTitle">Order Qty</div>
        <button type="button" class="qty-picker-done" id="qtyPickerDone">Done</button>
      </div>
      <div class="qty-picker-wheel-wrap">
        <div class="qty-picker-highlight"></div>
        <div class="qty-picker-wheel" id="qtyPickerWheel"></div>
      </div>
    </div>
  </div>

	  <!-- Order history -->
		  <div id="orderHistoryModal" class="modal" aria-hidden="true">
		    <div class="box">
	      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
	        <h2 style="margin:0;font-size:16px;">Order History</h2>
	        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
	          <button class="btn btn-icon" id="btnOrderHistoryDownload" type="button" title="Download CSV" aria-label="Download order history CSV">
	            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
	              <polyline points="7 10 12 15 17 10"></polyline>
	              <line x1="12" y1="15" x2="12" y2="3"></line>
	            </svg>
	          </button>
	          <button class="btn" id="btnOrderHistoryRefresh" type="button">Refresh</button>
	          <button class="btn" id="btnOrderHistoryClose" type="button">Close</button>
	        </div>
	      </div>
	      <div class="input-wrap" style="max-width:100%; margin-top:10px;">
	        <input id="orderHistoryFilter" type="text" placeholder="Filter history…" autocomplete="off" />
	        <button class="clear-input-btn" id="btnClearOrderHistoryFilter" type="button" aria-label="Clear history filter" title="Clear filter" style="display:none">
	          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	            <path d="M18 6L6 18"></path>
	            <path d="M6 6l12 12"></path>
	          </svg>
	        </button>
	      </div>
		      <div id="orderHistoryList" class="history-list" aria-live="polite"></div>
		    </div>
		  </div>

		  <!-- Inventory report -->
		  <div id="reportModal" class="modal" aria-hidden="true">
		    <div class="box">
		      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
		        <h2 style="margin:0;font-size:16px;">Inventory Report</h2>
	        <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;">
	          <button class="btn btn-icon" id="btnReportShare" type="button" title="Share report" aria-label="Share report">
	            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	              <path d="M4 12v7a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-7"></path>
	              <polyline points="16 6 12 2 8 6"></polyline>
	              <line x1="12" y1="2" x2="12" y2="15"></line>
	            </svg>
	          </button>
	          <button class="btn btn-icon" id="btnReportDownload" type="button" title="Download CSV" aria-label="Download report CSV">
	            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
	              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
	              <polyline points="7 10 12 15 17 10"></polyline>
	              <line x1="12" y1="15" x2="12" y2="3"></line>
	            </svg>
	          </button>
	          <button class="btn" id="btnReportClose" type="button">Close</button>
	        </div>
	      </div>

			      <div class="report-progress" id="reportProgress" style="display:none;" aria-live="polite">
			        <div class="report-progress-label">
			          <span id="reportProgressLabel">Analyzing Low Stock Items...</span>
			          <span class="report-progress-value" id="reportProgressValue">0%</span>
			        </div>
			        <div class="report-progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
			          <div class="report-progress-bar" id="reportProgressBar" style="width:0%"></div>
			        </div>
			      </div>

			      <div id="reportContent" style="display:none;">
				      <div class="report-metrics" aria-label="Report summary">
				        <div class="report-metric"><div class="muted">Total Items</div><div class="val" id="reportMetricTotalItems">0</div></div>
				        <div class="report-metric"><div class="muted">Total Qty</div><div class="val" id="reportMetricTotalQty">0</div></div>
				      </div>

				      <div class="order-pill-container report-pill-container" id="reportOrderPillContainer" style="display:none;">
				        <button class="order-pill" id="reportOrderBadge" data-order-reset role="status" aria-live="polite" aria-label="Clear shopping cart selections">
				          <span class="order-pill-value" id="reportOrderCount">0</span>
				          <span class="order-pill-label">Items in Cart</span>
				          <span class="order-pill-hint">tap to clear</span>
				        </button>
				      </div>
		
				      <details class="report-section" id="reportLowStockSection">
				        <summary class="report-summary">
				          <div class="report-summary-left">
				            <h3><span class="led-dot led-dot--amber"></span>Low Stock Items <span class="report-count" id="reportLowStockCount">(0)</span></h3>
				          </div>
				          <div class="report-summary-right">
				            <span class="report-chevron" aria-hidden="true">▾</span>
				          </div>
				        </summary>
				        <div class="report-list" id="reportLowStockList"></div>
				      </details>

				      <details class="report-section" id="reportInventorySection">
				        <summary class="report-summary">
				          <div class="report-summary-left">
				            <h3>Current Inventory <span class="report-count" id="reportInStockCount">(0)</span></h3>
				          </div>
				          <div class="report-summary-right">
				            <span class="report-chevron" aria-hidden="true">▾</span>
				          </div>
				        </summary>
				        <div class="report-list" id="reportList" aria-live="polite"></div>
				      </details>
			      </div>
			    </div>
			  </div>

		  <!-- Email inventory report -->
		  <div id="reportEmailModal" class="modal" aria-hidden="true">
		    <div class="box">
		      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
		        <h2 style="margin:0;font-size:16px;">Email Inventory Report</h2>
		        <button class="btn" id="btnReportEmailClose" type="button">Close</button>
		      </div>
		      <div style="display:grid; grid-template-columns:1fr; gap:8px; margin-top:10px;">
		        <label class="muted">To</label>
		        <input id="reportEmailTo" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />
		        <label class="muted">Subject</label>
		        <input id="reportEmailSubject" type="text" placeholder="Inventory Report" />
		      </div>
		      <div class="order-preview" style="margin-top:12px;">
		        <div class="muted" style="margin-bottom:6px;">Email Preview</div>
		        <div id="reportEmailPreview" class="order-preview-html"></div>
		      </div>
		      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
		        <div id="reportEmailMsg" class="muted" style="margin-right:auto;"></div>
		        <button class="btn" id="btnReportEmailCopy" type="button">Copy</button>
		        <button class="btn primary" id="btnReportEmailSend" type="button">Send</button>
		      </div>
		    </div>
		  </div>

		  <!-- Auth modal -->
		  <div id="authModal" class="modal" aria-hidden="true">
		    <div class="box">
	      <h2 style="margin:0 0 10px;font-size:16px;">Sign In</h2>
      <div style="display:grid; grid-template-columns:1fr; gap:8px;">
        <label class="muted">Email</label>
        <input id="authEmail" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email" />
        <label class="muted" id="authPasswordLabel">Password</label>
        <input id="authPassword" type="password" placeholder="Password" autocomplete="current-password" />
      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnAuthMagic">Send Magic Link</button>
        <button class="btn" id="btnAuthToggleMode">Create Account</button>
        <button class="btn primary" id="btnAuthSubmit">Sign In</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- Profile modal -->
  <div id="profileModal" class="modal" aria-hidden="true">
    <div class="box">
      <h2 style="margin:0 0 10px;font-size:16px;">Account</h2>
      <div class="muted" id="profileEmailDisplay" style="margin-bottom:10px;"></div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <div>
          <label class="muted">First Name</label>
          <input id="profileFirstName" type="text" placeholder="First" autocomplete="given-name" />
        </div>
        <div>
          <label class="muted">Last Name</label>
          <input id="profileLastName" type="text" placeholder="Last" autocomplete="family-name" />
        </div>
      </div>
	      <div style="display:grid; grid-template-columns:1fr; gap:8px; margin-top:8px;">
	        <label class="muted">Phone</label>
	        <input id="profilePhone" type="tel" placeholder="(555) 555-5555" autocomplete="tel" inputmode="tel" />
	        <label class="muted">Shipping Address</label>
	        <textarea id="profileDeliveryAddress" rows="3" placeholder="123 Main St&#10;City, ST 12345"></textarea>
	        <label class="muted">Global Low Stock Qty</label>
	        <input id="profileLowStockQtyGlobal" type="number" min="0" step="1" inputmode="numeric" placeholder="0" />
	        <div style="display:flex;align-items:center;gap:12px;margin-top:8px;">
	          <label class="toggle-switch">
	            <input id="profileSilenceLowStockAlerts" type="checkbox" />
	            <span class="toggle-slider"></span>
	          </label>
	          <label for="profileSilenceLowStockAlerts" class="muted" style="font-size:13px;cursor:pointer;">Hide low stock LED indicators</label>
	        </div>
	      </div>
      <div class="toolbar" style="margin-top:10px;justify-content:flex-end;">
        <button class="btn" id="btnSignOut">Sign Out</button>
        <button class="btn" id="btnProfileClose">Close</button>
      </div>
      <div id="profileMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

	  <div class="toast" id="toast" role="status" aria-live="polite"></div>

		  <script>
		    // UUID helper (works on older mobile browsers and non-HTTPS dev hosts)
		    let _nativeRandomUUID = null;
		    try{
		      if(typeof crypto !== 'undefined' && crypto && typeof crypto.randomUUID === 'function'){
		        const candidate = crypto.randomUUID.bind(crypto);
		        candidate(); // ensure it works (some browsers expose but throw on insecure contexts)
		        _nativeRandomUUID = candidate;
		      }
		    }catch(e){
		      _nativeRandomUUID = null;
		    }
		    function randomUUID(){
		      if(_nativeRandomUUID){
		        try{ return _nativeRandomUUID(); }catch(e){}
		      }
		      const cryptoObj = (typeof crypto !== 'undefined') ? crypto : null;
		      const bytes = new Uint8Array(16);
		      if(cryptoObj && typeof cryptoObj.getRandomValues === 'function'){
		        try{
		          cryptoObj.getRandomValues(bytes);
		        }catch(e){
		          for(let i=0;i<bytes.length;i++) bytes[i] = Math.floor(Math.random()*256);
		        }
		      }else{
		        for(let i=0;i<bytes.length;i++) bytes[i] = Math.floor(Math.random()*256);
		      }
		      // RFC4122 v4
		      bytes[6] = (bytes[6] & 0x0f) | 0x40;
		      bytes[8] = (bytes[8] & 0x3f) | 0x80;
		      const hex = Array.from(bytes, b => b.toString(16).padStart(2,'0'));
		      return `${hex[0]}${hex[1]}${hex[2]}${hex[3]}-${hex[4]}${hex[5]}-${hex[6]}${hex[7]}-${hex[8]}${hex[9]}-${hex[10]}${hex[11]}${hex[12]}${hex[13]}${hex[14]}${hex[15]}`;
		    }
		    if(!_nativeRandomUUID){
		      try{
		        const cryptoObj = (typeof crypto !== 'undefined') ? crypto : null;
		        if(cryptoObj) cryptoObj.randomUUID = randomUUID;
		      }catch(e){}
		      try{
		        if(typeof Crypto !== 'undefined' && Crypto.prototype){
		          Object.defineProperty(Crypto.prototype, 'randomUUID', { value: randomUUID, configurable: true, writable: true });
		        }
		      }catch(e){}
		    }

	    // ========================
	    // State & persistence
	    // ========================
    const DB_KEY='inv.single.inline.mobile.v1';
	    const state={items:[], updatedAt:null, _filter:'', _sort:{col:'name', dir:'asc'}, _order:{lines:[], email:'', subject:'', notes:'', contactName:'', search:''}};
    const APP_VERSION = '2.0.0';

    const $ = (id) => document.getElementById(String(id).replace(/^#/, ''));
    const toKey=s=>(s||'').trim().toUpperCase();
    function toInt(v,f=0){const n=Number(v); if(!Number.isFinite(n))return f; const i=Math.floor(n); return i<0?f:i;}
    function setUpdated(){ state.updatedAt=new Date().toISOString(); }
    // Persist only UI prefs; never persist items
    function save(){ const prefs={updatedAt:state.updatedAt,_filter:state._filter,_sort:state._sort}; localStorage.setItem(DB_KEY, JSON.stringify(prefs)); render(); }
    function load(){ const raw=localStorage.getItem(DB_KEY); if(raw){ try{ const p=JSON.parse(raw); if(p){ if(typeof p._filter==='string') state._filter=p._filter; if(p._sort && typeof p._sort.col==='string'){ state._sort={ col:p._sort.col, dir:(p._sort.dir==='desc'?'desc':'asc') }; } if(p.updatedAt) state.updatedAt=p.updatedAt; } } catch(e){} } }



    function dedupe(){
      const seen=new Set();
      state.items=state.items.filter(it=>{
        const k=toKey(it.name); if(!k) return false;
        if(seen.has(k)) return false;
        seen.add(k);
        if(!it.id) it.id=randomUUID();
        it.qty = toInt(it.qty,0);
        return true;
      });
    }

    // Shallow clone of items for optimistic-UI rollback
    function snapshotItems(){ return state.items.map(it => ({...it})); }

    // ========================
    // Supabase (cloud sync) — optional
    // ========================
	    const SB = { client:null, ready:false, connected:false, session:null, user:null, authorized:false, profile:null, itemsHasLowStockQty:null, itemsHasReorderEnabled:null, warnedLowStockSchema:false, warnedReorderSchema:false };
    function sbInit(){
      const url = window.SB_URL, key = window.SB_ANON;
      if(!url || !key || SB.client){ return; }
      try{
        if(!window.supabase || typeof window.supabase.createClient !== 'function'){
          console.warn('Supabase library not loaded; running in offline mode');
          SB.ready = false;
          return;
        }
        SB.client = window.supabase.createClient(url, key);
        SB.ready = true;
      }catch(err){
        console.warn('Supabase init failed:', err);
        SB.ready = false;
      }
    }
    function updateStatusBar(){
      // Update profile dropdown UI
      const statusEl = $('profileStatus');
      const emailEl = $('profileEmail');
      const connEl = $('profileConnection');
      const signInText = $('profileSignInText');
      const signInBtn = $('profileSignIn');

      // Icon SVGs
      const signInIcon = '<svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>';
      const signOutIcon = '<svg class="menu-icon-svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>';

      function setSignInUI(text, icon){
        if(signInText) signInText.textContent = text;
        if(signInBtn){
          const svg = signInBtn.querySelector('svg');
          if(svg) svg.outerHTML = icon;
        }
      }

      if(statusEl) statusEl.classList.remove('online','offline','warning');

      if(!SB.ready){
        if(emailEl) emailEl.textContent = 'Not configured';
        if(connEl) connEl.textContent = 'Supabase not set up';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Configure', signInIcon);
        return;
      }
      if(!SB.session){
        if(emailEl) emailEl.textContent = 'Not signed in';
        if(connEl) connEl.textContent = 'Sign in required';
        if(statusEl) statusEl.classList.add('offline');
        setSignInUI('Sign In', signInIcon);
        return;
      }

      // Show user email
      const userEmail = SB.session?.user?.email || 'Unknown user';
      if(emailEl) emailEl.textContent = userEmail;

      if(!SB.authorized){
        if(connEl) connEl.textContent = 'Not authorized';
        if(statusEl) statusEl.classList.add('warning');
        setSignInUI('Sign Out', signOutIcon);
        return;
      }
      if(SB.connected){
        if(connEl) connEl.textContent = 'Connected';
        if(statusEl) statusEl.classList.add('online');
      }else{
        if(connEl) connEl.textContent = 'Offline';
        if(statusEl) statusEl.classList.add('offline');
      }
      setSignInUI('Sign Out', signOutIcon);
    }
    function explainGate(){
      if(!SB.ready) return 'Supabase not configured';
      if(!SB.session) return 'Sign in required';
      if(!SB.authorized) return 'Not authorized';
      if(!SB.connected) return 'Offline – edits disabled';
      return '';
    }
    async function checkServerHealth(){
      if(!SB.ready || !SB.session || !SB.authorized){ SB.connected=false; updateStatusBar(); return false; }
      try{
        const { error } = await SB.client
          .from('items')
          .select('id', { head:true, count:'exact' })
          .limit(1);
        if(error) throw error;
        SB.connected = true;
      }catch(e){ SB.connected=false; }
      updateStatusBar();
      return SB.connected;
    }
    function isOnline(){ return SB.ready && !!SB.session && SB.authorized && SB.connected; }
    function requireOnline(){
      if(isOnline()) return true;
      const msg = explainGate();
      if(msg) toast(msg);
      if(!SB.session) show('authModal', true);
      return false;
    }

    // ---------- Auth + profile ----------
    let AUTH_MODE = 'signin'; // or 'signup'
    function renderAuthUi(){
      const submit = $('btnAuthSubmit');
      const toggle = $('btnAuthToggleMode');
      const pw = $('authPassword');
      const pwLabel = $('authPasswordLabel');
      if(submit) submit.textContent = (AUTH_MODE === 'signup') ? 'Create Account' : 'Sign In';
      if(toggle) toggle.textContent = (AUTH_MODE === 'signup') ? 'Have Account? Sign In' : 'Create Account';
      if(pw) pw.autocomplete = (AUTH_MODE === 'signup') ? 'new-password' : 'current-password';
      if(pwLabel) pwLabel.textContent = 'Password';
    }
    function setAuthMessage(msg){
      const el = $('authMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function setProfileMessage(msg){
      const el = $('profileMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
	    // Auto-format phone number as (XXX) XXX-XXXX
	    function formatPhoneNumber(value){
	      let digits = String(value || '').replace(/\D/g, '');
	      // iOS often pastes US numbers as 1XXXXXXXXXX — drop the leading country code
	      while(digits.length > 10 && digits.startsWith('1')) digits = digits.slice(1);
	      digits = digits.slice(0, 10);
	      if(digits.length === 0) return '';
	      if(digits.length <= 3) return `(${digits}`;
	      if(digits.length <= 6) return `(${digits.slice(0,3)}) ${digits.slice(3)}`;
	      return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
	    }

	    function renderProfileUi(){
	      const email = SB.user && SB.user.email ? String(SB.user.email) : '';
	      const elEmail = $('profileEmailDisplay'); if(elEmail) elEmail.textContent = email ? `Signed in: ${email}` : '';
	      const elFirstName = $('profileFirstName'); if(elFirstName) elFirstName.value = (SB.profile && SB.profile.first_name) ? String(SB.profile.first_name) : '';
	      const elLastName = $('profileLastName'); if(elLastName) elLastName.value = (SB.profile && SB.profile.last_name) ? String(SB.profile.last_name) : '';
	      const elPhone = $('profilePhone'); if(elPhone) elPhone.value = formatPhoneNumber((SB.profile && SB.profile.phone) ? String(SB.profile.phone) : '');
	      const elAddress = $('profileDeliveryAddress'); if(elAddress) elAddress.value = (SB.profile && SB.profile.delivery_address) ? String(SB.profile.delivery_address) : '';
	      const elLowGlobal = $('profileLowStockQtyGlobal'); if(elLowGlobal) elLowGlobal.value = String(getGlobalLowStockQty());
	      const elSilence = $('profileSilenceLowStockAlerts'); if(elSilence) elSilence.checked = lowStockAlertsSilenced();
	      const note = SB.session && !SB.authorized
	        ? 'This account is not authorized for this inventory yet. Ask an admin to add you in Supabase.'
	        : '';
	      setProfileMessage(note);
	    }
	    async function sbEnsureProfile(){
	      if(!SB.ready || !SB.user) return null;
	      try{
	        const { data, error } = await SB.client
	          .from('profiles')
	          .select('*')
	          .eq('user_id', SB.user.id)
	          .maybeSingle();
	        if(error) throw error;
	        if(data){
	          data.first_name = data.first_name || '';
	          data.last_name = data.last_name || '';
	          data.phone = data.phone || '';
	          data.delivery_address = data.delivery_address || '';
	          if(typeof data.silence_low_stock_alerts === 'undefined'){
	            data.silence_low_stock_alerts = lowStockAlertsSilenced();
	          }else{
	            data.silence_low_stock_alerts = !!data.silence_low_stock_alerts;
	          }
	          if(typeof data.low_stock_qty_global === 'undefined' || data.low_stock_qty_global === null){
	            data.low_stock_qty_global = getGlobalLowStockQty();
	          }else{
	            data.low_stock_qty_global = toInt(data.low_stock_qty_global, 0);
	          }
	          try{ localStorage.setItem('inv.pref.silenceLowStockAlerts', data.silence_low_stock_alerts ? '1' : '0'); }catch(e){}
	          try{ localStorage.setItem('inv.pref.lowStockQtyGlobal', String(toInt(data.low_stock_qty_global,0))); }catch(e){}
	          SB.profile = data;
	          return data;
	        }

	        const desiredSilence = lowStockAlertsSilenced();
	        const desiredGlobal = getGlobalLowStockQty();
	        const base = {
	          user_id: SB.user.id,
	          email: String(SB.user.email||'').trim(),
	          first_name: '',
	          last_name: '',
	          phone: '',
	        };
	        const address = '';
	        const attempts = [
	          { delivery:true, silence:true, global:true },
	          { delivery:true, silence:true, global:false },
	          { delivery:true, silence:false, global:true },
	          { delivery:true, silence:false, global:false },
	          { delivery:false, silence:true, global:true },
	          { delivery:false, silence:true, global:false },
	          { delivery:false, silence:false, global:true },
	          { delivery:false, silence:false, global:false },
	        ];
	        let lastError = null;
	        for(const a of attempts){
	          const row = { ...base };
	          if(a.delivery) row.delivery_address = address;
	          if(a.silence) row.silence_low_stock_alerts = desiredSilence;
	          if(a.global) row.low_stock_qty_global = desiredGlobal;
	          const res = await SB.client.from('profiles').insert([row]);
	          if(!res.error){
	            SB.profile = { ...row };
	            if(!a.delivery) SB.profile.delivery_address = '';
	            SB.profile.silence_low_stock_alerts = desiredSilence;
	            SB.profile.low_stock_qty_global = desiredGlobal;
	            return SB.profile;
	        }
	        lastError = res.error;
	        const msg = errToText(res.error);
	        if(!(msg.includes('delivery_address') || msg.includes('silence_low_stock_alerts') || msg.includes('low_stock_qty_global'))){
	          break;
	        }
	        }
	        if(lastError) throw lastError;
	        throw Error('Profile create failed');
	      }catch(e){
	        console.warn('Profile ensure failed:', e);
	        SB.profile = {
	          user_id: SB.user.id,
	          email: String(SB.user.email||'').trim(),
	          first_name: '',
	          last_name: '',
	          phone: '',
	          delivery_address: '',
	          silence_low_stock_alerts: lowStockAlertsSilenced(),
	          low_stock_qty_global: getGlobalLowStockQty(),
	        };
	        return SB.profile;
	      }
	    }
    async function sbSaveProfile(firstName, lastName, phone, deliveryAddress, silenceLowStockAlerts, lowStockQtyGlobal){
      if(!SB.ready || !SB.user) throw Error('Not signed in');
      const desiredSilence = !!silenceLowStockAlerts;
      const desiredGlobal = toInt(lowStockQtyGlobal, -1);
      if(desiredGlobal < 0) throw Error('Global low stock qty must be integer ≥ 0');
      try{ localStorage.setItem('inv.pref.silenceLowStockAlerts', desiredSilence ? '1' : '0'); }catch(e){}
      try{ localStorage.setItem('inv.pref.lowStockQtyGlobal', String(desiredGlobal)); }catch(e){}

      const base = {
        user_id: SB.user.id,
        email: String(SB.user.email||'').trim(),
        first_name: String(firstName||'').trim(),
        last_name: String(lastName||'').trim(),
        phone: String(phone||'').trim(),
      };
      const address = String(deliveryAddress||'').trim();

      const attempts = [
        { delivery:true, silence:true, global:true },
        { delivery:true, silence:true, global:false },
        { delivery:true, silence:false, global:true },
        { delivery:true, silence:false, global:false },
        { delivery:false, silence:true, global:true },
        { delivery:false, silence:true, global:false },
        { delivery:false, silence:false, global:true },
        { delivery:false, silence:false, global:false },
      ];
      let lastError = null;
      for(const a of attempts){
        const row = { ...base };
        if(a.delivery) row.delivery_address = address;
        if(a.silence) row.silence_low_stock_alerts = desiredSilence;
        if(a.global) row.low_stock_qty_global = desiredGlobal;
        const res = await SB.client.from('profiles').upsert([row], { onConflict: 'user_id' });
        if(!res.error){
          SB.profile = { ...row };
          if(!a.delivery) SB.profile.delivery_address = '';
          SB.profile.silence_low_stock_alerts = desiredSilence;
          SB.profile.low_stock_qty_global = desiredGlobal;
          return SB.profile;
        }
        lastError = res.error;
        const msg = String(res.error && res.error.message ? res.error.message : '');
        if(!(msg.includes('delivery_address') || msg.includes('silence_low_stock_alerts') || msg.includes('low_stock_qty_global'))){
          break;
        }
      }
      if(lastError) throw lastError;
      throw Error('Save failed');
    }
    async function sbCheckAuthorization(){
      if(!SB.ready || !SB.user){ SB.authorized=false; updateStatusBar(); return false; }
      try{
        const { data, error } = await SB.client
          .from('authorized_users')
          .select('user_id')
          .eq('user_id', SB.user.id)
          .maybeSingle();
        if(error) throw error;
        SB.authorized = !!data;
      }catch(e){
        console.warn('Authorization check failed:', e);
        SB.authorized = false;
      }
      updateStatusBar();
      return SB.authorized;
    }
    async function sbHandleSession(session){
      SB.session = session || null;
      SB.user = session && session.user ? session.user : null;
      SB.connected = false;
      SB.authorized = false;
      SB.profile = null;
      updateStatusBar();

      if(!SB.session){
        state.items = [];
        if(_sbChannel && SB.client){ try{ SB.client.removeChannel(_sbChannel); }catch{} _sbChannel=null; }
        render();
        show('authModal', true);
        return;
      }

      show('authModal', false);
      setAuthMessage('');

      await sbEnsureProfile();
      await sbCheckAuthorization();
      renderProfileUi();

      if(!SB.authorized){
        state.items = [];
        render();
        updateStatusBar();
        return;
      }

      await checkServerHealth();
      if(isOnline()){
        await sbLoadSnapshot();
        sbStartRealtime();
      }
    }
    async function sbAuthBoot(){
      if(!SB.ready || !SB.client) return;

      renderAuthUi();

      // Profile dropdown handlers
      const profileBtn = $('profileBtn');
      const profileDropdown = $('profileDropdown');
      const profileSignIn = $('profileSignIn');

      function toggleProfileDropdown(open){
        if(profileDropdown){
          profileDropdown.style.display = '';
          profileDropdown.classList.toggle('open', open);
          profileDropdown.setAttribute('aria-hidden', open ? 'false' : 'true');
          if(profileBtn) profileBtn.setAttribute('aria-expanded', open);
        }
      }

      if(profileBtn && !profileBtn._wired){
        profileBtn._wired = true;
        profileBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          toggleProfileDropdown(!profileDropdown.classList.contains('open'));
        });
      }

      if(profileSignIn && !profileSignIn._wired){
        profileSignIn._wired = true;
        profileSignIn.addEventListener('click', ()=>{
          toggleProfileDropdown(false);
          if(!SB.session) {
            show('authModal', true);
          } else {
            // Sign out
            sbSignOut();
          }
        });
      }

      // Close profile dropdown when clicking outside
      document.addEventListener('click', (e)=>{
        if(profileDropdown && profileDropdown.classList.contains('open')){
          if(!e.target.closest('.profile-menu')){
            toggleProfileDropdown(false);
          }
        }
      });

      try{
        const { data } = await SB.client.auth.getSession();
        await sbHandleSession(data && data.session ? data.session : null);
      }catch(e){
        console.warn('Auth boot failed:', e);
        await sbHandleSession(null);
      }

      SB.client.auth.onAuthStateChange((event, session)=>{
        void sbHandleSession(session);
      });
    }
    async function sbSignIn(email, password){
      if(!SB.ready) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      const p = String(password||'');
      if(!e) throw Error('Email required');
      if(!p) throw Error('Password required');
      const { error } = await SB.client.auth.signInWithPassword({ email: e, password: p });
      if(error) throw error;
    }
    async function sbSignUp(email, password){
      if(!SB.ready) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      const p = String(password||'');
      if(!e) throw Error('Email required');
      if(!p || p.length < 6) throw Error('Password must be at least 6 characters');
      const { data, error } = await SB.client.auth.signUp({ email: e, password: p });
      if(error) throw error;
      if(data && !data.session){
        setAuthMessage('Check your email to confirm your account, then sign in.');
      }
    }
    async function sbSendMagicLink(email){
      if(!SB.ready) throw Error('Supabase not configured');
      const e = String(email||'').trim();
      if(!e) throw Error('Email required');
      const { error } = await SB.client.auth.signInWithOtp({ email: e, options: { emailRedirectTo: location.href } });
      if(error) throw error;
    }
    async function sbSignOut(){
      if(!SB.ready || !SB.client) return;
      await SB.client.auth.signOut();
    }

    // ---------- Auth/Profile modal events ----------
    const btnAuthToggleMode = $('btnAuthToggleMode');
    if(btnAuthToggleMode) btnAuthToggleMode.addEventListener('click', ()=>{
      AUTH_MODE = (AUTH_MODE === 'signup') ? 'signin' : 'signup';
      setAuthMessage('');
      renderAuthUi();
    });

    const btnAuthMagic = $('btnAuthMagic');
    if(btnAuthMagic) btnAuthMagic.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      setAuthMessage('');
      btnAuthMagic.disabled = true;
      try{
        await sbSendMagicLink(email);
        setAuthMessage('Magic link sent. Check your email.');
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Failed to send magic link');
      }finally{
        btnAuthMagic.disabled = false;
      }
    });

    const btnAuthSubmit = $('btnAuthSubmit');
    if(btnAuthSubmit) btnAuthSubmit.addEventListener('click', async ()=>{
      const email = $('authEmail')?.value || '';
      const password = $('authPassword')?.value || '';
      setAuthMessage('');
      btnAuthSubmit.disabled = true;
      try{
        if(AUTH_MODE === 'signup') await sbSignUp(email, password);
        else await sbSignIn(email, password);
      }catch(e){
        setAuthMessage(e && e.message ? e.message : 'Authentication failed');
      }finally{
        btnAuthSubmit.disabled = false;
      }
    });

    const authPassword = $('authPassword');
    if(authPassword) authPassword.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); $('btnAuthSubmit')?.click(); }
    });

    const btnProfileClose = $('btnProfileClose');
    if(btnProfileClose) btnProfileClose.addEventListener('click', ()=> {
      if(_profileAutoSaveTimer){ clearTimeout(_profileAutoSaveTimer); _profileAutoSaveTimer = null; }
      show('profileModal', false);
    });

    const openProfileSettings = $('openProfileSettings');
    if(openProfileSettings) openProfileSettings.addEventListener('click', ()=>{
      const profileDropdown = $('profileDropdown');
      if(profileDropdown){
        profileDropdown.classList.remove('open');
        profileDropdown.style.display = '';
        profileDropdown.setAttribute('aria-hidden', 'true');
      }
      $('profileBtn')?.setAttribute('aria-expanded', 'false');
      renderProfileUi();
      show('profileModal', true);
    });

    const profilePhoneInput = $('profilePhone');
    if(profilePhoneInput){
      profilePhoneInput.addEventListener('input', (e)=>{
        const cursorPos = e.target.selectionStart;
        const oldLen = e.target.value.length;
        e.target.value = formatPhoneNumber(e.target.value);
        const newLen = e.target.value.length;
        // Adjust cursor position after formatting
        const newPos = Math.max(0, cursorPos + (newLen - oldLen));
        e.target.setSelectionRange(newPos, newPos);
      });
    }

	    // Profile auto-save
    let _profileAutoSaveTimer = null;
    async function autoSaveProfile(){
      const modal = $('profileModal');
      if(!modal || modal.getAttribute('aria-hidden') === 'true') return;
      const firstName = $('profileFirstName')?.value || '';
      const lastName = $('profileLastName')?.value || '';
      const phone = $('profilePhone')?.value || '';
      const deliveryAddress = $('profileDeliveryAddress')?.value || '';
      const lowStockQtyGlobal = $('profileLowStockQtyGlobal')?.value || '';
      const silenceLowStockAlerts = !!($('profileSilenceLowStockAlerts')?.checked);
      setProfileMessage('');
      try{
        await sbSaveProfile(firstName, lastName, phone, deliveryAddress, silenceLowStockAlerts, lowStockQtyGlobal);
        renderProfileUi();
        try{ renderTable(); }catch(e){}
        toast('Auto-saved');
      }catch(e){
        setProfileMessage(e && e.message ? e.message : 'Save failed');
      }
    }
    function scheduleProfileAutoSave(){
      if(_profileAutoSaveTimer) clearTimeout(_profileAutoSaveTimer);
      _profileAutoSaveTimer = setTimeout(()=> autoSaveProfile(), 600);
    }
    // Attach auto-save listeners to profile inputs
    ['profileFirstName','profileLastName','profilePhone','profileDeliveryAddress','profileLowStockQtyGlobal'].forEach(id=>{
      const el = $(id);
      if(el){
        el.addEventListener('blur', scheduleProfileAutoSave);
        el.addEventListener('change', scheduleProfileAutoSave);
      }
    });
    const profileSilenceToggle = $('profileSilenceLowStockAlerts');
    if(profileSilenceToggle) profileSilenceToggle.addEventListener('change', ()=> autoSaveProfile());

    const btnSignOut = $('btnSignOut');
    if(btnSignOut) btnSignOut.addEventListener('click', async ()=>{
      try{
        await sbSignOut();
        show('profileModal', false);
        toast('Signed out');
      }catch(e){
        toast(e && e.message ? e.message : 'Sign out failed');
      }
    });
		    async function sbLoadSnapshot(){
		      if(!SB.ready || !SB.session || !SB.authorized) return;
		      let data = null;
		      const baseSel = 'id,name,description,qty,updated_at';
		
		      function buildSel(){
		        let sel = baseSel;
		        if(SB.itemsHasLowStockQty !== false) sel += ',low_stock_qty';
		        if(SB.itemsHasReorderEnabled !== false) sel += ',reorder_enabled';
		        return sel;
		      }
		
		      for(let attempt=0; attempt<3; attempt++){
		        const sel = buildSel();
		        const res = await SB.client
		          .from('items')
		          .select(sel)
		          .order('name', { ascending:true });
		        if(!res.error){
		          data = res.data;
		          if(sel.includes('low_stock_qty')) SB.itemsHasLowStockQty = true;
		          if(sel.includes('reorder_enabled')) SB.itemsHasReorderEnabled = true;
		          break;
		        }
		        const e = res.error;
		        const msg = errToText(e).toLowerCase();
		        let changed = false;
		
		        if(msg.includes('low_stock_qty')){
		          if(SB.itemsHasLowStockQty !== false) changed = true;
		          SB.itemsHasLowStockQty = false;
		          if(isSchemaCacheMissingColumnError(e, 'low_stock_qty') && !SB.warnedLowStockSchema){
		            SB.warnedLowStockSchema = true;
		            toast("Supabase needs schema reload for low stock (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing items.low_stock_qty. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		        if(msg.includes('reorder_enabled')){
		          if(SB.itemsHasReorderEnabled !== false) changed = true;
		          SB.itemsHasReorderEnabled = false;
		          if(isSchemaCacheMissingColumnError(e, 'reorder_enabled') && !SB.warnedReorderSchema){
		            SB.warnedReorderSchema = true;
		            toast("Supabase needs schema reload for reorder settings (run: NOTIFY pgrst, 'reload schema';)");
		            console.warn("Supabase schema cache missing items.reorder_enabled. Run: NOTIFY pgrst, 'reload schema';");
		          }
		        }
		
		        if(!changed){
		          console.warn('Supabase load error', e);
		          return;
		        }
		      }
		
		      if(data === null) return;
		      state.items = (data||[]).map(r => ({
		        id:r.id,
		        name:r.name||'',
		        desc:r.description||'',
		        qty:toInt(r.qty,0),
		        lowStockQty: (r && Object.prototype.hasOwnProperty.call(r,'low_stock_qty') && r.low_stock_qty !== null) ? toInt(r.low_stock_qty,0) : null,
		        reorderEnabled: (r && Object.prototype.hasOwnProperty.call(r,'reorder_enabled')) ? !!r.reorder_enabled : true,
		        updatedAt:r.updated_at||null
		      }));
		      setUpdated(); render();
		    }
    let _sbChannel=null;
    function sbStartRealtime(){
      if(!SB.ready || !SB.session || !SB.authorized) return;
      if(_sbChannel){ SB.client.removeChannel(_sbChannel); _sbChannel=null; }
      _sbChannel = SB.client.channel('items_all')
        .on('postgres_changes', {event:'*', schema:'public', table:'items'}, payload=>{
          const row = payload.new || payload.old;
          console.log('[realtime]', payload.eventType, row && row.id, row);
		          if(payload.eventType==='INSERT'){
		            const i = state.items.findIndex(x=> x.id===row.id);
		            if(i===-1) state.items.push({
		              id:row.id,
		              name:row.name,
		              desc:row.description||'',
		              qty:toInt(row.qty,0),
		              lowStockQty: (row && Object.prototype.hasOwnProperty.call(row,'low_stock_qty') && row.low_stock_qty !== null) ? toInt(row.low_stock_qty,0) : null,
		              reorderEnabled: (row && Object.prototype.hasOwnProperty.call(row,'reorder_enabled')) ? !!row.reorder_enabled : true,
		              updatedAt:row.updated_at
		            });
		          }else if(payload.eventType==='UPDATE'){
		            const it = state.items.find(x=> x.id===row.id);
		            if(it){
		              it.name=row.name;
		              it.desc=row.description||'';
		              it.qty=toInt(row.qty,0);
		              if(Object.prototype.hasOwnProperty.call(row,'low_stock_qty')){
		                it.lowStockQty = (row.low_stock_qty === null) ? null : toInt(row.low_stock_qty,0);
		              }
		              if(Object.prototype.hasOwnProperty.call(row,'reorder_enabled')){
		                it.reorderEnabled = !!row.reorder_enabled;
		              }
		              it.updatedAt=row.updated_at;
		            }
		          }else if(payload.eventType==='DELETE'){
	            state.items = state.items.filter(x=> x.id!==row.id);
	          }
          setUpdated(); render();
        })
        .subscribe();
    }
    async function sbAddItem(name, desc, qty){
      const id = randomUUID();
      const { error } = await SB.client.from('items').insert([{ id, name, description:desc||'', qty:toInt(qty,0) }]);
      if(error) throw error; return id;
    }
	    async function sbUpdateFields(id, fields){
	      const clean = {};
	      if('name' in fields) clean.name = String(fields.name||'');
	      if('desc' in fields) clean.description = String(fields.desc||'');
	      if('qty'  in fields) clean.qty  = toInt(fields.qty,0);
	      if('reorderEnabled' in fields) clean.reorder_enabled = !!fields.reorderEnabled;
	      if('lowStockQty' in fields){
		        const raw = fields.lowStockQty;
		        if(raw === null || typeof raw === 'undefined' || String(raw).trim() === ''){
		          clean.low_stock_qty = null;
		        }else{
	          const v = toInt(raw, -1);
	          if(v < 0) throw Error('Low stock qty must be integer ≥ 0');
	          clean.low_stock_qty = v;
	        }
	      }
	      const { error } = await SB.client.from('items').update(clean).eq('id', id);
	      if(error) throw error;
	    }

	    function errToText(err){
	      if(!err) return '';
	      if(typeof err === 'string') return err;
	      const parts = [];
	      try{
	        if(err.message) parts.push(String(err.message));
	        if(err.details) parts.push(String(err.details));
	        if(err.hint) parts.push(String(err.hint));
	        if(err.code) parts.push(String(err.code));
	      }catch(e){}
	      return parts.join(' ');
	    }

	    function isSchemaCacheMissingColumnError(err, column){
	      const msg = errToText(err);
	      if(!msg) return false;
	      const lower = msg.toLowerCase();
	      if(!lower.includes('schema cache')) return false;
	      if(column && !lower.includes(String(column).toLowerCase())) return false;
	      return true;
	    }
	
	    function showSchemaCacheReloadHelp(tableName, columnName){
	      const sql = "NOTIFY pgrst, 'reload schema';";
	      try{
	        if(navigator.clipboard && navigator.clipboard.writeText){
	          navigator.clipboard.writeText(sql)
	            .then(()=> toast('Copied schema reload SQL'))
	            .catch(()=>{});
	        }
	      }catch(e){}
	      openMsgModal(
	        'Supabase schema cache',
	        `Supabase is reporting “column not found in schema cache” for ${tableName}.${columnName}.\n\n`+
	          `This usually means PostgREST hasn’t reloaded its schema cache yet.\n\n`+
	          `Fix:\n`+
	          `1) Supabase Dashboard → SQL Editor\n`+
	          `2) Run:\n${sql}\n`+
	          `3) Refresh this page\n\n`+
	          `If it still fails, wait ~30 seconds and try again.`,
	        sql
	      );
	    }
	    async function sbDeleteMany(ids){
	      const requested = Array.isArray(ids) ? ids.filter(Boolean) : [];
	      if(requested.length===0) return { deleted:0, requested:0 };
	      // Note: Some RLS policies may prevent returning representations of deleted rows,
	      // so we do not depend on the returned data length. If no error is thrown, treat
      // it as success for all requested IDs and immediately refresh from server.
      const { error } = await SB.client
        .from('items')
        .delete()
        .in('id', requested);
      if (error) throw error;
      return { deleted: requested.length, requested: requested.length };
    }
    async function sbUpsertMany(rows){
      // Load existing rows to build a case-insensitive index by name
      const { data: existing, error: selErr } = await SB.client
        .from('items')
        .select('id,name,description,qty');
      if (selErr) throw selErr;

      const idx = new Map((existing||[]).map(it => [toKey(it.name), it]));
      const toInsert = [];
      const toUpdate = [];

      for (const r of rows){
        const k = toKey(r.name); if (!k) continue;
        const ex = idx.get(k);
        const name = String(r.name||'').trim();
        const description = String(r.desc||'').trim();
        const qty = toInt(r.qty,0);

        if (!ex){
          toInsert.push({ name, description, qty });
        } else {
          toUpdate.push({ id: ex.id, name, description: (description || ex.description || ''), qty });
        }
      }

      if (toInsert.length){
        const { error: insErr } = await SB.client.from('items').insert(toInsert);
        if (insErr) throw insErr;
      }
      // Upsert updates by primary key id (safe and efficient)
      if (toUpdate.length){
        // Chunk to avoid payload limits
        const chunks = [];
        const size = 500;
        for (let i=0;i<toUpdate.length;i+=size) chunks.push(toUpdate.slice(i, i+size));
        for (const part of chunks){
          const { error: upErr } = await SB.client.from('items').upsert(part, { onConflict: 'id' });
          if (upErr) throw upErr;
        }
      }
    }

    // ========================
    // Rendering & inline edit
    // ========================
    function escapeHtml(s){ return String(s).replace(/[&<>]/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
    function escapeHtmlAttr(s){
      return String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function render(){ renderTable(); renderKpis(); }

function adjustTitleSize(){
  try{
    const h1=document.querySelector('header h1');
    const wrap=document.querySelector('.brandtext');
    if(!h1||!wrap) return;
    h1.style.whiteSpace='nowrap'; h1.style.maxWidth='100%';
    h1.style.fontSize='';
    const rootStyles = getComputedStyle(document.documentElement);
    let min = parseFloat(rootStyles.getPropertyValue('--title-min')) || 12;
    let max = parseFloat(rootStyles.getPropertyValue('--title-max')) || 56;
    let size=parseFloat(getComputedStyle(h1).fontSize)||32;
    const room = Math.max(0, wrap.getBoundingClientRect().width - 8);
    const fits = ()=> h1.scrollWidth <= room;
    if(!fits()){
      while(size>min && !fits()){ size-=1; h1.style.fontSize=size+'px'; }
    }else{
      while(size<max){ h1.style.fontSize=(size+1)+'px'; if(!fits()){ h1.style.fontSize=size+'px'; break; } size+=1; }
    }
  }catch(e){}
}

	function getSort(){ return state._sort || {col:'name',dir:'asc'}; }
	function syncMobileSortSelect(){
	  const sel = $('mobileSort');
	  if(!sel) return;
	  const srt = getSort();
	  const key = `${srt.col}:${srt.dir}`;
	  const has = Array.from(sel.options || []).some(o => o.value === key);
	  if(has) sel.value = key;
	}
	function applySortIndicators(){
	  const srt=getSort();
	  document.querySelectorAll('#invTable thead th.sortable').forEach(th=>{
	    const col=th.getAttribute('data-col');
	    th.removeAttribute('aria-sort');
    th.classList.remove('sorted-asc','sorted-desc');
    if(col===srt.col){
      const desc = (srt.dir==='desc');
      th.setAttribute('aria-sort', desc ? 'descending' : 'ascending');
	      th.classList.add(desc ? 'sorted-desc' : 'sorted-asc');
	    }
	  });
	  syncMobileSortSelect();
	}

	function toTime(v){
	  const t = Date.parse(String(v || ''));
	  return Number.isFinite(t) ? t : 0;
	}
	function sortItems(arr){
	  const srt=getSort(); const dir = srt.dir==='desc' ? -1 : 1; const col=srt.col||'name';
	  return arr.sort((a,b)=>{
	    if(col==='qty') return (toInt(a.qty,0)-toInt(b.qty,0))*dir;
	    if(col==='updatedAt') return (toTime(a.updatedAt)-toTime(b.updatedAt))*dir;
	    const av=toKey(String((a && a[col])||'')); const bv=toKey(String((b && b[col])||''));
	    return av.localeCompare(bv)*dir;
	  });
	}


	function adjustDescColumnWidth(){
	  try{
	    const table = document.getElementById('invTable');
	    const colDesc = document.getElementById('col-desc');
	    if(!table || !colDesc) return;
	    const isMobile = window.matchMedia('(max-width: 768px)').matches;
	    if(isMobile){
	      colDesc.style.width = '';
	      table.querySelectorAll('td[data-col="desc"], th[data-col="desc"]').forEach(el=>{
	        el.style.whiteSpace='normal'; el.style.wordBreak='break-word'; el.style.hyphens='auto';
	      });
	      return;
	    }
    const tb = table.querySelector('tbody');
    const cells = tb? Array.from(tb.querySelectorAll('td[data-col="desc"]')) : [];
    if(cells.length===0){ colDesc.style.width=''; return; }
    // Measure using hidden span with same font
    const sample = cells[0];
    const cs = window.getComputedStyle(sample);
    const meas = document.createElement('span');
    meas.style.position='absolute'; meas.style.visibility='hidden'; meas.style.whiteSpace='nowrap';
    meas.style.font = `${cs.fontWeight} ${cs.fontSize} ${cs.fontFamily}`;
    document.body.appendChild(meas);
    let max = 0;
    for(const td of cells){
      meas.textContent = td.textContent || '';
      const w = meas.getBoundingClientRect().width; if(w>max) max=w;
    }
    document.body.removeChild(meas);
	    const tableW = table.getBoundingClientRect().width;
	    const minW = 220; // ensure readable
	    const guard = 42 + 150 + 120; // sel + qty + min name
	    const maxClamp = Math.max(160, tableW - guard);
	    const width = Math.min(Math.max(minW, Math.ceil(max+24)), Math.floor(tableW*0.7), maxClamp);
    colDesc.style.width = width + 'px';
    table.querySelectorAll('td[data-col="desc"], th[data-col="desc"]').forEach(el=>{
      el.style.whiteSpace='nowrap'; el.style.wordBreak='normal'; el.style.hyphens='manual';
    });
	  }catch(e){ /* no-op */ }
	}

		function isMobileUx(){
		  try{
		    if(!window.matchMedia) return false;
		    return window.matchMedia('(max-width: 768px)').matches || window.matchMedia('(pointer: coarse)').matches;
		  }catch(e){ return false; }
		}
		function isMobileStacked(){ return isMobileUx(); }

	    function renderKpis(){
	      const el=$('lastUpdate');
	      if(!el) return;
	      el.textContent = state.updatedAt? `Last Update: ${new Date(state.updatedAt).toLocaleString(undefined,{hour12:true})}` : '';
      const fb=$('filterBox'); if(fb) fb.value = state._filter || '';
          }

    // -------- Partial-optimistic DOM helpers --------
function tbodyEl(){ return document.querySelector('#invTable tbody'); }
function rowElById(id){ return tbodyEl()?.querySelector(`tr[data-id="${id}"]`) || null; }
	function cellEl(tr, col){ return tr?.querySelector(`td[data-col="${col}"]`) || null; }
	let _openTrayId = '';
	const REVEAL_PX = 48; // icons begin appearing
	const SNAP_PX = 192; // tray snaps open
	const COMMIT_PX = 288; // auto-trigger Edit (swipe left only)
	const MAX_PX = 336; // elastic clamp
	const INNER_REVEAL_PX = Math.round((REVEAL_PX + SNAP_PX) / 2); // second icon begins appearing
	function clampNum(v, min, max){
	  return Math.max(min, Math.min(max, v));
	}
	function trayProgressForSwipeX(x){
	  const ax = Math.abs(Number(x) || 0);
	  if(ax <= REVEAL_PX) return 0;
	  return clampNum((ax - REVEAL_PX) / (SNAP_PX - REVEAL_PX), 0, 1);
	}
	function getRowSwipeX(tr){
	  if(!tr || !tr.style) return 0;
	  const raw = String(tr.style.getPropertyValue('--swipe-x') || '').trim();
	  const n = Number.parseFloat(raw);
	  return Number.isFinite(n) ? n : 0;
	}
	function setRowSwipeX(tr, x){
	  if(!tr || !tr.style) return;
	  const v = clampNum(Number(x) || 0, -MAX_PX, MAX_PX);
	  const ax = Math.abs(v);
	  const outer = trayProgressForSwipeX(v);
	  const inner = (ax <= INNER_REVEAL_PX) ? 0 : clampNum((ax - INNER_REVEAL_PX) / (SNAP_PX - INNER_REVEAL_PX), 0, 1);
	  const commitProgress = (ax <= SNAP_PX) ? 0 : clampNum((ax - SNAP_PX) / (COMMIT_PX - SNAP_PX), 0, 1);
	  tr.style.setProperty('--swipe-x', `${v}px`);
	  tr.style.setProperty('--tray-progress', String(outer));
	  tr.style.setProperty('--tray-outer', String(outer));
	  tr.style.setProperty('--tray-inner', String(inner));
	  tr.style.setProperty('--commit-progress', String(commitProgress));
	  const side = (tr && tr.dataset) ? String(tr.dataset.traySide || '') : '';
	  const commitArmed = (side === 'right') && (Math.abs(v) >= COMMIT_PX);
	  tr.classList.toggle('commit-armed', commitArmed);
	}
	function traySideToSwipeX(side){
	  return (side === 'left') ? SNAP_PX : -SNAP_PX;
	}
	function setMobileTrayA11y(tr, open){
	  const tray = tr ? tr.querySelector('.card-tray') : null;
	  if(!tray) return;
	  tray.setAttribute('aria-hidden', open ? 'false' : 'true');
	  tray.querySelectorAll('button.card-tray-btn').forEach(btn=>{
	    if(open) btn.removeAttribute('tabindex');
	    else btn.setAttribute('tabindex', '-1');
	  });
	}
	function closeMobileTray(){
	  if(!_openTrayId) return;
	  const tr = rowElById(_openTrayId);
	  if(tr){
	    tr.classList.remove('swiping');
	    tr.classList.remove('tray-peek');
	    tr.classList.remove('tray-open');
	    setRowSwipeX(tr, 0);
	    try{ delete tr.dataset.traySide; }catch(e){ tr.dataset.traySide = ''; }
	    setMobileTrayA11y(tr, false);
	  }
	  _openTrayId = '';
	}
	function closeMobileTrayElastic(targetTr){
	  const tr = targetTr || (_openTrayId ? rowElById(_openTrayId) : null);
	  if(tr){
	    tr.classList.remove('swiping');
	    tr.classList.remove('tray-peek');
	    tr.classList.remove('tray-open');
	    tr.classList.add('snap-elastic');
	    setRowSwipeX(tr, 0);
	    try{ delete tr.dataset.traySide; }catch(e){ tr.dataset.traySide = ''; }
	    setMobileTrayA11y(tr, false);
	    // Remove elastic class after animation completes
	    setTimeout(()=>{ try{ tr.classList.remove('snap-elastic'); }catch(e){} }, 400);
	  }
	  _openTrayId = '';
	}
	function prepareMobileTrayForRow(tr, side){
	  if(!tr) return;
	  const id = String(tr.dataset && tr.dataset.id ? tr.dataset.id : '').trim();
	  if(!id) return;
	  if(_openTrayId && _openTrayId !== id) closeMobileTray();
	  _openTrayId = id;
	  tr.dataset.traySide = (side === 'left') ? 'left' : 'right';
	  tr.classList.remove('tray-open');
	  tr.classList.add('tray-peek');
	  setMobileTrayA11y(tr, false);
	}
	function openMobileTrayForRow(tr, side){
	  if(!tr) return;
	  const id = String(tr.dataset && tr.dataset.id ? tr.dataset.id : '').trim();
	  if(!id) return;
	  if(_openTrayId && _openTrayId !== id) closeMobileTray();
	  _openTrayId = id;
	  tr.dataset.traySide = (side === 'left') ? 'left' : 'right';
	  tr.classList.remove('tray-peek');
	  tr.classList.add('tray-open');
	  setMobileTrayA11y(tr, true);
	  const targetX = traySideToSwipeX(tr.dataset.traySide);
	  try{ requestAnimationFrame(()=> setRowSwipeX(tr, targetX)); }catch(e){ setRowSwipeX(tr, targetX); }
	}
	function syncOrderIndicatorForRow(id){
	  const tr = rowElById(id);
	  if(!tr) return;
	  const led = tr.querySelector('.card-led--order');
	  let inOrder = false;
	  try{
	    const ord = orderState();
	    inOrder = !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && l.id === id));
	  }catch(e){}
	  if(led) led.classList.toggle('card-led--on', inOrder);
	  tr.classList.toggle('order-selected', inOrder);
	}
	function syncLowStockOverrideIndicatorForRow(id){
	  const tr = rowElById(id);
	  if(!tr) return;
	  const item = state.items.find(x => x && x.id === id);
	  if(!item) return;
	  const hasLowStockOverride = getItemLowStockQtyOverride(item) !== null;

	  const btn = tr.querySelector('.row-stock-btn');
	  if(btn){
	    btn.classList.toggle('has-override', hasLowStockOverride);
	    const lowStockBtnLabel = hasLowStockOverride ? 'Set low stock qty (override)' : 'Set low stock qty';
	    btn.setAttribute('aria-label', lowStockBtnLabel);
	    btn.setAttribute('title', lowStockBtnLabel);
	  }
	}
	function syncLowStockIndicatorForRow(id){
	  const tr = rowElById(id);
	  if(!tr) return;
	  const item = state.items.find(x => x && x.id === id);
	  if(!item) return;
	  const silenced = lowStockAlertsSilenced();
	  const qty = toInt(item.qty, 0);
	  const isLowStock = !silenced && isLowStockItem(item);
	  const isOutOfStock = isLowStock && qty === 0;
	  const isLowButInStock = isLowStock && qty > 0;
	  const led = tr.querySelector('.card-led--lowstock');
	  if(led){
	    led.classList.toggle('card-led--outofstock', isOutOfStock);
	    led.classList.toggle('card-led--on', isLowButInStock);
	  }
	}
	function qtyCellHTML(it){
	  const q = toInt(it.qty,0);
	  const id = escapeHtmlAttr(it.id || '');
	  return (
	    '<div class="qty-stepper qty-stepper--table" aria-label="Qty controls">'+
	      '<button type="button" class="qty-step qty-step-btn" data-id="'+id+'" data-delta="-1" aria-label="Decrease qty">−</button>'+
	      '<span class="qty-value" aria-label="Qty">'+q+'</span>'+
	      '<button type="button" class="qty-step qty-step-btn" data-id="'+id+'" data-delta="1" aria-label="Increase qty">+</button>'+
	    '</div>'
	  );
	}
			function buildRowHTML(it){
			  const rawId = String(it && it.id ? it.id : '');
			  const id = escapeHtmlAttr(rawId);
			  const hasLowStockOverride = getItemLowStockQtyOverride(it) !== null;
			  const isLowStock = isLowStockItem(it);
			  const lowStockBtnLabel = hasLowStockOverride ? 'Set low stock qty (override)' : 'Set low stock qty';
			  const lowStockBtnClass = hasLowStockOverride ? 'row-stock-btn has-override' : 'row-stock-btn';
			  const inOrder = (()=> {
			    try{
			      const ord = orderState();
			      return !!(ord && Array.isArray(ord.lines) && rawId && ord.lines.some(l => l && l.id === rawId));
			    }catch(e){ return false; }
			  })();
			  const orderLedClass = inOrder ? 'card-led card-led--order card-led--on' : 'card-led card-led--order';
			  const showLowStockLed = isLowStock && !lowStockAlertsSilenced();
			  const qty = toInt(it.qty, 0);
			  const isOutOfStock = showLowStockLed && qty === 0;
			  const isLowButInStock = showLowStockLed && qty > 0;
			  const lowstockLedClass = isOutOfStock ? 'card-led card-led--lowstock card-led--outofstock' : (isLowButInStock ? 'card-led card-led--lowstock card-led--on' : 'card-led card-led--lowstock');
			  return (
			    '<td class="sel"><input type="checkbox" class="rowChk" data-id="'+id+'"></td>'+
			    '<td data-col="name">'+
			      '<div class="card-leds" aria-hidden="true">'+
			        '<span class="'+orderLedClass+'"></span>'+
			        '<span class="'+lowstockLedClass+'"></span>'+
			      '</div>'+
			      '<div class="card-tray" aria-hidden="true">'+
			        '<button type="button" class="card-tray-btn" data-tray-action="lowStock" tabindex="-1" aria-label="Low stock override" title="Low stock override">'+
			          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
			            '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>'+
			            '<line x1="12" y1="9" x2="12" y2="13"></line>'+
			            '<line x1="12" y1="17" x2="12.01" y2="17"></line>'+
			          '</svg>'+
			        '</button>'+
			        '<button type="button" class="card-tray-btn" data-tray-action="edit" tabindex="-1" aria-label="Edit item" title="Edit item">'+
			          '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
			            '<path d="M12 20h9"></path>'+
			            '<path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>'+
			          '</svg>'+
			        '</button>'+
			      '</div>'+
			      '<span class="cell-val">'+escapeHtml(it.name||'')+'</span>'+
			    '</td>'+
			    '<td data-col="desc"><span class="cell-val">'+escapeHtml(it.desc||'')+'</span></td>'+
				    '<td data-col="qty" class="qty">'+qtyCellHTML(it)+'</td>'+
				    '<td class="actions"><div class="actions-wrap">'+
				      '<button class="'+lowStockBtnClass+'" data-id="'+id+'" aria-label="'+escapeHtmlAttr(lowStockBtnLabel)+'" title="'+escapeHtmlAttr(lowStockBtnLabel)+'">'+
		        '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
		          '<line x1="4" y1="21" x2="4" y2="14"></line>'+
		          '<line x1="4" y1="10" x2="4" y2="3"></line>'+
		          '<line x1="12" y1="21" x2="12" y2="12"></line>'+
		          '<line x1="12" y1="8" x2="12" y2="3"></line>'+
		          '<line x1="20" y1="21" x2="20" y2="16"></line>'+
		          '<line x1="20" y1="12" x2="20" y2="3"></line>'+
		          '<line x1="1" y1="14" x2="7" y2="14"></line>'+
		          '<line x1="9" y1="8" x2="15" y2="8"></line>'+
		          '<line x1="17" y1="16" x2="23" y2="16"></line>'+
		        '</svg>'+
		      '</button>'+
			      '<button class="row-delete-btn" data-id="'+id+'" aria-label="Delete item" title="Delete item">'+
		        '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">'+
		          '<polyline points="3 6 5 6 21 6"></polyline>'+
		          '<path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>'+
		        '</svg>'+
			      '</button>'+
			    '</div></td>'
			  );
			}
// Insert a row into the table in sorted position by name
function insertRowSorted(it){
  const tb = tbodyEl(); if(!tb) return;
  const empty = tb.querySelector('tr[data-empty="1"]'); if(empty) empty.remove();
  const trs = Array.from(tb.querySelectorAll('tr[data-id]'));
  const k = toKey(it.name);
  let anchor = null;
  for(const tr of trs){
    const nm = tr.querySelector('td[data-col="name"]')?.textContent || '';
    if(toKey(nm) > k){ anchor = tr; break; }
  }
  const tr = document.createElement('tr');
  tr.dataset.id = it.id;
  tr.innerHTML = buildRowHTML(it);
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing(); // attach listeners to the new row
}
// Reposition existing row if its name changed
function repositionRowByName(id){
  const tb = tbodyEl(); if(!tb) return;
  const tr = rowElById(id); if(!tr) return;
  const it = state.items.find(x=> x.id===id); if(!it) return;
  tr.innerHTML = buildRowHTML(it); // refresh cells
  const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
  const k = toKey(it.name);
  let anchor = null;
  for(const r of others){
    const nm = r.querySelector('td[data-col="name"]')?.textContent || '';
    if(toKey(nm) > k){ anchor = r; break; }
  }
  if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
  enableInlineEditing();
}
// Update just one cell
function updateCellDisplay(id, col, value){
  const tr = rowElById(id); if(!tr) return;
  const td = cellEl(tr, col); if(!td) return;
  if(col==='qty'){
    const v = String(toInt(value,0));
    const el = td.querySelector('.qty-value');
    if(el) el.textContent = v;
    else td.textContent = v;
    return;
  }
  td.textContent = String(value||'');
}

function updateFilterClearBtn(){
  const fb = $('filterBox');
  const btn = $('btnClearFilter');
  if(!fb || !btn) return;
  const has = String(fb.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderSearchClearBtn(){
  const inp = $('orderSearch');
  const btn = $('btnClearOrderSearch');
  if(!inp || !btn) return;
  const has = String(inp.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}

function updateOrderHistoryFilterClearBtn(){
  const inp = $('orderHistoryFilter');
  const btn = $('btnClearOrderHistoryFilter');
  if(!inp || !btn) return;
  const has = String(inp.value || '').length > 0;
  btn.style.display = has ? 'flex' : 'none';
  btn.disabled = !has;
  btn.setAttribute('aria-hidden', has ? 'false' : 'true');
}
// Ensure an empty-state row exists when there are no data rows
function emptyStateHtml(){
  const gate = explainGate();
  if(!gate){
    return 'No items yet. Use <b>Import File</b> or <b>Paste Data</b> above, or <b>Add Item</b> to create one.';
  }
  if(gate === 'Sign in required'){
    return 'Sign in to view your inventory. Tap the status bar above.';
  }
  if(gate === 'Not authorized'){
    return 'Not authorized for this inventory. Tap the status bar above for account details.';
  }
  if(gate.startsWith('Offline')){
    return 'Offline. Connect to load your inventory.';
  }
  return escapeHtml(gate);
}
	function ensureEmptyState(){
	  const tb = tbodyEl(); if(!tb) return;
	  const hasRows = tb.querySelector('tr[data-id]') !== null;
	  const existingEmpty = tb.querySelector('tr[data-empty="1"]');
	  if(!hasRows && !existingEmpty){
	    const tr=document.createElement('tr'); tr.setAttribute('data-empty','1');
	    tr.innerHTML = '<td colspan="4" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
	    tb.appendChild(tr);
	  } else if(hasRows && existingEmpty){
	    existingEmpty.remove();
	  }
	}

	function isCompactTotals(){
	  try{ return window.matchMedia && window.matchMedia('(max-width:520px)').matches; }catch(e){ return false; }
	}
	function totalsLabel(key){
	  const compact = isCompactTotals();
	  if(key === 'items') return compact ? 'Items' : 'Total Items';
	  if(key === 'inStock') return compact ? 'Stock' : 'In Stock';
	  if(key === 'lowStock') return compact ? 'Low' : 'Low Stock';
	  if(key === 'qty') return compact ? 'Qty' : 'Total Qty';
	  return String(key || '');
	}
	function getTotalsValue(elId){
	  const el = $(elId);
	  if(!el) return null;
	  const dv = el.dataset ? String(el.dataset.value || '').trim() : '';
	  if(dv){
	    const v = Number(dv);
	    if(Number.isFinite(v)) return Math.trunc(v);
	  }
	  const m = /:\s*(\d+)/.exec(el.textContent || '');
	  if(!m) return null;
	  return toInt(m[1], 0);
	}
	function setTotalsMetric(elId, key, value){
	  const el = $(elId);
	  if(!el) return;
	  const v = Math.max(0, toInt(value,0));
	  if(el.dataset) el.dataset.value = String(v);
	  el.textContent = `${totalsLabel(key)}: ${v}`;
	}
	function refreshTotalsLabels(){
	  const vItems = getTotalsValue('totalItems'); if(vItems !== null) setTotalsMetric('totalItems','items', vItems);
	  const vStock = getTotalsValue('totalInStock'); if(vStock !== null) setTotalsMetric('totalInStock','inStock', vStock);
	  const vLow = getTotalsValue('totalLowStock'); if(vLow !== null) setTotalsMetric('totalLowStock','lowStock', vLow);
	  const vQty = getTotalsValue('totalQty'); if(vQty !== null) setTotalsMetric('totalQty','qty', vQty);
	}
		    function renderTable(){
		      try{ closeMobileTray(); }catch(e){}
		      applySortIndicators();
		      const tbody=$('#invTable').querySelector('tbody'); tbody.innerHTML='';
		      const term=(state._filter||'').trim().toLowerCase();

      let items=sortItems([...state.items]);
      if(term){
        items = items.filter(it=>{
          const name=(it.name||'').toLowerCase();
          const desc=(it.desc||'').toLowerCase();
          const qty = String(toInt(it.qty,0));
          return name.includes(term) || desc.includes(term) || qty.includes(term);
        });
      }
		      const totalQty = items.reduce((sum, it) => sum + toInt(it.qty,0), 0);
		      const totalItems = items.length;
		      const inStock = items.reduce((count, it) => count + (toInt(it.qty,0) > 0 ? 1 : 0), 0);
		      const lowStock = items.reduce((count, it) => count + (isLowStockItem(it) ? 1 : 0), 0);
		      setTotalsMetric('totalQty', 'qty', totalQty);
		      setTotalsMetric('totalItems', 'items', totalItems);
		      setTotalsMetric('totalInStock', 'inStock', inStock);
		      setTotalsMetric('totalLowStock', 'lowStock', lowStock);
		      if(items.length===0){
	      const tr=document.createElement('tr');
	      tr.innerHTML = '<td colspan="5" style="padding:16px;text-align:center;color:var(--muted)">'+emptyStateHtml()+'</td>';
	      tbody.appendChild(tr);
      return;
      }
			      for(const it of items){
			        const tr=document.createElement('tr'); tr.dataset.id=it.id;
			        const inOrder = (()=> { try{ const ord = orderState(); return !!(ord && Array.isArray(ord.lines) && it.id && ord.lines.some(l => l && l.id === it.id)); }catch(e){ return false; } })();
			        if(inOrder) tr.classList.add('order-selected');
			        tr.innerHTML = buildRowHTML(it);
			        tbody.appendChild(tr);
			      }
	      enableInlineEditing();
	      try{ requestAnimationFrame(()=>{ adjustDescColumnWidth(); adjustTitleSize(); }); }catch(e){}
	    }

    function enableInlineEditing(){
      if(isMobileUx()) return;
      const tbody=$('#invTable').querySelector('tbody');
      tbody.querySelectorAll('td').forEach(td=>{
        if(td.classList.contains('sel')) return; // skip checkbox column
        td.addEventListener('click', (e)=> startCellEdit(td, e));
        td.addEventListener('dblclick', (e)=> startCellEdit(td, e));
      });
    }

    // Mobile-friendly modal editor (helps iOS cursor/precision issues)
    let _editItemCtx = null;
    let _lastEditHintPref = null;
    const _qtyCommit = new Map(); // id -> { timer, desiredQty, inFlight }

    function isIOS(){
      try{
        const ua = navigator.userAgent || '';
        const platform = navigator.platform || '';
        return /iPad|iPhone|iPod/.test(ua) || (platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }catch(e){ return false; }
    }
    function prefersModalEditing(){
      try{
        if(isIOS()) return true;
        const hasTouch = ('ontouchstart' in window) || (navigator && navigator.maxTouchPoints > 0);
        if(!hasTouch) return false;
        return window.matchMedia && (
          window.matchMedia('(pointer: coarse)').matches ||
          window.matchMedia('(hover: none)').matches ||
          window.matchMedia('(max-width: 768px)').matches
        );
      }catch(e){ return false; }
    }
	    function setEditHint(){
	      const el = $('editHint');
	      if(!el) return;
	      const mobileUx = isMobileUx();
	      const pref = prefersModalEditing();
	      const mode = mobileUx ? 'mobile' : (pref ? 'modal' : 'inline');
	      if(mode === 'mobile'){
	        el.innerHTML = '';
	      }else if(mode === 'modal'){
	        el.innerHTML = 'Tap any cell to edit. Changes auto-save.';
	      }else{
	        el.innerHTML = 'Tap any cell to edit inline; <kbd>Enter</kbd> confirms, <kbd>Esc</kbd> cancels.';
	      }
	      if(_lastEditHintPref !== null && mode !== _lastEditHintPref){
	        try{ renderTable(); }catch(e){}
	      }
	      _lastEditHintPref = mode;
	    }

    function setEditItemMessage(msg){
      const el = $('editItemMsg'); if(!el) return;
      el.textContent = String(msg || '');
    }
    function closeEditItemModal(){
      _editItemCtx = null;
      setEditItemMessage('');
      show('editItemModal', false);
    }
    function openEditItemModal(id){
      const it = state.items.find(x=> x.id===id); if(!it) return;
      _editItemCtx = { id };

      const sub = $('editItemSub');
      if(sub) sub.textContent = it.name ? `Editing: ${it.name}` : '';
      const name = $('editItemName'); if(name) name.value = String(it.name||'');
      const desc = $('editItemDesc'); if(desc) desc.value = String(it.desc||'');
      const qty  = $('editItemQty');  if(qty)  qty.value  = String(toInt(it.qty,0));

      setEditItemMessage('');
      show('editItemModal', true);
      setTimeout(()=>{
        const inp = $('editItemName');
        if(!inp) return;
        inp.focus();
        try{ inp.select(); }catch(e){}
      }, 0);
    }
    function bumpEditItemQty(delta){
      const inp = $('editItemQty'); if(!inp) return;
      const q = toInt(inp.value, 0);
      const nv = Math.max(0, q + toSignedInt(delta, 0));
      inp.value = String(nv);
    }

    async function commitItemUpdate(id, updates){
      const it = state.items.find(x=> x.id===id);
      if(!it) throw Error('Item not found');

      const fields = {};
      if(updates && 'name' in updates){
        const nv = String(updates.name||'').trim();
        if(!nv) throw Error('Name required');
        const prev = String(it.name||'');
        if(nv !== prev){
          if(toKey(nv)!==toKey(prev) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))) throw Error('Duplicate name');
          fields.name = nv;
        }
      }
      if(updates && 'desc' in updates){
        const nv = String(updates.desc||'').replace(/[\r\n]+/g,' ').trim();
        const prev = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
        if(nv !== prev) fields.desc = nv;
      }
      if(updates && 'qty' in updates){
        const q = toInt(updates.qty, -1); if(q < 0) throw Error('Qty must be integer ≥ 0');
        const prev = toInt(it.qty, 0);
        if(q !== prev) fields.qty = q;
      }

      if(Object.keys(fields).length === 0) return;
      await sbUpdateFields(id, fields);
      await sbLoadSnapshot();
    }
    async function commitItemField(id, col, rawValue){
      if(col==='name') return commitItemUpdate(id, { name: rawValue });
      if(col==='desc') return commitItemUpdate(id, { desc: rawValue });
      if(col==='qty')  return commitItemUpdate(id, { qty: rawValue });
      throw Error('Unknown field');
    }

	    async function autoSaveEditItem(){
	      if(!_editItemCtx) return;
	      const modal = $('editItemModal');
	      if(!modal || modal.getAttribute('aria-hidden') === 'true') return;
	      if(!requireOnline()) return;

      const id = _editItemCtx.id;
      const name = $('editItemName') ? $('editItemName').value : '';
      const desc = $('editItemDesc') ? $('editItemDesc').value : '';
      const qty  = $('editItemQty')  ? $('editItemQty').value  : '';

      const btnCancel = $('btnEditItemCancel');
      if(btnCancel) btnCancel.disabled = true;
      setEditItemMessage('');

      try{
        await commitItemUpdate(id, { name, desc, qty });
        toast('Auto-saved');
      }catch(e){
        const msg = (e && e.message) ? e.message : 'Update failed';
        setEditItemMessage(msg);
        toast(msg);
      }finally{
        if(btnCancel) btnCancel.disabled = false;
	      }
	    }
	    let _editItemAutoSaveTimer = null;
	    function scheduleEditItemAutoSave(){
	      if(_editItemAutoSaveTimer) clearTimeout(_editItemAutoSaveTimer);
	      _editItemAutoSaveTimer = setTimeout(()=> autoSaveEditItem(), 600);
	    }
	
	    async function deleteEditItemModal(){
	      if(!_editItemCtx) return;
	      if(!requireOnline()) return;

	      const id = _editItemCtx.id;
	      const item = state.items.find(x=> x && x.id === id);
	      const itemName = item && item.name ? String(item.name) : 'this item';
	      if(!(await openConfirmModal('Delete item?', `Delete "${itemName}"?`, { okText:'Delete', cancelText:'Cancel' }))) return;

	      const btnDelete = $('btnEditItemDelete');
	      const btnCancel = $('btnEditItemCancel');
	      if(btnDelete) btnDelete.disabled = true;
	      if(btnCancel) btnCancel.disabled = true;
	      setEditItemMessage('');
	
	      try{
	        await sbDeleteMany([id]);
	        try{ removeOrderLine(id); }catch(e){}
	        await sbLoadSnapshot();
	        closeEditItemModal();
	        toast('Item deleted');
	      }catch(e){
	        const msg = (e && e.message) ? e.message : 'Delete failed';
	        setEditItemMessage(msg);
	        toast(msg);
	      }finally{
	        if(btnDelete) btnDelete.disabled = false;
	        if(btnCancel) btnCancel.disabled = false;
	      }
	    }

	    // Modal editor events
	    const btnEditItemDelete = $('btnEditItemDelete');
	    if(btnEditItemDelete) btnEditItemDelete.addEventListener('click', deleteEditItemModal);
	    const btnEditItemCancel = $('btnEditItemCancel');
	    if(btnEditItemCancel) btnEditItemCancel.addEventListener('click', closeEditItemModal);
	    // Auto-save listeners for edit item modal
	    ['editItemName','editItemDesc','editItemQty'].forEach(id=>{
	      const el = $(id);
	      if(el){
	        el.addEventListener('blur', scheduleEditItemAutoSave);
	        el.addEventListener('change', scheduleEditItemAutoSave);
	      }
	    });
    const btnQtyMinus = $('editItemQtyMinus');
    if(btnQtyMinus) btnQtyMinus.addEventListener('click', ()=> { bumpEditItemQty(-1); scheduleEditItemAutoSave(); });
    const btnQtyPlus = $('editItemQtyPlus');
    if(btnQtyPlus) btnQtyPlus.addEventListener('click', ()=> { bumpEditItemQty(1); scheduleEditItemAutoSave(); });

    const editItemName = $('editItemName');
    if(editItemName) editItemName.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
      if(e.key==='Enter'){
        // On mobile, Enter often means "Done" — move to description instead of saving.
        e.preventDefault();
        $('editItemDesc')?.focus();
      }
    });
    const editItemQty = $('editItemQty');
    if(editItemQty) editItemQty.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
      if(e.key==='Enter'){ e.preventDefault(); autoSaveEditItem().then(()=> closeEditItemModal()); }
    });
	    const editItemDesc = $('editItemDesc');
	    if(editItemDesc) editItemDesc.addEventListener('keydown', e=>{
	      if(e.key==='Escape'){ e.preventDefault(); closeEditItemModal(); }
	      if((e.key==='Enter' || e.key==='NumpadEnter') && (e.metaKey || e.ctrlKey)){
	        e.preventDefault(); autoSaveEditItem().then(()=> closeEditItemModal());
	      }
	    });
	
	    // Low stock modal
	    let _lowStockCtx = null;
	    function closeLowStockModal(){
	      _lowStockCtx = null;
	      show('lowStockModal', false);
	    }
	    function openLowStockModal(id){
	      const item = state.items.find(it => it.id === id);
	      if(!item) return;
	      _lowStockCtx = { id, useGlobal:false };
	
	      const global = getGlobalLowStockQty();
	      const currentOverride = getItemLowStockQtyOverride(item);
	      const currentLabel = (currentOverride === null)
	        ? `This item: Global (${global})`
	        : `This item: ${currentOverride} (override)`;
	
	      const elItem = $('lowStockItemLabel');
	      const elCurrent = $('lowStockCurrentLabel');
	      const elGlobal = $('lowStockGlobalLabel');
	      if(elItem) elItem.textContent = `Item: ${item.name || 'Item'}`;
	      if(elCurrent) elCurrent.textContent = currentLabel;
	      if(elGlobal) elGlobal.textContent = `Global: ${global}`;
	
	      const inp = $('lowStockValue');
	      if(inp) inp.value = (currentOverride === null) ? '' : String(currentOverride);
	
	      const chk = $('lowStockReorderEnabled');
	      if(chk) chk.checked = getItemReorderEnabled(item);
	
	      show('lowStockModal', true);
	    }
	    async function autoSaveLowStock(){
	      if(!_lowStockCtx) return;
	      const modal = $('lowStockModal');
	      if(!modal || modal.getAttribute('aria-hidden') === 'true') return;
	      if(!requireOnline()) return;

	      const id = _lowStockCtx.id;
	      const item = state.items.find(it => it.id === id);
	      if(!item){ return; }

	      const global = getGlobalLowStockQty();
	      const prev = getItemLowStockQtyOverride(item);
	      const prevEnabled = getItemReorderEnabled(item);
	      const prevThr = (prev === null) ? global : prev;

	      const inp = $('lowStockValue');
	      const raw = String(inp && typeof inp.value !== 'undefined' ? inp.value : '').trim();
	      let next = null;
	      if(_lowStockCtx && _lowStockCtx.useGlobal){
	        next = null;
	      }else if(raw !== ''){
	        const n = Number(raw);
	        if(!Number.isFinite(n) || n < 0 || Math.trunc(n) !== n){
	          toast('Low stock qty must be integer ≥ 0');
	          return;
	        }
	        next = Math.trunc(n);
	      }
	      const nextThr = (next === null) ? global : next;
	      const chk = $('lowStockReorderEnabled');
	      const nextEnabled = chk ? !!chk.checked : true;

	      const btnCancel = $('btnLowStockCancel');
	      const btnGlobal = $('btnLowStockUseGlobal');
	      if(btnCancel) btnCancel.disabled = true;
	      if(btnGlobal) btnGlobal.disabled = true;

	      item.lowStockQty = next;
	      item.reorderEnabled = nextEnabled;
	      try{
	        await sbUpdateFields(id, { lowStockQty: next, reorderEnabled: nextEnabled });
	        try{
	          if(prevEnabled === nextEnabled && rowElById(id)){
	            adjustDisplayedLowStockThreshold(item, prevThr, nextThr);
	            syncLowStockOverrideIndicatorForRow(id);
	            syncLowStockIndicatorForRow(id);
	          }
	          else renderTable();
	        }catch(e){}
	        toast('Auto-saved');
	        try{
	          const reportModal = $('reportModal');
	          if(reportModal && reportModal.getAttribute('aria-hidden') === 'false') renderInventoryReport();
	        }catch(e){}
	      }catch(err){
	        item.lowStockQty = prev;
	        item.reorderEnabled = prevEnabled;
	        if(isSchemaCacheMissingColumnError(err, 'low_stock_qty')){
	          showSchemaCacheReloadHelp('items', 'low_stock_qty');
	        }else if(isSchemaCacheMissingColumnError(err, 'reorder_enabled')){
	          showSchemaCacheReloadHelp('items', 'reorder_enabled');
	        }else{
	          toast(err && err.message ? err.message : 'Update failed');
	        }
	      }finally{
	        if(btnCancel) btnCancel.disabled = false;
	        if(btnGlobal) btnGlobal.disabled = false;
	      }
	    }
	    let _lowStockAutoSaveTimer = null;
	    function scheduleLowStockAutoSave(){
	      if(_lowStockAutoSaveTimer) clearTimeout(_lowStockAutoSaveTimer);
	      _lowStockAutoSaveTimer = setTimeout(()=> autoSaveLowStock(), 600);
	    }
	    const btnLowStockCancel = $('btnLowStockCancel');
	    if(btnLowStockCancel) btnLowStockCancel.addEventListener('click', closeLowStockModal);
	    function bumpLowStockValue(delta){
	      const inp = $('lowStockValue'); if(!inp) return;
	      const global = getGlobalLowStockQty();
	      const curRaw = String(inp.value ?? '').trim();
	      const cur = (curRaw === '') ? global : toInt(curRaw, 0);
	      const step = Number.isFinite(Number(delta)) ? Math.trunc(Number(delta)) : 0;
	      const nv = Math.max(0, cur + step);
	      if(_lowStockCtx && _lowStockCtx.useGlobal) _lowStockCtx.useGlobal = false;
	      inp.value = String(nv);
	      const elCurrent = $('lowStockCurrentLabel');
	      if(elCurrent) elCurrent.textContent = `This item: ${nv} (override)`;
	      try{ inp.focus(); }catch(e){}
	    }
	    const btnLowStockMinus = $('lowStockMinus');
	    if(btnLowStockMinus) btnLowStockMinus.addEventListener('click', ()=> { bumpLowStockValue(-1); scheduleLowStockAutoSave(); });
	    const btnLowStockPlus = $('lowStockPlus');
	    if(btnLowStockPlus) btnLowStockPlus.addEventListener('click', ()=> { bumpLowStockValue(1); scheduleLowStockAutoSave(); });
	    const btnLowStockUseGlobal = $('btnLowStockUseGlobal');
	    if(btnLowStockUseGlobal) btnLowStockUseGlobal.addEventListener('click', ()=>{
	      const inp = $('lowStockValue');
	      const global = getGlobalLowStockQty();
	      if(_lowStockCtx) _lowStockCtx.useGlobal = true;
	      if(inp){
	        inp.value = String(global);
	        try{ inp.focus(); }catch(e){}
	      }
	      const elCurrent = $('lowStockCurrentLabel');
	      if(elCurrent) elCurrent.textContent = `This item: Global (${global})`;
	      autoSaveLowStock();
	    });
	    const lowStockValue = $('lowStockValue');
	    if(lowStockValue){
	      lowStockValue.addEventListener('keydown', e=>{
	        if(e.key==='Escape'){ e.preventDefault(); closeLowStockModal(); }
	        if(e.key==='Enter'){ e.preventDefault(); autoSaveLowStock().then(()=> closeLowStockModal()); }
	      });
	      lowStockValue.addEventListener('blur', scheduleLowStockAutoSave);
	      lowStockValue.addEventListener('change', scheduleLowStockAutoSave);
	    }
	    const lowStockReorderChk = $('lowStockReorderEnabled');
	    if(lowStockReorderChk) lowStockReorderChk.addEventListener('change', ()=> autoSaveLowStock());
	    if(lowStockValue) lowStockValue.addEventListener('input', ()=>{
	      if(!_lowStockCtx) return;
	      _lowStockCtx.useGlobal = false;
	      const global = getGlobalLowStockQty();
	      const raw = String(lowStockValue.value ?? '').trim();
	      const elCurrent = $('lowStockCurrentLabel');
	      if(!elCurrent) return;
	      if(raw === ''){
	        elCurrent.textContent = `This item: Global (${global})`;
	        return;
	      }
	      const n = Number(raw);
	      if(Number.isFinite(n) && n >= 0 && Math.trunc(n) === n){
	        elCurrent.textContent = `This item: ${Math.trunc(n)} (override)`;
	      }
	    });

	    // Table Qty +/- (mobile): optimistic UI + debounced commit
	    function toSignedInt(v, f=0){
	      const n = Number(v);
      if(!Number.isFinite(n)) return f;
      return Math.trunc(n);
    }
			    function adjustDisplayedTotalQty(delta){
			      const cur = getTotalsValue('totalQty');
			      if(cur === null) return;
			      setTotalsMetric('totalQty', 'qty', Math.max(0, cur + toSignedInt(delta,0)));
			    }
				    function adjustDisplayedInStock(prevQty, nextQty){
				      const cur = getTotalsValue('totalInStock');
				      if(cur === null) return;
				      const was = toInt(prevQty, 0) > 0;
				      const now = toInt(nextQty, 0) > 0;
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalInStock', 'inStock', Math.max(0, cur + delta));
				    }
				    function adjustDisplayedLowStock(item, prevQty, nextQty){
				      const cur = getTotalsValue('totalLowStock');
				      if(cur === null) return;
				      const thr = effectiveLowStockQty(item);
				      const was = toInt(prevQty, 0) <= thr;
				      const now = toInt(nextQty, 0) <= thr;
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalLowStock', 'lowStock', Math.max(0, cur + delta));
				    }
				    function adjustDisplayedLowStockThreshold(item, prevThr, nextThr){
				      const cur = getTotalsValue('totalLowStock');
				      if(cur === null) return;
				      const qty = toInt(item && item.qty, 0);
				      const was = qty <= toInt(prevThr, 0);
				      const now = qty <= toInt(nextThr, 0);
				      if(was === now) return;
				      const delta = now ? 1 : -1;
				      setTotalsMetric('totalLowStock', 'lowStock', Math.max(0, cur + delta));
				    }
		    function updateQtyCellUIForRow(id, qty){
		      const tr = rowElById(id);
		      const val = tr ? tr.querySelector('td[data-col="qty"] .qty-value') : null;
		      if(val) val.textContent = String(toInt(qty,0));
		    }
    function repositionRowByQty(id){
      const srt = getSort();
      if(!srt || srt.col !== 'qty') return;
      const tb = tbodyEl(); if(!tb) return;
      const tr = rowElById(id); if(!tr) return;
      const it = state.items.find(x=> x.id===id); if(!it) return;
      const myQty = toInt(it.qty,0);
      const myName = toKey(it.name||'');
      const desc = (srt.dir === 'desc');
      const others = Array.from(tb.querySelectorAll('tr[data-id]')).filter(x=> x!==tr);
      let anchor = null;
      for(const r of others){
        const rid = r.dataset.id;
        const o = state.items.find(x=> x.id===rid);
        if(!o) continue;
        const oq = toInt(o.qty,0);
        const on = toKey(o.name||'');
        if(desc){
          if(oq < myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }else{
          if(oq > myQty || (oq === myQty && on > myName)){ anchor = r; break; }
        }
      }
      if(anchor) tb.insertBefore(tr, anchor); else tb.appendChild(tr);
    }
    function queueQtyCommit(id, desiredQty){
      if(!id) return;
      const q = toInt(desiredQty, 0);
      let entry = _qtyCommit.get(id);
      if(!entry){
        entry = { timer:null, desiredQty:q, inFlight:false };
        _qtyCommit.set(id, entry);
      }
      entry.desiredQty = q;
      if(entry.timer) clearTimeout(entry.timer);
      entry.timer = setTimeout(()=> flushQtyCommit(id), 400);
    }
    async function flushQtyCommit(id){
      const entry = _qtyCommit.get(id);
      if(!entry) return;
      entry.timer = null;
      if(entry.inFlight) return;
      entry.inFlight = true;
      const qtyToSend = entry.desiredQty;
      try{
        await sbUpdateFields(id, { qty: qtyToSend });
      }catch(e){
        toast((e && e.message) ? e.message : 'Qty update failed');
        try{ await sbLoadSnapshot(); }catch{}
      }finally{
        entry.inFlight = false;
        if(entry.desiredQty !== qtyToSend){
          queueQtyCommit(id, entry.desiredQty);
        }
      }
    }

    const invTable = $('invTable');
    if(invTable){
      invTable.addEventListener('click', (e)=>{
        const btn = e.target.closest('button.qty-step-btn');
        if(!btn) return;
        const id = String(btn.dataset.id || '').trim();
        const delta = toSignedInt(btn.dataset.delta, 0);
        if(!id || !delta) return;
        if(!requireOnline()) return;
        const it = state.items.find(x=> x.id===id); if(!it) return;
	        const oldQty = toInt(it.qty,0);
	        const newQty = Math.max(0, oldQty + delta);
	        if(newQty === oldQty) return;
		        it.qty = newQty;
		        updateQtyCellUIForRow(id, newQty);
		        adjustDisplayedTotalQty(newQty - oldQty);
		        adjustDisplayedInStock(oldQty, newQty);
		        adjustDisplayedLowStock(it, oldQty, newQty);
		        try{ syncLowStockIndicatorForRow(id); }catch(e){}
		        repositionRowByQty(id);
		        queueQtyCommit(id, newQty);
		      });

      // Mobile UX v2: tray actions (Edit + Low Stock)
      invTable.addEventListener('click', (e)=>{
        const trayBtn = e.target.closest('button.card-tray-btn');
        if(!trayBtn) return;
        const tr = trayBtn.closest('tr[data-id]');
        const id = tr && tr.dataset ? String(tr.dataset.id || '').trim() : '';
        const action = trayBtn.dataset ? String(trayBtn.dataset.trayAction || '').trim() : '';
        if(!id || !action) return;
        e.preventDefault();
        e.stopPropagation();
        closeMobileTray();
        if(!requireOnline()) return;
        if(action === 'edit'){ openEditItemModal(id); return; }
        if(action === 'lowStock'){ openLowStockModal(id); return; }
      });

      // Mobile UX v2: card tap (toggle order) + iMessage-style swipe to reveal tray
      let _mobGesture = null;
      function resetMobGesture(){ _mobGesture = null; }
      function isAnyModalOpen(){
        try{ return !!document.querySelector('.modal[aria-hidden="false"]'); }catch(e){ return false; }
      }
      function findTouchById(list, id){
        try{
          for(let i=0;i<list.length;i++){
            const t = list[i];
            if(t && t.identifier === id) return t;
          }
        }catch(e){}
        return null;
      }

      invTable.addEventListener('pointerdown', (e)=>{
        if(!isMobileUx()) return;
        if(e && e.pointerType === 'touch') return; // prefer touch events for broader mobile compatibility
        if(isAnyModalOpen()) return;

        // If a tray is open, first tap anywhere outside the tray just closes it.
        if(_openTrayId){
          const openTr = rowElById(_openTrayId);
          if(openTr){
            const inTray = !!e.target.closest('.card-tray');
            const sameRow = !!(e.target.closest('tr[data-id]') === openTr);
            if(inTray) return;
            if(!sameRow) closeMobileTray();
          }
          // Stale tray state (row re-rendered)
          else closeMobileTray();
        }

        const tr = e.target.closest('tr[data-id]');
        if(!tr) return;
        const id = String(tr.dataset.id || '').trim();
        if(!id) return;

        // Highest-priority interaction: qty steppers (disable swipe/tap-to-add)
        if(e.target.closest('.qty-stepper--table')) return;

        // Ignore gestures starting from any other interactive control.
        if(e.target.closest('button, input, textarea, select, a')) return;

        const now = performance.now();
        const startSwipeX = getRowSwipeX(tr);
        const startSide = (startSwipeX < 0) ? 'right' : ((startSwipeX > 0) ? 'left' : null);
        _mobGesture = {
          id,
          tr,
          kind: 'pointer',
          pointerId: e.pointerId,
          startX: e.clientX,
          startY: e.clientY,
          startTime: now,
          prevMoveTime: now,
          lastMoveTime: now,
          prevMoveClientX: e.clientX,
          lastMoveClientX: e.clientX,
          startSwipeX,
          swipeX: startSwipeX,
          moved: false,
          intent: null, // 'h' | 'v'
          side: startSide, // 'left' | 'right'
        };
        try{ tr.setPointerCapture(e.pointerId); }catch(e){}
      }, { passive:true });

      invTable.addEventListener('pointermove', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'pointer') return;
        if(e.pointerId !== _mobGesture.pointerId) return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }

        const dx = e.clientX - _mobGesture.startX;
        const dy = e.clientY - _mobGesture.startY;
        const ax = Math.abs(dx);
        const ay = Math.abs(dy);

        // Any meaningful movement cancels a "tap".
        if(ax > 8 || ay > 8) _mobGesture.moved = true;

        if(!_mobGesture.intent){
          if(ax < 10 && ay < 10) return;
          _mobGesture.intent = (ax >= ay) ? 'h' : 'v';
          if(_mobGesture.intent === 'v'){ resetMobGesture(); return; }
        }
        if(_mobGesture.intent !== 'h') return;

        const now = performance.now();
        _mobGesture.prevMoveTime = _mobGesture.lastMoveTime;
        _mobGesture.prevMoveClientX = _mobGesture.lastMoveClientX;
        _mobGesture.lastMoveTime = now;
        _mobGesture.lastMoveClientX = e.clientX;

        const tr = _mobGesture.tr;
        if(!tr || !tr.isConnected){ resetMobGesture(); return; }

        // Elastic resistance when swiping back from detent toward origin
        const startAx = Math.abs(_mobGesture.startSwipeX);
        const isAtDetent = startAx >= SNAP_PX - 10;
        const isSwipingBack = (_mobGesture.startSwipeX < 0 && dx > 0) || (_mobGesture.startSwipeX > 0 && dx < 0);

        let nextX;
        if(isAtDetent && isSwipingBack){
          // Apply damping for sticky/elastic feel (0.35x movement)
          const dampedDx = dx * 0.35;
          nextX = clampNum(_mobGesture.startSwipeX + dampedDx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = true;
        }else{
          nextX = clampNum(_mobGesture.startSwipeX + dx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = false;
        }
        _mobGesture.swipeX = nextX;

        let side = _mobGesture.side;
        if(Math.abs(nextX) > 6) side = (nextX < 0) ? 'right' : 'left';
        else if(!side) side = (dx < 0) ? 'right' : 'left';
        _mobGesture.side = side || 'left';

        prepareMobileTrayForRow(tr, _mobGesture.side);
        tr.classList.add('swiping');
        setRowSwipeX(tr, nextX);
      }, { passive:true });

      invTable.addEventListener('pointerup', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'pointer') return;
        if(e.pointerId !== _mobGesture.pointerId) return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }

        const { id, tr, moved, intent, swipeX, startTime, startX, prevMoveTime, lastMoveTime, prevMoveClientX, lastMoveClientX, closingFromDetent } = _mobGesture;
        resetMobGesture();
        if(!id || !tr) return;

        if(!moved){
          if(_openTrayId === id && tr.classList.contains('tray-open')){
            closeMobileTrayElastic(tr);
            return;
          }
          const item = state.items.find(x => x && x.id === id);
          if(!item) return;
          const ord = orderState();
          const exists = !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && l.id === id));
          if(exists) removeOrderLine(id);
          else upsertOrderLineFromItem(item, 1);
          return;
        }

        if(intent === 'h'){
          tr.classList.remove('swiping');
          const finalX = Number.isFinite(swipeX) ? swipeX : getRowSwipeX(tr);
          const ax = Math.abs(finalX);
          const side = (finalX < 0) ? 'right' : 'left';

          // If user was swiping back from detent, always snap back with elastic animation
          if(closingFromDetent){
            closeMobileTrayElastic(tr);
            return;
          }

          let vx = 0;
          try{
            if(Number.isFinite(lastMoveTime) && Number.isFinite(prevMoveTime) && lastMoveTime > prevMoveTime){
              const dt = lastMoveTime - prevMoveTime;
              vx = dt > 0 ? (lastMoveClientX - prevMoveClientX) / dt : 0;
            }else{
              const tNow = performance.now();
              const dt = tNow - (Number(startTime) || tNow);
              vx = dt > 0 ? (e.clientX - startX) / dt : 0;
            }
          }catch(e){ vx = 0; }

	          const shouldCommitEdit = (side === 'right') && (ax >= COMMIT_PX);
	          if(shouldCommitEdit){
	            closeMobileTray();
	            if(!requireOnline()) return;
	            openEditItemModal(id);
	            return;
	          }

          const fastOpen = (side === 'right') ? (vx <= -0.55) : (vx >= 0.55);
          const fastClose = (side === 'right') ? (vx >= 0.55) : (vx <= -0.55);
          if(fastClose && ax < COMMIT_PX){
            closeMobileTray();
          }else if(ax >= SNAP_PX || (ax >= REVEAL_PX && fastOpen)){
            openMobileTrayForRow(tr, side);
          }else{
            closeMobileTray();
          }
        }
      }, { passive:true });

      invTable.addEventListener('pointercancel', ()=>{
        if(!isMobileUx()) return;
        try{ if(_mobGesture && _mobGesture.tr) _mobGesture.tr.classList.remove('swiping'); }catch(e){}
        try{ closeMobileTray(); }catch(e){}
        resetMobGesture();
      }, { passive:true });

      invTable.addEventListener('touchstart', (e)=>{
        if(!isMobileUx()) return;
        if(isAnyModalOpen()) return;
        if(!e || !e.target) return;

        // If a tray is open, first tap anywhere outside the tray just closes it.
        if(_openTrayId){
          const openTr = rowElById(_openTrayId);
          if(openTr){
            const inTray = !!e.target.closest('.card-tray');
            const sameRow = !!(e.target.closest('tr[data-id]') === openTr);
            if(inTray) return;
            if(!sameRow) closeMobileTray();
          }
          else closeMobileTray();
        }

        const tr = e.target.closest('tr[data-id]');
        if(!tr) return;
        const id = String(tr.dataset.id || '').trim();
        if(!id) return;

        // Highest-priority interaction: qty steppers (disable swipe/tap-to-add)
        if(e.target.closest('.qty-stepper--table')) return;

        // Ignore gestures starting from any other interactive control.
        if(e.target.closest('button, input, textarea, select, a')) return;

        const t = (e.touches && e.touches[0]) ? e.touches[0] : null;
        if(!t) return;
        const now = performance.now();
        const startSwipeX = getRowSwipeX(tr);
        const startSide = (startSwipeX < 0) ? 'right' : ((startSwipeX > 0) ? 'left' : null);
        _mobGesture = {
          id,
          tr,
          kind: 'touch',
          touchId: t.identifier,
          startX: t.clientX,
          startY: t.clientY,
          startTime: now,
          prevMoveTime: now,
          lastMoveTime: now,
          prevMoveClientX: t.clientX,
          lastMoveClientX: t.clientX,
          startSwipeX,
          swipeX: startSwipeX,
          moved: false,
          intent: null, // 'h' | 'v'
          side: startSide, // 'left' | 'right'
        };
      }, { passive:true });

      invTable.addEventListener('touchmove', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'touch') return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }

        const t = findTouchById(e.touches || [], _mobGesture.touchId);
        if(!t) return;

        const dx = t.clientX - _mobGesture.startX;
        const dy = t.clientY - _mobGesture.startY;
        const ax = Math.abs(dx);
        const ay = Math.abs(dy);

        // Any meaningful movement cancels a "tap".
        if(ax > 8 || ay > 8) _mobGesture.moved = true;

        if(!_mobGesture.intent){
          if(ax < 10 && ay < 10) return;
          _mobGesture.intent = (ax >= ay) ? 'h' : 'v';
          if(_mobGesture.intent === 'v'){ resetMobGesture(); return; }
        }
        if(_mobGesture.intent !== 'h') return;

        // Horizontal swipe: prevent scroll once locked.
        try{ e.preventDefault(); }catch(e){}

        const now = performance.now();
        _mobGesture.prevMoveTime = _mobGesture.lastMoveTime;
        _mobGesture.prevMoveClientX = _mobGesture.lastMoveClientX;
        _mobGesture.lastMoveTime = now;
        _mobGesture.lastMoveClientX = t.clientX;

        const tr = _mobGesture.tr;
        if(!tr || !tr.isConnected){ resetMobGesture(); return; }

        // Elastic resistance when swiping back from detent toward origin
        const startAx = Math.abs(_mobGesture.startSwipeX);
        const isAtDetent = startAx >= SNAP_PX - 10;
        const isSwipingBack = (_mobGesture.startSwipeX < 0 && dx > 0) || (_mobGesture.startSwipeX > 0 && dx < 0);

        let nextX;
        if(isAtDetent && isSwipingBack){
          // Apply damping for sticky/elastic feel (0.35x movement)
          const dampedDx = dx * 0.35;
          nextX = clampNum(_mobGesture.startSwipeX + dampedDx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = true;
        }else{
          nextX = clampNum(_mobGesture.startSwipeX + dx, -MAX_PX, MAX_PX);
          _mobGesture.closingFromDetent = false;
        }
        _mobGesture.swipeX = nextX;

        let side = _mobGesture.side;
        if(Math.abs(nextX) > 6) side = (nextX < 0) ? 'right' : 'left';
        else if(!side) side = (dx < 0) ? 'right' : 'left';
        _mobGesture.side = side || 'left';

        prepareMobileTrayForRow(tr, _mobGesture.side);
        tr.classList.add('swiping');
        setRowSwipeX(tr, nextX);
      }, { passive:false });

      invTable.addEventListener('touchend', (e)=>{
        if(!isMobileUx()) return;
        if(!_mobGesture) return;
        if(_mobGesture.kind !== 'touch') return;
        if(isAnyModalOpen()){ resetMobGesture(); return; }
        const ended = findTouchById(e.changedTouches || [], _mobGesture.touchId);
        if(!ended) return;
        try{ e.preventDefault(); }catch(e){}

        const { id, tr, moved, intent, swipeX, startTime, startX, prevMoveTime, lastMoveTime, prevMoveClientX, lastMoveClientX, closingFromDetent } = _mobGesture;
        resetMobGesture();
        if(!id || !tr) return;

        if(!moved){
          if(_openTrayId === id && tr.classList.contains('tray-open')){
            closeMobileTrayElastic(tr);
            return;
          }
          const item = state.items.find(x => x && x.id === id);
          if(!item) return;
          const ord = orderState();
          const exists = !!(ord && Array.isArray(ord.lines) && ord.lines.some(l => l && l.id === id));
          if(exists) removeOrderLine(id);
          else upsertOrderLineFromItem(item, 1);
          return;
        }

        if(intent === 'h'){
          tr.classList.remove('swiping');
          const finalX = Number.isFinite(swipeX) ? swipeX : getRowSwipeX(tr);
          const ax = Math.abs(finalX);
          const side = (finalX < 0) ? 'right' : 'left';

          // If user was swiping back from detent, always snap back with elastic animation
          if(closingFromDetent){
            closeMobileTrayElastic(tr);
            return;
          }

          let vx = 0;
          try{
            if(Number.isFinite(lastMoveTime) && Number.isFinite(prevMoveTime) && lastMoveTime > prevMoveTime){
              const dt = lastMoveTime - prevMoveTime;
              vx = dt > 0 ? (lastMoveClientX - prevMoveClientX) / dt : 0;
            }else{
              const tNow = performance.now();
              const dt = tNow - (Number(startTime) || tNow);
              vx = dt > 0 ? (ended.clientX - startX) / dt : 0;
            }
          }catch(e){ vx = 0; }

	          const shouldCommitEdit = (side === 'right') && (ax >= COMMIT_PX);
	          if(shouldCommitEdit){
	            closeMobileTray();
	            if(!requireOnline()) return;
	            openEditItemModal(id);
	            return;
	          }

          const fastOpen = (side === 'right') ? (vx <= -0.55) : (vx >= 0.55);
          const fastClose = (side === 'right') ? (vx >= 0.55) : (vx <= -0.55);
          if(fastClose && ax < COMMIT_PX){
            closeMobileTray();
          }else if(ax >= SNAP_PX || (ax >= REVEAL_PX && fastOpen)){
            openMobileTrayForRow(tr, side);
          }else{
            closeMobileTray();
          }
        }
      }, { passive:false });

      invTable.addEventListener('touchcancel', ()=>{
        if(!isMobileUx()) return;
        try{ if(_mobGesture && _mobGesture.tr) _mobGesture.tr.classList.remove('swiping'); }catch(e){}
        try{ closeMobileTray(); }catch(e){}
        resetMobGesture();
      }, { passive:true });
		    }

	    function startCellEdit(td, ev){
	      // If the user tapped a control inside the cell, don't open an editor.
	      if(ev && ev.target && ev.target.closest('button, input, textarea, select, a')) return;
	      if(td.querySelector('input')) return;
	      if(isMobileUx()) return;
	      const col=td.getAttribute('data-col'); if(!col) return;
	      const tr=td.closest('tr'); const id=tr?.dataset?.id; if(!id) return;
	      const it=state.items.find(x=> x.id===id); if(!it) return;

      if(prefersModalEditing()){
        if(!requireOnline()) return;
        openEditItemModal(id);
        return;
      }

      if(!requireOnline()) return;
      const fb = $('filterBox'); if (fb) fb.value = '';
	      state._filter = '';
	      try{ updateFilterClearBtn(); }catch(e){}

	      const oldVal = (col==='qty'? String(toInt(it.qty,0)) : String(col==='name'?it.name:(it.desc||'')));
	      const prevName = String(it.name||'');
	      const prevDesc = String(it.desc||'');
	      const prevQty = toInt(it.qty,0);
	      const inp=document.createElement('input');
	      inp.type = (col==='qty')? 'number' : 'text';
	      if(col==='qty'){ inp.min='0'; inp.step='1'; inp.inputMode='numeric'; inp.pattern='[0-9]*'; inp.setAttribute('enterkeyhint','done'); }
	      inp.value = oldVal; inp.autocapitalize='off'; inp.autocomplete='off'; inp.spellcheck=false;
	      td.classList.add('editing'); td.innerHTML=''; td.appendChild(inp);
	      setTimeout(()=>{ inp.focus(); inp.select(); }, 0);

	      let _done = false;
	      const restore = ()=>{
	        if(_done) return;
	        _done = true;
	        td.classList.remove('editing');
	        if(col==='qty') td.innerHTML = qtyCellHTML(it);
	        else td.innerHTML = '<span class="cell-val">' + escapeHtml((col==='name') ? String(it.name||'') : String(it.desc||'')) + '</span>';
	      };
	      const cancel=()=>{
	        it.name = prevName;
	        it.desc = prevDesc;
	        it.qty = prevQty;
	        restore();
	      };

	      const commit = async () => {
	        if(_done) return;
	        const raw = inp.value;
	        try{
	          if(col==='name'){
	            const nv = String(raw||'').trim();
	            if(!nv){ cancel(); toast('Name required'); return; }
	            if(nv === prevName){ cancel(); return; }
	            if(toKey(nv)!==toKey(prevName) && state.items.some(x=> x.id!==id && toKey(x.name)===toKey(nv))){ cancel(); toast('Duplicate name'); return; }
	            it.name = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'name') renderTable();
	            await sbUpdateFields(id, { name: nv });
	            return;
	          }
	          if(col==='desc'){
	            const nv = String(raw||'').replace(/[\r\n]+/g,' ').trim();
	            const pv = String(prevDesc||'').replace(/[\r\n]+/g,' ').trim();
	            if(nv === pv){ cancel(); return; }
	            it.desc = nv;
	            restore();
	            const srt = getSort();
	            if(srt && srt.col === 'desc') renderTable();
	            await sbUpdateFields(id, { desc: nv });
	            return;
	          }
			          if(col==='qty'){
			            const q = toInt(raw, -1);
			            if(q < 0){ cancel(); toast('Qty must be integer ≥ 0'); return; }
			            if(q === prevQty){ cancel(); return; }
			            it.qty = q;
			            restore();
			            adjustDisplayedTotalQty(q - prevQty);
			            adjustDisplayedInStock(prevQty, q);
			            adjustDisplayedLowStock(it, prevQty, q);
			            repositionRowByQty(id);
			            queueQtyCommit(id, q);
			            try{ syncLowStockIndicatorForRow(id); }catch(e){}
			            return;
			          }
	          cancel();
	        }catch(e){
	          it.name = prevName;
	          it.desc = prevDesc;
	          it.qty = prevQty;
	          try{ renderTable(); }catch(_){}
	          toast((e && e.message) ? e.message : 'Update failed');
	          try{ await sbLoadSnapshot(); }catch{}
	        }
	      };

	      inp.addEventListener('keydown', e=>{
	        if(e.key==='Enter'){ e.preventDefault(); commit(); }
	        if(e.key==='Escape'){ e.preventDefault(); cancel(); }
	      });
	      inp.addEventListener('blur', commit);
	    }

    // ========================
    // Hamburger Menu Toggle
    // ========================
    const hamburgerBtn = $('hamburgerBtn');
    const menuDropdown = $('menuDropdown');
    const menuBackdrop = $('menuBackdrop');

    function toggleMenu(open) {
      const isOpen = open !== undefined ? open : !menuDropdown.classList.contains('open');
      hamburgerBtn.classList.toggle('open', isOpen);
      menuDropdown.classList.toggle('open', isOpen);
      menuBackdrop.classList.toggle('open', isOpen);
      hamburgerBtn.setAttribute('aria-expanded', isOpen);
    }

    hamburgerBtn.addEventListener('click', () => toggleMenu());
    menuBackdrop.addEventListener('click', () => toggleMenu(false));

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && menuDropdown.classList.contains('open')) {
        toggleMenu(false);
      }
    });

    // ========================
    // Import / Paste / Export
    // ========================
    $('menuImport').addEventListener('click', ()=> { toggleMenu(false); if(!requireOnline()) return; $('#fileImport').click(); });
    $('#fileImport').addEventListener('change', async ev=>{
      if(!requireOnline()){ ev.target.value=''; return; }
      const f=ev.target.files[0]; if(!f) return; await handleFile(f); ev.target.value='';
    });

    $('menuPaste').addEventListener('click', ()=>{ toggleMenu(false); if(!requireOnline()) return; $('#pasteArea').value=''; show('pasteModal', true); });
    $('btnPasteCancel').addEventListener('click', ()=> show('pasteModal', false));
    $('btnPasteApply').addEventListener('click', ()=>{
      if(!requireOnline()) return;
      const text=$('#pasteArea').value||''; if(!text.trim()){ toast('Nothing to import'); return; }
      const rows=parseDelimitedSmart(text); const items=rowsToItems(rows);
      if(!items.length){ toast('Could not detect headers or rows'); return; }
      show('pasteModal', false);
      showPreview(items);
    });

    const drop=$('#dropZone');
    drop.addEventListener('dragover', e=>{ e.preventDefault(); drop.style.background='#0e1621'; });
    drop.addEventListener('dragleave', ()=>{ drop.style.background=''; });
    drop.addEventListener('drop', async e=>{
      e.preventDefault(); drop.style.background=''; if(!requireOnline()) return; const f=e.dataTransfer.files[0]; if(f) await handleFile(f);
    });

    $('#fileImportModal').addEventListener('change', async ev=>{ if(!requireOnline()){ ev.target.value=''; return; } const f=ev.target.files[0]; if(f) await handleFile(f); ev.target.value=''; });

    async function handleFile(f){
      if(!requireOnline()) return;
      try{
        const items=await parseAnyFile(f);
        if(!items.length){ toast('No rows found in file'); return; }
        show('pasteModal', false);
        showPreview(items);
      }catch(err){ toast(err.message||'Import failed'); }
    }
    function buildPreview(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      const rows=[]; let add=0, upd=0, same=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        const it=index.get(k);
        if(!it){ rows.push({name:r.name, desc:r.desc||'', oldQty:'—', newQty:toInt(r.qty,0), action:'Add'}); add++; }
        else{
          const oldQ=toInt(it.qty,0), newQ=toInt(r.qty,0);
          const act = (oldQ===newQ && (r.desc||'').trim()===String(it.desc||'').trim())? 'No change' : 'Update';
          if(act==='Update') upd++; else same++;
          rows.push({name:it.name, desc:(r.desc||it.desc||''), oldQty:oldQ, newQty:newQ, action:act});
        }
      }
      return {rows, add, upd, same, total: imported.length};
    }
    function showPreview(imported){
      const pv=buildPreview(imported);
      const info=$('previewInfo'); if(info){ info.textContent = `${pv.total} row(s): ${pv.add} add, ${pv.upd} update, ${pv.same} unchanged`; }
      const tbody=$('previewBody'); if(tbody){
        tbody.innerHTML='';
        for(const r of pv.rows){
          const tr=document.createElement('tr');
          tr.innerHTML =
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.name)}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${escapeHtml(r.desc||'')}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.oldQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border);text-align:right">${r.newQty}</td>`+
            `<td style="padding:8px;border-bottom:1px solid var(--border)">${r.action}</td>`;
          tbody.appendChild(tr);
        }
      }
      state._pendingImport = imported;
      show('previewModal', true);
    }
    $('btnPreviewCancel').addEventListener('click', ()=>{ state._pendingImport=null; show('previewModal', false); });
    $('btnPreviewApply').addEventListener('click', async ()=>{
      if(!requireOnline()) return;
      const imp = state._pendingImport||[]; state._pendingImport=null; show('previewModal', false);
      if(!imp.length){ toast('Nothing to import'); return; }
      try{
        await sbUpsertMany(imp);
        await sbLoadSnapshot();
        toast('Import applied');
      }catch(e){ toast(e.message || 'Import failed'); }
    });

	    $('menuExport').addEventListener('click', ()=>{
	      toggleMenu(false);
	      const rows=[["Item","Description","Qty"]];
	      for(const it of state.items){ rows.push([it.name||'', it.desc||'', String(toInt(it.qty,0))]); }
	      const csv = rows.map(r=> r.map(v=> '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
	      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
	      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='inventory.csv'; a.click(); URL.revokeObjectURL(url);
	    });

			    // ========================
			    // Inventory report
			    // ========================
			    function getGlobalLowStockQty(){
		      try{
		        if(SB && SB.profile && typeof SB.profile.low_stock_qty_global !== 'undefined'){
		          const v = Number(SB.profile.low_stock_qty_global);
	          if(Number.isFinite(v) && v >= 0) return Math.trunc(v);
	        }
	      }catch(e){}
	      try{
	        const raw = localStorage.getItem('inv.pref.lowStockQtyGlobal');
	        const v = Number(raw);
	        if(Number.isFinite(v) && v >= 0) return Math.trunc(v);
	      }catch(e){}
	      return 0;
	    }
	    function getItemLowStockQtyOverride(item){
	      if(!item) return null;
	      const v = Object.prototype.hasOwnProperty.call(item, 'lowStockQty') ? item.lowStockQty : null;
	      if(v === null || typeof v === 'undefined') return null;
	      const n = Number(v);
	      if(!Number.isFinite(n)) return null;
	      const i = Math.trunc(n);
	      if(i < 0) return null;
	      return i;
	    }
	    function getItemReorderEnabled(item){
	      if(!item) return true;
	      if(!Object.prototype.hasOwnProperty.call(item, 'reorderEnabled')) return true;
	      return !!item.reorderEnabled;
	    }
	    function effectiveLowStockQty(item){
	      const override = getItemLowStockQtyOverride(item);
	      return override !== null ? override : getGlobalLowStockQty();
	    }
	    function isLowStockItem(item){
	      if(!getItemReorderEnabled(item)) return false;
	      const qty = toInt(item && item.qty, 0);
	      const thr = effectiveLowStockQty(item);
	      return qty <= thr;
	    }
	    function reportDataSnapshot(){
	      const all = (Array.isArray(state.items) ? state.items : [])
	        .filter(Boolean)
		        .map(it => ({
		          id: it.id,
		          name: String(it.name||''),
		          desc: String(it.desc||''),
		          qty: toInt(it.qty,0),
		          lowStockQty: getItemLowStockQtyOverride(it),
		          reorderEnabled: getItemReorderEnabled(it),
		        }))
	        .sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
	      const totalItems = all.length;
	      const totalQty = all.reduce((sum, it) => sum + toInt(it.qty,0), 0);
	      const inStock = all.filter(it => toInt(it.qty,0) > 0);
	      const lowStock = all.filter(it => isLowStockItem(it));
	      return {
	        all,
	        inStock,
	        lowStock,
	        totalItems,
	        totalQty,
	        inStockCount: inStock.length,
	        lowStockCount: lowStock.length,
	      };
	    }
	    function reportCsvEscape(value){
	      const s = String(value ?? '');
	      return '"' + s.replace(/"/g, '""') + '"';
	    }
	    function buildInventoryReportCsv(data){
	      const d = data || reportDataSnapshot();
	      const out = [];
	      out.push(['Item','Description','Qty','In Stock'].map(reportCsvEscape).join(','));
	      for(const it of d.all){
	        out.push([
	          it.name || '',
	          String(it.desc||'').replace(/[\r\n]+/g,' ').trim(),
	          String(toInt(it.qty,0)),
	          toInt(it.qty,0) > 0 ? 'Yes' : 'No',
	        ].map(reportCsvEscape).join(','));
	      }
	      return out.join('\n');
	    }
	    function buildInventoryReportText(data, opts = {}){
	      const d = data || reportDataSnapshot();
	      const maxLines = Math.max(10, Math.min(500, toInt(opts.maxLines, 180)));
	      const out = [];
	      const when = formatEasternDateTime(new Date());
	      out.push(`Inventory Report`);
	      out.push(`Generated: ${when}`);
	      out.push('');
	      out.push(`Total Items: ${d.totalItems}`);
	      out.push(`In Stock: ${d.inStockCount}`);
	      out.push(`Low Stock: ${d.lowStockCount}`);
	      out.push(`Total Qty: ${d.totalQty}`);
	      out.push('');
	      out.push('Inventory:');
	      out.push('');
	      if(!d.all.length){
	        out.push('(none)');
	        return out.join('\n');
	      }
	      let linesUsed = out.length;
	      for(const it of d.all){
	        if(linesUsed >= maxLines){
	          out.push('');
	          out.push(`(trimmed; use CSV for full report)`);
	          break;
	        }
	        const qty = toInt(it.qty,0);
	        const desc = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
	        out.push(`${it.name}\t${qty}\t${desc}`);
	        linesUsed++;
	      }
	      return out.join('\n');
	    }
	
	    function reportTableHtml(items, opts = {}){
	      const rows = Array.isArray(items) ? items : [];
	      const showThreshold = !!opts.showThreshold;
	      let html = '<table class="report-table" role="table">';
	      html += '<thead><tr>';
	      html += '<th>Item</th>';
	      html += '<th>Description</th>';
	      html += '<th class="qty">Qty</th>';
	      if(showThreshold) html += '<th class="thr">Low</th>';
	      html += '</tr></thead><tbody>';
	      for(const it of rows){
	        const name = escapeHtml(it && it.name ? it.name : '');
	        const descRaw = String(it && it.desc ? it.desc : '').replace(/[\r\n]+/g,' ').trim();
	        const desc = escapeHtml(descRaw);
	        const qty = toInt(it && it.qty, 0);
	        html += '<tr>';
	        html += `<td class="item">${name}</td>`;
	        html += `<td class="desc">${desc}</td>`;
	        html += `<td class="qty">${qty}</td>`;
	        if(showThreshold){
	          const thr = effectiveLowStockQty(it);
	          html += `<td class="thr">${toInt(thr,0)}</td>`;
	        }
	        html += '</tr>';
	      }
	      html += '</tbody></table>';
	      return html;
	    }
	    function reportOrderHasItem(id){
	      const ord = orderState();
	      const key = String(id || '').trim();
	      return !!(key && ord && Array.isArray(ord.lines) && ord.lines.some(l => String(l && l.id ? l.id : '').trim() === key));
	    }
	    function reportRowButtonHtml(item, opts = {}){
	      const it = item || {};
	      const id = String(it.id || '').trim();
	      if(!id) return '';
	      const safeId = id.replace(/"/g, '&quot;');
	      const name = escapeHtml(String(it.name || '').trim());
	      const descRaw = String(it.desc || '').replace(/[\r\n]+/g,' ').trim();
	      const desc = escapeHtml(descRaw);
	      const qty = toInt(it.qty, 0);
	      const showThreshold = !!opts.showThreshold;
	      const thr = showThreshold ? toInt(effectiveLowStockQty(it), 0) : null;
	      const selected = reportOrderHasItem(id);
	      const dotClass = selected ? 'led-dot--green' : 'led-dot--off';
	      const pressed = selected ? 'true' : 'false';

	      return (
	        `<button type="button" class="report-row" data-report-order-id="${safeId}" aria-pressed="${pressed}">`+
	          `<div class="report-row-main">`+
	            `<div class="report-item">`+
	              `<span class="led-dot ${dotClass}" aria-hidden="true"></span>`+
	              `<span class="report-item-name">${name}</span>`+
	            `</div>`+
	            (desc ? `<div class="report-desc">${desc}</div>` : ``)+
	          `</div>`+
	          `<div class="report-qty">`+
	            `${qty}`+
	            (showThreshold ? `<div class="muted">Low: ${thr}</div>` : ``)+
	          `</div>`+
	        `</button>`
	      );
	    }
	    function reportRowsHtml(items, opts = {}){
	      const rows = Array.isArray(items) ? items : [];
	      if(!rows.length){
	        const emptyText = (opts && typeof opts.emptyText === 'string') ? opts.emptyText : 'No items.';
	        return `<div class="order-empty">${escapeHtml(emptyText)}</div>`;
	      }
	      const sepText = (opts && typeof opts.separatorText === 'string') ? opts.separatorText : 'Not in Cart';
	      const selected = [];
	      const rest = [];
	      for(const it of rows){
	        const id = String(it && it.id ? it.id : '').trim();
	        if(id && reportOrderHasItem(id)) selected.push(it);
	        else rest.push(it);
	      }
	      let html = '';
	      if(selected.length) html += selected.map(it => reportRowButtonHtml(it, opts)).join('');
	      if(selected.length && rest.length){
	        html += `<div class="report-separator" role="separator"><span>${escapeHtml(sepText)}</span></div>`;
	      }
	      if(rest.length) html += rest.map(it => reportRowButtonHtml(it, opts)).join('');
	      return html;
	    }
	    function updateReportOrderBadge(){
	      const modal = $('reportModal');
	      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
	      const pillContainer = $('reportOrderPillContainer');
	      const pill = $('reportOrderBadge');
	      const valueEl = $('reportOrderCount');
	      if(!pillContainer || !pill || !valueEl) return;
	      const ord = orderState();
	      const count = Array.isArray(ord.lines) ? ord.lines.length : 0;
	      if(count > 0){
	        pillContainer.style.display = 'flex';
	        valueEl.textContent = String(count);
	        const labelEl = pill.querySelector('.order-pill-label');
	        if(labelEl) labelEl.textContent = count === 1 ? 'Item in Cart' : 'Items in Cart';
	      }else{
	        pillContainer.style.display = 'none';
	        valueEl.textContent = '0';
	      }
	    }
	    function syncReportOrderIndicators(){
	      const modal = $('reportModal');
	      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
	      const ord = orderState();
	      const ids = new Set((Array.isArray(ord.lines) ? ord.lines : []).map(l => String(l && l.id ? l.id : '').trim()).filter(Boolean));
	      document.querySelectorAll('[data-report-order-id]').forEach(el=>{
	        const id = String(el.dataset && el.dataset.reportOrderId ? el.dataset.reportOrderId : '').trim();
	        if(!id) return;
	        const selected = ids.has(id);
	        el.setAttribute('aria-pressed', selected ? 'true' : 'false');
	        const dot = el.querySelector('.led-dot');
	        if(dot){
	          dot.classList.toggle('led-dot--green', selected);
	          dot.classList.toggle('led-dot--off', !selected);
	        }
	      });
	      updateReportOrderBadge();
	    }
		    function renderInventoryReport(){
		      const d = reportDataSnapshot();
		      const elTotal = $('reportMetricTotalItems'); if(elTotal) elTotal.textContent = String(d.totalItems);
		      const elQty = $('reportMetricTotalQty'); if(elQty) elQty.textContent = String(d.totalQty);
		      const elLowCount = $('reportLowStockCount'); if(elLowCount) elLowCount.textContent = `(${d.lowStockCount})`;
		      const elInCount = $('reportInStockCount'); if(elInCount) elInCount.textContent = `(${d.inStockCount})`;

		      const lowSection = $('reportLowStockSection');
		      const lowList = $('reportLowStockList');
		      if(lowSection && lowList){
		        lowList.innerHTML = reportRowsHtml(d.lowStock, { showThreshold:true, emptyText:'No low stock items.' });
		      }

	      const list = $('reportList');
	      if(list){
	        list.innerHTML = reportRowsHtml(d.inStock, { showThreshold:false, emptyText:'No in-stock items.' });
	      }
	      updateReportOrderBadge();
	    }
		    function downloadInventoryReportCsv(){
		      try{
		        const csv = buildInventoryReportCsv(reportDataSnapshot());
		        const stamp = new Date().toISOString().slice(0,10);
	        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
	        const url = URL.createObjectURL(blob);
	        const a = document.createElement('a');
	        a.href = url;
	        a.download = `inventory-report-${stamp}.csv`;
	        document.body.appendChild(a);
	        a.click();
	        document.body.removeChild(a);
	        URL.revokeObjectURL(url);
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Download failed');
		      }
		    }
		    function inventoryReportEmailTableHtml(items, opts = {}){
		      const rows = Array.isArray(items) ? items : [];
		      const showThreshold = !!opts.showThreshold;

		      const th = (label, alignRight) => (
		        `<th style="padding:10px;border:1px solid #d0d7de;${alignRight ? 'text-align:right;' : 'text-align:left;'}background:#f6f8fa;font-size:12px;text-transform:uppercase;letter-spacing:.06em;">${label}</th>`
		      );
		      const td = (value, alignRight, extra = '') => (
		        `<td style="padding:10px;border:1px solid #d0d7de;${alignRight ? 'text-align:right;font-variant-numeric:tabular-nums;font-weight:700;' : 'text-align:left;'}${extra}">${value}</td>`
		      );

		      let html = `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;">`;
		      html += `<thead><tr>`;
		      html += th('Item', false);
		      html += th('Description', false);
		      html += th('Qty', true);
		      if(showThreshold) html += th('Low', true);
		      html += `</tr></thead><tbody>`;

		      for(const it of rows){
		        const name = escapeHtml(it && it.name ? it.name : '');
		        const descRaw = String(it && it.desc ? it.desc : '').replace(/[\r\n]+/g,' ').trim();
		        const desc = escapeHtml(descRaw);
		        const qty = toInt(it && it.qty, 0);
		        html += `<tr>`;
		        html += td(`<strong>${name}</strong>`, false, 'word-break:break-word;overflow-wrap:anywhere;');
		        html += td(desc, false, 'word-break:break-word;overflow-wrap:anywhere;');
		        html += td(String(qty), true, '');
		        if(showThreshold){
		          const thr = effectiveLowStockQty(it);
		          html += td(String(toInt(thr,0)), true, '');
		        }
		        html += `</tr>`;
		      }

		      html += `</tbody></table>`;
		      return html;
		    }
		    function buildInventoryReportEmailHtml(data){
		      const d = data || reportDataSnapshot();
		      const when = formatEasternDateTime(new Date());
		      const global = getGlobalLowStockQty();

		      const metricsRow = (label, val) => (
		        `<tr>`+
		          `<td style="padding:8px 10px;border:1px solid #d0d7de;background:#f6f8fa;font-weight:700;">${label}</td>`+
		          `<td style="padding:8px 10px;border:1px solid #d0d7de;text-align:right;font-variant-numeric:tabular-nums;font-weight:800;">${val}</td>`+
		        `</tr>`
		      );

		      const metricsTable =
		        `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;margin:12px 0 18px;">`+
		          `<tbody>`+
		            metricsRow('Total Items', String(d.totalItems))+
		            metricsRow('In Stock', String(d.inStockCount))+
		            metricsRow('Low Stock', String(d.lowStockCount))+
		            metricsRow('Total Qty', String(d.totalQty))+
		          `</tbody>`+
		        `</table>`;

		      const lowStockBlock = d.lowStock && d.lowStock.length
		        ? (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Low Stock Items</div>`+
		            inventoryReportEmailTableHtml(d.lowStock, { showThreshold:true })+
		          `</div>`
		        )
		        : '';

		      const inventoryBlock = d.inStock && d.inStock.length
		        ? (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Current Inventory</div>`+
		            inventoryReportEmailTableHtml(d.inStock, { showThreshold:false })+
		          `</div>`
		        )
		        : (
		          `<div style="margin:0 0 18px;">`+
		            `<div style="font-weight:800;font-size:14px;margin:0 0 8px;">Current Inventory</div>`+
		            `<div style="color:#57606a;">No in-stock items.</div>`+
		          `</div>`
		        );

		      return (
		        `<!doctype html>`+
		        `<html><body style="margin:0;padding:0;background:#ffffff;">`+
		          `<div style="max-width:760px;margin:0 auto;padding:18px 16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.35;">`+
		            `<h2 style="margin:0 0 10px;font-size:18px;">Inventory Report</h2>`+
		            `<div style="font-size:13px;color:#444;margin:0 0 6px;"><strong>Generated:</strong> ${escapeHtml(when)}</div>`+
		            `${metricsTable}`+
		            `${lowStockBlock}`+
		            `${inventoryBlock}`+
		            `<div style="margin-top:18px;font-size:12px;color:#6a737d;">Built by james.johns83@gmail.com for Oakley Services, LLC | v${escapeHtml(APP_VERSION)}</div>`+
		          `</div>`+
		        `</body></html>`
		      );
		    }

		    let _reportEmailHtml = '';
		    function setReportEmailMessage(msg){
		      const el = $('reportEmailMsg');
		      if(el) el.textContent = String(msg || '');
		    }
		    function renderReportEmailPreview(html){
		      const wrap = $('reportEmailPreview');
		      if(!wrap) return;
		      const safe = String(html || '').replace(/"/g, '&quot;');
		      wrap.innerHTML = `<iframe srcdoc="${safe}" sandbox="allow-same-origin"></iframe>`;
		    }
		    function defaultInventoryReportEmailSubject(){
		      const stamp = new Date().toISOString().slice(0,10);
		      return `Inventory Report (${stamp})`;
		    }
		    function openReportEmailModal(){
		      const data = reportDataSnapshot();
		      _reportEmailHtml = buildInventoryReportEmailHtml(data);
		      const to = $('reportEmailTo');
		      const subject = $('reportEmailSubject');
		      if(subject) subject.value = defaultInventoryReportEmailSubject();
		      if(to && !String(to.value || '').trim()){
		        const signed = getSignedInEmail();
		        if(signed) to.value = signed;
		      }
		      renderReportEmailPreview(_reportEmailHtml);
		      setReportEmailMessage('');
		      show('reportEmailModal', true);
		    }
		    function closeReportEmailModal(){
		      show('reportEmailModal', false);
		      setReportEmailMessage('');
		    }
		    async function sendInventoryReportEmailViaApi({ toEmail, subjectLine, html }){
		      const to = String(toEmail || '').trim();
		      const subject = String(subjectLine || '').trim() || defaultInventoryReportEmailSubject();
		      const replyTo = getSignedInEmail();
		      const apiUrl = getOrderApiUrl();

		      const headers = { 'content-type': 'application/json' };
		      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
		      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
		      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
		        headers['apikey'] = sbKey;
		        if(SB.session && SB.session.access_token){
		          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
		        }
		      }

		      const res = await fetch(apiUrl, {
		        method: 'POST',
		        headers,
		        body: JSON.stringify({ to, subject, html: String(html || ''), replyTo }),
		      });
		      let data = null;
		      try { data = await res.json(); } catch {}
		      if(!res.ok || !data || data.ok !== true){
		        const msg = (data && data.error) ? String(data.error) : `Send failed (${res.status})`;
		        throw Object.assign(new Error(msg), { status: res.status, data });
		      }
		      return data;
		    }

		    async function shareInventoryReport(){
		      openReportEmailModal();
		    }
		    function lowStockAlertsSilenced(){
		      try{
		        if(SB && SB.profile && typeof SB.profile.silence_low_stock_alerts !== 'undefined'){
		          return !!SB.profile.silence_low_stock_alerts;
		        }
	      }catch(e){}
	      try{
	        const raw = localStorage.getItem('inv.pref.silenceLowStockAlerts');
	        return raw === '1' || raw === 'true';
		      }catch(e){ return false; }
		    }
		    let _reportLoadToken = 0;
		    function setReportLoading(isLoading){
		      const prog = $('reportProgress');
		      const content = $('reportContent');
		      if(prog) prog.style.display = isLoading ? 'block' : 'none';
		      if(content) content.style.display = isLoading ? 'none' : 'block';
		    }
		    function setReportProgress(progress, label){
		      const p = Math.max(0, Math.min(100, Math.round(Number(progress) || 0)));
		      const labelEl = $('reportProgressLabel');
		      const valueEl = $('reportProgressValue');
		      const barEl = $('reportProgressBar');
		      const trackEl = $('reportProgress')?.querySelector('.report-progress-track');
		      if(labelEl && typeof label === 'string') labelEl.textContent = label;
		      if(valueEl) valueEl.textContent = `${p}%`;
		      if(barEl) barEl.style.width = `${p}%`;
		      if(trackEl) trackEl.setAttribute('aria-valuenow', String(p));
		    }
		    function simulateReportProgress(token){
		      let progress = 0;
		      const baseMs = 1000;
		      const phaseOneTarget = 40 + Math.random() * 10; // 40–50%
		      let phaseTwo = false;
		      let label = 'Analyzing Low Stock Items...';
		      const start = performance.now();
		      setReportProgress(0, label);

		      const tick = () => {
		        if(token !== _reportLoadToken) return;
		        const modal = $('reportModal');
		        if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;

		        const elapsed = performance.now() - start;
		        const timeCap = Math.min(100, (elapsed / baseMs) * 100 + 12);
		        const increment = (Math.random() * 9) + 3; // 3–12%
		        progress = Math.min(progress + increment, timeCap, 100);

		        if(!phaseTwo && progress >= phaseOneTarget){
		          phaseTwo = true;
		          label = 'Generating Current Inventory...';
		        }
		        setReportProgress(progress, label);

		        if(progress >= 100 || elapsed >= baseMs){
		          setReportProgress(100, label);
		          finishReportLoad(token);
		          return;
		        }

		        let delay = (Math.random() * 100) + 50; // 50–150ms
		        if(Math.random() < 0.14) delay += (Math.random() * 250) + 200; // occasional pause
		        setTimeout(tick, delay);
		      };
		      tick();
		    }
		    function finishReportLoad(token){
		      if(token !== _reportLoadToken) return;
		      setReportLoading(false);
		      renderInventoryReport();
		      const lowSection = $('reportLowStockSection'); if(lowSection) lowSection.open = false;
		      const invSection = $('reportInventorySection'); if(invSection) invSection.open = false;
		      try{ syncReportOrderIndicators(); }catch(e){}
		    }
		    function startReportLoad(){
		      _reportLoadToken++;
		      const token = _reportLoadToken;
		      setReportLoading(true);
		      const lowSection = $('reportLowStockSection'); if(lowSection) lowSection.open = false;
		      const invSection = $('reportInventorySection'); if(invSection) invSection.open = false;
		      simulateReportProgress(token);
		    }
				    function openReportModal(){
				      show('reportModal', true);
				      startReportLoad();
				    }
		    function closeReportModal(){
		      _reportLoadToken++;
		      show('reportModal', false);
		    }

	    // ========================
	    // Order engine (email-based)
	    // ========================
	    function getSignedInEmail(){
      return (SB && SB.user && SB.user.email) ? String(SB.user.email).trim() : '';
    }
    function userNameFromEmail(email){
      const e = String(email || '').trim();
      const local = e.includes('@') ? e.split('@')[0] : e;
      const cleaned = local
        .replace(/[._-]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
      if(!cleaned) return '';
      return cleaned
        .split(' ')
        .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : '')
        .join(' ')
        .trim();
    }
    function formatStateToken(token){
      const t = String(token || '').trim().replace(/[.,]$/,'');
      if(!t) return '';
      if(t.length === 2) return t.toUpperCase();
      return t
        .split(/[\s_-]+/)
        .map(w => w ? (w[0].toUpperCase() + w.slice(1).toLowerCase()) : '')
        .join(' ')
        .trim();
    }
	    function cityStateFromDeliveryAddress(address){
	      const raw = String(address || '').trim();
	      if(!raw) return '';

	      const normalized = raw
	        .replace(/\r?\n/g, ', ')
	        .replace(/\s+/g, ' ')
	        .trim();

	      const noCountry = normalized
	        .replace(/\b(USA|UNITED STATES|UNITED STATES OF AMERICA)\b/gi, '')
	        .replace(/\s+/g, ' ')
	        .trim();

	      // Remove ZIP (and ZIP+4) to make parsing easier.
	      const zipStripped = noCountry
	        .replace(/\s+\d{5}(?:-\d{4})?\b/g, '')
	        .replace(/\s+/g, ' ')
	        .trim();

	      // Prefer the common US format: "Street, City, ST"
	      const parts = zipStripped.split(',').map(s => s.trim()).filter(Boolean);
	      if(parts.length >= 2){
	        const last = parts[parts.length - 1] || '';
	        const stateMatch = String(last).match(/\b([A-Za-z]{2})\b/);
	        const st = stateMatch ? String(stateMatch[1]).toUpperCase() : '';
	        if(st){
	          let city = String(parts[parts.length - 2] || '').trim();
	          // If the "city" looks like it's actually a street (starts with a number), try the segment before it.
	          if(/^\d/.test(city)){
	            if(parts.length >= 3){
	              city = String(parts[parts.length - 3] || '').trim();
	            }else{
	              // Handle: "Street, City ST"
	              city = String(last).replace(new RegExp(`\\b${st}\\b`, 'i'), '').trim();
	            }
	          }
	          if(city) return `${city}, ${st}`;
	        }
	      }

	      // Fallback: last "City ST" style (no commas).
	      const m = zipStripped.match(/^(.+?)\s+([A-Za-z]{2})$/);
	      if(m){
	        const city = String(m[1] || '').replace(/,$/, '').trim();
	        const st = String(m[2] || '').toUpperCase();
	        if(city && st) return `${city}, ${st}`;
	      }

	      return '';
	    }
    function formatEasternDateTime(value){
      const d = (value instanceof Date) ? value : new Date(value);
      try{
        return new Intl.DateTimeFormat('en-US', {
          timeZone: 'America/New_York',
          year: 'numeric',
          month: 'short',
          day: '2-digit',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true,
          timeZoneName: 'short',
        }).format(d);
      }catch{
        return d.toLocaleString(undefined, { hour12:true });
      }
    }
	    const ORDER_COMPANY_NAME = 'Oakley Services, LLC';
	    function defaultOrderSubject(){
	      const base = `Order for ${ORDER_COMPANY_NAME}`;
	      const loc = cityStateFromDeliveryAddress(SB && SB.profile ? SB.profile.delivery_address : '');
	      return loc ? `${base} (${loc})` : base;
	    }
    function orderActiveLines(){
      const ord = orderState();
      return ord.lines
        .filter(l => toInt(l.qty, 0) > 0)
        .slice()
        .sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
    }
    function orderState(){
      if(!state._order){
        state._order = { lines:[], email:'', subject:defaultOrderSubject(), notes:'', contactName:'', search:'' };
      }
      return state._order;
    }
    function updateOrderCounterBadge(){
      const ord = orderState();
      const count = ord.lines.length;
      // Update new main pill (below totals)
      const pillContainer = $('orderPillContainer');
      const pillValue = $('orderPillValue');
      const pill = $('orderPill');
      if(pillContainer){
        if(count > 0){
          pillContainer.style.display = 'flex';
          if(pillValue) pillValue.textContent = String(count);
          const labelEl = pill && pill.querySelector('.order-pill-label');
          if(labelEl) labelEl.textContent = count === 1 ? 'Item in Cart' : 'Items in Cart';
        }else{
          pillContainer.style.display = 'none';
        }
      }
      try{
        const modal = $('reportModal');
        const content = $('reportContent');
        if(modal && modal.getAttribute('aria-hidden') === 'false' && content && content.style.display !== 'none'){
          renderInventoryReport();
        }else{
          syncReportOrderIndicators();
        }
      }catch(e){}
    }
    function clearAllOrderLines(){
      const ord = orderState();
      const ids = ord.lines.map(l => l.id);
      ord.lines = [];
      ids.forEach(id => { try{ syncOrderIndicatorForRow(String(id)); }catch(e){} });
      updateOrderCounterBadge();
    }
    function getInventoryById(id){
      return state.items.find(x => x && x.id === id) || null;
    }
    function getOrderQtyForItem(id){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      return line ? toInt(line.qty, 0) : 0;
    }
	    function upsertOrderLineFromItem(it, qty = 1){
	      const ord = orderState();
	      if(!it || !it.id) return false;
	      if(ord.lines.some(l => l.id === it.id)) return false;
	      ord.lines.push({ id: it.id, name: String(it.name||'').trim(), desc: String(it.desc||'').trim(), qty: toInt(qty, 1) });
	      ord.lines.sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
	      try{ syncOrderIndicatorForRow(String(it.id)); }catch(e){}
	      try{ updateOrderCounterBadge(); }catch(e){}
	      return true;
	    }
	    function removeOrderLine(id){
	      const ord = orderState();
	      ord.lines = ord.lines.filter(l => l.id !== id);
	      try{ syncOrderIndicatorForRow(String(id)); }catch(e){}
	      try{ updateOrderCounterBadge(); }catch(e){}
	    }
    function setOrderQty(id, qty){
      const ord = orderState();
      const line = ord.lines.find(l => l.id === id);
      if(!line) return;
      line.qty = toInt(qty, 0);
    }
    function normalizeEmailLineItems(lineItems){
      const arr = Array.isArray(lineItems) ? lineItems : [];
      return arr
        .map((x) => {
          const part = String(x?.part || x?.name || x?.item || '').trim();
          const desc = String(x?.desc || x?.description || '').trim();
          const qty = toInt(x?.qty, 0);
          return { part, desc, qty };
        })
        .filter((x) => x.part && x.qty > 0)
        .sort((a,b)=> toKey(a.part).localeCompare(toKey(b.part)));
    }
    function buildOrderBodyFromData({ subjectLine, notes, lineItems }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim() || defaultOrderSubject();
      const out = [];

      out.push(subject);
      out.push(`Date: ${when}`);
      out.push('');
      out.push('Items:');
      out.push('');

      const active = normalizeEmailLineItems(lineItems);
      if(!active.length){
        out.push('(none)');
      }else{
        const parts = active.map(l => String(l.part||'').trim());
        const descs = active.map(l => String(l.desc||'').trim());
        const partW = Math.min(25, Math.max(4, ...parts.map(p => p.length)));
        const descW = Math.min(35, Math.max(11, ...descs.map(d => d.length)));
        const qtyW = Math.min(6, Math.max(3, ...active.map(l => String(toInt(l.qty, 0)).length)));
        out.push(`${'Item'.padEnd(partW)} | ${'Description'.padEnd(descW)} | ${'Qty'.padStart(qtyW)}`);
        out.push(`${'-'.repeat(partW)}-+-${'-'.repeat(descW)}-+-${'-'.repeat(qtyW)}`);
        for(const l of active){
          const part = String(l.part||'').replace(/\t/g,' ').trim();
          const desc = String(l.desc||'').replace(/\t/g,' ').trim();
          const qty = String(toInt(l.qty, 0)).padStart(qtyW, ' ');
          out.push(`${part.padEnd(partW)} | ${desc.padEnd(descW)} | ${qty}`);
        }
      }

      const nt = String(notes||'').trim();
      if(nt){
        out.push('');
        out.push('Notes:');
        out.push(nt);
      }

      // Add delivery info from profile
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const deliveryAddr = String(profileData.delivery_address || '').trim();
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const deliveryLines = [];
      if(fullName) deliveryLines.push(fullName);
      if(deliveryAddr) deliveryLines.push(deliveryAddr);
      if(userPhone) deliveryLines.push(userPhone);
      if(userEmail) deliveryLines.push(userEmail);

      if(deliveryLines.length){
        out.push('');
        out.push('Shipping Address:');
        for(const line of deliveryLines) out.push(line);
      }

      out.push('');
      out.push(`Built by james.johns83@gmail.com for Oakley Services, LLC | v${APP_VERSION}`);
      return out.join('\n');
    }
    function buildOrderHtmlFromData({ subjectLine, notes, lineItems }){
      const when = formatEasternDateTime(new Date());
      const subject = String(subjectLine||'').trim() || defaultOrderSubject();

      const active = normalizeEmailLineItems(lineItems);
      const rows = active.map(l=>{
        const part = escapeHtml(String(l.part||'').trim());
        const desc = escapeHtml(String(l.desc||'').trim());
        const qty = toInt(l.qty, 0);
        return (
          `<tr>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;font-weight:600;">${part}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;word-break:break-word;overflow-wrap:anywhere;">${desc}</td>`+
            `<td style="padding:10px;border:1px solid #d0d7de;text-align:right;font-variant-numeric:tabular-nums;font-weight:700;">${qty}</td>`+
          `</tr>`
        );
      }).join('');

      const notesRaw = String(notes||'').trim();
      const notesHtml = notesRaw ? escapeHtml(notesRaw).replace(/\n/g, '<br>') : '';

      // Build user/delivery info block from profile
      const profileData = SB && SB.profile ? SB.profile : {};
      const firstName = String(profileData.first_name || '').trim();
      const lastName = String(profileData.last_name || '').trim();
      const fullName = [firstName, lastName].filter(Boolean).join(' ');
      const deliveryAddr = String(profileData.delivery_address || '').trim();
      const userPhone = String(profileData.phone || '').trim();
      const userEmail = String(profileData.email || '').trim();

      const deliveryInfoLines = [];
      if(fullName) deliveryInfoLines.push(escapeHtml(fullName));
      if(deliveryAddr) deliveryInfoLines.push(escapeHtml(deliveryAddr).replace(/\n/g, '<br>'));
      if(userPhone) deliveryInfoLines.push(escapeHtml(userPhone));
      if(userEmail) deliveryInfoLines.push(`<a href="mailto:${escapeHtmlAttr(userEmail)}" style="color:#0969da;text-decoration:underline;">${escapeHtml(userEmail)}</a>`);

      const deliveryInfoBlock = deliveryInfoLines.length
        ? (
          `<div style="margin:16px 0 16px;padding:12px;background:#f6f8fa;border:1px solid #d0d7de;border-radius:6px;">`+
            `<div style="font-weight:700;margin-bottom:8px;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Shipping Address</div>`+
            `<div style="font-size:14px;line-height:1.5;">${deliveryInfoLines.join('<br>')}</div>`+
          `</div>`
        )
        : '';

      const notesBlock = notesHtml
        ? (
          `<div style="margin-top:16px;">`+
            `<div style="font-weight:700;margin-bottom:6px;">Notes</div>`+
            `<div>${notesHtml}</div>`+
          `</div>`
        )
        : '';

      const itemsBlock = active.length
        ? (
          `<table role="presentation" cellpadding="0" cellspacing="0" style="width:100%;border-collapse:collapse;border:1px solid #d0d7de;table-layout:fixed;">`+
            `<colgroup>`+
              `<col style="width:35%;">`+
              `<col style="width:50%;">`+
              `<col style="width:15%;">`+
            `</colgroup>`+
            `<thead>`+
              `<tr>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Item</th>`+
                `<th align="left" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Description</th>`+
                `<th align="right" style="padding:10px;border:1px solid #d0d7de;background:#f6f8fa;font-size:13px;text-transform:uppercase;letter-spacing:.06em;">Qty</th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>${rows}</tbody>`+
          `</table>`
        )
        : `<div style="padding:12px;border:1px dashed #d0d7de;color:#444;">(No items)</div>`;

      return (
        `<!doctype html>`+
        `<html><body style="margin:0;padding:0;background:#ffffff;">`+
        `<div style="max-width:620px;margin:0 auto;padding:18px 16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.35;">`+
          `<h2 style="margin:0 0 10px;font-size:18px;">${escapeHtml(subject)}</h2>`+
          `<div style="font-size:13px;color:#444;margin:0 0 16px;">`+
            `<div style="margin:2px 0;"><strong>Date:</strong> ${escapeHtml(when)}</div>`+
          `</div>`+
          `<div style="margin:0 0 10px;">Please supply the following materials:</div>`+
          `${itemsBlock}`+
          `${notesBlock}`+
          `${deliveryInfoBlock}`+
          `<div style="margin-top:18px;font-size:12px;color:#6a737d;">Built by james.johns83@gmail.com for Oakley Services, LLC | v${escapeHtml(APP_VERSION)}</div>`+
        `</div>`+
        `</body></html>`
      );
    }
    function looksLikeEmailAddress(email){
      const s = String(email || '').trim();
      if(!s) return false;
      if(s.length > 254) return false;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    }
    function buildOrderBody(){
      const ord = orderState();
      const subjectLine = String(ord.subject||'').trim() || defaultOrderSubject();
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return buildOrderBodyFromData({ subjectLine, notes, lineItems });
    }
    function buildOrderHtml(){
      const ord = orderState();
      const subjectLine = String(ord.subject||'').trim() || defaultOrderSubject();
      const notesRaw = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return buildOrderHtmlFromData({ subjectLine, notes: notesRaw, lineItems });
    }
    function buildMailtoUrl(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const subject = String(ord.subject||'').trim() || defaultOrderSubject();
      const body = buildOrderBody();
      if(!to) return '';
      return `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    function getOrderApiUrl(){
      // Allow explicit override via window.ORDER_API_URL
      const override = (typeof window.ORDER_API_URL === 'string') ? window.ORDER_API_URL.trim() : '';
      if(override) return override;
      // Use Supabase Edge Function if available
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      if(sbUrl) return `${sbUrl}/functions/v1/send-order`;
      // Fallback to local dev server
      return '/api/send-order';
    }
    async function sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems }){
      const toEmail = String(to||'').trim();
      const replyTo = getSignedInEmail();
      const subject = String(subjectLine||'').trim() || defaultOrderSubject();
      const text = buildOrderBodyFromData({ subjectLine: subject, notes, lineItems });
      const html = buildOrderHtmlFromData({ subjectLine: subject, notes, lineItems });
      const apiUrl = getOrderApiUrl();

      // Build headers - include Supabase auth if using Edge Function
      const headers = { 'content-type': 'application/json' };
      const sbUrl = (typeof window.SB_URL === 'string') ? window.SB_URL.trim() : '';
      const sbKey = (typeof window.SB_ANON === 'string') ? window.SB_ANON.trim() : '';
      if(sbUrl && apiUrl.startsWith(sbUrl) && sbKey){
        headers['apikey'] = sbKey;
        // Add auth token if user is signed in
        if(SB.session && SB.session.access_token){
          headers['Authorization'] = `Bearer ${SB.session.access_token}`;
        }
      }

      const res = await fetch(apiUrl, {
        method: 'POST',
        headers,
        body: JSON.stringify({ to: toEmail, subject, text, html, replyTo }),
      });
      let data = null;
      try { data = await res.json(); } catch {}
      if(!res.ok || !data || data.ok !== true){
        const msg = (data && data.error) ? String(data.error) : `Send failed (${res.status})`;
        throw Object.assign(new Error(msg), { status: res.status, data });
      }
      return data;
    }
    async function sendOrderViaApi(){
      const ord = orderState();
      const to = String(ord.email||'').trim();
      const subjectLine = String(ord.subject||'').trim() || defaultOrderSubject();
      const notes = String(ord.notes||'').trim();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems });
    }
    async function copyText(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
        return;
      }
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position='fixed';
      ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
    }
    async function copyOrderToClipboard(){
      try{
        await copyText(buildOrderBody());
        toast('Copied order text');
      }catch{
        toast('Copy failed');
      }
    }

    async function sbFetchOrderRecipientSuggestions(prefix){
      if(!SB.ready || !SB.session || !SB.authorized) return [];
      const q = String(prefix||'').trim();
      let req = SB.client
        .from('order_recipients')
        .select('email,name,last_used_at')
        .order('last_used_at', { ascending:false })
        .limit(20);
      if(q) req = req.ilike('email', q + '%');
      const { data, error } = await req;
      if(error) throw error;
      return Array.isArray(data) ? data : [];
    }
    async function sbRecordOrderRecipient(email, name){
      if(!SB.ready || !SB.session || !SB.authorized) return;
      const e = String(email||'').trim().toLowerCase();
      if(!e) return;
      const row = { email: e, last_used_at: new Date().toISOString(), created_by: SB.user ? SB.user.id : null };
      const nm = String(name||'').trim();
      if(nm) row.name = nm;
      const { error } = await SB.client
        .from('order_recipients')
        .upsert([row], { onConflict: 'email' });
      if(error) throw error;
    }
    function normalizeOrderLineItems(value){
      const arr = Array.isArray(value) ? value : [];
      return arr
        .map((x) => {
          const part = String(x?.part || x?.name || x?.item || '').trim();
          let desc = String(x?.desc || x?.description || '').trim();
          // Fallback: look up description from inventory if not stored
          if(!desc && part){
            const inv = state.items.find(it => it.name === part);
            if(inv) desc = String(inv.desc || '').trim();
          }
          const qty = toInt(x?.qty, 0);
          return { part, desc, qty };
        })
        .filter((x) => x.part);
    }
    async function sbInsertOrderHistoryFromData({ toEmail, subjectLine, contactName, notes, lineItems, providerResult }){
      if(!SB.ready || !SB.session || !SB.authorized || !SB.user) return;
      const cleaned = normalizeEmailLineItems(lineItems).map(x => ({ part: x.part, desc: x.desc, qty: x.qty }));
      const row = {
        created_by: SB.user.id,
        to_email: String(toEmail||'').trim(),
        reply_to_email: String(getSignedInEmail()||'').trim(),
        subject: String(subjectLine||'').trim() || defaultOrderSubject(),
        contact_name: String(contactName||'').trim(),
        notes: String(notes||'').trim(),
        line_items: cleaned,
        provider_result: providerResult || null,
      };
      const { error } = await SB.client.from('orders').insert([row]);
      if(error) throw error;
    }
    async function sbInsertOrderHistory(providerResult){
      const ord = orderState();
      const lineItems = orderActiveLines().map(l => ({ part: String(l.name||'').trim(), desc: String(l.desc||'').trim(), qty: toInt(l.qty, 0) }));
      return sbInsertOrderHistoryFromData({
        toEmail: String(ord.email||'').trim(),
        subjectLine: String(ord.subject||'').trim() || defaultOrderSubject(),
        contactName: String(ord.contactName||'').trim(),
        notes: String(ord.notes||'').trim(),
        lineItems,
        providerResult,
      });
    }
	    async function sbFetchOrders(limit = 50){
	      if(!SB.ready || !SB.session || !SB.authorized) return [];
	      const lim = Math.max(1, Math.min(200, toInt(limit, 50)));
	      const { data, error } = await SB.client
	        .from('orders')
	        .select('id,created_at,to_email,reply_to_email,subject,contact_name,notes,line_items')
	        .order('created_at', { ascending:false })
	        .limit(lim);
	      if(error) throw error;
	      return Array.isArray(data) ? data : [];
	    }
	    async function sbFetchAllOrders(pageSize = 200){
	      if(!SB.ready || !SB.session || !SB.authorized) return [];
	      const size = Math.max(1, Math.min(200, toInt(pageSize, 200)));
	      let offset = 0;
	      const out = [];
	      for(let page=0; page<200; page++){
	        const { data, error } = await SB.client
	          .from('orders')
	          .select('id,created_at,to_email,reply_to_email,subject,contact_name,notes,line_items')
	          .order('created_at', { ascending:false })
	          .range(offset, offset + size - 1);
	        if(error) throw error;
	        const rows = Array.isArray(data) ? data : [];
	        out.push(...rows);
	        if(rows.length < size) break;
	        offset += size;
	      }
	      return out;
	    }
	    function csvEscape(value){
	      const s = String(value ?? '');
	      return '"' + s.replace(/"/g, '""') + '"';
	    }
	    function orderLineItemsToCsvCell(value){
	      const items = normalizeOrderLineItems(value);
	      if(!items.length) return '';
	      return items
	        .map(it => {
	          const part = String(it.part||'').trim();
	          const qty = String(toInt(it.qty,0));
	          const desc = String(it.desc||'').replace(/[\r\n]+/g,' ').trim();
	          return `${part} | ${qty} | ${desc}`;
	        })
	        .join(' ; ');
	    }
	    function buildOrderHistoryCsv(rows){
	      const header = [
	        'Order ID',
	        'Created At (UTC)',
	        'Created (Eastern)',
	        'To',
	        'Reply-To',
	        'Subject',
	        'Contact Name',
	        'Notes',
	        'Item Count',
	        'Items',
	      ];
	      const out = [header.map(csvEscape).join(',')];
	      const list = Array.isArray(rows) ? rows : [];
	      for(const o of list){
	        const id = String(o?.id || '').trim();
	        const createdAt = String(o?.created_at || '').trim();
	        const createdEastern = formatEasternDateTime(createdAt || new Date());
	        const to = String(o?.to_email || '').trim();
	        const replyTo = String(o?.reply_to_email || '').trim();
	        const subject = String(o?.subject || '').trim() || defaultOrderSubject();
	        const contact = String(o?.contact_name || '').trim();
	        const notes = String(o?.notes || '').trim();
	        const items = normalizeOrderLineItems(o?.line_items);
	        const itemsCell = orderLineItemsToCsvCell(o?.line_items);
	        out.push([
	          id,
	          createdAt,
	          createdEastern,
	          to,
	          replyTo,
	          subject,
	          contact,
	          notes,
	          String(items.length),
	          itemsCell,
	        ].map(csvEscape).join(','));
	      }
	      // Add BOM so Excel opens UTF-8 correctly
	      return '\ufeff' + out.join('\n');
	    }
	    async function downloadOrderHistoryCsv(){
	      if(!SB.ready){ toast('Supabase not configured'); return; }
	      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }

	      const btn = $('btnOrderHistoryDownload');
	      const priorTitle = btn ? btn.getAttribute('title') : '';
	      if(btn){ btn.disabled = true; btn.setAttribute('title', 'Downloading…'); }
	      try{
	        toast('Downloading order history…');
	        const rows = await sbFetchAllOrders(200);
	        if(!rows.length){ toast('No orders to download'); return; }
	        const csv = buildOrderHistoryCsv(rows);
	        const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
	        const url = URL.createObjectURL(blob);
	        const a = document.createElement('a');
	        a.href = url;
	        const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
	        a.download = `order-history-${stamp}.csv`;
	        document.body.appendChild(a);
	        a.click();
	        document.body.removeChild(a);
	        URL.revokeObjectURL(url);
	        toast(`Downloaded ${rows.length} order(s)`);
	      }catch(e){
	        toast((e && e.message) ? e.message : 'Download failed');
	      }finally{
	        if(btn){ btn.disabled = false; btn.setAttribute('title', priorTitle || 'Download CSV'); }
	      }
	    }
	    async function sbDeleteOrder(orderId){
	      if(!SB.ready || !SB.session || !SB.authorized) throw new Error('Not authorized');
	      const id = String(orderId || '').trim();
	      if(!id) throw new Error('Invalid order ID');
	      const { error } = await SB.client
	        .from('orders')
	        .delete()
	        .eq('id', id);
	      if(error) throw error;
	    }
	    function renderOrderHistoryList(list, opts = {}){
	      const wrap = $('orderHistoryList');
	      if(!wrap) return;
	      wrap.innerHTML = '';
	      const rows = Array.isArray(list) ? list : [];
	      if(!rows.length){
	        const empty = document.createElement('div');
	        empty.className = 'order-empty';
	        empty.textContent = (opts && typeof opts.emptyText === 'string' && opts.emptyText.trim())
	          ? opts.emptyText
	          : 'No orders yet.';
	        wrap.appendChild(empty);
	        return;
	      }
      for(const o of rows){
        const det = document.createElement('details');
        det.className = 'history-item';
        det.dataset.orderId = String(o.id || '');

	        const subject = escapeHtml(String(o.subject||defaultOrderSubject()));
        const created = escapeHtml(formatEasternDateTime(o.created_at || ''));
        const to = escapeHtml(String(o.to_email||''));
        const replyTo = String(o.reply_to_email||'').trim();
        const contact = String(o.contact_name||'').trim();
        const notes = String(o.notes||'').trim();
        const items = normalizeOrderLineItems(o.line_items);

        const itemsTable = items.length ? (
          `<table class="history-table">`+
            `<thead>`+
              `<tr>`+
                `<th>Part #</th>`+
                `<th>Description</th>`+
                `<th style="text-align:right">Qty</th>`+
              `</tr>`+
            `</thead>`+
            `<tbody>`+
              items.map(it =>
                `<tr>`+
                  `<td>${escapeHtml(it.part)}</td>`+
                  `<td>${escapeHtml(it.desc)}</td>`+
                  `<td class="qty">${it.qty}</td>`+
                `</tr>`
              ).join('')+
            `</tbody>`+
          `</table>`
        ) : `<div class="order-empty" style="margin-top:10px;">(No line items)</div>`;

        const orderId = String(o.id || '');
        const forwardBlock =
          `<div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">`+
            `<div class="muted" style="margin-bottom:8px;letter-spacing:.08em;text-transform:uppercase;font-weight:800;">Forward</div>`+
            `<div class="order-recipient">`+
              `<input data-forward-email-id="${orderId}" type="email" placeholder="recipient@example.com" autocomplete="email" inputmode="email" />`+
              `<button class="btn small" type="button" data-forward-send-id="${orderId}" disabled>Forward</button>`+
            `</div>`+
            `<div class="order-suggest" data-forward-suggest-id="${orderId}" aria-label="Email suggestions"></div>`+
          `</div>`;

        det.innerHTML =
          `<summary>`+
            `<div class="history-header">`+
              `<div class="history-title">${subject}</div>`+
              `<button class="btn-icon-danger" data-delete-order-id="${orderId}" aria-label="Delete order" title="Delete order">`+
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>`+
              `</button>`+
            `</div>`+
            `<div class="history-meta">${created}${to ? ` • To: ${to}` : ''}</div>`+
          `</summary>`+
          `<div class="history-kv">`+
            (replyTo ? `<div><span class="muted">Reply-To:</span> ${escapeHtml(replyTo)}</div>` : '')+
            (contact ? `<div><span class="muted">Contact:</span> ${escapeHtml(contact)}</div>` : '')+
            (notes ? `<div><span class="muted">Notes:</span> ${escapeHtml(notes)}</div>` : '')+
          `</div>`+
          itemsTable +
          forwardBlock;

	        wrap.appendChild(det);
	      }
	    }
	    function orderHistorySearchText(orderRow){
	      const o = orderRow || {};
	      const createdAt = String(o.created_at || '').trim();
	      const createdEastern = String(formatEasternDateTime(createdAt || '') || '').trim();
	      const subject = String(o.subject || '').trim();
	      const to = String(o.to_email || '').trim();
	      const replyTo = String(o.reply_to_email || '').trim();
	      const contact = String(o.contact_name || '').trim();
	      const notes = String(o.notes || '').trim();
	      const id = String(o.id || '').trim();
	      const items = normalizeOrderLineItems(o.line_items);
	      const itemText = items.map(it => `${it.part} ${it.desc} ${toInt(it.qty,0)}`).join(' ');
	      return `${id} ${createdAt} ${createdEastern} ${to} ${replyTo} ${subject} ${contact} ${notes} ${itemText}`.toLowerCase();
	    }
	    function renderOrderHistoryFiltered(){
	      const rows = Array.isArray(state._orderHistoryRows) ? state._orderHistoryRows : [];
	      const raw = String(state._orderHistoryFilter || '').trim().toLowerCase();
	      if(!raw){
	        renderOrderHistoryList(rows, { emptyText: 'No orders yet.' });
	        return;
	      }
	      const tokens = raw.split(/\s+/g).filter(Boolean);
	      const out = rows.filter(r => {
	        const hay = orderHistorySearchText(r);
	        return tokens.every(t => hay.includes(t));
	      });
	      renderOrderHistoryList(out, { emptyText: 'No matching orders.' });
	    }
		    let _orderSuggestTimer = null;
		    function renderOrderEmailSuggestions(list){
		      const wrap = $('orderEmailSuggest');
		      if(!wrap) return;
	      wrap.innerHTML = '';
	      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
	      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
	      wrap.classList.add('has-suggest');
	      rows.forEach(r=>{
	        const btn = document.createElement('button');
	        btn.type = 'button';
	        btn.className = 'suggest-chip';
	        btn.dataset.suggestEmail = String(r.email);
	        btn.textContent = String(r.email);
	        wrap.appendChild(btn);
	      });
	    }
	    function hideOrderEmailSuggestions(){
	      if(_orderSuggestTimer){ clearTimeout(_orderSuggestTimer); _orderSuggestTimer = null; }
	      renderOrderEmailSuggestions([]);
	    }
	    function requestOrderEmailSuggestions(prefix){
	      if(_orderSuggestTimer) clearTimeout(_orderSuggestTimer);
	      const q = String(prefix||'');
	      _orderSuggestTimer = setTimeout(async ()=>{
	        const wrap = $('orderEmailSuggest');
	        const inp = $('orderEmail');
	        const ae = document.activeElement;
	        const allow = (inp && ae === inp) || (wrap && ae && wrap.contains(ae));
	        if(!allow){ hideOrderEmailSuggestions(); return; }
	        try{
	          const data = await sbFetchOrderRecipientSuggestions(q);
	          // If focus moved away while we awaited, don't reopen the list.
	          const wrap2 = $('orderEmailSuggest');
	          const inp2 = $('orderEmail');
	          const ae2 = document.activeElement;
	          const allow2 = (inp2 && ae2 === inp2) || (wrap2 && ae2 && wrap2.contains(ae2));
	          if(!allow2){ hideOrderEmailSuggestions(); return; }
	          renderOrderEmailSuggestions(data);
	        }catch{
	          renderOrderEmailSuggestions([]);
	        }
	      }, 160);
	    }

    const _forwardSuggestTimers = new Map();
    function renderForwardEmailSuggestions(orderId, list){
      const id = String(orderId || '').trim();
      if(!id) return;
      const wrap = document.querySelector(`[data-forward-suggest-id="${id}"]`);
      if(!wrap) return;
      wrap.innerHTML = '';
      const rows = Array.isArray(list) ? list.filter(r=> r && r.email) : [];
      if(!rows.length){ wrap.classList.remove('has-suggest'); return; }
      wrap.classList.add('has-suggest');
      rows.forEach(r=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'suggest-chip';
        btn.dataset.forwardSuggestEmail = String(r.email);
        btn.textContent = String(r.email);
        wrap.appendChild(btn);
      });
    }
    function requestForwardEmailSuggestions(orderId, prefix){
      const id = String(orderId || '').trim();
      if(!id) return;
      const prev = _forwardSuggestTimers.get(id);
      if(prev) clearTimeout(prev);
      const q = String(prefix||'');
      const t = setTimeout(async ()=>{
        try{
          const data = await sbFetchOrderRecipientSuggestions(q);
          renderForwardEmailSuggestions(id, data);
        }catch{
          renderForwardEmailSuggestions(id, []);
        }
      }, 160);
      _forwardSuggestTimers.set(id, t);
    }
    async function forwardOrderFromHistory(orderId){
      const id = String(orderId || '').trim();
      if(!id) return;

      const row = state._orderHistoryById && typeof state._orderHistoryById.get === 'function'
        ? (state._orderHistoryById.get(id) || null)
        : null;
      if(!row){ toast('Order not found'); return; }

      const input = document.querySelector(`[data-forward-email-id="${id}"]`);
      const to = String(input && input.value ? input.value : '').trim();
      if(!looksLikeEmailAddress(to)){ toast('Enter a valid email'); return; }

      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      const prior = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Sending…'; }

      try{
        const subjectLine = String(row.subject||'').trim() || defaultOrderSubject();
        const notes = String(row.notes||'').trim();
        const lineItems = Array.isArray(row.line_items) ? row.line_items : [];

        const sendRes = await sendOrderPayloadViaApi({ to, subjectLine, notes, lineItems });
        try{ await sbRecordOrderRecipient(to, ''); }catch{}
        try{
          await sbInsertOrderHistoryFromData({
            toEmail: to,
            subjectLine,
            contactName: '',
            notes,
            lineItems,
            providerResult: sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes,
          });
        }catch{}

        toast('Forwarded');
        if(input) input.value = '';
        renderForwardEmailSuggestions(id, []);
      }catch(e){
        toast((e && e.message) ? e.message : 'Forward failed');
      }finally{
        if(btn){ btn.disabled = false; btn.textContent = prior || 'Forward'; }
      }
    }
    let _orderHistoryReturnToOrder = false;
	    async function refreshOrderHistory(){
	      const wrap = $('orderHistoryList');
	      if(wrap) wrap.innerHTML = `<div class="muted">Loading…</div>`;
	      const btn = $('btnOrderHistoryRefresh');
	      const prior = btn ? btn.textContent : '';
	      if(btn){ btn.disabled = true; btn.textContent = 'Loading…'; }
	      try{
	        const rows = await sbFetchOrders(60);
	        state._orderHistoryRows = Array.isArray(rows) ? rows : [];
	        state._orderHistoryById = new Map((rows||[]).map(r => [String(r && r.id ? r.id : ''), r]).filter(x=>x[0]));
	        renderOrderHistoryFiltered();
	      }catch(e){
	        state._orderHistoryById = new Map();
	        state._orderHistoryRows = [];
	        const msg = e && e.message ? e.message : 'Failed to load history';
	        if(wrap) wrap.innerHTML = `<div class="order-empty">${escapeHtml(msg)}</div>`;
	      }finally{
	        if(btn){ btn.disabled = false; btn.textContent = prior || 'Refresh'; }
	      }
	    }
	    async function openOrderHistoryModal(opts = {}){
	      const returnToOrder = !!opts.returnToOrder;
	      if(!SB.ready){ toast('Supabase not configured'); return; }
	      if(!SB.session){ toast('Sign in required'); show('authModal', true); return; }
	      if(!SB.authorized){ toast('Not authorized'); show('profileModal', true); return; }
	      _orderHistoryReturnToOrder = returnToOrder;
	      if(returnToOrder) show('orderModal', false);
	      show('orderHistoryModal', true);
	      const f = $('orderHistoryFilter'); if(f) f.value = state._orderHistoryFilter || '';
	      try{ updateOrderHistoryFilterClearBtn(); }catch(e){}
	      await refreshOrderHistory();
	    }
    function closeOrderHistoryModal(){
      show('orderHistoryModal', false);
      if(_orderHistoryReturnToOrder){
        _orderHistoryReturnToOrder = false;
        show('orderModal', true);
        renderOrderPreview();
      }
    }
    function renderOrderResults(){
      const ord = orderState();
      const list = $('orderResultsBody');
      if(!list) return;
      const qRaw = String(ord.search||'').trim();
      const q = toKey(qRaw);

      const items = (state.items||[]).slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      list.innerHTML = '';
      if(!items.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No inventory loaded yet.';
        list.appendChild(empty);
        return;
      }
      if(!qRaw){
        return;
      }

      const hits = items.filter(it=>{
        if(!it) return false;
        const name = toKey(it.name);
        const desc = toKey(it.desc);
        return name.includes(q) || desc.includes(q) || String(toInt(it.qty,0)).includes(qRaw);
      }).slice(0, 20);

      if(!hits.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No matches.';
        list.appendChild(empty);
        return;
      }

      for(const it of hits){
        const card = document.createElement('div');
        card.className = 'order-card';
        const desc = String(it.desc||'').trim();
        const orderQty = getOrderQtyForItem(it.id);
        card.innerHTML =
          `<div class="order-card-top">`+
            `<div class="order-meta">`+
              `<div class="order-title">${escapeHtml(it.name||'')}</div>`+
              (desc ? `<div class="order-sub">${escapeHtml(desc)}</div>` : ``)+
            `</div>`+
            `<div class="order-side">`+
              `<div class="order-kpi">`+
                `<div class="order-kpi-label">On Hand</div>`+
                `<div class="order-kpi-value">${toInt(it.qty,0)}</div>`+
              `</div>`+
              `<div class="qty-stepper">`+
                `<button class="qty-stepper-btn" data-stepper-dec="${it.id}"${orderQty === 0 ? ' disabled style="opacity:0.3"' : ''}>−</button>`+
                `<span class="qty-stepper-val">${orderQty}</span>`+
                `<button class="qty-stepper-btn" data-stepper-inc="${it.id}">+</button>`+
              `</div>`+
            `</div>`+
          `</div>`;
        list.appendChild(card);
      }
    }
    function renderOrderLines(){
      const ord = orderState();
      const list = $('orderLinesBody');
      const info = $('orderLinesInfo');
      if(!list) return;
      list.innerHTML = '';

      const lines = ord.lines.slice().sort((a,b)=> toKey(a.name).localeCompare(toKey(b.name)));
      if(info){
        info.textContent = lines.length ? (lines.length === 1 ? '1 item' : `${lines.length} items`) : '';
      }

      if(!lines.length){
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No items in the order yet. Add from inventory above, or pre-select items in the main table before opening Create Order.';
        list.appendChild(empty);
        renderOrderPreview();
        return;
      }

      for(const l of lines){
        const inv = getInventoryById(l.id);
        const onHand = inv ? toInt(inv.qty, 0) : null;
        const card = document.createElement('div');
        card.className = 'order-card order-card--selected';
        card.dataset.orderLineId = l.id;
        const desc = String(l.desc||'').trim();
        card.innerHTML =
          `<div class="order-card-header">`+
            `<span class="order-card-led order-card-led--on"></span>`+
            `<div class="order-title">${escapeHtml(l.name||'')}</div>`+
            `<div class="order-inline-kpi"><span class="muted">On Hand</span><span class="order-inline-kpi-val">${onHand===null ? '—' : onHand}</span></div>`+
          `</div>`+
          (desc ? `<div class="order-sub">${escapeHtml(desc)}</div>` : ``)+
          `<div class="order-controls order-controls--compact">`+
            `<div class="qty-stepper" data-qty-picker-trigger="${l.id}">`+
              `<button class="qty-stepper-btn" data-line-dec="${l.id}">−</button>`+
              `<span class="qty-stepper-val">${toInt(l.qty,0)}</span>`+
              `<button class="qty-stepper-btn" data-line-inc="${l.id}">+</button>`+
            `</div>`+
            `<button class="order-remove-btn" data-remove-order-id="${l.id}" title="Remove">`+
              `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`+
            `</button>`+
          `</div>`;
        list.appendChild(card);
      }

      renderOrderPreview();
    }
    function renderOrderPreview(){
      const ord = orderState();
      const wrap = $('orderPreviewHtml');
      if(wrap){
        const html = buildOrderHtml();
        wrap.innerHTML = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" sandbox="allow-same-origin"></iframe>`;
      }
      const replyEl = $('orderReplyToNote');
      if(replyEl){
        const e = getSignedInEmail();
        replyEl.textContent = e ? `Reply-To: ${e}` : 'Reply-To: (sign in to set)';
      }
      const histBtn = $('btnOrderHistory');
      if(histBtn){
        histBtn.disabled = !(SB.ready && SB.session && SB.authorized);
      }
      const btn = $('btnOrderSubmit');
      if(btn){
        const okEmail = !!String(ord.email||'').trim();
        const okLines = ord.lines.some(l => toInt(l.qty, 0) > 0);
        btn.disabled = !(okEmail && okLines);
      }
    }
	    function openOrderModal(opts = {}){
		      const ord = orderState();
		      const addSelected = !isMobileUx() && !(opts && Object.prototype.hasOwnProperty.call(opts, 'addSelected') && opts.addSelected === false);
		      if(addSelected){
		        const selectedIds = Array.from(document.querySelectorAll('.rowChk:checked'))
		          .map(cb => cb.dataset.id)
		          .filter(Boolean);

	        let added = 0;
	        for(const id of selectedIds){
	          const it = getInventoryById(id);
	          if(it && upsertOrderLineFromItem(it, 1)) added++;
	        }
	        if(added) toast(`Added ${added} selected item(s)`);
	      }

	      if(
	        !ord.subject
	        || ord.subject === 'Materials Order'
	        || ord.subject === 'Material Order'
		        || /^Materials? Order\s*-\s*/i.test(String(ord.subject||'').trim())
	      ){
	        ord.subject = defaultOrderSubject();
	      }

      const s = $('orderSearch'); if(s) s.value = ord.search || '';
      const e = $('orderEmail'); if(e) e.value = ord.email || '';
      const sub = $('orderSubject'); if(sub) sub.value = ord.subject || '';
      const n = $('orderNotes'); if(n) n.value = ord.notes || '';

      renderOrderResults();
      renderOrderLines();
      renderOrderPreview();
      try{ updateOrderSearchClearBtn(); }catch(e){}

      show('orderModal', true);
    }

	    const menuOrder = $('menuOrder');
	    if(menuOrder) menuOrder.addEventListener('click', ()=>{ toggleMenu(false); openOrderModal(); });
	    const menuHistory = $('menuHistory');
	    if(menuHistory) menuHistory.addEventListener('click', ()=>{ toggleMenu(false); openOrderHistoryModal({ returnToOrder: false }); });
	    const menuReport = $('menuReport');
	    if(menuReport) menuReport.addEventListener('click', ()=>{ toggleMenu(false); openReportModal(); });
	    const btnReportClose = $('btnReportClose');
	    if(btnReportClose) btnReportClose.addEventListener('click', closeReportModal);
			    const btnReportDownload = $('btnReportDownload');
			    if(btnReportDownload) btnReportDownload.addEventListener('click', downloadInventoryReportCsv);
			    const btnReportShare = $('btnReportShare');
			    if(btnReportShare) btnReportShare.addEventListener('click', ()=>{ void shareInventoryReport(); });
			    const reportLowStockList = $('reportLowStockList');
			    const reportInventoryList = $('reportList');
			    function toggleOrderFromReportClick(e){
			      const row = e.target.closest('button[data-report-order-id]');
			      if(!row) return;
			      e.preventDefault();
			      e.stopPropagation();
			      const id = String(row.dataset.reportOrderId || '').trim();
			      if(!id) return;
			      const item = getInventoryById(id);
			      if(!item) return;
				      const ord = orderState();
				      const exists = Array.isArray(ord.lines) && ord.lines.some(l => String(l && l.id ? l.id : '').trim() === id);
				      if(exists) removeOrderLine(id);
				      else upsertOrderLineFromItem(item, 1);
				    }
			    if(reportLowStockList) reportLowStockList.addEventListener('click', toggleOrderFromReportClick);
			    if(reportInventoryList) reportInventoryList.addEventListener('click', toggleOrderFromReportClick);
			    const btnReportEmailClose = $('btnReportEmailClose');
			    if(btnReportEmailClose) btnReportEmailClose.addEventListener('click', closeReportEmailModal);
			    const btnReportEmailCopy = $('btnReportEmailCopy');
		    if(btnReportEmailCopy) btnReportEmailCopy.addEventListener('click', async ()=>{
		      try{
		        const html = String(_reportEmailHtml || '').trim();
		        if(!html){ toast('Nothing to copy'); return; }
		        await navigator.clipboard.writeText(html);
		        toast('Copied');
		      }catch(e){
		        toast('Copy failed');
		      }
		    });
		    const btnReportEmailSend = $('btnReportEmailSend');
		    if(btnReportEmailSend) btnReportEmailSend.addEventListener('click', async ()=>{
		      const to = String($('reportEmailTo')?.value || '').trim();
		      const subjectLine = String($('reportEmailSubject')?.value || '').trim() || defaultInventoryReportEmailSubject();
		      const html = String(_reportEmailHtml || '').trim();
		      setReportEmailMessage('');
		      if(!looksLikeEmailAddress(to)){ setReportEmailMessage('Enter a valid email.'); return; }
		      if(!html){ setReportEmailMessage('Nothing to send.'); return; }

		      const prior = btnReportEmailSend.textContent;
		      btnReportEmailSend.disabled = true;
		      btnReportEmailSend.textContent = 'Sending…';
		      try{
		        await sendInventoryReportEmailViaApi({ toEmail: to, subjectLine, html });
		        toast('Report sent');
		        closeReportEmailModal();
		      }catch(e){
		        const msg = (e && e.message) ? String(e.message) : 'Send failed';
		        setReportEmailMessage(msg);
		        const fallback = await openConfirmModal('Send failed', `${msg}\n\nOpen your email app with a text report instead?`, { okText:'Open Email', cancelText:'Stay' });
		        if(fallback){
		          const data = reportDataSnapshot();
		          const text = buildInventoryReportText(data, { maxLines: 180 });
		          const stamp = new Date().toISOString().slice(0,10);
		          const subject = subjectLine || `Inventory Report (${stamp})`;
		          const mailto = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
		          window.location.href = mailto;
		        }
		      }finally{
		        btnReportEmailSend.disabled = false;
		        btnReportEmailSend.textContent = prior || 'Send';
		      }
		    });
	    const btnOrderHistory = $('btnOrderHistory');
	    if(btnOrderHistory) btnOrderHistory.addEventListener('click', ()=> openOrderHistoryModal({ returnToOrder: true }));
	    const btnOrderHistoryClose = $('btnOrderHistoryClose');
	    if(btnOrderHistoryClose) btnOrderHistoryClose.addEventListener('click', closeOrderHistoryModal);
	    const btnOrderHistoryDownload = $('btnOrderHistoryDownload');
	    if(btnOrderHistoryDownload) btnOrderHistoryDownload.addEventListener('click', downloadOrderHistoryCsv);
	    const btnOrderHistoryRefresh = $('btnOrderHistoryRefresh');
	    if(btnOrderHistoryRefresh) btnOrderHistoryRefresh.addEventListener('click', refreshOrderHistory);

	    const orderHistoryFilter = $('orderHistoryFilter');
	    if(orderHistoryFilter){
	      updateOrderHistoryFilterClearBtn();
	      orderHistoryFilter.addEventListener('input', ()=>{
	        state._orderHistoryFilter = orderHistoryFilter.value || '';
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	      });
	      orderHistoryFilter.addEventListener('keydown', (e)=>{
	        if(e.key==='Escape' && orderHistoryFilter.value){
	          e.preventDefault();
	          orderHistoryFilter.value = '';
	          state._orderHistoryFilter = '';
	          renderOrderHistoryFiltered();
	          updateOrderHistoryFilterClearBtn();
	        }
	      });
	    }
	    const btnClearOrderHistoryFilter = $('btnClearOrderHistoryFilter');
	    if(btnClearOrderHistoryFilter && orderHistoryFilter){
	      btnClearOrderHistoryFilter.addEventListener('click', ()=>{
	        if(!orderHistoryFilter.value) return;
	        orderHistoryFilter.value = '';
	        state._orderHistoryFilter = '';
	        renderOrderHistoryFiltered();
	        updateOrderHistoryFilterClearBtn();
	        try{ orderHistoryFilter.focus(); }catch(e){}
	      });
	    }
	    const btnOrderCancel = $('btnOrderCancel');
	    if(btnOrderCancel) btnOrderCancel.addEventListener('click', ()=> show('orderModal', false));
    const btnResetOrderList = $('btnResetOrderList');
    if(btnResetOrderList) btnResetOrderList.addEventListener('click', ()=> {
      clearAllOrderLines();
      renderOrderLines();
      toast('Order list cleared');
    });
    const btnOrderCopy = $('btnOrderCopy');
    if(btnOrderCopy) btnOrderCopy.addEventListener('click', copyOrderToClipboard);
    const btnOrderSubmit = $('btnOrderSubmit');
    if(btnOrderSubmit) btnOrderSubmit.addEventListener('click', async ()=>{
      const url = buildMailtoUrl();
      if(!url){ toast('Add at least 1 item and an email'); return; }

      const btn = $('btnOrderSubmit');
      const priorText = btn ? btn.textContent : '';
      if(btn){ btn.disabled = true; btn.textContent = 'Sending…'; }

	      try{
	        const sendRes = await sendOrderViaApi();
	        let historySaved = false;
	        try{
	          const ord = orderState();
	          await sbRecordOrderRecipient(ord.email, ord.contactName);
	        }catch{}
	        try{
	          await sbInsertOrderHistory(sendRes && Object.prototype.hasOwnProperty.call(sendRes, 'result') ? sendRes.result : sendRes);
	          historySaved = true;
	        }catch{}
	        toast(historySaved ? 'Order sent' : 'Order sent (history not saved)');
	        show('orderModal', false);
	      }catch(e){
	        const msg = e && e.message ? e.message : 'Send failed';
	        const fallback = await openConfirmModal('Send failed', `${msg}\n\nOpen your email app instead?`, { okText:'Open Email', cancelText:'Cancel' });
	        if(fallback){ window.location.href = url; }
	        else { toast(msg); }
	      }finally{
	        if(btn){ btn.textContent = priorText || 'Send'; }
	        renderOrderPreview();
	      }
    });

    const orderSearch = $('orderSearch');
    if(orderSearch){
      updateOrderSearchClearBtn();
      orderSearch.addEventListener('input', ()=>{
        const ord = orderState();
        ord.search = orderSearch.value || '';
        renderOrderResults();
        updateOrderSearchClearBtn();
      });
      orderSearch.addEventListener('keydown', (e)=>{
        if(e.key==='Escape' && orderSearch.value){
          e.preventDefault();
          orderSearch.value = '';
          const ord = orderState();
          ord.search = '';
          renderOrderResults();
          updateOrderSearchClearBtn();
        }
      });
    }
    const btnClearOrderSearch = $('btnClearOrderSearch');
    if(btnClearOrderSearch && orderSearch){
      btnClearOrderSearch.addEventListener('click', ()=>{
        if(!orderSearch.value) return;
        orderSearch.value = '';
        const ord = orderState();
        ord.search = '';
        renderOrderResults();
        updateOrderSearchClearBtn();
        try{ orderSearch.focus(); }catch(e){}
      });
    }
	    const orderEmail = $('orderEmail');
	    if(orderEmail) orderEmail.addEventListener('input', ()=>{
	      const ord = orderState();
	      ord.email = orderEmail.value || '';
	      renderOrderPreview();
	      requestOrderEmailSuggestions(ord.email);
	    });
	    if(orderEmail) orderEmail.addEventListener('focus', ()=> requestOrderEmailSuggestions(orderEmail.value || ''));
	    if(orderEmail) orderEmail.addEventListener('blur', ()=>{
	      // Defer so clicks on suggestions can still be handled.
	      setTimeout(()=>{
	        const wrap = $('orderEmailSuggest');
	        if(!wrap || !wrap.classList.contains('has-suggest')) return;
	        const ae = document.activeElement;
	        if(ae && wrap.contains(ae)) return;
	        hideOrderEmailSuggestions();
	      }, 0);
	    });
	    const orderSubject = $('orderSubject');
	    if(orderSubject) orderSubject.addEventListener('input', ()=>{
	      const ord = orderState();
	      ord.subject = orderSubject.value || '';
	    });
    const orderNotes = $('orderNotes');
    if(orderNotes) orderNotes.addEventListener('input', ()=>{
      const ord = orderState();
      ord.notes = orderNotes.value || '';
      renderOrderPreview();
    });

    const orderResultsBody = $('orderResultsBody');
    if(orderResultsBody) orderResultsBody.addEventListener('click', (e)=>{
      const incBtn = e.target.closest('button[data-stepper-inc]');
      const decBtn = e.target.closest('button[data-stepper-dec]');
      if(incBtn){
        const id = incBtn.getAttribute('data-stepper-inc');
        const it = getInventoryById(id);
        if(!it) return;
        const currentQty = getOrderQtyForItem(id);
        if(currentQty === 0){
          upsertOrderLineFromItem(it, 1);
        } else {
          setOrderQty(id, currentQty + 1);
        }
        renderOrderResults();
        renderOrderLines();
      } else if(decBtn){
        const id = decBtn.getAttribute('data-stepper-dec');
        const currentQty = getOrderQtyForItem(id);
        if(currentQty <= 1){
          removeOrderLine(id);
        } else {
          setOrderQty(id, currentQty - 1);
        }
        renderOrderResults();
        renderOrderLines();
      }
    });

	    const orderEmailSuggest = $('orderEmailSuggest');
	    if(orderEmailSuggest) orderEmailSuggest.addEventListener('click', (e)=>{
	      const btn = e.target.closest('button[data-suggest-email]');
	      if(!btn) return;
	      const email = String(btn.dataset.suggestEmail || '').trim();
      if(!email) return;
      const ord = orderState();
      ord.email = email;
      const inp = $('orderEmail'); if(inp) inp.value = email;
	      renderOrderPreview();
	      hideOrderEmailSuggestions();
	    });
	    if(orderEmailSuggest) orderEmailSuggest.addEventListener('mouseleave', (e)=>{
	      // Only close when the mouse leaves below the last entry (not when moving back to the input).
	      try{
	        const rect = orderEmailSuggest.getBoundingClientRect();
	        if(e && typeof e.clientY === 'number' && e.clientY >= rect.bottom - 1){
	          hideOrderEmailSuggestions();
	        }
	      }catch(e){}
	    });
	    document.addEventListener('pointerdown', (e)=>{
	      const wrap = $('orderEmailSuggest');
	      if(!wrap || !wrap.classList.contains('has-suggest')) return;
	      const inp = $('orderEmail');
	      const t = e && e.target ? e.target : null;
	      if(t && wrap.contains(t)) return;
	      if(inp && (t === inp || (t && inp.contains(t)))) return;
	      hideOrderEmailSuggestions();
	    });

    const orderHistoryList = $('orderHistoryList');
    if(orderHistoryList) orderHistoryList.addEventListener('input', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
      const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
      if(btn) btn.disabled = !looksLikeEmailAddress(inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('focusin', (e)=>{
      const inp = e.target.closest('input[data-forward-email-id]');
      if(!inp) return;
      const id = String(inp.dataset.forwardEmailId || '').trim();
      if(!id) return;
      requestForwardEmailSuggestions(id, inp.value || '');
    });
    if(orderHistoryList) orderHistoryList.addEventListener('click', async (e)=>{
      // Delete order button
      const delBtn = e.target.closest('button[data-delete-order-id]');
	      if(delBtn){
	        e.preventDefault();
		        e.stopPropagation();
		        const id = String(delBtn.dataset.deleteOrderId || '').trim();
		        if(!id) return;
		        if(!(await openConfirmModal('Delete order?', 'Delete this order from history?', { okText:'Delete', cancelText:'Cancel' }))) return;
		        delBtn.disabled = true;
		        try{
		          await sbDeleteOrder(id);
	          try{
	            if(state._orderHistoryById && typeof state._orderHistoryById.delete === 'function'){
	              state._orderHistoryById.delete(id);
	            }
	            if(Array.isArray(state._orderHistoryRows)){
	              state._orderHistoryRows = state._orderHistoryRows.filter(r => String(r && r.id ? r.id : '') !== id);
	            }
	          }catch(e){}
	          renderOrderHistoryFiltered();
	          toast('Order deleted');
	        }catch(err){
	          toast(err && err.message ? err.message : 'Delete failed');
	          delBtn.disabled = false;
	        }
	        return;
	      }
      const sugBtn = e.target.closest('button[data-forward-suggest-email]');
      if(sugBtn){
        const email = String(sugBtn.dataset.forwardSuggestEmail || '').trim();
        const wrap = sugBtn.closest('[data-forward-suggest-id]');
        const id = wrap ? String(wrap.dataset.forwardSuggestId || '').trim() : '';
        if(id && email){
          const inp = document.querySelector(`input[data-forward-email-id="${id}"]`);
          if(inp) inp.value = email;
          const btn = document.querySelector(`button[data-forward-send-id="${id}"]`);
          if(btn) btn.disabled = false;
          renderForwardEmailSuggestions(id, []);
        }
        return;
      }
      const fwdBtn = e.target.closest('button[data-forward-send-id]');
      if(fwdBtn){
        const id = String(fwdBtn.dataset.forwardSendId || '').trim();
        if(!id) return;
        void forwardOrderFromHistory(id);
      }
    });
    const orderLinesBody = $('orderLinesBody');
    if(orderLinesBody) orderLinesBody.addEventListener('click', (e)=>{
      // Remove button
      const removeBtn = e.target.closest('button[data-remove-order-id]');
      if(removeBtn){
        removeOrderLine(removeBtn.getAttribute('data-remove-order-id'));
        renderOrderResults();
        renderOrderLines();
        return;
      }
      // Stepper increment
      const incBtn = e.target.closest('button[data-line-inc]');
      if(incBtn){
        const id = incBtn.getAttribute('data-line-inc');
        const currentQty = getOrderQtyForItem(id);
        setOrderQty(id, currentQty + 1);
        renderOrderResults();
        renderOrderLines();
        return;
      }
      // Stepper decrement
      const decBtn = e.target.closest('button[data-line-dec]');
      if(decBtn){
        const id = decBtn.getAttribute('data-line-dec');
        const currentQty = getOrderQtyForItem(id);
        if(currentQty <= 1){
          removeOrderLine(id);
        } else {
          setOrderQty(id, currentQty - 1);
        }
        renderOrderResults();
        renderOrderLines();
        return;
      }
    });

    // Add-one modal
    $('menuAddOne').addEventListener('click', ()=>{ toggleMenu(false); if(!requireOnline()) return; show('addOneModal', true); $('addName').focus(); });
    $('btnAddCancel').addEventListener('click', ()=> show('addOneModal', false));
    $('btnAddSave').addEventListener('click', saveAddOne);
    $('addQty').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); saveAddOne(); }});
    async function saveAddOne(){
      if(!requireOnline()) return;
      const name = String(($('addName').value||'').trim());
      const desc = String(($('addDesc').value||'').trim());
      const qty  = toInt($('addQty').value,-1);
      if(!name){ toast('Item name required'); return; }
      if(qty<=0){ toast('Qty must be > 0'); return; }
      if(state.items.some(x=> toKey(x.name)===toKey(name))){ toast('Duplicate item'); return; }

      try{
        await sbAddItem(name, desc, qty);
        await sbLoadSnapshot();
        $('addName').value=''; $('addDesc').value=''; $('addQty').value='';
        show('addOneModal', false);
        toast('Item added');
      }catch(e){
        toast(e.message || 'Cloud add failed');
      }
    }

		    // Row delete button handler (delegated)
		    document.addEventListener('click', async (e)=>{
		      const stockBtn = e.target.closest('.row-stock-btn');
		      if(stockBtn){
		        e.preventDefault();
		        e.stopPropagation();
		        if(!requireOnline()) return;
		        const id = stockBtn.dataset.id;
		        if(!id) return;
		        openLowStockModal(id);
		        return;
		      }

	      const btn = e.target.closest('.row-delete-btn');
	      if(!btn) return;
	      if(!requireOnline()) return;
	      const id = btn.dataset.id;
      if(!id) return;
      const item = state.items.find(it => it.id === id);
      const itemName = item ? item.name : 'this item';
      if(!(await openConfirmModal('Delete item?', `Delete "${itemName}"?`, { okText:'Delete', cancelText:'Cancel' }))) return;
      try {
        const res = await sbDeleteMany([id]);
        await sbLoadSnapshot();
        toast('Item deleted', 'success');
      } catch (e) {
        toast(e.message || 'Delete failed', 'error');
      }
    });

    // Master checkbox + indeterminate state
    document.addEventListener('change', (e)=>{
      if(e.target && e.target.id==='chkAll'){
        const on = e.target.checked;
        document.querySelectorAll('.rowChk').forEach(cb=> cb.checked=on);
      }
      if(e.target && e.target.classList && e.target.classList.contains('rowChk')){
        const all = document.querySelectorAll('.rowChk');
        const checked = document.querySelectorAll('.rowChk:checked');
        const m = $('chkAll');
        if(m){
          m.checked = (checked.length===all.length && all.length>0);
          m.indeterminate = (checked.length>0 && checked.length<all.length);
        }
      }
    });

    // ========================
    // Parsing helpers
    // ========================
    function parseDelimitedSmart(text){
      const firstLine=(text.split(/\r?\n/)[0]||'');
      let delim='\t';
      const tabScore=(firstLine.split('\t').length-1);
      const commaScore=(firstLine.split(',').length-1);
      const spaceScore=((firstLine.match(/\s{2,}/g)||[]).length);
      if(commaScore>tabScore && commaScore>=spaceScore) delim=','; else if(spaceScore>tabScore && spaceScore>commaScore) delim='  ';

      const rows=[]; let row=[]; let field=''; let inQ=false; let i=0; const N=text.length;
      const isDelim=(ch,pk)=> delim==='\t'? ch==='\t' : (delim===','? ch===',' : (ch===' ' && pk===' '));
      while(i<N){
        const ch=text[i], pk=text[i+1];
        if(ch==='"'){ if(inQ && pk==='"'){ field+='"'; i+=2; continue; } inQ=!inQ; i++; continue; }
        if(!inQ && (isDelim(ch,pk) || ch==='\n')){
          row.push(field); field='';
          if(delim==='  ' && ch===' ' && pk===' '){ while(text[i]===' ') i++; continue; }
          if(ch==='\n'){ rows.push(row); row=[]; }
          i++; continue;
        }
        if(ch==='\r'){ i++; continue; }
        field+=ch; i++;
      }
      if(field.length||row.length){ row.push(field); rows.push(row); }
      return rows.filter(r=> r.some(c=> String(c).trim().length));
    }
    function rowsToItems(rows){
      if(!rows||!rows.length) return [];
      const canon=s=> toKey(String(s).replace(/[^A-Za-z0-9]+/g,'').trim());
      const hdrsRaw=rows[0]||[]; const hdrs=hdrsRaw.map(canon);
      const idxFromHdr=names=>{ for(const n of names){ const i=hdrs.indexOf(n); if(i>=0) return i; } return -1; };
      let iItem=idxFromHdr(['ITEM','NAME']);
      let iDesc=idxFromHdr(['DESCRIPTION','DESC']);
      let iQty = idxFromHdr(['QTY','QUANTITY','COUNT','QUANTITYONHAND']);
      const hasHeader=(iItem>=0);
      if(!hasHeader){ iItem=0; iDesc=1; iQty=2; }
      const start=hasHeader?1:0; const out=[];
      for(let r=start;r<rows.length;r++){
        const row=rows[r]||[];
        const name=String((row[iItem]!==undefined? row[iItem] : '')).trim(); if(!name) continue;
        const desc=String((iDesc>=0 && row[iDesc]!==undefined? row[iDesc] : '')).trim();
        const qtyV=(iQty>=0 && row[iQty]!==undefined)? row[iQty] : 0; const qty=toInt(qtyV,0);
        out.push({name, desc, qty});
      }
      return out;
    }
    async function ensureXlsx(){
      if(window.XLSX) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load XLSX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensureDocx(){
      if(window.mammoth) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load DOCX parser'));
        document.head.appendChild(s);
      });
    }
    async function ensurePdf(){
      if(window.pdfjsLib) return;
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.min.js';
        s.onload=res; s.onerror=()=>rej(Error('Failed to load PDF parser'));
        document.head.appendChild(s);
      });
      // Configure worker
      if(window.pdfjsLib){
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.7.107/pdf.worker.min.js';
      }
    }
    async function parsePdf(file){
      await ensurePdf();
      const buf = await file.arrayBuffer();
      const doc = await window.pdfjsLib.getDocument({ data: buf }).promise;
      const allLines = [];
      for(let p=1; p<=doc.numPages; p++){
        const page = await doc.getPage(p);
        const tc = await page.getTextContent();
        const rows = new Map(); // y -> [{x,str}]
        for(const item of tc.items){
          const t = (item.str||'').trim(); if(!t) continue;
          const tr = item.transform || [0,0,0,0,0,0];
          const x = tr[4] || 0; const y = Math.round(tr[5] || 0);
          if(!rows.has(y)) rows.set(y, []);
          rows.get(y).push({ x, str:t });
        }
        // Sort by Y descending (PDF origin bottom-left), then by X asc
        const yKeys = Array.from(rows.keys()).sort((a,b)=> b-a);
        for(const y of yKeys){
          const cols = rows.get(y).sort((a,b)=> a.x-b.x).map(o=> o.str);
          const line = cols.join(' ').replace(/\s{2,}/g,'  ').trim();
          if(line) allLines.push(line);
        }
      }
      // Try to parse with existing delimited parser
      if(allLines.length){
        const text = allLines.join('\n');
        const items = rowsToItems(parseDelimitedSmart(text));
        if(items.length) return items;
        // Fallback: pairwise lines as name/desc with qty 0
        const rows=[]; for(let i=0;i<allLines.length;i+=2){ rows.push([allLines[i]||'', allLines[i+1]||'', '0']); }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseDocx(file){
      await ensureDocx();
      const buf = await file.arrayBuffer();
      const result = await window.mammoth.convertToHtml({arrayBuffer: buf});
      const html = result && result.value ? result.value : '';
      if(!html) return [];
      const tmp = document.createElement('div'); tmp.innerHTML = html;
      const tables = tmp.querySelectorAll('table');
      const items = [];
      if(tables.length){
        tables.forEach(tbl=>{
          const rows = Array.from(tbl.querySelectorAll('tr'))
            .map(tr => Array.from(tr.children).map(td => td.textContent.trim()));
          const parsed = rowsToItems(rows);
          parsed.forEach(r=> items.push(r));
        });
        if(items.length) return items;
      }
      const lines = Array.from(tmp.querySelectorAll('p'))
        .map(p=> p.textContent.replace(/\u00a0/g,' ').trim())
        .filter(s=> s.length);
      if(lines.length){
        if(lines.some(l=>/[\t,]/.test(l))){
          const text = lines.join('\n');
          return rowsToItems(parseDelimitedSmart(text));
        }
        const rows = [];
        for(let i=0;i<lines.length;i++){
          const a = lines[i];
          const b = (i+1 < lines.length) ? lines[++i] : '';
          rows.push([a, b, '0']);
        }
        return rowsToItems(rows);
      }
      return [];
    }
    async function parseAnyFile(file){
      const ext=(file.name.split('.').pop()||'').toLowerCase();
      if(ext==='json'){
        const t=await file.text();
        try{
          const p=JSON.parse(t);
          if(Array.isArray(p.items)) return p.items.map(it=>({name:String(it.name||'').trim(), desc:String(it.desc||''), qty:toInt(it.qty,0)}));
          if(Array.isArray(p)) return p.map(it=>({name:String(it.Item||it.name||'').trim(), desc:String(it.Description||it.desc||''), qty:toInt(it.Qty||it.qty,0)}));
        }catch{}
        return [];
      }
      if(ext==='pdf'){ try { return await parsePdf(file); } catch { return []; } }
      if(ext==='docx' || ext==='doc'){ try { return await parseDocx(file); } catch{ return []; } }
      if(ext==='csv'||ext==='tsv'||ext==='txt'){ const t=await file.text(); return rowsToItems(parseDelimitedSmart(t)); }
      if(ext==='xlsx'||ext==='xls'){
        await ensureXlsx();
        const buf=await file.arrayBuffer();
        const wb=XLSX.read(buf,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        const aoa=XLSX.utils.sheet_to_json(ws,{header:1,raw:true});
        return rowsToItems(aoa);
      }
      return [];
    }

    // ========================
    // Merge semantics (local mode)
    // ========================
    function mergeSet(imported){
      const index=new Map(state.items.map(it=>[toKey(it.name), it]));
      let added=0, updated=0;
      for(const r of imported){
        const k=toKey(r.name); if(!k) continue;
        let it=index.get(k);
        if(!it){
          it={id:randomUUID(), name:r.name.trim(), desc:(r.desc||'').trim(), qty:toInt(r.qty,0)};
          state.items.push(it); index.set(k,it); added++;
        }else{
          if(r.desc && r.desc.trim()) it.desc=r.desc.trim();
          it.qty=toInt(r.qty,0);
          updated++;
        }
      }
      dedupe(); setUpdated(); save();
      return {added, updated, total:imported.length};
    }

    // ========================
    // Utilities
    // ========================
    function show(id, on = true) {
  const el = document.getElementById(id);
  if (!el) return;
  if (!on) {
    // If we're hiding, and focus is inside the modal, blur it first
    if (el.contains(document.activeElement)) {
      document.activeElement.blur();
    }
    el.setAttribute('aria-hidden', 'true');
    el.style.display = 'none';
    return;
  }
	  // Show and make it accessible
	  el.style.display = 'block';
	  el.setAttribute('aria-hidden', 'false');
	  try{ closeMobileTray(); }catch(e){}
	
	  // Optional: auto-focus a sensible control
	  if (id === 'addOneModal') {
	    const inp = document.getElementById('addName');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'pasteModal') {
    const ta = document.getElementById('pasteArea');
    if (ta) setTimeout(() => ta.focus(), 0);
  } else if (id === 'orderModal') {
    const inp = document.getElementById('orderSearch');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'authModal') {
    const inp = document.getElementById('authEmail');
    if (inp) setTimeout(() => inp.focus(), 0);
  } else if (id === 'lowStockModal') {
    const inp = document.getElementById('lowStockValue');
    if (inp) setTimeout(() => { inp.focus(); try{ inp.select(); }catch(e){} }, 0);
  } else if (id === 'msgModal') {
    const btn = document.getElementById('btnMsgOk');
    if (btn) setTimeout(() => btn.focus(), 0);
  } else if (id === 'confirmModal') {
    const btn = document.getElementById('btnConfirmCancel');
    if (btn) setTimeout(() => btn.focus(), 0);
  } else if (id === 'profileModal') {
    const inp = document.getElementById('profilePhone');
    if (inp) setTimeout(() => inp.focus(), 0);
  }
}

    // App message modal (replaces browser alert/prompt where possible)
    let _msgCopyText = '';
    function openMsgModal(title, body, copyText){
      _msgCopyText = String(copyText || '');
      const t = $('msgTitle'); if(t) t.textContent = String(title || 'Message');
      const b = $('msgBody'); if(b) b.textContent = String(body || '');
      const btnCopy = $('btnMsgCopy');
      if(btnCopy){
        const has = !!_msgCopyText;
        btnCopy.style.display = has ? 'inline-flex' : 'none';
        btnCopy.disabled = !has;
      }
      show('msgModal', true);
    }
    function closeMsgModal(){
      _msgCopyText = '';
      show('msgModal', false);
    }
    const btnMsgOk = $('btnMsgOk');
    if(btnMsgOk) btnMsgOk.addEventListener('click', closeMsgModal);
    const btnMsgCopy = $('btnMsgCopy');
	    if(btnMsgCopy) btnMsgCopy.addEventListener('click', async ()=>{
	      if(!_msgCopyText) return;
	      try{
	        await navigator.clipboard.writeText(_msgCopyText);
	        toast('Copied');
	      }catch(e){
	        toast('Copy failed');
	      }
	    });

	    // App confirm modal (replaces browser confirm)
	    let _confirmResolve = null;
	    function openConfirmModal(title, body, opts = {}){
	      if(_confirmResolve){
	        try{ _confirmResolve(false); }catch(e){}
	        _confirmResolve = null;
	      }
	      const t = $('confirmTitle'); if(t) t.textContent = String(title || 'Confirm');
	      const b = $('confirmBody'); if(b) b.textContent = String(body || '');
	      const okText = opts && opts.okText ? String(opts.okText) : 'OK';
	      const cancelText = opts && opts.cancelText ? String(opts.cancelText) : 'Cancel';
	      const okBtn = $('btnConfirmOk'); if(okBtn) okBtn.textContent = okText;
	      const cancelBtn = $('btnConfirmCancel'); if(cancelBtn) cancelBtn.textContent = cancelText;
	      show('confirmModal', true);
	      return new Promise(resolve => { _confirmResolve = resolve; });
	    }
	    function closeConfirmModal(result){
	      show('confirmModal', false);
	      const resolve = _confirmResolve;
	      _confirmResolve = null;
	      if(resolve) resolve(!!result);
	    }
	    const btnConfirmCancel = $('btnConfirmCancel');
	    if(btnConfirmCancel) btnConfirmCancel.addEventListener('click', ()=> closeConfirmModal(false));
	    const btnConfirmOk = $('btnConfirmOk');
	    if(btnConfirmOk) btnConfirmOk.addEventListener('click', ()=> closeConfirmModal(true));
	    document.addEventListener('keydown', (e)=>{
	      if(e.key !== 'Escape') return;
	      const modal = $('confirmModal');
	      if(!modal || modal.getAttribute('aria-hidden') !== 'false') return;
	      e.preventDefault();
	      closeConfirmModal(false);
	    });
	    function toast(msg){ const t=$('toast'); t.textContent=msg; t.style.display='block'; clearTimeout(t._tmr); t._tmr=setTimeout(()=> t.style.display='none', 2000); }

    // iOS keyboard-safe scroll height
    document.addEventListener('focusin', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','60vh');
      }
    });
    document.addEventListener('focusout', (e)=>{
      if(e.target.matches('input,textarea')){
        document.querySelector('.scroll')?.style.setProperty('max-height','70vh');
      }
    });

    // iOS-style qty picker
    const _qtyPicker = {
      itemId: null,
      itemName: '',
      currentQty: 0,
      selectedQty: 0,
      maxQty: 999,
      scrollY: 0,
      isDragging: false,
      startY: 0,
      startScrollY: 0
    };
    function openQtyPicker(itemId, itemName, currentQty){
      _qtyPicker.itemId = itemId;
      _qtyPicker.itemName = itemName;
      _qtyPicker.currentQty = currentQty;
      _qtyPicker.selectedQty = currentQty;
      _qtyPicker.scrollY = -currentQty * 36;
      const title = $('qtyPickerTitle');
      if(title) title.textContent = itemName || 'Order Qty';
      renderQtyPickerWheel();
      show('qtyPickerModal', true);
    }
    function closeQtyPicker(){
      show('qtyPickerModal', false);
      _qtyPicker.itemId = null;
    }
    function renderQtyPickerWheel(){
      const wheel = $('qtyPickerWheel');
      if(!wheel) return;
      let html = '';
      for(let i = 0; i <= _qtyPicker.maxQty; i++){
        const isSelected = i === _qtyPicker.selectedQty;
        html += `<div class="qty-picker-item${isSelected ? ' selected' : ''}" data-qty="${i}">${i}</div>`;
      }
      wheel.innerHTML = html;
      wheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
    }
    function updateQtyPickerSelection(){
      const wheel = $('qtyPickerWheel');
      if(!wheel) return;
      const idx = Math.round(-_qtyPicker.scrollY / 36);
      _qtyPicker.selectedQty = Math.max(0, Math.min(_qtyPicker.maxQty, idx));
      wheel.querySelectorAll('.qty-picker-item').forEach((el, i) => {
        el.classList.toggle('selected', i === _qtyPicker.selectedQty);
      });
    }
    function snapQtyPicker(){
      const idx = Math.round(-_qtyPicker.scrollY / 36);
      const clampedIdx = Math.max(0, Math.min(_qtyPicker.maxQty, idx));
      _qtyPicker.selectedQty = clampedIdx;
      _qtyPicker.scrollY = -clampedIdx * 36;
      const wheel = $('qtyPickerWheel');
      if(wheel){
        wheel.style.transition = 'transform 150ms ease-out';
        wheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
        setTimeout(()=>{ wheel.style.transition = ''; }, 150);
      }
      updateQtyPickerSelection();
    }
    function handleQtyPickerDone(){
      const id = _qtyPicker.itemId;
      const qty = _qtyPicker.selectedQty;
      if(id){
        const ord = orderState();
        const line = ord.lines.find(l => l.id === id);
        if(line){
          if(qty === 0){
            removeOrderLine(id);
          } else {
            line.qty = qty;
          }
          renderOrderLines();
        }
      }
      closeQtyPicker();
    }

    // Boot
      document.addEventListener('DOMContentLoaded', async ()=>{
      load(); render();
      try{ setEditHint(); }catch(e){}
      try{ adjustTitleSize(); if(document.fonts && document.fonts.ready){ document.fonts.ready.then(()=> requestAnimationFrame(adjustTitleSize)); } }catch(e){}
      const fb=$('filterBox'); if(fb){
        fb.value=state._filter||'';
        updateFilterClearBtn();
        fb.addEventListener('input', ()=>{ state._filter=fb.value; renderTable(); save(); updateFilterClearBtn(); });
        fb.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && fb.value){ e.preventDefault(); fb.value=''; state._filter=''; renderTable(); save(); updateFilterClearBtn(); }});
      }
	      const clr=$('btnClearFilter'); if(clr && fb){
	        clr.addEventListener('click', ()=>{
	          if(!fb.value) return;
	          fb.value='';
	          state._filter='';
          renderTable();
          save();
          updateFilterClearBtn();
          try{ fb.focus(); }catch(e){}
	        });
	      }

	      // Order counter badge - delegated handler for all [data-order-reset] elements
	      document.addEventListener('click', (e)=>{
	        const badge = e.target.closest('[data-order-reset]');
	        if(!badge) return;
	        e.preventDefault();
	        clearAllOrderLines();
	        toast('Shopping cart cleared');
	        try{ syncReportOrderIndicators(); }catch(ex){}
	      });
	      try{ updateOrderCounterBadge(); }catch(e){}

	      // iOS-style qty picker - event handlers
	      const qtyPickerCancel = $('qtyPickerCancel');
	      const qtyPickerDone = $('qtyPickerDone');
	      const qtyPickerBackdrop = document.querySelector('.qty-picker-backdrop');
	      const qtyPickerWheel = $('qtyPickerWheel');
	      if(qtyPickerCancel) qtyPickerCancel.addEventListener('click', closeQtyPicker);
	      if(qtyPickerDone) qtyPickerDone.addEventListener('click', handleQtyPickerDone);
	      if(qtyPickerBackdrop) qtyPickerBackdrop.addEventListener('click', closeQtyPicker);

	      // Wheel touch/mouse drag
	      if(qtyPickerWheel){
	        const getY = (e) => e.touches ? e.touches[0].clientY : e.clientY;
	        qtyPickerWheel.addEventListener('touchstart', (e)=>{
	          _qtyPicker.isDragging = true;
	          _qtyPicker.startY = getY(e);
	          _qtyPicker.startScrollY = _qtyPicker.scrollY;
	          qtyPickerWheel.style.transition = '';
	        }, { passive: true });
	        qtyPickerWheel.addEventListener('touchmove', (e)=>{
	          if(!_qtyPicker.isDragging) return;
	          const deltaY = getY(e) - _qtyPicker.startY;
	          _qtyPicker.scrollY = _qtyPicker.startScrollY + deltaY;
	          // Clamp scroll
	          const minScroll = -_qtyPicker.maxQty * 36;
	          _qtyPicker.scrollY = Math.max(minScroll, Math.min(0, _qtyPicker.scrollY));
	          qtyPickerWheel.style.transform = `translateY(${_qtyPicker.scrollY}px)`;
	          updateQtyPickerSelection();
	        }, { passive: true });
	        qtyPickerWheel.addEventListener('touchend', ()=>{
	          _qtyPicker.isDragging = false;
	          snapQtyPicker();
	        });
	        // Click on item to select
	        qtyPickerWheel.addEventListener('click', (e)=>{
	          const item = e.target.closest('.qty-picker-item');
	          if(!item) return;
	          const qty = parseInt(item.dataset.qty, 10);
	          if(!isNaN(qty)){
	            _qtyPicker.selectedQty = qty;
	            _qtyPicker.scrollY = -qty * 36;
	            snapQtyPicker();
	          }
	        });
	      }

	      // Long-press on qty stepper in order modal to open picker
	      let _longPressTimer = null;
	      const orderLinesBody = $('orderLinesBody');
	      if(orderLinesBody){
	        orderLinesBody.addEventListener('touchstart', (e)=>{
	          const trigger = e.target.closest('[data-qty-picker-trigger]');
	          if(!trigger) return;
	          const id = trigger.dataset.qtyPickerTrigger;
	          _longPressTimer = setTimeout(()=>{
	            const ord = orderState();
	            const line = ord.lines.find(l => l.id === id);
	            if(line){
	              openQtyPicker(id, line.name, toInt(line.qty, 0));
	            }
	            _longPressTimer = null;
	          }, 500);
	        }, { passive: true });
	        orderLinesBody.addEventListener('touchend', ()=>{
	          if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer = null; }
	        });
	        orderLinesBody.addEventListener('touchmove', ()=>{
	          if(_longPressTimer){ clearTimeout(_longPressTimer); _longPressTimer = null; }
	        }, { passive: true });
	      }

	      const mobileSort = $('mobileSort');
	      if(mobileSort){
	        syncMobileSortSelect();
	        mobileSort.addEventListener('change', ()=>{
	          const raw = String(mobileSort.value || '');
	          const parts = raw.split(':');
	          const col = (parts[0] || '').trim();
	          const dir = (parts[1] || '').trim() === 'desc' ? 'desc' : 'asc';
	          if(!col) return;
	          state._sort = { col, dir };
	          renderTable();
	          save();
	        });
	      }

	      document.querySelectorAll('#invTable thead th.sortable').forEach(th=>{ th.addEventListener('click', ()=>{ const col=th.getAttribute('data-col'); if(!col) return; const srt=getSort(); if(srt.col===col){ state._sort={col, dir:(srt.dir==='asc'?'desc':'asc')}; } else { state._sort={col, dir:'asc'}; } renderTable(); save(); }); });

	      // Supabase init and health check
	      try{
        sbInit();
        updateStatusBar();
        await sbAuthBoot();
      }catch(e){
        console.warn('Startup error', e);
        SB.connected = false;
        updateStatusBar();
      }

      // Keep the status fresh
      window.addEventListener('online', checkServerHealth);
      window.addEventListener('offline', checkServerHealth);
	      setInterval(checkServerHealth, 15000);
	
	      // Responsive: adjust desc column width on viewport change
		      window.addEventListener('resize', ()=> { try{ requestAnimationFrame(()=>{ closeMobileTray(); adjustDescColumnWidth(); adjustTitleSize(); setEditHint(); refreshTotalsLabels(); }); }catch(e){} });
	
	      // Close modals when clicking outside (on backdrop)
	      document.addEventListener('click', (e)=>{
	        try{
	          if(isMobileUx() && _openTrayId){
	            const inTray = !!e.target.closest('.card-tray');
	            const inTable = !!e.target.closest('#invTable');
	            if(!inTray && !inTable) closeMobileTray();
	          }
	        }catch(e){}
	        const modal = e.target.closest('.modal');
	        if(modal && e.target === modal){
	          if(modal.id === 'editItemModal') return;
	          show(modal.id, false);
        }
      });

      if('serviceWorker' in navigator){
        // Listen for SW activation and update flow
        let _swReloaded = false;
        navigator.serviceWorker.addEventListener('controllerchange', ()=>{
          if(_swReloaded) return; _swReloaded = true;
          try{ toast('App updated. Reloading…'); }catch{}
          setTimeout(()=> location.reload(), 400);
        });
        navigator.serviceWorker.addEventListener('message', (e)=>{
          if(!e || !e.data) return;
          if(e.data.type === 'SW_ACTIVATED'){
            // No-op: controllerchange handler above will handle reload UX
          }
        });
        navigator.serviceWorker.register('./sw.js?v=14', { scope: './' }).catch(console.warn);
      }
    });
  </script>
</body>
</html>
